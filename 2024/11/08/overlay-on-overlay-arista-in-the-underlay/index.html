
<!DOCTYPE html>
<html
  lang="en"
  data-figures=""
  
    class="page"
  
  
  
    data-mode="dim"
  >
  <head>
<title>Overlay on overlay - Arista in the underlay | From 0.985mhz... to several Ghz</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-TVPYDVE8KR"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-TVPYDVE8KR');
</script>



  
<meta property="og:locale" content="en" />

<meta property="og:type" content="article">
<meta name="description" content="Going over some typical scenarios using overlay protocols in both the compute stack and network stack" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:creator" content="">
<meta name="twitter:title" content="Overlay on overlay - Arista in the underlay" />
<meta name="twitter:image" content="https://blog.andreasm.io/2024/11/08/overlay-on-overlay-arista-in-the-underlay/images/1280px-Arista-networks-logo.svg.png"/>
<meta property="og:url" content="https://blog.andreasm.io/2024/11/08/overlay-on-overlay-arista-in-the-underlay/" />
<meta property="og:title" content="Overlay on overlay - Arista in the underlay" />
<meta property="og:description" content="Going over some typical scenarios using overlay protocols in both the compute stack and network stack" />
<meta property="og:image" content="https://blog.andreasm.io/2024/11/08/overlay-on-overlay-arista-in-the-underlay/images/1280px-Arista-networks-logo.svg.png" />
  <meta name="keywords" content="nsx,vmware,networking,infrastucture,lodbalancing,tanzu,security,cni,antrea,cilium,kubernetes" />

<link rel="apple-touch-icon" sizes="180x180" href="https://blog.andreasm.io/icons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://blog.andreasm.io/icons/favicon-32x32.png">
<link rel="manifest" href="https://blog.andreasm.io/icons/site.webmanifest">

<link rel="canonical" href="https://blog.andreasm.io/2024/11/08/overlay-on-overlay-arista-in-the-underlay/">



<link rel="preload" href="https://blog.andreasm.io/css/styles.6c67fa3a7f5290a2facfb027358dd2bdb5450d04b8de427c8a74d79f524a7fb716b470b14b6ba95f1b7cf3aa9a2219a7294a6adeaf16a1080f432eae45d8c03c.css" integrity = "sha512-bGf6On9SkKL6z7AnNY3SvbVFDQS43kJ8inTXn1JKf7cWtHCxS2upXxt886qaIhmnKUpq3q8WoQgPQy6uRdjAPA==" as="style" crossorigin="anonymous">



<link rel="preload" href="https://blog.andreasm.io/en/js/bundle.5548d358738600c857a1f05f0459418da7143d4426c66a08bf3f15ded1b39dd2136bf104a559247a909fc4dcc45b8e06bad0870ece4c71ee5303d30550def8bd.js" as="script" integrity=
"sha512-VUjTWHOGAMhXofBfBFlBjacUPUQmxmoIvz8V3tGzndITa/EEpVkkepCfxNzEW44GutCHDs5Mce5TA9MFUN74vQ==" crossorigin="anonymous">


<link rel="stylesheet" type="text/css" href="https://blog.andreasm.io/css/styles.6c67fa3a7f5290a2facfb027358dd2bdb5450d04b8de427c8a74d79f524a7fb716b470b14b6ba95f1b7cf3aa9a2219a7294a6adeaf16a1080f432eae45d8c03c.css" integrity="sha512-bGf6On9SkKL6z7AnNY3SvbVFDQS43kJ8inTXn1JKf7cWtHCxS2upXxt886qaIhmnKUpq3q8WoQgPQy6uRdjAPA==" crossorigin="anonymous">


  </head>
  <body
    data-code="15"
    data-lines="false"
    id="documentTop"
    data-lang="en"
  >

<header class="nav_header" >
  <nav class="nav"><a href='https://blog.andreasm.io/' class="nav_brand nav_item" title="From 0.985mhz... to several Ghz">
  <img src="https://blog.andreasm.io/quote3.png" class="logo" alt="From 0.985mhz... to several Ghz">
  <div class="nav_close">
    <div><svg class="icon">
  <title>open-menu</title>
  <use xlink:href="#open-menu"></use>
</svg>
<svg class="icon">
  <title>closeme</title>
  <use xlink:href="#closeme"></use>
</svg>
</div>
  </div>
</a>

    <div class='nav_body nav_body_left'>
      
      
      
        

  <div class="nav_parent">
    <a href="https://blog.andreasm.io/" class="nav_item" title="Home">Home </a>
  </div>
  <div class="nav_parent">
    <a href="https://blog.andreasm.io/about/" class="nav_item" title="About">About </a>
  </div>
      
<div class='follow'>
    
  <a href="https://blog.andreasm.io/index.xml">
    <svg class="icon">
  <title>rss</title>
  <use xlink:href="#rss"></use>
</svg>

  </a>
<div class="color_mode">
  <input type="checkbox" class="color_choice" id="mode">
</div>

</div>

    </div>
  </nav>
</header>

    <main>
  
<div class="grid-inverse wrap content">
  <article class="post_content">
    <h1 class="post_title">Overlay on overlay - Arista in the underlay</h1>
  <div class="post_meta">
    <span><svg class="icon">
  <title>calendar</title>
  <use xlink:href="#calendar"></use>
</svg>
</span>
    <span class="post_date">
      08-11-2024</span>
    <span class="post_time"> · 50 min read</span><span>&nbsp;· <a href='https://blog.andreasm.io/tags/networking/' title="Networking" class="post_tag button button_translucent">Networking
        </a><a href='https://blog.andreasm.io/tags/eos/' title="EOS" class="post_tag button button_translucent">EOS
        </a><a href='https://blog.andreasm.io/tags/arista/' title="Arista" class="post_tag button button_translucent">Arista
        </a><a href='https://blog.andreasm.io/tags/overlay/' title="Overlay" class="post_tag button button_translucent">Overlay
        </a><a href='https://blog.andreasm.io/tags/encapsulation/' title="Encapsulation" class="post_tag button button_translucent">Encapsulation
        </a><a href='https://blog.andreasm.io/tags/topologies/' title="Topologies" class="post_tag button button_translucent">Topologies
        </a>
    </span>
    <span class="page_only">&nbsp;·
  <div class="post_share">
    Share on:
    <a href="https://twitter.com/intent/tweet?text=Overlay%20on%20overlay%20-%20Arista%20in%20the%20underlay&url=https%3a%2f%2fblog.andreasm.io%2f2024%2f11%2f08%2foverlay-on-overlay-arista-in-the-underlay%2f&tw_p=tweetbutton" class="twitter" title="Share on Twitter" target="_blank" rel="nofollow">
      <svg class="icon">
  <title>twitter</title>
  <use xlink:href="#twitter"></use>
</svg>

    </a>
    <a href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fblog.andreasm.io%2f2024%2f11%2f08%2foverlay-on-overlay-arista-in-the-underlay%2f&t=Overlay%20on%20overlay%20-%20Arista%20in%20the%20underlay" class="facebook" title="Share on Facebook" target="_blank" rel="nofollow">
      <svg class="icon">
  <title>facebook</title>
  <use xlink:href="#facebook"></use>
</svg>

    </a>
    <a href="#linkedinshare" id = "linkedinshare" class="linkedin" title="Share on LinkedIn" rel="nofollow">
      <svg class="icon">
  <title>linkedin</title>
  <use xlink:href="#linkedin"></use>
</svg>

    </a>
    <a href="https://blog.andreasm.io/2024/11/08/overlay-on-overlay-arista-in-the-underlay/" title="Copy Link" class="link link_yank">
      <svg class="icon">
  <title>copy</title>
  <use xlink:href="#copy"></use>
</svg>

    </a>
  </div>
  </span>
  </div>

      <div class="post_toc">
        <h2>Overview</h2>
        <nav id="TableOfContents">
  <ul>
    <li><a href="#underlay">Underlay</a></li>
    <li><a href="#overlay-in-the-underlay">Overlay in the &quot;underlay&quot;</a>
      <ul>
        <li><a href="#tcpdump-on-arista-switches-eos">TCPdump on Arista switches (EOS)</a></li>
      </ul>
    </li>
    <li><a href="#overlay-in-the-compute-stack">Overlay in the compute stack</a></li>
    <li><a href="#where-is-encapsulation-and-decapsulation-done">Where is encapsulation and decapsulation done</a></li>
    <li><a href="#will-it-fit-then">Will it fit then?</a></li>
    <li><a href="#simulating-an-environment-with-triple-encapsulation">Simulating an environment with triple encapsulation</a>
      <ul>
        <li><a href="#let-see-some-triple-encapsulation-in-action">Let see some triple encapsulation in action</a></li>
        <li><a href="#monitor-and-troubleshoot">Monitor and troubleshoot</a></li>
        <li><a href="#ethernet-mtu-and-ip-mtu">Ethernet MTU and IP MTU</a></li>
        <li><a href="#verifying-everything-in-the-arista-fabric">Verifying everything in the Arista fabric</a></li>
        <li><a href="#verifying-mtu-in-the-compute-stack">Verifying MTU in the compute stack</a></li>
      </ul>
    </li>
    <li><a href="#summary">Summary</a></li>
  </ul>
</nav>
      </div>
    
    <div class="post_body"><h1 id="spineleaf-with-evpn-and-vxlan---underlay-and-overlay">Spine/Leaf with EVPN and VXLAN - underlay and overlay</h1>
<p>In a typical datacenter today a common architecture is the Spine/Leaf design (<a href="https://en.wikipedia.org/wiki/Clos_network">Clos</a>). This architecture comes with many benefits such as:</p>
<ul>
<li>Performance</li>
<li>Scalability</li>
<li>Redundancy</li>
<li>High Availability</li>
<li>Simplified Network Management</li>
<li>Supports East-West</li>
</ul>
<h2 id="underlay">Underlay</h2>
<p>There are two ways to design a spine leaf fabric. We can do layer 2 designs and layer 3 designs. I will be focusing on the layer 3 design in this post as this is the most common design. Layer 3 scales and performs better, we dont need to consider STP (spanning tree) and we get Equal Cost Multi Path as a bonus. In a layer 3 design all switches in the fabric are connected using routed ports, which also means there is no layer 2 possibilities between the switches, unless we introduce some kind of layer on top that can carry this layer 2 over the layer 3 links. This layer is what this post will cover and is often referrred to as the overlay layer. Before going all in on overlay I need to also cover the underlay. The underlay in a spine leaf fabric is the physical ports configured as routed ports connecting the switches together. All switches in a layer 3 fabric is being connected to each other using routed ports. All leafs exchange routes/peers with the spines.</p>
<p>As everything is routed we need to add some routing information in the underlay to let all switches know where to go to reach certain destinations. This can in theory be any kind of routing protocols (even static routes) supported by the <a href="https://www.ietf.org/">IETF</a> such as OSFP, ISIS and BGP.</p>
<p>In Arista the preferred and recommended routing protocol in both the underlay and overlay is BGP. Why? BGP is the most commonly used routing protocol, it is very robust, feature rich and customisable. It supports EVPN, and if you know you are going to use EVPN why consider a different routing protocol in the underlay. That just adds more complexity and management overhead. Using BGP in both the underlay and the overlay gives a much more consistent config and benefits like BGP does not need multicast.</p>
<p>So if you read any Arista deployment recommendations, use Arista Validated Design, Arista's protocol of choice will always be BGP. It just makes everything so much easier.</p>
<p>In a spine leaf fabric, all leafs peers with the spines. The leafs do not peer with the other leafs in the underlay, unless there is an mlag config between two <a href="https://www.arista.com/en/um-eos/eos-multi-chassis-link-aggregation">leaf pairs</a>. All leafs have their own BGP AS, the spines usually share the same BGP AS.</p>
<p>A diagram of the fabric underlay:</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="layer-3-ls"
      
        class="image_figure image_internal image_processed"
        width="1800"
        height="1422"
        src="/2024/11/08/overlay-on-overlay-arista-in-the-underlay/images/image-20241127103701406.png"
      
      
    />

    </picture>
</figure>
</p>
<p>In the above diagram I have confgured my underlay with layer 3 routing, BGP exhanges route information between the leafs. So far in my configuration I can not have two servers connected to different leafs on the same layer 2 subnet. Only if they are connected to the same leaf I can have layer 2 adjacency. So when server 1, connected to leaf1a, wants to talk to server 2, connected on leaf2a, it has to be over layer 3 and both servers needs to be in their own subnet. Leaf1a and leaf2a advertises its subnets to both spine1 and spine2, server 1 and 2 has been configured to use their connected leaf switches  as gateway respectively.</p>
<p>If I do a ping in the &quot;underlay&quot; how will it look like when I ping from leaf1a to leaf2a using loopback interface 0 on my leaf1a and leaf2a to just simulate layer 3 connectivity without any overlay protocol involved (<em>I dont have any servers connected to a routed interfaces in my lab on any of my leafs at the moment</em>).</p>
<p>Tcpdump on leaf1a on both its uplinks (the source of the icmp request):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="o">[</span>ansible@veos-dc1-leaf1a ~<span class="o">]</span>$ tcpdump -i vmnicet1 -nnvvv -s <span class="m">0</span> icmp -c2
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">tcpdump: listening on vmnicet1, link-type EN10MB <span class="o">(</span>Ethernet<span class="o">)</span>, snapshot length <span class="m">262144</span> bytes
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">13:41:41.626368 bc:24:11:4a:9a:d0 &gt; bc:24:11:1d:5f:a1, ethertype IPv4 <span class="o">(</span>0x0800<span class="o">)</span>, length 114: <span class="o">(</span>tos 0x0, ttl 63, id 33961, offset 0, flags <span class="o">[</span>none<span class="o">]</span>, proto ICMP <span class="o">(</span>1<span class="o">)</span>, length 100<span class="o">)</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">    10.255.0.5 &gt; 10.255.0.3: ICMP <span class="nb">echo</span> reply, id 53, seq 1, length <span class="m">80</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">13:41:41.628659 bc:24:11:4a:9a:d0 &gt; bc:24:11:1d:5f:a1, ethertype IPv4 <span class="o">(</span>0x0800<span class="o">)</span>, length 114: <span class="o">(</span>tos 0x0, ttl 63, id 33962, offset 0, flags <span class="o">[</span>none<span class="o">]</span>, proto ICMP <span class="o">(</span>1<span class="o">)</span>, length 100<span class="o">)</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">    10.255.0.5 &gt; 10.255.0.3: ICMP <span class="nb">echo</span> reply, id 53, seq 2, length <span class="m">80</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="m">2</span> packets captured
</span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="m">5</span> packets received by filter
</span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="m">0</span> packets dropped by kernel
</span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="o">[</span>ansible@veos-dc1-leaf1a ~<span class="o">]</span>$ tcpdump -i vmnicet2 -nnvvv -s <span class="m">0</span> icmp -c2
</span></span><span class="line"><span class="ln">11</span><span class="cl">tcpdump: listening on vmnicet2, link-type EN10MB <span class="o">(</span>Ethernet<span class="o">)</span>, snapshot length <span class="m">262144</span> bytes
</span></span><span class="line"><span class="ln">12</span><span class="cl">13:41:51.177083 bc:24:11:1d:5f:a1 &gt; bc:24:11:f5:c0:d2, ethertype IPv4 <span class="o">(</span>0x0800<span class="o">)</span>, length 114: <span class="o">(</span>tos 0x0, ttl 64, id 21419, offset 0, flags <span class="o">[</span>none<span class="o">]</span>, proto ICMP <span class="o">(</span>1<span class="o">)</span>, length 100<span class="o">)</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">    10.255.0.3 &gt; 10.255.0.5: ICMP <span class="nb">echo</span> request, id 54, seq 1, length <span class="m">80</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">13:41:51.179460 bc:24:11:1d:5f:a1 &gt; bc:24:11:f5:c0:d2, ethertype IPv4 <span class="o">(</span>0x0800<span class="o">)</span>, length 114: <span class="o">(</span>tos 0x0, ttl 64, id 21420, offset 0, flags <span class="o">[</span>none<span class="o">]</span>, proto ICMP <span class="o">(</span>1<span class="o">)</span>, length 100<span class="o">)</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">    10.255.0.3 &gt; 10.255.0.5: ICMP <span class="nb">echo</span> request, id 54, seq 2, length <span class="m">80</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="m">2</span> packets captured
</span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="m">2</span> packets received by filter
</span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="m">0</span> packets dropped by kernel
</span></span></code></pre></div><p>Notice the change of direction on the MAC addresses.</p>
<p>Now if I do a tcpdump on both spine 1 and spine 2 - depending on which path my request takes:</p>
<p>Spine1 on downlinks to leaf1a and leaf2a :</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="o">[</span>ansible@veos-dc1-spine1 ~<span class="o">]</span>$ tcpdump -i vmnicet1 -nnvvv -s <span class="m">0</span> icmp -c2
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">tcpdump: listening on vmnicet1, link-type EN10MB <span class="o">(</span>Ethernet<span class="o">)</span>, snapshot length <span class="m">262144</span> bytes
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">13:44:38.739492 bc:24:11:4a:9a:d0 &gt; bc:24:11:1d:5f:a1, ethertype IPv4 <span class="o">(</span>0x0800<span class="o">)</span>, length 114: <span class="o">(</span>tos 0x0, ttl 63, id 39153, offset 0, flags <span class="o">[</span>none<span class="o">]</span>, proto ICMP <span class="o">(</span>1<span class="o">)</span>, length 100<span class="o">)</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">    10.255.0.5 &gt; 10.255.0.3: ICMP <span class="nb">echo</span> reply, id 55, seq 1, length <span class="m">80</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">13:44:38.741578 bc:24:11:4a:9a:d0 &gt; bc:24:11:1d:5f:a1, ethertype IPv4 <span class="o">(</span>0x0800<span class="o">)</span>, length 114: <span class="o">(</span>tos 0x0, ttl 63, id 39154, offset 0, flags <span class="o">[</span>none<span class="o">]</span>, proto ICMP <span class="o">(</span>1<span class="o">)</span>, length 100<span class="o">)</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">    10.255.0.5 &gt; 10.255.0.3: ICMP <span class="nb">echo</span> reply, id 55, seq 2, length <span class="m">80</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="m">2</span> packets captured
</span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="m">5</span> packets received by filter
</span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="m">0</span> packets dropped by kernel
</span></span><span class="line"><span class="ln">10</span><span class="cl">
</span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="o">[</span>ansible@veos-dc1-spine1 ~<span class="o">]</span>$ tcpdump -i vmnicet3 -nnvvv -s <span class="m">0</span> icmp -c2
</span></span><span class="line"><span class="ln">12</span><span class="cl">tcpdump: listening on vmnicet3, link-type EN10MB <span class="o">(</span>Ethernet<span class="o">)</span>, snapshot length <span class="m">262144</span> bytes
</span></span><span class="line"><span class="ln">13</span><span class="cl">13:44:57.720811 bc:24:11:31:35:db &gt; bc:24:11:4a:9a:d0, ethertype IPv4 <span class="o">(</span>0x0800<span class="o">)</span>, length 114: <span class="o">(</span>tos 0x0, ttl 64, id 41546, offset 0, flags <span class="o">[</span>none<span class="o">]</span>, proto ICMP <span class="o">(</span>1<span class="o">)</span>, length 100<span class="o">)</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">    10.255.0.5 &gt; 10.255.0.3: ICMP <span class="nb">echo</span> reply, id 57, seq 1, length <span class="m">80</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">13:44:57.723117 bc:24:11:31:35:db &gt; bc:24:11:4a:9a:d0, ethertype IPv4 <span class="o">(</span>0x0800<span class="o">)</span>, length 114: <span class="o">(</span>tos 0x0, ttl 64, id 41547, offset 0, flags <span class="o">[</span>none<span class="o">]</span>, proto ICMP <span class="o">(</span>1<span class="o">)</span>, length 100<span class="o">)</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">    10.255.0.5 &gt; 10.255.0.3: ICMP <span class="nb">echo</span> reply, id 57, seq 2, length <span class="m">80</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="m">2</span> packets captured
</span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="m">5</span> packets received by filter
</span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="m">0</span> packets dropped by kernel
</span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="o">[</span>ansible@veos-dc1-spine1 ~<span class="o">]</span>$
</span></span></code></pre></div><p>Spine2 on downlinks to leaf1a and leaf2a:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="o">[</span>ansible@veos-dc1-spine2 ~<span class="o">]</span>$ tcpdump -i vmnicet1 icmp -nnvvv -s <span class="m">0</span> -c <span class="m">2</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">tcpdump: listening on vmnicet1, link-type EN10MB <span class="o">(</span>Ethernet<span class="o">)</span>, snapshot length <span class="m">262144</span> bytes
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">13:46:42.934823 bc:24:11:1d:5f:a1 &gt; bc:24:11:f5:c0:d2, ethertype IPv4 <span class="o">(</span>0x0800<span class="o">)</span>, length 114: <span class="o">(</span>tos 0x0, ttl 64, id 64040, offset 0, flags <span class="o">[</span>none<span class="o">]</span>, proto ICMP <span class="o">(</span>1<span class="o">)</span>, length 100<span class="o">)</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">    10.255.0.3 &gt; 10.255.0.5: ICMP <span class="nb">echo</span> request, id 58, seq 1, length <span class="m">80</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">13:46:42.937184 bc:24:11:1d:5f:a1 &gt; bc:24:11:f5:c0:d2, ethertype IPv4 <span class="o">(</span>0x0800<span class="o">)</span>, length 114: <span class="o">(</span>tos 0x0, ttl 64, id 64041, offset 0, flags <span class="o">[</span>none<span class="o">]</span>, proto ICMP <span class="o">(</span>1<span class="o">)</span>, length 100<span class="o">)</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">    10.255.0.3 &gt; 10.255.0.5: ICMP <span class="nb">echo</span> request, id 58, seq 2, length <span class="m">80</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="m">2</span> packets captured
</span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="m">5</span> packets received by filter
</span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="m">0</span> packets dropped by kernel
</span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="o">[</span>ansible@veos-dc1-spine2 ~<span class="o">]</span>$ tcpdump -i vmnicet3 icmp -nnvvv -s <span class="m">0</span> -c <span class="m">2</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">tcpdump: listening on vmnicet3, link-type EN10MB <span class="o">(</span>Ethernet<span class="o">)</span>, snapshot length <span class="m">262144</span> bytes
</span></span><span class="line"><span class="ln">12</span><span class="cl">13:46:51.617532 bc:24:11:f5:c0:d2 &gt; bc:24:11:31:35:db, ethertype IPv4 <span class="o">(</span>0x0800<span class="o">)</span>, length 114: <span class="o">(</span>tos 0x0, ttl 63, id 497, offset 0, flags <span class="o">[</span>none<span class="o">]</span>, proto ICMP <span class="o">(</span>1<span class="o">)</span>, length 100<span class="o">)</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">    10.255.0.3 &gt; 10.255.0.5: ICMP <span class="nb">echo</span> request, id 59, seq 1, length <span class="m">80</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">13:46:51.620311 bc:24:11:f5:c0:d2 &gt; bc:24:11:31:35:db, ethertype IPv4 <span class="o">(</span>0x0800<span class="o">)</span>, length 114: <span class="o">(</span>tos 0x0, ttl 63, id 498, offset 0, flags <span class="o">[</span>none<span class="o">]</span>, proto ICMP <span class="o">(</span>1<span class="o">)</span>, length 100<span class="o">)</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">    10.255.0.3 &gt; 10.255.0.5: ICMP <span class="nb">echo</span> request, id 59, seq 2, length <span class="m">80</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="m">2</span> packets captured
</span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="m">5</span> packets received by filter
</span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="m">0</span> packets dropped by kernel
</span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="o">[</span>ansible@veos-dc1-spine2 ~<span class="o">]</span>$
</span></span></code></pre></div><p>And finally on leaf2a on both its uplinks:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="o">[</span>ansible@veos-dc1-leaf2a ~<span class="o">]</span>$ tcpdump -i vmnicet1 -nnvvv -s <span class="m">0</span> icmp -c2
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">tcpdump: listening on vmnicet1, link-type EN10MB <span class="o">(</span>Ethernet<span class="o">)</span>, snapshot length <span class="m">262144</span> bytes
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">13:50:01.166378 bc:24:11:31:35:db &gt; bc:24:11:4a:9a:d0, ethertype IPv4 <span class="o">(</span>0x0800<span class="o">)</span>, length 114: <span class="o">(</span>tos 0x0, ttl 64, id 21154, offset 0, flags <span class="o">[</span>none<span class="o">]</span>, proto ICMP <span class="o">(</span>1<span class="o">)</span>, length 100<span class="o">)</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">    10.255.0.5 &gt; 10.255.0.3: ICMP <span class="nb">echo</span> reply, id 60, seq 1, length <span class="m">80</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">13:50:01.168794 bc:24:11:31:35:db &gt; bc:24:11:4a:9a:d0, ethertype IPv4 <span class="o">(</span>0x0800<span class="o">)</span>, length 114: <span class="o">(</span>tos 0x0, ttl 64, id 21155, offset 0, flags <span class="o">[</span>none<span class="o">]</span>, proto ICMP <span class="o">(</span>1<span class="o">)</span>, length 100<span class="o">)</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">    10.255.0.5 &gt; 10.255.0.3: ICMP <span class="nb">echo</span> reply, id 60, seq 2, length <span class="m">80</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="m">2</span> packets captured
</span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="m">5</span> packets received by filter
</span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="m">0</span> packets dropped by kernel
</span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="o">[</span>ansible@veos-dc1-leaf2a ~<span class="o">]</span>$ tcpdump -i vmnicet2 -nnvvv -s <span class="m">0</span> icmp -c2
</span></span><span class="line"><span class="ln">11</span><span class="cl">tcpdump: listening on vmnicet2, link-type EN10MB <span class="o">(</span>Ethernet<span class="o">)</span>, snapshot length <span class="m">262144</span> bytes
</span></span><span class="line"><span class="ln">12</span><span class="cl">13:50:07.251988 bc:24:11:f5:c0:d2 &gt; bc:24:11:31:35:db, ethertype IPv4 <span class="o">(</span>0x0800<span class="o">)</span>, length 114: <span class="o">(</span>tos 0x0, ttl 63, id 31490, offset 0, flags <span class="o">[</span>none<span class="o">]</span>, proto ICMP <span class="o">(</span>1<span class="o">)</span>, length 100<span class="o">)</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">    10.255.0.3 &gt; 10.255.0.5: ICMP <span class="nb">echo</span> request, id 61, seq 1, length <span class="m">80</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">13:50:07.254459 bc:24:11:f5:c0:d2 &gt; bc:24:11:31:35:db, ethertype IPv4 <span class="o">(</span>0x0800<span class="o">)</span>, length 114: <span class="o">(</span>tos 0x0, ttl 63, id 31491, offset 0, flags <span class="o">[</span>none<span class="o">]</span>, proto ICMP <span class="o">(</span>1<span class="o">)</span>, length 100<span class="o">)</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">    10.255.0.3 &gt; 10.255.0.5: ICMP <span class="nb">echo</span> request, id 61, seq 2, length <span class="m">80</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="m">2</span> packets captured
</span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="m">5</span> packets received by filter
</span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="m">0</span> packets dropped by kernel
</span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="o">[</span>ansible@veos-dc1-leaf2a ~<span class="o">]</span>$
</span></span></code></pre></div><p>If I take a tcpdump and open it in Wireshark, I can have a look at the protocols in the frame.</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="image-20241130135824702"
      
        class="image_figure image_internal image_processed"
        width="1750"
        height="338"
        src="/2024/11/08/overlay-on-overlay-arista-in-the-underlay/images/image-20241130135824702.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Something to have in the back of the mind to later in this post...</p>
<p>Depending on which path my traffic takes, via spine 1 or spine 2, (remember one of the bonuses with L3 is ECMP), I see the mac address of my leaf1a <code>bc:24:11:1d:5f:a1</code> as source and the destination spine2 mac address <code>bc:24:11:f5:c0:d2</code>. Then the source IP and destination IP of their respective loopback interfaces. Nothing special here. Why do I see the spine2's mac address as destination mac address? Remember that this is a pure layer 3 fabric which means leaf1a and leaf2a are not seeing each other directly, everything is routed over spine1 and spine2. So the destination mac will be either spine1 and spine2 as those are both intermediary. The packets IP header (source and destination IP address) on the other hand corresponds to the right source and destination ip address. Its only the layer 2 ethernet header thats is being updated along the hops: leaf1a  -&gt; spine 1 or spine 2 -&gt; leaf2a.</p>
<p>For reference I have my leaf1a, spine1, spine2 and leaf2a's mac and ip address below:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="o">[</span>ansible@veos-dc1-leaf1a ~<span class="o">]</span>$ ip link show et1
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">29: et1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="m">9194</span> qdisc pfifo_fast state UP mode DEFAULT group default qlen <span class="m">1000</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">    link/ether bc:24:11:1d:5f:a1 brd ff:ff:ff:ff:ff:ff
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="o">[</span>ansible@veos-dc1-leaf1a ~<span class="o">]</span>$
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">veos-dc1-leaf1a#show interfaces loopback <span class="m">0</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">Loopback0 is up, line protocol is up <span class="o">(</span>connected<span class="o">)</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">  Hardware is Loopback
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">  Description: EVPN_Overlay_Peering
</span></span><span class="line"><span class="ln">10</span><span class="cl">  Internet address is 10.255.0.3/32
</span></span><span class="line"><span class="ln">11</span><span class="cl">  Broadcast address is 255.255.255.255
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl"><span class="o">[</span>ansible@veos-dc1-spine1 ~<span class="o">]</span>$ ip link show et1
</span></span><span class="line"><span class="ln">2</span><span class="cl">16: et1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="m">9194</span> qdisc pfifo_fast state UP mode DEFAULT group default qlen <span class="m">1000</span>
</span></span><span class="line"><span class="ln">3</span><span class="cl">    link/ether bc:24:11:4a:9a:d0 brd ff:ff:ff:ff:ff:ff
</span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="o">[</span>ansible@veos-dc1-spine1 ~<span class="o">]</span>$
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl"><span class="o">[</span>ansible@veos-dc1-spine2 ~<span class="o">]</span>$ ip link show et1
</span></span><span class="line"><span class="ln">2</span><span class="cl">22: et1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="m">9194</span> qdisc pfifo_fast state UP mode DEFAULT group default qlen <span class="m">1000</span>
</span></span><span class="line"><span class="ln">3</span><span class="cl">    link/ether bc:24:11:f5:c0:d2 brd ff:ff:ff:ff:ff:ff
</span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="o">[</span>ansible@veos-dc1-spine2 ~<span class="o">]</span>$
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="o">[</span>ansible@veos-dc1-leaf2a ~<span class="o">]</span>$ ip link show et1
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">26: et1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="m">9194</span> qdisc pfifo_fast state UP mode DEFAULT group default qlen <span class="m">1000</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">    link/ether bc:24:11:31:35:db brd ff:ff:ff:ff:ff:ff
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="o">[</span>ansible@veos-dc1-leaf2a ~<span class="o">]</span>$
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">veos-dc1-leaf2a#show interfaces loopback <span class="m">0</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">Loopback0 is up, line protocol is up <span class="o">(</span>connected<span class="o">)</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">  Hardware is Loopback
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">  Description: EVPN_Overlay_Peering
</span></span><span class="line"><span class="ln">10</span><span class="cl">  Internet address is 10.255.0.5/32
</span></span><span class="line"><span class="ln">11</span><span class="cl">  Broadcast address is 255.255.255.255
</span></span></code></pre></div><p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="icmp-request-reply"
      
        class="image_figure image_internal image_processed"
        width="1906"
        height="1446"
        src="/2024/11/08/overlay-on-overlay-arista-in-the-underlay/images/image-20241130133641620.png"
      
      
    />

    </picture>
</figure>
</p>
<p>This is fine, I can go home and rest, no one needs to use layer 2. Or... Well it depends.</p>
<p>Having solved a well performing layer 3 fabric, the routing in the underlay does not help me if I want layer 2 mobility between servers, virtual machines etc connected to different layer 3 leafs. This is where the overlay part comes in to the rescue. And to make it a bit more interesting, I will add several overlay layers into the mix.</p>
<h2 id="overlay-in-the-underlay">Overlay in the &quot;underlay&quot;</h2>
<p>In a Spine/Leaf architecture <strong>the</strong> most used overlay protocol is <a href="https://datatracker.ietf.org/doc/html/rfc7348">VXLAN</a> as the transport plane and BGP EVPN as the control plane. Why use overlay in the physical network you say? Well its the best way of moving L2 over L3, and in a &quot;distributed world&quot; as the services in the datacenter today mostly is we need to make sure this can be done in a controlled and effective way in our network. Doing pure L2 will not scale, L3 is the way. EVPN for multi-tenancy.</p>
<p>Adding VXLAN as the overlay protocol in my spine leaf fabric I can stretch my layer 2 networks across all my layer 3 leafs without worries. This means I can now suddenly have multiple servers physical as virtual in the same layer 2 subnet. To make that happen as effectively and with as low admin overhead as possible VXLAN will be the transport plane (overlay protocol) and again BGP will be used as the control plane. This means we now need to configure BGP in the overlay, on top of our BGP in the underlay. BGP EVPN will be used to create isolation and multi tenancy on top of the underlay. To quickly summarize, VXLAN is the transport protocol responsible of carrying the layer 2 subnets over any layer 3 link in the fabric. BGP and EVPN will be the control plane that always knows where things are located and can effectively inform where the traffic should go. This is stil all in the physical network fabric. As we will see a bit later, we can also introduce network overlay protocols in other parts of the infrastructure.</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="vxlan-l2-over-l3"
      
        class="image_figure image_internal image_processed"
        width="1884"
        height="1464"
        src="/2024/11/08/overlay-on-overlay-arista-in-the-underlay/images/image-20241127110441121.png"
      
      
    />

    </picture>
</figure>
</p>
<p>In the diagram above all my leaf switches has become VTEPs, VXLAN Tunnel Endpoints. Meaning they are responsible of taking my ethernet packet coming from server 1, encapsulate it, send it over the layer 3 links in my fabric, to the destination leaf where server 2 is located. The BGP configured in the overlay here is using an EVPN address family to advertise mac addresses. If one have a look at the ethernet packet coming from server 1 and destined to server 2 we will see some differerent mac addresses, depending on where you capture the traffic of course. Lets quickly illustrate that.</p>
<p>The two switches in the diagram above that will be the best place to look at all packages using tcpdump will be the spine 1 and spine 2 as they are connecting everything together and there is no direct communication between any leaf, they have to go through spine 1 and spine 2.</p>
<p>If I do a ping from server 1 to server 2 going over my VXLAN tunnel, how will the ethernet packet look like when captured at spine1s ethernet interface 1 (the one connected to leaf1a)?</p>
<p>Looking at the tcpdump below from <em>spine 1</em> I can clearly see some additional information added to the packet. First I see two mac addresses where source <code>bc:24:11:1d:5f:a1</code> is my <em>leaf1a</em>  and the destination mac address, <code>bc:24:11:4a:9a:d0</code> is my <em>spine1</em> switch. The first two ip addresses <code>10.255.1.3</code> and <code>10.255.1.4</code> is <em>leaf1a</em> and <em>leaf1b</em> VXLAN loopback interfaces respectively with the corresponding mac addresses <code>bc:24:11:1d:5f:a1</code>and <code>bc:24:11:9b:8f:08</code>. Then I get to the actual payload itself, the ICMP, between my <em>server 1</em> and <em>server 2</em> where I can see the source and destination ip of the actual servers doing the ping.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln">1</span><span class="cl"><span class="nt">15:44:33.125961 bc:24:11:1d:5f:a1 &gt; bc:24:11:4a:9a:d0, ethertype IPv4 (0x0800), length 148</span><span class="p">:</span><span class="w"> </span><span class="l">(tos 0x0, ttl 64, id 0, offset 0, flags [DF], proto UDP (17), length 134)</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w">    </span><span class="nt">10.255.1.3.53892 &gt; 10.255.1.4.4789</span><span class="p">:</span><span class="w"> </span><span class="l">VXLAN, flags [I] (0x08), vni 10</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w"></span><span class="nt">bc:24:11:1d:5f:a1 &gt; bc:24:11:9b:8f:08, ethertype IPv4 (0x0800), length 98</span><span class="p">:</span><span class="w"> </span><span class="l">(tos 0x0, ttl 63, id 6669, offset 0, flags [DF], proto ICMP (1), length 84)</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w">    </span><span class="nt">10.20.11.10 &gt; 10.20.12.10</span><span class="p">:</span><span class="w"> </span><span class="l">ICMP echo request, id 10, seq 108, length 64</span><span class="w">
</span></span></span></code></pre></div><p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="encap-decap"
      
        class="image_figure image_internal image_processed"
        width="2000"
        height="600"
        src="/2024/11/08/overlay-on-overlay-arista-in-the-underlay/images/vxlan_flow_diagram_2.gif"
      
      
    />

    </picture>
</figure>
</p>
<p>A quick explanation on what we are looking at. The ICMP request comes in from <em>server 1</em> to <em>leaf1a</em> and before it sends it to its destination leaf1b (vtep) it  encapsulates the packet by removing  some headers and adding some headers. As seen above it is adding an outer header including the source and destination VTEP mac addresses (leaf1a and leaf1b). Spine1 knows of the mac and IP address for both leaf1a and leaf1b. More info on VXLAN encapsulation further down.</p>
<p>Having a further look at a tcpdump in Wireshark captured at Spine1:</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="vxlan"
      
        class="image_figure image_internal image_processed"
        width="1808"
        height="346"
        src="/2024/11/08/overlay-on-overlay-arista-in-the-underlay/images/image-20241130141355245.png"
      
      
    />

    </picture>
</figure>
</p>
<p>I now notice another protocol in the header, VXLAN. The &quot;outer&quot; source IP and destination IP addresses are now my leaf1a and leaf1b's VXLAN loopback interfaces. The inner source and destination IP addresses will still be my original frame, namely server 1 and server 2's ip addresses:</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="inner-src-dst"
      
        class="image_figure image_internal image_processed"
        width="1800"
        height="874"
        src="/2024/11/08/overlay-on-overlay-arista-in-the-underlay/images/image-20241130141817568.png"
      
      
    />

    </picture>
</figure>
</p>
<h3 id="tcpdump-on-arista-switches-eos">TCPdump on Arista switches (EOS)</h3>
<p>Doing tcpdump on Arista switches is straight forward. Its just one of the benefits Arista has as it uses its EOS operating system which is a pure Linux operating system. I can do tcpdump directly from bash or remote. Here I will show a couple of methods of doing tcpumps in EOS.</p>
<div style="border-left: 4px solid #2196F3; background-color: #E3F2FD; padding: 10px; margin: 10px 0; color: #0000FF;"> <strong>Info:</strong>
As I am using vEOS (the virtual machine based EOS) I can capture dataplane traffic directly with tcpdump by using the virtual machine nics (eg vmnicX). On an actual Arista switch using the etX interfaces only captures controlplane traffic. To capture dataplane traffic on an Arista switch you can use mirror to CPU or monitoring ports. See the two links below for more info ->    </div>
<p><a href="https://arista.my.site.com/AristaCommunity/s/article/using-tcpdump-for-troubleshooting#Comm_Kna_ka0Uw0000005qxFIAQ_81">here</a> and <a href="https://arista.my.site.com/AristaCommunity/s/article/using-tcpdump-for-troubleshooting#Comm_Kna_ka02I000000QqZmQAK_44">here</a></p>
<p><em><strong>Locally on the switch in bash</strong></em></p>
<p>I will log in to the switch and be in my cli context, enter privilege mode (enable) then enter bash:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">veos-dc1-leaf1a&gt;enable
</span></span><span class="line"><span class="ln">2</span><span class="cl">veos-dc1-leaf1a#bash
</span></span><span class="line"><span class="ln">3</span><span class="cl">
</span></span><span class="line"><span class="ln">4</span><span class="cl">Arista Networks EOS shell
</span></span><span class="line"><span class="ln">5</span><span class="cl">
</span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="o">[</span>ansible@veos-dc1-leaf1a ~<span class="o">]</span>$
</span></span></code></pre></div><p>From here I have full access to the Linux operating system and can more or less use the exact same tools as I am used to in a regular Linux operating system.</p>
<p>To list all available interfaces, type <em>ip link</em> as usual.</p>
<p>Now I want to do a tcpdump in the interface where my Client 1 is connected and just have a quick look of whats going on:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl"><span class="o">[</span>ansible@veos-dc1-leaf1a ~<span class="o">]</span>$ tcpdump -i vmnicet5 -s <span class="m">0</span> -c <span class="m">2</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">tcpdump: verbose output suppressed, use -v<span class="o">[</span>v<span class="o">]</span>... <span class="k">for</span> full protocol decode
</span></span><span class="line"><span class="ln">3</span><span class="cl">listening on vmnicet5, link-type EN10MB <span class="o">(</span>Ethernet<span class="o">)</span>, snapshot length <span class="m">262144</span> bytes
</span></span><span class="line"><span class="ln">4</span><span class="cl">15:14:18.343604 bc:24:11:44:85:95 <span class="o">(</span>oui Unknown<span class="o">)</span> &gt; 00:1c:73:00:00:99 <span class="o">(</span>oui Arista Networks<span class="o">)</span>, ethertype IPv4 <span class="o">(</span>0x0800<span class="o">)</span>, length 98: 10.20.11.10 &gt; 10.20.12.10: ICMP <span class="nb">echo</span> request, id 11, seq 1302, length <span class="m">64</span>
</span></span><span class="line"><span class="ln">5</span><span class="cl">15:14:18.347329 bc:24:11:1d:5f:a1 <span class="o">(</span>oui Unknown<span class="o">)</span> &gt; bc:24:11:44:85:95 <span class="o">(</span>oui Unknown<span class="o">)</span>, ethertype IPv4 <span class="o">(</span>0x0800<span class="o">)</span>, length 98: 10.20.12.10 &gt; 10.20.11.10: ICMP <span class="nb">echo</span> reply, id 11, seq 1302, length <span class="m">64</span>
</span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="m">2</span> packets captured
</span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="m">3</span> packets received by filter
</span></span><span class="line"><span class="ln">8</span><span class="cl"><span class="m">0</span> packets dropped by kernel
</span></span><span class="line"><span class="ln">9</span><span class="cl"><span class="o">[</span>ansible@veos-dc1-leaf1a ~<span class="o">]</span>$
</span></span></code></pre></div><p>If I want to save a dump to a pcap file for Wireshark I can do the following:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="o">[</span>ansible@veos-dc1-leaf1a ~<span class="o">]</span>$ tcpdump -i vmnicet5 -s <span class="m">0</span> -c <span class="m">2</span> -w wireshark.pcap
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">tcpdump: listening on vmnicet5, link-type EN10MB <span class="o">(</span>Ethernet<span class="o">)</span>, snapshot length <span class="m">262144</span> bytes
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="m">2</span> packets captured
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="m">39</span> packets received by filter
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="m">0</span> packets dropped by kernel
</span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="o">[</span>ansible@veos-dc1-leaf1a ~<span class="o">]</span>$ ll
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">total <span class="m">4</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">-rw-r--r-- <span class="m">1</span> ansible eosadmin <span class="m">361</span> Nov <span class="m">28</span> 15:20 wireshark.pcap
</span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="o">[</span>ansible@veos-dc1-leaf1a ~<span class="o">]</span>$ <span class="nb">pwd</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">/home/ansible
</span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="o">[</span>ansible@veos-dc1-leaf1a ~<span class="o">]</span>$
</span></span></code></pre></div><p>Now I need to copy this one out of my switch to open it in Wireshark on my laptop. To do that I can use SCP. I will initate the scp command from my laptop and initiate the scp session from my laptop to my Arista switch and grab the file.</p>
<p>I have configured my out of band interface in a MGMT vrf, so for me to be able to access the switch via that interface I need to put the bash session on the switch in the MGMT vrf context. So before going into bash I need to enter the VRF and then enter bash.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="o">[</span>ansible@veos-dc1-leaf1a ~<span class="o">]</span>$ <span class="nb">exit</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="nb">logout</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">veos-dc1-leaf1a#cli vrf MGMT
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">veos-dc1-leaf1a<span class="o">(</span>vrf:MGMT<span class="o">)</span><span class="c1">#bash</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">Arista Networks EOS shell
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">
</span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="o">[</span>ansible@veos-dc1-leaf1a ~<span class="o">]</span>$ <span class="nb">pwd</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">/home/ansible
</span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="o">[</span>ansible@veos-dc1-leaf1a ~<span class="o">]</span>$ ls
</span></span><span class="line"><span class="ln">11</span><span class="cl">wireshark.pcap
</span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="o">[</span>ansible@veos-dc1-leaf1a ~<span class="o">]</span>$
</span></span></code></pre></div><p>Now I have placed bash in the correct context and grab the file using SCP from my client:</p>
<div style="border-left: 4px solid #2196F3; background-color: #E3F2FD; padding: 10px; margin: 10px 0; color: #0000FF;"> <strong>Info:</strong>
The user that logs into the switch needs to be allowed to log directly to Enable mode. This is done by adding the following:
AristaSwitch#aaa authorization exec default local 
** In configure mode ** 
 </div>
<p>From my client where I have Wireshark installed I will execute scp to copy the pcap file from the switch (<em>I can also run scp from the switch and copy to any destination</em>):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">➜  vxlan_dumps scp ansible@172.18.100.103:/home/ansible/wireshark.pcap .
</span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="o">(</span>ansible@172.18.100.103<span class="o">)</span> Password:
</span></span><span class="line"><span class="ln">3</span><span class="cl">wireshark.pcap                                                                                           100%  <span class="m">361</span>    46.1KB/s   00:00
</span></span><span class="line"><span class="ln">4</span><span class="cl">➜  vxlan_dumps
</span></span></code></pre></div><p>Now I can open it in Wireshark</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="wireshark"
      
        class="image_figure image_internal image_processed"
        width="1936"
        height="1261"
        src="/2024/11/08/overlay-on-overlay-arista-in-the-underlay/images/image-20241128153913617.png"
      
      
    />

    </picture>
</figure>
</p>
<p>When done, I can go back to the Arista switch log out of bash and into default vrf again like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl"><span class="o">[</span>ansible@veos-dc1-leaf1a ~<span class="o">]</span>$ <span class="nb">exit</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="nb">logout</span>
</span></span><span class="line"><span class="ln">3</span><span class="cl">veos-dc1-leaf1a<span class="o">(</span>vrf:MGMT<span class="o">)</span><span class="c1">#cli vrf default</span>
</span></span><span class="line"><span class="ln">4</span><span class="cl">veos-dc1-leaf1a#
</span></span></code></pre></div><p><em><strong>TCPdump remotely on the switch</strong></em></p>
<p>The first approach introduced many steps to get hold of some tcpdumps.</p>
<p>One can also trigger tcpdumps remotely and either show them in your own terminal session or dump to a pcap file.
To trigger the tcpdump and show live in your session I will now from my own client execute the following command:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">➜  vxlan_dumps ssh ansible@172.18.100.103 <span class="s2">&#34;bash tcpdump -s 0 -v -vv -w - -i vmnicet5 -c 4 icmp&#34;</span> <span class="p">|</span> tshark -i -
</span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="o">(</span>ansible@172.18.100.103<span class="o">)</span> Password: Capturing on <span class="s1">&#39;Standard input&#39;</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">tcpdump: listening on vmnicet5, link-type EN10MB <span class="o">(</span>Ethernet<span class="o">)</span>, snapshot length <span class="m">262144</span> bytes
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="m">4</span> packets captured
</span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="m">4</span> packets received by filter
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="m">0</span> packets dropped by kernel
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">    <span class="m">1</span>   0.000000  10.20.11.10 → 10.20.12.10  ICMP <span class="m">98</span> Echo <span class="o">(</span>ping<span class="o">)</span> request  <span class="nv">id</span><span class="o">=</span>0x000b, <span class="nv">seq</span><span class="o">=</span>3558/58893, <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">    <span class="m">2</span>   0.003400  10.20.12.10 → 10.20.11.10  ICMP <span class="m">98</span> Echo <span class="o">(</span>ping<span class="o">)</span> reply    <span class="nv">id</span><span class="o">=</span>0x000b, <span class="nv">seq</span><span class="o">=</span>3558/58893, <span class="nv">ttl</span><span class="o">=</span><span class="m">62</span> <span class="o">(</span>request in 1<span class="o">)</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">    <span class="m">3</span>   1.001586  10.20.11.10 → 10.20.12.10  ICMP <span class="m">98</span> Echo <span class="o">(</span>ping<span class="o">)</span> request  <span class="nv">id</span><span class="o">=</span>0x000b, <span class="nv">seq</span><span class="o">=</span>3559/59149, <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">    <span class="m">4</span>   1.005124  10.20.12.10 → 10.20.11.10  ICMP <span class="m">98</span> Echo <span class="o">(</span>ping<span class="o">)</span> reply    <span class="nv">id</span><span class="o">=</span>0x000b, <span class="nv">seq</span><span class="o">=</span>3559/59149, <span class="nv">ttl</span><span class="o">=</span><span class="m">62</span> <span class="o">(</span>request in 3<span class="o">)</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="m">4</span> packets captured
</span></span></code></pre></div><p>If I want to write to a pcap file and save the content directly on my laptop:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">➜  vxlan_dumps ssh ansible@172.18.100.103 <span class="s2">&#34;bash tcpdump -s 0 -v -vv -w - -i vmnicet5 icmp -c 2&#34;</span> &gt; wireshark.pcap
</span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="o">(</span>ansible@172.18.100.103<span class="o">)</span> Password:
</span></span><span class="line"><span class="ln">3</span><span class="cl">tcpdump: listening on vmnicet5, link-type EN10MB <span class="o">(</span>Ethernet<span class="o">)</span>, snapshot length <span class="m">262144</span> bytes
</span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="m">2</span> packets captured
</span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="m">2</span> packets received by filter
</span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="m">0</span> packets dropped by kernel
</span></span><span class="line"><span class="ln">7</span><span class="cl">➜  vxlan_dumps
</span></span></code></pre></div><p>Now I can open it in Wireshark. All the different tcpdump options and variables is ofcourse options to play around with. It is the exact tcpdump tool you use in your everyday Linux operating system. Its not a Arista specific tcpdump tool.</p>
<p>For more information using tcpdump and scp with Arista switches head over <a href="https://arista.my.site.com/AristaCommunity/s/article/using-tcpdump-for-troubleshooting">here</a> and <a href="https://arista.my.site.com/AristaCommunity/s/article/how-to-ftp-scp-winscp">here</a>.</p>
<h2 id="overlay-in-the-compute-stack">Overlay in the compute stack</h2>
<p>Up until now I have covered the underlay config briefly in a spine leaf, then the overlay in the spine leaf to overcome the layer 3 boundaries. But in the software or compute stack that is connecting to our fabric we can stumble upon other overlay protocols too.</p>
<p>Even though VXLAN is the most common overlay protocol, there are other overlay protocols being used in the datacenter, like <a href="https://datatracker.ietf.org/doc/html/rfc8926">Geneve</a>, and even NVGre and STT. This blog will discuss some typical scenarios where we deal with &quot;layers&quot; of overlay protocols.</p>
<p>Yes, the services connecting to my network also happen to use some kind of overlay protocol, can I have encapsulation on top of encapsulation? Yes, why not? In some environments we may even end up with overlay on top of overlay on top of another overlay (three &quot;layers&quot; of overlay). That's not possible, you are pulling a joke here right? No I am not, yes that is fully possible and occurs very frequent. But I will loose all visibility!? Why? Using VXLAN or Geneve does not mean the traffic is being encrypted. For an network admin its not always obvious that such scenarios exist, but they do and should be something to be aware of in case something goes wrong or they suddenly discovers a new overlay protocol in their network.</p>
<p>In such scenarios though, like the movie Inception, it will be important to know how things fits together, where to monitor, how to monitor, what to think of making sure there is nothing in the way of the tunnels to be established. This is something I will try to go through in this post. How these thing fits together.</p>
<p>One example of running overlay on top of overlay is in environments where VMware (by Broadcom) NSX is involved. VMware NSX is using Geneve<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup> to encapsulate their Layer2 NSX Segments over any fabric between their VTEPS (usually the ESXi host transport nodes, the NSX Edges is also considered TEPS in an NSX environment). If this is connected to a spine/leaf fabric we will have VXLAN and Geneve overlay protocols moving L2 segments between their own respective VTEPS (<em>VTEP for VXLAN, NSX just calls it TEP nowadays</em>).</p>
<p>Below we have a spine leaf fabric using VXLAN and NSX in the compute layer using Geneve. All network segments created in NSX leaving and entering a ESXi host will be encapsulated using Geneve, and that also means all services ingressing the leafs from these ESXi hosts will get another round of encapsulation using VXLAN. I will describe this a bit better later, below is a very high level illustration.</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="nsx-teps-arista-vteps"
      
        class="image_figure image_internal image_processed"
        width="3384"
        height="1110"
        src="/2024/11/08/overlay-on-overlay-arista-in-the-underlay/images/image-20241108111853681.png"
      
      
    />

    </picture>
</figure>
</p>
<p>But what if we are also running Kubernetes in our VMware NSX environment, which also happens to use some kind of overlay protocol (common CNIs supports VXLAN/Geneve/NVGre/STT) between the control plane and worker nodes. That will be hard to do right? Should we disable encapsulation in our Kubernetes clusters then? No, well it depends of course, but if you dont have any specific requirements to NOT use overlay (<em>like no-snat</em>) between your Kubernetes nodes then it makes your Kubernetes network connectivity (like pod to pod across nodes) so much easier.</p>
<p>How will this look like then?</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="kubernetes-overlay"
      
        class="image_figure image_internal image_processed"
        width="3386"
        height="1488"
        src="/2024/11/08/overlay-on-overlay-arista-in-the-underlay/images/image-20241108122625081.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Doesn't look that bad? Now if I were Leonardo DiCaprio in Inception it would be a walk in the park.</p>
<h2 id="where-is-encapsulation-and-decapsulation-done">Where is encapsulation and decapsulation done</h2>
<p>It is important to know where the ethernet frames are being encapsulated and decapsulated so one can understand where things may go wrong. Lets start with the Spine/Leaf fabric.</p>
<p>When traffic or the network services enters or ingresses on any of the leafs in the fabric its the leafs role to encapsulate and decapsulate the traffic. The leafs in a VXLAN spine/leaf fabric are considered our VTEP's (VXLAN Tunnel Endpoints). I have two servers connected to two different leafs, and also happens to be on two different VNIs (VXLAN Network Identifier), where server A needs to send a packet to server B the receiving leaf will encapsulate the ingress, then send it via any of the spines to the leaf where server B is connected and this leaf will then decapsulate the packet before its delivered to server B. See below:</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="spine/leaf/encap-decap"
      
        class="image_figure image_internal image_processed"
        width="2536"
        height="1088"
        src="/2024/11/08/overlay-on-overlay-arista-in-the-underlay/images/image-20241110201118681.png"
      
      
    />

    </picture>
</figure>
</p>
<p>How will this look if I add NSX into the mix? The below traffic flow will only be true if source and destination is not leaving the NSX &quot;fabric&quot;, meaning it is traffic between two vms in same NSX segment or two different NSX segments. If traffic is destined to go outside the NSX fabric it will need to leave via the NSX edges which will &quot;normalise&quot; the traffic and decapsulate the traffic to regular MTU size 1500 if not adjusted in the Edge uplinks to use bigger mtu size than default 1500.</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="nsx-over-vxlan"
      
        class="image_figure image_internal image_processed"
        width="2594"
        height="1626"
        src="/2024/11/08/overlay-on-overlay-arista-in-the-underlay/images/image-20241110202627504.png"
      
      
    />

    </picture>
</figure>
</p>
<p>What about Kubernetes as the third overlay layer?</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="kubernetes-encapsulation"
      
        class="image_figure image_internal image_processed"
        width="2198"
        height="1456"
        src="/2024/11/08/overlay-on-overlay-arista-in-the-underlay/images/image-20241110203609485.png"
      
      
    />

    </picture>
</figure>
</p>
<p>When traffic egresses a Kubernetes nodes configured to use VXLAN or Geneve it will encapsulate the original header, if the Kubernetes nodes are running in a NSX segment the ESXi hosts currently holding the Kubernetes nodes will then add its encapsulation before egressing the packet, and finally this traffic will hit the physical Arista VTEPS/Leaf switches in the physical fabric which will also add its encapsulation before egressing to the spines. Then from the leaf to the esxi hosts to the pods the traffic will slowly but surely be decapsulated to finally arrive at the destination as the original ethernet frame stripped from any additional encapsulation headers.</p>
<h2 id="will-it-fit-then">Will it fit then?</h2>
<p>A default IP frame size is 1500MTU (Maximum Transmission Unit). When encapsulating a standard ethernet frame using VXLAN some headers are removed from the original frame, and additional headers are being added. See illustration:</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="std-eth-frame"
      
        class="image_figure image_internal image_processed"
        width="1940"
        height="370"
        src="/2024/11/08/overlay-on-overlay-arista-in-the-underlay/images/image-20241109101619428.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Standard Ethernet frame to a VXLAN encapsulated ethernet frame:</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="headers-stripped-and-added"
      
        class="image_figure image_internal image_processed"
        width="2746"
        height="1550"
        src="/2024/11/08/overlay-on-overlay-arista-in-the-underlay/images/image-20241109102130032.png"
      
      
    />

    </picture>
</figure>
</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="vxlan-encapsulation"
      
        class="image_figure image_internal image_processed"
        width="2526"
        height="1022"
        src="/2024/11/08/overlay-on-overlay-arista-in-the-underlay/images/image-20241109102047130.png"
      
      
    />

    </picture>
</figure>
</p>
<p><em>See more explanation on ethernet mtu and ip mtu further down.</em></p>
<p>These additional headers requires some more room which makes the default size of 1500mtu too small. So in a very simple setup using VXLAN encapsulation we need to accomodate for this increase in size.  If this is not considered you will end up with nothing working. A general rule of thumb, VXLAN and Geneve will not handle fragmentation and will drop if it does not fit. A new buzzword will then become <em>its always MTU</em>.</p>
<p>Why is that? Imagine you have a rather big car and the road you are driving has a tunnel, this tunnel is not big enough to actually fit your car (One of the few times in your life, but assume its a monster truck you are driving). If you dont pay attention and just make a run for it, entering the tunnel will come to a hard stop.</p>
<img src=images/image-20241109103140283.png style="width:600px" />
<p>And if something should happen to come out on the other side of the tunnel it will most likely be fragments of the car. Which we dont like. We do like our cars whole, as we like our network packets whole.</p>
<p>If the tunnel is big enough to accommodate the biggest monster truck, then it should be fine.</p>
<img src=images/image-20241109103359204.png style="width:600px" />
<p>The monster truck both enters and exits the tunnel safe and sound and in the exact same shape it entered. No pieces torn off or ripped off to fit the tunnel.</p>
<p>If the tunnel will bearly fit the car, you can bet some pieces would be torn off, like side mirrors etc. This can be translated into dropped packets, which we dont want.</p>
<p>If the monster truck diagram is not depictive enough, lets try another illustration. Imagine you have two steel pipes of equal diameter and width and you want one pipe to be inserted into the other pipe to maybe extend the total length by combining the two. Pretty hard to do, welding is propably your best option here. But if one pipe had a smaller diameter so it could actually fit inside the other pipe, then it would slide in without any issue.</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="pipe-into-pipe-into-pipe"
      
        class="image_figure image_internal image_processed"
        width="1440"
        height="160"
        src="/2024/11/08/overlay-on-overlay-arista-in-the-underlay/images/image-20241110194248212.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Imagine the last pipe on the right is the Arista spine/leaf fabric. This should be the part of the infrastructure that must accommodate the biggest allowed MTU size. Then the green pipe will be the NSX environment which needs to tune their MTU setting on the TEP side (host profile) to fit the MTU size set in the Arista Fabric. Arista is default configured to use 9214 MTU. Then the Kubernetes cluster running in NSX segments also needs to adapt to the MTU size in the NSX environment.</p>
<p>This should be fairly easy to calculate as long as one know which overlay protocol being used, how much the additional headers will impose on the ethernet frame. See VXLAN above. Be aware that VXLAN has fixed headers so you will always know the exact MTU size, Geneve on the other hand (call it an VXLAN extension) is using dynamic headers and needs to be taken into consideration, it may need more room than VXLAN.</p>
<p>For VLXLAN we need at least 50 additional bytes: 14b (outer ethernet header) + 20b (outer IP header) + 8b (outer udp header) + 8b (VXLAN header) = 50b</p>
<p>So, to summarize. As long as one are aware of these MTU requirements it should be fine to run multiple stacked overlay protocols.</p>
<h2 id="simulating-an-environment-with-triple-encapsulation">Simulating an environment with triple encapsulation</h2>
<p>I have configured in my lab a spine leaf fabric using Arista vEOS switches. It is a full spine leaf fabric using EVPN and VXLAN. The fabric has been configured with 3 VRFS. A dedicated oob mgmt vrf called MGMT. Then VRF 10 for vlan 11-13 and VRF 11 for vlan 21-23. Then I have attached three virtual machines on each of their leaf switches. Server 1 is attached to leaf1a, server 2 is attached to leaf1b and server 3 is attached to leaf2a. These three servers have been configured with two network cards each.</p>
<p>NIC1 (ens18) on all three have been configured and placed in VRF10 but in their own vlan, vlan 11-13 respectively for their &quot;management&quot; interface. VRF 10 is the only VRF that is configured to reach internet. NIC2 (ens19) on all three servers have been configured and placed in an another VRF, VRF11, also placed in their separate vlan (vlan 21-23) respectively. NIC2 (ens19) have been configured to use VXLAN via a bridge called br-vxlan on all three servers to span a common layer 2 subnet across these 3 servers. Kubernetes is installed and configured on these servers. The pod network is using the second nic interfaces over VXLAN and the CNI inside Kubernetes has been configured to provide its own overlay protocol which happens to be Geneve. So in this scenario I have 3 overlay protocols in motion. VXLAN configured in my Arista spine leaf, VXLAN in the Ubuntu operating system layer, then Geneve in the pod network stack.
<em>The only reason I have chosen to use a dedicated management interface is just so I can have a network that is only encapsulated in my Arista fabric. Kubernetes can work perfectly well with just on network card, also most common config.</em></p>
<p>I have tried to illustrate my setup below, to get some more context.</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="kubernetes-compute-layer"
      
        class="image_figure image_internal image_processed"
        width="2406"
        height="1410"
        src="/2024/11/08/overlay-on-overlay-arista-in-the-underlay/images/image-20241130160953187.png"
      
      
    />

    </picture>
</figure>
</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="three-overlays"
      
        class="image_figure image_internal image_processed"
        width="2148"
        height="1452"
        src="/2024/11/08/overlay-on-overlay-arista-in-the-underlay/images/image-20241201104907035.png"
      
      
    />

    </picture>
</figure>
</p>
<table>
<thead>
<tr>
<th>Server 1</th>
<th>Server 2</th>
<th>Server 3</th>
</tr>
</thead>
<tbody>
<tr>
<td>ens18 - 10.20.11.10/24</td>
<td>ens18 - 10.20.12.10/24</td>
<td>ens18 - 10.20.13.10/24</td>
</tr>
<tr>
<td>ens19 - 10.21.21.10/24</td>
<td>ens19 - 10.21.22.10/24</td>
<td>ens19 - 10.21.23.10/24</td>
</tr>
<tr>
<td>br-vxlan (vxlan via ens19) - 192.168.100.11/24</td>
<td>br-vxlan (vxlan via ens19) - 192.168.100.12/24</td>
<td>br-vxlan (vxlan via ens19) - 192.168.100.13/24</td>
</tr>
<tr>
<td>antrea-gw0 (interface mtu -50)</td>
<td>antrea-gw0 (interface mtu -50)</td>
<td>antrea-gw0 (interface mtu -50)</td>
</tr>
<tr>
<td>pod-cidr (Antrea geneve tun0 via ens19) 10.40.0.0/24</td>
<td>pod-cidr (Antrea geneve tun0 via ens19) 10.40.1.0/24</td>
<td>pod-cidr (Antrea geneve tun0 via ens19) 10.40.2.0/24</td>
</tr>
</tbody>
</table>
<p><em>K8s cluster pod cidr is 10.40.0.0/16, each node carves out pr default a /24.</em></p>
<p>When the 3 nodes communicate with each other using ens18 they will only be encapsulated once, but when using the br-vxlan interface it will be double encapsulated, first vxlan in the server, then in the Arista fabric. When the pods communicate between nodes I will end up with triple encapsulation, Geneve, VXLAN in the server then VXLAN in the Arista fabric. Now it starts to be interesting.
The Antrea CNI has been configured to use br-vxlan as pod transport interface:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln">1</span><span class="cl"><span class="c"># traffic across Nodes.</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="nt">transportInterface</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;br-vxlan&#34;</span><span class="w">
</span></span></span></code></pre></div><p><em>A note on the Antrea CNI geneve tunnel. When Antrea is deployed in the cluster it will automatically adjust the MTU based on the interfaces it is selected to use a transport interface. It does that by reading the current MTU, if it is 1500 on the transport interface it will create a Antrea GW interface -50 MTU. If br-vxlan as above is 1500MTU Antrea GW will then be 1450MTU. If I happen to adjust this MTU at a later stage to either a higher or lower MTU I just need to restart the Antrea Agents and the respective Antrea GW interfaces should automatically adjust to the new MTU again. So in theory the Antrea GW should not be making any headaches in regards to MTU issues, but one never know and it should be something to be aware of.</em></p>
<h3 id="let-see-some-triple-encapsulation-in-action">Let see some triple encapsulation in action</h3>
<p>I have two pods deployed called <em>ubuntu-1</em> and <em>ubuntu-2</em> with one Ubuntu container instance in each pod, these two are running on ther own Kubernetes node 1 and 2. So they have to egress the nodes to communicate. How will this look like if I do a TCP dump on leaf1b (source), where node1 is connected, if I initiate a ping from pod ubuntu-1 and ubuntu-2?</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="pod-2-pod"
      
        class="image_figure image_internal image_processed"
        width="2082"
        height="1464"
        src="/2024/11/08/overlay-on-overlay-arista-in-the-underlay/images/image-20241201114908055.png"
      
      
    />

    </picture>
</figure>
</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="protocols-in-frame"
      
        class="image_figure image_internal image_processed"
        width="1178"
        height="453"
        src="/2024/11/08/overlay-on-overlay-arista-in-the-underlay/images/image-20241202101352635.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Protocols in frame: vxlan, vxlan and geneve - look at that. Lets break it down further, layer by layer.</p>
<p>As there is some encapsulation going on for sure, at different layers, it can be a good excercise to a layer by layer breakdown:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">    <span class="o">[</span>Protocols in frame: eth:ethertype:ip:udp:vxlan:eth:ethertype:ip:udp:vxlan:eth:ethertype:ip:udp:geneve:eth:ethertype:ip:icmp:data<span class="o">]</span>
</span></span></code></pre></div><p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="layer-by-layer"
      
        class="image_figure image_internal image_processed"
        width="3306"
        height="1382"
        src="/2024/11/08/overlay-on-overlay-arista-in-the-underlay/images/image-20241202134602692.png"
      
      
    />

    </picture>
</figure>
</p>
<p>In total 4 pairs of source &gt; destination ip addresses, including the actual payload ICMP packet between the two pods.</p>
<p>Full dump for reference below.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">  1</span><span class="cl">Frame 7: <span class="m">248</span> bytes on wire <span class="o">(</span><span class="m">1984</span> bits<span class="o">)</span>, <span class="m">248</span> bytes captured <span class="o">(</span><span class="m">1984</span> bits<span class="o">)</span>
</span></span><span class="line"><span class="ln">  2</span><span class="cl">    Encapsulation type: Ethernet <span class="o">(</span>1<span class="o">)</span>
</span></span><span class="line"><span class="ln">  3</span><span class="cl">    Arrival Time: Dec  2, <span class="m">2024</span> 10:01:56.510773000 CET
</span></span><span class="line"><span class="ln">  4</span><span class="cl">    UTC Arrival Time: Dec  2, <span class="m">2024</span> 09:01:56.510773000 UTC
</span></span><span class="line"><span class="ln">  5</span><span class="cl">    Epoch Arrival Time: 1733130116.510773000
</span></span><span class="line"><span class="ln">  6</span><span class="cl">    <span class="o">[</span>Time <span class="nb">shift</span> <span class="k">for</span> this packet: 0.000000000 seconds<span class="o">]</span>
</span></span><span class="line"><span class="ln">  7</span><span class="cl">    <span class="o">[</span>Time delta from previous captured frame: 0.034183000 seconds<span class="o">]</span>
</span></span><span class="line"><span class="ln">  8</span><span class="cl">    <span class="o">[</span>Time delta from previous displayed frame: 0.034183000 seconds<span class="o">]</span>
</span></span><span class="line"><span class="ln">  9</span><span class="cl">    <span class="o">[</span>Time since reference or first frame: 0.229242000 seconds<span class="o">]</span>
</span></span><span class="line"><span class="ln"> 10</span><span class="cl">    Frame Number: <span class="m">7</span>
</span></span><span class="line"><span class="ln"> 11</span><span class="cl">    Frame Length: <span class="m">248</span> bytes <span class="o">(</span><span class="m">1984</span> bits<span class="o">)</span>
</span></span><span class="line"><span class="ln"> 12</span><span class="cl">    Capture Length: <span class="m">248</span> bytes <span class="o">(</span><span class="m">1984</span> bits<span class="o">)</span>
</span></span><span class="line"><span class="ln"> 13</span><span class="cl">    <span class="o">[</span>Frame is marked: False<span class="o">]</span>
</span></span><span class="line"><span class="ln"> 14</span><span class="cl">    <span class="o">[</span>Frame is ignored: False<span class="o">]</span>
</span></span><span class="line"><span class="ln"> 15</span><span class="cl">    <span class="o">[</span>Protocols in frame: eth:ethertype:ip:udp:vxlan:eth:ethertype:ip:udp:vxlan:eth:ethertype:ip:udp:geneve:eth:ethertype:ip:icmp:data<span class="o">]</span>
</span></span><span class="line"><span class="ln"> 16</span><span class="cl">    <span class="o">[</span>Coloring Rule Name: ICMP<span class="o">]</span>
</span></span><span class="line"><span class="ln"> 17</span><span class="cl">    <span class="o">[</span>Coloring Rule String: icmp <span class="o">||</span> icmpv6<span class="o">]</span>
</span></span><span class="line"><span class="ln"> 18</span><span class="cl">Ethernet II, Src: ProxmoxServe_9b:8f:08 <span class="o">(</span>bc:24:11:9b:8f:08<span class="o">)</span>, Dst: ProxmoxServe_4a:9a:d0 <span class="o">(</span>bc:24:11:4a:9a:d0<span class="o">)</span>
</span></span><span class="line"><span class="ln"> 19</span><span class="cl">    Destination: ProxmoxServe_4a:9a:d0 <span class="o">(</span>bc:24:11:4a:9a:d0<span class="o">)</span>
</span></span><span class="line"><span class="ln"> 20</span><span class="cl">    Source: ProxmoxServe_9b:8f:08 <span class="o">(</span>bc:24:11:9b:8f:08<span class="o">)</span>
</span></span><span class="line"><span class="ln"> 21</span><span class="cl">    Type: IPv4 <span class="o">(</span>0x0800<span class="o">)</span>
</span></span><span class="line"><span class="ln"> 22</span><span class="cl">    <span class="o">[</span>Stream index: 0<span class="o">]</span>
</span></span><span class="line"><span class="ln"> 23</span><span class="cl">Internet Protocol Version 4, Src: 10.255.1.4, Dst: 10.255.1.5
</span></span><span class="line"><span class="ln"> 24</span><span class="cl">    <span class="m">0100</span> .... <span class="o">=</span> Version: <span class="m">4</span>
</span></span><span class="line"><span class="ln"> 25</span><span class="cl">    .... <span class="nv">0101</span> <span class="o">=</span> Header Length: <span class="m">20</span> bytes <span class="o">(</span>5<span class="o">)</span>
</span></span><span class="line"><span class="ln"> 26</span><span class="cl">    Differentiated Services Field: 0x00 <span class="o">(</span>DSCP: CS0, ECN: Not-ECT<span class="o">)</span>
</span></span><span class="line"><span class="ln"> 27</span><span class="cl">        <span class="m">0000</span> 00.. <span class="o">=</span> Differentiated Services Codepoint: Default <span class="o">(</span>0<span class="o">)</span>
</span></span><span class="line"><span class="ln"> 28</span><span class="cl">        .... ..00 <span class="o">=</span> Explicit Congestion Notification: Not ECN-Capable Transport <span class="o">(</span>0<span class="o">)</span>
</span></span><span class="line"><span class="ln"> 29</span><span class="cl">    Total Length: <span class="m">234</span>
</span></span><span class="line"><span class="ln"> 30</span><span class="cl">    Identification: 0x0000 <span class="o">(</span>0<span class="o">)</span>
</span></span><span class="line"><span class="ln"> 31</span><span class="cl">    010. .... <span class="o">=</span> Flags: 0x2, Don<span class="s1">&#39;t fragment
</span></span></span><span class="line"><span class="ln"> 32</span><span class="cl"><span class="s1">    ...0 0000 0000 0000 = Fragment Offset: 0
</span></span></span><span class="line"><span class="ln"> 33</span><span class="cl"><span class="s1">    Time to Live: 64
</span></span></span><span class="line"><span class="ln"> 34</span><span class="cl"><span class="s1">    Protocol: UDP (17)
</span></span></span><span class="line"><span class="ln"> 35</span><span class="cl"><span class="s1">    Header Checksum: 0x21fd [validation disabled]
</span></span></span><span class="line"><span class="ln"> 36</span><span class="cl"><span class="s1">    [Header checksum status: Unverified]
</span></span></span><span class="line"><span class="ln"> 37</span><span class="cl"><span class="s1">    Source Address: 10.255.1.4
</span></span></span><span class="line"><span class="ln"> 38</span><span class="cl"><span class="s1">    Destination Address: 10.255.1.5
</span></span></span><span class="line"><span class="ln"> 39</span><span class="cl"><span class="s1">    [Stream index: 4]
</span></span></span><span class="line"><span class="ln"> 40</span><span class="cl"><span class="s1">User Datagram Protocol, Src Port: 64509, Dst Port: 4789
</span></span></span><span class="line"><span class="ln"> 41</span><span class="cl"><span class="s1">    Source Port: 64509
</span></span></span><span class="line"><span class="ln"> 42</span><span class="cl"><span class="s1">    Destination Port: 4789
</span></span></span><span class="line"><span class="ln"> 43</span><span class="cl"><span class="s1">    Length: 214
</span></span></span><span class="line"><span class="ln"> 44</span><span class="cl"><span class="s1">    Checksum: 0x0000 [zero-value ignored]
</span></span></span><span class="line"><span class="ln"> 45</span><span class="cl"><span class="s1">    [Stream index: 7]
</span></span></span><span class="line"><span class="ln"> 46</span><span class="cl"><span class="s1">    [Stream Packet Number: 1]
</span></span></span><span class="line"><span class="ln"> 47</span><span class="cl"><span class="s1">    [Timestamps]
</span></span></span><span class="line"><span class="ln"> 48</span><span class="cl"><span class="s1">    UDP payload (206 bytes)
</span></span></span><span class="line"><span class="ln"> 49</span><span class="cl"><span class="s1">Virtual eXtensible Local Area Network
</span></span></span><span class="line"><span class="ln"> 50</span><span class="cl"><span class="s1">    Flags: 0x0800, VXLAN Network ID (VNI)
</span></span></span><span class="line"><span class="ln"> 51</span><span class="cl"><span class="s1">    Group Policy ID: 0
</span></span></span><span class="line"><span class="ln"> 52</span><span class="cl"><span class="s1">    VXLAN Network Identifier (VNI): 11
</span></span></span><span class="line"><span class="ln"> 53</span><span class="cl"><span class="s1">    Reserved: 0
</span></span></span><span class="line"><span class="ln"> 54</span><span class="cl"><span class="s1">Ethernet II, Src: ProxmoxServe_9b:8f:08 (bc:24:11:9b:8f:08), Dst: ProxmoxServe_31:35:db (bc:24:11:31:35:db)
</span></span></span><span class="line"><span class="ln"> 55</span><span class="cl"><span class="s1">    Destination: ProxmoxServe_31:35:db (bc:24:11:31:35:db)
</span></span></span><span class="line"><span class="ln"> 56</span><span class="cl"><span class="s1">    Source: ProxmoxServe_9b:8f:08 (bc:24:11:9b:8f:08)
</span></span></span><span class="line"><span class="ln"> 57</span><span class="cl"><span class="s1">    Type: IPv4 (0x0800)
</span></span></span><span class="line"><span class="ln"> 58</span><span class="cl"><span class="s1">    [Stream index: 3]
</span></span></span><span class="line"><span class="ln"> 59</span><span class="cl"><span class="s1">Internet Protocol Version 4, Src: 10.21.22.10, Dst: 10.21.23.10
</span></span></span><span class="line"><span class="ln"> 60</span><span class="cl"><span class="s1">    0100 .... = Version: 4
</span></span></span><span class="line"><span class="ln"> 61</span><span class="cl"><span class="s1">    .... 0101 = Header Length: 20 bytes (5)
</span></span></span><span class="line"><span class="ln"> 62</span><span class="cl"><span class="s1">    Differentiated Services Field: 0x00 (DSCP: CS0, ECN: Not-ECT)
</span></span></span><span class="line"><span class="ln"> 63</span><span class="cl"><span class="s1">        0000 00.. = Differentiated Services Codepoint: Default (0)
</span></span></span><span class="line"><span class="ln"> 64</span><span class="cl"><span class="s1">        .... ..00 = Explicit Congestion Notification: Not ECN-Capable Transport (0)
</span></span></span><span class="line"><span class="ln"> 65</span><span class="cl"><span class="s1">    Total Length: 184
</span></span></span><span class="line"><span class="ln"> 66</span><span class="cl"><span class="s1">    Identification: 0x0de9 (3561)
</span></span></span><span class="line"><span class="ln"> 67</span><span class="cl"><span class="s1">    000. .... = Flags: 0x0
</span></span></span><span class="line"><span class="ln"> 68</span><span class="cl"><span class="s1">    ...0 0000 0000 0000 = Fragment Offset: 0
</span></span></span><span class="line"><span class="ln"> 69</span><span class="cl"><span class="s1">    Time to Live: 63
</span></span></span><span class="line"><span class="ln"> 70</span><span class="cl"><span class="s1">    Protocol: UDP (17)
</span></span></span><span class="line"><span class="ln"> 71</span><span class="cl"><span class="s1">    Header Checksum: 0x2c0f [validation disabled]
</span></span></span><span class="line"><span class="ln"> 72</span><span class="cl"><span class="s1">    [Header checksum status: Unverified]
</span></span></span><span class="line"><span class="ln"> 73</span><span class="cl"><span class="s1">    Source Address: 10.21.22.10
</span></span></span><span class="line"><span class="ln"> 74</span><span class="cl"><span class="s1">    Destination Address: 10.21.23.10
</span></span></span><span class="line"><span class="ln"> 75</span><span class="cl"><span class="s1">    [Stream index: 5]
</span></span></span><span class="line"><span class="ln"> 76</span><span class="cl"><span class="s1">User Datagram Protocol, Src Port: 56889, Dst Port: 4789
</span></span></span><span class="line"><span class="ln"> 77</span><span class="cl"><span class="s1">    Source Port: 56889
</span></span></span><span class="line"><span class="ln"> 78</span><span class="cl"><span class="s1">    Destination Port: 4789
</span></span></span><span class="line"><span class="ln"> 79</span><span class="cl"><span class="s1">    Length: 164
</span></span></span><span class="line"><span class="ln"> 80</span><span class="cl"><span class="s1">    Checksum: 0x91c6 [unverified]
</span></span></span><span class="line"><span class="ln"> 81</span><span class="cl"><span class="s1">    [Checksum Status: Unverified]
</span></span></span><span class="line"><span class="ln"> 82</span><span class="cl"><span class="s1">    [Stream index: 8]
</span></span></span><span class="line"><span class="ln"> 83</span><span class="cl"><span class="s1">    [Stream Packet Number: 1]
</span></span></span><span class="line"><span class="ln"> 84</span><span class="cl"><span class="s1">    [Timestamps]
</span></span></span><span class="line"><span class="ln"> 85</span><span class="cl"><span class="s1">    UDP payload (156 bytes)
</span></span></span><span class="line"><span class="ln"> 86</span><span class="cl"><span class="s1">Virtual eXtensible Local Area Network
</span></span></span><span class="line"><span class="ln"> 87</span><span class="cl"><span class="s1">    Flags: 0x0800, VXLAN Network ID (VNI)
</span></span></span><span class="line"><span class="ln"> 88</span><span class="cl"><span class="s1">    Group Policy ID: 0
</span></span></span><span class="line"><span class="ln"> 89</span><span class="cl"><span class="s1">    VXLAN Network Identifier (VNI): 666
</span></span></span><span class="line"><span class="ln"> 90</span><span class="cl"><span class="s1">    Reserved: 0
</span></span></span><span class="line"><span class="ln"> 91</span><span class="cl"><span class="s1">Ethernet II, Src: 0e:a9:a0:1b:df:4b (0e:a9:a0:1b:df:4b), Dst: a6:58:bc:c5:47:62 (a6:58:bc:c5:47:62)
</span></span></span><span class="line"><span class="ln"> 92</span><span class="cl"><span class="s1">    Destination: a6:58:bc:c5:47:62 (a6:58:bc:c5:47:62)
</span></span></span><span class="line"><span class="ln"> 93</span><span class="cl"><span class="s1">    Source: 0e:a9:a0:1b:df:4b (0e:a9:a0:1b:df:4b)
</span></span></span><span class="line"><span class="ln"> 94</span><span class="cl"><span class="s1">    Type: IPv4 (0x0800)
</span></span></span><span class="line"><span class="ln"> 95</span><span class="cl"><span class="s1">    [Stream index: 2]
</span></span></span><span class="line"><span class="ln"> 96</span><span class="cl"><span class="s1">Internet Protocol Version 4, Src: 192.168.100.12, Dst: 192.168.100.13
</span></span></span><span class="line"><span class="ln"> 97</span><span class="cl"><span class="s1">    0100 .... = Version: 4
</span></span></span><span class="line"><span class="ln"> 98</span><span class="cl"><span class="s1">    .... 0101 = Header Length: 20 bytes (5)
</span></span></span><span class="line"><span class="ln"> 99</span><span class="cl"><span class="s1">    Differentiated Services Field: 0x00 (DSCP: CS0, ECN: Not-ECT)
</span></span></span><span class="line"><span class="ln">100</span><span class="cl"><span class="s1">        0000 00.. = Differentiated Services Codepoint: Default (0)
</span></span></span><span class="line"><span class="ln">101</span><span class="cl"><span class="s1">        .... ..00 = Explicit Congestion Notification: Not ECN-Capable Transport (0)
</span></span></span><span class="line"><span class="ln">102</span><span class="cl"><span class="s1">    Total Length: 134
</span></span></span><span class="line"><span class="ln">103</span><span class="cl"><span class="s1">    Identification: 0x8e54 (36436)
</span></span></span><span class="line"><span class="ln">104</span><span class="cl"><span class="s1">    010. .... = Flags: 0x2, Don&#39;</span>t fragment
</span></span><span class="line"><span class="ln">105</span><span class="cl">    ...0 <span class="m">0000</span> <span class="m">0000</span> <span class="nv">0000</span> <span class="o">=</span> Fragment Offset: <span class="m">0</span>
</span></span><span class="line"><span class="ln">106</span><span class="cl">    Time to Live: <span class="m">64</span>
</span></span><span class="line"><span class="ln">107</span><span class="cl">    Protocol: UDP <span class="o">(</span>17<span class="o">)</span>
</span></span><span class="line"><span class="ln">108</span><span class="cl">    Header Checksum: 0x62a8 <span class="o">[</span>validation disabled<span class="o">]</span>
</span></span><span class="line"><span class="ln">109</span><span class="cl">    <span class="o">[</span>Header checksum status: Unverified<span class="o">]</span>
</span></span><span class="line"><span class="ln">110</span><span class="cl">    Source Address: 192.168.100.12
</span></span><span class="line"><span class="ln">111</span><span class="cl">    Destination Address: 192.168.100.13
</span></span><span class="line"><span class="ln">112</span><span class="cl">    <span class="o">[</span>Stream index: 3<span class="o">]</span>
</span></span><span class="line"><span class="ln">113</span><span class="cl">User Datagram Protocol, Src Port: 19380, Dst Port: <span class="m">6081</span>
</span></span><span class="line"><span class="ln">114</span><span class="cl">    Source Port: <span class="m">19380</span>
</span></span><span class="line"><span class="ln">115</span><span class="cl">    Destination Port: <span class="m">6081</span>
</span></span><span class="line"><span class="ln">116</span><span class="cl">    Length: <span class="m">114</span>
</span></span><span class="line"><span class="ln">117</span><span class="cl">    Checksum: 0x0000 <span class="o">[</span>zero-value ignored<span class="o">]</span>
</span></span><span class="line"><span class="ln">118</span><span class="cl">    <span class="o">[</span>Stream index: 9<span class="o">]</span>
</span></span><span class="line"><span class="ln">119</span><span class="cl">    <span class="o">[</span>Stream Packet Number: 1<span class="o">]</span>
</span></span><span class="line"><span class="ln">120</span><span class="cl">    <span class="o">[</span>Timestamps<span class="o">]</span>
</span></span><span class="line"><span class="ln">121</span><span class="cl">    UDP payload <span class="o">(</span><span class="m">106</span> bytes<span class="o">)</span>
</span></span><span class="line"><span class="ln">122</span><span class="cl">Generic Network Virtualization Encapsulation, VNI: 0x000000
</span></span><span class="line"><span class="ln">123</span><span class="cl">Ethernet II, Src: ce:7f:43:8a:0e:3c <span class="o">(</span>ce:7f:43:8a:0e:3c<span class="o">)</span>, Dst: aa:bb:cc:dd:ee:ff <span class="o">(</span>aa:bb:cc:dd:ee:ff<span class="o">)</span>
</span></span><span class="line"><span class="ln">124</span><span class="cl">    Destination: aa:bb:cc:dd:ee:ff <span class="o">(</span>aa:bb:cc:dd:ee:ff<span class="o">)</span>
</span></span><span class="line"><span class="ln">125</span><span class="cl">    Source: ce:7f:43:8a:0e:3c <span class="o">(</span>ce:7f:43:8a:0e:3c<span class="o">)</span>
</span></span><span class="line"><span class="ln">126</span><span class="cl">    Type: IPv4 <span class="o">(</span>0x0800<span class="o">)</span>
</span></span><span class="line"><span class="ln">127</span><span class="cl">    <span class="o">[</span>Stream index: 4<span class="o">]</span>
</span></span><span class="line"><span class="ln">128</span><span class="cl">Internet Protocol Version 4, Src: 10.40.1.3, Dst: 10.40.2.4
</span></span><span class="line"><span class="ln">129</span><span class="cl">    <span class="m">0100</span> .... <span class="o">=</span> Version: <span class="m">4</span>
</span></span><span class="line"><span class="ln">130</span><span class="cl">    .... <span class="nv">0101</span> <span class="o">=</span> Header Length: <span class="m">20</span> bytes <span class="o">(</span>5<span class="o">)</span>
</span></span><span class="line"><span class="ln">131</span><span class="cl">    Differentiated Services Field: 0x00 <span class="o">(</span>DSCP: CS0, ECN: Not-ECT<span class="o">)</span>
</span></span><span class="line"><span class="ln">132</span><span class="cl">        <span class="m">0000</span> 00.. <span class="o">=</span> Differentiated Services Codepoint: Default <span class="o">(</span>0<span class="o">)</span>
</span></span><span class="line"><span class="ln">133</span><span class="cl">        .... ..00 <span class="o">=</span> Explicit Congestion Notification: Not ECN-Capable Transport <span class="o">(</span>0<span class="o">)</span>
</span></span><span class="line"><span class="ln">134</span><span class="cl">    Total Length: <span class="m">84</span>
</span></span><span class="line"><span class="ln">135</span><span class="cl">    Identification: 0x54ad <span class="o">(</span>21677<span class="o">)</span>
</span></span><span class="line"><span class="ln">136</span><span class="cl">    010. .... <span class="o">=</span> Flags: 0x2, Don<span class="err">&#39;</span>t fragment
</span></span><span class="line"><span class="ln">137</span><span class="cl">    ...0 <span class="m">0000</span> <span class="m">0000</span> <span class="nv">0000</span> <span class="o">=</span> Fragment Offset: <span class="m">0</span>
</span></span><span class="line"><span class="ln">138</span><span class="cl">    Time to Live: <span class="m">63</span>
</span></span><span class="line"><span class="ln">139</span><span class="cl">    Protocol: ICMP <span class="o">(</span>1<span class="o">)</span>
</span></span><span class="line"><span class="ln">140</span><span class="cl">    Header Checksum: 0xcfa5 <span class="o">[</span>validation disabled<span class="o">]</span>
</span></span><span class="line"><span class="ln">141</span><span class="cl">    <span class="o">[</span>Header checksum status: Unverified<span class="o">]</span>
</span></span><span class="line"><span class="ln">142</span><span class="cl">    Source Address: 10.40.1.3
</span></span><span class="line"><span class="ln">143</span><span class="cl">    Destination Address: 10.40.2.4
</span></span><span class="line"><span class="ln">144</span><span class="cl">    <span class="o">[</span>Stream index: 6<span class="o">]</span>
</span></span><span class="line"><span class="ln">145</span><span class="cl">Internet Control Message Protocol
</span></span><span class="line"><span class="ln">146</span><span class="cl">    Type: <span class="m">8</span> <span class="o">(</span>Echo <span class="o">(</span>ping<span class="o">)</span> request<span class="o">)</span>
</span></span><span class="line"><span class="ln">147</span><span class="cl">    Code: <span class="m">0</span>
</span></span><span class="line"><span class="ln">148</span><span class="cl">    Checksum: 0xf1a5 <span class="o">[</span>correct<span class="o">]</span>
</span></span><span class="line"><span class="ln">149</span><span class="cl">    <span class="o">[</span>Checksum Status: Good<span class="o">]</span>
</span></span><span class="line"><span class="ln">150</span><span class="cl">    Identifier <span class="o">(</span>BE<span class="o">)</span>: <span class="m">690</span> <span class="o">(</span>0x02b2<span class="o">)</span>
</span></span><span class="line"><span class="ln">151</span><span class="cl">    Identifier <span class="o">(</span>LE<span class="o">)</span>: <span class="m">45570</span> <span class="o">(</span>0xb202<span class="o">)</span>
</span></span><span class="line"><span class="ln">152</span><span class="cl">    Sequence Number <span class="o">(</span>BE<span class="o">)</span>: <span class="m">52</span> <span class="o">(</span>0x0034<span class="o">)</span>
</span></span><span class="line"><span class="ln">153</span><span class="cl">    Sequence Number <span class="o">(</span>LE<span class="o">)</span>: <span class="m">13312</span> <span class="o">(</span>0x3400<span class="o">)</span>
</span></span><span class="line"><span class="ln">154</span><span class="cl">    <span class="o">[</span>No response seen<span class="o">]</span>
</span></span><span class="line"><span class="ln">155</span><span class="cl">    Timestamp from icmp data: Dec  2, <span class="m">2024</span> 10:01:56.508523000 CET
</span></span><span class="line"><span class="ln">156</span><span class="cl">    <span class="o">[</span>Timestamp from icmp data <span class="o">(</span>relative<span class="o">)</span>: 0.002250000 seconds<span class="o">]</span>
</span></span><span class="line"><span class="ln">157</span><span class="cl">    Data <span class="o">(</span><span class="m">40</span> bytes<span class="o">)</span>
</span></span></code></pre></div><h3 id="monitor-and-troubleshoot">Monitor and troubleshoot</h3>
<p>Everything has been configured but nothing works. Could it be MTU? There is a high probability it is MTU as both VXLAN and Geneve will not tolerate fragmentation. Lets quickly go through how to check for MTU issues and if it is related to any overlay protocols being dropped due to defragmentation.</p>
<h3 id="ethernet-mtu-and-ip-mtu">Ethernet MTU and IP MTU</h3>
<p>A quick note on MTU. MTU can be referred to as Ethernet MTU and IP MTU. This can be important to be aware of as these numbers are quite different and operate at two different levels: the Data Link Layer and Network Layer.</p>
<p>The Ethernet MTU is the maximum payload in bytes an Ethernet frame can carry. This refers to the Layer 2 Data Link Layer size limit. What does that mean then? Well an ethernet MTU only considers the the size of the actual packet, it does not include the ethernet frame headers MAC addresses, ether type, and fcs. Remember the ethernet frame explanation above:</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="standard ethernet frame"
      
        class="image_figure image_internal image_processed"
        width="918"
        height="198"
        src="/2024/11/08/overlay-on-overlay-arista-in-the-underlay/images/image-20241203120426517.png"
      
      
    />

    </picture>
</figure>
</p>
<p>The IP MTU on the other hand is the maximum size in bytes of the IP packet than can be transmitted. This operates at the Layer 3 Network layer and includes the entire IP packet, ip header, and transport payload (tcp/udp headers and application data). The IP MTU must fit within the Ethernet MTU. The IP packet is encapsulated in the Ethernet payload.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="ln">1</span><span class="cl"><span class="o">+--------------------+--------------------+</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="o">|</span> <span class="n">Ethernet</span> <span class="n">Frame</span> <span class="p">(</span><span class="mi">1518</span> <span class="n">bytes</span><span class="p">)</span>            <span class="o">|</span>
</span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="o">|</span> <span class="mi">14</span><span class="n">B</span> <span class="n">Header</span> <span class="o">+</span> <span class="mi">1500</span><span class="n">B</span> <span class="n">Payload</span> <span class="o">+</span> <span class="mi">4</span><span class="n">B</span> <span class="n">Trailer</span><span class="o">|</span>
</span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="o">+----------------------------------------+</span>
</span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="o">|</span> <span class="n">IP</span> <span class="n">Packet</span> <span class="p">(</span><span class="mi">1500</span> <span class="n">bytes</span> <span class="n">max</span><span class="p">)</span>             <span class="o">|</span>
</span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="o">|</span> <span class="mi">20</span><span class="n">B</span> <span class="n">IP</span> <span class="n">Header</span> <span class="o">+</span> <span class="mi">1480</span><span class="n">B</span> <span class="n">Payload</span>          <span class="o">|</span>
</span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="o">+----------------------------------------+</span>
</span></span></code></pre></div><h3 id="verifying-everything-in-the-arista-fabric">Verifying everything in the Arista fabric</h3>
<p><strong>Underly links</strong>
To do this as &quot;methodically&quot; as possible I will first start by checking mtu in the Arista fabric. This will be the ptp links between the spines and leafs. They should be configured with the highest supported MTU in EOS.</p>
<div style="border-left: 4px solid #2196F3; background-color: #E3F2FD; padding: 10px; margin: 10px 0; color: #0000FF;"> <strong>Info:</strong>
This is all done in my lab using vEOS (virtual machines running on my hypervisor). The max MTU I can use in my lab is 9194 in vEOS. In a real physical Arista switch it is 9214MTU. So the numbers I am operating with is not representative to the real products </div>
<p>As soon as I have verified the mtu size there, I also need to verify that there is no issues with the VXLAN tunnel.</p>
<p>From <em>leaf1b</em> uplink 1 and 2 to spine 1 and 2:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">veos-dc1-leaf1b#ping 10.255.255.4 <span class="nb">source</span> 10.255.255.5 df-bit size <span class="m">9194</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">PING 10.255.255.4 <span class="o">(</span>10.255.255.4<span class="o">)</span> from 10.255.255.5 : 9166<span class="o">(</span>9194<span class="o">)</span> bytes of data.
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="m">9174</span> bytes from 10.255.255.4: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>1.50 ms
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="m">9174</span> bytes from 10.255.255.4: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">2</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>0.836 ms
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="m">9174</span> bytes from 10.255.255.4: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">3</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>0.549 ms
</span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="m">9174</span> bytes from 10.255.255.4: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">4</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>0.558 ms
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="m">9174</span> bytes from 10.255.255.4: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">5</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>0.556 ms
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">--- 10.255.255.4 ping statistics ---
</span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="m">5</span> packets transmitted, <span class="m">5</span> received, 0% packet loss, <span class="nb">time</span> 5ms
</span></span><span class="line"><span class="ln">11</span><span class="cl">rtt min/avg/max/mdev <span class="o">=</span> 0.549/0.800/1.503/0.367 ms, ipg/ewma 1.255/1.134 ms
</span></span></code></pre></div><p>If I try one byte too high it should tell me:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">veos-dc1-leaf1b#ping 10.255.255.4 <span class="nb">source</span> 10.255.255.5 df-bit size <span class="m">9195</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">PING 10.255.255.4 <span class="o">(</span>10.255.255.4<span class="o">)</span> from 10.255.255.5 : 9167<span class="o">(</span>9195<span class="o">)</span> bytes of data.
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">ping: <span class="nb">local</span> error: message too long, <span class="nv">mtu</span><span class="o">=</span><span class="m">9194</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">ping: <span class="nb">local</span> error: message too long, <span class="nv">mtu</span><span class="o">=</span><span class="m">9194</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">ping: <span class="nb">local</span> error: message too long, <span class="nv">mtu</span><span class="o">=</span><span class="m">9194</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">ping: <span class="nb">local</span> error: message too long, <span class="nv">mtu</span><span class="o">=</span><span class="m">9194</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">ping: <span class="nb">local</span> error: message too long, <span class="nv">mtu</span><span class="o">=</span><span class="m">9194</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">--- 10.255.255.4 ping statistics ---
</span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="m">5</span> packets transmitted, <span class="m">0</span> received, +5 errors, 100% packet loss, <span class="nb">time</span> 41ms
</span></span></code></pre></div><p>Ok, MTU in the ptp links are good. How is the status of the VXLAN tunnel:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">veos-dc1-leaf1b#show int vx1
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">Vxlan1 is up, line protocol is up <span class="o">(</span>connected<span class="o">)</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">  Hardware is Vxlan
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">  Description: veos-dc1-leaf1b_VTEP
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">  Source interface is Loopback1 and is active with 10.255.1.4
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">  Listening on UDP port <span class="m">4789</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">  Replication/Flood Mode is headend with Flood List Source: EVPN
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">  Remote MAC learning via EVPN
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">  VNI mapping to VLANs
</span></span><span class="line"><span class="ln">10</span><span class="cl">  Static VLAN to VNI mapping is
</span></span><span class="line"><span class="ln">11</span><span class="cl">    <span class="o">[</span>11, 10011<span class="o">]</span>       <span class="o">[</span>12, 10012<span class="o">]</span>       <span class="o">[</span>13, 10013<span class="o">]</span>       <span class="o">[</span>21, 10021<span class="o">]</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">    <span class="o">[</span>22, 10022<span class="o">]</span>       <span class="o">[</span>23, 10023<span class="o">]</span>       <span class="o">[</span>1079, 11079<span class="o">]</span>     <span class="o">[</span>3401, 13401<span class="o">]</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">    <span class="o">[</span>3402, 13402<span class="o">]</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">  Dynamic VLAN to VNI mapping <span class="k">for</span> <span class="s1">&#39;evpn&#39;</span> is
</span></span><span class="line"><span class="ln">15</span><span class="cl">    <span class="o">[</span>4097, 11<span class="o">]</span>        <span class="o">[</span>4098, 10<span class="o">]</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">  Note: All Dynamic VLANs used by VCS are internal VLANs.
</span></span><span class="line"><span class="ln">17</span><span class="cl">        Use <span class="s1">&#39;show vxlan vni&#39;</span> <span class="k">for</span> details.
</span></span><span class="line"><span class="ln">18</span><span class="cl">  Static VRF to VNI mapping is
</span></span><span class="line"><span class="ln">19</span><span class="cl">   <span class="o">[</span>VRF20, 10<span class="o">]</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">   <span class="o">[</span>VRF21, 11<span class="o">]</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl">  Headend replication flood vtep list is:
</span></span><span class="line"><span class="ln">22</span><span class="cl">    <span class="m">11</span> 10.255.1.6      10.255.1.3      10.255.1.5
</span></span><span class="line"><span class="ln">23</span><span class="cl">    <span class="m">12</span> 10.255.1.6      10.255.1.3      10.255.1.5
</span></span><span class="line"><span class="ln">24</span><span class="cl">    <span class="m">13</span> 10.255.1.6      10.255.1.3      10.255.1.5
</span></span><span class="line"><span class="ln">25</span><span class="cl">    <span class="m">21</span> 10.255.1.6      10.255.1.3      10.255.1.5
</span></span><span class="line"><span class="ln">26</span><span class="cl">    <span class="m">22</span> 10.255.1.6      10.255.1.3      10.255.1.5
</span></span><span class="line"><span class="ln">27</span><span class="cl">    <span class="m">23</span> 10.255.1.6      10.255.1.3      10.255.1.5
</span></span><span class="line"><span class="ln">28</span><span class="cl">  <span class="m">1079</span> 10.255.1.6      10.255.1.3      10.255.1.5
</span></span><span class="line"><span class="ln">29</span><span class="cl">  <span class="m">3401</span> 10.255.1.6      10.255.1.3      10.255.1.5
</span></span><span class="line"><span class="ln">30</span><span class="cl">  <span class="m">3402</span> 10.255.1.6      10.255.1.3      10.255.1.5
</span></span><span class="line"><span class="ln">31</span><span class="cl">  Shared Router MAC is 0000.0000.0000
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">veos-dc1-leaf1b#show vxlan config-sanity detail
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">Category                            Result
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">---------------------------------- --------
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">Local VTEP Configuration Check        OK
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">  Loopback IP Address                 OK
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">  VLAN-VNI Map                        OK
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">  Flood List                          OK
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">  Routing                             OK
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">  VNI VRF ACL                         OK
</span></span><span class="line"><span class="ln">10</span><span class="cl">  Decap VRF-VNI Map                   OK
</span></span><span class="line"><span class="ln">11</span><span class="cl">  VRF-VNI Dynamic VLAN                OK
</span></span><span class="line"><span class="ln">12</span><span class="cl">Remote VTEP Configuration Check       OK
</span></span><span class="line"><span class="ln">13</span><span class="cl">  Remote VTEP                         OK
</span></span><span class="line"><span class="ln">14</span><span class="cl">Platform Dependent Check              OK
</span></span><span class="line"><span class="ln">15</span><span class="cl">  VXLAN Bridging                      OK
</span></span><span class="line"><span class="ln">16</span><span class="cl">  VXLAN Routing                       OK
</span></span><span class="line"><span class="ln">17</span><span class="cl">CVX Configuration Check               OK
</span></span><span class="line"><span class="ln">18</span><span class="cl">  CVX Server                          OK
</span></span><span class="line"><span class="ln">19</span><span class="cl">MLAG Configuration Check              OK
</span></span><span class="line"><span class="ln">20</span><span class="cl">  Peer VTEP IP                        OK
</span></span><span class="line"><span class="ln">21</span><span class="cl">  MLAG VTEP IP                        OK
</span></span><span class="line"><span class="ln">22</span><span class="cl">  Peer VLAN-VNI                       OK
</span></span><span class="line"><span class="ln">23</span><span class="cl">  Virtual VTEP IP                     OK
</span></span><span class="line"><span class="ln">24</span><span class="cl">  MLAG Inactive State                 OK
</span></span><span class="line"><span class="ln">25</span><span class="cl">
</span></span><span class="line"><span class="ln">26</span><span class="cl">Detail
</span></span><span class="line"><span class="ln">27</span><span class="cl">--------------------------------------------------
</span></span><span class="line"><span class="ln">28</span><span class="cl">
</span></span><span class="line"><span class="ln">29</span><span class="cl">Not in controller client mode
</span></span><span class="line"><span class="ln">30</span><span class="cl">Run <span class="s1">&#39;show mlag config-sanity&#39;</span> to verify MLAG config
</span></span><span class="line"><span class="ln">31</span><span class="cl">MLAG peer is not connected
</span></span></code></pre></div><p><strong>Downlinks to connected endpoints and VLAN interfaces</strong></p>
<p>So my underlay links are in good shape, but I also need to have a look at the downlinks to my servers including the respective vlan interfaces whether they have been configured to also support jumbo frames. This is needed as they will be configured with jumbo frames too to accommodate their overlay tunnels.
To verify that the MTU is correct there I can use one of my leafs and do some ping tests using higher mtu payload. From my <em>leaf1b</em> I start by verifying the default MTU on the ethernet interface 6 which is connected to server 2:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">veos-dc1-leaf1b<span class="o">(</span>config<span class="o">)</span><span class="c1">#interface ethernet 6</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">veos-dc1-leaf1b<span class="o">(</span>config-if-Et6<span class="o">)</span><span class="c1">#show active</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">interface Ethernet6
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">   description dc1-leaf1b-client2-vxlan_CLIENT2-VXLAN
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">   switchport trunk native vlan <span class="m">22</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">   switchport trunk allowed vlan 11-13,21-23
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">   switchport mode trunk
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">veos-dc1-leaf1b<span class="o">(</span>config-if-Et6<span class="o">)</span><span class="c1">#show interfaces ethernet 6</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">Ethernet6 is up, line protocol is up <span class="o">(</span>connected<span class="o">)</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">  Hardware is Ethernet, address is bc24.117e.e982 <span class="o">(</span>bia bc24.117e.e982<span class="o">)</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">  Description: dc1-leaf1b-client2-vxlan_CLIENT2-VXLAN
</span></span><span class="line"><span class="ln">12</span><span class="cl">  Ethernet MTU <span class="m">9194</span> bytes, BW <span class="m">1000000</span> kbit
</span></span><span class="line"><span class="ln">13</span><span class="cl">  Full-duplex, 1Gb/s, auto negotiation: off, uni-link: n/a
</span></span><span class="line"><span class="ln">14</span><span class="cl">  Up <span class="m">9</span> days, <span class="m">10</span> hours, <span class="m">40</span> minutes, <span class="m">10</span> seconds
</span></span><span class="line"><span class="ln">15</span><span class="cl">  Loopback Mode : None
</span></span><span class="line"><span class="ln">16</span><span class="cl">  <span class="m">2</span> link status changes since last clear
</span></span><span class="line"><span class="ln">17</span><span class="cl">  Last clearing of <span class="s2">&#34;show interface&#34;</span> counters never
</span></span><span class="line"><span class="ln">18</span><span class="cl">  <span class="m">5</span> minutes input rate 6.34 kbps <span class="o">(</span>0.0% with framing overhead<span class="o">)</span>, <span class="m">5</span> packets/sec
</span></span><span class="line"><span class="ln">19</span><span class="cl">  <span class="m">5</span> minutes output rate 7.01 kbps <span class="o">(</span>0.0% with framing overhead<span class="o">)</span>, <span class="m">6</span> packets/sec
</span></span><span class="line"><span class="ln">20</span><span class="cl">     <span class="m">3517540</span> packets input, <span class="m">614301075</span> bytes
</span></span><span class="line"><span class="ln">21</span><span class="cl">     Received <span class="m">35</span> broadcasts, <span class="m">459</span> multicast
</span></span><span class="line"><span class="ln">22</span><span class="cl">     <span class="m">0</span> runts, <span class="m">0</span> giants
</span></span><span class="line"><span class="ln">23</span><span class="cl">     <span class="m">0</span> input errors, <span class="m">0</span> CRC, <span class="m">0</span> alignment, <span class="m">0</span> symbol, <span class="m">0</span> input discards
</span></span><span class="line"><span class="ln">24</span><span class="cl">     <span class="m">0</span> PAUSE input
</span></span><span class="line"><span class="ln">25</span><span class="cl">     <span class="m">3913885</span> packets output, <span class="m">625341082</span> bytes
</span></span><span class="line"><span class="ln">26</span><span class="cl">     Sent <span class="m">526</span> broadcasts, <span class="m">427958</span> multicast
</span></span><span class="line"><span class="ln">27</span><span class="cl">     <span class="m">0</span> output errors, <span class="m">0</span> collisions
</span></span><span class="line"><span class="ln">28</span><span class="cl">     <span class="m">0</span> late collision, <span class="m">0</span> deferred, <span class="m">0</span> output discards
</span></span><span class="line"><span class="ln">29</span><span class="cl">     <span class="m">0</span> PAUSE output
</span></span></code></pre></div><div style="border-left: 4px solid #2196F3; background-color: #E3F2FD; padding: 10px; margin: 10px 0; color: #0000FF;"> <strong>Info:</strong>
A note on MTU in Arista EOS. By default all Layer 2 ports are default 9214, while layer 3/routed ports are default 1500. </div>
<p>Then I will need to verify the MTU size on the VLAN interface I am using for VXLAN in my servers, vlan interfaces 21,22 and 23.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">veos-dc1-leaf1b<span class="o">(</span>config-if-Et6<span class="o">)</span><span class="c1">#interface vlan 22</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">veos-dc1-leaf1b<span class="o">(</span>config-if-Vl22<span class="o">)</span><span class="c1">#show active</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">interface Vlan22
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">   description VRF11_VLAN22
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">   mtu <span class="m">9194</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">   vrf VRF21
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">   ip address virtual 10.21.22.1/24
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">veos-dc1-leaf1b<span class="o">(</span>config-if-Vl22<span class="o">)</span><span class="c1">#show interfaces vlan 22</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">Vlan22 is up, line protocol is up <span class="o">(</span>connected<span class="o">)</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">  Hardware is Vlan, address is bc24.119b.8f08 <span class="o">(</span>bia bc24.119b.8f08<span class="o">)</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">  Description: VRF11_VLAN22
</span></span><span class="line"><span class="ln">12</span><span class="cl">  Internet address is virtual 10.21.22.1/24
</span></span><span class="line"><span class="ln">13</span><span class="cl">  Broadcast address is 255.255.255.255
</span></span><span class="line"><span class="ln">14</span><span class="cl">  IP MTU <span class="m">9194</span> bytes
</span></span><span class="line"><span class="ln">15</span><span class="cl">  Up <span class="m">9</span> days, <span class="m">10</span> hours, <span class="m">42</span> minutes, <span class="m">23</span> seconds
</span></span></code></pre></div><p>Now I would like to see it with my own eyes that I can actually use this MTU to the server (server2) connected. I will use ping as the tool to set a payload size of 9194 which is the switch interface mtu size that is connected to server 2. Server 2 nic has been configured with a MTU of 9000. The last ping is just 1 byte more than allowed.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">veos-dc1-leaf1b#ping vrf VRF21 10.21.22.10 <span class="nb">source</span> 10.21.21.1 size <span class="m">9194</span> df-bit
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">PING 10.21.22.10 <span class="o">(</span>10.21.22.10<span class="o">)</span> from 10.21.21.1 : 9166<span class="o">(</span>9194<span class="o">)</span> bytes of data.
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="m">9174</span> bytes from 10.21.22.10: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>1.71 ms
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="m">9174</span> bytes from 10.21.22.10: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">2</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>1.55 ms
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="m">9174</span> bytes from 10.21.22.10: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">3</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>1.29 ms
</span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="m">9174</span> bytes from 10.21.22.10: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">4</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>1.41 ms
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="m">9174</span> bytes from 10.21.22.10: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">5</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>1.15 ms
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">--- 10.21.22.10 ping statistics ---
</span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="m">5</span> packets transmitted, <span class="m">5</span> received, 0% packet loss, <span class="nb">time</span> 8ms
</span></span><span class="line"><span class="ln">11</span><span class="cl">rtt min/avg/max/mdev <span class="o">=</span> 1.149/1.422/1.707/0.194 ms, ipg/ewma 2.001/1.552 ms
</span></span><span class="line"><span class="ln">12</span><span class="cl">veos-dc1-leaf1b#ping vrf VRF21 10.21.22.10 <span class="nb">source</span> 10.21.21.1 size <span class="m">9195</span> df-bit
</span></span><span class="line"><span class="ln">13</span><span class="cl">PING 10.21.22.10 <span class="o">(</span>10.21.22.10<span class="o">)</span> from 10.21.21.1 : 9167<span class="o">(</span>9195<span class="o">)</span> bytes of data.
</span></span><span class="line"><span class="ln">14</span><span class="cl">ping: <span class="nb">local</span> error: message too long, <span class="nv">mtu</span><span class="o">=</span><span class="m">9194</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">ping: <span class="nb">local</span> error: message too long, <span class="nv">mtu</span><span class="o">=</span><span class="m">9194</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">ping: <span class="nb">local</span> error: message too long, <span class="nv">mtu</span><span class="o">=</span><span class="m">9194</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">ping: <span class="nb">local</span> error: message too long, <span class="nv">mtu</span><span class="o">=</span><span class="m">9194</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">ping: <span class="nb">local</span> error: message too long, <span class="nv">mtu</span><span class="o">=</span><span class="m">9194</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">^C
</span></span><span class="line"><span class="ln">20</span><span class="cl">--- 10.21.22.10 ping statistics ---
</span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="m">5</span> packets transmitted, <span class="m">0</span> received, +5 errors, 100% packet loss, <span class="nb">time</span> 41ms
</span></span></code></pre></div><p>There is also some other nifty tools in EOS that can be used to check if  fragmentation is going on, <em>show kernel ip counters</em>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">veos-dc1-leaf2a#show kernel ip counters vrf VRF21 <span class="p">|</span> grep -A1 <span class="s2">&#34;ICMP output&#34;</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">    ICMP output histogram:
</span></span><span class="line"><span class="ln">3</span><span class="cl">        destination unreachable: <span class="m">285</span>
</span></span></code></pre></div><p>And <em>netstat -s</em> from EOS bash:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="ln"> 1</span><span class="cl">Arista Networks EOS shell
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">[ansible@veos-dc1-leaf2a ~]$ netstat -s
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">Ip:
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">    Forwarding: 2
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">    372 total packets received
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">    367 forwarded
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">    0 incoming packets discarded
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">    5 incoming packets delivered
</span></span><span class="line"><span class="ln">10</span><span class="cl">    657 requests sent out
</span></span><span class="line"><span class="ln">11</span><span class="cl">Icmp:
</span></span><span class="line"><span class="ln">12</span><span class="cl">    5 ICMP messages received
</span></span><span class="line"><span class="ln">13</span><span class="cl">    0 input ICMP message failed
</span></span><span class="line"><span class="ln">14</span><span class="cl">    ICMP input histogram:
</span></span><span class="line"><span class="ln">15</span><span class="cl">        echo replies: 5
</span></span><span class="line"><span class="ln">16</span><span class="cl">    290 ICMP messages sent
</span></span><span class="line"><span class="ln">17</span><span class="cl">    0 ICMP messages failed
</span></span><span class="line"><span class="ln">18</span><span class="cl">    ICMP output histogram:
</span></span><span class="line"><span class="ln">19</span><span class="cl">        destination unreachable: 285
</span></span><span class="line"><span class="ln">20</span><span class="cl">        echo requests: 5
</span></span><span class="line"><span class="ln">21</span><span class="cl">IcmpMsg:
</span></span><span class="line"><span class="ln">22</span><span class="cl">        InType0: 5
</span></span><span class="line"><span class="ln">23</span><span class="cl">        OutType3: 285
</span></span><span class="line"><span class="ln">24</span><span class="cl">        OutType8: 5
</span></span><span class="line"><span class="ln">25</span><span class="cl">Tcp:
</span></span><span class="line"><span class="ln">26</span><span class="cl">    0 active connection openings
</span></span><span class="line"><span class="ln">27</span><span class="cl">    0 passive connection openings
</span></span><span class="line"><span class="ln">28</span><span class="cl">    0 failed connection attempts
</span></span><span class="line"><span class="ln">29</span><span class="cl">    0 connection resets received
</span></span><span class="line"><span class="ln">30</span><span class="cl">    0 connections established
</span></span><span class="line"><span class="ln">31</span><span class="cl">    0 segments received
</span></span><span class="line"><span class="ln">32</span><span class="cl">    0 segments sent out
</span></span><span class="line"><span class="ln">33</span><span class="cl">    0 segments retransmitted
</span></span><span class="line"><span class="ln">34</span><span class="cl">    0 bad segments received
</span></span><span class="line"><span class="ln">35</span><span class="cl">    0 resets sent
</span></span><span class="line"><span class="ln">36</span><span class="cl">Udp:
</span></span><span class="line"><span class="ln">37</span><span class="cl">    0 packets received
</span></span><span class="line"><span class="ln">38</span><span class="cl">    0 packets to unknown port received
</span></span><span class="line"><span class="ln">39</span><span class="cl">    0 packet receive errors
</span></span><span class="line"><span class="ln">40</span><span class="cl">    0 packets sent
</span></span><span class="line"><span class="ln">41</span><span class="cl">    0 receive buffer errors
</span></span><span class="line"><span class="ln">42</span><span class="cl">    0 send buffer errors
</span></span><span class="line"><span class="ln">43</span><span class="cl">UdpLite:
</span></span><span class="line"><span class="ln">44</span><span class="cl">TcpExt:
</span></span><span class="line"><span class="ln">45</span><span class="cl">    0 packet headers predicted
</span></span><span class="line"><span class="ln">46</span><span class="cl">IpExt:
</span></span><span class="line"><span class="ln">47</span><span class="cl">    InOctets: 47155
</span></span><span class="line"><span class="ln">48</span><span class="cl">    OutOctets: 139570
</span></span><span class="line"><span class="ln">49</span><span class="cl">    InNoECTPkts: 372
</span></span><span class="line"><span class="ln">50</span><span class="cl">Arista:
</span></span><span class="line"><span class="ln">51</span><span class="cl">[ansible@veos-dc1-leaf2a ~]$
</span></span></code></pre></div><p><em>netstat -s</em> will also be used in the compute stack later on.</p>
<h3 id="verifying-mtu-in-the-compute-stack">Verifying MTU in the compute stack</h3>
<p>To make it a bit easier to follow I will refer to the table below again with relevant information on the differents servers in my compute stack:</p>
<table>
<thead>
<tr>
<th>Server 1</th>
<th>Server 2</th>
<th>Server 3</th>
</tr>
</thead>
<tbody>
<tr>
<td>ens18 - 10.20.11.10/24 MTU 1500</td>
<td>ens18 - 10.20.12.10/24 - MTU 1500</td>
<td>ens18 - 10.20.13.10/24 - MTU 1500</td>
</tr>
<tr>
<td>ens19 - 10.21.21.10/24 - MTU 9000</td>
<td>ens19 - 10.21.22.10/24 - MTU 9000</td>
<td>ens19 - 10.21.23.10/24 - MTU 9000</td>
</tr>
<tr>
<td>vxlan10: MTU 1500 VNI: 666</td>
<td>vxlan10: MTU 1500 VNI: 666</td>
<td>vxlan10: MTU 1500 VNI: 666</td>
</tr>
<tr>
<td>br-vxlan (vxlan via ens19) - 192.168.100.11/24 - MTU 1500</td>
<td>br-vxlan (vxlan via ens19) - 192.168.100.12/24 - MTU 1500</td>
<td>br-vxlan (vxlan via ens19) - 192.168.100.13/24 - MTU 1500</td>
</tr>
<tr>
<td>antrea-gw0 (interface mtu -50)</td>
<td>antrea-gw0 (interface mtu -50)</td>
<td>antrea-gw0 (interface mtu -50)</td>
</tr>
<tr>
<td>pod-cidr (Antrea geneve tun0 via ens19) 10.40.0.0/24 - MTU 1450 (auto adapts to br-vxlan)</td>
<td>pod-cidr (Antrea geneve tun0 via ens19) 10.40.1.0/24 - MTU 1450 (auto adapts to br-vxlan)</td>
<td>pod-cidr (Antrea geneve tun0 via ens19) 10.40.2.0/24 - MTU 1450 (auto adapts to br-vxlan)</td>
</tr>
<tr>
<td>ens18 &gt; leaf1a ethernet 5 - mtu1500 &gt; mtu9194</td>
<td>ens18 &gt; leaf1b ethernet 5 - mtu1500 &gt; mtu9194</td>
<td>ens18 &gt; leaf2a ethernet 5 - mtu1500 &gt; mtu9194</td>
</tr>
<tr>
<td>ens19 &gt; leaf1a ethernet 6 - mtu9000 &gt; mtu9194</td>
<td>ens19 &gt; leaf1b ethernet 6 - mtu9000 &gt; mtu9194</td>
<td>ens19 &gt; leaf2a ethernet 6 - mtu9000 &gt; mtu9194</td>
</tr>
</tbody>
</table>
<p>My first test will be to verify that I can do a max IP MTU of 8972 using the ens19 interface between server 2 and server 3. The reason for that is because interface ens19 will be the uplink that vxlan in my compute stack will use, so I need to make sure it can handle bigger than 1500 mtu.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">andreasm@eos-client-2:~$ ping -I ens19 10.21.23.10 -M <span class="k">do</span> -s <span class="m">8972</span> -c <span class="m">4</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">PING 10.21.23.10 <span class="o">(</span>10.21.23.10<span class="o">)</span> 8972<span class="o">(</span>9000<span class="o">)</span> bytes of data.
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="m">8980</span> bytes from 10.21.23.10: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">62</span> <span class="nv">time</span><span class="o">=</span>3.89 ms
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="m">8980</span> bytes from 10.21.23.10: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">2</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">62</span> <span class="nv">time</span><span class="o">=</span>4.36 ms
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="m">8980</span> bytes from 10.21.23.10: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">3</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">62</span> <span class="nv">time</span><span class="o">=</span>4.70 ms
</span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="m">8980</span> bytes from 10.21.23.10: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">4</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">62</span> <span class="nv">time</span><span class="o">=</span>4.17 ms
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">--- 10.21.23.10 ping statistics ---
</span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="m">4</span> packets transmitted, <span class="m">4</span> received, 0% packet loss, <span class="nb">time</span> 3006ms
</span></span><span class="line"><span class="ln">10</span><span class="cl">rtt min/avg/max/mdev <span class="o">=</span> 3.889/4.278/4.697/0.293 ms
</span></span></code></pre></div><p>That went fine. Now I have verified the mtu between my servers running on top of my Arista fabrics that they can actually handle the additional overhead by using VXLAN between my hosts.</p>
<p>Next test is trying to ping using the overlay subnet configured on a bridge called br-vxlan:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">andreasm@eos-client-2:~$ ping -I br-vxlan 192.168.100.13 -M <span class="k">do</span> -s <span class="m">1472</span> -c <span class="m">4</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">PING 192.168.100.13 <span class="o">(</span>192.168.100.13<span class="o">)</span> from 192.168.100.12 br-vxlan: 1472<span class="o">(</span>1500<span class="o">)</span> bytes of data.
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="m">1480</span> bytes from 192.168.100.13: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>3.52 ms
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="m">1480</span> bytes from 192.168.100.13: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">2</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>4.24 ms
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="m">1480</span> bytes from 192.168.100.13: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">3</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>4.04 ms
</span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="m">1480</span> bytes from 192.168.100.13: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">4</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>3.97 ms
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">--- 192.168.100.13 ping statistics ---
</span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="m">4</span> packets transmitted, <span class="m">4</span> received, 0% packet loss, <span class="nb">time</span> 3004ms
</span></span><span class="line"><span class="ln">10</span><span class="cl">rtt min/avg/max/mdev <span class="o">=</span> 3.515/3.939/4.242/0.265 ms
</span></span></code></pre></div><p>This is for now only confgured to use an mtu of 1500.</p>
<p>To verify the vxlan tunnel status:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">andreasm@eos-client-2:~$ bridge fdb show
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">33:33:00:00:00:01 dev ens18 self permanent
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">01:00:5e:00:00:01 dev ens18 self permanent
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">33:33:ff:ca:c7:03 dev ens18 self permanent
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">01:80:c2:00:00:00 dev ens18 self permanent
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">01:80:c2:00:00:03 dev ens18 self permanent
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">01:80:c2:00:00:0e dev ens18 self permanent
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">01:00:5e:00:00:01 dev ens19 self permanent
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">33:33:00:00:00:01 dev ens19 self permanent
</span></span><span class="line"><span class="ln">10</span><span class="cl">33:33:ff:b8:13:63 dev ens19 self permanent
</span></span><span class="line"><span class="ln">11</span><span class="cl">01:80:c2:00:00:00 dev ens19 self permanent
</span></span><span class="line"><span class="ln">12</span><span class="cl">01:80:c2:00:00:03 dev ens19 self permanent
</span></span><span class="line"><span class="ln">13</span><span class="cl">01:80:c2:00:00:0e dev ens19 self permanent
</span></span><span class="line"><span class="ln">14</span><span class="cl">33:33:00:00:00:01 dev ovs-system self permanent
</span></span><span class="line"><span class="ln">15</span><span class="cl">33:33:00:00:00:01 dev genev_sys_6081 self permanent
</span></span><span class="line"><span class="ln">16</span><span class="cl">01:00:5e:00:00:01 dev genev_sys_6081 self permanent
</span></span><span class="line"><span class="ln">17</span><span class="cl">33:33:ff:b9:ce:70 dev genev_sys_6081 self permanent
</span></span><span class="line"><span class="ln">18</span><span class="cl">01:00:5e:00:00:01 dev antrea-gw0 self permanent
</span></span><span class="line"><span class="ln">19</span><span class="cl">33:33:00:00:00:01 dev antrea-gw0 self permanent
</span></span><span class="line"><span class="ln">20</span><span class="cl">33:33:ff:4f:1c:f0 dev antrea-gw0 self permanent
</span></span><span class="line"><span class="ln">21</span><span class="cl">33:33:00:00:00:01 dev antrea-egress0 self permanent
</span></span><span class="line"><span class="ln">22</span><span class="cl">a6:58:bc:c5:47:62 dev vxlan10 master br-vxlan
</span></span><span class="line"><span class="ln">23</span><span class="cl">42:87:fd:bd:57:63 dev vxlan10 master br-vxlan
</span></span><span class="line"><span class="ln">24</span><span class="cl">1a:f1:cc:65:97:37 dev vxlan10 vlan <span class="m">1</span> master br-vxlan permanent
</span></span><span class="line"><span class="ln">25</span><span class="cl">1a:f1:cc:65:97:37 dev vxlan10 master br-vxlan permanent
</span></span><span class="line"><span class="ln">26</span><span class="cl">00:00:00:00:00:00 dev vxlan10 dst 10.21.21.10 self permanent
</span></span><span class="line"><span class="ln">27</span><span class="cl">00:00:00:00:00:00 dev vxlan10 dst 10.21.23.10 self permanent
</span></span><span class="line"><span class="ln">28</span><span class="cl">33:33:00:00:00:01 dev br-vxlan self permanent
</span></span><span class="line"><span class="ln">29</span><span class="cl">01:00:5e:00:00:6a dev br-vxlan self permanent
</span></span><span class="line"><span class="ln">30</span><span class="cl">33:33:00:00:00:6a dev br-vxlan self permanent
</span></span><span class="line"><span class="ln">31</span><span class="cl">01:00:5e:00:00:01 dev br-vxlan self permanent
</span></span><span class="line"><span class="ln">32</span><span class="cl">33:33:ff:1b:df:4b dev br-vxlan self permanent
</span></span><span class="line"><span class="ln">33</span><span class="cl">0e:a9:a0:1b:df:4b dev br-vxlan vlan <span class="m">1</span> master br-vxlan permanent
</span></span><span class="line"><span class="ln">34</span><span class="cl">0e:a9:a0:1b:df:4b dev br-vxlan master br-vxlan permanent
</span></span><span class="line"><span class="ln">35</span><span class="cl">33:33:00:00:00:01 dev ubuntu-2-ce6914 self permanent
</span></span><span class="line"><span class="ln">36</span><span class="cl">01:00:5e:00:00:01 dev ubuntu-2-ce6914 self permanent
</span></span><span class="line"><span class="ln">37</span><span class="cl">33:33:ff:8f:cf:b7 dev ubuntu-2-ce6914 self permanent
</span></span></code></pre></div><p>Its also possible to see some increasing statistics here:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">andreasm@eos-client-2:~$ cat /sys/class/net/vxlan10/statistics/tx_packets
</span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="m">82088</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">andreasm@eos-client-2:~$ cat /sys/class/net/vxlan10/statistics/tx_packets
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="m">82100</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">andreasm@eos-client-2:~$ cat /sys/class/net/vxlan10/statistics/tx_packets
</span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="m">82102</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">andreasm@eos-client-2:~$ cat /sys/class/net/vxlan10/statistics/tx_packets
</span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="m">82104</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">andreasm@eos-client-2:~$ cat /sys/class/net/vxlan10/statistics/rx_packets
</span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="m">81016</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">andreasm@eos-client-2:~$ cat /sys/class/net/vxlan10/statistics/rx_packets
</span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="m">81035</span>
</span></span></code></pre></div><p>If I want to allow for higher mtu I will need to adjust both the vxlan interface and br-vxlan bridge interface. Lets try by just raising the MTU on the br-vxlan interface:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@eos-client-2:~$ sudo ip link <span class="nb">set</span> mtu <span class="m">8000</span> dev br-vxlan
</span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="o">[</span>sudo<span class="o">]</span> password <span class="k">for</span> andreasm:
</span></span><span class="line"><span class="ln">3</span><span class="cl">andreasm@eos-client-2:~$ ping -I br-vxlan 192.168.100.13 -M <span class="k">do</span> -s <span class="m">1600</span> -c <span class="m">4</span>
</span></span><span class="line"><span class="ln">4</span><span class="cl">PING 192.168.100.13 <span class="o">(</span>192.168.100.13<span class="o">)</span> from 192.168.100.12 br-vxlan: 1600<span class="o">(</span>1628<span class="o">)</span> bytes of data.
</span></span><span class="line"><span class="ln">5</span><span class="cl">
</span></span><span class="line"><span class="ln">6</span><span class="cl">--- 192.168.100.13 ping statistics ---
</span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="m">4</span> packets transmitted, <span class="m">0</span> received, 100% packet loss, <span class="nb">time</span> 3062ms
</span></span></code></pre></div><p>Thats not promising.. Remember the monster truck? Thats just what I did now. I came with a car too big to fit the tunnel. The <em>br-vxlan</em> interface had a higher MTU than the <em>VXLAN</em> interface which is still at 1500</p>
<p>Reverting <em>br-vxlan</em> back to MTU1500 again. I will now set the mtu to 100 on the vlan interfaces where my server 2 ens19 interface is connected, I will hit the same scenario as above, but can I see it somehow in my Arista  fabric, and the server itself?</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">veos-dc1-leaf1b<span class="o">(</span>config-if-Vl22<span class="o">)</span><span class="c1">#show active</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">interface Vlan22
</span></span><span class="line"><span class="ln">3</span><span class="cl">   description VRF11_VLAN22
</span></span><span class="line"><span class="ln">4</span><span class="cl">   mtu <span class="m">100</span>
</span></span><span class="line"><span class="ln">5</span><span class="cl">   vrf VRF21
</span></span><span class="line"><span class="ln">6</span><span class="cl">   ip address virtual 10.21.22.1/24
</span></span></code></pre></div><p>Using netstat -s on my affected server 2 I can notice an increase in <em>destination unreachable</em>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">andreasm@eos-client-2:~/vxlan$ netstat -s <span class="p">|</span> grep -A <span class="m">10</span> -E <span class="s2">&#34;^Icmp:&#34;</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">Icmp:
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">    <span class="m">5420</span> ICMP messages received
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">    <span class="m">216</span> input ICMP message failed
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">    ICMP input histogram:
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">        destination unreachable: <span class="m">3452</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">        <span class="nb">echo</span> requests: <span class="m">619</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">        <span class="nb">echo</span> replies: <span class="m">1349</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">    <span class="m">7111</span> ICMP messages sent
</span></span><span class="line"><span class="ln">10</span><span class="cl">    <span class="m">0</span> ICMP messages failed
</span></span><span class="line"><span class="ln">11</span><span class="cl">    ICMP output histogram:
</span></span><span class="line"><span class="ln">12</span><span class="cl">        destination unreachable: <span class="m">3152</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">andreasm@eos-client-2:~/vxlan$
</span></span><span class="line"><span class="ln">14</span><span class="cl">andreasm@eos-client-2:~/vxlan$ netstat -s <span class="p">|</span> grep -A <span class="m">10</span> -E <span class="s2">&#34;^Icmp:&#34;</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">Icmp:
</span></span><span class="line"><span class="ln">16</span><span class="cl">    <span class="m">5455</span> ICMP messages received
</span></span><span class="line"><span class="ln">17</span><span class="cl">    <span class="m">216</span> input ICMP message failed
</span></span><span class="line"><span class="ln">18</span><span class="cl">    ICMP input histogram:
</span></span><span class="line"><span class="ln">19</span><span class="cl">        destination unreachable: <span class="m">3453</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">        <span class="nb">echo</span> requests: <span class="m">619</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl">        <span class="nb">echo</span> replies: <span class="m">1383</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl">    <span class="m">7179</span> ICMP messages sent
</span></span><span class="line"><span class="ln">23</span><span class="cl">    <span class="m">0</span> ICMP messages failed
</span></span><span class="line"><span class="ln">24</span><span class="cl">    ICMP output histogram:
</span></span><span class="line"><span class="ln">25</span><span class="cl">        destination unreachable: <span class="m">3152</span>
</span></span></code></pre></div><p>Doing tcpdump on interface ethernet 6 on my leaf1b switch I can see a whole bunch of Fragmented IP protocol:</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="ip-fragments"
      
        class="image_figure image_internal image_processed"
        width="1257"
        height="962"
        src="/2024/11/08/overlay-on-overlay-arista-in-the-underlay/images/image-20241206091506273.png"
      
      
    />

    </picture>
</figure>
</p>
<p>The same is seen on my server 2 ens19 interface:</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="ip-fragments-ens19"
      
        class="image_figure image_internal image_processed"
        width="1214"
        height="991"
        src="/2024/11/08/overlay-on-overlay-arista-in-the-underlay/images/image-20241206092135310.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Doing tcpdump directly on server 2 itself I see a lots of <em>bytes missing!</em>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">andreasm@eos-client-2:~/tcpdump/mtu_issues$ sudo tcpdump -i ens19 -c <span class="m">100</span>  -vvv
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">tcpdump: listening on ens19, link-type EN10MB <span class="o">(</span>Ethernet<span class="o">)</span>, snapshot length <span class="m">262144</span> bytes
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">10:47:43.473406 IP <span class="o">(</span>tos 0x0, ttl 61, id 48283, offset 0, flags <span class="o">[</span>+<span class="o">]</span>, proto UDP <span class="o">(</span>17<span class="o">)</span>, length 100<span class="o">)</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">    10.21.23.10.43221 &gt; eos-client-2.4789: VXLAN, flags <span class="o">[</span>I<span class="o">]</span> <span class="o">(</span>0x08<span class="o">)</span>, vni <span class="m">666</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">IP truncated-ip - <span class="m">63</span> bytes missing! <span class="o">(</span>tos 0x0, ttl 64, id 43823, offset 0, flags <span class="o">[</span>DF<span class="o">]</span>, proto UDP <span class="o">(</span>17<span class="o">)</span>, length 113<span class="o">)</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">    192.168.100.13.10351 &gt; 192.168.100.11.10351: UDP, length <span class="m">85</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">10:47:43.473407 IP <span class="o">(</span>tos 0x0, ttl 61, id 48283, offset 80, flags <span class="o">[</span>none<span class="o">]</span>, proto UDP <span class="o">(</span>17<span class="o">)</span>, length 83<span class="o">)</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">    10.21.23.10 &gt; eos-client-2: udp
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">10:47:43.476149 IP <span class="o">(</span>tos 0x0, ttl 62, id 11890, offset 0, flags <span class="o">[</span>none<span class="o">]</span>, proto UDP <span class="o">(</span>17<span class="o">)</span>, length 100<span class="o">)</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">    10.21.21.10.55208 &gt; eos-client-2.4789: <span class="o">[</span>udp sum ok<span class="o">]</span> VXLAN, flags <span class="o">[</span>I<span class="o">]</span> <span class="o">(</span>0x08<span class="o">)</span>, vni <span class="m">666</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">IP <span class="o">(</span>tos 0x0, ttl 64, id 33812, offset 0, flags <span class="o">[</span>DF<span class="o">]</span>, proto UDP <span class="o">(</span>17<span class="o">)</span>, length 50<span class="o">)</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">    192.168.100.11.10351 &gt; 192.168.100.13.10351: <span class="o">[</span>udp sum ok<span class="o">]</span> UDP, length <span class="m">22</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">10:47:43.709133 IP <span class="o">(</span>tos 0x0, ttl 61, id 48311, offset 0, flags <span class="o">[</span>+<span class="o">]</span>, proto UDP <span class="o">(</span>17<span class="o">)</span>, length 100<span class="o">)</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">    10.21.23.10.35009 &gt; eos-client-2.4789: VXLAN, flags <span class="o">[</span>I<span class="o">]</span> <span class="o">(</span>0x08<span class="o">)</span>, vni <span class="m">666</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">IP truncated-ip - <span class="m">978</span> bytes missing! <span class="o">(</span>tos 0x0, ttl 64, id 0, offset 0, flags <span class="o">[</span>DF<span class="o">]</span>, proto ICMP <span class="o">(</span>1<span class="o">)</span>, length 1028<span class="o">)</span>
</span></span></code></pre></div><p>Reverting back to the correct mtu size on the vlan interface on leaf1b again, I should no longer see any fragments or missing bytes:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">andreasm@eos-client-2:~/tcpdump/mtu_issues$ sudo tcpdump -i ens19 -c <span class="m">100</span>  -vvv
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">tcpdump: listening on ens19, link-type EN10MB <span class="o">(</span>Ethernet<span class="o">)</span>, snapshot length <span class="m">262144</span> bytes
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">09:29:38.728403 IP <span class="o">(</span>tos 0x0, ttl 64, id 36841, offset 0, flags <span class="o">[</span>none<span class="o">]</span>, proto UDP <span class="o">(</span>17<span class="o">)</span>, length 1128<span class="o">)</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">    eos-client-2.53002 &gt; 10.21.23.10.4789: <span class="o">[</span>udp sum ok<span class="o">]</span> VXLAN, flags <span class="o">[</span>I<span class="o">]</span> <span class="o">(</span>0x08<span class="o">)</span>, vni <span class="m">666</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">IP <span class="o">(</span>tos 0x0, ttl 64, id 39910, offset 0, flags <span class="o">[</span>DF<span class="o">]</span>, proto UDP <span class="o">(</span>17<span class="o">)</span>, length 1078<span class="o">)</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">    eos-client-2.34860 &gt; 192.168.100.13.6081: <span class="o">[</span>no cksum<span class="o">]</span> Geneve, Flags <span class="o">[</span>none<span class="o">]</span>, vni 0x0
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">	IP <span class="o">(</span>tos 0x0, ttl 63, id 0, offset 0, flags <span class="o">[</span>DF<span class="o">]</span>, proto ICMP <span class="o">(</span>1<span class="o">)</span>, length 1028<span class="o">)</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">    10.40.1.4 &gt; 10.40.2.4: ICMP <span class="nb">echo</span> request, id 350, seq 1369, length <span class="m">1008</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">09:29:38.728444 IP <span class="o">(</span>tos 0x0, ttl 64, id 21433, offset 0, flags <span class="o">[</span>none<span class="o">]</span>, proto UDP <span class="o">(</span>17<span class="o">)</span>, length 1128<span class="o">)</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">    eos-client-2.53002 &gt; 10.21.21.10.4789: <span class="o">[</span>udp sum ok<span class="o">]</span> VXLAN, flags <span class="o">[</span>I<span class="o">]</span> <span class="o">(</span>0x08<span class="o">)</span>, vni <span class="m">666</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">IP <span class="o">(</span>tos 0x0, ttl 64, id 39910, offset 0, flags <span class="o">[</span>DF<span class="o">]</span>, proto UDP <span class="o">(</span>17<span class="o">)</span>, length 1078<span class="o">)</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">    eos-client-2.34860 &gt; 192.168.100.13.6081: <span class="o">[</span>no cksum<span class="o">]</span> Geneve, Flags <span class="o">[</span>none<span class="o">]</span>, vni 0x0
</span></span><span class="line"><span class="ln">13</span><span class="cl">	IP <span class="o">(</span>tos 0x0, ttl 63, id 0, offset 0, flags <span class="o">[</span>DF<span class="o">]</span>, proto ICMP <span class="o">(</span>1<span class="o">)</span>, length 1028<span class="o">)</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">    10.40.1.4 &gt; 10.40.2.4: ICMP <span class="nb">echo</span> request, id 350, seq 1369, length <span class="m">1008</span>
</span></span></code></pre></div><h2 id="summary">Summary</h2>
<p>It is not unusual to end up with double or even triple encapsulation. Its just a matter of having control of the MTU at the different levels. They physical fabric needs to accommodate the highest MTU as thats where all traffic needs to traverse. Then the next encapsulation layer also needs to adjust according to the physical MTU configuration. If a third encapsulation layer is deployed this needs to be adjusted to the second encapsulation layers MTU configuration. The third encapsulation layer in my environment above comes from the Kubernetes CNI Antrea, which handles this automatically, but should still be something to be aware of in case of performance or any issues thats needs to be looked into.</p>
<p>If one follow the MTU sizing accordingly it shouldn't be any issues, but if it does it is good to know where to look?</p>
<p>If using tcpdump and manual cli commands is cumbersome, there may be another more elegant way to monitor such things. I will create a follow up post on this at a later stage.</p>
<p>I will end this post with a simple diagram.</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="one-mtu-to-rule-them-all"
      
        class="image_figure image_internal image_processed"
        width="2560"
        height="950"
        src="/2024/11/08/overlay-on-overlay-arista-in-the-underlay/images/image-20241206095739636.png"
      
      
    />

    </picture>
</figure>
</p>
<div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p><em>(Earlier version of VMware NSX called NSX-V used VXLAN too, for a period VMware had two NSX versions NSX-V and NSX-T where the latter used Geneve and is the current NSX product, NSX-V is obsolete and NSX-T now is the only product and is just called NSX.)</em>&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div>

    </div>




  </article>
<aside class="sidebar">
  <section class="sidebar_inner">
    <br>
    
  
  <div class="search">
    <input type="search" class="search_field form_field" placeholder='Search...' id="find" autocomplete="off" data-scope='post'>
    <label for="find" class="search_label"><svg class="icon">
  <title>search</title>
  <use xlink:href="#search"></use>
</svg>

    </label>
    
    <div class="search_results results"></div>
  </div>

        <h2>Hi there</h2>
      <div class="author_bio">
        This is Andreas Marqvardsen's blog, a Systems Engineer at Arista. This blog focuses on stuff he finds interesting and useful. All views and opinions expressed here are his own
      </div>
      <a href='https://blog.andreasm.io/about/' class="button mt-1" role="button" title='Read More'>Read More</a>

    
    
    <h2 class="mt-4">Recent Posts</h2>
    <ul class="flex-column">
      <li>
        <a href="https://blog.andreasm.io/2024/11/08/overlay-on-overlay-arista-in-the-underlay/" class="nav-link" title="Overlay on overlay - Arista in the underlay">Overlay on overlay - Arista in the underlay</a>
      </li>
      <li>
        <a href="https://blog.andreasm.io/2024/08/22/arista-cloudvision-and-avd-using-containerlab/" class="nav-link" title="Arista Cloudvision and AVD using Containerlab">Arista Cloudvision and AVD using Containerlab</a>
      </li>
      <li>
        <a href="https://blog.andreasm.io/2024/06/10/arista-automated-configuration-using-ansible/" class="nav-link" title="Arista Automated Configuration using Ansible">Arista Automated Configuration using Ansible</a>
      </li>
      <li>
        <a href="https://blog.andreasm.io/2024/04/16/exploring-some-antrea-features/" class="nav-link" title="Exploring some Antrea Features">Exploring some Antrea Features</a>
      </li>
      <li>
        <a href="https://blog.andreasm.io/2024/04/08/vsphere-with-tanzu-avi-and-multiple-supervisors/" class="nav-link" title="vSphere with Tanzu - Avi and Multiple Supervisors">vSphere with Tanzu - Avi and Multiple Supervisors</a>
      </li>
      <li>
        <a href="https://blog.andreasm.io/2024/02/04/argo-cd-vsphere-with-tanzu/" class="nav-link" title="Argo CD &amp; vSphere with Tanzu">Argo CD &amp; vSphere with Tanzu</a>
      </li>
      <li>
        <a href="https://blog.andreasm.io/2024/01/15/proxmox-with-opentofu-kubespray-and-kubernetes/" class="nav-link" title="Proxmox with OpenTofu Kubespray and Kubernetes">Proxmox with OpenTofu Kubespray and Kubernetes</a>
      </li>
      <li>
        <a href="https://blog.andreasm.io/2023/12/26/traefik-proxy-in-kubernetes/" class="nav-link" title="Traefik Proxy in Kubernetes">Traefik Proxy in Kubernetes</a>
      </li>
    </ul>
    <div>
      <h2 class="mt-4 taxonomy" id="categories-section">Categories</h2>
      <nav class="tags_nav">
        <a href='https://blog.andreasm.io/categories/kubernetes/' class="post_tag button button_translucent" title="kubernetes">
          KUBERNETES
          <span class="button_tally">42</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/networking/' class="post_tag button button_translucent" title="networking">
          NETWORKING
          <span class="button_tally">23</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/tanzu/' class="post_tag button button_translucent" title="tanzu">
          TANZU
          <span class="button_tally">13</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/cni/' class="post_tag button button_translucent" title="cni">
          CNI
          <span class="button_tally">9</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/loadbalancing/' class="post_tag button button_translucent" title="loadbalancing">
          LOADBALANCING
          <span class="button_tally">9</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/security/' class="post_tag button button_translucent" title="security">
          SECURITY
          <span class="button_tally">7</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/avi/' class="post_tag button button_translucent" title="avi">
          AVI
          <span class="button_tally">6</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/nsx/' class="post_tag button button_translucent" title="nsx">
          NSX
          <span class="button_tally">5</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/antrea/' class="post_tag button button_translucent" title="antrea">
          ANTREA
          <span class="button_tally">4</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/automation/' class="post_tag button button_translucent" title="automation">
          AUTOMATION
          <span class="button_tally">4</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/arista/' class="post_tag button button_translucent" title="arista">
          ARISTA
          <span class="button_tally">2</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/blog/' class="post_tag button button_translucent" title="blog">
          BLOG
          <span class="button_tally">2</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/network/' class="post_tag button button_translucent" title="network">
          NETWORK
          <span class="button_tally">2</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/provisioning/' class="post_tag button button_translucent" title="provisioning">
          PROVISIONING
          <span class="button_tally">2</span>
        </a>
        
        
        <br>
        <div class="post_tags_toggle button">All Categories</div>
        <div class="post_tags">
          <div class="tags_list">
            
            <a href='https://blog.andreasm.io/categories/antrea/' class=" post_tag button button_translucent" data-position=4 title="antrea">ANTREA<span class="button_tally">4</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/argocd/' class=" post_tag button button_translucent" data-position=1 title="argocd">ARGOCD<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/arista/' class=" post_tag button button_translucent" data-position=2 title="arista">ARISTA<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/automation/' class=" post_tag button button_translucent" data-position=4 title="automation">AUTOMATION<span class="button_tally">4</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/autoscaling/' class=" post_tag button button_translucent" data-position=1 title="autoscaling">AUTOSCALING<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/avi/' class=" post_tag button button_translucent" data-position=6 title="avi">AVI<span class="button_tally">6</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/blog/' class=" post_tag button button_translucent" data-position=2 title="blog">BLOG<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/ceos/' class=" post_tag button button_translucent" data-position=1 title="ceos">CEOS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/certificate/' class=" post_tag button button_translucent" data-position=1 title="certificate">CERTIFICATE<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/cni/' class=" post_tag button button_translucent" data-position=9 title="cni">CNI<span class="button_tally">9</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/compliance/' class=" post_tag button button_translucent" data-position=1 title="compliance">COMPLIANCE<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/docker/' class=" post_tag button button_translucent" data-position=1 title="docker">DOCKER<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/ebpf/' class=" post_tag button button_translucent" data-position=1 title="ebpf">EBPF<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/encapsulation/' class=" post_tag button button_translucent" data-position=1 title="encapsulation">ENCAPSULATION<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/eos/' class=" post_tag button button_translucent" data-position=1 title="eos">EOS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/github/' class=" post_tag button button_translucent" data-position=1 title="github">GITHUB<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/gitops/' class=" post_tag button button_translucent" data-position=1 title="gitops">GITOPS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/harbor/' class=" post_tag button button_translucent" data-position=1 title="harbor">HARBOR<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/helm/' class=" post_tag button button_translucent" data-position=1 title="helm">HELM<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/home-automation/' class=" post_tag button button_translucent" data-position=1 title="home-automation">HOME-AUTOMATION<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/hugo/' class=" post_tag button button_translucent" data-position=1 title="hugo">HUGO<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/ingress/' class=" post_tag button button_translucent" data-position=1 title="ingress">INGRESS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/kubernetes/' class=" post_tag button button_translucent" data-position=42 title="kubernetes">KUBERNETES<span class="button_tally">42</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/kubernetes-management/' class=" post_tag button button_translucent" data-position=1 title="kubernetes-management">KUBERNETES-MANAGEMENT<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/lcm/' class=" post_tag button button_translucent" data-position=1 title="lcm">LCM<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/lifecycle-management/' class=" post_tag button button_translucent" data-position=1 title="lifecycle-management">LIFECYCLE-MANAGEMENT<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/loadbalancing/' class=" post_tag button button_translucent" data-position=9 title="loadbalancing">LOADBALANCING<span class="button_tally">9</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/management/' class=" post_tag button button_translucent" data-position=1 title="management">MANAGEMENT<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/monitoring/' class=" post_tag button button_translucent" data-position=1 title="monitoring">MONITORING<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/netowkring/' class=" post_tag button button_translucent" data-position=1 title="netowkring">NETOWKRING<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/network/' class=" post_tag button button_translucent" data-position=2 title="network">NETWORK<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/networking/' class=" post_tag button button_translucent" data-position=23 title="networking">NETWORKING<span class="button_tally">23</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/neuvector/' class=" post_tag button button_translucent" data-position=1 title="neuvector">NEUVECTOR<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/nsx/' class=" post_tag button button_translucent" data-position=5 title="nsx">NSX<span class="button_tally">5</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/nsx-alb/' class=" post_tag button button_translucent" data-position=1 title="nsx-alb">NSX-ALB<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/nsx-t/' class=" post_tag button button_translucent" data-position=1 title="nsx-t">NSX-T<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/overlay/' class=" post_tag button button_translucent" data-position=1 title="overlay">OVERLAY<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/pinniped/' class=" post_tag button button_translucent" data-position=1 title="pinniped">PINNIPED<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/provisioning/' class=" post_tag button button_translucent" data-position=2 title="provisioning">PROVISIONING<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/rancher/' class=" post_tag button button_translucent" data-position=1 title="rancher">RANCHER<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/rbac/' class=" post_tag button button_translucent" data-position=1 title="rbac">RBAC<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/rke2/' class=" post_tag button button_translucent" data-position=1 title="rke2">RKE2<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/security/' class=" post_tag button button_translucent" data-position=7 title="security">SECURITY<span class="button_tally">7</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/storage/' class=" post_tag button button_translucent" data-position=1 title="storage">STORAGE<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/suse/' class=" post_tag button button_translucent" data-position=1 title="suse">SUSE<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/tanzu/' class=" post_tag button button_translucent" data-position=13 title="tanzu">TANZU<span class="button_tally">13</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/tanzu-mission-control/' class=" post_tag button button_translucent" data-position=1 title="tanzu mission control">TANZU MISSION CONTROL<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/tkg/' class=" post_tag button button_translucent" data-position=1 title="tkg">TKG<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/tkgi/' class=" post_tag button button_translucent" data-position=1 title="tkgi">TKGI<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/tmc/' class=" post_tag button button_translucent" data-position=1 title="tmc">TMC<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/topologies/' class=" post_tag button button_translucent" data-position=1 title="topologies">TOPOLOGIES<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/troubleshooting/' class=" post_tag button button_translucent" data-position=1 title="troubleshooting">TROUBLESHOOTING<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/veos/' class=" post_tag button button_translucent" data-position=1 title="veos">VEOS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/virtualization/' class=" post_tag button button_translucent" data-position=1 title="virtualization">VIRTUALIZATION<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/vmare-nsx-intelligence/' class=" post_tag button button_translucent" data-position=1 title="vmare nsx intelligence">VMARE NSX INTELLIGENCE<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/vmware-nsx/' class=" post_tag button button_translucent" data-position=2 title="vmware nsx">VMWARE NSX<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/vmware-cloud/' class=" post_tag button button_translucent" data-position=1 title="vmware-cloud">VMWARE-CLOUD<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/vsphere/' class=" post_tag button button_translucent" data-position=1 title="vsphere">VSPHERE<span class="button_tally">1</span>
            </a>
            
            <div class="tags_sort"><span title="sort alphabetically">[A~Z]</span><span title="sort by count">[0~9]</span>
            </div>
            <span class="tags_hide"><svg class="icon">
            <use xlink:href="#closeme"></use>
          </svg></span>
          </div>
        </div>
      </nav>
    </div>
    <div>
      <h2 class="mt-4 taxonomy" id="tags-section">Tags</h2>
      <nav class="tags_nav">
        <a href='https://blog.andreasm.io/tags/kubernetes/' class="post_tag button button_translucent" title="kubernetes">
          KUBERNETES
          <span class="button_tally">24</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/tanzu/' class="post_tag button button_translucent" title="tanzu">
          TANZU
          <span class="button_tally">14</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/nsx/' class="post_tag button button_translucent" title="nsx">
          NSX
          <span class="button_tally">13</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/antrea/' class="post_tag button button_translucent" title="antrea">
          ANTREA
          <span class="button_tally">12</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/ako/' class="post_tag button button_translucent" title="ako">
          AKO
          <span class="button_tally">8</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/avi/' class="post_tag button button_translucent" title="avi">
          AVI
          <span class="button_tally">7</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/loadbalancing/' class="post_tag button button_translucent" title="loadbalancing">
          LOADBALANCING
          <span class="button_tally">7</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/security/' class="post_tag button button_translucent" title="security">
          SECURITY
          <span class="button_tally">7</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/networking/' class="post_tag button button_translucent" title="networking">
          NETWORKING
          <span class="button_tally">6</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/ingress/' class="post_tag button button_translucent" title="ingress">
          INGRESS
          <span class="button_tally">5</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/cni/' class="post_tag button button_translucent" title="cni">
          CNI
          <span class="button_tally">4</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/automation/' class="post_tag button button_translucent" title="automation">
          AUTOMATION
          <span class="button_tally">3</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/availability/' class="post_tag button button_translucent" title="availability">
          AVAILABILITY
          <span class="button_tally">3</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/cert-manager/' class="post_tag button button_translucent" title="cert-manager">
          CERT-MANAGER
          <span class="button_tally">3</span>
        </a>
        
        
        <br>
        <div class="post_tags_toggle button">All Tags</div>
        <div class="post_tags">
          <div class="tags_list">
            
            <a href='https://blog.andreasm.io/tags/ako/' class=" post_tag button button_translucent" data-position=8 title="ako">AKO<span class="button_tally">8</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/amko/' class=" post_tag button button_translucent" data-position=1 title="amko">AMKO<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/ansible/' class=" post_tag button button_translucent" data-position=1 title="ansible">ANSIBLE<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/antrea/' class=" post_tag button button_translucent" data-position=12 title="antrea">ANTREA<span class="button_tally">12</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/argocd/' class=" post_tag button button_translucent" data-position=1 title="argocd">ARGOCD<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/arista/' class=" post_tag button button_translucent" data-position=2 title="arista">ARISTA<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/authentication/' class=" post_tag button button_translucent" data-position=2 title="authentication">AUTHENTICATION<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/automation/' class=" post_tag button button_translucent" data-position=3 title="automation">AUTOMATION<span class="button_tally">3</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/autoscaling/' class=" post_tag button button_translucent" data-position=1 title="autoscaling">AUTOSCALING<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/availability/' class=" post_tag button button_translucent" data-position=3 title="availability">AVAILABILITY<span class="button_tally">3</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/avi/' class=" post_tag button button_translucent" data-position=7 title="avi">AVI<span class="button_tally">7</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/ceos/' class=" post_tag button button_translucent" data-position=1 title="ceos">CEOS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/cert-manager/' class=" post_tag button button_translucent" data-position=3 title="cert-manager">CERT-MANAGER<span class="button_tally">3</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/certificate/' class=" post_tag button button_translucent" data-position=1 title="certificate">CERTIFICATE<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/cilium/' class=" post_tag button button_translucent" data-position=1 title="cilium">CILIUM<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/cni/' class=" post_tag button button_translucent" data-position=4 title="cni">CNI<span class="button_tally">4</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/compliance/' class=" post_tag button button_translucent" data-position=1 title="compliance">COMPLIANCE<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/containerlab/' class=" post_tag button button_translucent" data-position=1 title="containerlab">CONTAINERLAB<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/custom-resource-definitions/' class=" post_tag button button_translucent" data-position=1 title="custom-resource-definitions">CUSTOM-RESOURCE-DEFINITIONS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/distributed-firewall/' class=" post_tag button button_translucent" data-position=1 title="distributed-firewall">DISTRIBUTED-FIREWALL<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/dns-service/' class=" post_tag button button_translucent" data-position=1 title="dns-service">DNS-SERVICE<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/docker/' class=" post_tag button button_translucent" data-position=2 title="docker">DOCKER<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/ebpf/' class=" post_tag button button_translucent" data-position=1 title="ebpf">EBPF<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/encapsulation/' class=" post_tag button button_translucent" data-position=1 title="encapsulation">ENCAPSULATION<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/eos/' class=" post_tag button button_translucent" data-position=1 title="eos">EOS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/github/' class=" post_tag button button_translucent" data-position=1 title="github">GITHUB<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/gitops/' class=" post_tag button button_translucent" data-position=1 title="gitops">GITOPS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/gslb/' class=" post_tag button button_translucent" data-position=1 title="gslb">GSLB<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/harbor/' class=" post_tag button button_translucent" data-position=1 title="harbor">HARBOR<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/home-assistant/' class=" post_tag button button_translucent" data-position=1 title="home-assistant">HOME-ASSISTANT<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/hugo/' class=" post_tag button button_translucent" data-position=2 title="hugo">HUGO<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/ids/' class=" post_tag button button_translucent" data-position=1 title="ids">IDS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/informational/' class=" post_tag button button_translucent" data-position=2 title="informational">INFORMATIONAL<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/ingress/' class=" post_tag button button_translucent" data-position=5 title="ingress">INGRESS<span class="button_tally">5</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/ips/' class=" post_tag button button_translucent" data-position=1 title="ips">IPS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/keycloak/' class=" post_tag button button_translucent" data-position=1 title="keycloak">KEYCLOAK<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/kubernetes/' class=" post_tag button button_translucent" data-position=24 title="kubernetes">KUBERNETES<span class="button_tally">24</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/kubernetes-api-endpoint/' class=" post_tag button button_translucent" data-position=1 title="kubernetes-api-endpoint">KUBERNETES-API-ENDPOINT<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/kubernetes-management/' class=" post_tag button button_translucent" data-position=1 title="kubernetes-management">KUBERNETES-MANAGEMENT<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/kubespray/' class=" post_tag button button_translucent" data-position=1 title="kubespray">KUBESPRAY<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/lifecycle-management/' class=" post_tag button button_translucent" data-position=1 title="lifecycle-management">LIFECYCLE-MANAGEMENT<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/load-balancing/' class=" post_tag button button_translucent" data-position=1 title="load-balancing">LOAD-BALANCING<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/loadbalancer/' class=" post_tag button button_translucent" data-position=1 title="loadbalancer">LOADBALANCER<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/loadbalancing/' class=" post_tag button button_translucent" data-position=7 title="loadbalancing">LOADBALANCING<span class="button_tally">7</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/lodbalancing/' class=" post_tag button button_translucent" data-position=1 title="lodbalancing">LODBALANCING<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/management/' class=" post_tag button button_translucent" data-position=1 title="management">MANAGEMENT<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/multi-cluster/' class=" post_tag button button_translucent" data-position=1 title="multi-cluster">MULTI-CLUSTER<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/multi-dc/' class=" post_tag button button_translucent" data-position=1 title="multi-dc">MULTI-DC<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/multi-tenancy/' class=" post_tag button button_translucent" data-position=1 title="multi-tenancy">MULTI-TENANCY<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/network/' class=" post_tag button button_translucent" data-position=3 title="network">NETWORK<span class="button_tally">3</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/network-policies/' class=" post_tag button button_translucent" data-position=2 title="network-policies">NETWORK-POLICIES<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/networking/' class=" post_tag button button_translucent" data-position=6 title="networking">NETWORKING<span class="button_tally">6</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/neuvector/' class=" post_tag button button_translucent" data-position=1 title="neuvector">NEUVECTOR<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/nfs/' class=" post_tag button button_translucent" data-position=1 title="nfs">NFS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/nsx/' class=" post_tag button button_translucent" data-position=13 title="nsx">NSX<span class="button_tally">13</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/nsx-advanced-loadbalancer/' class=" post_tag button button_translucent" data-position=1 title="nsx advanced loadbalancer">NSX ADVANCED LOADBALANCER<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/nsx-alb/' class=" post_tag button button_translucent" data-position=1 title="nsx-alb">NSX-ALB<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/nsx-application-platform/' class=" post_tag button button_translucent" data-position=1 title="nsx-application-platform">NSX-APPLICATION-PLATFORM<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/nsx-t/' class=" post_tag button button_translucent" data-position=2 title="nsx-t">NSX-T<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/opentofu/' class=" post_tag button button_translucent" data-position=1 title="opentofu">OPENTOFU<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/overlay/' class=" post_tag button button_translucent" data-position=1 title="overlay">OVERLAY<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/persistent-storage/' class=" post_tag button button_translucent" data-position=1 title="persistent-storage">PERSISTENT-STORAGE<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/pinniped/' class=" post_tag button button_translucent" data-position=1 title="pinniped">PINNIPED<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/provisioning/' class=" post_tag button button_translucent" data-position=2 title="provisioning">PROVISIONING<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/proxmox/' class=" post_tag button button_translucent" data-position=1 title="proxmox">PROXMOX<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/proxy/' class=" post_tag button button_translucent" data-position=1 title="proxy">PROXY<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/pvc/' class=" post_tag button button_translucent" data-position=1 title="pvc">PVC<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/rancher/' class=" post_tag button button_translucent" data-position=1 title="rancher">RANCHER<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/rbac/' class=" post_tag button button_translucent" data-position=1 title="rbac">RBAC<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/registry/' class=" post_tag button button_translucent" data-position=1 title="registry">REGISTRY<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/rke2/' class=" post_tag button button_translucent" data-position=1 title="rke2">RKE2<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/security/' class=" post_tag button button_translucent" data-position=7 title="security">SECURITY<span class="button_tally">7</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/static-content-generator/' class=" post_tag button button_translucent" data-position=1 title="static-content-generator">STATIC-CONTENT-GENERATOR<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/static-site-generator/' class=" post_tag button button_translucent" data-position=1 title="static-site-generator">STATIC-SITE-GENERATOR<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/suse/' class=" post_tag button button_translucent" data-position=2 title="suse">SUSE<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/tanzu/' class=" post_tag button button_translucent" data-position=14 title="tanzu">TANZU<span class="button_tally">14</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/tanzu-kubernetes-grid/' class=" post_tag button button_translucent" data-position=1 title="tanzu-kubernetes-grid">TANZU-KUBERNETES-GRID<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/terraform/' class=" post_tag button button_translucent" data-position=1 title="terraform">TERRAFORM<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/tkg/' class=" post_tag button button_translucent" data-position=1 title="tkg">TKG<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/tkg-2.1/' class=" post_tag button button_translucent" data-position=1 title="tkg 2.1">TKG 2.1<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/tkgi/' class=" post_tag button button_translucent" data-position=1 title="tkgi">TKGI<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/tkgs/' class=" post_tag button button_translucent" data-position=1 title="tkgs">TKGS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/tmc/' class=" post_tag button button_translucent" data-position=1 title="tmc">TMC<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/tmc-local/' class=" post_tag button button_translucent" data-position=1 title="tmc-local">TMC-LOCAL<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/tmc-sm/' class=" post_tag button button_translucent" data-position=1 title="tmc-sm">TMC-SM<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/topologies/' class=" post_tag button button_translucent" data-position=1 title="topologies">TOPOLOGIES<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/traefik/' class=" post_tag button button_translucent" data-position=1 title="traefik">TRAEFIK<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/troubleshooting/' class=" post_tag button button_translucent" data-position=2 title="troubleshooting">TROUBLESHOOTING<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/unifi/' class=" post_tag button button_translucent" data-position=1 title="unifi">UNIFI<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/veos/' class=" post_tag button button_translucent" data-position=1 title="veos">VEOS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/vmconaws/' class=" post_tag button button_translucent" data-position=1 title="vmconaws">VMCONAWS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/vsphere/' class=" post_tag button button_translucent" data-position=2 title="vsphere">VSPHERE<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/vsphere-replication/' class=" post_tag button button_translucent" data-position=1 title="vsphere-replication">VSPHERE-REPLICATION<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/vsphere-with-tanzu/' class=" post_tag button button_translucent" data-position=1 title="vsphere-with-tanzu">VSPHERE-WITH-TANZU<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/zwave/' class=" post_tag button button_translucent" data-position=1 title="zwave">ZWAVE<span class="button_tally">1</span>
            </a>
            
            <div class="tags_sort"><span title="sort alphabetically">[A~Z]</span><span title="sort by count">[0~9]</span>
            </div>
            <span class="tags_hide"><svg class="icon">
            <use xlink:href="#closeme"></use>
          </svg></span>
          </div>
        </div>
      </nav>
    </div>
  </section>
</aside>

  
</div>
    </main><svg width="0" height="0" class="hidden">
  <symbol viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" id="facebook">
    <path d="M437 0H75C33.648 0 0 33.648 0 75v362c0 41.352 33.648 75 75 75h151V331h-60v-90h60v-61c0-49.629 40.371-90 90-90h91v90h-91v61h91l-15 90h-76v181h121c41.352 0 75-33.648 75-75V75c0-41.352-33.648-75-75-75zm0 0"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18.001 18.001" id="twitter">
    <path d="M15.891 4.013c.808-.496 1.343-1.173 1.605-2.034a8.68 8.68 0 0 1-2.351.861c-.703-.756-1.593-1.14-2.66-1.14-1.043 0-1.924.366-2.643 1.078a3.56 3.56 0 0 0-1.076 2.605c0 .309.039.585.117.819-3.076-.105-5.622-1.381-7.628-3.837-.34.601-.51 1.213-.51 1.846 0 1.301.549 2.332 1.645 3.089-.625-.053-1.176-.211-1.645-.47 0 .929.273 1.705.82 2.388a3.623 3.623 0 0 0 2.115 1.291c-.312.08-.641.118-.979.118-.312 0-.533-.026-.664-.083.23.757.664 1.371 1.291 1.841a3.652 3.652 0 0 0 2.152.743C4.148 14.173 2.625 14.69.902 14.69c-.422 0-.721-.006-.902-.038 1.697 1.102 3.586 1.649 5.676 1.649 2.139 0 4.029-.542 5.674-1.626 1.645-1.078 2.859-2.408 3.639-3.974a10.77 10.77 0 0 0 1.172-4.892v-.468a7.788 7.788 0 0 0 1.84-1.921 8.142 8.142 0 0 1-2.11.593z"
      ></path>
  </symbol>
  <symbol aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id="mail">
    <path  d="M502.3 190.8c3.9-3.1 9.7-.2 9.7 4.7V400c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V195.6c0-5 5.7-7.8 9.7-4.7 22.4 17.4 52.1 39.5 154.1 113.6 21.1 15.4 56.7 47.8 92.2 47.6 35.7.3 72-32.8 92.3-47.6 102-74.1 131.6-96.3 154-113.7zM256 320c23.2.4 56.6-29.2 73.4-41.4 132.7-96.3 142.8-104.7 173.4-128.7 5.8-4.5 9.2-11.5 9.2-18.9v-19c0-26.5-21.5-48-48-48H48C21.5 64 0 85.5 0 112v19c0 7.4 3.4 14.3 9.2 18.9 30.6 23.9 40.7 32.4 173.4 128.7 16.8 12.2 50.2 41.8 73.4 41.4z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id="calendar">
    <path d="M452 40h-24V0h-40v40H124V0H84v40H60C26.916 40 0 66.916 0 100v352c0 33.084 26.916 60 60 60h392c33.084 0 60-26.916 60-60V100c0-33.084-26.916-60-60-60zm20 412c0 11.028-8.972 20-20 20H60c-11.028 0-20-8.972-20-20V188h432v264zm0-304H40v-48c0-11.028 8.972-20 20-20h24v40h40V80h264v40h40V80h24c11.028 0 20 8.972 20 20v48z"></path>
    <path d="M76 230h40v40H76zm80 0h40v40h-40zm80 0h40v40h-40zm80 0h40v40h-40zm80 0h40v40h-40zM76 310h40v40H76zm80 0h40v40h-40zm80 0h40v40h-40zm80 0h40v40h-40zM76 390h40v40H76zm80 0h40v40h-40zm80 0h40v40h-40zm80 0h40v40h-40zm80-80h40v40h-40z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id="github">
    <path d="M255.968 5.329C114.624 5.329 0 120.401 0 262.353c0 113.536 73.344 209.856 175.104 243.872 12.8 2.368 17.472-5.568 17.472-12.384 0-6.112-.224-22.272-.352-43.712-71.2 15.52-86.24-34.464-86.24-34.464-11.616-29.696-28.416-37.6-28.416-37.6-23.264-15.936 1.728-15.616 1.728-15.616 25.696 1.824 39.2 26.496 39.2 26.496 22.848 39.264 59.936 27.936 74.528 21.344 2.304-16.608 8.928-27.936 16.256-34.368-56.832-6.496-116.608-28.544-116.608-127.008 0-28.064 9.984-51.008 26.368-68.992-2.656-6.496-11.424-32.64 2.496-68 0 0 21.504-6.912 70.4 26.336 20.416-5.696 42.304-8.544 64.096-8.64 21.728.128 43.648 2.944 64.096 8.672 48.864-33.248 70.336-26.336 70.336-26.336 13.952 35.392 5.184 61.504 2.56 68 16.416 17.984 26.304 40.928 26.304 68.992 0 98.72-59.84 120.448-116.864 126.816 9.184 7.936 17.376 23.616 17.376 47.584 0 34.368-.32 62.08-.32 70.496 0 6.88 4.608 14.88 17.6 12.352C438.72 472.145 512 375.857 512 262.353 512 120.401 397.376 5.329 255.968 5.329z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 212 212" id="gitlab">
    <path d="M12.3 74.7h54L43.3 3c-1-3.6-6.4-3.6-7.6 0L12.3 74.8z" />
    <path d="M12.3 74.7L.5 111c-1 3.2 0 6.8 3 8.8l101.6 74-92.5-119z"/>
    <path d="M105 193.7l-38.6-119h-54l92.7 119z"/>
    <path d="M105 193.7l38.7-119H66.4l38.7 119z"/>
    <path d="M105 193.7l38.7-119H198l-93 119z"/>
    <path d="M198 74.7l11.6 36.2c1 3 0 6.6-3 8.6l-101.5 74 93-119z"/>
    <path d="M198 74.7h-54.3L167 3c1.2-3.6 6.4-3.6 7.6 0L198 74.8z"/> 
  </symbol>
  <symbol viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" id="rss">
    <circle cx="3.429" cy="20.571" r="3.429"></circle>
    <path d="M11.429 24h4.57C15.999 15.179 8.821 8.001 0 8v4.572c6.302.001 11.429 5.126 11.429 11.428z"></path>
    <path d="M24 24C24 10.766 13.234 0 0 0v4.571c10.714 0 19.43 8.714 19.43 19.429z"></path>
  </symbol>
  <symbol viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" id="linkedin">
    <path d="M437 0H75C33.648 0 0 33.648 0 75v362c0 41.352 33.648 75 75 75h362c41.352 0 75-33.648 75-75V75c0-41.352-33.648-75-75-75zM181 406h-60V196h60zm0-240h-60v-60h60zm210 240h-60V286c0-16.54-13.46-30-30-30s-30 13.46-30 30v120h-60V196h60v11.309C286.719 202.422 296.93 196 316 196c40.691.043 75 36.547 75 79.688zm0 0"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 612 612" id="to-top">
    <path d="M604.501 440.509L325.398 134.956c-5.331-5.357-12.423-7.627-19.386-7.27-6.989-.357-14.056 1.913-19.387 7.27L7.499 440.509c-9.999 10.024-9.999 26.298 0 36.323s26.223 10.024 36.222 0l262.293-287.164L568.28 476.832c9.999 10.024 26.222 10.024 36.221 0 9.999-10.023 9.999-26.298 0-36.323z"></path>
  </symbol>
  <symbol viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" id="carly">
    <path d="M504.971 239.029L448 182.059V84c0-46.317-37.682-84-84-84h-44c-13.255 0-24 10.745-24 24s10.745 24 24 24h44c19.851 0 36 16.149 36 36v108c0 6.365 2.529 12.47 7.029 16.971L454.059 256l-47.029 47.029A24.002 24.002 0 0 0 400 320v108c0 19.851-16.149 36-36 36h-44c-13.255 0-24 10.745-24 24s10.745 24 24 24h44c46.318 0 84-37.683 84-84v-98.059l56.971-56.971c9.372-9.372 9.372-24.568 0-33.941zM112 192V84c0-19.851 16.149-36 36-36h44c13.255 0 24-10.745 24-24S205.255 0 192 0h-44c-46.318 0-84 37.683-84 84v98.059l-56.971 56.97c-9.373 9.373-9.373 24.568 0 33.941L64 329.941V428c0 46.317 37.682 84 84 84h44c13.255 0 24-10.745 24-24s-10.745-24-24-24h-44c-19.851 0-36-16.149-36-36V320c0-6.365-2.529-12.47-7.029-16.971L57.941 256l47.029-47.029A24.002 24.002 0 0 0 112 192z"></path>
  </symbol>
  <symbol viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" id="copy">
    <path d="M23 2.75A2.75 2.75 0 0 0 20.25 0H8.75A2.75 2.75 0 0 0 6 2.75v13.5A2.75 2.75 0 0 0 8.75 19h11.5A2.75 2.75 0 0 0 23 16.25zM18.25 14.5h-7.5a.75.75 0 0 1 0-1.5h7.5a.75.75 0 0 1 0 1.5zm0-3h-7.5a.75.75 0 0 1 0-1.5h7.5a.75.75 0 0 1 0 1.5zm0-3h-7.5a.75.75 0 0 1 0-1.5h7.5a.75.75 0 0 1 0 1.5z"></path>
    <path d="M8.75 20.5a4.255 4.255 0 0 1-4.25-4.25V2.75c0-.086.02-.166.025-.25H3.75A2.752 2.752 0 0 0 1 5.25v16A2.752 2.752 0 0 0 3.75 24h12a2.752 2.752 0 0 0 2.75-2.75v-.75z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512.001 512.001" id="closeme">
    <path d="M284.286 256.002L506.143 34.144c7.811-7.811 7.811-20.475 0-28.285-7.811-7.81-20.475-7.811-28.285 0L256 227.717 34.143 5.859c-7.811-7.811-20.475-7.811-28.285 0-7.81 7.811-7.811 20.475 0 28.285l221.857 221.857L5.858 477.859c-7.811 7.811-7.811 20.475 0 28.285a19.938 19.938 0 0 0 14.143 5.857 19.94 19.94 0 0 0 14.143-5.857L256 284.287l221.857 221.857c3.905 3.905 9.024 5.857 14.143 5.857s10.237-1.952 14.143-5.857c7.811-7.811 7.811-20.475 0-28.285L284.286 256.002z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id="open-menu">
    <path d="M492 236H20c-11.046 0-20 8.954-20 20s8.954 20 20 20h472c11.046 0 20-8.954 20-20s-8.954-20-20-20zm0-160H20C8.954 76 0 84.954 0 96s8.954 20 20 20h472c11.046 0 20-8.954 20-20s-8.954-20-20-20zm0 320H20c-11.046 0-20 8.954-20 20s8.954 20 20 20h472c11.046 0 20-8.954 20-20s-8.954-20-20-20z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="instagram">
    <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id=youtube>
    <path d="M19.615 3.184c-3.604-.246-11.631-.245-15.23 0-3.897.266-4.356 2.62-4.385 8.816.029 6.185.484 8.549 4.385 8.816 3.6.245 11.626.246 15.23 0 3.897-.266 4.356-2.62 4.385-8.816-.029-6.185-.484-8.549-4.385-8.816zm-10.615 12.816v-8l8 3.993-8 4.007z"/>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="stackoverflow">
    <path d="M21 27v-8h3v11H0V19h3v8h18z"></path><path d="M17.1.2L15 1.8l7.9 10.6 2.1-1.6L17.1.2zm3.7 14.7L10.6 6.4l1.7-2 10.2 8.5-1.7 2zM7.2 12.3l12 5.6 1.1-2.4-12-5.6-1.1 2.4zm-1.8 6.8l13.56 1.96.17-2.38-13.26-2.55-.47 2.97zM19 25H5v-3h14v3z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="xing">
    <path d="M18.188 0c-.517 0-.741.325-.927.66 0 0-7.455 13.224-7.702 13.657.015.024 4.919 9.023 4.919 9.023.17.308.436.66.967.66h3.454c.211 0 .375-.078.463-.22.089-.151.089-.346-.009-.536l-4.879-8.916c-.004-.006-.004-.016 0-.022L22.139.756c.095-.191.097-.387.006-.535C22.056.078 21.894 0 21.686 0h-3.498zM3.648 4.74c-.211 0-.385.074-.473.216-.09.149-.078.339.02.531l2.34 4.05c.004.01.004.016 0 .021L1.86 16.051c-.099.188-.093.381 0 .529.085.142.239.234.45.234h3.461c.518 0 .766-.348.945-.667l3.734-6.609-2.378-4.155c-.172-.315-.434-.659-.962-.659H3.648v.016z"/>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 71 55" id="discord">
    <path d="M60.1045 4.8978C55.5792 2.8214 50.7265 1.2916 45.6527 0.41542C45.5603 0.39851 45.468 0.440769 45.4204 0.525289C44.7963 1.6353 44.105 3.0834 43.6209 4.2216C38.1637 3.4046 32.7345 3.4046 27.3892 4.2216C26.905 3.0581 26.1886 1.6353 25.5617 0.525289C25.5141 0.443589 25.4218 0.40133 25.3294 0.41542C20.2584 1.2888 15.4057 2.8186 10.8776 4.8978C10.8384 4.9147 10.8048 4.9429 10.7825 4.9795C1.57795 18.7309 -0.943561 32.1443 0.293408 45.3914C0.299005 45.4562 0.335386 45.5182 0.385761 45.5576C6.45866 50.0174 12.3413 52.7249 18.1147 54.5195C18.2071 54.5477 18.305 54.5139 18.3638 54.4378C19.7295 52.5728 20.9469 50.6063 21.9907 48.5383C22.0523 48.4172 21.9935 48.2735 21.8676 48.2256C19.9366 47.4931 18.0979 46.6 16.3292 45.5858C16.1893 45.5041 16.1781 45.304 16.3068 45.2082C16.679 44.9293 17.0513 44.6391 17.4067 44.3461C17.471 44.2926 17.5606 44.2813 17.6362 44.3151C29.2558 49.6202 41.8354 49.6202 53.3179 44.3151C53.3935 44.2785 53.4831 44.2898 53.5502 44.3433C53.9057 44.6363 54.2779 44.9293 54.6529 45.2082C54.7816 45.304 54.7732 45.5041 54.6333 45.5858C52.8646 46.6197 51.0259 47.4931 49.0921 48.2228C48.9662 48.2707 48.9102 48.4172 48.9718 48.5383C50.038 50.6034 51.2554 52.5699 52.5959 54.435C52.6519 54.5139 52.7526 54.5477 52.845 54.5195C58.6464 52.7249 64.529 50.0174 70.6019 45.5576C70.6551 45.5182 70.6887 45.459 70.6943 45.3942C72.1747 30.0791 68.2147 16.7757 60.1968 4.9823C60.1772 4.9429 60.1437 4.9147 60.1045 4.8978ZM23.7259 37.3253C20.2276 37.3253 17.3451 34.1136 17.3451 30.1693C17.3451 26.225 20.1717 23.0133 23.7259 23.0133C27.308 23.0133 30.1626 26.2532 30.1066 30.1693C30.1066 34.1136 27.28 37.3253 23.7259 37.3253ZM47.3178 37.3253C43.8196 37.3253 40.9371 34.1136 40.9371 30.1693C40.9371 26.225 43.7636 23.0133 47.3178 23.0133C50.9 23.0133 53.7545 26.2532 53.6986 30.1693C53.6986 34.1136 50.9 37.3253 47.3178 37.3253Z"/>
  </symbol>
</svg>


<footer class="footer">
  <div class="footer_inner wrap pale">
    <img src='https://blog.andreasm.io/icons/apple-touch-icon.png' class="icon icon_2 transparent" alt="From 0.985mhz... to several Ghz">
    <p>Copyright&nbsp;2016-&nbsp;<span class="year"></span>&nbsp;FROM 0.985MHZ... TO SEVERAL GHZ. All Rights Reserved</p><a class="to_top" href="#documentTop">
  <svg class="icon">
  <title>to-top</title>
  <use xlink:href="#to-top"></use>
</svg>

</a>

  </div>
</footer>

<script type="text/javascript" src="https://blog.andreasm.io/en/js/bundle.5548d358738600c857a1f05f0459418da7143d4426c66a08bf3f15ded1b39dd2136bf104a559247a909fc4dcc45b8e06bad0870ece4c71ee5303d30550def8bd.js" integrity="sha512-VUjTWHOGAMhXofBfBFlBjacUPUQmxmoIvz8V3tGzndITa/EEpVkkepCfxNzEW44GutCHDs5Mce5TA9MFUN74vQ==" crossorigin="anonymous"></script>

  <script src="https://blog.andreasm.io/js/search.min.95a6a82b7db565e9830200f15d8809e9663868dd57209f6f86afd54bb19568b9fbdfb9b479ebcc5d37e3b2e2136e396c05135d268cd68b21728a0bc176a8a809.js"></script>

  </body>
</html>
