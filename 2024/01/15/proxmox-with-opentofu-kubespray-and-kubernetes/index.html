<!DOCTYPE html>
<html lang="en" dir="ltr" class="scroll-smooth" data-default-appearance="dark"
  data-auto-appearance="true"><head>
  <meta charset="utf-8" />
  
  <meta http-equiv="content-language" content="en" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  
  <title>Proxmox with OpenTofu Kubespray and Kubernetes &middot; blog.andreasm.io</title>
  <meta name="title" content="Proxmox with OpenTofu Kubespray and Kubernetes &middot; blog.andreasm.io" />
  
  <meta name="description" content="In this post I will quickly go through how I made use of OpenTofu to provision VMs on my Proxmox cluster and Ansible using Kubespray to deploy my Kubernetes clusters on demand." />
  <meta name="keywords" content="kubernetes, proxmox, ansible, terraform, opentofu, kubespray, " />
  
  
  <link rel="canonical" href="https://blog.andreasm.io/2024/01/15/proxmox-with-opentofu-kubespray-and-kubernetes/" />
  
  
  
  
  
  
  
  
  
  
  
  
  <link type="text/css" rel="stylesheet" href="/css/main.bundle.min.48d290696564c2380c4233780f3fd414aa6e2b0b67ed916e9d918c48c05f5b20b641bf892fadd408e43ec21d2feb2ec1fe6fd1f021df2806a254977fe2f80a64.css"
    integrity="sha512-SNKQaWVkwjgMQjN4Dz/UFKpuKwtn7ZFunZGMSMBfWyC2Qb&#43;JL63UCOQ&#43;wh0v6y7B/m/R8CHfKAaiVJd/4vgKZA==" />
  
  
  <script type="text/javascript" src="/js/appearance.min.a85bd6dc99d1fecae166deb56a1fee6375588c72533c4b8c690e4a9ec5a04174ff780e41e2ac770382a8e67818cb2b89766afa3e23965c9102424a080dafbb0c.js"
    integrity="sha512-qFvW3JnR/srhZt61ah/uY3VYjHJTPEuMaQ5KnsWgQXT/eA5B4qx3A4Ko5ngYyyuJdmr6PiOWXJECQkoIDa&#43;7DA=="></script>
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <script defer type="text/javascript" id="script-bundle" src="/js/main.bundle.min.a2d78d78672e549fbfc972ece871725b5478ba0b65708dda20cb97ab80a865eae6d247e1b05a4aec6ebbf78647ec3233bad8b2609ed98eee53cd58aa17128bc7.js"
    integrity="sha512-oteNeGcuVJ&#43;/yXLs6HFyW1R4ugtlcI3aIMuXq4CoZerm0kfhsFpK7G6794ZH7DIzutiyYJ7Zju5TzViqFxKLxw==" data-copy="" data-copied=""></script>
  
  
  
  <script src="/lib/zoom/zoom.min.37d2094687372da3f7343a221a470f6b8806f7891aa46a5a03966af7f0ebd38b9fe536cb154e6ad28f006d184b294525a7c4054b6bbb4be62d8b453b42db99bd.js" integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S&#43;Yti0U7QtuZvQ=="></script>
  
  
  
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
  <link rel="manifest" href="/site.webmanifest" />
  
  
  
  
  
  
  
  
  <meta property="og:url" content="https://blog.andreasm.io/2024/01/15/proxmox-with-opentofu-kubespray-and-kubernetes/">
  <meta property="og:site_name" content="blog.andreasm.io">
  <meta property="og:title" content="Proxmox with OpenTofu Kubespray and Kubernetes">
  <meta property="og:description" content="Automating with Terraform, Ansible and Kubespray on Proxmox">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-01-15T14:15:19+01:00">
    <meta property="article:modified_time" content="2024-01-15T14:15:19+01:00">
    <meta property="article:tag" content="Kubernetes">
    <meta property="article:tag" content="Proxmox">
    <meta property="article:tag" content="Ansible">
    <meta property="article:tag" content="Terraform">
    <meta property="article:tag" content="Opentofu">
    <meta property="article:tag" content="Kubespray">
    <meta property="og:image" content="https://blog.andreasm.io/2024/01/15/proxmox-with-opentofu-kubespray-and-kubernetes/feature-proxmox-logo-stacked-inverted-color.jpg">

  
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://blog.andreasm.io/2024/01/15/proxmox-with-opentofu-kubespray-and-kubernetes/feature-proxmox-logo-stacked-inverted-color.jpg">
  <meta name="twitter:title" content="Proxmox with OpenTofu Kubespray and Kubernetes">
  <meta name="twitter:description" content="Automating with Terraform, Ansible and Kubespray on Proxmox">

  
  <script type="application/ld+json">
  [{
    "@context": "https://schema.org",
    "@type": "Article",
    "articleSection": "Posts",
    "name": "Proxmox with OpenTofu Kubespray and Kubernetes",
    "headline": "Proxmox with OpenTofu Kubespray and Kubernetes",
    "description": "Automating with Terraform, Ansible and Kubespray on Proxmox",
    "abstract": "In this post I will quickly go through how I made use of OpenTofu to provision VMs on my Proxmox cluster and Ansible using Kubespray to deploy my Kubernetes clusters on demand.",
    "inLanguage": "en",
    "url" : "https:\/\/blog.andreasm.io\/2024\/01\/15\/proxmox-with-opentofu-kubespray-and-kubernetes\/",
    "author" : {
      "@type": "Person",
      "name": "Andreas Marqvardsen"
    },
    "copyrightYear": "2024",
    "dateCreated": "2024-01-15T14:15:19\u002b01:00",
    "datePublished": "2024-01-15T14:15:19\u002b01:00",
    
    "dateModified": "2024-01-15T14:15:19\u002b01:00",
    
    "keywords": ["kubernetes","proxmox","ansible","terraform","opentofu","kubespray"],
    
    "mainEntityOfPage": "true",
    "wordCount": "7897"
  }]
  </script>


  
  
  <meta name="author" content="Andreas Marqvardsen" />
  
  
  
  <link href="mailto:andreas.marqvardsen[AT]gmail.com" rel="me" />
  
  
  <link href="https://blog.andreasm.io/" rel="me" />
  
  
  <link href="https://github.com/andreasm80" rel="me" />
  
  
  <link href="https://linkedin.com/in/andreas-marqvardsen" rel="me" />
  
  
  <link href="https://vmst.io/@andreasm" rel="me" />
  
  
  <link href="https://x.com/NATsoFast" rel="me" />
  
  
  
  

<script src="/lib/jquery/jquery.slim.min.b0dca576e87d7eaa5850ae4e61759c065786cdb6489d68fcc82240539eebd5da522bdb4fda085ffd245808c8fe2acb2516408eb774ef26b5f6015fc6737c0ea8.js" integrity="sha512-sNylduh9fqpYUK5OYXWcBleGzbZInWj8yCJAU57r1dpSK9tP2ghf/SRYCMj&#43;KsslFkCOt3TvJrX2AV/Gc3wOqA=="></script>






















  
  

<script async src="https://www.googletagmanager.com/gtag/js?id=G-TVPYDVE8KR"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-TVPYDVE8KR');
</script>



  
  
  <meta name="theme-color"/>
  
  
</head>
<body
  class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32 scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600">
  <div id="the-top" class="absolute flex self-center">
    <a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600"
      href="#main-content"><span
        class="font-bold text-primary-600 ltr:pr-2 rtl:pl-2 dark:text-primary-400">&darr;</span>Skip to main content</a>
  </div>
  
  
  <div class="min-h-[148px]"></div>
<div class="fixed inset-x-0 pl-[24px] pr-[24px]" style="z-index:100">
  <div id="menu-blur" class="absolute opacity-0 inset-x-0 top-0 h-full single_hero_background nozoom backdrop-blur-2xl shadow-2xl"></div>
  <div class="relative max-w-[64rem] ml-auto mr-auto">
    <div style="padding-left:0;padding-right:0;padding-top:2px;padding-bottom:3px"
    class="main-menu flex items-center justify-between px-4 py-6 sm:px-6 md:justify-start space-x-3">
    
    
    
    <div>
        <a href="/" class="flex">
            <span class="sr-only">blog.andreasm.io</span>

            
            <img src="/ynwa2.png" width="300" height="342"
                class="logo max-h-[5rem] max-w-[5rem] object-scale-down object-left nozoom" alt="blog.andreasm.io" />
            

        </a>
    </div>
    
    <div class="flex flex-1 items-center justify-between">
        <nav class="flex space-x-3">

            
            <a href="/" class="text-base font-medium text-gray-500 hover:text-gray-900">blog.andreasm.io</a>
            

        </nav>
        <nav class="hidden md:flex items-center space-x-5 md:ml-12 h-12">

            
            
            
  <a href="/posts/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
    
    <p class="text-base font-medium" title="">
        Posts
    </p>
</a>



            
            
  <a href="/about/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
    
    <p class="text-base font-medium" title="">
        About
    </p>
</a>



            
            
  <a href="/categories/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
    
    <p class="text-base font-medium" title="">
        Categories
    </p>
</a>



            
            
  <a href="/tags/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
    
    <p class="text-base font-medium" title="">
        Tags
    </p>
</a>



            
            

            


            
            <button id="search-button" aria-label="Search" class="text-base hover:text-primary-600 dark:hover:text-primary-400"
                title="">
                

  <span class="relative block icon">
    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>

  </span>


            </button>
            


            
            
            <div
                class="ltr:mr-14 rtl:ml-14 flex items-center">
                <button id="appearance-switcher" aria-label="Dark mode switcher" type="button" class="text-base hover:text-primary-600 dark:hover:text-primary-400">
                    <div class="flex items-center justify-center dark:hidden">
                        

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M32 256c0-123.8 100.3-224 223.8-224c11.36 0 29.7 1.668 40.9 3.746c9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3c9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480C132.1 480 32 379.6 32 256z"/></svg>

  </span>


                    </div>
                    <div class="items-center justify-center hidden dark:flex">
                        

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02 0-95.1 42.98-95.1 95.1S202.1 351.1 256 351.1s95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347L446.1 255.1l63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7l-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89L164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6L12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256l-63.15 91.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7l19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109l109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69 0-127.1-57.31-127.1-127.1c0-70.69 57.31-127.1 127.1-127.1s127.1 57.3 127.1 127.1C383.1 326.7 326.7 383.1 256 383.1z"/></svg>

  </span>


                    </div>
                </button>
            </div>
            

        </nav>
        <div class="flex md:hidden items-center space-x-5 md:ml-12 h-12">

            <span></span>

            


            
            <button id="search-button-mobile" aria-label="Search" class="text-base hover:text-primary-600 dark:hover:text-primary-400"
                title="">
                

  <span class="relative block icon">
    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>

  </span>


            </button>
            

            
            
            <button id="appearance-switcher-mobile" aria-label="Dark mode switcher" type="button" class="text-base hover:text-primary-600 dark:hover:text-primary-400" style="margin-right:5px">
                <div class="flex items-center justify-center dark:hidden">
                    

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M32 256c0-123.8 100.3-224 223.8-224c11.36 0 29.7 1.668 40.9 3.746c9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3c9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480C132.1 480 32 379.6 32 256z"/></svg>

  </span>


                </div>
                <div class="items-center justify-center hidden dark:flex">
                    

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02 0-95.1 42.98-95.1 95.1S202.1 351.1 256 351.1s95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347L446.1 255.1l63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7l-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89L164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6L12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256l-63.15 91.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7l19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109l109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69 0-127.1-57.31-127.1-127.1c0-70.69 57.31-127.1 127.1-127.1s127.1 57.3 127.1 127.1C383.1 326.7 326.7 383.1 256 383.1z"/></svg>

  </span>


                </div>
            </button>
            

        </div>
    </div>
    <div class="-my-2 -mr-2 md:hidden">

        <label id="menu-button" class="block">
            
            <div class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400">
                

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M0 96C0 78.33 14.33 64 32 64H416C433.7 64 448 78.33 448 96C448 113.7 433.7 128 416 128H32C14.33 128 0 113.7 0 96zM0 256C0 238.3 14.33 224 32 224H416C433.7 224 448 238.3 448 256C448 273.7 433.7 288 416 288H32C14.33 288 0 273.7 0 256zM416 448H32C14.33 448 0 433.7 0 416C0 398.3 14.33 384 32 384H416C433.7 384 448 398.3 448 416C448 433.7 433.7 448 416 448z"/></svg>

  </span>


            </div>
            <div id="menu-wrapper" style="padding-top:5px;"
                class="fixed inset-0 z-30 invisible w-screen h-screen m-0 overflow-auto transition-opacity opacity-0 cursor-default bg-neutral-100/50 backdrop-blur-sm dark:bg-neutral-900/50">
                <ul
                    class="flex space-y-2 mt-3 flex-col items-end w-full px-6 py-6 mx-auto overflow-visible list-none ltr:text-right rtl:text-left max-w-7xl">

                    <li id="menu-close-button">
                        <span
                            class="cursor-pointer inline-block align-text-bottom hover:text-primary-600 dark:hover:text-primary-400">

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75 0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3L54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75 0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75 0-45.25s32.75-12.5 45.25 0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25 0s12.5 32.75 0 45.25l-105.4 105.4L310.6 361.4z"/></svg>

  </span>

</span>
                    </li>

                    

                    
  <li class="mt-1">
    <a href="/posts/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
        
        <p class="text-bg font-bg" title="">
            Posts
        </p>
    </a>
</li>




                    

                    
  <li class="mt-1">
    <a href="/about/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
        
        <p class="text-bg font-bg" title="">
            About
        </p>
    </a>
</li>




                    

                    
  <li class="mt-1">
    <a href="/categories/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
        
        <p class="text-bg font-bg" title="">
            Categories
        </p>
    </a>
</li>




                    

                    
  <li class="mt-1">
    <a href="/tags/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
        
        <p class="text-bg font-bg" title="">
            Tags
        </p>
    </a>
</li>




                    

                </ul>
                
                

            </div>
        </label>
    </div>
</div>




<script>
    (function () {
        var $mainmenu = $('.main-menu');
        var path = window.location.pathname;
        $mainmenu.find('a[href="' + path + '"]').each(function (i, e) {
            $(e).children('p').addClass('active');
        });
    })();
</script>


  </div>
</div>
<script>
  window.addEventListener('scroll', function (e) {
    var scroll = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop || 0;
    var background_blur = document.getElementById('menu-blur');
    background_blur.style.opacity = (scroll / 300);
  });
</script>

  
  <div class="relative flex flex-col grow">
    <main id="main-content" class="grow">
      


<article>
  
  
  
  
  
  


<div id="hero" class="h-[150px] md:h-[200px]"></div>



    
    <div class="fixed inset-x-0 top-0 h-[800px] single_hero_background nozoom"
    style="background-image:url(/2024/01/15/proxmox-with-opentofu-kubespray-and-kubernetes/feature-proxmox-logo-stacked-inverted-color.jpg);">
    


    <div class="absolute inset-0 bg-gradient-to-t from-neutral dark:from-neutral-800 to-transparent mix-blend-normal">
    </div>
    <div
        class="absolute inset-0 opacity-60 bg-gradient-to-t from-neutral dark:from-neutral-800 to-neutral-100 dark:to-neutral-800 mix-blend-normal">
    </div>
</div>

<div id="background-blur" class="fixed opacity-0 inset-x-0 top-0 h-full single_hero_background nozoom backdrop-blur-2xl"></div>
<script>
    window.addEventListener('scroll', function (e) {
        var scroll = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop || 0;
        var background_blur = document.getElementById('background-blur');
        background_blur.style.opacity = (scroll / 300)
    });
</script>

  
  

  <header id="single_header" class="mt-5 max-w-prose">
    
    <ol class="text-sm text-neutral-500 dark:text-neutral-400 print:hidden">
  
  
    
  
    
  
  <li class="inline hidden">
    <a
      class="hover:underline decoration-neutral-300 dark:underline-neutral-600"
      href="/"
      >blog.andreasm.io</a
    ><span class="px-1 text-primary-500">/</span>
  </li>

  
  <li class="inline ">
    <a
      class="hover:underline decoration-neutral-300 dark:underline-neutral-600"
      href="/posts/"
      >Posts</a
    ><span class="px-1 text-primary-500">/</span>
  </li>

  
  <li class="inline hidden">
    <a
      class="hover:underline decoration-neutral-300 dark:underline-neutral-600"
      href="/2024/01/15/proxmox-with-opentofu-kubespray-and-kubernetes/"
      >Proxmox with OpenTofu Kubespray and Kubernetes</a
    ><span class="px-1 text-primary-500">/</span>
  </li>

</ol>


    
    <h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">
      Proxmox with OpenTofu Kubespray and Kubernetes
    </h1>
    <div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden">
      





  
  







  





  



  













<div class="flex flex-row flex-wrap items-center">
  
  
  <time datetime="2024-01-15T14:15:19&#43;01:00">15 January 2024</time><span class="px-2 text-primary-500">&middot;</span><span>7897 words</span><span class="px-2 text-primary-500">&middot;</span><span title="Reading time">38 mins</span>
  

  
  
</div>


<div class="flex flex-row flex-wrap items-center">
  
  
  
  
  
  
  
  
  
  
  
</div>




<div class="flex flex-row flex-wrap items-center">
  
  
  
  
  
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/kubernetes/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Kubernetes
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/automation/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Automation
  </span>
</span>
  </span>
  
  
  
  
  
  
  
  
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/kubernetes/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Kubernetes
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/proxmox/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Proxmox
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/ansible/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Ansible
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/terraform/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Terraform
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/opentofu/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Opentofu
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/kubespray/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Kubespray
  </span>
</span>
  </span>
  
  
  
  
</div>




    </div>

    
    
    
    
    

    

    
      
      
        
        
<div class="flex author">
  
    
    
      
    
    
      
      <img class="!mt-0 !mb-0 h-24 w-24 rounded-full ltr:mr-4 rtl:ml-4" width="96" height="96"
      alt="Andreas Marqvardsen" src="/profile.png" />
    
  
  <div class="place-self-center">
    
    <div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">
      Author
    </div>
    <div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">
      Andreas Marqvardsen
    </div>
    
    
    <div class="text-sm text-neutral-700 dark:text-neutral-400">Always curious, always learning</div>
    
    <div class="text-2xl sm:text-lg">
  <div class="flex flex-wrap text-neutral-400 dark:text-neutral-500">
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="mailto:andreas.marqvardsen[AT]gmail.com"
          target="_blank"
          aria-label="Email"
          rel="me noopener noreferrer"
          ><span class="inline-block align-text-bottom">

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M207.8 20.73c-93.45 18.32-168.7 93.66-187 187.1c-27.64 140.9 68.65 266.2 199.1 285.1c19.01 2.888 36.17-12.26 36.17-31.49l.0001-.6631c0-15.74-11.44-28.88-26.84-31.24c-84.35-12.98-149.2-86.13-149.2-174.2c0-102.9 88.61-185.5 193.4-175.4c91.54 8.869 158.6 91.25 158.6 183.2l0 16.16c0 22.09-17.94 40.05-40 40.05s-40.01-17.96-40.01-40.05v-120.1c0-8.847-7.161-16.02-16.01-16.02l-31.98 .0036c-7.299 0-13.2 4.992-15.12 11.68c-24.85-12.15-54.24-16.38-86.06-5.106c-38.75 13.73-68.12 48.91-73.72 89.64c-9.483 69.01 43.81 128 110.9 128c26.44 0 50.43-9.544 69.59-24.88c24 31.3 65.23 48.69 109.4 37.49C465.2 369.3 496 324.1 495.1 277.2V256.3C495.1 107.1 361.2-9.332 207.8 20.73zM239.1 304.3c-26.47 0-48-21.56-48-48.05s21.53-48.05 48-48.05s48 21.56 48 48.05S266.5 304.3 239.1 304.3z"/></svg>

  </span>

</span></a
        >
      
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="https://blog.andreasm.io/"
          target="_blank"
          aria-label="Link"
          rel="me noopener noreferrer"
          ><span class="inline-block align-text-bottom">

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><path fill="currentColor" d="M172.5 131.1C228.1 75.51 320.5 75.51 376.1 131.1C426.1 181.1 433.5 260.8 392.4 318.3L391.3 319.9C381 334.2 361 337.6 346.7 327.3C332.3 317 328.9 297 339.2 282.7L340.3 281.1C363.2 249 359.6 205.1 331.7 177.2C300.3 145.8 249.2 145.8 217.7 177.2L105.5 289.5C73.99 320.1 73.99 372 105.5 403.5C133.3 431.4 177.3 435 209.3 412.1L210.9 410.1C225.3 400.7 245.3 404 255.5 418.4C265.8 432.8 262.5 452.8 248.1 463.1L246.5 464.2C188.1 505.3 110.2 498.7 60.21 448.8C3.741 392.3 3.741 300.7 60.21 244.3L172.5 131.1zM467.5 380C411 436.5 319.5 436.5 263 380C213 330 206.5 251.2 247.6 193.7L248.7 192.1C258.1 177.8 278.1 174.4 293.3 184.7C307.7 194.1 311.1 214.1 300.8 229.3L299.7 230.9C276.8 262.1 280.4 306.9 308.3 334.8C339.7 366.2 390.8 366.2 422.3 334.8L534.5 222.5C566 191 566 139.1 534.5 108.5C506.7 80.63 462.7 76.99 430.7 99.9L429.1 101C414.7 111.3 394.7 107.1 384.5 93.58C374.2 79.2 377.5 59.21 391.9 48.94L393.5 47.82C451 6.731 529.8 13.25 579.8 63.24C636.3 119.7 636.3 211.3 579.8 267.7L467.5 380z"/></svg>

  </span>

</span></a
        >
      
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="https://github.com/andreasm80"
          target="_blank"
          aria-label="Github"
          rel="me noopener noreferrer"
          ><span class="inline-block align-text-bottom">

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>

  </span>

</span></a
        >
      
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="https://linkedin.com/in/andreas-marqvardsen"
          target="_blank"
          aria-label="Linkedin"
          rel="me noopener noreferrer"
          ><span class="inline-block align-text-bottom">

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg>

  </span>

</span></a
        >
      
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="https://vmst.io/@andreasm"
          target="_blank"
          aria-label="Mastodon"
          rel="me noopener noreferrer"
          ><span class="inline-block align-text-bottom">

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48 0 0 0-63.72 28.5-63.72 125.7 0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54 0 0 1-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"/></svg>

  </span>

</span></a
        >
      
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="https://x.com/NATsoFast"
          target="_blank"
          aria-label="X-Twitter"
          rel="me noopener noreferrer"
          ><span class="inline-block align-text-bottom">

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8L200.7 275.5 26.8 48H172.4L272.9 180.9 389.2 48zM364.4 421.8h39.1L151.1 88h-42L364.4 421.8z"/></svg>
  </span>

</span></a
        >
      
    
  </div>

</div>
  </div>
</div>

      

      

      
      <div class="mb-5"></div>
      

    

  </header>
  
  <section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row">
    
     <div
      class="order-first lg:ml-auto px-0 lg:order-last ltr:lg:pl-8 rtl:lg:pr-8">
      <div class="toc ltr:pl-5 rtl:pr-5 print:hidden lg:sticky lg:top-[140px]">

         <details open id="TOCView"
  class="toc-right mt-0 overflow-y-scroll overscroll-contain scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600 rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 hidden lg:block">
  <summary
    class="block py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">
    Table of Contents
  </summary>
  <div
    class="min-w-[220px] py-2 border-dotted ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#my-lab">My lab</a></li>
    <li><a href="#provision-vms-in-proxmox-using-opentofu">Provision VMs in Proxmox using OpenTofu</a>
      <ul>
        <li><a href="#install-opentofu">Install OpenTofu</a></li>
        <li><a href="#opentofu-proxmox-provider">OpenTofu Proxmox provider</a></li>
        <li><a href="#prepare-proxmox-with-an-api-token-for-the-opentofu-bpgproxmox-provider">Prepare Proxmox with an API token for the OpenTofu bpg/proxmox provider</a></li>
        <li><a href="#opentofu-variables-and-credentials">OpenTofu variables and credentials</a></li>
      </ul>
    </li>
    <li><a href="#prepare-a-ubuntu-cloud-image---opentofu-resource">Prepare a Ubuntu cloud image - opentofu resource</a></li>
    <li><a href="#deploy-vms-using-opentofu-and-install-kubernetes-using-ansible-and-kubespray">Deploy VMs using OpenTofu and install Kubernetes using Ansible and Kubespray</a>
      <ul>
        <li><a href="#prepare-opentofu-to-deploy-my-vms">Prepare OpenTofu to deploy my VMs</a></li>
        <li><a href="#install-and-configure-kubespray">Install and configure Kubespray</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li><a href="#kubespray-vs-kopshttpskubesprayiodocscomparisonsidkubespray-vs-kops"><a href="https://kubespray.io/#/docs/comparisons?id=kubespray-vs-kops">Kubespray vs Kops</a></a></li>
    <li><a href="#kubespray-vs-kubeadmhttpskubesprayiodocscomparisonsidkubespray-vs-kubeadm"><a href="https://kubespray.io/#/docs/comparisons?id=kubespray-vs-kubeadm">Kubespray vs Kubeadm</a></a>
      <ul>
        <li><a href="#configure-opentofu-to-kick-off-kubespray">Configure OpenTofu to kick off Kubespray</a></li>
        <li><a href="#a-fully-automated-provisioning-of-kubernetes-on-proxmox-using-opentofu-ansible-and-kubespray">A fully automated provisioning of Kubernetes on Proxmox using OpenTofu, Ansible and Kubespray</a></li>
        <li><a href="#cleaning-up">Cleaning up</a></li>
      </ul>
    </li>
    <li><a href="#preparing-a-bunch-of-hosts-for-rancher-rke2-clusters">Preparing a bunch of hosts for Rancher RKE2 clusters</a>
      <ul>
        <li><a href="#proxmox-vm-resource">Proxmox VM resource</a></li>
        <li><a href="#proxmox-virtual-environment-file">Proxmox virtual environment file</a></li>
      </ul>
    </li>
    <li><a href="#summary">Summary</a></li>
  </ul>
</nav>
  </div>
</details>
<details class="toc-inside mt-0 overflow-hidden rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 lg:hidden">
  <summary
    class="py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">
    Table of Contents
  </summary>
  <div
    class="py-2 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#my-lab">My lab</a></li>
    <li><a href="#provision-vms-in-proxmox-using-opentofu">Provision VMs in Proxmox using OpenTofu</a>
      <ul>
        <li><a href="#install-opentofu">Install OpenTofu</a></li>
        <li><a href="#opentofu-proxmox-provider">OpenTofu Proxmox provider</a></li>
        <li><a href="#prepare-proxmox-with-an-api-token-for-the-opentofu-bpgproxmox-provider">Prepare Proxmox with an API token for the OpenTofu bpg/proxmox provider</a></li>
        <li><a href="#opentofu-variables-and-credentials">OpenTofu variables and credentials</a></li>
      </ul>
    </li>
    <li><a href="#prepare-a-ubuntu-cloud-image---opentofu-resource">Prepare a Ubuntu cloud image - opentofu resource</a></li>
    <li><a href="#deploy-vms-using-opentofu-and-install-kubernetes-using-ansible-and-kubespray">Deploy VMs using OpenTofu and install Kubernetes using Ansible and Kubespray</a>
      <ul>
        <li><a href="#prepare-opentofu-to-deploy-my-vms">Prepare OpenTofu to deploy my VMs</a></li>
        <li><a href="#install-and-configure-kubespray">Install and configure Kubespray</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li><a href="#kubespray-vs-kopshttpskubesprayiodocscomparisonsidkubespray-vs-kops"><a href="https://kubespray.io/#/docs/comparisons?id=kubespray-vs-kops">Kubespray vs Kops</a></a></li>
    <li><a href="#kubespray-vs-kubeadmhttpskubesprayiodocscomparisonsidkubespray-vs-kubeadm"><a href="https://kubespray.io/#/docs/comparisons?id=kubespray-vs-kubeadm">Kubespray vs Kubeadm</a></a>
      <ul>
        <li><a href="#configure-opentofu-to-kick-off-kubespray">Configure OpenTofu to kick off Kubespray</a></li>
        <li><a href="#a-fully-automated-provisioning-of-kubernetes-on-proxmox-using-opentofu-ansible-and-kubespray">A fully automated provisioning of Kubernetes on Proxmox using OpenTofu, Ansible and Kubespray</a></li>
        <li><a href="#cleaning-up">Cleaning up</a></li>
      </ul>
    </li>
    <li><a href="#preparing-a-bunch-of-hosts-for-rancher-rke2-clusters">Preparing a bunch of hosts for Rancher RKE2 clusters</a>
      <ul>
        <li><a href="#proxmox-vm-resource">Proxmox VM resource</a></li>
        <li><a href="#proxmox-virtual-environment-file">Proxmox virtual environment file</a></li>
      </ul>
    </li>
    <li><a href="#summary">Summary</a></li>
  </ul>
</nav>
  </div>
</details>

<script>

  var margin = 200;
  var marginError = 50;

  (function () {
    var $window = $(window);
    var $toc = $('#TOCView');
    var tocHeight = $toc.height();

    function onResize() {
      var windowAndMarginHeight = $window.height() - margin;
      if(tocHeight >= windowAndMarginHeight) {
        $toc.css("overflow-y", "scroll")
        $toc.css("max-height", (windowAndMarginHeight + marginError) + "px")
      } else {
        $toc.css("overflow-y", "hidden")
        $toc.css("max-height", "9999999px")
      }
    }

    $window.on('resize', onResize);
    $(document).ready(onResize);
  })();



  (function () {
    var $toc = $('#TableOfContents');
    if ($toc.length > 0) {
      var $window = $(window);

      function onScroll() {
        var currentScroll = $window.scrollTop();
        var h = $('.anchor');
        var id = "";
        h.each(function (i, e) {
          e = $(e);
          if (e.offset().top - $(window).height()/3 <= currentScroll) {
            id = decodeURIComponent(e.attr('id'));
          }
        });
        var active = $toc.find('a.active');      
        if (active.length == 1 && active.eq(0).attr('href') == '#' + id) return true;

        active.each(function (i, e) {
          
            $(e).removeClass('active');
          
        });
        $toc.find('a[href="#' + id + '"]').addClass('active')
        $toc.find('a[href="#' + id + '"]').parentsUntil('#TableOfContents').each(function (i, e) {
          $(e).children('a').parents('ul').show();          
        });
      }

      $window.on('scroll', onScroll);
      $(document).ready(function () {
        
        onScroll();
      });
    }
  })();


</script>
   </div>
      </div>
      

      <div class="min-w-0 min-h-0 max-w-fit">
        
        


        <div class="article-content max-w-prose mb-20">
          

<h1 class="relative group">I need a Kubernetes cluster, again 
    <div id="i-need-a-kubernetes-cluster-again" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#i-need-a-kubernetes-cluster-again" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<p>I am using a lot of my spare time playing around with my lab exploring different topics. Very much of that time again is spent with Kubernetes. It has been so many times have I deployed a new Kubernetes cluster, then after some time decommissioned it again. They way I have typically done it is using a Ubuntu template I have created, cloned it, manually adjusted all clones as needed, then manually installed Kubernetes. This takes a lot of time overall and it also stops me doing certain tasks as sometimes I just think nah.. not again. Maybe another day and I do something else instead. And, when a human being is set to do a repetive task it is destined to fail at some stage, forgot a setting, why is this one vm not working as the other vms and so on.  Now the time has come to automate these tasks with the following goal in mind:</p>
<ul>
<li>Reduce deployment time to a minum</li>
<li>Eliminate human errors</li>
<li>Consistent outcome every time</li>
<li>Make it even more fun to deploy a Kubernetes cluster</li>
</ul>
<p>I have been running Home Assistant for many years, there I have a bunch of automations automating all kinds of things in my home which just makes my everyday life a bit happier. Most of these automations just work in the background doing their stuff as a good automation should. Automating my lab deployments is something I have been thinking of getting into several times, and now I decided to get this show started. So, as usual, a lot of tinkering, trial and error until I managed to get something working the way I wanted. Probably room for improvement in several areas, that is something I will most likely use my time on &ldquo;post&rdquo; this blog post. Speaking of blog post, after using some time on this I had to create a blog post on it. My goal later on is a fully automated lab from VM creation, Kubernetes runtime, and applications. And when they are decommisioned I can easily spin up everything again with persistent data etc. Lets see.</p>
<p>For now, this post will cover what I have done and configured so far to be able to automatically deploy the VMs for my Kubernetes clusters then the provisioning of Kubernetes itself.</p>


<h2 class="relative group">My lab 
    <div id="my-lab" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#my-lab" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>My lab consists of two fairly spec&rsquo;ed servers with a bunch of CPU cores, a lot of RAM, and a decent amount of SSDs. In regards to network they are using 10GB ethernet. In terms of power usage they are kind of friendly to my electricity bill with my &ldquo;required&rdquo; vms running on them, but can potentially ruin that if I throw a lot of stuff at them to chew on.</p>
<img src=images/image-20240115152236095.png style="width:400px" />
<p><em>The total power usage above includes my switch, UPS and some other small devices. So its not that bad considering how much I can get out of it.</em></p>
<p>But with automation I can easily spin up some resources to be consumed for a certain period and delete again if not needed. My required VMs, that are always on, are things like Bind dns servers, PfSense, Truenas, Frigate, DCS server, a couple of linux &ldquo;mgmt&rdquo; vms,  Home Assistant, a couple of Kubernetes clusters hosting my Unifi controller, Traefik Proxy, Grafana etc.</p>
<p>For the virtualization layer on my two servers I am using Proxmox, one of the reason is that it supports PCI passthrough of my Coral TPU. I have been running Proxmox for many years and I find it to be a very decent alternative. It does what I want it to do and Proxmox has a great community!</p>
<p>Proxmox has been configured with these two servers as a cluster. I have not configured any VMs in HA, but with a Proxmox cluster I can easily migrate VMs between the hosts, even without shared storage, and single web-ui to manage both servers. To be &ldquo;quorate&rdquo; I have a cute little RPi3 with its beefy 32 GB SD card, 2GB RAM and 1GB ethernet as a <a href="https://pve.proxmox.com/wiki/Cluster_Manager#_corosync_external_vote_support" target="_blank">Qdevice</a></p>
<div class="notice info">
<p>On that note, one does not necessarily need have them in a cluster to do vm migration. I recently moved a bunch of VMs over two these two new servers and it was easy peasy using this command:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># executed on the source Proxmox node</span>
</span></span><span class="line"><span class="cl">qm remote-migrate &lt;src vm_id&gt; &lt;dst vm_id&gt; <span class="s1">&#39;apitoken=PVEAPIToken=root@pam!migrate=&lt;token&gt;,host=&lt;dst-host-ip&gt;,fingerprint=&lt;thumprint&gt;&#39;</span> --target-bridge vmbr0 --target-storage <span class="s1">&#39;raid10-node01&#39;</span> --online
</span></span></code></pre></div><p>I found this with the great help of the Proxmox community <a href="https://forum.proxmox.com/threads/framework-for-remote-migration-to-cluster-external-proxmox-ve-hosts.118444/page-2" target="_blank">here</a></p>
</div>
<p>Both Proxmox servers have their own local ZFS storage. In both of them I have created a dedicated zfs pool with identical name which I use for zfs replication for some of the more &ldquo;critical&rdquo; VMs, and  as a bonus it also reduces the migration time drastically for these VMs when I move them between my servers. The &ldquo;cluster&rdquo; network (vmbr1) is directly connected 2x 10GB ethernet (not through my physical switch). The other 2x 10GB interfaces are connected to my switch for all my other network needs like VM network (vmbr0) and Proxmox management.</p>
<p>Throughout this post I will be using a dedicated linux vm for all my commands, interactions. So every time I install something, it is on this linux vm.</p>
<p>But I am digressing, enough of the intro, get on with the automation part you were supposed to write about. Got it.</p>
<p>In this post I will use the following products:</p>
<ul>
<li>Proxmox - <a href="https://www.proxmox.com/en/" target="_blank">homepage</a></li>
<li>Ubuntu - <a href="https://ubuntu.com/" target="_blank">homepage</a></li>
<li>OpenTofu - <a href="https://opentofu.org/" target="_blank">homepage</a></li>
<li>bpg/proxmox terraform provider - <a href="https://registry.terraform.io/providers/bpg/proxmox/latest" target="_blank">registry</a> and <a href="https://github.com/bpg/terraform-provider-proxmox" target="_blank">github</a></li>
<li>Ansible - <a href="https://www.ansible.com/community" target="_blank">homepage</a></li>
<li>Kubespray - <a href="https://kubespray.io/#/" target="_blank">homepage</a> and <a href="https://github.com/kubernetes-sigs/kubespray/tree/master" target="_blank">github</a></li>
</ul>


<h2 class="relative group">Provision VMs in Proxmox using OpenTofu 
    <div id="provision-vms-in-proxmox-using-opentofu" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#provision-vms-in-proxmox-using-opentofu" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>Terraform is something I have been involved in many times in my professional work, but never had the chance to actually use it myself other than know about it, and how the solutions I work with can work together with Terraform. I did notice even the Proxmox community had several post around using Terraform, so I decided to just go with Terraform. I already knew that HashiCorp had <a href="https://www.hashicorp.com/license-faq" target="_blank">announced</a> their change of Terraform license from MPL to BSL and that <a href="https://opentofu.org/" target="_blank">OpenTofu</a> is an OpenSource fork of Terraform. So instead of basing my automations using Terraform, I will be using OpenTofu. Read more about OpenTofu <a href="https://opentofu.org/" target="_blank">here</a>. For now OpenTofu is Terraform &ldquo;compatible&rdquo; and uses Terraform registries, so providers etc for Terraform works with OpenTofu. You will notice that further down, all my configs will be using terraform constructs.</p>
<p>In OpenTofu/Terraform there are several concepts that one needs to know about, I will use some of them in this post like <em>providers</em>, <em>resources</em>, <em>provisioners</em> and <em>variables</em>. It is smart to read about them a bit more <a href="https://opentofu.org/docs/cli/commands/" target="_blank">here</a> how and why to use them.</p>
<p>To get started with OpenTofu there are some preparations do be done. Lets start with these</p>


<h3 class="relative group">Install OpenTofu 
    <div id="install-opentofu" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#install-opentofu" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>To get started with OpenTofu I deployed it on my linux machine using Snap, but several other alternatives is available. See more on the official OpenTofu <a href="https://opentofu.org/docs/intro/install/snap" target="_blank">docs</a> page.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo snap install --classic opentofu
</span></span></code></pre></div><p>Now OpenTofu is installed and I can start using it. I also installed the bash autocompletion like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">tofu -install-autocomplete <span class="c1"># restart shell session...</span>
</span></span></code></pre></div><p>I decided to create a dedicated folder for my &ldquo;projects&rdquo; to live in so I have created a folder in my  home folder called *proxmox&quot; where I have different subfolders depending on certain tasks or resources I will use OpenTofu for.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">proxmox/
</span></span><span class="line"><span class="cl"> k8s-cluster-02
</span></span><span class="line"><span class="cl"> proxmox-images
</span></span></code></pre></div>

<h3 class="relative group">OpenTofu Proxmox provider 
    <div id="opentofu-proxmox-provider" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#opentofu-proxmox-provider" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>To be able to use OpenTofu with Proxmox I need a provider that can use the Proxmox API. I did some quick research on the different options out there and landed on this provider: <a href="https://registry.terraform.io/providers/bpg/proxmox" target="_blank">bpg/proxmox</a>. Seems very active and are recently updated (according to the git repo <a href="https://github.com/bpg/terraform-provider-proxmox" target="_blank">here</a>)</p>
<p>An OpenTofu/Terraform provider is being defined like this, and the example below is configured to install the bpg/proxmox provider I need to interact with Proxmox.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="l">terraform {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">required_providers {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">proxmox = {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="l">source = &#34;bpg/proxmox&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="l">version = &#34;0.43.2&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">provider &#34;proxmox&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">endpoint  = var.proxmox_api_endpoint</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">api_token = var.proxmox_api_token</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">insecure  = true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">ssh {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">agent    = true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">username = &#34;root&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span></code></pre></div><p>I will save this content in a filed called <em>providers.tf</em></p>
<p>First a short explanation of the two sections above. The <em>terraform</em> sections instructs OpenTofu/Terraform which provider to be downloaded and enabled. The <em>version</em> field defines a specific version to use, not the <em>latest</em> but this version. Using this field will make sure that your automation will not break if there is an update in the provider version that introduces some API changes.</p>
<p>The <em>provider</em> section configures the proxmox provider how it should interact with Proxmox. Instead of using a regular username and password I have opted for using API token. Here I in the endpoint and api-token keys am using a variable value that are defined in another file called variables.tf and a credentials.auto.tfvars. There are also certain tasks in my automation that requires SSH interaction with Proxmox so I have also enabled that by configuring the <em>ssh</em> field.</p>
<p>For more information on the bpg/proxmox provider, head over <a href="https://registry.terraform.io/providers/bpg/proxmox/latest/docs" target="_blank">here</a></p>


<h3 class="relative group">Prepare Proxmox with an API token for the OpenTofu bpg/proxmox provider 
    <div id="prepare-proxmox-with-an-api-token-for-the-opentofu-bpgproxmox-provider" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#prepare-proxmox-with-an-api-token-for-the-opentofu-bpgproxmox-provider" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>To be able to use the above configured provider with Proxmox I need to prepare Proxmox to use API token.
I followed the bpg/proxmox provider documentation <a href="https://registry.terraform.io/providers/bpg/proxmox/latest/docs#api-token-authentication" target="_blank">here</a></p>
<p>On my &ldquo;leader&rdquo; Proxmox node:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># Create the user</span>
</span></span><span class="line"><span class="cl">sudo pveum user add terraform@pve
</span></span><span class="line"><span class="cl"><span class="c1"># Create a role for the user above</span>
</span></span><span class="line"><span class="cl">sudo pveum role add Terraform -privs <span class="s2">&#34;Datastore.Allocate Datastore.AllocateSpace Datastore.AllocateTemplate Datastore.Audit Pool.Allocate Sys.Audit Sys.Console Sys.Modify SDN.Use VM.Allocate VM.Audit VM.Clone VM.Config.CDROM VM.Config.Cloudinit VM.Config.CPU VM.Config.Disk VM.Config.HWType VM.Config.Memory VM.Config.Network VM.Config.Options VM.Migrate VM.Monitor VM.PowerMgmt User.Modify&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Assign the terraform user to the above role</span>
</span></span><span class="line"><span class="cl">sudo pveum aclmod / -user terraform@pve -role Terraform
</span></span><span class="line"><span class="cl"><span class="c1"># Create the token</span>
</span></span><span class="line"><span class="cl">sudo pveum user token add terraform@pve provider --privsep<span class="o">=</span><span class="m">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> key           value                                
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> full-tokenid  terraform@pve!provider               
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> info          <span class="o">{</span><span class="s2">&#34;privsep&#34;</span>:<span class="s2">&#34;0&#34;</span><span class="o">}</span>                      
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> value         &lt;token&gt;                               
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># make a backup of the token</span>
</span></span><span class="line"><span class="cl">    
</span></span></code></pre></div><p>Now I have create the API user to be used with my bpg/proxmox provider. Though it is not sufficient as I also need to define a ssh keypair on my Linux jumphost for passwordless SSH authentication which I will need to copy to my Proxmox nodes. This is done like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@linuxmgmt01:~$ ssh-copy-id -i id_rsa.pub root@172.18.5.102 <span class="c1"># -i pointing to the pub key I want to use and specify the root user</span>
</span></span></code></pre></div><p>Now, I can log into my Proxmox node using SSH without password from my Linux jumphost. But, when used in combination with opentofu its not sufficient. I need to load the key into the keystore. If I dont do that the automations that require SSH access will fail with this error message:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">Error: failed to open SSH client: unable to authenticate user <span class="s2">&#34;root&#34;</span> over SSH to <span class="s2">&#34;172.18.5.102:22&#34;</span>. Please verify that ssh-agent is correctly loaded with an authorized key via <span class="s1">&#39;ssh-add -L&#39;</span> <span class="o">(</span>NOTE: configurations in ~/.ssh/config are not considered by golang<span class="err">&#39;</span>s ssh implementation<span class="o">)</span>. The exact error from ssh.Dial: ssh: handshake failed: ssh: unable to authenticate, attempted methods <span class="o">[</span>none password<span class="o">]</span>, no supported methods remain
</span></span></code></pre></div><p>Ah, I can just configure the .ssh/config with this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">Host 172.18.5.102
</span></span><span class="line"><span class="cl">    AddKeysToAgent yes
</span></span><span class="line"><span class="cl">    IdentityFile ~/.ssh/id_rsa
</span></span></code></pre></div><p>Nope, cant do.. Look at the error message again:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">(</span>NOTE: configurations in ~/.ssh/config are not considered by golang<span class="err">&#39;</span>s ssh implementation<span class="o">)</span>
</span></span></code></pre></div><p>Ah, I can just do this then:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@linuxmgmt01:~$ <span class="nb">eval</span> <span class="sb">`</span>ssh-agent -s<span class="sb">`</span>
</span></span><span class="line"><span class="cl">andreasm@linuxmgmt01:~$ ssh-add id_rsa
</span></span></code></pre></div><p>Yes, but that is not persistent between sessions, so you need to do this every time you log on to your Linux jumphost again. I couldnt figure out how to do this the &ldquo;correct&rdquo; way by following the expected Golang approach so instead I went with this approach.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># I added this in my .bashrc file</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[</span> -z <span class="s2">&#34;</span><span class="nv">$SSH_AUTH_SOCK</span><span class="s2">&#34;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl"> <span class="nb">eval</span> <span class="sb">`</span>ssh-agent -s<span class="sb">`</span>
</span></span><span class="line"><span class="cl"> ssh-add ~/.ssh/id_rsa
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span></code></pre></div>

<h3 class="relative group">OpenTofu variables and credentials 
    <div id="opentofu-variables-and-credentials" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#opentofu-variables-and-credentials" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>Instead of exposing username/tokens and other information directly in my provider/resource *.tf&rsquo;s I can refer to them by declaring them in a <em>variables.tf</em> and credentials in a <em>credentials.auto.tfvars</em>. The <em>variables.tf</em> defines the variables to use, and the credentials.auto.tfvars maps the value to a variable. I am using this content in my variable.tf</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="l">variable &#34;proxmox_api_endpoint&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">type = string</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">description = &#34;Proxmox cluster API endpoint https://proxmox-01.my-domain.net:8006&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">variable &#34;proxmox_api_token&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">type = string</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">description = &#34;Proxmox API token bpg proxmox provider with ID and token&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span></code></pre></div><p>Then in my credentials.auto.tfvars file I have this content:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nv">proxmox_api_endpoint</span> <span class="o">=</span> <span class="s2">&#34;https://proxmox-01.mu-domain.net:8006&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">proxmox_api_token</span> <span class="o">=</span> <span class="s2">&#34;terraform@pve!provider=&lt;token-from-earlier&gt;&#34;</span>
</span></span></code></pre></div><p>To read more about these files head over <a href="https://developer.hashicorp.com/terraform/language/values/variables" target="_blank">here</a>. One can also use the varible.tf to generate prompts if I have created variables being referred to in any of my resources but do not map to a value (credentials.tfvars etc..). Then it will ask you to enter a value when doing a plan or apply.</p>


<h2 class="relative group">Prepare a Ubuntu cloud image - opentofu resource 
    <div id="prepare-a-ubuntu-cloud-image---opentofu-resource" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#prepare-a-ubuntu-cloud-image---opentofu-resource" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>In my automations with OpenTofu I will use a cloud image instead of a VM template in Proxmox.</p>
<p>I have been using Ubuntu as my preferred Linux distribution for many years and dont see any reason to change that now. Ubuntu/Canonical do provide cloud images and they can be found <a href="https://cloud-images.ubuntu.com/" target="_blank">here</a></p>
<p>But I will not download them using my browser, instead I will be using OpenTofu with the bpg/proxmox provider to download and upload them to my Proxmox nodes.</p>
<p>In my proxmox folder I have a dedicated folder for this project called <em>proxmox-images</em></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">proxmox/
</span></span><span class="line"><span class="cl"> proxmox-images
</span></span></code></pre></div><p>Inside that folder I will start by creating the following files: provider.tf file, variable.tf and credentials.auto.tfvars with the content described above.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">proxmox-images/
</span></span><span class="line"><span class="cl"> credentials.auto.tfvars
</span></span><span class="line"><span class="cl"> provider.tf
</span></span><span class="line"><span class="cl"> variables.tf
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">0</span> directories, <span class="m">3</span> files
</span></span></code></pre></div><p>But these files dont to anything other than provides the relevant information to connect and interact with Proxmox. What I need is a OpenTofu resource with a task that needs to be done. So I will prepare a file called ubuntu_cloud_image.tf with the following content:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="l">resource &#34;proxmox_virtual_environment_file&#34; &#34;ubuntu_cloud_image&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">content_type = &#34;iso&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">datastore_id = &#34;local&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">node_name    = &#34;proxmox-02&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">source_file {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># you may download this image locally on your workstation and then use the local path instead of the remote URL</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">path      = &#34;https://cloud-images.ubuntu.com/jammy/current/jammy-server-cloudimg-amd64.img&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># you may also use the SHA256 checksum of the image to verify its integrity</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">checksum = &#34;1d82c1db56e7e55e75344f1ff875b51706efe171ff55299542c29abba3a20823&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span></code></pre></div><p>What this file does is instructing OpenTofu where to grab my Ubuntu cloud image from, then upload it to my Proxmox node 2 and a specific datastore on that node. So I have defined a <em>resource</em> to define this task. More info on this <a href="https://github.com/bpg/terraform-provider-proxmox/tree/main/howtos/cloud-image" target="_blank">here</a>.</p>
<p>Within this same .tf file I can define several resources to download several cloud images. I could have called the file cloud-images.tf instead and just defined all the images I wanted to download/upload to Proxmox.
I have decided to keep this task as a separate project/folder.</p>
<p>When I save this file I will now have 4 files in my <em>proxmox-image</em> folder:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">proxmox-images/
</span></span><span class="line"><span class="cl"> credentials.auto.tfvars
</span></span><span class="line"><span class="cl"> provider.tf
</span></span><span class="line"><span class="cl"> ubuntu_cloud_image.tf
</span></span><span class="line"><span class="cl"> variables.tf
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">0</span> directories, <span class="m">4</span> files
</span></span></code></pre></div><p>Thats all the files I need to start my first OpenTofu task/automation.</p>
<p>Lets do a quick recap. The provider.tf instructs OpenTofu to download and enable the bpg/proxmox provider in this folder, and configure the provider to interact with my Proxmox nodes.</p>
<p>Then it is the variables.tf and the credentials.auto.tfvars that provides keys and values to be used in the provider.tf.
The ubuntu_cloud_image.tf contains the task I want OpenTofu to perform.</p>
<p>So now I am ready to execute the first OpenTofu command <em>tofu init</em>.
This command initiates OpenTofu in the respective folder <em>proxmox-images</em>, downloads and enables the provider I have configured. More info <a href="https://opentofu.org/docs/cli/commands/init" target="_blank">here</a>.</p>
<p>So lets try it:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@linuxmgmt01:~/terraform/proxmox/proxmox-images$ tofu init
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Initializing the backend...
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Initializing provider plugins...
</span></span><span class="line"><span class="cl">- Finding bpg/proxmox versions matching <span class="s2">&#34;0.43.2&#34;</span>...
</span></span><span class="line"><span class="cl">- Installing bpg/proxmox v0.43.2...
</span></span><span class="line"><span class="cl">- Installed bpg/proxmox v0.43.2 <span class="o">(</span>signed, key ID DAA1958557A27403<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Providers are signed by their developers.
</span></span><span class="line"><span class="cl">If you<span class="err">&#39;</span>d like to know more about provider signing, you can <span class="nb">read</span> about it here:
</span></span><span class="line"><span class="cl">https://opentofu.org/docs/cli/plugins/signing/
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">OpenTofu has created a lock file .terraform.lock.hcl to record the provider
</span></span><span class="line"><span class="cl">selections it made above. Include this file in your version control repository
</span></span><span class="line"><span class="cl">so that OpenTofu can guarantee to make the same selections by default when
</span></span><span class="line"><span class="cl">you run <span class="s2">&#34;tofu init&#34;</span> in the future.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">OpenTofu has been successfully initialized!
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">You may now begin working with OpenTofu. Try running <span class="s2">&#34;tofu plan&#34;</span> to see
</span></span><span class="line"><span class="cl">any changes that are required <span class="k">for</span> your infrastructure. All OpenTofu commands
</span></span><span class="line"><span class="cl">should now work.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">If you ever <span class="nb">set</span> or change modules or backend configuration <span class="k">for</span> OpenTofu,
</span></span><span class="line"><span class="cl">rerun this <span class="nb">command</span> to reinitialize your working directory. If you forget, other
</span></span><span class="line"><span class="cl">commands will detect it and remind you to <span class="k">do</span> so <span class="k">if</span> necessary.
</span></span></code></pre></div><p>Cool, now I have initialized my proxmox-image folder. Lets continue with creating a plan.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@linuxmgmt01:~/terraform/proxmox/proxmox-images$ tofu plan -out plan
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">OpenTofu used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols:
</span></span><span class="line"><span class="cl">  + create
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">OpenTofu will perform the following actions:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1"># proxmox_virtual_environment_file.ubuntu_cloud_image will be created</span>
</span></span><span class="line"><span class="cl">  + resource <span class="s2">&#34;proxmox_virtual_environment_file&#34;</span> <span class="s2">&#34;ubuntu_cloud_image&#34;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      + <span class="nv">content_type</span>           <span class="o">=</span> <span class="s2">&#34;iso&#34;</span>
</span></span><span class="line"><span class="cl">      + <span class="nv">datastore_id</span>           <span class="o">=</span> <span class="s2">&#34;local&#34;</span>
</span></span><span class="line"><span class="cl">      + <span class="nv">file_modification_date</span> <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span></span><span class="line"><span class="cl">      + <span class="nv">file_name</span>              <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span></span><span class="line"><span class="cl">      + <span class="nv">file_size</span>              <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span></span><span class="line"><span class="cl">      + <span class="nv">file_tag</span>               <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span></span><span class="line"><span class="cl">      + <span class="nv">id</span>                     <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span></span><span class="line"><span class="cl">      + <span class="nv">node_name</span>              <span class="o">=</span> <span class="s2">&#34;proxmox-02&#34;</span>
</span></span><span class="line"><span class="cl">      + <span class="nv">overwrite</span>              <span class="o">=</span> <span class="nb">true</span>
</span></span><span class="line"><span class="cl">      + <span class="nv">timeout_upload</span>         <span class="o">=</span> <span class="m">1800</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      + source_file <span class="o">{</span>
</span></span><span class="line"><span class="cl">          + <span class="nv">changed</span>  <span class="o">=</span> <span class="nb">false</span>
</span></span><span class="line"><span class="cl">          + <span class="nv">checksum</span> <span class="o">=</span> <span class="s2">&#34;1d82c1db56e7e55e75344f1ff875b51706efe171ff55299542c29abba3a20823&#34;</span>
</span></span><span class="line"><span class="cl">          + <span class="nv">insecure</span> <span class="o">=</span> <span class="nb">false</span>
</span></span><span class="line"><span class="cl">          + <span class="nv">path</span>     <span class="o">=</span> <span class="s2">&#34;https://cloud-images.ubuntu.com/jammy/current/jammy-server-cloudimg-amd64.img&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Plan: <span class="m">1</span> to add, <span class="m">0</span> to change, <span class="m">0</span> to destroy.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Saved the plan to: plan
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">To perform exactly these actions, run the following <span class="nb">command</span> to apply:
</span></span><span class="line"><span class="cl">    tofu apply <span class="s2">&#34;plan&#34;</span>
</span></span></code></pre></div><p>I am using the -out plan to just keep a record of the plan. It could be called whatever I wanted. Now OpenTofu tells me what its intention are, and if I am happy with the plan, I just need to apply it.</p>
<p>So lets apply it:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@linuxmgmt01:~/terraform/proxmox/proxmox-images$ tofu apply plan
</span></span><span class="line"><span class="cl">proxmox_virtual_environment_file.ubuntu_cloud_image: Creating...
</span></span><span class="line"><span class="cl">proxmox_virtual_environment_file.ubuntu_cloud_image: Still creating... <span class="o">[</span>10s elapsed<span class="o">]</span>
</span></span><span class="line"><span class="cl">proxmox_virtual_environment_file.ubuntu_cloud_image: Creation <span class="nb">complete</span> after 20s <span class="o">[</span><span class="nv">id</span><span class="o">=</span>local:iso/jammy-server-cloudimg-amd64.img<span class="o">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Apply complete! Resources: <span class="m">1</span> added, <span class="m">0</span> changed, <span class="m">0</span> destroyed.
</span></span></code></pre></div><p>And after 20 seconds I have my Ubuntu cloud image uploaded to my Proxmox node (<em>jammy-server-cloudimg-amd64.img</em>):</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2024/01/15/proxmox-with-opentofu-kubespray-and-kubernetes/images/image-20240115202924543.png"
        alt="jammy-server-cloud-image"
      />
      
    </figure>
</p>
<p>Thats great. Now I have my iso image to use for my VM deployments.</p>
<p>Next up is to deploy a bunch of VMs to be used for a Kubernetes cluster</p>


<h2 class="relative group">Deploy VMs using OpenTofu and install Kubernetes using Ansible and Kubespray 
    <div id="deploy-vms-using-opentofu-and-install-kubernetes-using-ansible-and-kubespray" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#deploy-vms-using-opentofu-and-install-kubernetes-using-ansible-and-kubespray" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>In this section I will automate everything from deploying VMs to install Kubernetes on these VMs. This task will involve OpenTofu, Ansible and Kubespray. It will deploy 6 virtual machines, with two different resource configurations. It will deploy 3 vms intended to be used as Kubernetes controlplane nodes, and 3 vms intended to be Kubernetes worker nodes. Thats the task for OpenTofu, as soon as OpenTofu has done its part it will trigger an Ansible playbook to initiate Kubespray to install Kubernetes on all my nodes. This should then end up in a fully automated task from me just executing <em>tofu apply plan</em> to a ready Kubernetes cluster.</p>
<p>I will start by creating another subfolder in my <em>proxmox</em> folder called <em>k8s-cluster-02</em>. In this folder I will reuse the following files:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">k8s-cluster-02/
</span></span><span class="line"><span class="cl"> credentials.auto.tfvars
</span></span><span class="line"><span class="cl"> provider.tf
</span></span><span class="line"><span class="cl"> variables.tf
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">0</span> directories, <span class="m">3</span> files
</span></span></code></pre></div><p>These files I will just copy from my <em>proxmox-images</em> folder. I will also need define and add a couple of other files. When I am ready with this task I will end up with these files:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">k8s-cluster-02/
</span></span><span class="line"><span class="cl"> ansible.tf
</span></span><span class="line"><span class="cl"> credentials.auto.tfvars
</span></span><span class="line"><span class="cl"> k8s-cluster-02.tf
</span></span><span class="line"><span class="cl"> provider.tf
</span></span><span class="line"><span class="cl"> ubuntu_cloud_config.tf
</span></span><span class="line"><span class="cl"> variables.tf
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">0</span> directories, <span class="m">7</span> files
</span></span></code></pre></div><p>I will go through all the files one by one. But there is still some preparations to be done to be able to complete this whole task.</p>


<h3 class="relative group">Prepare OpenTofu to deploy my VMs 
    <div id="prepare-opentofu-to-deploy-my-vms" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#prepare-opentofu-to-deploy-my-vms" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>In addition to the three common files I have copied from the previous project, I will need to create two <em>proxmox_virtual_environment_vm</em> resource definitions (one for each VM type). The content of this file will be saved as <em>k8s-cluster-02.tf</em> and looks like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="l">resource &#34;proxmox_virtual_environment_vm&#34; &#34;k8s-cp-vms-cl02&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">count       = 3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">name        = &#34;k8s-cp-vm-${count.index + 1}-cl-02&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">description = &#34;Managed by Terraform&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">tags        = [&#34;terraform&#34;, &#34;ubuntu&#34;, &#34;k8s-cp&#34;]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">node_name = &#34;proxmox-02&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">vm_id     = &#34;100${count.index + 1}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">cpu {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">cores = 2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">type = &#34;host&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">memory {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">dedicated = 2048</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">agent {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># read &#39;Qemu guest agent&#39; section, change to true only when ready</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">enabled = true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">startup {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">order      = &#34;3&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">up_delay   = &#34;60&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">down_delay = &#34;60&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">disk {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">datastore_id = &#34;raid-10-node02&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">file_id      = &#34;local:iso/jammy-server-cloudimg-amd64.img&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">interface    = &#34;virtio0&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">iothread     = true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">discard      = &#34;on&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">size         = 40</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">file_format  = &#34;raw&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">initialization {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">dns {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="l">servers = [&#34;10.100.1.7&#34;, &#34;10.100.1.6&#34;]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="l">domain = &#34;my-domain.net&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">ip_config {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="l">ipv4 {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="l">address = &#34;10.160.1.2${count.index + 1}/24&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="l">gateway = &#34;10.160.1.1&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">datastore_id = &#34;raid-10-node02&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">user_data_file_id = proxmox_virtual_environment_file.ubuntu_cloud_init.id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">network_device {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">bridge = &#34;vmbr0&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">vlan_id = &#34;216&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">operating_system {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">type = &#34;l26&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">keyboard_layout = &#34;no&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">lifecycle {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">ignore_changes = [</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="l">network_device,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">resource &#34;proxmox_virtual_environment_vm&#34; &#34;k8s-worker-vms-cl02&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">count       = 3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">name        = &#34;k8s-node-vm-${count.index + 1}-cl-02&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">description = &#34;Managed by Terraform&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">tags        = [&#34;terraform&#34;, &#34;ubuntu&#34;, &#34;k8s-node&#34;]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">node_name = &#34;proxmox-02&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">vm_id     = &#34;100${count.index + 5}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">cpu {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">cores = 4</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">type = &#34;host&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">memory {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">dedicated = 4096</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">agent {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># read &#39;Qemu guest agent&#39; section, change to true only when ready</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">enabled = true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">startup {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">order      = &#34;3&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">up_delay   = &#34;60&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">down_delay = &#34;60&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">disk {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">datastore_id = &#34;raid-10-node02&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">file_id      = &#34;local:iso/jammy-server-cloudimg-amd64.img&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">interface    = &#34;virtio0&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">iothread     = true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">discard      = &#34;on&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">size         = 60</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">file_format  = &#34;raw&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">initialization {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">dns {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="l">servers = [&#34;10.100.1.7&#34;, &#34;10.100.1.6&#34;]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="l">domain = &#34;my-domain.net&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">ip_config {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="l">ipv4 {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="l">address = &#34;10.160.1.2${count.index + 5}/24&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="l">gateway = &#34;10.160.1.1&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">datastore_id = &#34;raid-10-node02&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">user_data_file_id = proxmox_virtual_environment_file.ubuntu_cloud_init.id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">network_device {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">bridge = &#34;vmbr0&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">vlan_id = &#34;216&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">operating_system {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">type = &#34;l26&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">keyboard_layout = &#34;no&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">lifecycle {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">ignore_changes = [</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="l">network_device,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span></code></pre></div><p>In this file I have define two <em>proxmox_virtual_environment_vm</em> resources called <em>k8s-cp-vms-cl02</em> and <em>k8s-worker-vms-cl02</em> respectively.
I am using count.index in some of the fields where I need to automatically generate an increasing number. Like IP address, VM_ID, Name. It is also referring to my Ubuntu cloud image as installation source, then a <em>user_data_file_id</em> (will be shown next) to do a simple cloud-init on the VMs.</p>
<p>Then I need to configure a <em>proxmox_virtual_environment_file</em> resource called <em>ubuntu_cloud_init</em> to trigger a cloud-init task to configure some basic initial config on my VMs.</p>
<p>This is the content of this file:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="l">resource &#34;proxmox_virtual_environment_file&#34; &#34;ubuntu_cloud_init&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">content_type = &#34;snippets&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">datastore_id = &#34;local&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">node_name    = &#34;proxmox-02&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">source_raw {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">data = &lt;&lt;EOF</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#cloud-config</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">chpasswd</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">list</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">    ubuntu:ubuntu</span><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">expire</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">packages</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">qemu-guest-agent</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">timezone</span><span class="p">:</span><span class="w"> </span><span class="l">Europe/Oslo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">users</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">ubuntu</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">groups</span><span class="p">:</span><span class="w"> </span><span class="l">sudo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">shell</span><span class="p">:</span><span class="w"> </span><span class="l">/bin/bash</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ssh-authorized-keys</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">${trimspace(&#34;ssh-rsa &lt;sha356&gt; user@mail.com&#34;)}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">sudo</span><span class="p">:</span><span class="w"> </span><span class="l">ALL=(ALL) NOPASSWD:ALL</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">power_state</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">delay</span><span class="p">:</span><span class="w"> </span><span class="l">now</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l">reboot</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">message</span><span class="p">:</span><span class="w"> </span><span class="l">Rebooting after cloud-init completion</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">condition</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">EOF</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">file_name = &#34;ubuntu.cloud-config.yaml&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span></code></pre></div><p>This will be used by all my OpenTofu deployed VMs in this task. It will install the <em>qemu-guest-agent</em>, configure a timezone, copy my Linux jumphost public key so I can log in to them using SSH without password. Then a quick reboot after all task completed to get the qemu-agent to report correctly to Proxmox.  This will be uploaded to my Proxmox server as a Snippet. For Snippets to work. One need to enable this here under Datacenter -&gt; Storage</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2024/01/15/proxmox-with-opentofu-kubespray-and-kubernetes/images/image-20240115205937507.png"
        alt="snippets"
      />
      
    </figure>
</p>
<p>Now I can go ahead and perform <em>tofu init</em> in this folder, but I am still not ready. I Kubernetes to be deployed also remember. For that I will use Kubespray.</p>


<h3 class="relative group">Install and configure Kubespray 
    <div id="install-and-configure-kubespray" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#install-and-configure-kubespray" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>If you have not heard about Kubespray before, head over <a href="https://github.com/kubernetes-sigs/kubespray/tree/master" target="_blank">here</a> for more info. I have been following the guides from Kubespray to get it working, and its very well documented.</p>
<p>Kubespray is a really powerful way to deploy Kubernetes with a lot of options and customizations. I just want to highlight Kubespray in this section as it does a really great job in automating Kubernetes deployment.</p>
<p>A quote from the Kubespray pages:</p>
<blockquote>


<h1 class="relative group"><a href="https://kubespray.io/#/docs/comparisons?id=comparison" target="_blank">Comparison</a> 
    <div id="comparisonhttpskubesprayiodocscomparisonsidcomparison" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#comparisonhttpskubesprayiodocscomparisonsidcomparison" aria-label="Anchor">#</a>
    </span>        
    
</h1>


<h2 class="relative group"><a href="https://kubespray.io/#/docs/comparisons?id=kubespray-vs-kops" target="_blank">Kubespray vs Kops</a> 
    <div id="kubespray-vs-kopshttpskubesprayiodocscomparisonsidkubespray-vs-kops" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#kubespray-vs-kopshttpskubesprayiodocscomparisonsidkubespray-vs-kops" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>Kubespray runs on bare metal and most clouds, using Ansible as its substrate for provisioning and orchestration. <a href="https://github.com/kubernetes/kops" target="_blank">Kops</a> performs the provisioning and orchestration itself, and as such is less flexible in deployment platforms. For people with familiarity with Ansible, existing Ansible deployments or the desire to run a Kubernetes cluster across multiple platforms, Kubespray is a good choice. Kops, however, is more tightly integrated with the unique features of the clouds it supports so it could be a better choice if you know that you will only be using one platform for the foreseeable future.</p>


<h2 class="relative group"><a href="https://kubespray.io/#/docs/comparisons?id=kubespray-vs-kubeadm" target="_blank">Kubespray vs Kubeadm</a> 
    <div id="kubespray-vs-kubeadmhttpskubesprayiodocscomparisonsidkubespray-vs-kubeadm" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#kubespray-vs-kubeadmhttpskubesprayiodocscomparisonsidkubespray-vs-kubeadm" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p><a href="https://github.com/kubernetes/kubeadm" target="_blank">Kubeadm</a> provides domain Knowledge of Kubernetes clusters&rsquo; life cycle management, including self-hosted layouts, dynamic discovery services and so on. Had it belonged to the new <a href="https://coreos.com/blog/introducing-operators.html" target="_blank">operators world</a>, it may have been named a &ldquo;Kubernetes cluster operator&rdquo;. Kubespray however, does generic configuration management tasks from the &ldquo;OS operators&rdquo; ansible world, plus some initial K8s clustering (with networking plugins included) and control plane bootstrapping.</p>
<p>Kubespray has started using <code>kubeadm</code> internally for cluster creation since v2.3 in order to consume life cycle management domain knowledge from it and offload generic OS configuration things from it, which hopefully benefits both sides.</p>
</blockquote>
<p>On my Linux jumphost I have done the following to prepare for Kubespray</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># clone the Kubespray repo</span>
</span></span><span class="line"><span class="cl">andreasm@linuxmgmt01:~/terraform/proxmox$ git clone https://github.com/kubernetes-sigs/kubespray.git
</span></span><span class="line"><span class="cl"><span class="c1"># kubespray folder created under my proxmox folder</span>
</span></span><span class="line"><span class="cl">andreasm@linuxmgmt01:~/terraform/proxmox$ ls
</span></span><span class="line"><span class="cl">k8s-cluster-02  kubespray  proxmox-images
</span></span><span class="line"><span class="cl"><span class="c1"># Python dependencies -  these I am not sure are needed but I installed them anyways.</span>
</span></span><span class="line"><span class="cl">sudo apt install software-properties-common
</span></span><span class="line"><span class="cl">sudo add-apt-repository ppa:deadsnakes/ppa <span class="c1"># used this repo to get a newer Python 3 than default repo</span>
</span></span><span class="line"><span class="cl">sudo apt update
</span></span><span class="line"><span class="cl">sudo apt install python3.12 python3-pip python3-virtualenv
</span></span></code></pre></div><p>Don&rsquo;t try to install Ansible in the systemwide, it will not work. Follow the Kubespray documentation to install ansible in a Python Virtual Environment.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@linuxmgmt01:~/terraform/proxmox$ <span class="nv">VENVDIR</span><span class="o">=</span>kubespray-venv
</span></span><span class="line"><span class="cl">andreasm@linuxmgmt01:~/terraform/proxmox$ <span class="nv">KUBESPRAYDIR</span><span class="o">=</span>kubespray
</span></span><span class="line"><span class="cl">andreasm@linuxmgmt01:~/terraform/proxmox$ python3 -m venv <span class="nv">$VENVDIR</span>
</span></span><span class="line"><span class="cl">andreasm@linuxmgmt01:~/terraform/proxmox$ <span class="nb">source</span> <span class="nv">$VENVDIR</span>/bin/activate
</span></span><span class="line"><span class="cl"><span class="o">(</span>kubespray-venv<span class="o">)</span> andreasm@linuxmgmt01:~/terraform/proxmox$ <span class="nb">cd</span> <span class="nv">$KUBESPRAYDIR</span>
</span></span><span class="line"><span class="cl"><span class="o">(</span>kubespray-venv<span class="o">)</span> andreasm@linuxmgmt01:~/terraform/proxmox/kubespray$ pip install -U -r requirements.txt
</span></span></code></pre></div><p>To exit out of the python environment type <em>deactivate</em>.</p>
<p>Now I have these subfolders under my <em>proxmox</em> folder:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">andreasm@linuxmgmt01:~/terraform/proxmox$ tree -L <span class="m">1</span>
</span></span><span class="line"><span class="cl">.
</span></span><span class="line"><span class="cl"> k8s-cluster-02
</span></span><span class="line"><span class="cl"> kubespray
</span></span><span class="line"><span class="cl"> kubespray-venv
</span></span><span class="line"><span class="cl"> proxmox-images
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">4</span> directories, <span class="m">0</span> files
</span></span></code></pre></div><p>Next thing I need to do is to copy a sample folder inside the kubespray folder to a folder that reflects the kubernetes cluster name I am planning to deploy.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@linuxmgmt01:~/terraform/proxmox/kubespray$ cp -rfp inventory/sample inventory/k8s-cluster-02
</span></span></code></pre></div><p>This sample folder contains a couple of files and directories. The file I am interested in right now is the <em>inventory.ini</em> file. I need to populate this file with the nodes, including the control plane nodes, that will form my Kubernetes cluster.  This is how it looks like now, default:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># ## Configure &#39;ip&#39; variable to bind kubernetes services on a</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># ## different ip than the default iface</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># ## We should set etcd_member_name for etcd cluster. The node that is not a etcd member do not need to set the value, or can set the empty string value.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">[</span><span class="l">all]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># node1 ansible_host=95.54.0.12  # ip=10.3.0.1 etcd_member_name=etcd1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># node2 ansible_host=95.54.0.13  # ip=10.3.0.2 etcd_member_name=etcd2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># node3 ansible_host=95.54.0.14  # ip=10.3.0.3 etcd_member_name=etcd3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># node4 ansible_host=95.54.0.15  # ip=10.3.0.4 etcd_member_name=etcd4</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># node5 ansible_host=95.54.0.16  # ip=10.3.0.5 etcd_member_name=etcd5</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># node6 ansible_host=95.54.0.17  # ip=10.3.0.6 etcd_member_name=etcd6</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># ## configure a bastion host if your nodes are not directly reachable</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># [bastion]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># bastion ansible_host=x.x.x.x ansible_user=some_user</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">[</span><span class="l">kube_control_plane]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># node1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># node2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># node3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">[</span><span class="l">etcd]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># node1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># node2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># node3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">[</span><span class="l">kube_node]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># node2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># node3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># node4</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># node5</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># node6</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">[</span><span class="l">calico_rr]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">[</span><span class="l">k8s_cluster:children]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">kube_control_plane</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">kube_node</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">calico_rr</span><span class="w">
</span></span></span></code></pre></div><p>This is just a sample, but nice to know how it should be defined. I will create a OpenTofu task to create this inventory file for me with the corresponding VMs I am deploying in the same task/project. This will autopopulate this <em>inventory.ini</em> file with all the necessary information. So I can just go ahead and delete the <em>inventory.ini</em> file that has been copied from the <em>sample</em> folder to my new <em>k8s-cluster-02</em> folder. The other folders and files contains several variables/settings I can adjust to my liking. Like different CNIs, Kubernetes version etc. But I will not cover these here, head over to the official Kubespray docs for more info on that. These are the files/folder:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@linuxmgmt01:~/terraform/proxmox/kubespray/inventory/k8s-cluster-02/group_vars$ tree -L <span class="m">1</span>
</span></span><span class="line"><span class="cl">.
</span></span><span class="line"><span class="cl"> all
</span></span><span class="line"><span class="cl"> etcd.yml
</span></span><span class="line"><span class="cl"> k8s_cluster
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">2</span> directories, <span class="m">1</span> file
</span></span></code></pre></div><p>I will deploy my Kubernetes cluster &ldquo;stock&rdquo; so these files are left untouched for now, except the <em>inventory.ini</em> file.</p>
<p>Now Kubespray is ready to execute Ansible to configure my Kubernetes cluster as soon as my OpenTofu provisioned VMs has been deployed. The last step I need to do is to confgiure a new .tf file to create this <em>inventory.ini</em> file and kick of the Ansible command to fire up Kubespray.</p>


<h3 class="relative group">Configure OpenTofu to kick off Kubespray 
    <div id="configure-opentofu-to-kick-off-kubespray" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#configure-opentofu-to-kick-off-kubespray" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>The last .tf file in my fully automated Kubernetes installation is the <em>ansible.tf</em> file that contains this information:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># Generate inventory file</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">resource &#34;local_file&#34; &#34;ansible_inventory&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">filename = &#34;/home/andreasm/terraform/proxmox/kubespray/inventory/k8s-cluster-02/inventory.ini&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">content = &lt;&lt;-EOF</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">[</span><span class="l">all]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">${proxmox_virtual_environment_vm.k8s-cp-vms-cl02[0].name} ansible_host=${proxmox_virtual_environment_vm.k8s-cp-vms-cl02[0].ipv4_addresses[1][0]}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">${proxmox_virtual_environment_vm.k8s-cp-vms-cl02[1].name} ansible_host=${proxmox_virtual_environment_vm.k8s-cp-vms-cl02[1].ipv4_addresses[1][0]}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">${proxmox_virtual_environment_vm.k8s-cp-vms-cl02[2].name} ansible_host=${proxmox_virtual_environment_vm.k8s-cp-vms-cl02[2].ipv4_addresses[1][0]}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">${proxmox_virtual_environment_vm.k8s-worker-vms-cl02[0].name} ansible_host=${proxmox_virtual_environment_vm.k8s-worker-vms-cl02[0].ipv4_addresses[1][0]}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">${proxmox_virtual_environment_vm.k8s-worker-vms-cl02[1].name} ansible_host=${proxmox_virtual_environment_vm.k8s-worker-vms-cl02[1].ipv4_addresses[1][0]}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">${proxmox_virtual_environment_vm.k8s-worker-vms-cl02[2].name} ansible_host=${proxmox_virtual_environment_vm.k8s-worker-vms-cl02[2].ipv4_addresses[1][0]}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">[</span><span class="l">kube_control_plane]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">${proxmox_virtual_environment_vm.k8s-cp-vms-cl02[0].name}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">${proxmox_virtual_environment_vm.k8s-cp-vms-cl02[1].name}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">${proxmox_virtual_environment_vm.k8s-cp-vms-cl02[2].name}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">[</span><span class="l">etcd]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">${proxmox_virtual_environment_vm.k8s-cp-vms-cl02[0].name}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">${proxmox_virtual_environment_vm.k8s-cp-vms-cl02[1].name}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">${proxmox_virtual_environment_vm.k8s-cp-vms-cl02[2].name}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">[</span><span class="l">kube_node]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">${proxmox_virtual_environment_vm.k8s-worker-vms-cl02[0].name}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">${proxmox_virtual_environment_vm.k8s-worker-vms-cl02[1].name}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">${proxmox_virtual_environment_vm.k8s-worker-vms-cl02[2].name}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">[</span><span class="l">k8s_cluster:children]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">kube_node</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">kube_control_plane</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">EOF</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">resource &#34;null_resource&#34; &#34;ansible_command&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">provisioner &#34;local-exec&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">command = &#34;./kubespray.k8s-cluster-02.sh &gt; k8s-cluster-02/ansible_output.log 2&gt;&amp;1&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">interpreter = [&#34;/bin/bash&#34;, &#34;-c&#34;]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">working_dir = &#34;/home/andreasm/terraform/proxmox&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">depends_on = [proxmox_virtual_environment_vm.k8s-cp-vms-cl02, proxmox_virtual_environment_vm.k8s-worker-vms-cl02, local_file.ansible_inventory]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span></code></pre></div><p>This will create the <em>inventory.ini</em> in the <em>/proxmox/kubespray/inventory/k8s-cluster-02/</em> for Kubespray to use. Then it will fire a command refering to a bash script (more on that further down) to trigger the Ansible command:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ansible-playbook -i inventory/k8s-cluster-02/inventory.ini --become --become-user<span class="o">=</span>root cluster.yml -u ubuntu
</span></span></code></pre></div><p>For this to work I had to create a bash script that activated the Kubespray virtual environment:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="cp">#!/bin/bash
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1"># Set working directory</span>
</span></span><span class="line"><span class="cl"><span class="nv">WORKING_DIR</span><span class="o">=</span><span class="s2">&#34;/home/andreasm/terraform/proxmox&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> <span class="s2">&#34;</span><span class="nv">$WORKING_DIR</span><span class="s2">&#34;</span> <span class="o">||</span> <span class="nb">exit</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Set virtual environment variables</span>
</span></span><span class="line"><span class="cl"><span class="nv">VENVDIR</span><span class="o">=</span><span class="s2">&#34;kubespray-venv&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">KUBESPRAYDIR</span><span class="o">=</span><span class="s2">&#34;kubespray&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Activate virtual environment</span>
</span></span><span class="line"><span class="cl"><span class="nb">source</span> <span class="s2">&#34;</span><span class="nv">$VENVDIR</span><span class="s2">/bin/activate&#34;</span> <span class="o">||</span> <span class="nb">exit</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Change to Kubespray directory</span>
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> <span class="s2">&#34;</span><span class="nv">$KUBESPRAYDIR</span><span class="s2">&#34;</span> <span class="o">||</span> <span class="nb">exit</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Run Ansible playbook</span>
</span></span><span class="line"><span class="cl">ansible-playbook -i inventory/k8s-cluster-02/inventory.ini --become --become-user<span class="o">=</span>root cluster.yml -u ubuntu
</span></span></code></pre></div><p>I will create and save this file in my <em>proxmox</em> folder.</p>
<p>This is now the content of my proxmox folder:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@linuxmgmt01:~/terraform/proxmox$ tree -L <span class="m">1</span>
</span></span><span class="line"><span class="cl">.
</span></span><span class="line"><span class="cl"> k8s-cluster-02
</span></span><span class="line"><span class="cl"> kubespray
</span></span><span class="line"><span class="cl"> kubespray-venv
</span></span><span class="line"><span class="cl"> kubespray.k8s-cluster-02.sh
</span></span><span class="line"><span class="cl"> proxmox-images
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">4</span> directories, <span class="m">1</span> file
</span></span></code></pre></div><p>And this is the content in the k8s-cluster-02 folder where I have my OpenTofu tasks defined:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@linuxmgmt01:~/terraform/proxmox/k8s-cluster-02$ tree -L <span class="m">1</span>
</span></span><span class="line"><span class="cl">.
</span></span><span class="line"><span class="cl"> ansible.tf
</span></span><span class="line"><span class="cl"> credentials.auto.tfvars
</span></span><span class="line"><span class="cl"> k8s-cluster-02.tf
</span></span><span class="line"><span class="cl"> provider.tf
</span></span><span class="line"><span class="cl"> ubuntu_cloud_config.tf
</span></span><span class="line"><span class="cl"> variables.tf
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">0</span> directories, <span class="m">6</span> files
</span></span></code></pre></div><p>Its time to put it all to a test</p>


<h3 class="relative group">A fully automated provisioning of Kubernetes on Proxmox using OpenTofu, Ansible and Kubespray 
    <div id="a-fully-automated-provisioning-of-kubernetes-on-proxmox-using-opentofu-ansible-and-kubespray" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#a-fully-automated-provisioning-of-kubernetes-on-proxmox-using-opentofu-ansible-and-kubespray" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>To get this show started, it is the same procedure as it was with my cloud image task. Need to run tofu init, then create a plan, check the output and finally approve it. So lets see how this goes.</p>
<p>From within my <em>./proxmox/k8s-cluster-02</em> folder:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@linuxmgmt01:~/terraform/proxmox/k8s-cluster-02$ tofu init
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Initializing the backend...
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Initializing provider plugins...
</span></span><span class="line"><span class="cl">- Finding latest version of hashicorp/null...
</span></span><span class="line"><span class="cl">- Finding bpg/proxmox versions matching <span class="s2">&#34;0.43.2&#34;</span>...
</span></span><span class="line"><span class="cl">- Finding latest version of hashicorp/local...
</span></span><span class="line"><span class="cl">- Installing hashicorp/null v3.2.2...
</span></span><span class="line"><span class="cl">- Installed hashicorp/null v3.2.2 <span class="o">(</span>signed, key ID 0C0AF313E5FD9F80<span class="o">)</span>
</span></span><span class="line"><span class="cl">- Installing bpg/proxmox v0.43.2...
</span></span><span class="line"><span class="cl">- Installed bpg/proxmox v0.43.2 <span class="o">(</span>signed, key ID DAA1958557A27403<span class="o">)</span>
</span></span><span class="line"><span class="cl">- Installing hashicorp/local v2.4.1...
</span></span><span class="line"><span class="cl">- Installed hashicorp/local v2.4.1 <span class="o">(</span>signed, key ID 0C0AF313E5FD9F80<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Providers are signed by their developers.
</span></span><span class="line"><span class="cl">If you<span class="err">&#39;</span>d like to know more about provider signing, you can <span class="nb">read</span> about it here:
</span></span><span class="line"><span class="cl">https://opentofu.org/docs/cli/plugins/signing/
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">OpenTofu has created a lock file .terraform.lock.hcl to record the provider
</span></span><span class="line"><span class="cl">selections it made above. Include this file in your version control repository
</span></span><span class="line"><span class="cl">so that OpenTofu can guarantee to make the same selections by default when
</span></span><span class="line"><span class="cl">you run <span class="s2">&#34;tofu init&#34;</span> in the future.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">OpenTofu has been successfully initialized!
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">You may now begin working with OpenTofu. Try running <span class="s2">&#34;tofu plan&#34;</span> to see
</span></span><span class="line"><span class="cl">any changes that are required <span class="k">for</span> your infrastructure. All OpenTofu commands
</span></span><span class="line"><span class="cl">should now work.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">If you ever <span class="nb">set</span> or change modules or backend configuration <span class="k">for</span> OpenTofu,
</span></span><span class="line"><span class="cl">rerun this <span class="nb">command</span> to reinitialize your working directory. If you forget, other
</span></span><span class="line"><span class="cl">commands will detect it and remind you to <span class="k">do</span> so <span class="k">if</span> necessary.
</span></span></code></pre></div><p>Then create the plan:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">OpenTofu used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols:
</span></span><span class="line"><span class="cl">  + create
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">OpenTofu will perform the following actions:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1"># local_file.ansible_inventory will be created</span>
</span></span><span class="line"><span class="cl">  + resource <span class="s2">&#34;local_file&#34;</span> <span class="s2">&#34;ansible_inventory&#34;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      + <span class="nv">content</span>              <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span></span><span class="line"><span class="cl">      + <span class="nv">content_base64sha256</span> <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span></span><span class="line"><span class="cl">      + <span class="nv">content_base64sha512</span> <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span></span><span class="line"><span class="cl">      + <span class="nv">content_md5</span>          <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span></span><span class="line"><span class="cl">      + <span class="nv">content_sha1</span>         <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span></span><span class="line"><span class="cl">      + <span class="nv">content_sha256</span>       <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span></span><span class="line"><span class="cl">      + <span class="nv">content_sha512</span>       <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span></span><span class="line"><span class="cl">      + <span class="nv">directory_permission</span> <span class="o">=</span> <span class="s2">&#34;0777&#34;</span>
</span></span><span class="line"><span class="cl">      + <span class="nv">file_permission</span>      <span class="o">=</span> <span class="s2">&#34;0777&#34;</span>
</span></span><span class="line"><span class="cl">      + <span class="nv">filename</span>             <span class="o">=</span> <span class="s2">&#34;/home/andreasm/terraform/proxmox/kubespray/inventory/k8s-cluster-02/inventory.ini&#34;</span>
</span></span><span class="line"><span class="cl">      + <span class="nv">id</span>                   <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1"># null_resource.ansible_command will be created</span>
</span></span><span class="line"><span class="cl">  + resource <span class="s2">&#34;null_resource&#34;</span> <span class="s2">&#34;ansible_command&#34;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      + <span class="nv">id</span> <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1"># proxmox_virtual_environment_file.ubuntu_cloud_init will be created</span>
</span></span><span class="line"><span class="cl">  + resource <span class="s2">&#34;proxmox_virtual_environment_file&#34;</span> <span class="s2">&#34;ubuntu_cloud_init&#34;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      + <span class="nv">content_type</span>           <span class="o">=</span> <span class="s2">&#34;snippets&#34;</span>
</span></span><span class="line"><span class="cl">      + <span class="nv">datastore_id</span>           <span class="o">=</span> <span class="s2">&#34;local&#34;</span>
</span></span><span class="line"><span class="cl">      + <span class="nv">file_modification_date</span> <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span></span><span class="line"><span class="cl">      + <span class="nv">file_name</span>              <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span></span><span class="line"><span class="cl">      + <span class="nv">file_size</span>              <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span></span><span class="line"><span class="cl">      + <span class="nv">file_tag</span>               <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span></span><span class="line"><span class="cl">      + <span class="nv">id</span>                     <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span></span><span class="line"><span class="cl">      + <span class="nv">node_name</span>              <span class="o">=</span> <span class="s2">&#34;proxmox-02&#34;</span>
</span></span><span class="line"><span class="cl">      + <span class="nv">overwrite</span>              <span class="o">=</span> <span class="nb">true</span>
</span></span><span class="line"><span class="cl">      + <span class="nv">timeout_upload</span>         <span class="o">=</span> <span class="m">1800</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="s">&lt;&lt;redacted&gt;&gt;
</span></span></span><span class="line"><span class="cl"><span class="s">Plan: 9 to add, 0 to change, 0 to destr</span>oy.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Saved the plan to: plan
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">To perform exactly these actions, run the following <span class="nb">command</span> to apply:
</span></span><span class="line"><span class="cl">    tofu apply <span class="s2">&#34;plan&#34;</span>
</span></span></code></pre></div><p>It looks good to me, lets apply it:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@linuxmgmt01:~/terraform/proxmox/k8s-cluster-02$ tofu apply plan
</span></span><span class="line"><span class="cl">proxmox_virtual_environment_file.ubuntu_cloud_init: Creating...
</span></span><span class="line"><span class="cl">proxmox_virtual_environment_file.ubuntu_cloud_init: Creation <span class="nb">complete</span> after 1s <span class="o">[</span><span class="nv">id</span><span class="o">=</span>local:snippets/ubuntu.cloud-config.yaml<span class="o">]</span>
</span></span><span class="line"><span class="cl">proxmox_virtual_environment_vm.k8s-worker-vms-cl02<span class="o">[</span>2<span class="o">]</span>: Creating...
</span></span><span class="line"><span class="cl">proxmox_virtual_environment_vm.k8s-worker-vms-cl02<span class="o">[</span>1<span class="o">]</span>: Creating...
</span></span><span class="line"><span class="cl">proxmox_virtual_environment_vm.k8s-worker-vms-cl02<span class="o">[</span>0<span class="o">]</span>: Creating...
</span></span><span class="line"><span class="cl">proxmox_virtual_environment_vm.k8s-cp-vms-cl02<span class="o">[</span>1<span class="o">]</span>: Creating...
</span></span><span class="line"><span class="cl">proxmox_virtual_environment_vm.k8s-cp-vms-cl02<span class="o">[</span>0<span class="o">]</span>: Creating...
</span></span><span class="line"><span class="cl">proxmox_virtual_environment_vm.k8s-cp-vms-cl02<span class="o">[</span>2<span class="o">]</span>: Creating...
</span></span><span class="line"><span class="cl">proxmox_virtual_environment_vm.k8s-worker-vms-cl02<span class="o">[</span>2<span class="o">]</span>: Still creating... <span class="o">[</span>10s elapsed<span class="o">]</span>
</span></span><span class="line"><span class="cl">proxmox_virtual_environment_vm.k8s-worker-vms-cl02<span class="o">[</span>1<span class="o">]</span>: Still creating... <span class="o">[</span>10s elapsed<span class="o">]</span>
</span></span><span class="line"><span class="cl">proxmox_virtual_environment_vm.k8s-worker-vms-cl02<span class="o">[</span>0<span class="o">]</span>: Still creating... <span class="o">[</span>10s elapsed<span class="o">]</span>
</span></span><span class="line"><span class="cl">proxmox_virtual_environment_vm.k8s-cp-vms-cl02<span class="o">[</span>1<span class="o">]</span>: Still creating... <span class="o">[</span>10s elapsed<span class="o">]</span>
</span></span><span class="line"><span class="cl">proxmox_virtual_environment_vm.k8s-cp-vms-cl02<span class="o">[</span>0<span class="o">]</span>: Still creating... <span class="o">[</span>10s elapsed<span class="o">]</span>
</span></span><span class="line"><span class="cl">proxmox_virtual_environment_vm.k8s-cp-vms-cl02<span class="o">[</span>2<span class="o">]</span>: Still creating... <span class="o">[</span>10s elapsed<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="s">&lt;&lt;redacted&gt;&gt;
</span></span></span><span class="line"><span class="cl"><span class="s">proxmox_virtual_environment_vm.k8s-worker-vms-cl02[2]: Still cre</span>ating... <span class="o">[</span>1m30s elapsed<span class="o">]</span>
</span></span><span class="line"><span class="cl">proxmox_virtual_environment_vm.k8s-worker-vms-cl02<span class="o">[</span>1<span class="o">]</span>: Still creating... <span class="o">[</span>1m30s elapsed<span class="o">]</span>
</span></span><span class="line"><span class="cl">proxmox_virtual_environment_vm.k8s-worker-vms-cl02<span class="o">[</span>0<span class="o">]</span>: Still creating... <span class="o">[</span>1m30s elapsed<span class="o">]</span>
</span></span><span class="line"><span class="cl">proxmox_virtual_environment_vm.k8s-cp-vms-cl02<span class="o">[</span>1<span class="o">]</span>: Still creating... <span class="o">[</span>1m30s elapsed<span class="o">]</span>
</span></span><span class="line"><span class="cl">proxmox_virtual_environment_vm.k8s-cp-vms-cl02<span class="o">[</span>0<span class="o">]</span>: Still creating... <span class="o">[</span>1m30s elapsed<span class="o">]</span>
</span></span><span class="line"><span class="cl">proxmox_virtual_environment_vm.k8s-cp-vms-cl02<span class="o">[</span>2<span class="o">]</span>: Still creating... <span class="o">[</span>1m30s elapsed<span class="o">]</span>
</span></span><span class="line"><span class="cl">proxmox_virtual_environment_vm.k8s-worker-vms-cl02<span class="o">[</span>0<span class="o">]</span>: Creation <span class="nb">complete</span> after 1m32s <span class="o">[</span><span class="nv">id</span><span class="o">=</span>1005<span class="o">]</span>
</span></span><span class="line"><span class="cl">proxmox_virtual_environment_vm.k8s-cp-vms-cl02<span class="o">[</span>1<span class="o">]</span>: Creation <span class="nb">complete</span> after 1m32s <span class="o">[</span><span class="nv">id</span><span class="o">=</span>1002<span class="o">]</span>
</span></span><span class="line"><span class="cl">proxmox_virtual_environment_vm.k8s-worker-vms-cl02<span class="o">[</span>1<span class="o">]</span>: Creation <span class="nb">complete</span> after 1m33s <span class="o">[</span><span class="nv">id</span><span class="o">=</span>1006<span class="o">]</span>
</span></span><span class="line"><span class="cl">proxmox_virtual_environment_vm.k8s-worker-vms-cl02<span class="o">[</span>2<span class="o">]</span>: Creation <span class="nb">complete</span> after 1m33s <span class="o">[</span><span class="nv">id</span><span class="o">=</span>1007<span class="o">]</span>
</span></span><span class="line"><span class="cl">proxmox_virtual_environment_vm.k8s-cp-vms-cl02<span class="o">[</span>2<span class="o">]</span>: Creation <span class="nb">complete</span> after 1m34s <span class="o">[</span><span class="nv">id</span><span class="o">=</span>1003<span class="o">]</span>
</span></span><span class="line"><span class="cl">proxmox_virtual_environment_vm.k8s-cp-vms-cl02<span class="o">[</span>0<span class="o">]</span>: Creation <span class="nb">complete</span> after 1m37s <span class="o">[</span><span class="nv">id</span><span class="o">=</span>1001<span class="o">]</span>
</span></span></code></pre></div><p>1m37s to create my 6 VMs, ready for the Kubernetes installation.</p>
<p>And in Proxmox I have 6 new VMs with correct name, vm_id, tags and all:</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2024/01/15/proxmox-with-opentofu-kubespray-and-kubernetes/images/image-20240115224119296.png"
        alt="my-new-kubernetes-cluster"
      />
      
    </figure>
</p>
<p>Let me check if the <em>inventory.ini</em> file has been created correct:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="l">andreasm@linuxmgmt01:~/terraform/proxmox/kubespray/inventory/k8s-cluster-02$ cat inventory.ini</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">[</span><span class="l">all]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">k8s-cp-vm-1-cl-02 ansible_host=10.160.1.21</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">k8s-cp-vm-2-cl-02 ansible_host=10.160.1.22</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">k8s-cp-vm-3-cl-02 ansible_host=10.160.1.23</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">k8s-node-vm-1-cl-02 ansible_host=10.160.1.25</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">k8s-node-vm-2-cl-02 ansible_host=10.160.1.26</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">k8s-node-vm-3-cl-02 ansible_host=10.160.1.27</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">[</span><span class="l">kube_control_plane]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">k8s-cp-vm-1-cl-02</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">k8s-cp-vm-2-cl-02</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">k8s-cp-vm-3-cl-02</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">[</span><span class="l">etcd]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">k8s-cp-vm-1-cl-02</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">k8s-cp-vm-2-cl-02</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">k8s-cp-vm-3-cl-02</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">[</span><span class="l">kube_node]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">k8s-node-vm-1-cl-02</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">k8s-node-vm-2-cl-02</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">k8s-node-vm-3-cl-02</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">[</span><span class="l">k8s_cluster:children]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">kube_node</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">kube_control_plane</span><span class="w">
</span></span></span></code></pre></div><p>Now the last task the ansible_command:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">local_file.ansible_inventory: Creating...
</span></span><span class="line"><span class="cl">local_file.ansible_inventory: Creation <span class="nb">complete</span> after 0s <span class="o">[</span><span class="nv">id</span><span class="o">=</span>1d19a8be76746178f26336defc9ce96c6e82a791<span class="o">]</span>
</span></span><span class="line"><span class="cl">null_resource.ansible_command: Creating...
</span></span><span class="line"><span class="cl">null_resource.ansible_command: Provisioning with <span class="s1">&#39;local-exec&#39;</span>...
</span></span><span class="line"><span class="cl">null_resource.ansible_command <span class="o">(</span>local-exec<span class="o">)</span>: Executing: <span class="o">[</span><span class="s2">&#34;/bin/bash&#34;</span> <span class="s2">&#34;-c&#34;</span> <span class="s2">&#34;./kubespray.k8s-cluster-02.sh &gt; k8s-cluster-02/ansible_output.log 2&gt;&amp;1&#34;</span><span class="o">]</span>
</span></span><span class="line"><span class="cl">null_resource.ansible_command: Still creating... <span class="o">[</span>10s elapsed<span class="o">]</span>
</span></span><span class="line"><span class="cl">null_resource.ansible_command: Still creating... <span class="o">[</span>20s elapsed<span class="o">]</span>
</span></span><span class="line"><span class="cl">null_resource.ansible_command: Still creating... <span class="o">[</span>30s elapsed<span class="o">]</span>
</span></span><span class="line"><span class="cl">null_resource.ansible_command: Still creating... <span class="o">[</span>40s elapsed<span class="o">]</span>
</span></span><span class="line"><span class="cl">null_resource.ansible_command: Still creating... <span class="o">[</span>50s elapsed<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="s">&lt;&lt;redacted&gt;&gt;
</span></span></span><span class="line"><span class="cl"><span class="s">null_re</span>source.ansible_command: Still creating... <span class="o">[</span>16m50s elapsed<span class="o">]</span>
</span></span><span class="line"><span class="cl">null_resource.ansible_command: Still creating... <span class="o">[</span>17m0s elapsed<span class="o">]</span>
</span></span><span class="line"><span class="cl">null_resource.ansible_command: Creation <span class="nb">complete</span> after 17m4s <span class="o">[</span><span class="nv">id</span><span class="o">=</span>5215143035945962122<span class="o">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Apply complete! Resources: <span class="m">9</span> added, <span class="m">0</span> changed, <span class="m">0</span> destroyed.
</span></span></code></pre></div><p>That took 17m4s to deploy a fully working Kubernetes cluster with no intervention from me at all.</p>
<p>From the ansible_output.log:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">PLAY RECAP *********************************************************************
</span></span><span class="line"><span class="cl">k8s-cp-vm-1-cl-02          : <span class="nv">ok</span><span class="o">=</span><span class="m">691</span>  <span class="nv">changed</span><span class="o">=</span><span class="m">139</span>  <span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span>    <span class="nv">failed</span><span class="o">=</span><span class="m">0</span>    <span class="nv">skipped</span><span class="o">=</span><span class="m">1080</span> <span class="nv">rescued</span><span class="o">=</span><span class="m">0</span>    <span class="nv">ignored</span><span class="o">=</span><span class="m">6</span>
</span></span><span class="line"><span class="cl">k8s-cp-vm-2-cl-02          : <span class="nv">ok</span><span class="o">=</span><span class="m">646</span>  <span class="nv">changed</span><span class="o">=</span><span class="m">131</span>  <span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span>    <span class="nv">failed</span><span class="o">=</span><span class="m">0</span>    <span class="nv">skipped</span><span class="o">=</span><span class="m">1050</span> <span class="nv">rescued</span><span class="o">=</span><span class="m">0</span>    <span class="nv">ignored</span><span class="o">=</span><span class="m">3</span>
</span></span><span class="line"><span class="cl">k8s-cp-vm-3-cl-02          : <span class="nv">ok</span><span class="o">=</span><span class="m">648</span>  <span class="nv">changed</span><span class="o">=</span><span class="m">132</span>  <span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span>    <span class="nv">failed</span><span class="o">=</span><span class="m">0</span>    <span class="nv">skipped</span><span class="o">=</span><span class="m">1048</span> <span class="nv">rescued</span><span class="o">=</span><span class="m">0</span>    <span class="nv">ignored</span><span class="o">=</span><span class="m">3</span>
</span></span><span class="line"><span class="cl">k8s-node-vm-1-cl-02        : <span class="nv">ok</span><span class="o">=</span><span class="m">553</span>  <span class="nv">changed</span><span class="o">=</span><span class="m">93</span>   <span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span>    <span class="nv">failed</span><span class="o">=</span><span class="m">0</span>    <span class="nv">skipped</span><span class="o">=</span><span class="m">840</span>  <span class="nv">rescued</span><span class="o">=</span><span class="m">0</span>    <span class="nv">ignored</span><span class="o">=</span><span class="m">1</span>
</span></span><span class="line"><span class="cl">k8s-node-vm-2-cl-02        : <span class="nv">ok</span><span class="o">=</span><span class="m">509</span>  <span class="nv">changed</span><span class="o">=</span><span class="m">90</span>   <span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span>    <span class="nv">failed</span><span class="o">=</span><span class="m">0</span>    <span class="nv">skipped</span><span class="o">=</span><span class="m">739</span>  <span class="nv">rescued</span><span class="o">=</span><span class="m">0</span>    <span class="nv">ignored</span><span class="o">=</span><span class="m">1</span>
</span></span><span class="line"><span class="cl">k8s-node-vm-3-cl-02        : <span class="nv">ok</span><span class="o">=</span><span class="m">509</span>  <span class="nv">changed</span><span class="o">=</span><span class="m">90</span>   <span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span>    <span class="nv">failed</span><span class="o">=</span><span class="m">0</span>    <span class="nv">skipped</span><span class="o">=</span><span class="m">739</span>  <span class="nv">rescued</span><span class="o">=</span><span class="m">0</span>    <span class="nv">ignored</span><span class="o">=</span><span class="m">1</span>
</span></span><span class="line"><span class="cl">localhost                  : <span class="nv">ok</span><span class="o">=</span><span class="m">3</span>    <span class="nv">changed</span><span class="o">=</span><span class="m">0</span>    <span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span>    <span class="nv">failed</span><span class="o">=</span><span class="m">0</span>    <span class="nv">skipped</span><span class="o">=</span><span class="m">0</span>    <span class="nv">rescued</span><span class="o">=</span><span class="m">0</span>    <span class="nv">ignored</span><span class="o">=</span><span class="m">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Monday <span class="m">15</span> January <span class="m">2024</span>  21:59:02 +0000 <span class="o">(</span>0:00:00.288<span class="o">)</span>       0:17:01.376 ********
</span></span><span class="line"><span class="cl"><span class="o">===============================================================================</span>
</span></span><span class="line"><span class="cl">download : Download_file <span class="p">|</span> Download item ------------------------------- 71.29s
</span></span><span class="line"><span class="cl">download : Download_file <span class="p">|</span> Download item ------------------------------- 36.04s
</span></span><span class="line"><span class="cl">kubernetes/kubeadm : Join to cluster ----------------------------------- 19.06s
</span></span><span class="line"><span class="cl">container-engine/containerd : Download_file <span class="p">|</span> Download item ------------ 16.73s
</span></span><span class="line"><span class="cl">download : Download_container <span class="p">|</span> Download image <span class="k">if</span> required ------------- 15.65s
</span></span><span class="line"><span class="cl">container-engine/runc : Download_file <span class="p">|</span> Download item ------------------ 15.53s
</span></span><span class="line"><span class="cl">container-engine/nerdctl : Download_file <span class="p">|</span> Download item --------------- 14.75s
</span></span><span class="line"><span class="cl">container-engine/crictl : Download_file <span class="p">|</span> Download item ---------------- 14.66s
</span></span><span class="line"><span class="cl">download : Download_container <span class="p">|</span> Download image <span class="k">if</span> required ------------- 13.75s
</span></span><span class="line"><span class="cl">container-engine/crictl : Extract_file <span class="p">|</span> Unpacking archive ------------- 13.35s
</span></span><span class="line"><span class="cl">kubernetes/control-plane : Kubeadm <span class="p">|</span> Initialize first master ----------- 10.16s
</span></span><span class="line"><span class="cl">container-engine/nerdctl : Extract_file <span class="p">|</span> Unpacking archive ------------- 9.99s
</span></span><span class="line"><span class="cl">kubernetes/preinstall : Install packages requirements ------------------- 9.93s
</span></span><span class="line"><span class="cl">kubernetes/control-plane : Joining control plane node to the cluster. --- 9.21s
</span></span><span class="line"><span class="cl">container-engine/runc : Download_file <span class="p">|</span> Validate mirrors ---------------- 9.20s
</span></span><span class="line"><span class="cl">container-engine/crictl : Download_file <span class="p">|</span> Validate mirrors -------------- 9.15s
</span></span><span class="line"><span class="cl">container-engine/nerdctl : Download_file <span class="p">|</span> Validate mirrors ------------- 9.12s
</span></span><span class="line"><span class="cl">container-engine/containerd : Download_file <span class="p">|</span> Validate mirrors ---------- 9.06s
</span></span><span class="line"><span class="cl">container-engine/containerd : Containerd <span class="p">|</span> Unpack containerd archive ---- 8.99s
</span></span><span class="line"><span class="cl">download : Download_container <span class="p">|</span> Download image <span class="k">if</span> required -------------- 8.19s
</span></span></code></pre></div><p>I guess I am gonna spin up a couple of Kubernetes clusters going forward &#x1f604;</p>
<p>If something should fail I have configured the <em>ansible_command</em> to pipe the output to a file called <em>ansible_output.log</em> I can check. This pipes out the whole Kubespray operation. Some simple tests to do is also checking if Ansible can reach the VMs (after they have been deployed ofcourse). This command needs to be run within the python environment again.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># activate the environment</span>
</span></span><span class="line"><span class="cl">andreasm@linuxmgmt01:~/terraform/proxmox$ <span class="nb">source</span> <span class="nv">$VENVDIR</span>/bin/activate
</span></span><span class="line"><span class="cl"><span class="c1"># ping all nodes</span>
</span></span><span class="line"><span class="cl"><span class="o">(</span>kubespray-venv<span class="o">)</span> andreasm@linuxmgmt01:~/terraform/proxmox$ ansible -i inventory/k8s-cluster-02/inventory.ini -m ping all -u ubuntu
</span></span></code></pre></div><p>Now let me log into one of the Kubernetes Control plane and check if there is a Kubernetes cluster ready or not:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root@k8s-cp-vm-1-cl-02:/home/ubuntu# kubectl get nodes
</span></span><span class="line"><span class="cl">NAME                  STATUS   ROLES           AGE     VERSION
</span></span><span class="line"><span class="cl">k8s-cp-vm-1-cl-02     Ready    control-plane   6m13s   v1.28.5
</span></span><span class="line"><span class="cl">k8s-cp-vm-2-cl-02     Ready    control-plane   6m1s    v1.28.5
</span></span><span class="line"><span class="cl">k8s-cp-vm-3-cl-02     Ready    control-plane   5m57s   v1.28.5
</span></span><span class="line"><span class="cl">k8s-node-vm-1-cl-02   Ready    &lt;none&gt;          5m24s   v1.28.5
</span></span><span class="line"><span class="cl">k8s-node-vm-2-cl-02   Ready    &lt;none&gt;          5m23s   v1.28.5
</span></span><span class="line"><span class="cl">k8s-node-vm-3-cl-02   Ready    &lt;none&gt;          5m19s   v1.28.5
</span></span><span class="line"><span class="cl">root@k8s-cp-vm-1-cl-02:/home/ubuntu# kubectl get pods -A
</span></span><span class="line"><span class="cl">NAMESPACE     NAME                                        READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">kube-system   calico-kube-controllers-648dffd99-lr82q     1/1     Running   <span class="m">0</span>          4m25s
</span></span><span class="line"><span class="cl">kube-system   calico-node-b25gf                           1/1     Running   <span class="m">0</span>          4m52s
</span></span><span class="line"><span class="cl">kube-system   calico-node-h7lpr                           1/1     Running   <span class="m">0</span>          4m52s
</span></span><span class="line"><span class="cl">kube-system   calico-node-jdkb9                           1/1     Running   <span class="m">0</span>          4m52s
</span></span><span class="line"><span class="cl">kube-system   calico-node-vsgqq                           1/1     Running   <span class="m">0</span>          4m52s
</span></span><span class="line"><span class="cl">kube-system   calico-node-w6vrc                           1/1     Running   <span class="m">0</span>          4m52s
</span></span><span class="line"><span class="cl">kube-system   calico-node-x95mh                           1/1     Running   <span class="m">0</span>          4m52s
</span></span><span class="line"><span class="cl">kube-system   coredns-77f7cc69db-29t6b                    1/1     Running   <span class="m">0</span>          4m13s
</span></span><span class="line"><span class="cl">kube-system   coredns-77f7cc69db-2ph9d                    1/1     Running   <span class="m">0</span>          4m10s
</span></span><span class="line"><span class="cl">kube-system   dns-autoscaler-8576bb9f5b-8bzqp             1/1     Running   <span class="m">0</span>          4m11s
</span></span><span class="line"><span class="cl">kube-system   kube-apiserver-k8s-cp-vm-1-cl-02            1/1     Running   <span class="m">1</span>          6m14s
</span></span><span class="line"><span class="cl">kube-system   kube-apiserver-k8s-cp-vm-2-cl-02            1/1     Running   <span class="m">1</span>          5m55s
</span></span><span class="line"><span class="cl">kube-system   kube-apiserver-k8s-cp-vm-3-cl-02            1/1     Running   <span class="m">1</span>          6m1s
</span></span><span class="line"><span class="cl">kube-system   kube-controller-manager-k8s-cp-vm-1-cl-02   1/1     Running   <span class="m">2</span>          6m16s
</span></span><span class="line"><span class="cl">kube-system   kube-controller-manager-k8s-cp-vm-2-cl-02   1/1     Running   <span class="m">2</span>          5m56s
</span></span><span class="line"><span class="cl">kube-system   kube-controller-manager-k8s-cp-vm-3-cl-02   1/1     Running   <span class="m">2</span>          6m1s
</span></span><span class="line"><span class="cl">kube-system   kube-proxy-6jt89                            1/1     Running   <span class="m">0</span>          5m22s
</span></span><span class="line"><span class="cl">kube-system   kube-proxy-9w5f2                            1/1     Running   <span class="m">0</span>          5m22s
</span></span><span class="line"><span class="cl">kube-system   kube-proxy-k7l9g                            1/1     Running   <span class="m">0</span>          5m22s
</span></span><span class="line"><span class="cl">kube-system   kube-proxy-p7wqt                            1/1     Running   <span class="m">0</span>          5m22s
</span></span><span class="line"><span class="cl">kube-system   kube-proxy-qfmg5                            1/1     Running   <span class="m">0</span>          5m22s
</span></span><span class="line"><span class="cl">kube-system   kube-proxy-v6tcn                            1/1     Running   <span class="m">0</span>          5m22s
</span></span><span class="line"><span class="cl">kube-system   kube-scheduler-k8s-cp-vm-1-cl-02            1/1     Running   <span class="m">1</span>          6m14s
</span></span><span class="line"><span class="cl">kube-system   kube-scheduler-k8s-cp-vm-2-cl-02            1/1     Running   <span class="m">1</span>          5m56s
</span></span><span class="line"><span class="cl">kube-system   kube-scheduler-k8s-cp-vm-3-cl-02            1/1     Running   <span class="m">1</span>          6m
</span></span><span class="line"><span class="cl">kube-system   nginx-proxy-k8s-node-vm-1-cl-02             1/1     Running   <span class="m">0</span>          5m25s
</span></span><span class="line"><span class="cl">kube-system   nginx-proxy-k8s-node-vm-2-cl-02             1/1     Running   <span class="m">0</span>          5m20s
</span></span><span class="line"><span class="cl">kube-system   nginx-proxy-k8s-node-vm-3-cl-02             1/1     Running   <span class="m">0</span>          5m20s
</span></span><span class="line"><span class="cl">kube-system   nodelocaldns-4z72v                          1/1     Running   <span class="m">0</span>          4m9s
</span></span><span class="line"><span class="cl">kube-system   nodelocaldns-8wv4j                          1/1     Running   <span class="m">0</span>          4m9s
</span></span><span class="line"><span class="cl">kube-system   nodelocaldns-kl6fw                          1/1     Running   <span class="m">0</span>          4m9s
</span></span><span class="line"><span class="cl">kube-system   nodelocaldns-pqxpj                          1/1     Running   <span class="m">0</span>          4m9s
</span></span><span class="line"><span class="cl">kube-system   nodelocaldns-qmrq8                          1/1     Running   <span class="m">0</span>          4m9s
</span></span><span class="line"><span class="cl">kube-system   nodelocaldns-vqnbd                          1/1     Running   <span class="m">0</span>          4m9s
</span></span><span class="line"><span class="cl">root@k8s-cp-vm-1-cl-02:/home/ubuntu#
</span></span></code></pre></div><p>Nice nice nice. Now I can go ahead and grab the kubeconfig, configure my loadbalancer to loadbalance the Kubernetes API and start using my newly decomposable provisioned cluster.</p>


<h3 class="relative group">Cleaning up 
    <div id="cleaning-up" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#cleaning-up" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>When I am done with my Kubernetes cluster its just about doing a <em>tofu destroy</em> command and everything is neatly cleaned up. I have not configured any persistent storage yet. So if I have deployed some apps on this cluster and decides to delete it any data that has been created I want to keep will be deleted. So its wise to look into how to keep certain data even after the deletion of my cluster.</p>
<p>There are two ways I can clean up. If I want to keep the nodes running but just reset the Kubernetes installation I can execute the following command:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># from the Kubespray environment</span>
</span></span><span class="line"><span class="cl"><span class="o">(</span>kubespray-venv<span class="o">)</span> andreasm@linuxmgmt01:~/terraform/proxmox/kubespray$ ansible-playbook -i inventory/k8s-cluster-02/hosts.yaml --become --become-user<span class="o">=</span>root reset.yml -u ubuntu
</span></span></code></pre></div><p>Or a full wipe, including the deployed VMs:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># Inside the k8s-cluster-02 OpenTofu project folder</span>
</span></span><span class="line"><span class="cl">andreasm@linuxmgmt01:~/terraform/proxmox/k8s-cluster-02$ tofu destroy
</span></span><span class="line"><span class="cl">Do you really want to destroy all resources?
</span></span><span class="line"><span class="cl">  OpenTofu will destroy all your managed infrastructure, as shown above.
</span></span><span class="line"><span class="cl">  There is no undo. Only <span class="s1">&#39;yes&#39;</span> will be accepted to confirm.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  Enter a value:yes
</span></span><span class="line"><span class="cl">null_resource.ansible_command: Destroying... <span class="o">[</span><span class="nv">id</span><span class="o">=</span>5215143035945962122<span class="o">]</span>
</span></span><span class="line"><span class="cl">null_resource.ansible_command: Destruction <span class="nb">complete</span> after 0s
</span></span><span class="line"><span class="cl">local_file.ansible_inventory: Destroying... <span class="o">[</span><span class="nv">id</span><span class="o">=</span>1d19a8be76746178f26336defc9ce96c6e82a791<span class="o">]</span>
</span></span><span class="line"><span class="cl">local_file.ansible_inventory: Destruction <span class="nb">complete</span> after 0s
</span></span><span class="line"><span class="cl">proxmox_virtual_environment_vm.k8s-cp-vms-cl02<span class="o">[</span>1<span class="o">]</span>: Destroying... <span class="o">[</span><span class="nv">id</span><span class="o">=</span>1002<span class="o">]</span>
</span></span><span class="line"><span class="cl">proxmox_virtual_environment_vm.k8s-cp-vms-cl02<span class="o">[</span>2<span class="o">]</span>: Destroying... <span class="o">[</span><span class="nv">id</span><span class="o">=</span>1003<span class="o">]</span>
</span></span><span class="line"><span class="cl">proxmox_virtual_environment_vm.k8s-worker-vms-cl02<span class="o">[</span>0<span class="o">]</span>: Destroying... <span class="o">[</span><span class="nv">id</span><span class="o">=</span>1005<span class="o">]</span>
</span></span><span class="line"><span class="cl">proxmox_virtual_environment_vm.k8s-worker-vms-cl02<span class="o">[</span>2<span class="o">]</span>: Destroying... <span class="o">[</span><span class="nv">id</span><span class="o">=</span>1007<span class="o">]</span>
</span></span><span class="line"><span class="cl">proxmox_virtual_environment_vm.k8s-worker-vms-cl02<span class="o">[</span>1<span class="o">]</span>: Destroying... <span class="o">[</span><span class="nv">id</span><span class="o">=</span>1006<span class="o">]</span>
</span></span><span class="line"><span class="cl">proxmox_virtual_environment_vm.k8s-cp-vms-cl02<span class="o">[</span>0<span class="o">]</span>: Destroying... <span class="o">[</span><span class="nv">id</span><span class="o">=</span>1001<span class="o">]</span>
</span></span><span class="line"><span class="cl">proxmox_virtual_environment_vm.k8s-worker-vms-cl02<span class="o">[</span>0<span class="o">]</span>: Destruction <span class="nb">complete</span> after 7s
</span></span><span class="line"><span class="cl">proxmox_virtual_environment_vm.k8s-worker-vms-cl02<span class="o">[</span>2<span class="o">]</span>: Destruction <span class="nb">complete</span> after 7s
</span></span><span class="line"><span class="cl">proxmox_virtual_environment_vm.k8s-worker-vms-cl02<span class="o">[</span>1<span class="o">]</span>: Destruction <span class="nb">complete</span> after 9s
</span></span><span class="line"><span class="cl">proxmox_virtual_environment_vm.k8s-cp-vms-cl02<span class="o">[</span>1<span class="o">]</span>: Still destroying... <span class="o">[</span><span class="nv">id</span><span class="o">=</span>1002, 10s elapsed<span class="o">]</span>
</span></span><span class="line"><span class="cl">proxmox_virtual_environment_vm.k8s-cp-vms-cl02<span class="o">[</span>2<span class="o">]</span>: Still destroying... <span class="o">[</span><span class="nv">id</span><span class="o">=</span>1003, 10s elapsed<span class="o">]</span>
</span></span><span class="line"><span class="cl">proxmox_virtual_environment_vm.k8s-cp-vms-cl02<span class="o">[</span>0<span class="o">]</span>: Still destroying... <span class="o">[</span><span class="nv">id</span><span class="o">=</span>1001, 10s elapsed<span class="o">]</span>
</span></span><span class="line"><span class="cl">proxmox_virtual_environment_vm.k8s-cp-vms-cl02<span class="o">[</span>0<span class="o">]</span>: Destruction <span class="nb">complete</span> after 12s
</span></span><span class="line"><span class="cl">proxmox_virtual_environment_vm.k8s-cp-vms-cl02<span class="o">[</span>1<span class="o">]</span>: Still destroying... <span class="o">[</span><span class="nv">id</span><span class="o">=</span>1002, 20s elapsed<span class="o">]</span>
</span></span><span class="line"><span class="cl">proxmox_virtual_environment_vm.k8s-cp-vms-cl02<span class="o">[</span>2<span class="o">]</span>: Still destroying... <span class="o">[</span><span class="nv">id</span><span class="o">=</span>1003, 20s elapsed<span class="o">]</span>
</span></span><span class="line"><span class="cl">proxmox_virtual_environment_vm.k8s-cp-vms-cl02<span class="o">[</span>1<span class="o">]</span>: Still destroying... <span class="o">[</span><span class="nv">id</span><span class="o">=</span>1002, 30s elapsed<span class="o">]</span>
</span></span><span class="line"><span class="cl">proxmox_virtual_environment_vm.k8s-cp-vms-cl02<span class="o">[</span>2<span class="o">]</span>: Still destroying... <span class="o">[</span><span class="nv">id</span><span class="o">=</span>1003, 30s elapsed<span class="o">]</span>
</span></span><span class="line"><span class="cl">proxmox_virtual_environment_vm.k8s-cp-vms-cl02<span class="o">[</span>1<span class="o">]</span>: Still destroying... <span class="o">[</span><span class="nv">id</span><span class="o">=</span>1002, 40s elapsed<span class="o">]</span>
</span></span><span class="line"><span class="cl">proxmox_virtual_environment_vm.k8s-cp-vms-cl02<span class="o">[</span>2<span class="o">]</span>: Still destroying... <span class="o">[</span><span class="nv">id</span><span class="o">=</span>1003, 40s elapsed<span class="o">]</span>
</span></span><span class="line"><span class="cl">proxmox_virtual_environment_vm.k8s-cp-vms-cl02<span class="o">[</span>1<span class="o">]</span>: Still destroying... <span class="o">[</span><span class="nv">id</span><span class="o">=</span>1002, 50s elapsed<span class="o">]</span>
</span></span><span class="line"><span class="cl">proxmox_virtual_environment_vm.k8s-cp-vms-cl02<span class="o">[</span>2<span class="o">]</span>: Still destroying... <span class="o">[</span><span class="nv">id</span><span class="o">=</span>1003, 50s elapsed<span class="o">]</span>
</span></span><span class="line"><span class="cl">proxmox_virtual_environment_vm.k8s-cp-vms-cl02<span class="o">[</span>1<span class="o">]</span>: Still destroying... <span class="o">[</span><span class="nv">id</span><span class="o">=</span>1002, 1m0s elapsed<span class="o">]</span>
</span></span><span class="line"><span class="cl">proxmox_virtual_environment_vm.k8s-cp-vms-cl02<span class="o">[</span>2<span class="o">]</span>: Still destroying... <span class="o">[</span><span class="nv">id</span><span class="o">=</span>1003, 1m0s elapsed<span class="o">]</span>
</span></span><span class="line"><span class="cl">proxmox_virtual_environment_vm.k8s-cp-vms-cl02<span class="o">[</span>1<span class="o">]</span>: Still destroying... <span class="o">[</span><span class="nv">id</span><span class="o">=</span>1002, 1m10s elapsed<span class="o">]</span>
</span></span><span class="line"><span class="cl">proxmox_virtual_environment_vm.k8s-cp-vms-cl02<span class="o">[</span>2<span class="o">]</span>: Still destroying... <span class="o">[</span><span class="nv">id</span><span class="o">=</span>1003, 1m10s elapsed<span class="o">]</span>
</span></span><span class="line"><span class="cl">proxmox_virtual_environment_vm.k8s-cp-vms-cl02<span class="o">[</span>1<span class="o">]</span>: Still destroying... <span class="o">[</span><span class="nv">id</span><span class="o">=</span>1002, 1m20s elapsed<span class="o">]</span>
</span></span><span class="line"><span class="cl">proxmox_virtual_environment_vm.k8s-cp-vms-cl02<span class="o">[</span>2<span class="o">]</span>: Still destroying... <span class="o">[</span><span class="nv">id</span><span class="o">=</span>1003, 1m20s elapsed<span class="o">]</span>
</span></span><span class="line"><span class="cl">proxmox_virtual_environment_vm.k8s-cp-vms-cl02<span class="o">[</span>1<span class="o">]</span>: Still destroying... <span class="o">[</span><span class="nv">id</span><span class="o">=</span>1002, 1m30s elapsed<span class="o">]</span>
</span></span><span class="line"><span class="cl">proxmox_virtual_environment_vm.k8s-cp-vms-cl02<span class="o">[</span>2<span class="o">]</span>: Still destroying... <span class="o">[</span><span class="nv">id</span><span class="o">=</span>1003, 1m30s elapsed<span class="o">]</span>
</span></span><span class="line"><span class="cl">proxmox_virtual_environment_vm.k8s-cp-vms-cl02<span class="o">[</span>1<span class="o">]</span>: Destruction <span class="nb">complete</span> after 1m37s
</span></span><span class="line"><span class="cl">proxmox_virtual_environment_vm.k8s-cp-vms-cl02<span class="o">[</span>2<span class="o">]</span>: Destruction <span class="nb">complete</span> after 1m37s
</span></span><span class="line"><span class="cl">proxmox_virtual_environment_file.ubuntu_cloud_init: Destroying... <span class="o">[</span><span class="nv">id</span><span class="o">=</span>local:snippets/ubuntu.cloud-config.yaml<span class="o">]</span>
</span></span><span class="line"><span class="cl">proxmox_virtual_environment_file.ubuntu_cloud_init: Destruction <span class="nb">complete</span> after 0s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Destroy complete! Resources: <span class="m">9</span> destroyed.
</span></span></code></pre></div><p>Now all the VMs, everything that has been deployed with OpenTofu is gone again. And it takes a couple of seconds or minutes depending on whether I have configured the provider to do a shutdown or stop of the VMs on <em>tofu destroy</em>. I am currently using shutdown.</p>


<h2 class="relative group">Preparing a bunch of hosts for Rancher RKE2 clusters 
    <div id="preparing-a-bunch-of-hosts-for-rancher-rke2-clusters" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#preparing-a-bunch-of-hosts-for-rancher-rke2-clusters" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>I decided to give Rancher a run in another post (post this post) and discovered I needed to solve hostnames in the VMs being created. RKE2 requires all nodes have unique hostnames, see <a href="https://docs.rke2.io/install/requirements" target="_blank">here</a> Kubespray took care of that for me above, but if I just wanted to deploy a bunch of VMs with nothing more than the OS itself deployed, that means only provisioned using OpenTofu, I needed some way to also update the hostname inside the VMs also. Below is two updated resource that handles this for me. So now I can just deploy as many VMs I want, hostname is being taken care of by the OpenTofu deployment, and I can just hand them to Rancher to create my RKE2 clusters on.</p>


<h3 class="relative group">Proxmox VM resource 
    <div id="proxmox-vm-resource" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#proxmox-vm-resource" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="l">resource &#34;proxmox_virtual_environment_vm&#34; &#34;rke2-cp-vms-cl01&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">count       = 3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">name        = &#34;rke2-cp-vm-${count.index + 1}-cl-01&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">description = &#34;Managed by Terraform&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">tags        = [&#34;terraform&#34;, &#34;ubuntu&#34;, &#34;k8s-cp&#34;]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">timeout_clone = 180</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">timeout_create = 180</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">timeout_migrate = 180</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">timeout_reboot = 180</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">timeout_shutdown_vm = 180</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">timeout_start_vm = 180</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">timeout_stop_vm = 180</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">node_name = &#34;proxmox-02&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">vm_id     = &#34;102${count.index + 1}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">cpu {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">cores = 4</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">type = &#34;host&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">memory {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">dedicated = 6144</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">agent {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># read &#39;Qemu guest agent&#39; section, change to true only when ready</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">enabled = true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">startup {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">order      = &#34;3&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">up_delay   = &#34;60&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">down_delay = &#34;60&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">disk {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">datastore_id = &#34;raid-10-node02&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">file_id      = &#34;local:iso/jammy-server-cloudimg-amd64.img&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">interface    = &#34;virtio0&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">iothread     = true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">discard      = &#34;on&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">size         = 40</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">file_format  = &#34;raw&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">initialization {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">dns {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="l">servers = [&#34;10.100.1.7&#34;, &#34;10.100.1.6&#34;]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="l">domain = &#34;my-domain.net&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">ip_config {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="l">ipv4 {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="l">address = &#34;10.170.0.1${count.index + 1}/24&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="l">gateway = &#34;10.170.0.1&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">datastore_id = &#34;raid-10-node02&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">user_data_file_id = proxmox_virtual_environment_file.rke2-cp-vms-cl01[count.index].id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">network_device {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">bridge = &#34;vmbr0&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">vlan_id = &#34;217&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">operating_system {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">type = &#34;l26&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">keyboard_layout = &#34;no&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">lifecycle {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">ignore_changes = [</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="l">network_device,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">depends_on = [proxmox_virtual_environment_file.rke2-cp-vms-cl01]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">resource &#34;proxmox_virtual_environment_vm&#34; &#34;rke2-worker-vms-cl01&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">count       = 3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">name        = &#34;rke2-node-vm-${count.index + 1}-cl-01&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">description = &#34;Managed by Terraform&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">tags        = [&#34;terraform&#34;, &#34;ubuntu&#34;, &#34;k8s-node&#34;]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">node_name = &#34;proxmox-02&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">vm_id     = &#34;102${count.index + 5}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">timeout_clone = 180</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">timeout_create = 180</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">timeout_migrate = 180</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">timeout_reboot = 180</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">timeout_shutdown_vm = 180</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">timeout_start_vm = 180</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">timeout_stop_vm = 180</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">cpu {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">cores = 4</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">type = &#34;host&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">memory {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">dedicated = 6144</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">agent {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># read &#39;Qemu guest agent&#39; section, change to true only when ready</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">enabled = true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">startup {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">order      = &#34;3&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">up_delay   = &#34;60&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">down_delay = &#34;60&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">disk {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">datastore_id = &#34;raid-10-node02&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">file_id      = &#34;local:iso/jammy-server-cloudimg-amd64.img&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">interface    = &#34;virtio0&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">iothread     = true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">discard      = &#34;on&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">size         = 60</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">file_format  = &#34;raw&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">initialization {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">dns {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="l">servers = [&#34;10.100.1.7&#34;, &#34;10.100.1.6&#34;]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="l">domain = &#34;my-domain.net&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">ip_config {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="l">ipv4 {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="l">address = &#34;10.170.0.1${count.index + 5}/24&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="l">gateway = &#34;10.170.0.1&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">datastore_id = &#34;raid-10-node02&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">user_data_file_id = proxmox_virtual_environment_file.rke2-worker-vms-cl01[count.index].id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">network_device {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">bridge = &#34;vmbr0&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">vlan_id = &#34;217&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">operating_system {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">type = &#34;l26&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">keyboard_layout = &#34;no&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">lifecycle {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">ignore_changes = [</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="l">network_device,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">depends_on = [proxmox_virtual_environment_file.rke2-worker-vms-cl01]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">resource &#34;null_resource&#34; &#34;rke2-cp-vms-cl01&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">count = 3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">provisioner &#34;remote-exec&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">inline = [&#34;sudo hostnamectl set-hostname rke2-cp-vm-${count.index + 1}-cl-01.my-domain.net&#34;]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">connection {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="l">type        = &#34;ssh&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="l">user        = &#34;ubuntu&#34; </span><span class="w"> </span><span class="c"># or another user</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="l">private_key = file(&#34;${var.private_key_path}&#34;)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">host        = element([for ip in flatten(proxmox_virtual_environment_vm.rke2-cp-vms-cl01[count.index].ipv4_addresses) </span><span class="p">:</span><span class="w"> </span><span class="l">ip if ip != &#34;127.0.0.1&#34;], 0)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">depends_on = [proxmox_virtual_environment_vm.rke2-cp-vms-cl01]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">resource &#34;null_resource&#34; &#34;rke2-worker-vms-cl01&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">count = 3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">provisioner &#34;remote-exec&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">inline = [&#34;sudo hostnamectl set-hostname rke2-node-vm-${count.index + 1}-cl-01.my-domain.net&#34;]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">connection {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="l">type        = &#34;ssh&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="l">user        = &#34;ubuntu&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="l">private_key = file(&#34;${var.private_key_path}&#34;)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">host = element([for ip in flatten(proxmox_virtual_environment_vm.rke2-worker-vms-cl01[count.index].ipv4_addresses) </span><span class="p">:</span><span class="w"> </span><span class="l">ip if ip != &#34;127.0.0.1&#34;], 0)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">depends_on = [proxmox_virtual_environment_vm.rke2-worker-vms-cl01]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">output &#34;usable_cp_vm_ipv4_addresses&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">value = [for ip in flatten(proxmox_virtual_environment_vm.rke2-cp-vms-cl01[*].ipv4_addresses) </span><span class="p">:</span><span class="w"> </span><span class="l">ip if ip != &#34;127.0.0.1&#34;]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">output &#34;usable_worker_vm_ipv4_addresses&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">value = [for ip in flatten(proxmox_virtual_environment_vm.rke2-worker-vms-cl01[*].ipv4_addresses) </span><span class="p">:</span><span class="w"> </span><span class="l">ip if ip != &#34;127.0.0.1&#34;]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span></code></pre></div><p>I have added a remote-exec resource to remotely log in to the provisioned VMs, execute the <em>hostname set-hostname</em> command. To get around cycle dependencies I had to add a &ldquo;null_resource&rdquo; before the remote-exec. I have also divided the vm resource config to separate the type of VMs from each other so I can configure them different from each other (control plane nodes and worker nodes). The two last entries was only added to verify if it could pick up the correct IP address from the VMs.</p>


<h3 class="relative group">Proxmox virtual environment file 
    <div id="proxmox-virtual-environment-file" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#proxmox-virtual-environment-file" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># CP VMs</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">resource &#34;proxmox_virtual_environment_file&#34; &#34;rke2-cp-vms-cl01&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">count = 3</span><span class="w"> </span><span class="c"># adjust pr total amount of VMs</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">content_type = &#34;snippets&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">datastore_id = &#34;local&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">node_name    = &#34;proxmox-02&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">source_raw {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">data = &lt;&lt;EOF</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#cloud-config</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">chpasswd</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">list</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">    ubuntu:ubuntu</span><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">expire</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">packages</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">qemu-guest-agent</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">timezone</span><span class="p">:</span><span class="w"> </span><span class="l">Europe/Oslo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">users</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">ubuntu</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">groups</span><span class="p">:</span><span class="w"> </span><span class="l">sudo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">shell</span><span class="p">:</span><span class="w"> </span><span class="l">/bin/bash</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ssh-authorized-keys</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">${trimspace(&#34;ssh-rsa E8lMzi2QtaV6FbEGQG41sKUetP4IfQ9OKQb4n3pIleyuFySijxWS37krexsd9E2rkJFjz0rhh1idWb4vfzQH15lsBIaA1JpcYTqJWp6QwJ8oV2psQUi/knwVNfn3EckKrkNsGwUw6+d&#34;)}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">sudo</span><span class="p">:</span><span class="w"> </span><span class="l">ALL=(ALL) NOPASSWD:ALL</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">power_state</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">delay</span><span class="p">:</span><span class="w"> </span><span class="l">now</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l">reboot</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">message</span><span class="p">:</span><span class="w"> </span><span class="l">Rebooting after cloud-init completion</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">condition</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">EOF</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">file_name = &#34;rke2-cp-vms-${count.index + 1}-cl01.yaml&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># Node VMs</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">resource &#34;proxmox_virtual_environment_file&#34; &#34;rke2-worker-vms-cl01&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">count = 3</span><span class="w"> </span><span class="c"># adjust pr total amount of VMs</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">content_type = &#34;snippets&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">datastore_id = &#34;local&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">node_name    = &#34;proxmox-02&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">source_raw {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">data = &lt;&lt;EOF</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#cloud-config</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">chpasswd</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">list</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">    ubuntu:ubuntu</span><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">expire</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">packages</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">qemu-guest-agent</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">timezone</span><span class="p">:</span><span class="w"> </span><span class="l">Europe/Oslo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">users</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">ubuntu</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">groups</span><span class="p">:</span><span class="w"> </span><span class="l">sudo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">shell</span><span class="p">:</span><span class="w"> </span><span class="l">/bin/bash</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ssh-authorized-keys</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">${trimspace(&#34;ssh-rsa AAAAB3NxTSy6hioyUwiRpVUKYDf9zsU4P87zIqasRHMPfoj2PI0YCPihDpQj/e0VtkQaBhyfLoFuLa+zTEDjR5nYt1P0MRWPRuOxY/ls04VCpVvA9mUSYF8ftAXf2SXRY7sqQE3dg4Bav7FdHe1labQH4logd1N5ra9PS+bVGcBDstSH/t7Zkf/Na1EMqN75M5PKiFzHpde7xFnvaRbcVdzr64xTXP2vVj+jTlcMBRAoJQHIO4703jy3Ma2fJbYxipSsl1TGDgUFxf3rDjW/gKOWQhbCVheDMGC94&#34;)}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">sudo</span><span class="p">:</span><span class="w"> </span><span class="l">ALL=(ALL) NOPASSWD:ALL</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">power_state</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">delay</span><span class="p">:</span><span class="w"> </span><span class="l">now</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l">reboot</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">message</span><span class="p">:</span><span class="w"> </span><span class="l">Rebooting after cloud-init completion</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">condition</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">EOF</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">file_name = &#34;rke2-worker-vms-${count.index + 1}-cl01.yaml&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span></code></pre></div><p>In the cloud init environment resource I have also added to entries to separate the control plane nodes from the worker nodes so I can easier configure them differently. Every file_name created will accomodate the actual name of the node it belongs to. So the Proxmox snippets being created will now be 1 snippet pr VM created. They will be removed when the project is deleted by <em>tofu destroy</em>.</p>


<h2 class="relative group">Summary 
    <div id="summary" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#summary" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>There is so much more that can be adjusted, improved and explored in general. But this post is just how I have done it now to solve a task I have been waiting to finally get some time to do. I will maybe do a follow up post where I do some improvements after some time using it and gained more experience on it. This includes improving the OpenTofu configs and Kubespray.</p>

          
          
          
        </div>
        
        

        
        
  
  <section class="flex flex-row flex-wrap justify-center pt-4 text-xl">
    
      
      <a
      target="_blank"
      class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800"
      href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://blog.andreasm.io/2024/01/15/proxmox-with-opentofu-kubespray-and-kubernetes/&amp;title=Proxmox%20with%20OpenTofu%20Kubespray%20and%20Kubernetes"
      title="Share on LinkedIn"
      aria-label="Share on LinkedIn"
      >
      

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg>

  </span>


    </a>
      
    
      
      <a
      target="_blank"
      class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800"
      href="https://twitter.com/intent/tweet/?url=https://blog.andreasm.io/2024/01/15/proxmox-with-opentofu-kubespray-and-kubernetes/&amp;text=Proxmox%20with%20OpenTofu%20Kubespray%20and%20Kubernetes"
      title="Tweet on Twitter"
      aria-label="Tweet on Twitter"
      >
      

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8L200.7 275.5 26.8 48H172.4L272.9 180.9 389.2 48zM364.4 421.8h39.1L151.1 88h-42L364.4 421.8z"/></svg>
  </span>


    </a>
      
    
      
      <a
      target="_blank"
      class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800"
      href="https://s2f.kytta.dev/?text=Proxmox%20with%20OpenTofu%20Kubespray%20and%20Kubernetes%20https://blog.andreasm.io/2024/01/15/proxmox-with-opentofu-kubespray-and-kubernetes/"
      title=""
      aria-label=""
      >
      

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48 0 0 0-63.72 28.5-63.72 125.7 0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54 0 0 1-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"/></svg>

  </span>


    </a>
      
    
      
      <a
      target="_blank"
      class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800"
      href="mailto:?body=https://blog.andreasm.io/2024/01/15/proxmox-with-opentofu-kubespray-and-kubernetes/&amp;subject=Proxmox%20with%20OpenTofu%20Kubespray%20and%20Kubernetes"
      title="Send via email"
      aria-label="Send via email"
      >
      

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M207.8 20.73c-93.45 18.32-168.7 93.66-187 187.1c-27.64 140.9 68.65 266.2 199.1 285.1c19.01 2.888 36.17-12.26 36.17-31.49l.0001-.6631c0-15.74-11.44-28.88-26.84-31.24c-84.35-12.98-149.2-86.13-149.2-174.2c0-102.9 88.61-185.5 193.4-175.4c91.54 8.869 158.6 91.25 158.6 183.2l0 16.16c0 22.09-17.94 40.05-40 40.05s-40.01-17.96-40.01-40.05v-120.1c0-8.847-7.161-16.02-16.01-16.02l-31.98 .0036c-7.299 0-13.2 4.992-15.12 11.68c-24.85-12.15-54.24-16.38-86.06-5.106c-38.75 13.73-68.12 48.91-73.72 89.64c-9.483 69.01 43.81 128 110.9 128c26.44 0 50.43-9.544 69.59-24.88c24 31.3 65.23 48.69 109.4 37.49C465.2 369.3 496 324.1 495.1 277.2V256.3C495.1 107.1 361.2-9.332 207.8 20.73zM239.1 304.3c-26.47 0-48-21.56-48-48.05s21.53-48.05 48-48.05s48 21.56 48 48.05S266.5 304.3 239.1 304.3z"/></svg>

  </span>


    </a>
      
    
  </section>


        


<h2 class="mt-8 text-2xl font-extrabold mb-10">Related</h2>
<section class="w-full grid gap-4 sm:grid-cols-2 md:grid-cols-3">
  
  

  <a href="/2024/02/04/argo-cd-vsphere-with-tanzu/" class="min-w-full">
    
    <div class="min-h-full border border-neutral-200 dark:border-neutral-700 border-2 rounded overflow-hidden shadow-2xl relative">
        
        <div class="w-full thumbnail_card_related nozoom" style="background-image:url(/2024/02/04/argo-cd-vsphere-with-tanzu/feature-argocd.png);"></div>
        
      

      <div class="px-6 py-4">

        
        <div class="font-bold text-xl text-neutral-800 decoration-primary-500 hover:underline hover:underline-offset-2 dark:text-neutral"
          href="/2024/02/04/argo-cd-vsphere-with-tanzu/">Argo CD & vSphere with Tanzu</div>
        

        <div class="text-sm text-neutral-500 dark:text-neutral-400">
          











  





  



  













<div class="flex flex-row flex-wrap items-center">
  
  
  <time datetime="2024-02-04T11:28:21&#43;01:00">4 February 2024</time><span class="px-2 text-primary-500">&middot;</span><span>4554 words</span><span class="px-2 text-primary-500">&middot;</span><span title="Reading time">22 mins</span>
  

  
  
</div>


<div class="flex flex-row flex-wrap items-center">
  
  
  
  
  
  
  
  
  
  
  
</div>




<div class="flex flex-row flex-wrap items-center">
  
  
  
  
  
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/kubernetes/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Kubernetes
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/tanzu/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Tanzu
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/argocd/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    ArgoCD
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/avi/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    AVI
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/vsphere/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    VSphere
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/gitops/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Gitops
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/automation/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Automation
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/antrea/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Antrea
  </span>
</span>
  </span>
  
  
  
  
  
  
  
  
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/kubernetes/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Kubernetes
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/gitops/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Gitops
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/argocd/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Argocd
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/vsphere/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Vsphere
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/tanzu/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Tanzu
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/ako/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Ako
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/avi/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Avi
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/antrea/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Antrea
  </span>
</span>
  </span>
  
  
  
  
</div>




        </div>

        
        <div class="py-1 prose dark:prose-invert">
          In this post I am using ArgoCD bootstrapping Tanzu Kubernetes Clusters with AKO and Antrea configs
        </div>
        
      </div>
      <div class="px-6 pt-4 pb-2">

      </div>
    </div>
  </a>

  
  

  <a href="/2024/04/16/exploring-some-antrea-features/" class="min-w-full">
    
    <div class="min-h-full border border-neutral-200 dark:border-neutral-700 border-2 rounded overflow-hidden shadow-2xl relative">
        
        <div class="w-full thumbnail_card_related nozoom" style="background-image:url(/2024/04/16/exploring-some-antrea-features/feature-antrea-1.png);"></div>
        
      

      <div class="px-6 py-4">

        
        <div class="font-bold text-xl text-neutral-800 decoration-primary-500 hover:underline hover:underline-offset-2 dark:text-neutral"
          href="/2024/04/16/exploring-some-antrea-features/">Exploring some Antrea Features</div>
        

        <div class="text-sm text-neutral-500 dark:text-neutral-400">
          











  





  



  













<div class="flex flex-row flex-wrap items-center">
  
  
  <time datetime="2024-04-16T09:25:28&#43;02:00">16 April 2024</time><span class="px-2 text-primary-500">&middot;</span><span>6097 words</span><span class="px-2 text-primary-500">&middot;</span><span title="Reading time">29 mins</span>
  

  
  
</div>


<div class="flex flex-row flex-wrap items-center">
  
  
  
  
  
  
  
  
  
  
  
</div>




<div class="flex flex-row flex-wrap items-center">
  
  
  
  
  
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/kubernetes/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Kubernetes
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/cni/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    CNI
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/antrea/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Antrea
  </span>
</span>
  </span>
  
  
  
  
  
  
  
  
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/antrea/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Antrea
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/kubernetes/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Kubernetes
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/cni/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Cni
  </span>
</span>
  </span>
  
  
  
  
</div>




        </div>

        
        <div class="py-1 prose dark:prose-invert">
          In this post I will go through a couple of Antrea features I find interesting, some new features and some older features
        </div>
        
      </div>
      <div class="px-6 pt-4 pb-2">

      </div>
    </div>
  </a>

  
  

  <a href="/2024/04/08/vsphere-with-tanzu-avi-and-multiple-supervisors/" class="min-w-full">
    
    <div class="min-h-full border border-neutral-200 dark:border-neutral-700 border-2 rounded overflow-hidden shadow-2xl relative">
        
        <div class="w-full thumbnail_card_related nozoom" style="background-image:url(/2024/04/08/vsphere-with-tanzu-avi-and-multiple-supervisors/feature-vmware_by_broadcom.png);"></div>
        
      

      <div class="px-6 py-4">

        
        <div class="font-bold text-xl text-neutral-800 decoration-primary-500 hover:underline hover:underline-offset-2 dark:text-neutral"
          href="/2024/04/08/vsphere-with-tanzu-avi-and-multiple-supervisors/">vSphere with Tanzu - Avi and Multiple Supervisors</div>
        

        <div class="text-sm text-neutral-500 dark:text-neutral-400">
          











  





  



  













<div class="flex flex-row flex-wrap items-center">
  
  
  <time datetime="2024-04-08T14:56:56&#43;02:00">8 April 2024</time><span class="px-2 text-primary-500">&middot;</span><span>1632 words</span><span class="px-2 text-primary-500">&middot;</span><span title="Reading time">8 mins</span>
  

  
  
</div>


<div class="flex flex-row flex-wrap items-center">
  
  
  
  
  
  
  
  
  
  
  
</div>




<div class="flex flex-row flex-wrap items-center">
  
  
  
  
  
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/kubernetes/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Kubernetes
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/tanzu/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Tanzu
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/nsx/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    NSX
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/avi/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    AVI
  </span>
</span>
  </span>
  
  
  
  
  
  
  
  
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/kubernetes/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Kubernetes
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/loadbalancing/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Loadbalancing
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/networking/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Networking
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/avi/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Avi
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/nsx/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Nsx
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/multi-tenancy/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Multi-Tenancy
  </span>
</span>
  </span>
  
  
  
  
</div>




        </div>

        
        <div class="py-1 prose dark:prose-invert">
          In this post I will try to describe how to use the new NSX and Avi together integration in vSphere with Tanzu in combination with several Supervisor clusters using only 1 NSX manager cluster and 1 Avi controller cluster
        </div>
        
      </div>
      <div class="px-6 pt-4 pb-2">

      </div>
    </div>
  </a>

  
</section>

  
      </div>
     
      
      
        
        
          
          
        
      <script>
        var oid = "views_posts\/2024-01-15-proxmox-opentofu-ansible-and-kubernetes\/index.md"
        var oid_likes = "likes_posts\/2024-01-15-proxmox-opentofu-ansible-and-kubernetes\/index.md"
      </script>
      
      
      <script type="text/javascript" src="/js/page.min.0860cf4e04fa2d72cc33ddba263083464d48f67de06114529043cb4623319efed4f484fd7f1730df5abea0e2da6f3538855634081d02f2d6e920b956f063e823.js" integrity="sha512-CGDPTgT6LXLMM926JjCDRk1I9n3gYRRSkEPLRiMxnv7U9IT9fxcw31q&#43;oOLabzU4hVY0CB0C8tbpILlW8GPoIw=="></script>
      
  
    </section>
  <footer class="pt-8 max-w-prose print:hidden">

    
  
    
    
    
    <div class="pt-8">
      <hr class="border-dotted border-neutral-300 dark:border-neutral-600" />
      <div class="flex justify-between pt-3">
        <span>
          
            <a class="flex group mr-3" href="/2023/12/26/traefik-proxy-in-kubernetes/">
              <span
                class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400"
                >&larr;</span
              >
              <span
                class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400"
                >&rarr;</span
              >
              <span class="flex flex-col">
                <span
                  class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500"
                  >Traefik Proxy in Kubernetes</span
                >
                <span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400">
                  
                    <time datetime="2023-12-26T20:31:45&#43;01:00">26 December 2023</time>
                  
                </span>
              </span>
            </a>
          
        </span>
        <span>
          
            <a class="flex text-right group ml-3" href="/2024/02/04/argo-cd-vsphere-with-tanzu/">
              <span class="flex flex-col">
                <span
                  class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500"
                  >Argo CD & vSphere with Tanzu</span
                >
                <span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400">
                  
                    <time datetime="2024-02-04T11:28:21&#43;01:00">4 February 2024</time>
                  
                </span>
              </span>
              <span
                class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400"
                >&rarr;</span
              >
              <span
                class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400"
                >&larr;</span
              >
            </a>
          
        </span>
      </div>
    </div>
  


    
  </footer>
</article>

      <div id="top-scroller" class="pointer-events-none absolute top-[110vh] bottom-0 w-12 ltr:right-0 rtl:left-0">
  <a href="#the-top"
    class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 mb-16 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400"
    aria-label="Scroll to top" title="Scroll to top">
    &uarr;
  </a>
</div>
    </main><footer id="site-footer" class="py-10 print:hidden">
  
  
    
    <nav class="flex flex-row pb-4 text-base font-medium text-neutral-500 dark:text-neutral-400">
      <ul class="flex flex-col list-none sm:flex-row">
        
        <li class="flex mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0">
          <a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2 flex items-center" href="/tags/"
            title="">
            
            Tags
          </a>
        </li>
        
        <li class="flex mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0">
          <a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2 flex items-center" href="/categories/"
            title="">
            
            Categories
          </a>
        </li>
        
      </ul>
    </nav>
    
  
  <div class="flex items-center justify-between">

    
    
    <p class="text-sm text-neutral-500 dark:text-neutral-400">
      &copy;
      2025
      Andreas Marqvardsen
    </p>
    

    
    
    <p class="text-xs text-neutral-500 dark:text-neutral-400">
      
      
      Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500"
        href="https://gohugo.io/" target="_blank" rel="noopener noreferrer">Hugo</a> &amp; <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500"
        href="https://blowfish.page/" target="_blank" rel="noopener noreferrer">Blowfish</a>
    </p>
    

  </div>
  <script>
    
    mediumZoom(document.querySelectorAll("img:not(.nozoom)"), {
      margin: 24,
      background: 'rgba(0,0,0,0.5)',
      scrollOffset: 0,
    })
    
  </script>
  
  
  <script type="text/javascript" src="/js/process.min.ee03488f19c93c2efb199e2e3014ea5f3cb2ce7d45154adb3399a158cac27ca52831db249ede5bb602700ef87eb02434139de0858af1818ab0fb4182472204a4.js" integrity="sha512-7gNIjxnJPC77GZ4uMBTqXzyyzn1FFUrbM5mhWMrCfKUoMdsknt5btgJwDvh&#43;sCQ0E53ghYrxgYqw&#43;0GCRyIEpA=="></script>
  
  
</footer>
<div
  id="search-wrapper"
  class="invisible fixed inset-0 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh]"
  data-url="https://blog.andreasm.io/"
  style="z-index:500"
>
  <div
    id="search-modal"
    class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"
  >
    <header class="relative z-10 flex items-center justify-between flex-none px-2">
      <form class="flex items-center flex-auto min-w-0">
        <div class="flex items-center justify-center w-8 h-8 text-neutral-400">
          

  <span class="relative block icon">
    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>

  </span>


        </div>
        <input
          type="search"
          id="search-query"
          class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent"
          placeholder="Search"
          tabindex="0"
        />
      </form>
      <button
        id="close-search-button"
        class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400"
        title="Close (Esc)"
      >
        

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75 0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3L54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75 0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75 0-45.25s32.75-12.5 45.25 0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25 0s12.5 32.75 0 45.25l-105.4 105.4L310.6 361.4z"/></svg>

  </span>


      </button>
    </header>
    <section class="flex-auto px-2 overflow-auto">
      <ul id="search-results">
        
      </ul>
    </section>
  </div>
</div>

  </div>
</body>

</html>
