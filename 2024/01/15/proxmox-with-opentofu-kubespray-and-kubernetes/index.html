
<!DOCTYPE html>
<html
  lang="en"
  data-figures=""
  
    class="page"
  
  
  
    data-mode="dim"
  >
  <head>
<title>Proxmox with OpenTofu Kubespray and Kubernetes | From 0.985mhz... to several Ghz</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-TVPYDVE8KR"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-TVPYDVE8KR');
</script>



  
<meta property="og:locale" content="en" />

<meta property="og:type" content="article">
<meta name="description" content="Automating with Terraform, Ansible and Kubespray on Proxmox" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:creator" content="">
<meta name="twitter:title" content="Proxmox with OpenTofu Kubespray and Kubernetes" />
<meta name="twitter:image" content="https://blog.andreasm.io/2024/01/15/proxmox-with-opentofu-kubespray-and-kubernetes/images/proxmox.png"/>
<meta property="og:url" content="https://blog.andreasm.io/2024/01/15/proxmox-with-opentofu-kubespray-and-kubernetes/" />
<meta property="og:title" content="Proxmox with OpenTofu Kubespray and Kubernetes" />
<meta property="og:description" content="Automating with Terraform, Ansible and Kubespray on Proxmox" />
<meta property="og:image" content="https://blog.andreasm.io/2024/01/15/proxmox-with-opentofu-kubespray-and-kubernetes/images/proxmox.png" />
  <meta name="keywords" content="nsx,vmware,kubernetes" />

<link rel="apple-touch-icon" sizes="180x180" href="https://blog.andreasm.io/icons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://blog.andreasm.io/icons/favicon-32x32.png">
<link rel="manifest" href="https://blog.andreasm.io/icons/site.webmanifest">

<link rel="canonical" href="https://blog.andreasm.io/2024/01/15/proxmox-with-opentofu-kubespray-and-kubernetes/">



<link rel="preload" href="https://blog.andreasm.io/css/styles.6c67fa3a7f5290a2facfb027358dd2bdb5450d04b8de427c8a74d79f524a7fb716b470b14b6ba95f1b7cf3aa9a2219a7294a6adeaf16a1080f432eae45d8c03c.css" integrity = "sha512-bGf6On9SkKL6z7AnNY3SvbVFDQS43kJ8inTXn1JKf7cWtHCxS2upXxt886qaIhmnKUpq3q8WoQgPQy6uRdjAPA==" as="style" crossorigin="anonymous">



<link rel="preload" href="https://blog.andreasm.io/en/js/bundle.5548d358738600c857a1f05f0459418da7143d4426c66a08bf3f15ded1b39dd2136bf104a559247a909fc4dcc45b8e06bad0870ece4c71ee5303d30550def8bd.js" as="script" integrity=
"sha512-VUjTWHOGAMhXofBfBFlBjacUPUQmxmoIvz8V3tGzndITa/EEpVkkepCfxNzEW44GutCHDs5Mce5TA9MFUN74vQ==" crossorigin="anonymous">


<link rel="stylesheet" type="text/css" href="https://blog.andreasm.io/css/styles.6c67fa3a7f5290a2facfb027358dd2bdb5450d04b8de427c8a74d79f524a7fb716b470b14b6ba95f1b7cf3aa9a2219a7294a6adeaf16a1080f432eae45d8c03c.css" integrity="sha512-bGf6On9SkKL6z7AnNY3SvbVFDQS43kJ8inTXn1JKf7cWtHCxS2upXxt886qaIhmnKUpq3q8WoQgPQy6uRdjAPA==" crossorigin="anonymous">


  </head>
  <body
    data-code="7"
    data-lines="false"
    id="documentTop"
    data-lang="en"
  >

<header class="nav_header" >
  <nav class="nav"><a href='https://blog.andreasm.io/' class="nav_brand nav_item" title="From 0.985mhz... to several Ghz">
  <img src="https://blog.andreasm.io/quote3.png" class="logo" alt="From 0.985mhz... to several Ghz">
  <div class="nav_close">
    <div><svg class="icon">
  <title>open-menu</title>
  <use xlink:href="#open-menu"></use>
</svg>
<svg class="icon">
  <title>closeme</title>
  <use xlink:href="#closeme"></use>
</svg>
</div>
  </div>
</a>

    <div class='nav_body nav_body_left'>
      
      
      
        

  <div class="nav_parent">
    <a href="https://blog.andreasm.io/" class="nav_item" title="Home">Home </a>
  </div>
  <div class="nav_parent">
    <a href="https://blog.andreasm.io/about/" class="nav_item" title="About">About </a>
  </div>
      
<div class='follow'>
<div class="color_mode">
  <input type="checkbox" class="color_choice" id="mode">
</div>

</div>

    </div>
  </nav>
</header>

    <main>
  
<div class="grid-inverse wrap content">
  <article class="post_content">
    <h1 class="post_title">Proxmox with OpenTofu Kubespray and Kubernetes</h1>
  <div class="post_meta">
    <span><svg class="icon">
  <title>calendar</title>
  <use xlink:href="#calendar"></use>
</svg>
</span>
    <span class="post_date">
      15-01-2024</span>
    <span class="post_time"> · 35 min read</span><span>&nbsp;· <a href='https://blog.andreasm.io/tags/kubernetes/' title="kubernetes" class="post_tag button button_translucent">kubernetes
        </a><a href='https://blog.andreasm.io/tags/proxmox/' title="proxmox" class="post_tag button button_translucent">proxmox
        </a><a href='https://blog.andreasm.io/tags/ansible/' title="ansible" class="post_tag button button_translucent">ansible
        </a><a href='https://blog.andreasm.io/tags/terraform/' title="terraform" class="post_tag button button_translucent">terraform
        </a><a href='https://blog.andreasm.io/tags/opentofu/' title="opentofu" class="post_tag button button_translucent">opentofu
        </a><a href='https://blog.andreasm.io/tags/kubespray/' title="kubespray" class="post_tag button button_translucent">kubespray
        </a>
    </span>
  </div>

      <div class="post_toc">
        <h2>Overview</h2>
        <nav id="TableOfContents">
  <ul>
    <li><a href="#my-lab">My lab</a></li>
    <li><a href="#provision-vms-in-proxmox-using-opentofu">Provision VMs in Proxmox using OpenTofu</a>
      <ul>
        <li><a href="#install-opentofu">Install OpenTofu</a></li>
        <li><a href="#opentofu-proxmox-provider">OpenTofu Proxmox provider</a></li>
        <li><a href="#prepare-proxmox-with-an-api-token-for-the-opentofu-bpgproxmox-provider">Prepare Proxmox with an API token for the OpenTofu bpg/proxmox provider</a></li>
        <li><a href="#opentofu-variables-and-credentials">OpenTofu variables and credentials</a></li>
      </ul>
    </li>
    <li><a href="#prepare-a-ubuntu-cloud-image---opentofu-resource">Prepare a Ubuntu cloud image - opentofu resource</a></li>
    <li><a href="#deploy-vms-using-opentofu-and-install-kubernetes-using-ansible-and-kubespray">Deploy VMs using OpenTofu and install Kubernetes using Ansible and Kubespray</a>
      <ul>
        <li><a href="#prepare-opentofu-to-deploy-my-vms">Prepare OpenTofu to deploy my VMs</a></li>
        <li><a href="#install-and-configure-kubespray">Install and configure Kubespray</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li><a href="#kubespray-vs-kopshttpskubesprayiodocscomparisonsidkubespray-vs-kops"><a href="https://kubespray.io/#/docs/comparisons?id=kubespray-vs-kops">Kubespray vs Kops</a></a></li>
    <li><a href="#kubespray-vs-kubeadmhttpskubesprayiodocscomparisonsidkubespray-vs-kubeadm"><a href="https://kubespray.io/#/docs/comparisons?id=kubespray-vs-kubeadm">Kubespray vs Kubeadm</a></a>
      <ul>
        <li><a href="#configure-opentofu-to-kick-off-kubespray">Configure OpenTofu to kick off Kubespray</a></li>
        <li><a href="#a-fully-automated-provisioning-of-kubernetes-on-proxmox-using-opentofu-ansible-and-kubespray">A fully automated provisioning of Kubernetes on Proxmox using OpenTofu, Ansible and Kubespray</a></li>
        <li><a href="#cleaning-up">Cleaning up</a></li>
      </ul>
    </li>
    <li><a href="#summary">Summary</a></li>
  </ul>
</nav>
      </div>
    
    <div class="post_body"><h1 id="i-need-a-kubernetes-cluster-again">I need a Kubernetes cluster, again</h1>
<p>I am using a lot of my spare time playing around with my lab exploring different topics. Very much of that time again is spent with Kubernetes. It has been so many times have I deployed a new Kubernetes cluster, then after some time decommissioned it again. They way I have typically done it is using a Ubuntu template I have created, cloned it, manually adjusted all clones as needed, then manually installed Kubernetes. This takes a lot of time overall and it also stops me doing certain tasks as sometimes I just think nah.. not again. Maybe another day and I do something else instead. And, when a human being is set to do a repetive task it is destined to fail at some stage, forgot a setting, why is this one vm not working as the other vms and so on.  Now the time has come to automate these tasks with the following goal in mind:</p>
<ul>
<li>Reduce deployment time to a minum</li>
<li>Eliminate human errors</li>
<li>Consistent outcome every time</li>
<li>Make it even more fun to deploy a Kubernetes cluster</li>
</ul>
<p>I have been running Home Assistant for many years, there I have a bunch of automations automating all kinds of things in my home which just makes my everyday life a bit happier. Most of these automations just work in the background doing their stuff as a good automation should. Automating my lab deployments is something I have been thinking of getting into several times, and now I decided to get this show started. So, as usual, a lot of tinkering, trial and error until I managed to get something working the way I wanted. Probably room for improvement in several areas, that is something I will most likely use my time on &quot;post&quot; this blog post. Speaking of blog post, after using some time on this I had to create a blog post on it. My goal later on is a fully automated lab from VM creation, Kubernetes runtime, and applications. And when they are decommisioned I can easily spin up everything again with persistent data etc. Lets see.</p>
<p>For now, this post will cover what I have done and configured so far to be able to automatically deploy the VMs for my Kubernetes clusters then the provisioning of Kubernetes itself.</p>
<h2 id="my-lab">My lab</h2>
<p>My lab consists of two fairly spec'ed servers with a bunch of CPU cores, a lot of RAM, and a decent amount of SSDs. In regards to network they are using 10GB ethernet. In terms of power usage they are kind of friendly to my electricity bill with my &quot;required&quot; vms running on them, but can potentially ruin that if I throw a lot of stuff at them to chew on.</p>
<img src=images/image-20240115152236095.png style="width:400px" />
<p><em>The total power usage above includes my switch, UPS and some other small devices. So its not that bad considering how much I can get out of it.</em></p>
<p>But with automation I can easily spin up some resources to be consumed for a certain period and delete again if not needed. My required VMs, that are always on, are things like Bind dns servers, PfSense, Truenas, Frigate, DCS server, a couple of linux &quot;mgmt&quot; vms,  Home Assistant, a couple of Kubernetes clusters hosting my Unifi controller, Traefik Proxy, Grafana etc.</p>
<p>For the virtualization layer on my two servers I am using Proxmox, one of the reason is that it supports PCI passthrough of my Coral TPU. I have been running Proxmox for many years and I find it to be a very decent alternative. It does what I want it to do and Proxmox has a great community!</p>
<p>Proxmox has been configured with these two servers as a cluster. I have not configured any VMs in HA, but with a Proxmox cluster I can easily migrate VMs between the hosts, even without shared storage, and single web-ui to manage both servers. To be &quot;quorate&quot; I have a cute little RPi3 with its beefy 32 GB SD card, 2GB RAM and 1GB ethernet as a <a href="https://pve.proxmox.com/wiki/Cluster_Manager#_corosync_external_vote_support">Qdevice</a></p>

<div class="notices info">
    <div class="label">Info</div>
    <p>On that note, one does not necessarily need have them in a cluster to do vm migration. I recently moved a bunch of VMs over two these two new servers and it was easy peasy using this command:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1"># executed on the source Proxmox node</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">qm remote-migrate &lt;src vm_id&gt; &lt;dst vm_id&gt; <span class="s1">&#39;apitoken=PVEAPIToken=root@pam!migrate=&lt;token&gt;,host=&lt;dst-host-ip&gt;,fingerprint=&lt;thumprint&gt;&#39;</span> --target-bridge vmbr0 --target-storage <span class="s1">&#39;raid10-node01&#39;</span> --online
</span></span></code></pre></div><p>I found this with the great help of the Proxmox community <a href="https://forum.proxmox.com/threads/framework-for-remote-migration-to-cluster-external-proxmox-ve-hosts.118444/page-2">here</a></p>

  </div>

<p>Both Proxmox servers have their own local ZFS storage. In both of them I have created a dedicated zfs pool with identical name which I use for zfs replication for some of the more &quot;critical&quot; VMs, and  as a bonus it also reduces the migration time drastically for these VMs when I move them between my servers. The &quot;cluster&quot; network (vmbr1) is directly connected 2x 10GB ethernet (not through my physical switch). The other 2x 10GB interfaces are connected to my switch for all my other network needs like VM network (vmbr0) and Proxmox management.</p>
<p>Throughout this post I will be using a dedicated linux vm for all my commands, interactions. So every time I install something, it is on this linux vm.</p>
<p>But I am digressing, enough of the intro, get on with the automation part you were supposed to write about. Got it.</p>
<p>In this post I will use the following products:</p>
<ul>
<li>Proxmox - <a href="https://www.proxmox.com/en/">homepage</a></li>
<li>Ubuntu - <a href="https://ubuntu.com/">homepage</a></li>
<li>OpenTofu - <a href="https://opentofu.org/">homepage</a></li>
<li>bpg/proxmox terraform provider - <a href="https://registry.terraform.io/providers/bpg/proxmox/latest">registry</a> and <a href="https://github.com/bpg/terraform-provider-proxmox">github</a></li>
<li>Ansible - <a href="https://www.ansible.com/community">homepage</a></li>
<li>Kubespray - <a href="https://kubespray.io/#/">homepage</a> and <a href="https://github.com/kubernetes-sigs/kubespray/tree/master">github</a></li>
</ul>
<h2 id="provision-vms-in-proxmox-using-opentofu">Provision VMs in Proxmox using OpenTofu</h2>
<p>Terraform is something I have been involved in many times in my professional work, but never had the chance to actually use it myself other than know about it, and how the solutions I work with can work together with Terraform. I did notice even the Proxmox community had several post around using Terraform, so I decided to just go with Terraform. I already knew that HashiCorp had <a href="https://www.hashicorp.com/license-faq">announced</a> their change of Terraform license from MPL to BSL and that <a href="https://opentofu.org/">OpenTofu</a> is an OpenSource fork of Terraform. So instead of basing my automations using Terraform, I will be using OpenTofu. Read more about OpenTofu <a href="https://opentofu.org/">here</a>. For now OpenTofu is Terraform &quot;compatible&quot; and uses Terraform registries, so providers etc for Terraform works with OpenTofu. You will notice that further down, all my configs will be using terraform constructs.</p>
<p>In OpenTofu/Terraform there are several concepts that one needs to know about, I will use some of them in this post like <em>providers</em>, <em>resources</em>, <em>provisioners</em> and <em>variables</em>. It is smart to read about them a bit more <a href="https://opentofu.org/docs/cli/commands/">here</a> how and why to use them.</p>
<p>To get started with OpenTofu there are some preparations do be done. Lets start with these</p>
<h3 id="install-opentofu">Install OpenTofu</h3>
<p>To get started with OpenTofu I deployed it on my linux machine using Snap, but several other alternatives is available. See more on the official OpenTofu <a href="https://opentofu.org/docs/intro/install/snap">docs</a> page.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">sudo snap install --classic opentofu
</span></span></code></pre></div><p>Now OpenTofu is installed and I can start using it. I also installed the bash autocompletion like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">tofu -install-autocomplete <span class="c1"># restart shell session...</span>
</span></span></code></pre></div><p>I decided to create a dedicated folder for my &quot;projects&quot; to live in so I have created a folder in my  home folder called *proxmox&quot; where I have different subfolders depending on certain tasks or resources I will use OpenTofu for.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">proxmox/
</span></span><span class="line"><span class="ln">2</span><span class="cl">├── k8s-cluster-02
</span></span><span class="line"><span class="ln">3</span><span class="cl">├── proxmox-images
</span></span></code></pre></div><h3 id="opentofu-proxmox-provider">OpenTofu Proxmox provider</h3>
<p>To be able to use OpenTofu with Proxmox I need a provider that can use the Proxmox API. I did some quick research on the different options out there and landed on this provider: <a href="https://registry.terraform.io/providers/bpg/proxmox">bpg/proxmox</a>. Seems very active and are recently updated (according to the git repo <a href="https://github.com/bpg/terraform-provider-proxmox">here</a>)</p>
<p>An OpenTofu/Terraform provider is being defined like this, and the example below is configured to install the bpg/proxmox provider I need to interact with Proxmox.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="l">terraform {</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">  </span><span class="l">required_providers {</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="l">proxmox = {</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">      </span><span class="l">source = &#34;bpg/proxmox&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">      </span><span class="l">version = &#34;0.43.2&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span>}<span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w"></span><span class="l">provider &#34;proxmox&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">  </span><span class="l">endpoint  = var.proxmox_api_endpoint</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">  </span><span class="l">api_token = var.proxmox_api_token</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">  </span><span class="l">insecure  = true</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">  </span><span class="l">ssh {</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">    </span><span class="l">agent    = true</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">    </span><span class="l">username = &#34;root&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span></code></pre></div><p>I will save this content in a filed called <em>providers.tf</em></p>
<p>First a short explanation of the two sections above. The <em>terraform</em> sections instructs OpenTofu/Terraform which provider to be downloaded and enabled. The <em>version</em> field defines a specific version to use, not the <em>latest</em> but this version. Using this field will make sure that your automation will not break if there is an update in the provider version that introduces some API changes.</p>
<p>The <em>provider</em> section configures the proxmox provider how it should interact with Proxmox. Instead of using a regular username and password I have opted for using API token. Here I in the endpoint and api-token keys am using a variable value that are defined in another file called variables.tf and a credentials.auto.tfvars. There are also certain tasks in my automation that requires SSH interaction with Proxmox so I have also enabled that by configuring the <em>ssh</em> field.</p>
<p>For more information on the bpg/proxmox provider, head over <a href="https://registry.terraform.io/providers/bpg/proxmox/latest/docs">here</a></p>
<h3 id="prepare-proxmox-with-an-api-token-for-the-opentofu-bpgproxmox-provider">Prepare Proxmox with an API token for the OpenTofu bpg/proxmox provider</h3>
<p>To be able to use the above configured provider with Proxmox I need to prepare Proxmox to use API token.
I followed the bpg/proxmox provider documentation <a href="https://registry.terraform.io/providers/bpg/proxmox/latest/docs#api-token-authentication">here</a></p>
<p>On my &quot;leader&quot; Proxmox node:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1"># Create the user</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">sudo pveum user add terraform@pve
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="c1"># Create a role for the user above</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">sudo pveum role add Terraform -privs <span class="s2">&#34;Datastore.Allocate Datastore.AllocateSpace Datastore.AllocateTemplate Datastore.Audit Pool.Allocate Sys.Audit Sys.Console Sys.Modify SDN.Use VM.Allocate VM.Audit VM.Clone VM.Config.CDROM VM.Config.Cloudinit VM.Config.CPU VM.Config.Disk VM.Config.HWType VM.Config.Memory VM.Config.Network VM.Config.Options VM.Migrate VM.Monitor VM.PowerMgmt User.Modify&#34;</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="c1"># Assign the terraform user to the above role</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">sudo pveum aclmod / -user terraform@pve -role Terraform
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="c1"># Create the token</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">sudo pveum user token add terraform@pve provider --privsep<span class="o">=</span><span class="m">0</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">
</span></span><span class="line"><span class="ln">10</span><span class="cl">┌──────────────┬──────────────────────────────────────┐
</span></span><span class="line"><span class="ln">11</span><span class="cl">│ key          │ value                                │
</span></span><span class="line"><span class="ln">12</span><span class="cl">╞══════════════╪══════════════════════════════════════╡
</span></span><span class="line"><span class="ln">13</span><span class="cl">│ full-tokenid │ terraform@pve!provider               │
</span></span><span class="line"><span class="ln">14</span><span class="cl">├──────────────┼──────────────────────────────────────┤
</span></span><span class="line"><span class="ln">15</span><span class="cl">│ info         │ <span class="o">{</span><span class="s2">&#34;privsep&#34;</span>:<span class="s2">&#34;0&#34;</span><span class="o">}</span>                      │
</span></span><span class="line"><span class="ln">16</span><span class="cl">├──────────────┼──────────────────────────────────────┤
</span></span><span class="line"><span class="ln">17</span><span class="cl">│ value        │ &lt;token&gt;                               │
</span></span><span class="line"><span class="ln">18</span><span class="cl">└──────────────┴──────────────────────────────────────┘
</span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="c1"># make a backup of the token</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">    
</span></span></code></pre></div><p>Now I have create the API user to be used with my bpg/proxmox provider. Though it is not sufficient as I also need to define a ssh keypair on my Linux jumphost for passwordless SSH authentication which I will need to copy to my Proxmox nodes. This is done like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@linuxmgmt01:~$ ssh-copy-id -i id_rsa.pub root@172.18.5.102 <span class="c1"># -i pointing to the pub key I want to use and specify the root user</span>
</span></span></code></pre></div><p>Now, I can log into my Proxmox node using SSH without password from my Linux jumphost. But, when used in combination with opentofu its not sufficient. I need to load the key into the keystore. If I dont do that the automations that require SSH access will fail with this error message:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">Error: failed to open SSH client: unable to authenticate user <span class="s2">&#34;root&#34;</span> over SSH to <span class="s2">&#34;172.18.5.102:22&#34;</span>. Please verify that ssh-agent is correctly loaded with an authorized key via <span class="s1">&#39;ssh-add -L&#39;</span> <span class="o">(</span>NOTE: configurations in ~/.ssh/config are not considered by golang<span class="err">&#39;</span>s ssh implementation<span class="o">)</span>. The exact error from ssh.Dial: ssh: handshake failed: ssh: unable to authenticate, attempted methods <span class="o">[</span>none password<span class="o">]</span>, no supported methods remain
</span></span></code></pre></div><p>Ah, I can just configure the .ssh/config with this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">Host 172.18.5.102
</span></span><span class="line"><span class="ln">2</span><span class="cl">    AddKeysToAgent yes
</span></span><span class="line"><span class="ln">3</span><span class="cl">    IdentityFile ~/.ssh/id_rsa
</span></span></code></pre></div><p>Nope, cant do.. Look at the error message again:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl"><span class="o">(</span>NOTE: configurations in ~/.ssh/config are not considered by golang<span class="err">&#39;</span>s ssh implementation<span class="o">)</span>
</span></span></code></pre></div><p>Ah, I can just do this then:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@linuxmgmt01:~$ <span class="nb">eval</span> <span class="sb">`</span>ssh-agent -s<span class="sb">`</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">andreasm@linuxmgmt01:~$ ssh-add id_rsa
</span></span></code></pre></div><p>Yes, but that is not persistent between sessions, so you need to do this every time you log on to your Linux jumphost again. I couldnt figure out how to do this the &quot;correct&quot; way by following the expected Golang approach so instead I went with this approach.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1"># I added this in my .bashrc file</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="k">if</span> <span class="o">[</span> -z <span class="s2">&#34;</span><span class="nv">$SSH_AUTH_SOCK</span><span class="s2">&#34;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="ln">3</span><span class="cl"> <span class="nb">eval</span> <span class="sb">`</span>ssh-agent -s<span class="sb">`</span>
</span></span><span class="line"><span class="ln">4</span><span class="cl"> ssh-add ~/.ssh/id_rsa
</span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="k">fi</span>
</span></span></code></pre></div><h3 id="opentofu-variables-and-credentials">OpenTofu variables and credentials</h3>
<p>Instead of exposing username/tokens and other information directly in my provider/resource *.tf's I can refer to them by declaring them in a <em>variables.tf</em> and credentials in a <em>credentials.auto.tfvars</em>. The <em>variables.tf</em> defines the variables to use, and the credentials.auto.tfvars maps the value to a variable. I am using this content in my variable.tf</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln">1</span><span class="cl"><span class="l">variable &#34;proxmox_api_endpoint&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w">  </span><span class="l">type = string</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w">  </span><span class="l">description = &#34;Proxmox cluster API endpoint https://proxmox-01.my-domain.net:8006&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="w"></span><span class="l">variable &#34;proxmox_api_token&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="w">  </span><span class="l">type = string</span><span class="w">
</span></span></span><span class="line"><span class="ln">8</span><span class="cl"><span class="w">  </span><span class="l">description = &#34;Proxmox API token bpg proxmox provider with ID and token&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">9</span><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span></code></pre></div><p>Then in my credentials.auto.tfvars file I have this content:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl"><span class="nv">proxmox_api_endpoint</span> <span class="o">=</span> <span class="s2">&#34;https://proxmox-01.mu-domain.net:8006&#34;</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="nv">proxmox_api_token</span> <span class="o">=</span> <span class="s2">&#34;terraform@pve!provider=&lt;token-from-earlier&gt;&#34;</span>
</span></span></code></pre></div><p>To read more about these files head over <a href="https://developer.hashicorp.com/terraform/language/values/variables">here</a>. One can also use the varible.tf to generate prompts if I have created variables being referred to in any of my resources but do not map to a value (credentials.tfvars etc..). Then it will ask you to enter a value when doing a plan or apply.</p>
<h2 id="prepare-a-ubuntu-cloud-image---opentofu-resource">Prepare a Ubuntu cloud image - opentofu resource</h2>
<p>In my automations with OpenTofu I will use a cloud image instead of a VM template in Proxmox.</p>
<p>I have been using Ubuntu as my preferred Linux distribution for many years and dont see any reason to change that now. Ubuntu/Canonical do provide cloud images and they can be found <a href="https://cloud-images.ubuntu.com/">here</a></p>
<p>But I will not download them using my browser, instead I will be using OpenTofu with the bpg/proxmox provider to download and upload them to my Proxmox nodes.</p>
<p>In my proxmox folder I have a dedicated folder for this project called <em>proxmox-images</em></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">proxmox/
</span></span><span class="line"><span class="ln">2</span><span class="cl">├── proxmox-images
</span></span></code></pre></div><p>Inside that folder I will start by creating the following files: provider.tf file, variable.tf and credentials.auto.tfvars with the content described above.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">proxmox-images/
</span></span><span class="line"><span class="ln">2</span><span class="cl">├── credentials.auto.tfvars
</span></span><span class="line"><span class="ln">3</span><span class="cl">├── provider.tf
</span></span><span class="line"><span class="ln">4</span><span class="cl">└── variables.tf
</span></span><span class="line"><span class="ln">5</span><span class="cl">
</span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="m">0</span> directories, <span class="m">3</span> files
</span></span></code></pre></div><p>But these files dont to anything other than provides the relevant information to connect and interact with Proxmox. What I need is a OpenTofu resource with a task that needs to be done. So I will prepare a file called ubuntu_cloud_image.tf with the following content:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="l">resource &#34;proxmox_virtual_environment_file&#34; &#34;ubuntu_cloud_image&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">  </span><span class="l">content_type = &#34;iso&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">  </span><span class="l">datastore_id = &#34;local&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">  </span><span class="l">node_name    = &#34;proxmox-02&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">  </span><span class="l">source_file {</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">    </span><span class="c"># you may download this image locally on your workstation and then use the local path instead of the remote URL</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">    </span><span class="l">path      = &#34;https://cloud-images.ubuntu.com/jammy/current/jammy-server-cloudimg-amd64.img&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="c"># you may also use the SHA256 checksum of the image to verify its integrity</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">    </span><span class="l">checksum = &#34;1d82c1db56e7e55e75344f1ff875b51706efe171ff55299542c29abba3a20823&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span></code></pre></div><p>What this file does is instructing OpenTofu where to grab my Ubuntu cloud image from, then upload it to my Proxmox node 2 and a specific datastore on that node. So I have defined a <em>resource</em> to define this task. More info on this <a href="https://github.com/bpg/terraform-provider-proxmox/tree/main/howtos/cloud-image">here</a>.</p>
<p>Within this same .tf file I can define several resources to download several cloud images. I could have called the file cloud-images.tf instead and just defined all the images I wanted to download/upload to Proxmox.
I have decided to keep this task as a separate project/folder.</p>
<p>When I save this file I will now have 4 files in my <em>proxmox-image</em> folder:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">proxmox-images/
</span></span><span class="line"><span class="ln">2</span><span class="cl">├── credentials.auto.tfvars
</span></span><span class="line"><span class="ln">3</span><span class="cl">├── provider.tf
</span></span><span class="line"><span class="ln">4</span><span class="cl">├── ubuntu_cloud_image.tf
</span></span><span class="line"><span class="ln">5</span><span class="cl">└── variables.tf
</span></span><span class="line"><span class="ln">6</span><span class="cl">
</span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="m">0</span> directories, <span class="m">4</span> files
</span></span></code></pre></div><p>Thats all the files I need to start my first OpenTofu task/automation.</p>
<p>Lets do a quick recap. The provider.tf instructs OpenTofu to download and enable the bpg/proxmox provider in this folder, and configure the provider to interact with my Proxmox nodes.</p>
<p>Then it is the variables.tf and the credentials.auto.tfvars that provides keys and values to be used in the provider.tf.
The ubuntu_cloud_image.tf contains the task I want OpenTofu to perform.</p>
<p>So now I am ready to execute the first OpenTofu command <em>tofu init</em>.
This command initiates OpenTofu in the respective folder <em>proxmox-images</em>, downloads and enables the provider I have configured. More info <a href="https://opentofu.org/docs/cli/commands/init">here</a>.</p>
<p>So lets try it:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">andreasm@linuxmgmt01:~/terraform/proxmox/proxmox-images$ tofu init
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">Initializing the backend...
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">Initializing provider plugins...
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">- Finding bpg/proxmox versions matching <span class="s2">&#34;0.43.2&#34;</span>...
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">- Installing bpg/proxmox v0.43.2...
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">- Installed bpg/proxmox v0.43.2 <span class="o">(</span>signed, key ID DAA1958557A27403<span class="o">)</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">
</span></span><span class="line"><span class="ln">10</span><span class="cl">Providers are signed by their developers.
</span></span><span class="line"><span class="ln">11</span><span class="cl">If you<span class="err">&#39;</span>d like to know more about provider signing, you can <span class="nb">read</span> about it here:
</span></span><span class="line"><span class="ln">12</span><span class="cl">https://opentofu.org/docs/cli/plugins/signing/
</span></span><span class="line"><span class="ln">13</span><span class="cl">
</span></span><span class="line"><span class="ln">14</span><span class="cl">OpenTofu has created a lock file .terraform.lock.hcl to record the provider
</span></span><span class="line"><span class="ln">15</span><span class="cl">selections it made above. Include this file in your version control repository
</span></span><span class="line"><span class="ln">16</span><span class="cl">so that OpenTofu can guarantee to make the same selections by default when
</span></span><span class="line"><span class="ln">17</span><span class="cl">you run <span class="s2">&#34;tofu init&#34;</span> in the future.
</span></span><span class="line"><span class="ln">18</span><span class="cl">
</span></span><span class="line"><span class="ln">19</span><span class="cl">OpenTofu has been successfully initialized!
</span></span><span class="line"><span class="ln">20</span><span class="cl">
</span></span><span class="line"><span class="ln">21</span><span class="cl">You may now begin working with OpenTofu. Try running <span class="s2">&#34;tofu plan&#34;</span> to see
</span></span><span class="line"><span class="ln">22</span><span class="cl">any changes that are required <span class="k">for</span> your infrastructure. All OpenTofu commands
</span></span><span class="line"><span class="ln">23</span><span class="cl">should now work.
</span></span><span class="line"><span class="ln">24</span><span class="cl">
</span></span><span class="line"><span class="ln">25</span><span class="cl">If you ever <span class="nb">set</span> or change modules or backend configuration <span class="k">for</span> OpenTofu,
</span></span><span class="line"><span class="ln">26</span><span class="cl">rerun this <span class="nb">command</span> to reinitialize your working directory. If you forget, other
</span></span><span class="line"><span class="ln">27</span><span class="cl">commands will detect it and remind you to <span class="k">do</span> so <span class="k">if</span> necessary.
</span></span></code></pre></div><p>Cool, now I have initialized my proxmox-image folder. Lets continue with creating a plan.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">andreasm@linuxmgmt01:~/terraform/proxmox/proxmox-images$ tofu plan -out plan
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">OpenTofu used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols:
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">  + create
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">OpenTofu will perform the following actions:
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">  <span class="c1"># proxmox_virtual_environment_file.ubuntu_cloud_image will be created</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">  + resource <span class="s2">&#34;proxmox_virtual_environment_file&#34;</span> <span class="s2">&#34;ubuntu_cloud_image&#34;</span> <span class="o">{</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">      + <span class="nv">content_type</span>           <span class="o">=</span> <span class="s2">&#34;iso&#34;</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">      + <span class="nv">datastore_id</span>           <span class="o">=</span> <span class="s2">&#34;local&#34;</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">      + <span class="nv">file_modification_date</span> <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">      + <span class="nv">file_name</span>              <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">      + <span class="nv">file_size</span>              <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">      + <span class="nv">file_tag</span>               <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">      + <span class="nv">id</span>                     <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">      + <span class="nv">node_name</span>              <span class="o">=</span> <span class="s2">&#34;proxmox-02&#34;</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">      + <span class="nv">overwrite</span>              <span class="o">=</span> <span class="nb">true</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">      + <span class="nv">timeout_upload</span>         <span class="o">=</span> <span class="m">1800</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">
</span></span><span class="line"><span class="ln">21</span><span class="cl">      + source_file <span class="o">{</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl">          + <span class="nv">changed</span>  <span class="o">=</span> <span class="nb">false</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl">          + <span class="nv">checksum</span> <span class="o">=</span> <span class="s2">&#34;1d82c1db56e7e55e75344f1ff875b51706efe171ff55299542c29abba3a20823&#34;</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl">          + <span class="nv">insecure</span> <span class="o">=</span> <span class="nb">false</span>
</span></span><span class="line"><span class="ln">25</span><span class="cl">          + <span class="nv">path</span>     <span class="o">=</span> <span class="s2">&#34;https://cloud-images.ubuntu.com/jammy/current/jammy-server-cloudimg-amd64.img&#34;</span>
</span></span><span class="line"><span class="ln">26</span><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="ln">27</span><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="ln">28</span><span class="cl">
</span></span><span class="line"><span class="ln">29</span><span class="cl">Plan: <span class="m">1</span> to add, <span class="m">0</span> to change, <span class="m">0</span> to destroy.
</span></span><span class="line"><span class="ln">30</span><span class="cl">
</span></span><span class="line"><span class="ln">31</span><span class="cl">──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
</span></span><span class="line"><span class="ln">32</span><span class="cl">
</span></span><span class="line"><span class="ln">33</span><span class="cl">Saved the plan to: plan
</span></span><span class="line"><span class="ln">34</span><span class="cl">
</span></span><span class="line"><span class="ln">35</span><span class="cl">To perform exactly these actions, run the following <span class="nb">command</span> to apply:
</span></span><span class="line"><span class="ln">36</span><span class="cl">    tofu apply <span class="s2">&#34;plan&#34;</span>
</span></span></code></pre></div><p>I am using the -out plan to just keep a record of the plan. It could be called whatever I wanted. Now OpenTofu tells me what its intention are, and if I am happy with the plan, I just need to apply it.</p>
<p>So lets apply it:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@linuxmgmt01:~/terraform/proxmox/proxmox-images$ tofu apply plan
</span></span><span class="line"><span class="ln">2</span><span class="cl">proxmox_virtual_environment_file.ubuntu_cloud_image: Creating...
</span></span><span class="line"><span class="ln">3</span><span class="cl">proxmox_virtual_environment_file.ubuntu_cloud_image: Still creating... <span class="o">[</span>10s elapsed<span class="o">]</span>
</span></span><span class="line"><span class="ln">4</span><span class="cl">proxmox_virtual_environment_file.ubuntu_cloud_image: Creation <span class="nb">complete</span> after 20s <span class="o">[</span><span class="nv">id</span><span class="o">=</span>local:iso/jammy-server-cloudimg-amd64.img<span class="o">]</span>
</span></span><span class="line"><span class="ln">5</span><span class="cl">
</span></span><span class="line"><span class="ln">6</span><span class="cl">Apply complete! Resources: <span class="m">1</span> added, <span class="m">0</span> changed, <span class="m">0</span> destroyed.
</span></span></code></pre></div><p>And after 20 seconds I have my Ubuntu cloud image uploaded to my Proxmox node (<em>jammy-server-cloudimg-amd64.img</em>):</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="jammy-server-cloud-image"
      
        class="image_figure image_internal image_processed"
        width="1022"
        height="478"
        src="/2024/01/15/proxmox-with-opentofu-kubespray-and-kubernetes/images/image-20240115202924543.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Thats great. Now I have my iso image to use for my VM deployments.</p>
<p>Next up is to deploy a bunch of VMs to be used for a Kubernetes cluster</p>
<h2 id="deploy-vms-using-opentofu-and-install-kubernetes-using-ansible-and-kubespray">Deploy VMs using OpenTofu and install Kubernetes using Ansible and Kubespray</h2>
<p>In this section I will automate everything from deploying VMs to install Kubernetes on these VMs. This task will involve OpenTofu, Ansible and Kubespray. It will deploy 6 virtual machines, with two different resource configurations. It will deploy 3 vms intended to be used as Kubernetes controlplane nodes, and 3 vms intended to be Kubernetes worker nodes. Thats the task for OpenTofu, as soon as OpenTofu has done its part it will trigger an Ansible playbook to initiate Kubespray to install Kubernetes on all my nodes. This should then end up in a fully automated task from me just executing <em>tofu apply plan</em> to a ready Kubernetes cluster.</p>
<p>I will start by creating another subfolder in my <em>proxmox</em> folder called <em>k8s-cluster-02</em>. In this folder I will reuse the following files:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">k8s-cluster-02/
</span></span><span class="line"><span class="ln">2</span><span class="cl">├── credentials.auto.tfvars
</span></span><span class="line"><span class="ln">3</span><span class="cl">├── provider.tf
</span></span><span class="line"><span class="ln">4</span><span class="cl">└── variables.tf
</span></span><span class="line"><span class="ln">5</span><span class="cl">
</span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="m">0</span> directories, <span class="m">3</span> files
</span></span></code></pre></div><p>These files I will just copy from my <em>proxmox-images</em> folder. I will also need define and add a couple of other files. When I am ready with this task I will end up with these files:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">k8s-cluster-02/
</span></span><span class="line"><span class="ln">2</span><span class="cl">├── ansible.tf
</span></span><span class="line"><span class="ln">3</span><span class="cl">├── credentials.auto.tfvars
</span></span><span class="line"><span class="ln">4</span><span class="cl">├── k8s-cluster-02.tf
</span></span><span class="line"><span class="ln">5</span><span class="cl">├── provider.tf
</span></span><span class="line"><span class="ln">6</span><span class="cl">├── ubuntu_cloud_config.tf
</span></span><span class="line"><span class="ln">7</span><span class="cl">└── variables.tf
</span></span><span class="line"><span class="ln">8</span><span class="cl">
</span></span><span class="line"><span class="ln">9</span><span class="cl"><span class="m">0</span> directories, <span class="m">7</span> files
</span></span></code></pre></div><p>I will go through all the files one by one. But there is still some preparations to be done to be able to complete this whole task.</p>
<h3 id="prepare-opentofu-to-deploy-my-vms">Prepare OpenTofu to deploy my VMs</h3>
<p>In addition to the three common files I have copied from the previous project, I will need to create two <em>proxmox_virtual_environment_vm</em> resource definitions (one for each VM type). The content of this file will be saved as <em>k8s-cluster-02.tf</em> and looks like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln">  1</span><span class="cl"><span class="l">resource &#34;proxmox_virtual_environment_vm&#34; &#34;k8s-cp-vms-cl02&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="ln">  2</span><span class="cl"><span class="w">  </span><span class="l">count       = 3</span><span class="w">
</span></span></span><span class="line"><span class="ln">  3</span><span class="cl"><span class="w">  </span><span class="l">name        = &#34;k8s-cp-vm-${count.index + 1}-cl-02&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">  4</span><span class="cl"><span class="w">  </span><span class="l">description = &#34;Managed by Terraform&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">  5</span><span class="cl"><span class="w">  </span><span class="l">tags        = [&#34;terraform&#34;, &#34;ubuntu&#34;, &#34;k8s-cp&#34;]</span><span class="w">
</span></span></span><span class="line"><span class="ln">  6</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">  7</span><span class="cl"><span class="w">  </span><span class="l">node_name = &#34;proxmox-02&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">  8</span><span class="cl"><span class="w">  </span><span class="l">vm_id     = &#34;100${count.index + 1}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">  9</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 10</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 11</span><span class="cl"><span class="w">  </span><span class="l">cpu {</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 12</span><span class="cl"><span class="w">    </span><span class="l">cores = 2</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 13</span><span class="cl"><span class="w">    </span><span class="l">type = &#34;host&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 14</span><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="ln"> 15</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 16</span><span class="cl"><span class="w">  </span><span class="l">memory {</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 17</span><span class="cl"><span class="w">    </span><span class="l">dedicated = 2048</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 18</span><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="ln"> 19</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 20</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 21</span><span class="cl"><span class="w">  </span><span class="l">agent {</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 22</span><span class="cl"><span class="w">    </span><span class="c"># read &#39;Qemu guest agent&#39; section, change to true only when ready</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 23</span><span class="cl"><span class="w">    </span><span class="l">enabled = true</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 24</span><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="ln"> 25</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 26</span><span class="cl"><span class="w">  </span><span class="l">startup {</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 27</span><span class="cl"><span class="w">    </span><span class="l">order      = &#34;3&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 28</span><span class="cl"><span class="w">    </span><span class="l">up_delay   = &#34;60&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 29</span><span class="cl"><span class="w">    </span><span class="l">down_delay = &#34;60&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 30</span><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="ln"> 31</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 32</span><span class="cl"><span class="w">  </span><span class="l">disk {</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 33</span><span class="cl"><span class="w">    </span><span class="l">datastore_id = &#34;raid-10-node02&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 34</span><span class="cl"><span class="w">    </span><span class="l">file_id      = &#34;local:iso/jammy-server-cloudimg-amd64.img&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 35</span><span class="cl"><span class="w">    </span><span class="l">interface    = &#34;virtio0&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 36</span><span class="cl"><span class="w">    </span><span class="l">iothread     = true</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 37</span><span class="cl"><span class="w">    </span><span class="l">discard      = &#34;on&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 38</span><span class="cl"><span class="w">    </span><span class="l">size         = 40</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 39</span><span class="cl"><span class="w">    </span><span class="l">file_format  = &#34;raw&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 40</span><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="ln"> 41</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 42</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 43</span><span class="cl"><span class="w">  </span><span class="l">initialization {</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 44</span><span class="cl"><span class="w">    </span><span class="l">dns {</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 45</span><span class="cl"><span class="w">      </span><span class="l">servers = [&#34;10.100.1.7&#34;, &#34;10.100.1.6&#34;]</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 46</span><span class="cl"><span class="w">      </span><span class="l">domain = &#34;my-domain.net&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 47</span><span class="cl"><span class="w">    </span>}<span class="w">
</span></span></span><span class="line"><span class="ln"> 48</span><span class="cl"><span class="w">    </span><span class="l">ip_config {</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 49</span><span class="cl"><span class="w">      </span><span class="l">ipv4 {</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 50</span><span class="cl"><span class="w">        </span><span class="l">address = &#34;10.160.1.2${count.index + 1}/24&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 51</span><span class="cl"><span class="w">        </span><span class="l">gateway = &#34;10.160.1.1&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 52</span><span class="cl"><span class="w">      </span>}<span class="w">
</span></span></span><span class="line"><span class="ln"> 53</span><span class="cl"><span class="w">    </span>}<span class="w">
</span></span></span><span class="line"><span class="ln"> 54</span><span class="cl"><span class="w">    </span><span class="l">datastore_id = &#34;raid-10-node02&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 55</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 56</span><span class="cl"><span class="w">    </span><span class="l">user_data_file_id = proxmox_virtual_environment_file.ubuntu_cloud_init.id</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 57</span><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="ln"> 58</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 59</span><span class="cl"><span class="w">  </span><span class="l">network_device {</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 60</span><span class="cl"><span class="w">    </span><span class="l">bridge = &#34;vmbr0&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 61</span><span class="cl"><span class="w">    </span><span class="l">vlan_id = &#34;216&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 62</span><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="ln"> 63</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 64</span><span class="cl"><span class="w">  </span><span class="l">operating_system {</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 65</span><span class="cl"><span class="w">    </span><span class="l">type = &#34;l26&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 66</span><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="ln"> 67</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 68</span><span class="cl"><span class="w">  </span><span class="l">keyboard_layout = &#34;no&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 69</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 70</span><span class="cl"><span class="w">  </span><span class="l">lifecycle {</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 71</span><span class="cl"><span class="w">    </span><span class="l">ignore_changes = [</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 72</span><span class="cl"><span class="w">      </span><span class="l">network_device,</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 73</span><span class="cl"><span class="w">    </span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 74</span><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="ln"> 75</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 76</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 77</span><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span><span class="line"><span class="ln"> 78</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 79</span><span class="cl"><span class="w"></span><span class="l">resource &#34;proxmox_virtual_environment_vm&#34; &#34;k8s-worker-vms-cl02&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 80</span><span class="cl"><span class="w">  </span><span class="l">count       = 3</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 81</span><span class="cl"><span class="w">  </span><span class="l">name        = &#34;k8s-node-vm-${count.index + 1}-cl-02&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 82</span><span class="cl"><span class="w">  </span><span class="l">description = &#34;Managed by Terraform&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 83</span><span class="cl"><span class="w">  </span><span class="l">tags        = [&#34;terraform&#34;, &#34;ubuntu&#34;, &#34;k8s-node&#34;]</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 84</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 85</span><span class="cl"><span class="w">  </span><span class="l">node_name = &#34;proxmox-02&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 86</span><span class="cl"><span class="w">  </span><span class="l">vm_id     = &#34;100${count.index + 5}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 87</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 88</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 89</span><span class="cl"><span class="w">  </span><span class="l">cpu {</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 90</span><span class="cl"><span class="w">    </span><span class="l">cores = 4</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 91</span><span class="cl"><span class="w">    </span><span class="l">type = &#34;host&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 92</span><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="ln"> 93</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 94</span><span class="cl"><span class="w">  </span><span class="l">memory {</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 95</span><span class="cl"><span class="w">    </span><span class="l">dedicated = 4096</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 96</span><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="ln"> 97</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 98</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 99</span><span class="cl"><span class="w">  </span><span class="l">agent {</span><span class="w">
</span></span></span><span class="line"><span class="ln">100</span><span class="cl"><span class="w">    </span><span class="c"># read &#39;Qemu guest agent&#39; section, change to true only when ready</span><span class="w">
</span></span></span><span class="line"><span class="ln">101</span><span class="cl"><span class="w">    </span><span class="l">enabled = true</span><span class="w">
</span></span></span><span class="line"><span class="ln">102</span><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="ln">103</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">104</span><span class="cl"><span class="w">  </span><span class="l">startup {</span><span class="w">
</span></span></span><span class="line"><span class="ln">105</span><span class="cl"><span class="w">    </span><span class="l">order      = &#34;3&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">106</span><span class="cl"><span class="w">    </span><span class="l">up_delay   = &#34;60&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">107</span><span class="cl"><span class="w">    </span><span class="l">down_delay = &#34;60&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">108</span><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="ln">109</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">110</span><span class="cl"><span class="w">  </span><span class="l">disk {</span><span class="w">
</span></span></span><span class="line"><span class="ln">111</span><span class="cl"><span class="w">    </span><span class="l">datastore_id = &#34;raid-10-node02&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">112</span><span class="cl"><span class="w">    </span><span class="l">file_id      = &#34;local:iso/jammy-server-cloudimg-amd64.img&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">113</span><span class="cl"><span class="w">    </span><span class="l">interface    = &#34;virtio0&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">114</span><span class="cl"><span class="w">    </span><span class="l">iothread     = true</span><span class="w">
</span></span></span><span class="line"><span class="ln">115</span><span class="cl"><span class="w">    </span><span class="l">discard      = &#34;on&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">116</span><span class="cl"><span class="w">    </span><span class="l">size         = 60</span><span class="w">
</span></span></span><span class="line"><span class="ln">117</span><span class="cl"><span class="w">    </span><span class="l">file_format  = &#34;raw&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">118</span><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="ln">119</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">120</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">121</span><span class="cl"><span class="w">  </span><span class="l">initialization {</span><span class="w">
</span></span></span><span class="line"><span class="ln">122</span><span class="cl"><span class="w">    </span><span class="l">dns {</span><span class="w">
</span></span></span><span class="line"><span class="ln">123</span><span class="cl"><span class="w">      </span><span class="l">servers = [&#34;10.100.1.7&#34;, &#34;10.100.1.6&#34;]</span><span class="w">
</span></span></span><span class="line"><span class="ln">124</span><span class="cl"><span class="w">      </span><span class="l">domain = &#34;my-domain.net&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">125</span><span class="cl"><span class="w">    </span>}<span class="w">
</span></span></span><span class="line"><span class="ln">126</span><span class="cl"><span class="w">    </span><span class="l">ip_config {</span><span class="w">
</span></span></span><span class="line"><span class="ln">127</span><span class="cl"><span class="w">      </span><span class="l">ipv4 {</span><span class="w">
</span></span></span><span class="line"><span class="ln">128</span><span class="cl"><span class="w">        </span><span class="l">address = &#34;10.160.1.2${count.index + 5}/24&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">129</span><span class="cl"><span class="w">        </span><span class="l">gateway = &#34;10.160.1.1&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">130</span><span class="cl"><span class="w">      </span>}<span class="w">
</span></span></span><span class="line"><span class="ln">131</span><span class="cl"><span class="w">    </span>}<span class="w">
</span></span></span><span class="line"><span class="ln">132</span><span class="cl"><span class="w">    </span><span class="l">datastore_id = &#34;raid-10-node02&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">133</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">134</span><span class="cl"><span class="w">    </span><span class="l">user_data_file_id = proxmox_virtual_environment_file.ubuntu_cloud_init.id</span><span class="w">
</span></span></span><span class="line"><span class="ln">135</span><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="ln">136</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">137</span><span class="cl"><span class="w">  </span><span class="l">network_device {</span><span class="w">
</span></span></span><span class="line"><span class="ln">138</span><span class="cl"><span class="w">    </span><span class="l">bridge = &#34;vmbr0&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">139</span><span class="cl"><span class="w">    </span><span class="l">vlan_id = &#34;216&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">140</span><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="ln">141</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">142</span><span class="cl"><span class="w">  </span><span class="l">operating_system {</span><span class="w">
</span></span></span><span class="line"><span class="ln">143</span><span class="cl"><span class="w">    </span><span class="l">type = &#34;l26&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">144</span><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="ln">145</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">146</span><span class="cl"><span class="w">  </span><span class="l">keyboard_layout = &#34;no&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">147</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">148</span><span class="cl"><span class="w">  </span><span class="l">lifecycle {</span><span class="w">
</span></span></span><span class="line"><span class="ln">149</span><span class="cl"><span class="w">    </span><span class="l">ignore_changes = [</span><span class="w">
</span></span></span><span class="line"><span class="ln">150</span><span class="cl"><span class="w">      </span><span class="l">network_device,</span><span class="w">
</span></span></span><span class="line"><span class="ln">151</span><span class="cl"><span class="w">    </span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="ln">152</span><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="ln">153</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">154</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">155</span><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span></code></pre></div><p>In this file I have define two <em>proxmox_virtual_environment_vm</em> resources called <em>k8s-cp-vms-cl02</em> and <em>k8s-worker-vms-cl02</em> respectively.
I am using count.index in some of the fields where I need to automatically generate an increasing number. Like IP address, VM_ID, Name. It is also referring to my Ubuntu cloud image as installation source, then a <em>user_data_file_id</em> (will be shown next) to do a simple cloud-init on the VMs.</p>
<p>Then I need to configure a <em>proxmox_virtual_environment_file</em> resource called <em>ubuntu_cloud_init</em> to trigger a cloud-init task to configure some basic initial config on my VMs.</p>
<p>This is the content of this file:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="l">resource &#34;proxmox_virtual_environment_file&#34; &#34;ubuntu_cloud_init&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">  </span><span class="l">content_type = &#34;snippets&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">  </span><span class="l">datastore_id = &#34;local&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">  </span><span class="l">node_name    = &#34;proxmox-02&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">  </span><span class="l">source_raw {</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">    </span><span class="l">data = &lt;&lt;EOF</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w"></span><span class="c">#cloud-config</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w"></span><span class="nt">chpasswd</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">  </span><span class="nt">list</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="sd">    ubuntu:ubuntu</span><span class="w">    
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">  </span><span class="nt">expire</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w"></span><span class="nt">packages</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">  </span>- <span class="l">qemu-guest-agent</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w"></span><span class="nt">timezone</span><span class="p">:</span><span class="w"> </span><span class="l">Europe/Oslo</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w"></span><span class="nt">users</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">  </span>- <span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">ubuntu</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">    </span><span class="nt">groups</span><span class="p">:</span><span class="w"> </span><span class="l">sudo</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">    </span><span class="nt">shell</span><span class="p">:</span><span class="w"> </span><span class="l">/bin/bash</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">    </span><span class="nt">ssh-authorized-keys</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">      </span>- <span class="l">${trimspace(&#34;ssh-rsa &lt;sha356&gt; user@mail.com&#34;)}</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">    </span><span class="nt">sudo</span><span class="p">:</span><span class="w"> </span><span class="l">ALL=(ALL) NOPASSWD:ALL</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w"></span><span class="nt">power_state</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w">    </span><span class="nt">delay</span><span class="p">:</span><span class="w"> </span><span class="l">now</span><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w">    </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l">reboot</span><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">    </span><span class="nt">message</span><span class="p">:</span><span class="w"> </span><span class="l">Rebooting after cloud-init completion</span><span class="w">
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w">    </span><span class="nt">condition</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="w"></span><span class="l">EOF</span><span class="w">
</span></span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="w">    </span><span class="l">file_name = &#34;ubuntu.cloud-config.yaml&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span><span class="line"><span class="ln">36</span><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span></code></pre></div><p>This will be used by all my OpenTofu deployed VMs in this task. It will install the <em>qemu-guest-agent</em>, configure a timezone, copy my Linux jumphost public key so I can log in to them using SSH without password. Then a quick reboot after all task completed to get the qemu-agent to report correctly to Proxmox.  This will be uploaded to my Proxmox server as a Snippet. For Snippets to work. One need to enable this here under Datacenter -&gt; Storage</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="snippets"
      
        class="image_figure image_internal image_processed"
        width="1960"
        height="1492"
        src="/2024/01/15/proxmox-with-opentofu-kubespray-and-kubernetes/images/image-20240115205937507.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Now I can go ahead and perform <em>tofu init</em> in this folder, but I am still not ready. I Kubernetes to be deployed also remember. For that I will use Kubespray.</p>
<h3 id="install-and-configure-kubespray">Install and configure Kubespray</h3>
<p>If you have not heard about Kubespray before, head over <a href="https://github.com/kubernetes-sigs/kubespray/tree/master">here</a> for more info. I have been following the guides from Kubespray to get it working, and its very well documented.</p>
<p>Kubespray is a really powerful way to deploy Kubernetes with a lot of options and customizations. I just want to highlight Kubespray in this section as it does a really great job in automating Kubernetes deployment.</p>
<p>A quote from the Kubespray pages:</p>
<blockquote>
<h1 id="comparisonhttpskubesprayiodocscomparisonsidcomparison"><a href="https://kubespray.io/#/docs/comparisons?id=comparison">Comparison</a></h1>
<h2 id="kubespray-vs-kopshttpskubesprayiodocscomparisonsidkubespray-vs-kops"><a href="https://kubespray.io/#/docs/comparisons?id=kubespray-vs-kops">Kubespray vs Kops</a></h2>
<p>Kubespray runs on bare metal and most clouds, using Ansible as its substrate for provisioning and orchestration. <a href="https://github.com/kubernetes/kops">Kops</a> performs the provisioning and orchestration itself, and as such is less flexible in deployment platforms. For people with familiarity with Ansible, existing Ansible deployments or the desire to run a Kubernetes cluster across multiple platforms, Kubespray is a good choice. Kops, however, is more tightly integrated with the unique features of the clouds it supports so it could be a better choice if you know that you will only be using one platform for the foreseeable future.</p>
<h2 id="kubespray-vs-kubeadmhttpskubesprayiodocscomparisonsidkubespray-vs-kubeadm"><a href="https://kubespray.io/#/docs/comparisons?id=kubespray-vs-kubeadm">Kubespray vs Kubeadm</a></h2>
<p><a href="https://github.com/kubernetes/kubeadm">Kubeadm</a> provides domain Knowledge of Kubernetes clusters' life cycle management, including self-hosted layouts, dynamic discovery services and so on. Had it belonged to the new <a href="https://coreos.com/blog/introducing-operators.html">operators world</a>, it may have been named a &quot;Kubernetes cluster operator&quot;. Kubespray however, does generic configuration management tasks from the &quot;OS operators&quot; ansible world, plus some initial K8s clustering (with networking plugins included) and control plane bootstrapping.</p>
<p>Kubespray has started using <code>kubeadm</code> internally for cluster creation since v2.3 in order to consume life cycle management domain knowledge from it and offload generic OS configuration things from it, which hopefully benefits both sides.</p>
</blockquote>
<p>On my Linux jumphost I have done the following to prepare for Kubespray</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1"># clone the Kubespray repo</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">andreasm@linuxmgmt01:~/terraform/proxmox$ git clone https://github.com/kubernetes-sigs/kubespray.git
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="c1"># kubespray folder created under my proxmox folder</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">andreasm@linuxmgmt01:~/terraform/proxmox$ ls
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">k8s-cluster-02  kubespray  proxmox-images
</span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="c1"># Python dependencies -  these I am not sure are needed but I installed them anyways.</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">sudo apt install software-properties-common
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">sudo add-apt-repository ppa:deadsnakes/ppa <span class="c1"># used this repo to get a newer Python 3 than default repo</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">sudo apt update
</span></span><span class="line"><span class="ln">10</span><span class="cl">sudo apt install python3.12 python3-pip python3-virtualenv
</span></span></code></pre></div><p>Don't try to install Ansible in the systemwide, it will not work. Follow the Kubespray documentation to install ansible in a Python Virtual Environment.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@linuxmgmt01:~/terraform/proxmox$ <span class="nv">VENVDIR</span><span class="o">=</span>kubespray-venv
</span></span><span class="line"><span class="ln">2</span><span class="cl">andreasm@linuxmgmt01:~/terraform/proxmox$ <span class="nv">KUBESPRAYDIR</span><span class="o">=</span>kubespray
</span></span><span class="line"><span class="ln">3</span><span class="cl">andreasm@linuxmgmt01:~/terraform/proxmox$ python3 -m venv <span class="nv">$VENVDIR</span>
</span></span><span class="line"><span class="ln">4</span><span class="cl">andreasm@linuxmgmt01:~/terraform/proxmox$ <span class="nb">source</span> <span class="nv">$VENVDIR</span>/bin/activate
</span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="o">(</span>kubespray-venv<span class="o">)</span> andreasm@linuxmgmt01:~/terraform/proxmox$ <span class="nb">cd</span> <span class="nv">$KUBESPRAYDIR</span>
</span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="o">(</span>kubespray-venv<span class="o">)</span> andreasm@linuxmgmt01:~/terraform/proxmox/kubespray$ pip install -U -r requirements.txt
</span></span></code></pre></div><p>To exit out of the python environment type <em>deactivate</em>.</p>
<p>Now I have these subfolders under my <em>proxmox</em> folder:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">
</span></span><span class="line"><span class="ln">2</span><span class="cl">andreasm@linuxmgmt01:~/terraform/proxmox$ tree -L <span class="m">1</span>
</span></span><span class="line"><span class="ln">3</span><span class="cl">.
</span></span><span class="line"><span class="ln">4</span><span class="cl">├── k8s-cluster-02
</span></span><span class="line"><span class="ln">5</span><span class="cl">├── kubespray
</span></span><span class="line"><span class="ln">6</span><span class="cl">├── kubespray-venv
</span></span><span class="line"><span class="ln">7</span><span class="cl">├── proxmox-images
</span></span><span class="line"><span class="ln">8</span><span class="cl">
</span></span><span class="line"><span class="ln">9</span><span class="cl"><span class="m">4</span> directories, <span class="m">0</span> files
</span></span></code></pre></div><p>Next thing I need to do is to copy a sample folder inside the kubespray folder to a folder that reflects the kubernetes cluster name I am planning to deploy.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@linuxmgmt01:~/terraform/proxmox/kubespray$ cp -rfp inventory/sample inventory/k8s-cluster-02
</span></span></code></pre></div><p>This sample folder contains a couple of files and directories. The file I am interested in right now is the <em>inventory.ini</em> file. I need to populate this file with the nodes, including the control plane nodes, that will form my Kubernetes cluster.  This is how it looks like now, default:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c"># ## Configure &#39;ip&#39; variable to bind kubernetes services on a</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="c"># ## different ip than the default iface</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="c"># ## We should set etcd_member_name for etcd cluster. The node that is not a etcd member do not need to set the value, or can set the empty string value.</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w"></span><span class="p">[</span><span class="l">all]</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w"></span><span class="c"># node1 ansible_host=95.54.0.12  # ip=10.3.0.1 etcd_member_name=etcd1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w"></span><span class="c"># node2 ansible_host=95.54.0.13  # ip=10.3.0.2 etcd_member_name=etcd2</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w"></span><span class="c"># node3 ansible_host=95.54.0.14  # ip=10.3.0.3 etcd_member_name=etcd3</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w"></span><span class="c"># node4 ansible_host=95.54.0.15  # ip=10.3.0.4 etcd_member_name=etcd4</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w"></span><span class="c"># node5 ansible_host=95.54.0.16  # ip=10.3.0.5 etcd_member_name=etcd5</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w"></span><span class="c"># node6 ansible_host=95.54.0.17  # ip=10.3.0.6 etcd_member_name=etcd6</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w"></span><span class="c"># ## configure a bastion host if your nodes are not directly reachable</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w"></span><span class="c"># [bastion]</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w"></span><span class="c"># bastion ansible_host=x.x.x.x ansible_user=some_user</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w"></span><span class="p">[</span><span class="l">kube_control_plane]</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w"></span><span class="c"># node1</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w"></span><span class="c"># node2</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w"></span><span class="c"># node3</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w"></span><span class="p">[</span><span class="l">etcd]</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w"></span><span class="c"># node1</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w"></span><span class="c"># node2</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w"></span><span class="c"># node3</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w"></span><span class="p">[</span><span class="l">kube_node]</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w"></span><span class="c"># node2</span><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w"></span><span class="c"># node3</span><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w"></span><span class="c"># node4</span><span class="w">
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w"></span><span class="c"># node5</span><span class="w">
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="w"></span><span class="c"># node6</span><span class="w">
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="w"></span><span class="p">[</span><span class="l">calico_rr]</span><span class="w">
</span></span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="w"></span><span class="p">[</span><span class="l">k8s_cluster:children]</span><span class="w">
</span></span></span><span class="line"><span class="ln">36</span><span class="cl"><span class="w"></span><span class="l">kube_control_plane</span><span class="w">
</span></span></span><span class="line"><span class="ln">37</span><span class="cl"><span class="w"></span><span class="l">kube_node</span><span class="w">
</span></span></span><span class="line"><span class="ln">38</span><span class="cl"><span class="w"></span><span class="l">calico_rr</span><span class="w">
</span></span></span></code></pre></div><p>This is just a sample, but nice to know how it should be defined. I will create a OpenTofu task to create this inventory file for me with the corresponding VMs I am deploying in the same task/project. This will autopopulate this <em>inventory.ini</em> file with all the necessary information. So I can just go ahead and delete the <em>inventory.ini</em> file that has been copied from the <em>sample</em> folder to my new <em>k8s-cluster-02</em> folder. The other folders and files contains several variables/settings I can adjust to my liking. Like different CNIs, Kubernetes version etc. But I will not cover these here, head over to the official Kubespray docs for more info on that. These are the files/folder:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@linuxmgmt01:~/terraform/proxmox/kubespray/inventory/k8s-cluster-02/group_vars$ tree -L <span class="m">1</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">.
</span></span><span class="line"><span class="ln">3</span><span class="cl">├── all
</span></span><span class="line"><span class="ln">4</span><span class="cl">├── etcd.yml
</span></span><span class="line"><span class="ln">5</span><span class="cl">└── k8s_cluster
</span></span><span class="line"><span class="ln">6</span><span class="cl">
</span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="m">2</span> directories, <span class="m">1</span> file
</span></span></code></pre></div><p>I will deploy my Kubernetes cluster &quot;stock&quot; so these files are left untouched for now, except the <em>inventory.ini</em> file.</p>
<p>Now Kubespray is ready to execute Ansible to configure my Kubernetes cluster as soon as my OpenTofu provisioned VMs has been deployed. The last step I need to do is to confgiure a new .tf file to create this <em>inventory.ini</em> file and kick of the Ansible command to fire up Kubespray.</p>
<h3 id="configure-opentofu-to-kick-off-kubespray">Configure OpenTofu to kick off Kubespray</h3>
<p>The last .tf file in my fully automated Kubernetes installation is the <em>ansible.tf</em> file that contains this information:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c"># Generate inventory file</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="l">resource &#34;local_file&#34; &#34;ansible_inventory&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">  </span><span class="l">filename = &#34;/home/andreasm/terraform/proxmox/kubespray/inventory/k8s-cluster-02/inventory.ini&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">  </span><span class="l">content = &lt;&lt;-EOF</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">  </span><span class="p">[</span><span class="l">all]</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">  </span><span class="l">${proxmox_virtual_environment_vm.k8s-cp-vms-cl02[0].name} ansible_host=${proxmox_virtual_environment_vm.k8s-cp-vms-cl02[0].ipv4_addresses[1][0]}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">  </span><span class="l">${proxmox_virtual_environment_vm.k8s-cp-vms-cl02[1].name} ansible_host=${proxmox_virtual_environment_vm.k8s-cp-vms-cl02[1].ipv4_addresses[1][0]}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">  </span><span class="l">${proxmox_virtual_environment_vm.k8s-cp-vms-cl02[2].name} ansible_host=${proxmox_virtual_environment_vm.k8s-cp-vms-cl02[2].ipv4_addresses[1][0]}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">  </span><span class="l">${proxmox_virtual_environment_vm.k8s-worker-vms-cl02[0].name} ansible_host=${proxmox_virtual_environment_vm.k8s-worker-vms-cl02[0].ipv4_addresses[1][0]}</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">  </span><span class="l">${proxmox_virtual_environment_vm.k8s-worker-vms-cl02[1].name} ansible_host=${proxmox_virtual_environment_vm.k8s-worker-vms-cl02[1].ipv4_addresses[1][0]}</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">  </span><span class="l">${proxmox_virtual_environment_vm.k8s-worker-vms-cl02[2].name} ansible_host=${proxmox_virtual_environment_vm.k8s-worker-vms-cl02[2].ipv4_addresses[1][0]}</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">  </span><span class="p">[</span><span class="l">kube_control_plane]</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">  </span><span class="l">${proxmox_virtual_environment_vm.k8s-cp-vms-cl02[0].name}</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">  </span><span class="l">${proxmox_virtual_environment_vm.k8s-cp-vms-cl02[1].name}</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">  </span><span class="l">${proxmox_virtual_environment_vm.k8s-cp-vms-cl02[2].name}</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">  </span><span class="p">[</span><span class="l">etcd]</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">  </span><span class="l">${proxmox_virtual_environment_vm.k8s-cp-vms-cl02[0].name}</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">  </span><span class="l">${proxmox_virtual_environment_vm.k8s-cp-vms-cl02[1].name}</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">  </span><span class="l">${proxmox_virtual_environment_vm.k8s-cp-vms-cl02[2].name}</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">  </span><span class="p">[</span><span class="l">kube_node]</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">  </span><span class="l">${proxmox_virtual_environment_vm.k8s-worker-vms-cl02[0].name}</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">  </span><span class="l">${proxmox_virtual_environment_vm.k8s-worker-vms-cl02[1].name}</span><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w">  </span><span class="l">${proxmox_virtual_environment_vm.k8s-worker-vms-cl02[2].name}</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w">  </span><span class="p">[</span><span class="l">k8s_cluster:children]</span><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">  </span><span class="l">kube_node</span><span class="w">
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w">  </span><span class="l">kube_control_plane</span><span class="w">
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="w">  </span><span class="l">EOF</span><span class="w">
</span></span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="w"></span>}<span class="w">
</span></span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="w"></span><span class="l">resource &#34;null_resource&#34; &#34;ansible_command&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="ln">36</span><span class="cl"><span class="w">  </span><span class="l">provisioner &#34;local-exec&#34; {</span><span class="w">
</span></span></span><span class="line"><span class="ln">37</span><span class="cl"><span class="w">    </span><span class="l">command = &#34;./kubespray.k8s-cluster-02.sh &gt; k8s-cluster-02/ansible_output.log 2&gt;&amp;1&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">38</span><span class="cl"><span class="w">    </span><span class="l">interpreter = [&#34;/bin/bash&#34;, &#34;-c&#34;]</span><span class="w">
</span></span></span><span class="line"><span class="ln">39</span><span class="cl"><span class="w">    </span><span class="l">working_dir = &#34;/home/andreasm/terraform/proxmox&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">40</span><span class="cl"><span class="w">    </span>}<span class="w">
</span></span></span><span class="line"><span class="ln">41</span><span class="cl"><span class="w">  </span><span class="l">depends_on = [proxmox_virtual_environment_vm.k8s-cp-vms-cl02, proxmox_virtual_environment_vm.k8s-worker-vms-cl02, local_file.ansible_inventory]</span><span class="w">
</span></span></span><span class="line"><span class="ln">42</span><span class="cl"><span class="w">  </span>}<span class="w">
</span></span></span></code></pre></div><p>This will create the <em>inventory.ini</em> in the <em>/proxmox/kubespray/inventory/k8s-cluster-02/</em> for Kubespray to use. Then it will fire a command refering to a bash script (more on that further down) to trigger the Ansible command:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">ansible-playbook -i inventory/k8s-cluster-02/inventory.ini --become --become-user<span class="o">=</span>root cluster.yml -u ubuntu
</span></span></code></pre></div><p>For this to work I had to create a bash script that activated the Kubespray virtual environment:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="cp">#!/bin/bash
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="c1"># Set working directory</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="nv">WORKING_DIR</span><span class="o">=</span><span class="s2">&#34;/home/andreasm/terraform/proxmox&#34;</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="nb">cd</span> <span class="s2">&#34;</span><span class="nv">$WORKING_DIR</span><span class="s2">&#34;</span> <span class="o">||</span> <span class="nb">exit</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="c1"># Set virtual environment variables</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="nv">VENVDIR</span><span class="o">=</span><span class="s2">&#34;kubespray-venv&#34;</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="nv">KUBESPRAYDIR</span><span class="o">=</span><span class="s2">&#34;kubespray&#34;</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">
</span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="c1"># Activate virtual environment</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="nb">source</span> <span class="s2">&#34;</span><span class="nv">$VENVDIR</span><span class="s2">/bin/activate&#34;</span> <span class="o">||</span> <span class="nb">exit</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">
</span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="c1"># Change to Kubespray directory</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="nb">cd</span> <span class="s2">&#34;</span><span class="nv">$KUBESPRAYDIR</span><span class="s2">&#34;</span> <span class="o">||</span> <span class="nb">exit</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">
</span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="c1"># Run Ansible playbook</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">ansible-playbook -i inventory/k8s-cluster-02/inventory.ini --become --become-user<span class="o">=</span>root cluster.yml -u ubuntu
</span></span></code></pre></div><p>I will create and save this file in my <em>proxmox</em> folder.</p>
<p>This is now the content of my proxmox folder:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@linuxmgmt01:~/terraform/proxmox$ tree -L <span class="m">1</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">.
</span></span><span class="line"><span class="ln">3</span><span class="cl">├── k8s-cluster-02
</span></span><span class="line"><span class="ln">4</span><span class="cl">├── kubespray
</span></span><span class="line"><span class="ln">5</span><span class="cl">├── kubespray-venv
</span></span><span class="line"><span class="ln">6</span><span class="cl">├── kubespray.k8s-cluster-02.sh
</span></span><span class="line"><span class="ln">7</span><span class="cl">└── proxmox-images
</span></span><span class="line"><span class="ln">8</span><span class="cl">
</span></span><span class="line"><span class="ln">9</span><span class="cl"><span class="m">4</span> directories, <span class="m">1</span> file
</span></span></code></pre></div><p>And this is the content in the k8s-cluster-02 folder where I have my OpenTofu tasks defined:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">andreasm@linuxmgmt01:~/terraform/proxmox/k8s-cluster-02$ tree -L <span class="m">1</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">.
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">├── ansible.tf
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">├── credentials.auto.tfvars
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">├── k8s-cluster-02.tf
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">├── provider.tf
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">├── ubuntu_cloud_config.tf
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">└── variables.tf
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">
</span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="m">0</span> directories, <span class="m">6</span> files
</span></span></code></pre></div><p>Its time to put it all to a test</p>
<h3 id="a-fully-automated-provisioning-of-kubernetes-on-proxmox-using-opentofu-ansible-and-kubespray">A fully automated provisioning of Kubernetes on Proxmox using OpenTofu, Ansible and Kubespray</h3>
<p>To get this show started, it is the same procedure as it was with my cloud image task. Need to run tofu init, then create a plan, check the output and finally approve it. So lets see how this goes.</p>
<p>From within my <em>./proxmox/k8s-cluster-02</em> folder:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">andreasm@linuxmgmt01:~/terraform/proxmox/k8s-cluster-02$ tofu init
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">Initializing the backend...
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">Initializing provider plugins...
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">- Finding latest version of hashicorp/null...
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">- Finding bpg/proxmox versions matching <span class="s2">&#34;0.43.2&#34;</span>...
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">- Finding latest version of hashicorp/local...
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">- Installing hashicorp/null v3.2.2...
</span></span><span class="line"><span class="ln">10</span><span class="cl">- Installed hashicorp/null v3.2.2 <span class="o">(</span>signed, key ID 0C0AF313E5FD9F80<span class="o">)</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">- Installing bpg/proxmox v0.43.2...
</span></span><span class="line"><span class="ln">12</span><span class="cl">- Installed bpg/proxmox v0.43.2 <span class="o">(</span>signed, key ID DAA1958557A27403<span class="o">)</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">- Installing hashicorp/local v2.4.1...
</span></span><span class="line"><span class="ln">14</span><span class="cl">- Installed hashicorp/local v2.4.1 <span class="o">(</span>signed, key ID 0C0AF313E5FD9F80<span class="o">)</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">
</span></span><span class="line"><span class="ln">16</span><span class="cl">Providers are signed by their developers.
</span></span><span class="line"><span class="ln">17</span><span class="cl">If you<span class="err">&#39;</span>d like to know more about provider signing, you can <span class="nb">read</span> about it here:
</span></span><span class="line"><span class="ln">18</span><span class="cl">https://opentofu.org/docs/cli/plugins/signing/
</span></span><span class="line"><span class="ln">19</span><span class="cl">
</span></span><span class="line"><span class="ln">20</span><span class="cl">OpenTofu has created a lock file .terraform.lock.hcl to record the provider
</span></span><span class="line"><span class="ln">21</span><span class="cl">selections it made above. Include this file in your version control repository
</span></span><span class="line"><span class="ln">22</span><span class="cl">so that OpenTofu can guarantee to make the same selections by default when
</span></span><span class="line"><span class="ln">23</span><span class="cl">you run <span class="s2">&#34;tofu init&#34;</span> in the future.
</span></span><span class="line"><span class="ln">24</span><span class="cl">
</span></span><span class="line"><span class="ln">25</span><span class="cl">OpenTofu has been successfully initialized!
</span></span><span class="line"><span class="ln">26</span><span class="cl">
</span></span><span class="line"><span class="ln">27</span><span class="cl">You may now begin working with OpenTofu. Try running <span class="s2">&#34;tofu plan&#34;</span> to see
</span></span><span class="line"><span class="ln">28</span><span class="cl">any changes that are required <span class="k">for</span> your infrastructure. All OpenTofu commands
</span></span><span class="line"><span class="ln">29</span><span class="cl">should now work.
</span></span><span class="line"><span class="ln">30</span><span class="cl">
</span></span><span class="line"><span class="ln">31</span><span class="cl">If you ever <span class="nb">set</span> or change modules or backend configuration <span class="k">for</span> OpenTofu,
</span></span><span class="line"><span class="ln">32</span><span class="cl">rerun this <span class="nb">command</span> to reinitialize your working directory. If you forget, other
</span></span><span class="line"><span class="ln">33</span><span class="cl">commands will detect it and remind you to <span class="k">do</span> so <span class="k">if</span> necessary.
</span></span></code></pre></div><p>Then create the plan:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">OpenTofu used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols:
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">  + create
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">OpenTofu will perform the following actions:
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">  <span class="c1"># local_file.ansible_inventory will be created</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">  + resource <span class="s2">&#34;local_file&#34;</span> <span class="s2">&#34;ansible_inventory&#34;</span> <span class="o">{</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">      + <span class="nv">content</span>              <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">      + <span class="nv">content_base64sha256</span> <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">      + <span class="nv">content_base64sha512</span> <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">      + <span class="nv">content_md5</span>          <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">      + <span class="nv">content_sha1</span>         <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">      + <span class="nv">content_sha256</span>       <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">      + <span class="nv">content_sha512</span>       <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">      + <span class="nv">directory_permission</span> <span class="o">=</span> <span class="s2">&#34;0777&#34;</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">      + <span class="nv">file_permission</span>      <span class="o">=</span> <span class="s2">&#34;0777&#34;</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">      + <span class="nv">filename</span>             <span class="o">=</span> <span class="s2">&#34;/home/andreasm/terraform/proxmox/kubespray/inventory/k8s-cluster-02/inventory.ini&#34;</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">      + <span class="nv">id</span>                   <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">
</span></span><span class="line"><span class="ln">21</span><span class="cl">  <span class="c1"># null_resource.ansible_command will be created</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl">  + resource <span class="s2">&#34;null_resource&#34;</span> <span class="s2">&#34;ansible_command&#34;</span> <span class="o">{</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl">      + <span class="nv">id</span> <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="ln">25</span><span class="cl">
</span></span><span class="line"><span class="ln">26</span><span class="cl">  <span class="c1"># proxmox_virtual_environment_file.ubuntu_cloud_init will be created</span>
</span></span><span class="line"><span class="ln">27</span><span class="cl">  + resource <span class="s2">&#34;proxmox_virtual_environment_file&#34;</span> <span class="s2">&#34;ubuntu_cloud_init&#34;</span> <span class="o">{</span>
</span></span><span class="line"><span class="ln">28</span><span class="cl">      + <span class="nv">content_type</span>           <span class="o">=</span> <span class="s2">&#34;snippets&#34;</span>
</span></span><span class="line"><span class="ln">29</span><span class="cl">      + <span class="nv">datastore_id</span>           <span class="o">=</span> <span class="s2">&#34;local&#34;</span>
</span></span><span class="line"><span class="ln">30</span><span class="cl">      + <span class="nv">file_modification_date</span> <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span></span><span class="line"><span class="ln">31</span><span class="cl">      + <span class="nv">file_name</span>              <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span></span><span class="line"><span class="ln">32</span><span class="cl">      + <span class="nv">file_size</span>              <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span></span><span class="line"><span class="ln">33</span><span class="cl">      + <span class="nv">file_tag</span>               <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span></span><span class="line"><span class="ln">34</span><span class="cl">      + <span class="nv">id</span>                     <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span></span><span class="line"><span class="ln">35</span><span class="cl">      + <span class="nv">node_name</span>              <span class="o">=</span> <span class="s2">&#34;proxmox-02&#34;</span>
</span></span><span class="line"><span class="ln">36</span><span class="cl">      + <span class="nv">overwrite</span>              <span class="o">=</span> <span class="nb">true</span>
</span></span><span class="line"><span class="ln">37</span><span class="cl">      + <span class="nv">timeout_upload</span>         <span class="o">=</span> <span class="m">1800</span>
</span></span><span class="line"><span class="ln">38</span><span class="cl">
</span></span><span class="line"><span class="ln">39</span><span class="cl"><span class="s">&lt;&lt;redacted&gt;&gt;
</span></span></span><span class="line"><span class="ln">40</span><span class="cl"><span class="s">Plan: 9 to add, 0 to change, 0 to destr</span>oy.
</span></span><span class="line"><span class="ln">41</span><span class="cl">
</span></span><span class="line"><span class="ln">42</span><span class="cl">──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
</span></span><span class="line"><span class="ln">43</span><span class="cl">
</span></span><span class="line"><span class="ln">44</span><span class="cl">Saved the plan to: plan
</span></span><span class="line"><span class="ln">45</span><span class="cl">
</span></span><span class="line"><span class="ln">46</span><span class="cl">To perform exactly these actions, run the following <span class="nb">command</span> to apply:
</span></span><span class="line"><span class="ln">47</span><span class="cl">    tofu apply <span class="s2">&#34;plan&#34;</span>
</span></span></code></pre></div><p>It looks good to me, lets apply it:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">andreasm@linuxmgmt01:~/terraform/proxmox/k8s-cluster-02$ tofu apply plan
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">proxmox_virtual_environment_file.ubuntu_cloud_init: Creating...
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">proxmox_virtual_environment_file.ubuntu_cloud_init: Creation <span class="nb">complete</span> after 1s <span class="o">[</span><span class="nv">id</span><span class="o">=</span>local:snippets/ubuntu.cloud-config.yaml<span class="o">]</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">proxmox_virtual_environment_vm.k8s-worker-vms-cl02<span class="o">[</span>2<span class="o">]</span>: Creating...
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">proxmox_virtual_environment_vm.k8s-worker-vms-cl02<span class="o">[</span>1<span class="o">]</span>: Creating...
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">proxmox_virtual_environment_vm.k8s-worker-vms-cl02<span class="o">[</span>0<span class="o">]</span>: Creating...
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">proxmox_virtual_environment_vm.k8s-cp-vms-cl02<span class="o">[</span>1<span class="o">]</span>: Creating...
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">proxmox_virtual_environment_vm.k8s-cp-vms-cl02<span class="o">[</span>0<span class="o">]</span>: Creating...
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">proxmox_virtual_environment_vm.k8s-cp-vms-cl02<span class="o">[</span>2<span class="o">]</span>: Creating...
</span></span><span class="line"><span class="ln">10</span><span class="cl">proxmox_virtual_environment_vm.k8s-worker-vms-cl02<span class="o">[</span>2<span class="o">]</span>: Still creating... <span class="o">[</span>10s elapsed<span class="o">]</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">proxmox_virtual_environment_vm.k8s-worker-vms-cl02<span class="o">[</span>1<span class="o">]</span>: Still creating... <span class="o">[</span>10s elapsed<span class="o">]</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">proxmox_virtual_environment_vm.k8s-worker-vms-cl02<span class="o">[</span>0<span class="o">]</span>: Still creating... <span class="o">[</span>10s elapsed<span class="o">]</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">proxmox_virtual_environment_vm.k8s-cp-vms-cl02<span class="o">[</span>1<span class="o">]</span>: Still creating... <span class="o">[</span>10s elapsed<span class="o">]</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">proxmox_virtual_environment_vm.k8s-cp-vms-cl02<span class="o">[</span>0<span class="o">]</span>: Still creating... <span class="o">[</span>10s elapsed<span class="o">]</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">proxmox_virtual_environment_vm.k8s-cp-vms-cl02<span class="o">[</span>2<span class="o">]</span>: Still creating... <span class="o">[</span>10s elapsed<span class="o">]</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="s">&lt;&lt;redacted&gt;&gt;
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="s">proxmox_virtual_environment_vm.k8s-worker-vms-cl02[2]: Still cre</span>ating... <span class="o">[</span>1m30s elapsed<span class="o">]</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">proxmox_virtual_environment_vm.k8s-worker-vms-cl02<span class="o">[</span>1<span class="o">]</span>: Still creating... <span class="o">[</span>1m30s elapsed<span class="o">]</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">proxmox_virtual_environment_vm.k8s-worker-vms-cl02<span class="o">[</span>0<span class="o">]</span>: Still creating... <span class="o">[</span>1m30s elapsed<span class="o">]</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">proxmox_virtual_environment_vm.k8s-cp-vms-cl02<span class="o">[</span>1<span class="o">]</span>: Still creating... <span class="o">[</span>1m30s elapsed<span class="o">]</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl">proxmox_virtual_environment_vm.k8s-cp-vms-cl02<span class="o">[</span>0<span class="o">]</span>: Still creating... <span class="o">[</span>1m30s elapsed<span class="o">]</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl">proxmox_virtual_environment_vm.k8s-cp-vms-cl02<span class="o">[</span>2<span class="o">]</span>: Still creating... <span class="o">[</span>1m30s elapsed<span class="o">]</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl">proxmox_virtual_environment_vm.k8s-worker-vms-cl02<span class="o">[</span>0<span class="o">]</span>: Creation <span class="nb">complete</span> after 1m32s <span class="o">[</span><span class="nv">id</span><span class="o">=</span>1005<span class="o">]</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl">proxmox_virtual_environment_vm.k8s-cp-vms-cl02<span class="o">[</span>1<span class="o">]</span>: Creation <span class="nb">complete</span> after 1m32s <span class="o">[</span><span class="nv">id</span><span class="o">=</span>1002<span class="o">]</span>
</span></span><span class="line"><span class="ln">25</span><span class="cl">proxmox_virtual_environment_vm.k8s-worker-vms-cl02<span class="o">[</span>1<span class="o">]</span>: Creation <span class="nb">complete</span> after 1m33s <span class="o">[</span><span class="nv">id</span><span class="o">=</span>1006<span class="o">]</span>
</span></span><span class="line"><span class="ln">26</span><span class="cl">proxmox_virtual_environment_vm.k8s-worker-vms-cl02<span class="o">[</span>2<span class="o">]</span>: Creation <span class="nb">complete</span> after 1m33s <span class="o">[</span><span class="nv">id</span><span class="o">=</span>1007<span class="o">]</span>
</span></span><span class="line"><span class="ln">27</span><span class="cl">proxmox_virtual_environment_vm.k8s-cp-vms-cl02<span class="o">[</span>2<span class="o">]</span>: Creation <span class="nb">complete</span> after 1m34s <span class="o">[</span><span class="nv">id</span><span class="o">=</span>1003<span class="o">]</span>
</span></span><span class="line"><span class="ln">28</span><span class="cl">proxmox_virtual_environment_vm.k8s-cp-vms-cl02<span class="o">[</span>0<span class="o">]</span>: Creation <span class="nb">complete</span> after 1m37s <span class="o">[</span><span class="nv">id</span><span class="o">=</span>1001<span class="o">]</span>
</span></span></code></pre></div><p>1m37s to create my 6 VMs, ready for the Kubernetes installation.</p>
<p>And in Proxmox I have 6 new VMs with correct name, vm_id, tags and all:</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="my-new-kubernetes-cluster"
      
        class="image_figure image_internal image_processed"
        width="566"
        height="270"
        src="/2024/01/15/proxmox-with-opentofu-kubespray-and-kubernetes/images/image-20240115224119296.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Let me check if the <em>inventory.ini</em> file has been created correct:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="l">andreasm@linuxmgmt01:~/terraform/proxmox/kubespray/inventory/k8s-cluster-02$ cat inventory.ini</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="p">[</span><span class="l">all]</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="l">k8s-cp-vm-1-cl-02 ansible_host=10.160.1.21</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w"></span><span class="l">k8s-cp-vm-2-cl-02 ansible_host=10.160.1.22</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w"></span><span class="l">k8s-cp-vm-3-cl-02 ansible_host=10.160.1.23</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w"></span><span class="l">k8s-node-vm-1-cl-02 ansible_host=10.160.1.25</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w"></span><span class="l">k8s-node-vm-2-cl-02 ansible_host=10.160.1.26</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w"></span><span class="l">k8s-node-vm-3-cl-02 ansible_host=10.160.1.27</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w"></span><span class="p">[</span><span class="l">kube_control_plane]</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w"></span><span class="l">k8s-cp-vm-1-cl-02</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w"></span><span class="l">k8s-cp-vm-2-cl-02</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w"></span><span class="l">k8s-cp-vm-3-cl-02</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w"></span><span class="p">[</span><span class="l">etcd]</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w"></span><span class="l">k8s-cp-vm-1-cl-02</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w"></span><span class="l">k8s-cp-vm-2-cl-02</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w"></span><span class="l">k8s-cp-vm-3-cl-02</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w"></span><span class="p">[</span><span class="l">kube_node]</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w"></span><span class="l">k8s-node-vm-1-cl-02</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w"></span><span class="l">k8s-node-vm-2-cl-02</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w"></span><span class="l">k8s-node-vm-3-cl-02</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w"></span><span class="p">[</span><span class="l">k8s_cluster:children]</span><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w"></span><span class="l">kube_node</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w"></span><span class="l">kube_control_plane</span><span class="w">
</span></span></span></code></pre></div><p>Now the last task the ansible_command:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">local_file.ansible_inventory: Creating...
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">local_file.ansible_inventory: Creation <span class="nb">complete</span> after 0s <span class="o">[</span><span class="nv">id</span><span class="o">=</span>1d19a8be76746178f26336defc9ce96c6e82a791<span class="o">]</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">null_resource.ansible_command: Creating...
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">null_resource.ansible_command: Provisioning with <span class="s1">&#39;local-exec&#39;</span>...
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">null_resource.ansible_command <span class="o">(</span>local-exec<span class="o">)</span>: Executing: <span class="o">[</span><span class="s2">&#34;/bin/bash&#34;</span> <span class="s2">&#34;-c&#34;</span> <span class="s2">&#34;./kubespray.k8s-cluster-02.sh &gt; k8s-cluster-02/ansible_output.log 2&gt;&amp;1&#34;</span><span class="o">]</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">null_resource.ansible_command: Still creating... <span class="o">[</span>10s elapsed<span class="o">]</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">null_resource.ansible_command: Still creating... <span class="o">[</span>20s elapsed<span class="o">]</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">null_resource.ansible_command: Still creating... <span class="o">[</span>30s elapsed<span class="o">]</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">null_resource.ansible_command: Still creating... <span class="o">[</span>40s elapsed<span class="o">]</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">null_resource.ansible_command: Still creating... <span class="o">[</span>50s elapsed<span class="o">]</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="s">&lt;&lt;redacted&gt;&gt;
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="s">null_re</span>source.ansible_command: Still creating... <span class="o">[</span>16m50s elapsed<span class="o">]</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">null_resource.ansible_command: Still creating... <span class="o">[</span>17m0s elapsed<span class="o">]</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">null_resource.ansible_command: Creation <span class="nb">complete</span> after 17m4s <span class="o">[</span><span class="nv">id</span><span class="o">=</span>5215143035945962122<span class="o">]</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">
</span></span><span class="line"><span class="ln">16</span><span class="cl">Apply complete! Resources: <span class="m">9</span> added, <span class="m">0</span> changed, <span class="m">0</span> destroyed.
</span></span></code></pre></div><p>That took 17m4s to deploy a fully working Kubernetes cluster with no intervention from me at all.</p>
<p>From the ansible_output.log:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">PLAY RECAP *********************************************************************
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">k8s-cp-vm-1-cl-02          : <span class="nv">ok</span><span class="o">=</span><span class="m">691</span>  <span class="nv">changed</span><span class="o">=</span><span class="m">139</span>  <span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span>    <span class="nv">failed</span><span class="o">=</span><span class="m">0</span>    <span class="nv">skipped</span><span class="o">=</span><span class="m">1080</span> <span class="nv">rescued</span><span class="o">=</span><span class="m">0</span>    <span class="nv">ignored</span><span class="o">=</span><span class="m">6</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">k8s-cp-vm-2-cl-02          : <span class="nv">ok</span><span class="o">=</span><span class="m">646</span>  <span class="nv">changed</span><span class="o">=</span><span class="m">131</span>  <span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span>    <span class="nv">failed</span><span class="o">=</span><span class="m">0</span>    <span class="nv">skipped</span><span class="o">=</span><span class="m">1050</span> <span class="nv">rescued</span><span class="o">=</span><span class="m">0</span>    <span class="nv">ignored</span><span class="o">=</span><span class="m">3</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">k8s-cp-vm-3-cl-02          : <span class="nv">ok</span><span class="o">=</span><span class="m">648</span>  <span class="nv">changed</span><span class="o">=</span><span class="m">132</span>  <span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span>    <span class="nv">failed</span><span class="o">=</span><span class="m">0</span>    <span class="nv">skipped</span><span class="o">=</span><span class="m">1048</span> <span class="nv">rescued</span><span class="o">=</span><span class="m">0</span>    <span class="nv">ignored</span><span class="o">=</span><span class="m">3</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">k8s-node-vm-1-cl-02        : <span class="nv">ok</span><span class="o">=</span><span class="m">553</span>  <span class="nv">changed</span><span class="o">=</span><span class="m">93</span>   <span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span>    <span class="nv">failed</span><span class="o">=</span><span class="m">0</span>    <span class="nv">skipped</span><span class="o">=</span><span class="m">840</span>  <span class="nv">rescued</span><span class="o">=</span><span class="m">0</span>    <span class="nv">ignored</span><span class="o">=</span><span class="m">1</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">k8s-node-vm-2-cl-02        : <span class="nv">ok</span><span class="o">=</span><span class="m">509</span>  <span class="nv">changed</span><span class="o">=</span><span class="m">90</span>   <span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span>    <span class="nv">failed</span><span class="o">=</span><span class="m">0</span>    <span class="nv">skipped</span><span class="o">=</span><span class="m">739</span>  <span class="nv">rescued</span><span class="o">=</span><span class="m">0</span>    <span class="nv">ignored</span><span class="o">=</span><span class="m">1</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">k8s-node-vm-3-cl-02        : <span class="nv">ok</span><span class="o">=</span><span class="m">509</span>  <span class="nv">changed</span><span class="o">=</span><span class="m">90</span>   <span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span>    <span class="nv">failed</span><span class="o">=</span><span class="m">0</span>    <span class="nv">skipped</span><span class="o">=</span><span class="m">739</span>  <span class="nv">rescued</span><span class="o">=</span><span class="m">0</span>    <span class="nv">ignored</span><span class="o">=</span><span class="m">1</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">localhost                  : <span class="nv">ok</span><span class="o">=</span><span class="m">3</span>    <span class="nv">changed</span><span class="o">=</span><span class="m">0</span>    <span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span>    <span class="nv">failed</span><span class="o">=</span><span class="m">0</span>    <span class="nv">skipped</span><span class="o">=</span><span class="m">0</span>    <span class="nv">rescued</span><span class="o">=</span><span class="m">0</span>    <span class="nv">ignored</span><span class="o">=</span><span class="m">0</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">
</span></span><span class="line"><span class="ln">10</span><span class="cl">Monday <span class="m">15</span> January <span class="m">2024</span>  21:59:02 +0000 <span class="o">(</span>0:00:00.288<span class="o">)</span>       0:17:01.376 ********
</span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="o">===============================================================================</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">download : Download_file <span class="p">|</span> Download item ------------------------------- 71.29s
</span></span><span class="line"><span class="ln">13</span><span class="cl">download : Download_file <span class="p">|</span> Download item ------------------------------- 36.04s
</span></span><span class="line"><span class="ln">14</span><span class="cl">kubernetes/kubeadm : Join to cluster ----------------------------------- 19.06s
</span></span><span class="line"><span class="ln">15</span><span class="cl">container-engine/containerd : Download_file <span class="p">|</span> Download item ------------ 16.73s
</span></span><span class="line"><span class="ln">16</span><span class="cl">download : Download_container <span class="p">|</span> Download image <span class="k">if</span> required ------------- 15.65s
</span></span><span class="line"><span class="ln">17</span><span class="cl">container-engine/runc : Download_file <span class="p">|</span> Download item ------------------ 15.53s
</span></span><span class="line"><span class="ln">18</span><span class="cl">container-engine/nerdctl : Download_file <span class="p">|</span> Download item --------------- 14.75s
</span></span><span class="line"><span class="ln">19</span><span class="cl">container-engine/crictl : Download_file <span class="p">|</span> Download item ---------------- 14.66s
</span></span><span class="line"><span class="ln">20</span><span class="cl">download : Download_container <span class="p">|</span> Download image <span class="k">if</span> required ------------- 13.75s
</span></span><span class="line"><span class="ln">21</span><span class="cl">container-engine/crictl : Extract_file <span class="p">|</span> Unpacking archive ------------- 13.35s
</span></span><span class="line"><span class="ln">22</span><span class="cl">kubernetes/control-plane : Kubeadm <span class="p">|</span> Initialize first master ----------- 10.16s
</span></span><span class="line"><span class="ln">23</span><span class="cl">container-engine/nerdctl : Extract_file <span class="p">|</span> Unpacking archive ------------- 9.99s
</span></span><span class="line"><span class="ln">24</span><span class="cl">kubernetes/preinstall : Install packages requirements ------------------- 9.93s
</span></span><span class="line"><span class="ln">25</span><span class="cl">kubernetes/control-plane : Joining control plane node to the cluster. --- 9.21s
</span></span><span class="line"><span class="ln">26</span><span class="cl">container-engine/runc : Download_file <span class="p">|</span> Validate mirrors ---------------- 9.20s
</span></span><span class="line"><span class="ln">27</span><span class="cl">container-engine/crictl : Download_file <span class="p">|</span> Validate mirrors -------------- 9.15s
</span></span><span class="line"><span class="ln">28</span><span class="cl">container-engine/nerdctl : Download_file <span class="p">|</span> Validate mirrors ------------- 9.12s
</span></span><span class="line"><span class="ln">29</span><span class="cl">container-engine/containerd : Download_file <span class="p">|</span> Validate mirrors ---------- 9.06s
</span></span><span class="line"><span class="ln">30</span><span class="cl">container-engine/containerd : Containerd <span class="p">|</span> Unpack containerd archive ---- 8.99s
</span></span><span class="line"><span class="ln">31</span><span class="cl">download : Download_container <span class="p">|</span> Download image <span class="k">if</span> required -------------- 8.19s
</span></span></code></pre></div><p>I guess I am gonna spin up a couple of Kubernetes clusters going forward 😄</p>
<p>If something should fail I have configured the <em>ansible_command</em> to pipe the output to a file called <em>ansible_output.log</em> I can check. This pipes out the whole Kubespray operation. Some simple tests to do is also checking if Ansible can reach the VMs (after they have been deployed ofcourse). This command needs to be run within the python environment again.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1"># activate the environment</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">andreasm@linuxmgmt01:~/terraform/proxmox$ <span class="nb">source</span> <span class="nv">$VENVDIR</span>/bin/activate
</span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="c1"># ping all nodes</span>
</span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="o">(</span>kubespray-venv<span class="o">)</span> andreasm@linuxmgmt01:~/terraform/proxmox$ ansible -i inventory/k8s-cluster-02/inventory.ini -m ping all -u ubuntu
</span></span></code></pre></div><p>Now let me log into one of the Kubernetes Control plane and check if there is a Kubernetes cluster ready or not:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">root@k8s-cp-vm-1-cl-02:/home/ubuntu# kubectl get nodes
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">NAME                  STATUS   ROLES           AGE     VERSION
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">k8s-cp-vm-1-cl-02     Ready    control-plane   6m13s   v1.28.5
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">k8s-cp-vm-2-cl-02     Ready    control-plane   6m1s    v1.28.5
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">k8s-cp-vm-3-cl-02     Ready    control-plane   5m57s   v1.28.5
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">k8s-node-vm-1-cl-02   Ready    &lt;none&gt;          5m24s   v1.28.5
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">k8s-node-vm-2-cl-02   Ready    &lt;none&gt;          5m23s   v1.28.5
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">k8s-node-vm-3-cl-02   Ready    &lt;none&gt;          5m19s   v1.28.5
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">root@k8s-cp-vm-1-cl-02:/home/ubuntu# kubectl get pods -A
</span></span><span class="line"><span class="ln">10</span><span class="cl">NAMESPACE     NAME                                        READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="ln">11</span><span class="cl">kube-system   calico-kube-controllers-648dffd99-lr82q     1/1     Running   <span class="m">0</span>          4m25s
</span></span><span class="line"><span class="ln">12</span><span class="cl">kube-system   calico-node-b25gf                           1/1     Running   <span class="m">0</span>          4m52s
</span></span><span class="line"><span class="ln">13</span><span class="cl">kube-system   calico-node-h7lpr                           1/1     Running   <span class="m">0</span>          4m52s
</span></span><span class="line"><span class="ln">14</span><span class="cl">kube-system   calico-node-jdkb9                           1/1     Running   <span class="m">0</span>          4m52s
</span></span><span class="line"><span class="ln">15</span><span class="cl">kube-system   calico-node-vsgqq                           1/1     Running   <span class="m">0</span>          4m52s
</span></span><span class="line"><span class="ln">16</span><span class="cl">kube-system   calico-node-w6vrc                           1/1     Running   <span class="m">0</span>          4m52s
</span></span><span class="line"><span class="ln">17</span><span class="cl">kube-system   calico-node-x95mh                           1/1     Running   <span class="m">0</span>          4m52s
</span></span><span class="line"><span class="ln">18</span><span class="cl">kube-system   coredns-77f7cc69db-29t6b                    1/1     Running   <span class="m">0</span>          4m13s
</span></span><span class="line"><span class="ln">19</span><span class="cl">kube-system   coredns-77f7cc69db-2ph9d                    1/1     Running   <span class="m">0</span>          4m10s
</span></span><span class="line"><span class="ln">20</span><span class="cl">kube-system   dns-autoscaler-8576bb9f5b-8bzqp             1/1     Running   <span class="m">0</span>          4m11s
</span></span><span class="line"><span class="ln">21</span><span class="cl">kube-system   kube-apiserver-k8s-cp-vm-1-cl-02            1/1     Running   <span class="m">1</span>          6m14s
</span></span><span class="line"><span class="ln">22</span><span class="cl">kube-system   kube-apiserver-k8s-cp-vm-2-cl-02            1/1     Running   <span class="m">1</span>          5m55s
</span></span><span class="line"><span class="ln">23</span><span class="cl">kube-system   kube-apiserver-k8s-cp-vm-3-cl-02            1/1     Running   <span class="m">1</span>          6m1s
</span></span><span class="line"><span class="ln">24</span><span class="cl">kube-system   kube-controller-manager-k8s-cp-vm-1-cl-02   1/1     Running   <span class="m">2</span>          6m16s
</span></span><span class="line"><span class="ln">25</span><span class="cl">kube-system   kube-controller-manager-k8s-cp-vm-2-cl-02   1/1     Running   <span class="m">2</span>          5m56s
</span></span><span class="line"><span class="ln">26</span><span class="cl">kube-system   kube-controller-manager-k8s-cp-vm-3-cl-02   1/1     Running   <span class="m">2</span>          6m1s
</span></span><span class="line"><span class="ln">27</span><span class="cl">kube-system   kube-proxy-6jt89                            1/1     Running   <span class="m">0</span>          5m22s
</span></span><span class="line"><span class="ln">28</span><span class="cl">kube-system   kube-proxy-9w5f2                            1/1     Running   <span class="m">0</span>          5m22s
</span></span><span class="line"><span class="ln">29</span><span class="cl">kube-system   kube-proxy-k7l9g                            1/1     Running   <span class="m">0</span>          5m22s
</span></span><span class="line"><span class="ln">30</span><span class="cl">kube-system   kube-proxy-p7wqt                            1/1     Running   <span class="m">0</span>          5m22s
</span></span><span class="line"><span class="ln">31</span><span class="cl">kube-system   kube-proxy-qfmg5                            1/1     Running   <span class="m">0</span>          5m22s
</span></span><span class="line"><span class="ln">32</span><span class="cl">kube-system   kube-proxy-v6tcn                            1/1     Running   <span class="m">0</span>          5m22s
</span></span><span class="line"><span class="ln">33</span><span class="cl">kube-system   kube-scheduler-k8s-cp-vm-1-cl-02            1/1     Running   <span class="m">1</span>          6m14s
</span></span><span class="line"><span class="ln">34</span><span class="cl">kube-system   kube-scheduler-k8s-cp-vm-2-cl-02            1/1     Running   <span class="m">1</span>          5m56s
</span></span><span class="line"><span class="ln">35</span><span class="cl">kube-system   kube-scheduler-k8s-cp-vm-3-cl-02            1/1     Running   <span class="m">1</span>          6m
</span></span><span class="line"><span class="ln">36</span><span class="cl">kube-system   nginx-proxy-k8s-node-vm-1-cl-02             1/1     Running   <span class="m">0</span>          5m25s
</span></span><span class="line"><span class="ln">37</span><span class="cl">kube-system   nginx-proxy-k8s-node-vm-2-cl-02             1/1     Running   <span class="m">0</span>          5m20s
</span></span><span class="line"><span class="ln">38</span><span class="cl">kube-system   nginx-proxy-k8s-node-vm-3-cl-02             1/1     Running   <span class="m">0</span>          5m20s
</span></span><span class="line"><span class="ln">39</span><span class="cl">kube-system   nodelocaldns-4z72v                          1/1     Running   <span class="m">0</span>          4m9s
</span></span><span class="line"><span class="ln">40</span><span class="cl">kube-system   nodelocaldns-8wv4j                          1/1     Running   <span class="m">0</span>          4m9s
</span></span><span class="line"><span class="ln">41</span><span class="cl">kube-system   nodelocaldns-kl6fw                          1/1     Running   <span class="m">0</span>          4m9s
</span></span><span class="line"><span class="ln">42</span><span class="cl">kube-system   nodelocaldns-pqxpj                          1/1     Running   <span class="m">0</span>          4m9s
</span></span><span class="line"><span class="ln">43</span><span class="cl">kube-system   nodelocaldns-qmrq8                          1/1     Running   <span class="m">0</span>          4m9s
</span></span><span class="line"><span class="ln">44</span><span class="cl">kube-system   nodelocaldns-vqnbd                          1/1     Running   <span class="m">0</span>          4m9s
</span></span><span class="line"><span class="ln">45</span><span class="cl">root@k8s-cp-vm-1-cl-02:/home/ubuntu#
</span></span></code></pre></div><p>Nice nice nice. Now I can go ahead and grab the kubeconfig, configure my loadbalancer to loadbalance the Kubernetes API and start using my newly decomposable provisioned cluster.</p>
<h3 id="cleaning-up">Cleaning up</h3>
<p>When I am done with my Kubernetes cluster its just about doing a <em>tofu destroy</em> command and everything is neatly cleaned up. I have not configured any persistent storage yet. So if I have deployed some apps on this cluster and decides to delete it any data that has been created I want to keep will be deleted. So its wise to look into how to keep certain data even after the deletion of my cluster.</p>
<p>There are two ways I can clean up. If I want to keep the nodes running but just reset the Kubernetes installation I can execute the following command:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1"># from the Kubespray environment</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="o">(</span>kubespray-venv<span class="o">)</span> andreasm@linuxmgmt01:~/terraform/proxmox/kubespray$ ansible-playbook -i inventory/k8s-cluster-02/hosts.yaml --become --become-user<span class="o">=</span>root reset.yml -u ubuntu
</span></span></code></pre></div><p>Or a full wipe, including the deployed VMs:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1"># Inside the k8s-cluster-02 OpenTofu project folder</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">andreasm@linuxmgmt01:~/terraform/proxmox/k8s-cluster-02$ tofu destroy
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">Do you really want to destroy all resources?
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">  OpenTofu will destroy all your managed infrastructure, as shown above.
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">  There is no undo. Only <span class="s1">&#39;yes&#39;</span> will be accepted to confirm.
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">  Enter a value:yes
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">null_resource.ansible_command: Destroying... <span class="o">[</span><span class="nv">id</span><span class="o">=</span>5215143035945962122<span class="o">]</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">null_resource.ansible_command: Destruction <span class="nb">complete</span> after 0s
</span></span><span class="line"><span class="ln">10</span><span class="cl">local_file.ansible_inventory: Destroying... <span class="o">[</span><span class="nv">id</span><span class="o">=</span>1d19a8be76746178f26336defc9ce96c6e82a791<span class="o">]</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">local_file.ansible_inventory: Destruction <span class="nb">complete</span> after 0s
</span></span><span class="line"><span class="ln">12</span><span class="cl">proxmox_virtual_environment_vm.k8s-cp-vms-cl02<span class="o">[</span>1<span class="o">]</span>: Destroying... <span class="o">[</span><span class="nv">id</span><span class="o">=</span>1002<span class="o">]</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">proxmox_virtual_environment_vm.k8s-cp-vms-cl02<span class="o">[</span>2<span class="o">]</span>: Destroying... <span class="o">[</span><span class="nv">id</span><span class="o">=</span>1003<span class="o">]</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">proxmox_virtual_environment_vm.k8s-worker-vms-cl02<span class="o">[</span>0<span class="o">]</span>: Destroying... <span class="o">[</span><span class="nv">id</span><span class="o">=</span>1005<span class="o">]</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">proxmox_virtual_environment_vm.k8s-worker-vms-cl02<span class="o">[</span>2<span class="o">]</span>: Destroying... <span class="o">[</span><span class="nv">id</span><span class="o">=</span>1007<span class="o">]</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">proxmox_virtual_environment_vm.k8s-worker-vms-cl02<span class="o">[</span>1<span class="o">]</span>: Destroying... <span class="o">[</span><span class="nv">id</span><span class="o">=</span>1006<span class="o">]</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">proxmox_virtual_environment_vm.k8s-cp-vms-cl02<span class="o">[</span>0<span class="o">]</span>: Destroying... <span class="o">[</span><span class="nv">id</span><span class="o">=</span>1001<span class="o">]</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">proxmox_virtual_environment_vm.k8s-worker-vms-cl02<span class="o">[</span>0<span class="o">]</span>: Destruction <span class="nb">complete</span> after 7s
</span></span><span class="line"><span class="ln">19</span><span class="cl">proxmox_virtual_environment_vm.k8s-worker-vms-cl02<span class="o">[</span>2<span class="o">]</span>: Destruction <span class="nb">complete</span> after 7s
</span></span><span class="line"><span class="ln">20</span><span class="cl">proxmox_virtual_environment_vm.k8s-worker-vms-cl02<span class="o">[</span>1<span class="o">]</span>: Destruction <span class="nb">complete</span> after 9s
</span></span><span class="line"><span class="ln">21</span><span class="cl">proxmox_virtual_environment_vm.k8s-cp-vms-cl02<span class="o">[</span>1<span class="o">]</span>: Still destroying... <span class="o">[</span><span class="nv">id</span><span class="o">=</span>1002, 10s elapsed<span class="o">]</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl">proxmox_virtual_environment_vm.k8s-cp-vms-cl02<span class="o">[</span>2<span class="o">]</span>: Still destroying... <span class="o">[</span><span class="nv">id</span><span class="o">=</span>1003, 10s elapsed<span class="o">]</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl">proxmox_virtual_environment_vm.k8s-cp-vms-cl02<span class="o">[</span>0<span class="o">]</span>: Still destroying... <span class="o">[</span><span class="nv">id</span><span class="o">=</span>1001, 10s elapsed<span class="o">]</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl">proxmox_virtual_environment_vm.k8s-cp-vms-cl02<span class="o">[</span>0<span class="o">]</span>: Destruction <span class="nb">complete</span> after 12s
</span></span><span class="line"><span class="ln">25</span><span class="cl">proxmox_virtual_environment_vm.k8s-cp-vms-cl02<span class="o">[</span>1<span class="o">]</span>: Still destroying... <span class="o">[</span><span class="nv">id</span><span class="o">=</span>1002, 20s elapsed<span class="o">]</span>
</span></span><span class="line"><span class="ln">26</span><span class="cl">proxmox_virtual_environment_vm.k8s-cp-vms-cl02<span class="o">[</span>2<span class="o">]</span>: Still destroying... <span class="o">[</span><span class="nv">id</span><span class="o">=</span>1003, 20s elapsed<span class="o">]</span>
</span></span><span class="line"><span class="ln">27</span><span class="cl">proxmox_virtual_environment_vm.k8s-cp-vms-cl02<span class="o">[</span>1<span class="o">]</span>: Still destroying... <span class="o">[</span><span class="nv">id</span><span class="o">=</span>1002, 30s elapsed<span class="o">]</span>
</span></span><span class="line"><span class="ln">28</span><span class="cl">proxmox_virtual_environment_vm.k8s-cp-vms-cl02<span class="o">[</span>2<span class="o">]</span>: Still destroying... <span class="o">[</span><span class="nv">id</span><span class="o">=</span>1003, 30s elapsed<span class="o">]</span>
</span></span><span class="line"><span class="ln">29</span><span class="cl">proxmox_virtual_environment_vm.k8s-cp-vms-cl02<span class="o">[</span>1<span class="o">]</span>: Still destroying... <span class="o">[</span><span class="nv">id</span><span class="o">=</span>1002, 40s elapsed<span class="o">]</span>
</span></span><span class="line"><span class="ln">30</span><span class="cl">proxmox_virtual_environment_vm.k8s-cp-vms-cl02<span class="o">[</span>2<span class="o">]</span>: Still destroying... <span class="o">[</span><span class="nv">id</span><span class="o">=</span>1003, 40s elapsed<span class="o">]</span>
</span></span><span class="line"><span class="ln">31</span><span class="cl">proxmox_virtual_environment_vm.k8s-cp-vms-cl02<span class="o">[</span>1<span class="o">]</span>: Still destroying... <span class="o">[</span><span class="nv">id</span><span class="o">=</span>1002, 50s elapsed<span class="o">]</span>
</span></span><span class="line"><span class="ln">32</span><span class="cl">proxmox_virtual_environment_vm.k8s-cp-vms-cl02<span class="o">[</span>2<span class="o">]</span>: Still destroying... <span class="o">[</span><span class="nv">id</span><span class="o">=</span>1003, 50s elapsed<span class="o">]</span>
</span></span><span class="line"><span class="ln">33</span><span class="cl">proxmox_virtual_environment_vm.k8s-cp-vms-cl02<span class="o">[</span>1<span class="o">]</span>: Still destroying... <span class="o">[</span><span class="nv">id</span><span class="o">=</span>1002, 1m0s elapsed<span class="o">]</span>
</span></span><span class="line"><span class="ln">34</span><span class="cl">proxmox_virtual_environment_vm.k8s-cp-vms-cl02<span class="o">[</span>2<span class="o">]</span>: Still destroying... <span class="o">[</span><span class="nv">id</span><span class="o">=</span>1003, 1m0s elapsed<span class="o">]</span>
</span></span><span class="line"><span class="ln">35</span><span class="cl">proxmox_virtual_environment_vm.k8s-cp-vms-cl02<span class="o">[</span>1<span class="o">]</span>: Still destroying... <span class="o">[</span><span class="nv">id</span><span class="o">=</span>1002, 1m10s elapsed<span class="o">]</span>
</span></span><span class="line"><span class="ln">36</span><span class="cl">proxmox_virtual_environment_vm.k8s-cp-vms-cl02<span class="o">[</span>2<span class="o">]</span>: Still destroying... <span class="o">[</span><span class="nv">id</span><span class="o">=</span>1003, 1m10s elapsed<span class="o">]</span>
</span></span><span class="line"><span class="ln">37</span><span class="cl">proxmox_virtual_environment_vm.k8s-cp-vms-cl02<span class="o">[</span>1<span class="o">]</span>: Still destroying... <span class="o">[</span><span class="nv">id</span><span class="o">=</span>1002, 1m20s elapsed<span class="o">]</span>
</span></span><span class="line"><span class="ln">38</span><span class="cl">proxmox_virtual_environment_vm.k8s-cp-vms-cl02<span class="o">[</span>2<span class="o">]</span>: Still destroying... <span class="o">[</span><span class="nv">id</span><span class="o">=</span>1003, 1m20s elapsed<span class="o">]</span>
</span></span><span class="line"><span class="ln">39</span><span class="cl">proxmox_virtual_environment_vm.k8s-cp-vms-cl02<span class="o">[</span>1<span class="o">]</span>: Still destroying... <span class="o">[</span><span class="nv">id</span><span class="o">=</span>1002, 1m30s elapsed<span class="o">]</span>
</span></span><span class="line"><span class="ln">40</span><span class="cl">proxmox_virtual_environment_vm.k8s-cp-vms-cl02<span class="o">[</span>2<span class="o">]</span>: Still destroying... <span class="o">[</span><span class="nv">id</span><span class="o">=</span>1003, 1m30s elapsed<span class="o">]</span>
</span></span><span class="line"><span class="ln">41</span><span class="cl">proxmox_virtual_environment_vm.k8s-cp-vms-cl02<span class="o">[</span>1<span class="o">]</span>: Destruction <span class="nb">complete</span> after 1m37s
</span></span><span class="line"><span class="ln">42</span><span class="cl">proxmox_virtual_environment_vm.k8s-cp-vms-cl02<span class="o">[</span>2<span class="o">]</span>: Destruction <span class="nb">complete</span> after 1m37s
</span></span><span class="line"><span class="ln">43</span><span class="cl">proxmox_virtual_environment_file.ubuntu_cloud_init: Destroying... <span class="o">[</span><span class="nv">id</span><span class="o">=</span>local:snippets/ubuntu.cloud-config.yaml<span class="o">]</span>
</span></span><span class="line"><span class="ln">44</span><span class="cl">proxmox_virtual_environment_file.ubuntu_cloud_init: Destruction <span class="nb">complete</span> after 0s
</span></span><span class="line"><span class="ln">45</span><span class="cl">
</span></span><span class="line"><span class="ln">46</span><span class="cl">Destroy complete! Resources: <span class="m">9</span> destroyed.
</span></span></code></pre></div><p>Now all the VMs, everything that has been deployed with OpenTofu is gone again. And it takes a couple of seconds or minutes depending on whether I have configured the provider to do a shutdown or stop of the VMs on <em>tofu destroy</em>. I am currently using shutdown.</p>
<h2 id="summary">Summary</h2>
<p>There is so much more that can be adjusted, improved and explored in general. But this post is just how I have done it now to solve a task I have been waiting to finally get some time to do. I will maybe do a follow up post where I do some improvements after some time using it and gained more experience on it. This includes improving the OpenTofu configs and Kubespray.</p>

    </div>




  </article>
<aside class="sidebar">
  <section class="sidebar_inner">
    <br>
    
  
  <div class="search">
    <input type="search" class="search_field form_field" placeholder='Search...' id="find" autocomplete="off" data-scope='post'>
    <label for="find" class="search_label"><svg class="icon">
  <title>search</title>
  <use xlink:href="#search"></use>
</svg>

    </label>
    
    <div class="search_results results"></div>
  </div>

        <h2>Hi there</h2>
      <div class="author_bio">
        This blog is a WIP, sometimes I just throw up some topics for myself to remember to be finished later. Stay tuned...
      </div>
      <a href='https://blog.andreasm.io/about/' class="button mt-1" role="button" title='Read More'>Read More</a>

    
    
    <h2 class="mt-4">Recent Posts</h2>
    <ul class="flex-column">
      <li>
        <a href="https://blog.andreasm.io/2024/02/04/argo-cd-vsphere-with-tanzu/" class="nav-link" title="Argo CD &amp; vSphere with Tanzu">Argo CD &amp; vSphere with Tanzu</a>
      </li>
      <li>
        <a href="https://blog.andreasm.io/2024/01/15/proxmox-with-opentofu-kubespray-and-kubernetes/" class="nav-link" title="Proxmox with OpenTofu Kubespray and Kubernetes">Proxmox with OpenTofu Kubespray and Kubernetes</a>
      </li>
      <li>
        <a href="https://blog.andreasm.io/2023/12/26/traefik-proxy-in-kubernetes/" class="nav-link" title="Traefik Proxy in Kubernetes">Traefik Proxy in Kubernetes</a>
      </li>
      <li>
        <a href="https://blog.andreasm.io/2023/12/18/a-quick-glance-at-cilium-cni/" class="nav-link" title="A Quick Glance at Cilium CNI">A Quick Glance at Cilium CNI</a>
      </li>
      <li>
        <a href="https://blog.andreasm.io/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/" class="nav-link" title="TKGi with NSX and NSX Advanced LoadBalancer">TKGi with NSX and NSX Advanced LoadBalancer</a>
      </li>
      <li>
        <a href="https://blog.andreasm.io/2023/09/25/antrea-multi-cluster-in-tkg-and-vsphere-with-tanzu/" class="nav-link" title="Antrea Multi-cluster - in TKG and vSphere with Tanzu">Antrea Multi-cluster - in TKG and vSphere with Tanzu</a>
      </li>
      <li>
        <a href="https://blog.andreasm.io/2023/09/23/vsphere-with-tanzu-8-u2-using-nsx-and-nsx-advanced-loadbalancer/" class="nav-link" title="vSphere with Tanzu 8 U2 using NSX AND NSX Advanced Loadbalancer">vSphere with Tanzu 8 U2 using NSX AND NSX Advanced Loadbalancer</a>
      </li>
      <li>
        <a href="https://blog.andreasm.io/2023/09/19/vsphere-with-tanzu-and-haproxy/" class="nav-link" title="vSphere with Tanzu and HAproxy">vSphere with Tanzu and HAproxy</a>
      </li>
    </ul>
    <div>
      <h2 class="mt-4 taxonomy" id="categories-section">Categories</h2>
      <nav class="tags_nav">
        <a href='https://blog.andreasm.io/categories/kubernetes/' class="post_tag button button_translucent" title="kubernetes">
          KUBERNETES
          <span class="button_tally">38</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/networking/' class="post_tag button button_translucent" title="networking">
          NETWORKING
          <span class="button_tally">20</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/tanzu/' class="post_tag button button_translucent" title="tanzu">
          TANZU
          <span class="button_tally">12</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/loadbalancing/' class="post_tag button button_translucent" title="loadbalancing">
          LOADBALANCING
          <span class="button_tally">9</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/cni/' class="post_tag button button_translucent" title="cni">
          CNI
          <span class="button_tally">8</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/security/' class="post_tag button button_translucent" title="security">
          SECURITY
          <span class="button_tally">6</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/avi/' class="post_tag button button_translucent" title="avi">
          AVI
          <span class="button_tally">5</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/nsx/' class="post_tag button button_translucent" title="nsx">
          NSX
          <span class="button_tally">4</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/antrea/' class="post_tag button button_translucent" title="antrea">
          ANTREA
          <span class="button_tally">3</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/automation/' class="post_tag button button_translucent" title="automation">
          AUTOMATION
          <span class="button_tally">2</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/blog/' class="post_tag button button_translucent" title="blog">
          BLOG
          <span class="button_tally">2</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/network/' class="post_tag button button_translucent" title="network">
          NETWORK
          <span class="button_tally">2</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/vmware-nsx/' class="post_tag button button_translucent" title="vmware-nsx">
          VMWARE-NSX
          <span class="button_tally">2</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/argocd/' class="post_tag button button_translucent" title="argocd">
          ARGOCD
          <span class="button_tally">1</span>
        </a>
        
        
        <br>
        <div class="post_tags_toggle button">All Categories</div>
        <div class="post_tags">
          <div class="tags_list">
            
            <a href='https://blog.andreasm.io/categories/antrea/' class=" post_tag button button_translucent" data-position=3 title="antrea">ANTREA<span class="button_tally">3</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/argocd/' class=" post_tag button button_translucent" data-position=1 title="argocd">ARGOCD<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/automation/' class=" post_tag button button_translucent" data-position=2 title="automation">AUTOMATION<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/autoscaling/' class=" post_tag button button_translucent" data-position=1 title="autoscaling">AUTOSCALING<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/avi/' class=" post_tag button button_translucent" data-position=5 title="avi">AVI<span class="button_tally">5</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/blog/' class=" post_tag button button_translucent" data-position=2 title="blog">BLOG<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/certificate/' class=" post_tag button button_translucent" data-position=1 title="certificate">CERTIFICATE<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/cni/' class=" post_tag button button_translucent" data-position=8 title="cni">CNI<span class="button_tally">8</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/docker/' class=" post_tag button button_translucent" data-position=1 title="docker">DOCKER<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/ebpf/' class=" post_tag button button_translucent" data-position=1 title="ebpf">EBPF<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/github/' class=" post_tag button button_translucent" data-position=1 title="github">GITHUB<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/gitops/' class=" post_tag button button_translucent" data-position=1 title="gitops">GITOPS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/harbor/' class=" post_tag button button_translucent" data-position=1 title="harbor">HARBOR<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/helm/' class=" post_tag button button_translucent" data-position=1 title="helm">HELM<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/home-automation/' class=" post_tag button button_translucent" data-position=1 title="home-automation">HOME-AUTOMATION<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/hugo/' class=" post_tag button button_translucent" data-position=1 title="hugo">HUGO<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/ingress/' class=" post_tag button button_translucent" data-position=1 title="ingress">INGRESS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/kubernetes/' class=" post_tag button button_translucent" data-position=38 title="kubernetes">KUBERNETES<span class="button_tally">38</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/lcm/' class=" post_tag button button_translucent" data-position=1 title="lcm">LCM<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/lifecycle-management/' class=" post_tag button button_translucent" data-position=1 title="lifecycle-management">LIFECYCLE-MANAGEMENT<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/loadbalancing/' class=" post_tag button button_translucent" data-position=9 title="loadbalancing">LOADBALANCING<span class="button_tally">9</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/management/' class=" post_tag button button_translucent" data-position=1 title="management">MANAGEMENT<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/monitoring/' class=" post_tag button button_translucent" data-position=1 title="monitoring">MONITORING<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/netowkring/' class=" post_tag button button_translucent" data-position=1 title="netowkring">NETOWKRING<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/network/' class=" post_tag button button_translucent" data-position=2 title="network">NETWORK<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/networking/' class=" post_tag button button_translucent" data-position=20 title="networking">NETWORKING<span class="button_tally">20</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/nsx/' class=" post_tag button button_translucent" data-position=4 title="nsx">NSX<span class="button_tally">4</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/nsx-alb/' class=" post_tag button button_translucent" data-position=1 title="nsx-alb">NSX-ALB<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/nsx-t/' class=" post_tag button button_translucent" data-position=1 title="nsx-t">NSX-T<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/pinniped/' class=" post_tag button button_translucent" data-position=1 title="pinniped">PINNIPED<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/rbac/' class=" post_tag button button_translucent" data-position=1 title="rbac">RBAC<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/security/' class=" post_tag button button_translucent" data-position=6 title="security">SECURITY<span class="button_tally">6</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/storage/' class=" post_tag button button_translucent" data-position=1 title="storage">STORAGE<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/tanzu/' class=" post_tag button button_translucent" data-position=12 title="tanzu">TANZU<span class="button_tally">12</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/tanzu-mission-control/' class=" post_tag button button_translucent" data-position=1 title="tanzu-mission-control">TANZU-MISSION-CONTROL<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/tkg/' class=" post_tag button button_translucent" data-position=1 title="tkg">TKG<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/tkgi/' class=" post_tag button button_translucent" data-position=1 title="tkgi">TKGI<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/tmc/' class=" post_tag button button_translucent" data-position=1 title="tmc">TMC<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/troubleshooting/' class=" post_tag button button_translucent" data-position=1 title="troubleshooting">TROUBLESHOOTING<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/virtualization/' class=" post_tag button button_translucent" data-position=1 title="virtualization">VIRTUALIZATION<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/vmare-nsx-intelligence/' class=" post_tag button button_translucent" data-position=1 title="vmare-nsx-intelligence">VMARE-NSX-INTELLIGENCE<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/vmware-cloud/' class=" post_tag button button_translucent" data-position=1 title="vmware-cloud">VMWARE-CLOUD<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/vmware-nsx/' class=" post_tag button button_translucent" data-position=2 title="vmware-nsx">VMWARE-NSX<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/vsphere/' class=" post_tag button button_translucent" data-position=1 title="vsphere">VSPHERE<span class="button_tally">1</span>
            </a>
            
            <div class="tags_sort"><span title="sort alphabetically">[A~Z]</span><span title="sort by count">[0~9]</span>
            </div>
            <span class="tags_hide"><svg class="icon">
            <use xlink:href="#closeme"></use>
          </svg></span>
          </div>
        </div>
      </nav>
    </div>
    <div>
      <h2 class="mt-4 taxonomy" id="tags-section">Tags</h2>
      <nav class="tags_nav">
        <a href='https://blog.andreasm.io/tags/kubernetes/' class="post_tag button button_translucent" title="kubernetes">
          KUBERNETES
          <span class="button_tally">21</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/tanzu/' class="post_tag button button_translucent" title="tanzu">
          TANZU
          <span class="button_tally">14</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/nsx/' class="post_tag button button_translucent" title="nsx">
          NSX
          <span class="button_tally">12</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/antrea/' class="post_tag button button_translucent" title="antrea">
          ANTREA
          <span class="button_tally">11</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/ako/' class="post_tag button button_translucent" title="ako">
          AKO
          <span class="button_tally">8</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/avi/' class="post_tag button button_translucent" title="avi">
          AVI
          <span class="button_tally">6</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/loadbalancing/' class="post_tag button button_translucent" title="loadbalancing">
          LOADBALANCING
          <span class="button_tally">6</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/security/' class="post_tag button button_translucent" title="security">
          SECURITY
          <span class="button_tally">6</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/ingress/' class="post_tag button button_translucent" title="ingress">
          INGRESS
          <span class="button_tally">5</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/availability/' class="post_tag button button_translucent" title="availability">
          AVAILABILITY
          <span class="button_tally">3</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/cert-manager/' class="post_tag button button_translucent" title="cert-manager">
          CERT-MANAGER
          <span class="button_tally">3</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/cni/' class="post_tag button button_translucent" title="cni">
          CNI
          <span class="button_tally">3</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/network/' class="post_tag button button_translucent" title="network">
          NETWORK
          <span class="button_tally">3</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/authentication/' class="post_tag button button_translucent" title="authentication">
          AUTHENTICATION
          <span class="button_tally">2</span>
        </a>
        
        
        <br>
        <div class="post_tags_toggle button">All Tags</div>
        <div class="post_tags">
          <div class="tags_list">
            
            <a href='https://blog.andreasm.io/tags/ako/' class=" post_tag button button_translucent" data-position=8 title="ako">AKO<span class="button_tally">8</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/amko/' class=" post_tag button button_translucent" data-position=1 title="amko">AMKO<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/ansible/' class=" post_tag button button_translucent" data-position=1 title="ansible">ANSIBLE<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/antrea/' class=" post_tag button button_translucent" data-position=11 title="antrea">ANTREA<span class="button_tally">11</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/argocd/' class=" post_tag button button_translucent" data-position=1 title="argocd">ARGOCD<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/authentication/' class=" post_tag button button_translucent" data-position=2 title="authentication">AUTHENTICATION<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/automation/' class=" post_tag button button_translucent" data-position=1 title="automation">AUTOMATION<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/autoscaling/' class=" post_tag button button_translucent" data-position=1 title="autoscaling">AUTOSCALING<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/availability/' class=" post_tag button button_translucent" data-position=3 title="availability">AVAILABILITY<span class="button_tally">3</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/avi/' class=" post_tag button button_translucent" data-position=6 title="avi">AVI<span class="button_tally">6</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/cert-manager/' class=" post_tag button button_translucent" data-position=3 title="cert-manager">CERT-MANAGER<span class="button_tally">3</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/certificate/' class=" post_tag button button_translucent" data-position=1 title="certificate">CERTIFICATE<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/cilium/' class=" post_tag button button_translucent" data-position=1 title="cilium">CILIUM<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/cni/' class=" post_tag button button_translucent" data-position=3 title="cni">CNI<span class="button_tally">3</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/custom-resource-definitions/' class=" post_tag button button_translucent" data-position=1 title="custom-resource-definitions">CUSTOM-RESOURCE-DEFINITIONS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/distributed-firewall/' class=" post_tag button button_translucent" data-position=1 title="distributed-firewall">DISTRIBUTED-FIREWALL<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/dns-service/' class=" post_tag button button_translucent" data-position=1 title="dns-service">DNS-SERVICE<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/docker/' class=" post_tag button button_translucent" data-position=2 title="docker">DOCKER<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/ebpf/' class=" post_tag button button_translucent" data-position=1 title="ebpf">EBPF<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/github/' class=" post_tag button button_translucent" data-position=1 title="github">GITHUB<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/gitops/' class=" post_tag button button_translucent" data-position=1 title="gitops">GITOPS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/gslb/' class=" post_tag button button_translucent" data-position=1 title="gslb">GSLB<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/harbor/' class=" post_tag button button_translucent" data-position=1 title="harbor">HARBOR<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/home-assistant/' class=" post_tag button button_translucent" data-position=1 title="home-assistant">HOME-ASSISTANT<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/hugo/' class=" post_tag button button_translucent" data-position=2 title="hugo">HUGO<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/ids/' class=" post_tag button button_translucent" data-position=1 title="ids">IDS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/informational/' class=" post_tag button button_translucent" data-position=2 title="informational">INFORMATIONAL<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/ingress/' class=" post_tag button button_translucent" data-position=5 title="ingress">INGRESS<span class="button_tally">5</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/ips/' class=" post_tag button button_translucent" data-position=1 title="ips">IPS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/keycloak/' class=" post_tag button button_translucent" data-position=1 title="keycloak">KEYCLOAK<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/kubernetes/' class=" post_tag button button_translucent" data-position=21 title="kubernetes">KUBERNETES<span class="button_tally">21</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/kubernetes-api-endpoint/' class=" post_tag button button_translucent" data-position=1 title="kubernetes-api-endpoint">KUBERNETES-API-ENDPOINT<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/kubespray/' class=" post_tag button button_translucent" data-position=1 title="kubespray">KUBESPRAY<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/lifecycle-management/' class=" post_tag button button_translucent" data-position=1 title="lifecycle-management">LIFECYCLE-MANAGEMENT<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/load-balancing/' class=" post_tag button button_translucent" data-position=1 title="load-balancing">LOAD-BALANCING<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/loadbalancer/' class=" post_tag button button_translucent" data-position=1 title="loadbalancer">LOADBALANCER<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/loadbalancing/' class=" post_tag button button_translucent" data-position=6 title="loadbalancing">LOADBALANCING<span class="button_tally">6</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/lodbalancing/' class=" post_tag button button_translucent" data-position=1 title="lodbalancing">LODBALANCING<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/management/' class=" post_tag button button_translucent" data-position=1 title="management">MANAGEMENT<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/multi-cluster/' class=" post_tag button button_translucent" data-position=1 title="multi-cluster">MULTI-CLUSTER<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/multi-dc/' class=" post_tag button button_translucent" data-position=1 title="multi-dc">MULTI-DC<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/network/' class=" post_tag button button_translucent" data-position=3 title="network">NETWORK<span class="button_tally">3</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/network-policies/' class=" post_tag button button_translucent" data-position=2 title="network-policies">NETWORK-POLICIES<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/networking/' class=" post_tag button button_translucent" data-position=2 title="networking">NETWORKING<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/nfs/' class=" post_tag button button_translucent" data-position=1 title="nfs">NFS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/nsx/' class=" post_tag button button_translucent" data-position=12 title="nsx">NSX<span class="button_tally">12</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/nsx-advanced-loadbalancer/' class=" post_tag button button_translucent" data-position=1 title="nsx-advanced-loadbalancer">NSX-ADVANCED-LOADBALANCER<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/nsx-alb/' class=" post_tag button button_translucent" data-position=1 title="nsx-alb">NSX-ALB<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/nsx-application-platform/' class=" post_tag button button_translucent" data-position=1 title="nsx-application-platform">NSX-APPLICATION-PLATFORM<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/nsx-t/' class=" post_tag button button_translucent" data-position=2 title="nsx-t">NSX-T<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/opentofu/' class=" post_tag button button_translucent" data-position=1 title="opentofu">OPENTOFU<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/persistent-storage/' class=" post_tag button button_translucent" data-position=1 title="persistent-storage">PERSISTENT-STORAGE<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/pinniped/' class=" post_tag button button_translucent" data-position=1 title="pinniped">PINNIPED<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/proxmox/' class=" post_tag button button_translucent" data-position=1 title="proxmox">PROXMOX<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/proxy/' class=" post_tag button button_translucent" data-position=1 title="proxy">PROXY<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/pvc/' class=" post_tag button button_translucent" data-position=1 title="pvc">PVC<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/rbac/' class=" post_tag button button_translucent" data-position=1 title="rbac">RBAC<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/registry/' class=" post_tag button button_translucent" data-position=1 title="registry">REGISTRY<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/security/' class=" post_tag button button_translucent" data-position=6 title="security">SECURITY<span class="button_tally">6</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/static-content-generator/' class=" post_tag button button_translucent" data-position=1 title="static-content-generator">STATIC-CONTENT-GENERATOR<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/static-site-generator/' class=" post_tag button button_translucent" data-position=1 title="static-site-generator">STATIC-SITE-GENERATOR<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/tanzu/' class=" post_tag button button_translucent" data-position=14 title="tanzu">TANZU<span class="button_tally">14</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/tanzu-kubernetes-grid/' class=" post_tag button button_translucent" data-position=1 title="tanzu-kubernetes-grid">TANZU-KUBERNETES-GRID<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/terraform/' class=" post_tag button button_translucent" data-position=1 title="terraform">TERRAFORM<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/tkg/' class=" post_tag button button_translucent" data-position=1 title="tkg">TKG<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/tkg-2.1/' class=" post_tag button button_translucent" data-position=1 title="tkg-2.1">TKG-2.1<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/tkgi/' class=" post_tag button button_translucent" data-position=1 title="tkgi">TKGI<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/tkgs/' class=" post_tag button button_translucent" data-position=1 title="tkgs">TKGS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/tmc/' class=" post_tag button button_translucent" data-position=1 title="tmc">TMC<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/tmc-local/' class=" post_tag button button_translucent" data-position=1 title="tmc-local">TMC-LOCAL<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/tmc-sm/' class=" post_tag button button_translucent" data-position=1 title="tmc-sm">TMC-SM<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/traefik/' class=" post_tag button button_translucent" data-position=1 title="traefik">TRAEFIK<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/troubleshooting/' class=" post_tag button button_translucent" data-position=2 title="troubleshooting">TROUBLESHOOTING<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/unifi/' class=" post_tag button button_translucent" data-position=1 title="unifi">UNIFI<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/vmconaws/' class=" post_tag button button_translucent" data-position=1 title="vmconaws">VMCONAWS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/vsphere/' class=" post_tag button button_translucent" data-position=2 title="vsphere">VSPHERE<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/vsphere-replication/' class=" post_tag button button_translucent" data-position=1 title="vsphere-replication">VSPHERE-REPLICATION<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/vsphere-with-tanzu/' class=" post_tag button button_translucent" data-position=1 title="vsphere-with-tanzu">VSPHERE-WITH-TANZU<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/zwave/' class=" post_tag button button_translucent" data-position=1 title="zwave">ZWAVE<span class="button_tally">1</span>
            </a>
            
            <div class="tags_sort"><span title="sort alphabetically">[A~Z]</span><span title="sort by count">[0~9]</span>
            </div>
            <span class="tags_hide"><svg class="icon">
            <use xlink:href="#closeme"></use>
          </svg></span>
          </div>
        </div>
      </nav>
    </div>
  </section>
</aside>

  
</div>
    </main><svg width="0" height="0" class="hidden">
  <symbol viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" id="facebook">
    <path d="M437 0H75C33.648 0 0 33.648 0 75v362c0 41.352 33.648 75 75 75h151V331h-60v-90h60v-61c0-49.629 40.371-90 90-90h91v90h-91v61h91l-15 90h-76v181h121c41.352 0 75-33.648 75-75V75c0-41.352-33.648-75-75-75zm0 0"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18.001 18.001" id="twitter">
    <path d="M15.891 4.013c.808-.496 1.343-1.173 1.605-2.034a8.68 8.68 0 0 1-2.351.861c-.703-.756-1.593-1.14-2.66-1.14-1.043 0-1.924.366-2.643 1.078a3.56 3.56 0 0 0-1.076 2.605c0 .309.039.585.117.819-3.076-.105-5.622-1.381-7.628-3.837-.34.601-.51 1.213-.51 1.846 0 1.301.549 2.332 1.645 3.089-.625-.053-1.176-.211-1.645-.47 0 .929.273 1.705.82 2.388a3.623 3.623 0 0 0 2.115 1.291c-.312.08-.641.118-.979.118-.312 0-.533-.026-.664-.083.23.757.664 1.371 1.291 1.841a3.652 3.652 0 0 0 2.152.743C4.148 14.173 2.625 14.69.902 14.69c-.422 0-.721-.006-.902-.038 1.697 1.102 3.586 1.649 5.676 1.649 2.139 0 4.029-.542 5.674-1.626 1.645-1.078 2.859-2.408 3.639-3.974a10.77 10.77 0 0 0 1.172-4.892v-.468a7.788 7.788 0 0 0 1.84-1.921 8.142 8.142 0 0 1-2.11.593z"
      ></path>
  </symbol>
  <symbol aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id="mail">
    <path  d="M502.3 190.8c3.9-3.1 9.7-.2 9.7 4.7V400c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V195.6c0-5 5.7-7.8 9.7-4.7 22.4 17.4 52.1 39.5 154.1 113.6 21.1 15.4 56.7 47.8 92.2 47.6 35.7.3 72-32.8 92.3-47.6 102-74.1 131.6-96.3 154-113.7zM256 320c23.2.4 56.6-29.2 73.4-41.4 132.7-96.3 142.8-104.7 173.4-128.7 5.8-4.5 9.2-11.5 9.2-18.9v-19c0-26.5-21.5-48-48-48H48C21.5 64 0 85.5 0 112v19c0 7.4 3.4 14.3 9.2 18.9 30.6 23.9 40.7 32.4 173.4 128.7 16.8 12.2 50.2 41.8 73.4 41.4z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id="calendar">
    <path d="M452 40h-24V0h-40v40H124V0H84v40H60C26.916 40 0 66.916 0 100v352c0 33.084 26.916 60 60 60h392c33.084 0 60-26.916 60-60V100c0-33.084-26.916-60-60-60zm20 412c0 11.028-8.972 20-20 20H60c-11.028 0-20-8.972-20-20V188h432v264zm0-304H40v-48c0-11.028 8.972-20 20-20h24v40h40V80h264v40h40V80h24c11.028 0 20 8.972 20 20v48z"></path>
    <path d="M76 230h40v40H76zm80 0h40v40h-40zm80 0h40v40h-40zm80 0h40v40h-40zm80 0h40v40h-40zM76 310h40v40H76zm80 0h40v40h-40zm80 0h40v40h-40zm80 0h40v40h-40zM76 390h40v40H76zm80 0h40v40h-40zm80 0h40v40h-40zm80 0h40v40h-40zm80-80h40v40h-40z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id="github">
    <path d="M255.968 5.329C114.624 5.329 0 120.401 0 262.353c0 113.536 73.344 209.856 175.104 243.872 12.8 2.368 17.472-5.568 17.472-12.384 0-6.112-.224-22.272-.352-43.712-71.2 15.52-86.24-34.464-86.24-34.464-11.616-29.696-28.416-37.6-28.416-37.6-23.264-15.936 1.728-15.616 1.728-15.616 25.696 1.824 39.2 26.496 39.2 26.496 22.848 39.264 59.936 27.936 74.528 21.344 2.304-16.608 8.928-27.936 16.256-34.368-56.832-6.496-116.608-28.544-116.608-127.008 0-28.064 9.984-51.008 26.368-68.992-2.656-6.496-11.424-32.64 2.496-68 0 0 21.504-6.912 70.4 26.336 20.416-5.696 42.304-8.544 64.096-8.64 21.728.128 43.648 2.944 64.096 8.672 48.864-33.248 70.336-26.336 70.336-26.336 13.952 35.392 5.184 61.504 2.56 68 16.416 17.984 26.304 40.928 26.304 68.992 0 98.72-59.84 120.448-116.864 126.816 9.184 7.936 17.376 23.616 17.376 47.584 0 34.368-.32 62.08-.32 70.496 0 6.88 4.608 14.88 17.6 12.352C438.72 472.145 512 375.857 512 262.353 512 120.401 397.376 5.329 255.968 5.329z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 212 212" id="gitlab">
    <path d="M12.3 74.7h54L43.3 3c-1-3.6-6.4-3.6-7.6 0L12.3 74.8z" />
    <path d="M12.3 74.7L.5 111c-1 3.2 0 6.8 3 8.8l101.6 74-92.5-119z"/>
    <path d="M105 193.7l-38.6-119h-54l92.7 119z"/>
    <path d="M105 193.7l38.7-119H66.4l38.7 119z"/>
    <path d="M105 193.7l38.7-119H198l-93 119z"/>
    <path d="M198 74.7l11.6 36.2c1 3 0 6.6-3 8.6l-101.5 74 93-119z"/>
    <path d="M198 74.7h-54.3L167 3c1.2-3.6 6.4-3.6 7.6 0L198 74.8z"/> 
  </symbol>
  <symbol viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" id="rss">
    <circle cx="3.429" cy="20.571" r="3.429"></circle>
    <path d="M11.429 24h4.57C15.999 15.179 8.821 8.001 0 8v4.572c6.302.001 11.429 5.126 11.429 11.428z"></path>
    <path d="M24 24C24 10.766 13.234 0 0 0v4.571c10.714 0 19.43 8.714 19.43 19.429z"></path>
  </symbol>
  <symbol viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" id="linkedin">
    <path d="M437 0H75C33.648 0 0 33.648 0 75v362c0 41.352 33.648 75 75 75h362c41.352 0 75-33.648 75-75V75c0-41.352-33.648-75-75-75zM181 406h-60V196h60zm0-240h-60v-60h60zm210 240h-60V286c0-16.54-13.46-30-30-30s-30 13.46-30 30v120h-60V196h60v11.309C286.719 202.422 296.93 196 316 196c40.691.043 75 36.547 75 79.688zm0 0"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 612 612" id="to-top">
    <path d="M604.501 440.509L325.398 134.956c-5.331-5.357-12.423-7.627-19.386-7.27-6.989-.357-14.056 1.913-19.387 7.27L7.499 440.509c-9.999 10.024-9.999 26.298 0 36.323s26.223 10.024 36.222 0l262.293-287.164L568.28 476.832c9.999 10.024 26.222 10.024 36.221 0 9.999-10.023 9.999-26.298 0-36.323z"></path>
  </symbol>
  <symbol viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" id="carly">
    <path d="M504.971 239.029L448 182.059V84c0-46.317-37.682-84-84-84h-44c-13.255 0-24 10.745-24 24s10.745 24 24 24h44c19.851 0 36 16.149 36 36v108c0 6.365 2.529 12.47 7.029 16.971L454.059 256l-47.029 47.029A24.002 24.002 0 0 0 400 320v108c0 19.851-16.149 36-36 36h-44c-13.255 0-24 10.745-24 24s10.745 24 24 24h44c46.318 0 84-37.683 84-84v-98.059l56.971-56.971c9.372-9.372 9.372-24.568 0-33.941zM112 192V84c0-19.851 16.149-36 36-36h44c13.255 0 24-10.745 24-24S205.255 0 192 0h-44c-46.318 0-84 37.683-84 84v98.059l-56.971 56.97c-9.373 9.373-9.373 24.568 0 33.941L64 329.941V428c0 46.317 37.682 84 84 84h44c13.255 0 24-10.745 24-24s-10.745-24-24-24h-44c-19.851 0-36-16.149-36-36V320c0-6.365-2.529-12.47-7.029-16.971L57.941 256l47.029-47.029A24.002 24.002 0 0 0 112 192z"></path>
  </symbol>
  <symbol viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" id="copy">
    <path d="M23 2.75A2.75 2.75 0 0 0 20.25 0H8.75A2.75 2.75 0 0 0 6 2.75v13.5A2.75 2.75 0 0 0 8.75 19h11.5A2.75 2.75 0 0 0 23 16.25zM18.25 14.5h-7.5a.75.75 0 0 1 0-1.5h7.5a.75.75 0 0 1 0 1.5zm0-3h-7.5a.75.75 0 0 1 0-1.5h7.5a.75.75 0 0 1 0 1.5zm0-3h-7.5a.75.75 0 0 1 0-1.5h7.5a.75.75 0 0 1 0 1.5z"></path>
    <path d="M8.75 20.5a4.255 4.255 0 0 1-4.25-4.25V2.75c0-.086.02-.166.025-.25H3.75A2.752 2.752 0 0 0 1 5.25v16A2.752 2.752 0 0 0 3.75 24h12a2.752 2.752 0 0 0 2.75-2.75v-.75z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512.001 512.001" id="closeme">
    <path d="M284.286 256.002L506.143 34.144c7.811-7.811 7.811-20.475 0-28.285-7.811-7.81-20.475-7.811-28.285 0L256 227.717 34.143 5.859c-7.811-7.811-20.475-7.811-28.285 0-7.81 7.811-7.811 20.475 0 28.285l221.857 221.857L5.858 477.859c-7.811 7.811-7.811 20.475 0 28.285a19.938 19.938 0 0 0 14.143 5.857 19.94 19.94 0 0 0 14.143-5.857L256 284.287l221.857 221.857c3.905 3.905 9.024 5.857 14.143 5.857s10.237-1.952 14.143-5.857c7.811-7.811 7.811-20.475 0-28.285L284.286 256.002z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id="open-menu">
    <path d="M492 236H20c-11.046 0-20 8.954-20 20s8.954 20 20 20h472c11.046 0 20-8.954 20-20s-8.954-20-20-20zm0-160H20C8.954 76 0 84.954 0 96s8.954 20 20 20h472c11.046 0 20-8.954 20-20s-8.954-20-20-20zm0 320H20c-11.046 0-20 8.954-20 20s8.954 20 20 20h472c11.046 0 20-8.954 20-20s-8.954-20-20-20z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="instagram">
    <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id=youtube>
    <path d="M19.615 3.184c-3.604-.246-11.631-.245-15.23 0-3.897.266-4.356 2.62-4.385 8.816.029 6.185.484 8.549 4.385 8.816 3.6.245 11.626.246 15.23 0 3.897-.266 4.356-2.62 4.385-8.816-.029-6.185-.484-8.549-4.385-8.816zm-10.615 12.816v-8l8 3.993-8 4.007z"/>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="stackoverflow">
    <path d="M21 27v-8h3v11H0V19h3v8h18z"></path><path d="M17.1.2L15 1.8l7.9 10.6 2.1-1.6L17.1.2zm3.7 14.7L10.6 6.4l1.7-2 10.2 8.5-1.7 2zM7.2 12.3l12 5.6 1.1-2.4-12-5.6-1.1 2.4zm-1.8 6.8l13.56 1.96.17-2.38-13.26-2.55-.47 2.97zM19 25H5v-3h14v3z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="xing">
    <path d="M18.188 0c-.517 0-.741.325-.927.66 0 0-7.455 13.224-7.702 13.657.015.024 4.919 9.023 4.919 9.023.17.308.436.66.967.66h3.454c.211 0 .375-.078.463-.22.089-.151.089-.346-.009-.536l-4.879-8.916c-.004-.006-.004-.016 0-.022L22.139.756c.095-.191.097-.387.006-.535C22.056.078 21.894 0 21.686 0h-3.498zM3.648 4.74c-.211 0-.385.074-.473.216-.09.149-.078.339.02.531l2.34 4.05c.004.01.004.016 0 .021L1.86 16.051c-.099.188-.093.381 0 .529.085.142.239.234.45.234h3.461c.518 0 .766-.348.945-.667l3.734-6.609-2.378-4.155c-.172-.315-.434-.659-.962-.659H3.648v.016z"/>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 71 55" id="discord">
    <path d="M60.1045 4.8978C55.5792 2.8214 50.7265 1.2916 45.6527 0.41542C45.5603 0.39851 45.468 0.440769 45.4204 0.525289C44.7963 1.6353 44.105 3.0834 43.6209 4.2216C38.1637 3.4046 32.7345 3.4046 27.3892 4.2216C26.905 3.0581 26.1886 1.6353 25.5617 0.525289C25.5141 0.443589 25.4218 0.40133 25.3294 0.41542C20.2584 1.2888 15.4057 2.8186 10.8776 4.8978C10.8384 4.9147 10.8048 4.9429 10.7825 4.9795C1.57795 18.7309 -0.943561 32.1443 0.293408 45.3914C0.299005 45.4562 0.335386 45.5182 0.385761 45.5576C6.45866 50.0174 12.3413 52.7249 18.1147 54.5195C18.2071 54.5477 18.305 54.5139 18.3638 54.4378C19.7295 52.5728 20.9469 50.6063 21.9907 48.5383C22.0523 48.4172 21.9935 48.2735 21.8676 48.2256C19.9366 47.4931 18.0979 46.6 16.3292 45.5858C16.1893 45.5041 16.1781 45.304 16.3068 45.2082C16.679 44.9293 17.0513 44.6391 17.4067 44.3461C17.471 44.2926 17.5606 44.2813 17.6362 44.3151C29.2558 49.6202 41.8354 49.6202 53.3179 44.3151C53.3935 44.2785 53.4831 44.2898 53.5502 44.3433C53.9057 44.6363 54.2779 44.9293 54.6529 45.2082C54.7816 45.304 54.7732 45.5041 54.6333 45.5858C52.8646 46.6197 51.0259 47.4931 49.0921 48.2228C48.9662 48.2707 48.9102 48.4172 48.9718 48.5383C50.038 50.6034 51.2554 52.5699 52.5959 54.435C52.6519 54.5139 52.7526 54.5477 52.845 54.5195C58.6464 52.7249 64.529 50.0174 70.6019 45.5576C70.6551 45.5182 70.6887 45.459 70.6943 45.3942C72.1747 30.0791 68.2147 16.7757 60.1968 4.9823C60.1772 4.9429 60.1437 4.9147 60.1045 4.8978ZM23.7259 37.3253C20.2276 37.3253 17.3451 34.1136 17.3451 30.1693C17.3451 26.225 20.1717 23.0133 23.7259 23.0133C27.308 23.0133 30.1626 26.2532 30.1066 30.1693C30.1066 34.1136 27.28 37.3253 23.7259 37.3253ZM47.3178 37.3253C43.8196 37.3253 40.9371 34.1136 40.9371 30.1693C40.9371 26.225 43.7636 23.0133 47.3178 23.0133C50.9 23.0133 53.7545 26.2532 53.6986 30.1693C53.6986 34.1136 50.9 37.3253 47.3178 37.3253Z"/>
  </symbol>
</svg>


<footer class="footer">
  <div class="footer_inner wrap pale">
    <img src='https://blog.andreasm.io/icons/apple-touch-icon.png' class="icon icon_2 transparent" alt="From 0.985mhz... to several Ghz">
    <p>Copyright&nbsp;2016-&nbsp;<span class="year"></span>&nbsp;FROM 0.985MHZ... TO SEVERAL GHZ. All Rights Reserved</p><a class="to_top" href="#documentTop">
  <svg class="icon">
  <title>to-top</title>
  <use xlink:href="#to-top"></use>
</svg>

</a>

  </div>
</footer>

<script type="text/javascript" src="https://blog.andreasm.io/en/js/bundle.5548d358738600c857a1f05f0459418da7143d4426c66a08bf3f15ded1b39dd2136bf104a559247a909fc4dcc45b8e06bad0870ece4c71ee5303d30550def8bd.js" integrity="sha512-VUjTWHOGAMhXofBfBFlBjacUPUQmxmoIvz8V3tGzndITa/EEpVkkepCfxNzEW44GutCHDs5Mce5TA9MFUN74vQ==" crossorigin="anonymous"></script>

  <script src="https://blog.andreasm.io/js/search.min.df4d84e4983f0c71dd495e07a09815d920553c3ddf3d0767801c73373573aa17e1b489e4453272dbf4ce2a38a3d01a10b170744e50dd6bec85a598221867ba9a.js"></script>

  </body>
</html>
