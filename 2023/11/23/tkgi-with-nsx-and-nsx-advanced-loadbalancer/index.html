
<!DOCTYPE html>
<html
  lang="en"
  data-figures=""
  
    class="page"
  
  
  
    data-mode="dim"
  >
  <head>
<title>TKGi with NSX and NSX Advanced LoadBalancer | From 0.985mhz... to several Ghz</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-TVPYDVE8KR"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-TVPYDVE8KR');
</script>



  
<meta property="og:locale" content="en" />

<meta property="og:type" content="article">
<meta name="description" content="Using TKGi with NSX ALB for both L4 and L7 services" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:creator" content="">
<meta name="twitter:title" content="TKGi with NSX and NSX Advanced LoadBalancer" />
<meta name="twitter:image" content="https://blog.andreasm.io/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/logo-vmware-tanzu.png"/>
<meta property="og:url" content="https://blog.andreasm.io/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/" />
<meta property="og:title" content="TKGi with NSX and NSX Advanced LoadBalancer" />
<meta property="og:description" content="Using TKGi with NSX ALB for both L4 and L7 services" />
<meta property="og:image" content="https://blog.andreasm.io/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/logo-vmware-tanzu.png" />
  <meta name="keywords" content="nsx,vmware,kubernetes" />

<link rel="apple-touch-icon" sizes="180x180" href="https://blog.andreasm.io/icons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://blog.andreasm.io/icons/favicon-32x32.png">
<link rel="manifest" href="https://blog.andreasm.io/icons/site.webmanifest">

<link rel="canonical" href="https://blog.andreasm.io/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/">



<link rel="preload" href="https://blog.andreasm.io/css/styles.6c67fa3a7f5290a2facfb027358dd2bdb5450d04b8de427c8a74d79f524a7fb716b470b14b6ba95f1b7cf3aa9a2219a7294a6adeaf16a1080f432eae45d8c03c.css" integrity = "sha512-bGf6On9SkKL6z7AnNY3SvbVFDQS43kJ8inTXn1JKf7cWtHCxS2upXxt886qaIhmnKUpq3q8WoQgPQy6uRdjAPA==" as="style" crossorigin="anonymous">



<link rel="preload" href="https://blog.andreasm.io/en/js/bundle.5548d358738600c857a1f05f0459418da7143d4426c66a08bf3f15ded1b39dd2136bf104a559247a909fc4dcc45b8e06bad0870ece4c71ee5303d30550def8bd.js" as="script" integrity=
"sha512-VUjTWHOGAMhXofBfBFlBjacUPUQmxmoIvz8V3tGzndITa/EEpVkkepCfxNzEW44GutCHDs5Mce5TA9MFUN74vQ==" crossorigin="anonymous">


<link rel="stylesheet" type="text/css" href="https://blog.andreasm.io/css/styles.6c67fa3a7f5290a2facfb027358dd2bdb5450d04b8de427c8a74d79f524a7fb716b470b14b6ba95f1b7cf3aa9a2219a7294a6adeaf16a1080f432eae45d8c03c.css" integrity="sha512-bGf6On9SkKL6z7AnNY3SvbVFDQS43kJ8inTXn1JKf7cWtHCxS2upXxt886qaIhmnKUpq3q8WoQgPQy6uRdjAPA==" crossorigin="anonymous">


  </head>
  <body
    data-code="7"
    data-lines="false"
    id="documentTop"
    data-lang="en"
  >

<header class="nav_header" >
  <nav class="nav"><a href='https://blog.andreasm.io/' class="nav_brand nav_item" title="From 0.985mhz... to several Ghz">
  <img src="https://blog.andreasm.io/quote3.png" class="logo" alt="From 0.985mhz... to several Ghz">
  <div class="nav_close">
    <div><svg class="icon">
  <title>open-menu</title>
  <use xlink:href="#open-menu"></use>
</svg>
<svg class="icon">
  <title>closeme</title>
  <use xlink:href="#closeme"></use>
</svg>
</div>
  </div>
</a>

    <div class='nav_body nav_body_left'>
      
      
      
        

  <div class="nav_parent">
    <a href="https://blog.andreasm.io/" class="nav_item" title="Home">Home </a>
  </div>
  <div class="nav_parent">
    <a href="https://blog.andreasm.io/about/" class="nav_item" title="About">About </a>
  </div>
      
<div class='follow'>
<div class="color_mode">
  <input type="checkbox" class="color_choice" id="mode">
</div>

</div>

    </div>
  </nav>
</header>

    <main>
  
<div class="grid-inverse wrap content">
  <article class="post_content">
    <h1 class="post_title">TKGi with NSX and NSX Advanced LoadBalancer</h1>
  <div class="post_meta">
    <span><svg class="icon">
  <title>calendar</title>
  <use xlink:href="#calendar"></use>
</svg>
</span>
    <span class="post_date">
      23-11-2023</span>
    <span class="post_time"> · 41 min read</span><span>&nbsp;· <a href='https://blog.andreasm.io/tags/nsx-alb/' title="nsx-alb" class="post_tag button button_translucent">nsx-alb
        </a><a href='https://blog.andreasm.io/tags/avi/' title="avi" class="post_tag button button_translucent">avi
        </a><a href='https://blog.andreasm.io/tags/loadbalancing/' title="loadbalancing" class="post_tag button button_translucent">loadbalancing
        </a><a href='https://blog.andreasm.io/tags/networking/' title="networking" class="post_tag button button_translucent">networking
        </a><a href='https://blog.andreasm.io/tags/antrea/' title="antrea" class="post_tag button button_translucent">antrea
        </a><a href='https://blog.andreasm.io/tags/nsx/' title="nsx" class="post_tag button button_translucent">nsx
        </a><a href='https://blog.andreasm.io/tags/tkgi/' title="tkgi" class="post_tag button button_translucent">tkgi
        </a><a href='https://blog.andreasm.io/tags/tanzu/' title="tanzu" class="post_tag button button_translucent">tanzu
        </a>
    </span>
  </div>

      <div class="post_toc">
        <h2>Overview</h2>
        <nav id="TableOfContents">
  <ul>
    <li><a href="#installing-tkgi">Installing TKGi</a>
      <ul>
        <li><a href="#preparations-before-deploying-tkgi">Preparations before deploying TKGi</a></li>
        <li><a href="#nsx-configurations">NSX configurations</a></li>
        <li><a href="#nsx-alb-configurations">NSX-ALB configurations</a></li>
        <li><a href="#deploy-the-tkgi-management-console-formerly-the-epmc-for-enterprise-pks-management-console">Deploy the TKGi Management Console (Formerly the EPMC for Enterprise PKS Management Console)</a></li>
      </ul>
    </li>
    <li><a href="#installing-tkgi-using-the-management-console">Installing TKGi using the Management Console</a>
      <ul>
        <li><a href="#nsx-t-bring-your-own-topology">NSX-T Bring Your Own Topology</a></li>
        <li><a href="#antrea-topology">Antrea Topology</a></li>
        <li><a href="#common-settings-independent-of-topology-choice">Common settings independent of topology choice</a></li>
      </ul>
    </li>
    <li><a href="#deploy-workload-clusters-using-nsx-t-byot-manager-api">Deploy workload clusters using NSX-T BYOT (Manager API)</a>
      <ul>
        <li><a href="#create-network-profile-from-tkgi-mc">Create Network Profile from TKGi MC</a></li>
        <li><a href="#deploy-workload-clusterkubernetes-cluster">Deploy workload cluster/Kubernetes cluster</a></li>
        <li><a href="#nsx-objects-created-by-the-manager-api">NSX objects created by the manager API</a></li>
        <li><a href="#configure-nsx-advanced-loadbalancer-as-layer-4-and-layer-7-provider-inside-workload-clusters">Configure NSX Advanced Loadbalancer as Layer 4 and Layer 7 provider inside workload clusters.</a></li>
      </ul>
    </li>
    <li><a href="#deploy-workload-clusters-using-antrea">Deploy workload clusters using Antrea</a>
      <ul>
        <li><a href="#configure-nsx-advanced-loadbalancer-as-kuberntes-api-endpoint-provider">Configure NSX Advanced Loadbalancer as Kuberntes API endpoint provider</a></li>
        <li><a href="#configure-nsx-advanced-loadbalancer-as-layer-4-and-layer-7-provider-inside-kubernetes-cluster">Configure NSX Advanced Loadbalancer as Layer 4 and Layer 7 provider inside Kubernetes cluster</a></li>
      </ul>
    </li>
    <li><a href="#a-note-on-the-vip">A note on the VIP</a></li>
  </ul>
</nav>
      </div>
    
    <div class="post_body"><h1 id="tkgi">TKGi</h1>
<p>I realized I have not covered any posts around TKGi, so it is about high time to cover TKGi also. TKGi for me has a special place in my IT heart. Back in the days when it was called PKS I was all over the place doing a lot of PoCs and some production installations on TKGi. It was, and is, a very good Kubernetes platform very integrated with NSX. Back then NSX Advanced Loadbalancer, or Avi Networks, were not part of VMware. TKGi relied 100% on NSX-T providing both L4 and L7 loadbalancer services and it had a very tight integration with NCP (NSX Container Plugin) as the CNI for the Kubernetes clusters. Now we can also use Antrea as the CNI and we can also use NSX Advanced LoadBalancer for both Layer 4 and Layer 7 services in combination with NSX (different ways how NSX is being used, more on that later) as the underlaying network platform. So this will be an exiting post for me to go through. TKGi is very much alive and keeps going forward.</p>
<h2 id="installing-tkgi">Installing TKGi</h2>
<p>TKGi involves several components like vSphere, vCenter, NSX, and now also NSX Advanced LoadBalancer and the actual TKGi components themselves. The actual installing of TKGi can be done a couple of ways. One way (the method I prefer) is to use the TKGi Management Console. The MC is a rather large OVA image that contains all the binaries needed to install TKGi, and provides a nice UI. More on that later. The other approach is to build TKGi by downloading all the binaries from the Ops Manager, Bosh Stemcells, TGKi, etc. But before we can deploy TKGi there is some preparations that needs to be done. A note on how NSX can be prepared for use in TKGi. NSX can be the underlaying network provider for TKGi in three ways. We can use NSX as a regular underlay, no integration with TKGi, we will create the NSX networks as for regular VM workload with segments, gateway IPs and select them to be used respectively in TKGi. The other option is to use fully automated way where TKGi creates and configures all the needed NSX network components on demand and the third option is to <em>Bring Your Own Topology</em> meaning we have created some components like Tier-0 ourselves, and TKGi will use these objects and attach its own created Tier1s and segments according to the config. I will go through  both of these two options to to show the differencem where the Antrea approach just leverage NSX as the underlaying network stack with no TKGi integration and the &quot;BYOT&quot; will automate many of the networking tasks. I will not show how the &quot;fully&quot; automated NSX network integrations works, this also configures the Tier-0 which I already have in place in my infra.</p>
<p>I will be basing this post on TKGi version 1.18.0. This version supports the NSX Policy API, but is not so relevant when selecting the Antrea approach. I was not able to deploy TKGi using NSX Policy API in my lab so it to use Manager API. But the biggest difference is just how to NSX objects are being created in NSX, and for the sake of it probably some support statements that may differ.</p>
<p>So this post will cover to two ways of deplying TKGI where the first is using the EPMC, BYOT with NSX-T using NSX manager API, then the Antrea approach (still using TKGiMC) with NSX-T as just a network fabric managed completely outside of TKGi. Both approaches will incorporate the use of NSX Advanced Loadbalancer for both L4 services and L7 services inside my Kubernetes clusters. In the Antrea approach I will also configure Virtual Services in NSX Advanced Loadbalancer to provide the Kubernetes APi endpoint.</p>
<h3 id="preparations-before-deploying-tkgi">Preparations before deploying TKGi</h3>
<ul>
<li>A fully functioning vSphere cluster with vCenter</li>
<li>NSX installed and configured with required network topology(see drawing below)</li>
<li>NSX-ALB controller deployed, configured and NSX-T cloud configured.</li>
<li>Downloaded the TKGi Management Console from my.vmware.com (13GB)</li>
</ul>
<p>Network topology

  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="topology"
      
        class="image_figure image_internal image_processed"
        width="1421"
        height="641"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231201080952619.png"
      
      
    />

    </picture>
</figure>
</p>
<h3 id="nsx-configurations">NSX configurations</h3>
<p>Within NSX I have configured my Tier-0, then a Tier-1 for a couple of segments like a &quot;management segment&quot; and &quot;avi-se-generic-data&quot; for SE &quot;generic&quot; datanic, then a second Tier for my Avi DNS service where the DNS SE data nic will be placed. If BYOT then the T1s and segments for TKGi will be created by TKGi, for the Antrea approach, you need to manually or create the segments/Tier1s in NSX yourselves, these segments is at a minumun the management network for TKGi management components (OpsMan, Bosh) and a service network for the Kubernetes nodes. By using network profiles you can add more service networks to accommodate different networks for different Kubernetes clusters.</p>
<p>Tier-0</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="tier0"
      
        class="image_figure image_internal image_processed"
        width="2448"
        height="438"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231123090716840.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Tier-1s</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="tier-1s"
      
        class="image_figure image_internal image_processed"
        width="2534"
        height="528"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231123090803035.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Segments</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="segments"
      
        class="image_figure image_internal image_processed"
        width="3018"
        height="1446"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231123125646911.png"
      
      
    />

    </picture>
</figure>
</p>
<p>IP Pools/Blocks</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="floatingIP"
      
        class="image_figure image_internal image_processed"
        width="3036"
        height="598"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231123200339443.png"
      
      
    />

    </picture>
</figure>
</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="ipblocks"
      
        class="image_figure image_internal image_processed"
        width="3018"
        height="596"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231123200357339.png"
      
      
    />

    </picture>
</figure>
</p>
<h3 id="nsx-alb-configurations">NSX-ALB configurations</h3>
<p>In my NSX-ALB controller I have done the following configurations</p>
<p>Clouds:</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="nsx-t cloud"
      
        class="image_figure image_internal image_processed"
        width="3184"
        height="620"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231123093716220.png"
      
      
    />

    </picture>
</figure>
</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="edit-nsx-t-cloud"
      
        class="image_figure image_internal image_processed"
        width="2092"
        height="1666"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231123093744560.png"
      
      
    />

    </picture>
</figure>
</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="edit-nsx-cloud-2"
      
        class="image_figure image_internal image_processed"
        width="2088"
        height="1402"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231123093815822.png"
      
      
    />

    </picture>
</figure>
</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="edit-nsx-t-cloud"
      
        class="image_figure image_internal image_processed"
        width="2090"
        height="1482"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231123093852061.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Service Engine Group</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="se-group"
      
        class="image_figure image_internal image_processed"
        width="2764"
        height="830"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231123095342628.png"
      
      
    />

    </picture>
</figure>
</p>
<p>I have created two SE groups, one for all &quot;usecases&quot; (se-group-generic) and one for the Avi DNS service (se-dns-group).</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="edit-se-group-1"
      
        class="image_figure image_internal image_processed"
        width="2026"
        height="1712"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231123095505328.png"
      
      
    />

    </picture>
</figure>
</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="se-group-edit-2"
      
        class="image_figure image_internal image_processed"
        width="2036"
        height="1496"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231123095544187.png"
      
      
    />

    </picture>
</figure>
</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="se-group-edit-3"
      
        class="image_figure image_internal image_processed"
        width="2044"
        height="1494"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231123095625074.png"
      
      
    />

    </picture>
</figure>
</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="se-group-edit-5"
      
        class="image_figure image_internal image_processed"
        width="2046"
        height="1494"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231123095711410.png"
      
      
    />

    </picture>
</figure>
</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="scope-placement"
      
        class="image_figure image_internal image_processed"
        width="2034"
        height="1454"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231123095746822.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Networks</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="networks"
      
        class="image_figure image_internal image_processed"
        width="2998"
        height="1812"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231123100549642.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Here I have defined networks for the SE data and different VIP networks. All these have been added to the IPAM template used by my NSX cloud.
The SE data networks are only defining SE vNICS, the VIP networks are defined as only VIP networks.</p>
<p>VRF Contexts</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="vrf-context"
      
        class="image_figure image_internal image_processed"
        width="2402"
        height="826"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231123100627062.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Here I have configured a static route under the global VRF for my mgmt subnet using the gateway for the the SE mgmt network as nextop. The other two VRFs has been configured with a default route using the gateway in their respective datanetworks gateway.</p>
<p>IPAM/DNS profiles</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="ipam-dns-profiles"
      
        class="image_figure image_internal image_processed"
        width="3074"
        height="800"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231123100932299.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Then my DNS service</p>
<img src=images/image-20231123111613972.png style="width:500px" />
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="dns-service-1"
      
        class="image_figure image_internal image_processed"
        width="3036"
        height="372"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231123111725647.png"
      
      
    />

    </picture>
</figure>
</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="settings-dns-service"
      
        class="image_figure image_internal image_processed"
        width="3042"
        height="1812"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231123111653045.png"
      
      
    />

    </picture>
</figure>
</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="system-settings"
      
        class="image_figure image_internal image_processed"
        width="1456"
        height="1246"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231128072035431.png"
      
      
    />

    </picture>
</figure>
</p>
<p>In system settings DNS service is configured to use my deployed DNS VS.</p>
<p>I have configured my backend DNS server to forward requests to this service (10.146.100.53) for my dns sones configured in my NSX ALB DNS service.</p>
<h3 id="deploy-the-tkgi-management-console-formerly-the-epmc-for-enterprise-pks-management-console">Deploy the TKGi Management Console (Formerly the EPMC for Enterprise PKS Management Console)</h3>
<p>After downloading the ova, I will deploy it in my vCenter server as all other OVA deployments. I just want to point out a setting that one should be aware of and that is the docker-network. In the initial days of this EPMC installer it just took for granted that we could use the default docker network inside the EPMC appliance. But not every customer are using 192.168.0.0/16 or 10.0.0.0/16 they may use 172.16.0.0/12.. And the Docker default network is using 172.16.0.0/17. If your client network that interacts with the deployed MC appliance happens to be on this subnet also, you are unable to reach the installer as the container network will not try to route outside.
I made the EPMC developers aware of this back then, created a guide how to override it manually by adjusting the docker network inside the appliance itself, and shortly after they added the field in the OVA for you to select your own Docker network during provisioning.
Below is the deployment of the EPMC OVA.</p>
<img src=images/image-20231123113148152.png style="width:500px" />
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="step-1"
      
        class="image_figure image_internal image_processed"
        width="2290"
        height="1200"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231123113303213.png"
      
      
    />

    </picture>
</figure>
</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="step-2"
      
        class="image_figure image_internal image_processed"
        width="2278"
        height="1186"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231123113344951.png"
      
      
    />

    </picture>
</figure>
</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="step-3"
      
        class="image_figure image_internal image_processed"
        width="2286"
        height="1190"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231123113408554.png"
      
      
    />

    </picture>
</figure>
</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="step-4"
      
        class="image_figure image_internal image_processed"
        width="2268"
        height="1172"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231123112735402.png"
      
      
    />

    </picture>
</figure>
</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="step-5"
      
        class="image_figure image_internal image_processed"
        width="2272"
        height="1182"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231123112758727.png"
      
      
    />

    </picture>
</figure>
</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="step-5"
      
        class="image_figure image_internal image_processed"
        width="2280"
        height="1182"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231123113457188.png"
      
      
    />

    </picture>
</figure>
</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="step-7"
      
        class="image_figure image_internal image_processed"
        width="2270"
        height="1180"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231123113524047.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Selecting my mgmt network created in NSX.</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="step-8-1"
      
        class="image_figure image_internal image_processed"
        width="2278"
        height="1174"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231123113603973.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Enter password for the root user of the epmc appliance, then leave SSH selected for troubleshooting scenarios.</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="step-8-2"
      
        class="image_figure image_internal image_processed"
        width="2272"
        height="1186"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231123113730128.png"
      
      
    />

    </picture>
</figure>
</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="step-8-3"
      
        class="image_figure image_internal image_processed"
        width="2284"
        height="1186"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231123114248266.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Here it is important to change the docker network to something that does not conflict with subnet your are coming from when interacting with the EPMC appliance.</p>
<p>Then Next and FINISH</p>
<p>Sit back and wait, as soon as it is deployed power on and wat a couple more minutes. Then it is time to enter the IP address in our browser to start the TKGi installation...</p>
<h2 id="installing-tkgi-using-the-management-console">Installing TKGi using the Management Console</h2>
<p>Open your preferred browser and enter the given IP address.</p>
<img src=images/image-20231123114643708.png style="width:500px" />
<p>Login with username root and the password provided in the OVA deployment process.</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="welcome-page"
      
        class="image_figure image_internal image_processed"
        width="3582"
        height="1642"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231123114806911.png"
      
      
    />

    </picture>
</figure>
</p>
<p>I want to do a new install, so I will select INSTALL, but first I will change the theme to dark. Much nicer on my eyes.</p>
<img src=images/image-20231123114908180.png style="width:500px" />
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="next-1"
      
        class="image_figure image_internal image_processed"
        width="3574"
        height="1530"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231123114951396.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Here I can import an already existing config, or start creating a new one. I dont have an existing so I will do a new one selection Start Configuration</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="vcenter-info"
      
        class="image_figure image_internal image_processed"
        width="3574"
        height="1876"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231123115125620.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Enter my relevant vCenter info, click connect.</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="vcenter-connected"
      
        class="image_figure image_internal image_processed"
        width="3574"
        height="1844"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231123115224089.png"
      
      
    />

    </picture>
</figure>
</p>
<p>vCenter connected, selecting my Datacenter, then Next.</p>
<p>And its here we can do our topology choices. I will start with the BYOT approach, NSX-T Bring Your Own Topology.</p>
<h3 id="nsx-t-bring-your-own-topology">NSX-T Bring Your Own Topology</h3>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="nsx-t-byot"
      
        class="image_figure image_internal image_processed"
        width="3548"
        height="1900"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231123200601136.png"
      
      
    />

    </picture>
</figure>
</p>
<p>In this topology I will point to my existing Tier0, then my already created segment ls-tkgi-mgmt, the floating IP pool (api endpoints), ip blocks for node and pod. I deselect NAT as I want to keep the Kubernetes nodes routable. This also mean the POD network is not NAT'ed, be aware of this otherwise you may end up advertising a bunch of subnets you may not want to re-distribute.</p>

<div class="notices warning">
    <div class="label">Info</div>
    <p>According to the official documentation <a href="https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid-Integrated-Edition/1.18/tkgi/GUID-nsxt-topologies.html">here</a> NO NAT should give me routable management VMs (Bosh, OpsMan etc) and routable Kubernetes Nodes, but I discovered it also gave me routable pods, so my pod cidr was exposed in my network via BGP.
To keep this network inside NSX I had to add a route-map on my Tier-0 blocking this cidr. This only stop my POD cidr from being advertised outside NSX (Tier0) but not inside NSX. I would like to have the option to at least place the nat rules on the Tier1 for only the pod CIDR.</p>
<p><a href="https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid-Integrated-Edition/1.18/tkgi/GUID-nsxt-topologies.html">Here</a> is the topology diagrams, the Cluster Network (I assume is the pod-cidr) is following the kubernetes nodes topology.</p>
<p>More on that later.</p>

  </div>

<p>Also I was not able to enable the NSX-T Policy API using the TKGI MC, it could not find any of my NSX objects created using Policy API, so I decided to continue using manager api. Maybe using Ops Man, the manual approach, will make this easier. But again, this is my lab and there may be some small config it does not like there. In other real world environments it may behave different.</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="validation_error"
      
        class="image_figure image_internal image_processed"
        width="3546"
        height="348"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231123202050937.png"
      
      
    />

    </picture>
</figure>
</p>
<p>This is because it requires the T1 where I connect my tkgi-mgmt segment to be centralised, and placed on an edge cluster. That is most likely because it needs the option to create stateful objects like NAT rules..</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="tier-dedicated"
      
        class="image_figure image_internal image_processed"
        width="3020"
        height="772"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231123202350989.png"
      
      
    />

    </picture>
</figure>
</p>
<p>After creating my new Tier1 router as active standby, selecting my edge cluster repoint my tkgi mgmt segment to the new Tier1 router it validates fine.</p>
<h3 id="antrea-topology">Antrea Topology</h3>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="networking"
      
        class="image_figure image_internal image_processed"
        width="3578"
        height="620"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231123120614535.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Here I will select Antrea. I will do that because I want to use NSX ALB as the loadbalancer provider and Antrea as the CNI. I know I will not get the benefit from NCP automatically creating the networks for me in NSX and some other NCP features as bridging, easy choice whether I want to NAT or no NAT etc. But this blog post is about running TKGi together with NSX, NSX ALB and Antrea. NSX will still be my main network provider in this setup as networks are easily created in NSX and I have the benefit of using the DFW for my worker nodes and the Antrea NSX Integration I have written about <a href="https://blog.andreasm.io/2023/06/01/managing-antrea-in-vsphere-with-tanzu/#integrating-antrea-with-nsx-t">here</a>.</p>
<p>For more information on the differnet network topologies have a look <a href="https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid-Integrated-Edition/1.18/tkgi/GUID-console-deploy-wizard.html#networking">here</a></p>
<p>This first installation of TKGi can be called a foundation, that means we can have several TKGi installations with their own Ops Managers, Bosh instances etc, sharing some common components as NSX (not using same Tier0 but dedicated Tier0s pr foundation). The benefits of running multiple TKGi foundations is that we can have unique configurations done pr foundation. See more <a href="https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid-Integrated-Edition/1.18/tkgi/GUID-nsxt-multi.html?hWord=N4IghgNiBcIGYHsCuA7AJmALgSwSkAvkA">here</a></p>
<p>Now that I have selected the Topology Antrea, I will fill out the necessary network information accordingly. The Deployment Network Resource is for the TKGi management components and the Service Network Resource is for the Kubernetes Cluster nodes.</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="network-info"
      
        class="image_figure image_internal image_processed"
        width="3562"
        height="2008"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231123125848062.png"
      
      
    />

    </picture>
</figure>
</p>
<h3 id="common-settings-independent-of-topology-choice">Common settings independent of topology choice</h3>
<p>Click next</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="step-3"
      
        class="image_figure image_internal image_processed"
        width="3568"
        height="826"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231123130313415.png"
      
      
    />

    </picture>
</figure>
</p>
<p>add a name to the TKGi API endpoint.</p>
<p>Before I populate the next section, I have already created four resource pools in my vCenter to &quot;simulate&quot; 3 availability zones and one for management.</p>
<img src=images/image-20231123130622669.png style="width:500px" />
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="azs-1"
      
        class="image_figure image_internal image_processed"
        width="3564"
        height="1170"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231123130847078.png"
      
      
    />

    </picture>
</figure>
</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="az-defined"
      
        class="image_figure image_internal image_processed"
        width="3550"
        height="1896"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231123131359165.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Next</p>
<p>Under Resources and Storage I have enabled vSphere CSI Driver Integration. Selected my vSAN Storage for Ephemeral and permanent as it will default used if not specifying otherwise.</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="storage"
      
        class="image_figure image_internal image_processed"
        width="3538"
        height="1728"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231123131559672.png"
      
      
    />

    </picture>
</figure>
</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="persistent"
      
        class="image_figure image_internal image_processed"
        width="3536"
        height="828"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231123131627285.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Plans</p>
<p>Here I have only adjusted the worker nodes in the medium and large plans to have 2 cpu 8gb ram and 4 cpus and 16gb ram respectively.</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="plans"
      
        class="image_figure image_internal image_processed"
        width="3494"
        height="640"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231123132002743.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Next</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="integrations"
      
        class="image_figure image_internal image_processed"
        width="3548"
        height="746"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231123132024467.png"
      
      
    />

    </picture>
</figure>
</p>
<p>I dont have any integrations</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="harbor"
      
        class="image_figure image_internal image_processed"
        width="3522"
        height="1492"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231123132113714.png"
      
      
    />

    </picture>
</figure>
</p>
<p>I already have a Harbor instance running.. So I disable it here.</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="end"
      
        class="image_figure image_internal image_processed"
        width="3544"
        height="1364"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231123132149676.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Generate Configuration</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="apply-export"
      
        class="image_figure image_internal image_processed"
        width="3556"
        height="1934"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231123132218287.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Now I can Apply the config, but before that I will export the config.</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="applying"
      
        class="image_figure image_internal image_processed"
        width="2938"
        height="1400"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231123132316502.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Continue... Sit back and well... It will take some time.</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="installation"
      
        class="image_figure image_internal image_processed"
        width="3568"
        height="1332"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231123133312535.png"
      
      
    />

    </picture>
</figure>
</p>
<p>As soon as the OpsMgr has been deployed it is possible to monitor the deployment process further. Like when it gets to this step below, and begin to wonder if it has stopped completely.</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="progress-halted?"
      
        class="image_figure image_internal image_processed"
        width="3562"
        height="1332"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231124080709701.png"
      
      
    />

    </picture>
</figure>
</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="ops-manager"
      
        class="image_figure image_internal image_processed"
        width="3542"
        height="1602"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231124080648496.png"
      
      
    />

    </picture>
</figure>
</p>
<p>As soon as I logged into OpsManager I could see it was still doing a lot of things.</p>
<p>Grab the password from here:</p>
<img src=images/image-20231123143411489.png style="width:600px" />
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="ops-man"
      
        class="image_figure image_internal image_processed"
        width="2128"
        height="932"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231123143345209.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Now after some waiting the TKGi Management Console reports a successful deployment</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="done"
      
        class="image_figure image_internal image_processed"
        width="3564"
        height="1300"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231127083436971.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Now the fun starts.</p>
<h2 id="deploy-workload-clusters-using-nsx-t-byot-manager-api">Deploy workload clusters using NSX-T BYOT (Manager API)</h2>
<p>From the TKGI Management Console click continue and you should get to the &quot;welcome page&quot; for your TKGi foundation with all the details of the components installed.

  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="tkgi-mgmt-console-welcome"
      
        class="image_figure image_internal image_processed"
        width="3562"
        height="1828"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231127084357673.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Notice that the NSX Policy API is <em>disabled</em>. I could not get the TKGi MC to use Policy API during deployment in my lab. So I decided to leave that unchecked. The biggest impact of this is that certain objects created in NSX by TKGi (NCP) will be created using Manager API.</p>
<p>The plan now is to to deploy a workload cluster using the plan <em>Small</em>. but before I do that I will create a Network Profile from the TKGi MC that disables the NSX-T loadbalancer for both L4 and L7 for the Kubernetes cluster. What this means is that NSX-T loadbalancer will be used only to provide a loadbalanced API endpoint for my workload cluster control planes. But from within the workload clusters themselves (Kubernetes clusters) I will need to provide my own layer4 and layer7 provider. And guess what that will be.. Yes, the NSX Advanced LoadBalancer.</p>
<h3 id="create-network-profile-from-tkgi-mc">Create Network Profile from TKGi MC</h3>
<p>I will go to Profiles in the TKGi MC left menu and create a new Network Profile like this:</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="create-profile"
      
        class="image_figure image_internal image_processed"
        width="1606"
        height="1016"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231127090501319.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Click <em>create profile</em></p>
<p>Then I will give the profile the name <em>ako-provider</em></p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="profile-name"
      
        class="image_figure image_internal image_processed"
        width="1534"
        height="1146"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231127090732948.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Then I will expand the Container Network section, and set <em>Use NSX-T L4 Virtual Server For K8s LoadBalancer</em> to <em>No</em> and <em>Use NSX-T L7 Virtual Server As The Ingress Controller For K8s Cluster</em> to <em>No</em></p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="disable_NSX-T-LB_inside-k8s"
      
        class="image_figure image_internal image_processed"
        width="1900"
        height="1448"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231127091040027.png"
      
      
    />

    </picture>
</figure>
</p>
<p>This is done as I only want NSX ALB AKO to provide L4 and L7 services from my Kubernetes Clusters.</p>
<p>Scroll all the way down and click save as there are no more settings I want to adjust now.</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="profile-created"
      
        class="image_figure image_internal image_processed"
        width="2890"
        height="1068"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231127091245781.png"
      
      
    />

    </picture>
</figure>
</p>
<h3 id="deploy-workload-clusterkubernetes-cluster">Deploy workload cluster/Kubernetes cluster</h3>
<p>I prefer the easy way to deploy the clusters, so from the TKGi MC I will head here and create a cluster:</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="create-cluster"
      
        class="image_figure image_internal image_processed"
        width="2586"
        height="1080"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231127091727215.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Click create cluster:</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="cluster-1"
      
        class="image_figure image_internal image_processed"
        width="3500"
        height="1900"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231127093418978.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Here I will give the cluster a name, then I will use the same cluster name also in my fqdn name. I will go with 3 Worker Nodes. Then the important step is to select my newly created ako-provider Network Profile.
If one want to see what its in the network profile click on show more on the right side under <em>Network Profile Parameters</em></p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="network-profile-ako-provider"
      
        class="image_figure image_internal image_processed"
        width="3414"
        height="1918"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231127093858248.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Then click Create and another session of waiting.</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="cluster-created"
      
        class="image_figure image_internal image_processed"
        width="3348"
        height="1882"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231127093959142.png"
      
      
    />

    </picture>
</figure>
</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="creating"
      
        class="image_figure image_internal image_processed"
        width="3562"
        height="1038"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231127094204908.png"
      
      
    />

    </picture>
</figure>
</p>
<p>It will now start to deploy the vms in my vCenter. Then moving them to the correct Resource Groups and network (Using the Node pool I created earlier)</p>
<img src=images/image-20231127100256978.png style="width:400px" />
<p>After a little while (depending on fast the underlaying hardware is) it should be ready:</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="cluste-1-ready"
      
        class="image_figure image_internal image_processed"
        width="3572"
        height="1034"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231127104942988.png"
      
      
    />

    </picture>
</figure>
</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="cluster-1-info"
      
        class="image_figure image_internal image_processed"
        width="3566"
        height="1654"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231127105014266.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Now next step is to log into the newly created cluster and deploy AKO for the L4 and L7 parts inside that cluster</p>

<div class="notices warning">
    <div class="label">Info</div>
    <p>As I did deploy this cluster using NSX Manager API, the only way of configuring the Cloud in the NSX Advanced Loadbalancer is vCenter Cloud. According to the offical documentation found <a href="https://docs.vmware.com/en/VMware-NSX-Advanced-Load-Balancer/1.11/Avi-Kubernetes-Operator-Guide/GUID-2778C485-E48F-4C5E-8EC7-CB96F6CA5CBB.html#cloud-configuration-5">here</a>. I will use a NSX Cloud anyway, so consider this a non-supported approach. I will not use the NCP/TKGi created Segments using Manager API for any of the Avi components, I have created my own T1 and segments for my Avi cloud using Policy API. So this would be interesting to explorer further. But with TKGi in Policy mode it is supported.
In the link above one of the concerns is that SEs needs to traverse the Tier-0 to reach the backends. But this will be the case even if using policy api as the T1s created by TKGi/NCP will be created as centralized tier1s and will be handled by the NSX Edges, so I am not so sure how this can be done differently.</p>

  </div>

<h3 id="nsx-objects-created-by-the-manager-api">NSX objects created by the manager API</h3>
<p>Now that my first Kubernetes cluster is up and running, lets have a look inside NSX and see what is has created. For that I need to switch my NSX UI into Manager</p>
<img src=images/image-20231127121911099.png style="width:400px" />
<p>Then I will first have a look at the Tier 1</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="tier-1"
      
        class="image_figure image_internal image_processed"
        width="3580"
        height="820"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231127122100484.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Then the segments:</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="pks-segments"
      
        class="image_figure image_internal image_processed"
        width="3576"
        height="1908"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231127130118079.png"
      
      
    />

    </picture>
</figure>
</p>
<p>This one is interesting. If you are used to any other CNIs than NCP you will notice here that all the Kubernetes Namespaces created in your Kubernetes clusters reflects a NSX segment. Example the segment <em>pks-0b7d0725-c67b-4e14-b6d0-52f799cb3556-kube-system</em>, contains all the pods as logical ports in that namespace. A nice feature of NCP. This is really useful in strict IPAM cases, isolation and maintaning control of any pod in the Kubernetes clusters. All Logical ports are enforced by the NSX Distributed Firewall also.</p>
<p>NAT rules:

  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="nat"
      
        class="image_figure image_internal image_processed"
        width="3572"
        height="1378"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231127133759706.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Here is a bunch of SNAT rules translating all the pod cidrs in use to ip addresses from the Floating IP pool.</p>
<p>Distributed Firewall rules</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="dfw"
      
        class="image_figure image_internal image_processed"
        width="3570"
        height="1914"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231127134007992.png"
      
      
    />

    </picture>
</figure>
</p>
<p>These are the major objects being created in manager mode in NSX by NCP.</p>
<p>Speaking of loadbalancing, lets get some loadbalancing done from the Kubernetes cluster I just created. Isnt this post about TKGi and NSX Advanced Loadbalancer? ... 😄</p>
<h3 id="configure-nsx-advanced-loadbalancer-as-layer-4-and-layer-7-provider-inside-workload-clusters">Configure NSX Advanced Loadbalancer as Layer 4 and Layer 7 provider inside workload clusters.</h3>
<p>I have already configured my NSX Advanced Loadbalancer using a NSX cloud, configured a Tier1 for both generic SE data and my DNS SEs using the policy API. But again according to the official documentation <a href="https://docs.vmware.com/en/VMware-NSX-Advanced-Load-Balancer/1.11/Avi-Kubernetes-Operator-Guide/GUID-2778C485-E48F-4C5E-8EC7-CB96F6CA5CBB.html#cloud-configuration-5">here</a> this is not supported. But as I will not be putting any of my SEs on the segments created by TKGi, and I am doing a BYOT installation where I have created some NSX objects myself) I dont feel this should be an issue. What this approach will do though is forcing SE traffic to reach the backend (Kubernetes nodes on the NCP created segments using manager API) via the T0. This could potentially reduce performance, as the T1s may be centralized. If the T1 for the SEs are distributed they will just use the DR T0, not via the Edges. Another statement from the official documentation around this scenario where the SE datanics needs to traverse the T0 to reach the backends <a href="https://avinetworks.com/docs/22.1/nsx-t-design-guide/#pool-configuration">here</a>:</p>
<blockquote>
<p>For a given virtual service, the logical segment of the pool servers and the logical segment of the VIP must belong to the same tier-1 router. If the VIP and the pool are connected to different tier-1, the traffic may pass through the tier-0 and hence through the NSX-T edge (depending on the NSX-T services configured by admin). This reduces the data path performance and hence must be avoided.</p>
</blockquote>
<p>So, lets see how the traffic goes when all this is up and running.</p>
<p>First I need to grab the config for my Kubernetes cluster so I can interact with it. I will just grab the config from the TKGI MC here:</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="access_cluster"
      
        class="image_figure image_internal image_processed"
        width="3564"
        height="1712"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231127134400247.png"
      
      
    />

    </picture>
</figure>
</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="cluster-config"
      
        class="image_figure image_internal image_processed"
        width="2694"
        height="1500"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231127134444042.png"
      
      
    />

    </picture>
</figure>
</p>
<p>This assumes we have configured a DNS record for the FQDN I entered when I created the cluster. Have I done that, yes of course.</p>
<p>Now I will just paste this in my linux machine where I have kubectl installed.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">andreasm@ubuntu02:~/tkgi/cluster-1$ kubectl config set-cluster tkgi-cluster-1 --server<span class="o">=</span>https://tkgi-cluster-1.this-is-a.domain.net:8443 <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="se"></span>kubectl config <span class="nb">set</span> clusters.tkgi-cluster-1.certificate-authority-data <span class="nv">Ci0tLS0tQkVHSU4gQ0VSVElGSUNBVEUtLS0tLQpNSUlET3pDQ0FpT2dBd0lCQWdJVU9EQXNVemVuRk1JYVBhajhoZWpOZ21FL2JXOHdEUVlKS29aSWh2Y05BUUVMCkJRQXdMVEVMTUFrR0ExVUVBeE1DUTBFeERUQUxCZ05WQkFzVEJGUkxSMGt4RHpBTkJnTlZCQW9UQmxaTmQyRnkKWlRBZUZ3MHlNekV4TWpjd09ETTVORFJhRncweU56RXhNamN3T0RNNU5EUmFNQzB4Q3pBSkJnTlZCQU1UQWtOQgpNUTB3Q3dZRFZRUUxFd1JVUzBkSk1ROHdEUVlEVlFRS0V3WldUWGRoY21Vd2dnRWlNQTBHQ1NxR1NJYjNEUUVCCkFRVUFBNElCRHdBd2dnRUtBb0lCQVFEaURlVTBaOXF3MVFDblltNDRUNnFmOWJDeVA5YXJPd2ltZjFaL09paVoKRFhDYzhMT214YTRWbHh1NXB0OGVzMEt5QmdLd1hjMEVnVDl2NmluV083RWpsZmNHYy9ySThPdjFkOEFuT0tzWQpiRXUzQlo5VS9KOGZNNnpGV3M5bGdzZVBsOURldEFLWXZpcFgzV28yVHpkbjhOVnU5NlJKTmNNdTlNVGNZU05DCjNUbUpVMWdFOVRVak45TXpyRWpsNVo3RkFaMVZnMXl3ZmpCU3h4WlpJcUN6UDFhaWw3OFZBR2VHLzhoN3VXUVIKd0oyTFM5Vm90bTlGQ0FFMlN1ZzUzQVEyUzNPalNBMExNWVI2d0dBeGk0a0xhcld3TjU1d2owcm9zWnBKREJzcQo4OURHYkI5YjdNaHZYcWhMQ3dOT2NiUFppVFFCUkJUZnVOZTRFQjhvTFZxcEFnTUJBQUdqVXpCUk1CMEdBMVVkCkRnUVdCQlFLVEV0d3ZVZEdRMVAzU01aNWtCV0xOcTJWOWpBZkJnTlZIU01FR0RBV2dCUUtURXR3dlVkR1ExUDMKU01aNWtCV0xOcTJWOWpBUEJnTlZIUk1CQWY4RUJUQURBUUgvTUEwR0NTcUdTSWIzRFFFQkN3VUFBNElCQVFCNQpoT3Q3aW5GZy94Vkg5d0prY3M0QVlNQnJpT2tabkl5RHBzQWl0MmJqMkNlUzdEMHdlNE5saWUrNmxzdFhHQ1B4ClU5YmFRTld0a3EwWERxNEhKT0hJd0lXUTE1V2N0ZFZmYks4SFo2QWtZN2QvTWNaTEJUeEZPc2JtSVJnRTZMVW4Kc1BBMHcyRkloMWk5TFkrVE5lV2l2K1YrZi9kZmpVaWh4citzZFRkOHhUSmdxZldjSUl2TmVpcitNZmg2YW1IcgpUVDhDK1dRSm5xc29SMjBLdTU4VGNPbzFsQmYyUjNKZUNJeXIwZExpSnJZV2RZckxteHpORU4xRndjVU9MMHAyCnI4dXl5RkZqYWUyNXp0VFFIR09YU3lzV2xSSHJ2MmdqSW03MlFGZnVUdGhzOVpKRGtYSFhKdnBYcEdoelhqZVgKLzQwVnhzR3Qwd3dwa2c2b2dqUTkKLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo</span><span class="o">=</span> <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="se"></span>kubectl config set-credentials c3905e0f-b588-40d9-973f-fba55b6dd6a0 --token<span class="o">=</span>eyJhbGciOiJSUzI1NiIsImtpZCI6IlJNWU5pdFdwV3RZUDE2dk9RSHFkQ3p3VnFZV0ttTFJPYllMYmMyM1BkQzAifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJkZWZhdWx0Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZWNyZXQubmFtZSI6ImMzOTA1ZTBmLWI1ODgtNDBkOS05NzNmLWZiYTU1YjZkZDZhMCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50Lm5hbWUiOiJjMzkwNWUwZi1iNTg4LTQwZDktOTczZi1mYmE1NWI2ZGQ2YTAiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC51aWQiOiI2YzIxNDRmNi1iNTRjLTQ4NmItOTU3NS0yNDk4YTQ5YzZjZmIiLCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6ZGVmYXVsdDpjMzkwNWUwZi1iNTg4LTQwZDktOTczZi1mYmE1NWI2ZGQ2YTAifQ.K9qjIqBUMlwag_-XCK9kbiGjdXflKSRLmOol2AvWlu3HV5yEOAdh7B4-CrTDsk-RA1ajBqUerc8IngbyaWELN2APTKoe2gQoVqvszw4sBqL_VnmNGL9zBl1AyEB8EuUSY17W3XGTWjVRaDskqOkyB36vx3nksnM07du7tRa6evQlvAqPQFuWaX-d7yeTTRRurxzhycPL_AdKFry7V8XSFxvLFaAK93EvWsKQbknxmq7YT4HM7HbGnBzBceUz2ZCjQ_ilMpup-Rxvu1y7Fgf4-dx09PVQXT_SqSaqfSN2sxesNZOFESW-EFEgXytDO4VNQjKVgEv0SBHNwzhhAl8wNw <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="se"></span>kubectl config set-context tkgi-cluster-1 --cluster<span class="o">=</span>tkgi-cluster-1 --user<span class="o">=</span>c3905e0f-b588-40d9-973f-fba55b6dd6a0 <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="se"></span>kubectl config use-context tkgi-cluster-1
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">Cluster <span class="s2">&#34;tkgi-cluster-1&#34;</span> set.
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">Property <span class="s2">&#34;clusters.tkgi-cluster-1.certificate-authority-data&#34;</span> set.
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">User <span class="s2">&#34;c3905e0f-b588-40d9-973f-fba55b6dd6a0&#34;</span> set.
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">Context <span class="s2">&#34;tkgi-cluster-1&#34;</span> created.
</span></span><span class="line"><span class="ln">10</span><span class="cl">Switched to context <span class="s2">&#34;tkgi-cluster-1&#34;</span>.
</span></span></code></pre></div><p>Lets test connectivity</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@ubuntu02:~/tkgi/cluster-1-nsx-manager-api$ k get nodes
</span></span><span class="line"><span class="ln">2</span><span class="cl">NAME                                   STATUS   ROLES    AGE     VERSION
</span></span><span class="line"><span class="ln">3</span><span class="cl">a0e22550-80fe-40d8-9b0f-0dcb2d92c58a   Ready    &lt;none&gt;   4h16m   v1.27.5+vmware.1
</span></span><span class="line"><span class="ln">4</span><span class="cl">bc69d2aa-4ddc-41b8-8ede-b8a94929496b   Ready    &lt;none&gt;   4h12m   v1.27.5+vmware.1
</span></span><span class="line"><span class="ln">5</span><span class="cl">d90a5da4-343a-4040-bef3-1f2f148159e0   Ready    &lt;none&gt;   4h9m    v1.27.5+vmware.1
</span></span></code></pre></div><p>There are my worker nodes. You have to wonder where the control plane nodes is.. Well a quick question to my friend Robert Guske the simple explanation is that the kubelet is not running on the control plane nodes in TKGi. To view the control plane nodes we need to use bosh. See <a href="https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid-Integrated-Edition/1.18/tkgi/GUID-verify-health.html">here</a>.</p>
<p>Now I just need to deploy AKO and create some test applications. But before I do that I will need to check if there are any ingress or loadbalancer classes available in my cluster.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@ubuntu02:~/tkgi/cluster-1-nsx-manager-api$ k get ingressclasses.networking.k8s.io
</span></span><span class="line"><span class="ln">2</span><span class="cl">No resources found
</span></span><span class="line"><span class="ln">3</span><span class="cl">
</span></span><span class="line"><span class="ln">4</span><span class="cl">
</span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="c1">## There is no loadbalancerclass crd available...</span>
</span></span></code></pre></div><p>Now I will grab the values for AKO</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@ubuntu02:~/tkgi/cluster-1-nsx-manager-api$  helm show values oci://projects.registry.vmware.com/ako/helm-charts/ako --version 1.10.3 &gt; values.yaml
</span></span></code></pre></div><p>Then I will edit the values.yaml according to my environment:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln">  1</span><span class="cl"><span class="c"># Default values for ako.</span><span class="w">
</span></span></span><span class="line"><span class="ln">  2</span><span class="cl"><span class="w"></span><span class="c"># This is a YAML-formatted file.</span><span class="w">
</span></span></span><span class="line"><span class="ln">  3</span><span class="cl"><span class="w"></span><span class="c"># Declare variables to be passed into your templates.</span><span class="w">
</span></span></span><span class="line"><span class="ln">  4</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">  5</span><span class="cl"><span class="w"></span><span class="nt">replicaCount</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="ln">  6</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">  7</span><span class="cl"><span class="w"></span><span class="nt">image</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">  8</span><span class="cl"><span class="w">  </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l">projects.registry.vmware.com/ako/ako</span><span class="w">
</span></span></span><span class="line"><span class="ln">  9</span><span class="cl"><span class="w">  </span><span class="nt">pullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">IfNotPresent</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 10</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 11</span><span class="cl"><span class="w"></span><span class="c">### This section outlines the generic AKO settings</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 12</span><span class="cl"><span class="w"></span><span class="nt">AKOSettings</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 13</span><span class="cl"><span class="w">  </span><span class="nt">primaryInstance: true # Defines AKO instance is primary or not. Value `true` indicates that AKO instance is primary. In a multiple AKO deployment in a cluster, only one AKO instance should be primary. Default value</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="l">.</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 14</span><span class="cl"><span class="w">  </span><span class="nt">enableEvents</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;true&#39;</span><span class="w"> </span><span class="c"># Enables/disables Event broadcasting via AKO</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 15</span><span class="cl"><span class="w">  </span><span class="nt">logLevel: WARN   # enum</span><span class="p">:</span><span class="w"> </span><span class="l">INFO|DEBUG|WARN|ERROR</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 16</span><span class="cl"><span class="w">  </span><span class="nt">fullSyncFrequency</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;1800&#39;</span><span class="w"> </span><span class="c"># This frequency controls how often AKO polls the Avi controller to update itself with cloud configurations.</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 17</span><span class="cl"><span class="w">  </span><span class="nt">apiServerPort</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w"> </span><span class="c"># Internal port for AKO&#39;s API server for the liveness probe of the AKO pod default=8080</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 18</span><span class="cl"><span class="w">  </span><span class="nt">deleteConfig</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;false&#39;</span><span class="w"> </span><span class="c"># Has to be set to true in configmap if user wants to delete AKO created objects from AVI</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 19</span><span class="cl"><span class="w">  </span><span class="nt">disableStaticRouteSync</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;false&#39;</span><span class="w"> </span><span class="c"># If the POD networks are reachable from the Avi SE, set this knob to true.</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 20</span><span class="cl"><span class="w">  </span><span class="nt">clusterName</span><span class="p">:</span><span class="w"> </span><span class="l">tkgi-cluster-1  </span><span class="w"> </span><span class="c"># A unique identifier for the kubernetes cluster, that helps distinguish the objects for this cluster in the avi controller. // MUST-EDIT</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 21</span><span class="cl"><span class="w">  </span><span class="nt">cniPlugin: &#39;ncp&#39; # Set the string if your CNI is calico or openshift or ovn-kubernetes. For Cilium CNI, set the string as cilium only when using Cluster Scope mode for IPAM and leave it empty if using Kubernetes Host Scope mode for IPAM. enum</span><span class="p">:</span><span class="w"> </span><span class="l">calico|canal|flannel|openshift|antrea|ncp|ovn-kubernetes|cilium</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 22</span><span class="cl"><span class="w">  </span><span class="nt">enableEVH</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="c"># This enables the Enhanced Virtual Hosting Model in Avi Controller for the Virtual Services</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 23</span><span class="cl"><span class="w">  </span><span class="nt">layer7Only</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="c"># If this flag is switched on, then AKO will only do layer 7 loadbalancing.</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 24</span><span class="cl"><span class="w">  </span><span class="c"># NamespaceSelector contains label key and value used for namespacemigration</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 25</span><span class="cl"><span class="w">  </span><span class="c"># Same label has to be present on namespace/s which needs migration/sync to AKO</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 26</span><span class="cl"><span class="w">  </span><span class="nt">namespaceSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 27</span><span class="cl"><span class="w">    </span><span class="nt">labelKey</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 28</span><span class="cl"><span class="w">    </span><span class="nt">labelValue</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 29</span><span class="cl"><span class="w">  </span><span class="nt">servicesAPI: false # Flag that enables AKO in services API mode</span><span class="p">:</span><span class="w"> </span><span class="l">https://kubernetes-sigs.github.io/service-apis/. Currently implemented only for L4. This flag uses the upstream GA APIs which are not backward compatible</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 30</span><span class="cl"><span class="w">                     </span><span class="c"># with the advancedL4 APIs which uses a fork and a version of v1alpha1pre1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 31</span><span class="cl"><span class="w">  </span><span class="nt">vipPerNamespace</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;false&#39;</span><span class="w"> </span><span class="c"># Enabling this flag would tell AKO to create Parent VS per Namespace in EVH mode</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 32</span><span class="cl"><span class="w">  </span><span class="nt">istioEnabled</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="c"># This flag needs to be enabled when AKO is be to brought up in an Istio environment</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 33</span><span class="cl"><span class="w">  </span><span class="c"># This is the list of system namespaces from which AKO will not listen any Kubernetes or Openshift object event.</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 34</span><span class="cl"><span class="w">  </span><span class="nt">blockedNamespaceList</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 35</span><span class="cl"><span class="w">  </span><span class="c"># blockedNamespaceList:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 36</span><span class="cl"><span class="w">  </span><span class="c">#   - kube-system</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 37</span><span class="cl"><span class="w">  </span><span class="c">#   - kube-public</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 38</span><span class="cl"><span class="w">  </span><span class="nt">ipFamily</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="c"># This flag can take values V4 or V6 (default V4). This is for the backend pools to use ipv6 or ipv4. For frontside VS, use v6cidr</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 39</span><span class="cl"><span class="w">  </span><span class="nt">useDefaultSecretsOnly</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;false&#39;</span><span class="w"> </span><span class="c"># If this flag is set to true, AKO will only handle default secrets from the namespace where AKO is installed.</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 40</span><span class="cl"><span class="w">                                 </span><span class="c"># This flag is applicable only to Openshift clusters.</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 41</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 42</span><span class="cl"><span class="w"></span><span class="c">### This section outlines the network settings for virtualservices.</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 43</span><span class="cl"><span class="w"></span><span class="nt">NetworkSettings</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 44</span><span class="cl"><span class="w">  </span><span class="c">## This list of network and cidrs are used in pool placement network for vcenter cloud.</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 45</span><span class="cl"><span class="w">  </span><span class="c">## Node Network details are not needed when in nodeport mode / static routes are disabled / non vcenter clouds.</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 46</span><span class="cl"><span class="w">  </span><span class="c">## Either networkName or networkUUID should be specified.</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 47</span><span class="cl"><span class="w">  </span><span class="c">## If duplicate networks are present for the network name, networkUUID should be used for appropriate network.</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 48</span><span class="cl"><span class="w">  </span><span class="nt">nodeNetworkList</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 49</span><span class="cl"><span class="w">    </span>- <span class="nt">networkName</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;pks-0b7d0725-c67b-4e14-b6d0-52f799cb3556&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 50</span><span class="cl"><span class="w">      </span><span class="nt">cidrs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 51</span><span class="cl"><span class="w">        </span>- <span class="m">10.146.42.0</span><span class="l">/24</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 52</span><span class="cl"><span class="w">  </span><span class="c">#       - 11.0.0.1/24</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 53</span><span class="cl"><span class="w">  </span><span class="nt">enableRHI</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="c"># This is a cluster wide setting for BGP peering.</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 54</span><span class="cl"><span class="w">  </span><span class="nt">nsxtT1LR</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;/infra/tier-1s/The-Tier-1&#39;</span><span class="w"> </span><span class="c"># T1 Logical Segment mapping for backend network. Only applies to NSX-T cloud.</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 55</span><span class="cl"><span class="w">  </span><span class="nt">bgpPeerLabels</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="c"># Select BGP peers using bgpPeerLabels, for selective VsVip advertisement.</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 56</span><span class="cl"><span class="w">  </span><span class="c"># bgpPeerLabels:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 57</span><span class="cl"><span class="w">  </span><span class="c">#   - peer1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 58</span><span class="cl"><span class="w">  </span><span class="c">#   - peer2</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 59</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 60</span><span class="cl"><span class="w">  </span><span class="c"># Network information of the VIP network. Multiple networks allowed only for AWS Cloud.</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 61</span><span class="cl"><span class="w">  </span><span class="c"># Either networkName or networkUUID should be specified.</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 62</span><span class="cl"><span class="w">  </span><span class="c"># If duplicate networks are present for the network name, networkUUID should be used for appropriate network.</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 63</span><span class="cl"><span class="w">  </span><span class="nt">vipNetworkList</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 64</span><span class="cl"><span class="w">   </span>- <span class="nt">networkName</span><span class="p">:</span><span class="w"> </span><span class="l">vip-l4-incluster-tkgi</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 65</span><span class="cl"><span class="w">     </span><span class="nt">cidr</span><span class="p">:</span><span class="w"> </span><span class="m">10.146.102.0</span><span class="l">/24</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 66</span><span class="cl"><span class="w">  </span><span class="c">#    v6cidr: 2002:🔢abcd:ffff:c0a8:101/64 # Setting this will enable the VS networks to use ipv6</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 67</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 68</span><span class="cl"><span class="w"></span><span class="c">### This section outlines all the knobs  used to control Layer 7 loadbalancing settings in AKO.</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 69</span><span class="cl"><span class="w"></span><span class="nt">L7Settings</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 70</span><span class="cl"><span class="w">  </span><span class="nt">defaultIngController</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;true&#39;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 71</span><span class="cl"><span class="w">  </span><span class="nt">noPGForSNI</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="c"># Switching this knob to true, will get rid of poolgroups from SNI VSes. Do not use this flag, if you don&#39;t want http caching. This will be deprecated once the controller support caching on PGs.</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 72</span><span class="cl"><span class="w">  </span><span class="nt">serviceType</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterIP</span><span class="w"> </span><span class="c"># enum NodePort|ClusterIP|NodePortLocal</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 73</span><span class="cl"><span class="w">  </span><span class="nt">shardVSSize: SMALL   # Use this to control the layer 7 VS numbers. This applies to both secure/insecure VSes but does not apply for passthrough. ENUMs</span><span class="p">:</span><span class="w"> </span><span class="l">LARGE, MEDIUM, SMALL, DEDICATED</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 74</span><span class="cl"><span class="w">  </span><span class="nt">passthroughShardSize: SMALL   # Control the passthrough virtualservice numbers using this ENUM. ENUMs</span><span class="p">:</span><span class="w"> </span><span class="l">LARGE, MEDIUM, SMALL</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 75</span><span class="cl"><span class="w">  </span><span class="nt">enableMCI</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;false&#39;</span><span class="w"> </span><span class="c"># Enabling this flag would tell AKO to start processing multi-cluster ingress objects.</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 76</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 77</span><span class="cl"><span class="w"></span><span class="c">### This section outlines all the knobs  used to control Layer 4 loadbalancing settings in AKO.</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 78</span><span class="cl"><span class="w"></span><span class="nt">L4Settings</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 79</span><span class="cl"><span class="w">  </span><span class="nt">defaultDomain</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="c"># If multiple sub-domains are configured in the cloud, use this knob to set the default sub-domain to use for L4 VSes.</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 80</span><span class="cl"><span class="w">  </span><span class="nt">autoFQDN: default   # ENUM</span><span class="p">:</span><span class="w"> </span><span class="l">default(&lt;svc&gt;.&lt;ns&gt;.&lt;subdomain&gt;), flat (&lt;svc&gt;-&lt;ns&gt;.&lt;subdomain&gt;), &#34;disabled&#34; If the value is disabled then the FQDN generation is disabled.</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 81</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 82</span><span class="cl"><span class="w"></span><span class="c">### This section outlines settings on the Avi controller that affects AKO&#39;s functionality.</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 83</span><span class="cl"><span class="w"></span><span class="nt">ControllerSettings</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 84</span><span class="cl"><span class="w">  </span><span class="nt">serviceEngineGroupName</span><span class="p">:</span><span class="w"> </span><span class="l">se-group-generic  </span><span class="w"> </span><span class="c"># Name of the ServiceEngine Group.</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 85</span><span class="cl"><span class="w">  </span><span class="nt">controllerVersion</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;22.1.4&#39;</span><span class="w"> </span><span class="c"># The controller API version</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 86</span><span class="cl"><span class="w">  </span><span class="nt">cloudName</span><span class="p">:</span><span class="w"> </span><span class="l">nsx-t-lhr  </span><span class="w"> </span><span class="c"># The configured cloud name on the Avi controller.</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 87</span><span class="cl"><span class="w">  </span><span class="nt">controllerHost</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;172.60.146.50&#39;</span><span class="w"> </span><span class="c"># IP address or Hostname of Avi Controller</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 88</span><span class="cl"><span class="w">  </span><span class="nt">tenantName</span><span class="p">:</span><span class="w"> </span><span class="l">admin  </span><span class="w"> </span><span class="c"># Name of the tenant where all the AKO objects will be created in AVI.</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 89</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 90</span><span class="cl"><span class="w"></span><span class="nt">nodePortSelector</span><span class="p">:</span><span class="w"> </span><span class="c"># Only applicable if serviceType is NodePort</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 91</span><span class="cl"><span class="w">  </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 92</span><span class="cl"><span class="w">  </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 93</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 94</span><span class="cl"><span class="w"></span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 95</span><span class="cl"><span class="w">  </span><span class="nt">limits</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 96</span><span class="cl"><span class="w">    </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="l">350m</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 97</span><span class="cl"><span class="w">    </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l">400Mi</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 98</span><span class="cl"><span class="w">  </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 99</span><span class="cl"><span class="w">    </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="l">200m</span><span class="w">
</span></span></span><span class="line"><span class="ln">100</span><span class="cl"><span class="w">    </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l">300Mi</span><span class="w">
</span></span></span><span class="line"><span class="ln">101</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">102</span><span class="cl"><span class="w"></span><span class="nt">securityContext</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="ln">103</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">104</span><span class="cl"><span class="w"></span><span class="nt">podSecurityContext</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="ln">105</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">106</span><span class="cl"><span class="w"></span><span class="nt">rbac</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">107</span><span class="cl"><span class="w">  </span><span class="c"># Creates the pod security policy if set to true</span><span class="w">
</span></span></span><span class="line"><span class="ln">108</span><span class="cl"><span class="w">  </span><span class="nt">pspEnable</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="ln">109</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">110</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">111</span><span class="cl"><span class="w"></span><span class="nt">avicredentials</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">112</span><span class="cl"><span class="w">  </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w">
</span></span></span><span class="line"><span class="ln">113</span><span class="cl"><span class="w">  </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w">
</span></span></span><span class="line"><span class="ln">114</span><span class="cl"><span class="w">  </span><span class="nt">authtoken</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">115</span><span class="cl"><span class="w">  </span><span class="nt">certificateAuthorityData</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">116</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">117</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">118</span><span class="cl"><span class="w"></span><span class="nt">persistentVolumeClaim</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w">
</span></span></span><span class="line"><span class="ln">119</span><span class="cl"><span class="w"></span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/log</span><span class="w">
</span></span></span><span class="line"><span class="ln">120</span><span class="cl"><span class="w"></span><span class="nt">logFile</span><span class="p">:</span><span class="w"> </span><span class="l">avi.log</span><span class="w">
</span></span></span></code></pre></div><p>Now when I am done editing the values file its time to deploy AKO.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln">1</span><span class="cl"><span class="l">andreasm@ubuntu02:~/tkgi/cluster-1-nsx-manager-api$ helm install --generate-name oci://projects.registry.vmware.com/ako/helm-charts/ako --version 1.10.3 -f ako-values.1.10.3.yaml --namespace avi-system</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="nt">Pulled</span><span class="p">:</span><span class="w"> </span><span class="l">projects.registry.vmware.com/ako/helm-charts/ako:1.10.3</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w"></span><span class="nt">Digest</span><span class="p">:</span><span class="w"> </span><span class="l">sha256:1f2f9b89f4166737ed0d0acf4ebfb5853fb6f67b08ca1c8dae48e1dd99d31ab6</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w"></span><span class="nt">NAME</span><span class="p">:</span><span class="w"> </span><span class="l">ako-1701092267</span><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w"></span><span class="nt">LAST DEPLOYED</span><span class="p">:</span><span class="w"> </span><span class="l">Mon Nov 27 13:37:48 2023</span><span class="w">
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="w"></span><span class="nt">NAMESPACE</span><span class="p">:</span><span class="w"> </span><span class="l">avi-system</span><span class="w">
</span></span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="w"></span><span class="nt">STATUS</span><span class="p">:</span><span class="w"> </span><span class="l">deployed</span><span class="w">
</span></span></span><span class="line"><span class="ln">8</span><span class="cl"><span class="w"></span><span class="nt">REVISION</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="ln">9</span><span class="cl"><span class="w"></span><span class="nt">TEST SUITE</span><span class="p">:</span><span class="w"> </span><span class="l">None</span><span class="w">
</span></span></span></code></pre></div><p>Its up and running and no errors in the logs. So far so good</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">andreasm@ubuntu02:~/tkgi/cluster-1-nsx-manager-api$ k get pods -n avi-system
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">NAME    READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">ako-0   1/1     Running   <span class="m">0</span>          81s
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">andreasm@ubuntu02:~/tkgi/cluster-1-nsx-manager-api$ k logs -n avi-system ako-0
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">2023-11-27T13:38:04.192Z	INFO	api/api.go:52	Setting route <span class="k">for</span> GET /api/status
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">2023-11-27T13:38:04.193Z	INFO	ako-main/main.go:72	AKO is running with version: v1.10.3
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">2023-11-27T13:38:04.193Z	INFO	ako-main/main.go:82	We are running inside kubernetes cluster. Won<span class="s1">&#39;t use kubeconfig files.
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="s1">2023-11-27T13:38:04.193Z	INFO	api/api.go:110	Starting API server at :8080
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="s1">2023-11-27T13:38:04.278Z	INFO	ako-main/main.go:157	Kubernetes cluster apiserver version 1.27
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="s1">2023-11-27T13:38:04.285Z	INFO	utils/utils.go:168	Initializing configmap informer in avi-system
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="s1">2023-11-27T13:38:04.285Z	INFO	lib/dynamic_client.go:137	Skipped initializing dynamic informers for cniPlugin ncp
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="s1">2023-11-27T13:38:05.660Z	INFO	utils/avi_rest_utils.go:116	Overwriting the controller version 22.1.4 to max Avi version 22.1.3
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="s1">2023-11-27T13:38:05.660Z	INFO	utils/avi_rest_utils.go:119	Setting the client version to the current controller version 22.1.3
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="s1">2023-11-27T13:38:06.849Z	INFO	cache/controller_obj_cache.go:2345	Avi cluster state is CLUSTER_UP_NO_HA
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="s1">2023-11-27T13:38:07.019Z	INFO	cache/controller_obj_cache.go:3116	Setting cloud vType: CLOUD_NSXT
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="s1">2023-11-27T13:38:07.019Z	INFO	cache/controller_obj_cache.go:3119	Setting cloud uuid: cloud-b739e6b0-f0c8-4259-b36b-450d227c633c
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="s1">2023-11-27T13:38:07.019Z	INFO	lib/lib.go:291	Setting AKOUser: ako-tkgi-cluster-1 for Avi Objects
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="s1">2023-11-27T13:38:07.019Z	INFO	cache/controller_obj_cache.go:2855	Skipping the check for SE group labels
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="s1">2023-11-27T13:38:07.019Z	INFO	cache/controller_obj_cache.go:3395	Skipping the check for Node Network
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="s1">2023-11-27T13:38:07.134Z	INFO	cache/controller_obj_cache.go:3526	Setting VRF The-Tier-1 found from network vip-l4-incluster-tkgi
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="s1">2023-11-27T13:38:07.135Z	INFO	record/event.go:282	Event(v1.ObjectReference{Kind:&#34;Pod&#34;, Namespace:&#34;avi-system&#34;, Name:&#34;ako-0&#34;, UID:&#34;e0a321af-42c9-49cb-a3b5-cba17cf41805&#34;, APIVersion:&#34;v1&#34;, ResourceVersion:&#34;65342&#34;, FieldPath:&#34;&#34;}): type: &#39;</span>Normal<span class="s1">&#39; reason: &#39;</span>ValidatedUserInput<span class="err">&#39;</span> User input validation completed.
</span></span><span class="line"><span class="ln">23</span><span class="cl">2023-11-27T13:38:07.139Z	INFO	lib/lib.go:230	Setting Disable Sync to: <span class="nb">false</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl">2023-11-27T13:38:07.143Z	INFO	k8s/ako_init.go:271	avi k8s configmap created
</span></span><span class="line"><span class="ln">25</span><span class="cl">2023-11-27T13:38:08.007Z	WARN	rest/dequeue_nodes.go:65	key: admin/DummyVSForStaleData, msg: no model found <span class="k">for</span> the key
</span></span></code></pre></div><p>Do I have an Ingressclass now?</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@ubuntu02:~/tkgi/examples$ k get ingressclasses.networking.k8s.io
</span></span><span class="line"><span class="ln">2</span><span class="cl">NAME     CONTROLLER              PARAMETERS   AGE
</span></span><span class="line"><span class="ln">3</span><span class="cl">avi-lb   ako.vmware.com/avi-lb   &lt;none&gt;       13m
</span></span></code></pre></div><p>Yes I do 😄</p>
<p>Time to deploy some test applications, first out my favourite demo app, <em>Yelb</em>.</p>
<p>This just need a servicetype loadbalancer.</p>
<p>Backend</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">andreasm@ubuntu02:~/tkgi/examples$ k apply -f yelb-lb-backend.yaml
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">service/redis-server created
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">service/yelb-db created
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">service/yelb-appserver created
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">deployment.apps/redis-server created
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">deployment.apps/yelb-db created
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">deployment.apps/yelb-appserver created
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">andreasm@ubuntu02:~/tkgi/examples$ k get pods -n yelb
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">NAME                             READY   STATUS              RESTARTS   AGE
</span></span><span class="line"><span class="ln">10</span><span class="cl">redis-server-6cf478df95-vf7t8    0/1     ContainerCreating   <span class="m">0</span>          5s
</span></span><span class="line"><span class="ln">11</span><span class="cl">yelb-appserver-bf75dbb5b-g6bmf   0/1     ContainerCreating   <span class="m">0</span>          5s
</span></span><span class="line"><span class="ln">12</span><span class="cl">yelb-db-d4c64d9c-687sb           0/1     ContainerCreating   <span class="m">0</span>          5s
</span></span></code></pre></div><p>Frontend,  where the request for a loadbalancer comes from.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">andreasm@ubuntu02:~/tkgi/examples$ k apply -f yelb-lb-frontend.yaml
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">service/yelb-ui created
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">deployment.apps/yelb-ui created
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">andreasm@ubuntu02:~/tkgi/examples$ k get svc -n yelb
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">NAME             TYPE           CLUSTER-IP       EXTERNAL-IP      PORT<span class="o">(</span>S<span class="o">)</span>        AGE
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">redis-server     ClusterIP      10.100.200.110   &lt;none&gt;           6379/TCP       8m46s
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">yelb-appserver   ClusterIP      10.100.200.170   &lt;none&gt;           4567/TCP       8m46s
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">yelb-db          ClusterIP      10.100.200.84    &lt;none&gt;           5432/TCP       8m46s
</span></span><span class="line"><span class="ln">10</span><span class="cl">yelb-ui          LoadBalancer   10.100.200.123   10.146.102.100   80:30400/TCP   31s
</span></span></code></pre></div><p>There it is..</p>
<p>Now what happens in the NSX ALB ui?</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="vs-created"
      
        class="image_figure image_internal image_processed"
        width="2188"
        height="1014"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231127145237402.png"
      
      
    />

    </picture>
</figure>
</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="se-creating"
      
        class="image_figure image_internal image_processed"
        width="2098"
        height="1142"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231127145215719.png"
      
      
    />

    </picture>
</figure>
</p>
<p>In vCenter the first SE has been deployed.</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="vcenter-se"
      
        class="image_figure image_internal image_processed"
        width="656"
        height="110"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231127145325461.png"
      
      
    />

    </picture>
</figure>
</p>
<p>And the Service is UP</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="vs-up"
      
        class="image_figure image_internal image_processed"
        width="2164"
        height="1188"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231127145410046.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Can I access it?</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="service-with-ip"
      
        class="image_figure image_internal image_processed"
        width="3030"
        height="124"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231127152228629.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Let me just use the automatically dns record created by the AKO integration with NSX ALB DNS service.
This means I have enabled the DNS service in NSX ALB to auto create DNS records for me whenever I create servicetype Loabalancer or Ingress objects. So I dont have to think about that.</p>
<p>In this case the FQDN of my yelb ui service is <em>yelb-ui-yelb.this-is-a.domain.net</em></p>
<p>I will grab the ip of the service and do a curl</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">andreasm@ubuntu02:~/tkgi/examples$ curl yelb-ui-yelb.this-is-a.domain.net
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">&lt;!doctype html&gt;
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">&lt;html&gt;
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">&lt;head&gt;
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">    &lt;meta <span class="nv">charset</span><span class="o">=</span><span class="s2">&#34;utf-8&#34;</span>&gt;
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">    &lt;title&gt;Yelb&lt;/title&gt;
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">    &lt;base <span class="nv">href</span><span class="o">=</span><span class="s2">&#34;/&#34;</span>&gt;
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">    &lt;meta <span class="nv">name</span><span class="o">=</span><span class="s2">&#34;viewport&#34;</span> <span class="nv">content</span><span class="o">=</span><span class="s2">&#34;width=device-width, initial-scale=1&#34;</span>&gt;
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">    &lt;link <span class="nv">rel</span><span class="o">=</span><span class="s2">&#34;icon&#34;</span> <span class="nv">type</span><span class="o">=</span><span class="s2">&#34;image/x-icon&#34;</span> <span class="nv">href</span><span class="o">=</span><span class="s2">&#34;favicon.ico?v=2&#34;</span>&gt;
</span></span><span class="line"><span class="ln">10</span><span class="cl">&lt;/head&gt;
</span></span><span class="line"><span class="ln">11</span><span class="cl">&lt;body&gt;
</span></span><span class="line"><span class="ln">12</span><span class="cl">&lt;yelb&gt;Loading...&lt;/yelb&gt;
</span></span><span class="line"><span class="ln">13</span><span class="cl">&lt;script <span class="nv">type</span><span class="o">=</span><span class="s2">&#34;text/javascript&#34;</span> <span class="nv">src</span><span class="o">=</span><span class="s2">&#34;inline.bundle.js&#34;</span>&gt;&lt;/script&gt;&lt;script <span class="nv">type</span><span class="o">=</span><span class="s2">&#34;text/javascript&#34;</span> <span class="nv">src</span><span class="o">=</span><span class="s2">&#34;styles.bundle.js&#34;</span>&gt;&lt;/script&gt;&lt;script <span class="nv">type</span><span class="o">=</span><span class="s2">&#34;text/javascript&#34;</span> <span class="nv">src</span><span class="o">=</span><span class="s2">&#34;scripts.bundle.js&#34;</span>&gt;&lt;/script&gt;&lt;script <span class="nv">type</span><span class="o">=</span><span class="s2">&#34;text/javascript&#34;</span> <span class="nv">src</span><span class="o">=</span><span class="s2">&#34;vendor.bundle.js&#34;</span>&gt;&lt;/script&gt;&lt;script <span class="nv">type</span><span class="o">=</span><span class="s2">&#34;text/javascript&#34;</span> <span class="nv">src</span><span class="o">=</span><span class="s2">&#34;main.bundle.js&#34;</span>&gt;&lt;/script&gt;&lt;/body&gt;
</span></span><span class="line"><span class="ln">14</span><span class="cl">&lt;/html&gt;
</span></span></code></pre></div><p>Nice</p>
<p>Now lets test the Ingress.</p>
<p>I will deploy two pods with corresponding ClusterIP services that has one purpose in life and that is displaying apple and banana respectively. Then I will deploy an Ingress pointing to these two services.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">andreasm@ubuntu02:~/tkgi/examples$ k apply -f apple.yaml -f banana.yaml
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">pod/apple-app created
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">service/apple-service created
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">pod/banana-app created
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">service/banana-service created
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">andreasm@ubuntu02:~/tkgi/examples$ k get svc -n fruit
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">NAME             TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>    AGE
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">apple-service    ClusterIP   10.100.200.33    &lt;none&gt;        5678/TCP   26s
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">banana-service   ClusterIP   10.100.200.231   &lt;none&gt;        5678/TCP   26s
</span></span><span class="line"><span class="ln">10</span><span class="cl">
</span></span><span class="line"><span class="ln">11</span><span class="cl">andreasm@ubuntu02:~/tkgi/examples$ k apply -f ingress-example-generic.yaml
</span></span><span class="line"><span class="ln">12</span><span class="cl">ingress.networking.k8s.io/ingress-example created
</span></span><span class="line"><span class="ln">13</span><span class="cl">andreasm@ubuntu02:~/tkgi/examples$ k get ingress -n fruit
</span></span><span class="line"><span class="ln">14</span><span class="cl">NAME              CLASS    HOSTS                             ADDRESS          PORTS   AGE
</span></span><span class="line"><span class="ln">15</span><span class="cl">ingress-example   avi-lb   fruit-tkgi.this-is-a.domain.net   10.146.102.101   <span class="m">80</span>      7s
</span></span></code></pre></div><p>And in my NSX ALB UI</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="fruit-ingress"
      
        class="image_figure image_internal image_processed"
        width="1932"
        height="870"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231127221314940.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Now can I reach it? Lets test using the FQDN:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@ubuntu02:~/tkgi/examples$ curl fruit-tkgi.this-is-a.domain.net/apple
</span></span><span class="line"><span class="ln">2</span><span class="cl">apple
</span></span><span class="line"><span class="ln">3</span><span class="cl">andreasm@ubuntu02:~/tkgi/examples$ curl fruit-tkgi.this-is-a.domain.net/banana
</span></span><span class="line"><span class="ln">4</span><span class="cl">banana
</span></span></code></pre></div><p>Works like a charm...</p>
<p>Now back to my notice above about doing this in an unsupported way and placing the SEs on different T1s (which I cant understand how is possible to do anyway). By just doing a traceflow from one of the SEs data nic to the worker nodes of my Kubernetes cluster, it will involve the Edge cluster as the destination T1 is centralised (being active/passive and placed on an Edge cluster). But when using products like TKGi, TKGs the auto created Tier1 routers tend to be created as centralized routers, so we will alway have this issue when traffic is going through the Tier-0/Edges.</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="traceflow"
      
        class="image_figure image_internal image_processed"
        width="3564"
        height="1932"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231127201836688.png"
      
      
    />

    </picture>
</figure>
</p>
<p>A quick diagram of how this topology looks like networking wise:</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="nsx-topology"
      
        class="image_figure image_internal image_processed"
        width="2201"
        height="600"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231127221214444.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Here my Tier1 routers for the PKS segments will be created by TKGi and I cant configre Avi to use somehting that does not exist.</p>
<p>Well, it was a nice test. It worked.. Let me tear it all down and go ahead with an installation using Antrea as the CNI.</p>
<h2 id="deploy-workload-clusters-using-antrea">Deploy workload clusters using Antrea</h2>
<p>In this approach there will be no automatic assignement of a L4 loadbalancer for the Kubernetes API endpoints, that is something I need to manually provide myself, and I will be using NSX ALB for that purpose also.</p>
<p>Here is my TKGi installation for this section:</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="tkgi-antrea"
      
        class="image_figure image_internal image_processed"
        width="1798"
        height="1434"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231201100222581.png"
      
      
    />

    </picture>
</figure>
</p>
<p>First I will need to create a Kubernetes cluster. I will not use the TKGi MC to deploy the cluster now, I will use the TKGi CLI to to that, just to make it a bit more interesting. I still have the option to use TKGi MC, but I have already used that approach above.  More info on TKGi CLI <a href="https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid-Integrated-Edition/1.18/tkgi/GUID-cli-index.html">here</a></p>
<p>Login to the TKGi API</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@ubuntu02:~/tkgi$ tkgi login -a tkgi-api.this-is-a.domain.net -u admin -p <span class="s1">&#39;password&#39;</span> --ca-cert ca/tkgi-ca.crt
</span></span><span class="line"><span class="ln">2</span><span class="cl">
</span></span><span class="line"><span class="ln">3</span><span class="cl">API Endpoint: tkgi-api.this-is-a.domain.net
</span></span><span class="line"><span class="ln">4</span><span class="cl">User: admin
</span></span><span class="line"><span class="ln">5</span><span class="cl">Login successful.
</span></span></code></pre></div><p>All the relevant information can be found in the TKGi MC Deployment Metadata page.</p>
<p>Now its just all about creating the same cluster as I did in TKGi MC just using cli instead. There is no need to create any network profiles this time as there is no NSX-T that provides any loadbalancer functionality. It is a &quot;vanilla&quot; Kubernetes cluster with Antrea as the CNI, so I will need to add the services I need. I will start by listing the plans available. I will go with the medium plan, deploy 3 control plane nodes and 3 worker nodes. The reason for three control plane nodes is because I would like to utilize the Avi LB for the the Kubernetes API endpoint and the it is much more interesting to have more than 1 cp node as the loadbalancer should have something to loadbalance. The purpose of a loadbalancer....</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">andreasm@ubuntu02:~/tkgi/cluster-1-antrea$ tkgi network-profiles
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">Name  Description
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="c1"># No profiles as its not needed</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">andreasm@ubuntu02:~/tkgi/cluster-1-antrea$ tkgi plans
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">Name    ID                                    Description
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">Small   8A0E21A8-8072-4D80-B365-D1F502085560  This plan will configure a lightweight Kubernetes cluster. Not recommended <span class="k">for</span> production workloads.
</span></span><span class="line"><span class="ln">10</span><span class="cl">Medium  58375a45-17f7-4291-acf1-455bfdc8e371  Example: This plan will configure a medium sized Kubernetes cluster, suitable <span class="k">for</span> more pods.
</span></span><span class="line"><span class="ln">11</span><span class="cl">Large   241118e5-69b2-4ef9-b47f-4d2ab071aff5  Example: This plan will configure a large Kubernetes cluster <span class="k">for</span> resource heavy workloads, or a high number of workloads.
</span></span></code></pre></div><p>Now, lets create a cluster</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">andreasm@ubuntu02:~/tkgi/cluster-1-antrea$ tkgi create-cluster tkgi-cluster-1-antrea --external-hostname tkgi-cluster-1-antrea.this-is-a.domain.net --plan Medium --num-nodes <span class="m">3</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">PKS Version:              1.18.0-build.46
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">Name:                     tkgi-cluster-1-antrea
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">K8s Version:              1.27.5
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">Plan Name:                Medium
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">UUID:                     518d850c-ca34-4163-85cb-dda5d915abda
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">Last Action:              CREATE
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">Last Action State:        in progress
</span></span><span class="line"><span class="ln">10</span><span class="cl">Last Action Description:  Creating cluster
</span></span><span class="line"><span class="ln">11</span><span class="cl">Kubernetes Master Host:   tkgi-cluster-1-antrea.this-is-a.domain.net
</span></span><span class="line"><span class="ln">12</span><span class="cl">Kubernetes Master Port:   <span class="m">8443</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">Worker Nodes:             <span class="m">3</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">Kubernetes Master IP<span class="o">(</span>s<span class="o">)</span>:  In Progress
</span></span><span class="line"><span class="ln">15</span><span class="cl">Network Profile Name:
</span></span><span class="line"><span class="ln">16</span><span class="cl">Kubernetes Profile Name:
</span></span><span class="line"><span class="ln">17</span><span class="cl">Compute Profile Name:
</span></span><span class="line"><span class="ln">18</span><span class="cl">NSX Policy:               <span class="nb">false</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">Tags:
</span></span><span class="line"><span class="ln">20</span><span class="cl">
</span></span><span class="line"><span class="ln">21</span><span class="cl">Use <span class="s1">&#39;tkgi cluster tkgi-cluster-1-antrea&#39;</span> to monitor the state of your cluster
</span></span></code></pre></div><p>In vCenter I can see that TKGi has been so kind to spread my Kubernetes cluster across all three availability zones:</p>
<img src=images/image-20231201102725337.png style="width:500px" />
<p>And in my TKGi MC:

  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="nodes"
      
        class="image_figure image_internal image_processed"
        width="3568"
        height="1150"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231201103243628.png"
      
      
    />

    </picture>
</figure>
</p>
<p>After a while it is ready:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">andreasm@ubuntu02:~/tkgi/cluster-1-antrea$ tkgi clusters
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">PKS Version      Name                   k8s Version  Plan Name  UUID                                  Status     Action
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">1.18.0-build.46  tkgi-cluster-1-antrea  1.27.5       Medium     518d850c-ca34-4163-85cb-dda5d915abda  succeeded  CREATE
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">andreasm@ubuntu02:~/tkgi/cluster-1-antrea$ tkgi cluster tkgi-cluster-1-antrea
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">PKS Version:              1.18.0-build.46
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">Name:                     tkgi-cluster-1-antrea
</span></span><span class="line"><span class="ln">10</span><span class="cl">K8s Version:              1.27.5
</span></span><span class="line"><span class="ln">11</span><span class="cl">Plan Name:                Medium
</span></span><span class="line"><span class="ln">12</span><span class="cl">UUID:                     518d850c-ca34-4163-85cb-dda5d915abda
</span></span><span class="line"><span class="ln">13</span><span class="cl">Last Action:              CREATE
</span></span><span class="line"><span class="ln">14</span><span class="cl">Last Action State:        succeeded
</span></span><span class="line"><span class="ln">15</span><span class="cl">Last Action Description:  Instance provisioning completed
</span></span><span class="line"><span class="ln">16</span><span class="cl">Kubernetes Master Host:   tkgi-cluster-1-antrea.this-is-a.domain.net
</span></span><span class="line"><span class="ln">17</span><span class="cl">Kubernetes Master Port:   <span class="m">8443</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">Worker Nodes:             <span class="m">3</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">Kubernetes Master IP<span class="o">(</span>s<span class="o">)</span>:  10.146.41.4, 10.146.41.2, 10.146.41.3
</span></span><span class="line"><span class="ln">20</span><span class="cl">Network Profile Name:
</span></span><span class="line"><span class="ln">21</span><span class="cl">Kubernetes Profile Name:
</span></span><span class="line"><span class="ln">22</span><span class="cl">Compute Profile Name:
</span></span><span class="line"><span class="ln">23</span><span class="cl">NSX Policy:               <span class="nb">false</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl">Tags:
</span></span></code></pre></div><p>In TKGiMC</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="success"
      
        class="image_figure image_internal image_processed"
        width="3568"
        height="1002"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231201104658879.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Now as I can see from the output above, I can reach my cluster using any of my 3 control plane nodes. I would like to reach them using one singe entry, and with the real external name. I will now go ahead and create the Virtual Service in NSX Advanced Loadbalancer.</p>
<h3 id="configure-nsx-advanced-loadbalancer-as-kuberntes-api-endpoint-provider">Configure NSX Advanced Loadbalancer as Kuberntes API endpoint provider</h3>
<p>In NSX ALB, go to Virtual Services and create a new Virtual Sevice, and select advanced.</p>
<img src=images/image-20231201104856791.png style="width:300px" />
<p>Then I will configure my Virtual Service accordingly below:</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="vrf"
      
        class="image_figure image_internal image_processed"
        width="3046"
        height="1824"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231201103655436.png"
      
      
    />

    </picture>
</figure>
</p>
<p>The Virtual Service Settings:</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="vs"
      
        class="image_figure image_internal image_processed"
        width="3042"
        height="1806"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231201104211003.png"
      
      
    />

    </picture>
</figure>
</p>
<p>The pool containing my Control Plane nodes (notice the control plane nodes dont use the defaul Kubernetes 6443 port, it is using 8443):</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="pool-1"
      
        class="image_figure image_internal image_processed"
        width="2082"
        height="1728"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231201104234017.png"
      
      
    />

    </picture>
</figure>
</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="pool-2"
      
        class="image_figure image_internal image_processed"
        width="2066"
        height="1744"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231201104252809.png"
      
      
    />

    </picture>
</figure>
</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="pool-3"
      
        class="image_figure image_internal image_processed"
        width="2054"
        height="1722"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231201104312323.png"
      
      
    />

    </picture>
</figure>
</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="pool-4"
      
        class="image_figure image_internal image_processed"
        width="2070"
        height="1732"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231201104333141.png"
      
      
    />

    </picture>
</figure>
</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="pool-5"
      
        class="image_figure image_internal image_processed"
        width="2080"
        height="1844"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231201104407397.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Then it is the VS VIP. Here I will also add a FQDN/DNS entry called tkgi-cluster-1-antrea.this-is-a.domain.net</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="vs-vip"
      
        class="image_figure image_internal image_processed"
        width="2078"
        height="1848"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231201104436991.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Last step I just select the SE group I want to use.</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="save"
      
        class="image_figure image_internal image_processed"
        width="3040"
        height="1810"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231201104510044.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Finish.</p>
<p>And my Virtual Service should now be green and I can use this entrypoint to reach my newly created Kubernetes Cluster.</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="vs-k8s-api"
      
        class="image_figure image_internal image_processed"
        width="2416"
        height="1290"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231201112132810.png"
      
      
    />

    </picture>
</figure>
</p>
<p>The FQDN/DNS record is being automatically created by the Avi DNS service. So I should be able to use DNS instead of ip:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@ubuntu02:~/tkgi/cluster-1-antrea$ ping tkgi-cluster-1-antrea.this-is-a.domain.net
</span></span><span class="line"><span class="ln">2</span><span class="cl">PING tkgi-cluster-1-antrea.this-is-a.domain.net <span class="o">(</span>10.146.101.10<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
</span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="m">64</span> bytes from 10.146.101.10 <span class="o">(</span>10.146.101.10<span class="o">)</span>: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">63</span> <span class="nv">time</span><span class="o">=</span>0.562 ms
</span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="m">64</span> bytes from 10.146.101.10 <span class="o">(</span>10.146.101.10<span class="o">)</span>: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">2</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">63</span> <span class="nv">time</span><span class="o">=</span>0.602 ms
</span></span></code></pre></div><p>Getting the Kubernetes context and logging in:</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="cluster-info"
      
        class="image_figure image_internal image_processed"
        width="3572"
        height="1812"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231201112448886.png"
      
      
    />

    </picture>
</figure>
</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">andreasm@ubuntu02:~/tkgi/cluster-1-antrea$ kubectl config set-cluster tkgi-cluster-1-antrea --server<span class="o">=</span>https://tkgi-cluster-1-antrea.this-is-a.domain.net:8443 <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="se"></span>kubectl config <span class="nb">set</span> clusters.tkgi-cluster-1-antrea.certificate-authority-data <span class="nv">Ci0tLS0tQkVHSU4gQ0VSVElGSUNBVEUtLS0tLQpNSUlET3pDQ0FpT2dBd0lCQWdJVVlGdDNxVFJLYXQ5T3hxOS9kYzdzbkNnSXRMa3dEUVlKS29aSWh2Y05BUUVMCkJRQXdMVEVMTUFrR0ExVUVBeE1DUTBFeERUQUxCZ05WQkFzVEJGUkxSMGt4RHpBTkJnTlZCQW9UQmxaTmQyRnkKWlRBZUZ3MHlNekV5TURFd09URXpNREZhRncweU56RXlNREV3T1RFek1ERmFNQzB4Q3pBSkJnTlZCQU1UQWtOQgpNUTB3Q3dZRFZRUUxFd1JVUzBkSk1ROHdEUVlEVlFRS0V3WldUWGRoY21Vd2dnRWlNQTBHQ1NxR1NJYjNEUUVCCkFRVUFBNElCRHdBd2dnRUtBb0lCQVFDNS9lcDdFLzFQOXJPanpxNlNJVkRaN2dDTEJ0L21GZW5oQVNNQUM0WUEKUUVmUnlzWlloZUhxRkZxVENEcEpRZzFuUDFmZzNEdDhhVWNpaGR6VEEremJvS0R6WStjWk9EVy9yM1YvR2Y1bwpIdHd2SDIrWkEyT1lydlVrOGExVUwvb1hKNHdlWFBsWUdndWJoeXcrSU44WUdGdEVQQnlmaTQrSEFQdDFveWlTCnN5VUF1bHFiOUwyU29xQ3Zmc3cwY2cyN0l5RktvN1FUSmFiTnd1MXdQbnhnWCtwa2M4dTdsSnZucWJnMm1OeUYKYVpxZGRqMHN1YmplSG9VN0Z3b3U5ZHN4SVVCYlZSbWxQVkc1S1JSN3pVdWNSTjdLKzYyS1p2ZWMwRGNsaW13SApONEhqUFJSczN4OEpVRXFEajU5MWcrT0NUTnFqK0pIVm9sQnFJbi9RcUlOVkFnTUJBQUdqVXpCUk1CMEdBMVVkCkRnUVdCQlRUMVRleVlMcGtaRzZnZGxXU05pVXlIaURUeURBZkJnTlZIU01FR0RBV2dCVFQxVGV5WUxwa1pHNmcKZGxXU05pVXlIaURUeURBUEJnTlZIUk1CQWY4RUJUQURBUUgvTUEwR0NTcUdTSWIzRFFFQkN3VUFBNElCQVFBdApqY09iOFFjUmxWM2h6YXc2R2YzdnpxeFRXYXl4b1NiK1ZFSCtUTEFuZERRaVZQMjR2OS9uektYVUl5M0pPQnlQCnVmNnJJQ2Viekt6WUtDNC9hb2JpRmJBcmRiajd3c1UyNGMvUHdPdUgya0l2SnY0Q3lwOHZ3Umh3aUdnZUZCNFoKMEdLNkJ0VGdKVW9QblhuZnYreGZrRzFMN0Jod0Z6aC9YM2lNSmp4S21tenpLcXRBZG5aajMvbFhaUlAzVUFSbgpuQTlBakVDbkpxSU5ENGhLK1p4cjhaVy81a0NtM2xWL3BRMHZMSXF6czBmN1RMS2hHYXhieFExeDBpRmxwS3JoCkIzU1lhTDdQTmJCUzYzWE50ZjlZQnNPYmFmNFErbFFlVlRMQ2ZkZGwxN0ZzaXJ5T0xQK09aK2pmUnJQSmdPbmcKR281VU8xZ0RyR1dkWHpYK1NRZmgKLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo</span><span class="o">=</span> <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="se"></span>kubectl config set-credentials 93a89395-658d-4058-b1f2-5a47a50b51f9 --token<span class="o">=</span>eyJhbGciOiJSUzI1NiIsImtpZCI6IkVCUzkyVFExNktOTzV5bF9ITG1aYWNiYzMxQk9IZnVXMHF2MFNMQ1FqU2cifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJkZWZhdWx0Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZWNyZXQubmFtZSI6IjkzYTg5Mzk1LTY1OGQtNDA1OC1iMWYyLTVhNDdhNTBiNTFmOSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50Lm5hbWUiOiI5M2E4OTM5NS02NThkLTQwNTgtYjFmMi01YTQ3YTUwYjUxZjkiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC51aWQiOiI4NDk0YjZjNi03OTU0LTRiMWMtOWMwMC0yYTdjODFiMDkzZTIiLCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6ZGVmYXVsdDo5M2E4OTM5NS02NThkLTQwNTgtYjFmMi01YTQ3YTUwYjUxZjkifQ.CJg_eMksCi9eaEaKsB1tjy083owleoBH9tYM2olEpRyU5GQOc3tkRE0r9SqUhe67FB9JWruyuA6QwgyOGxGfJvi1r_spoQeQg7Xzn50N1OtKPocdTDlWUVgxXeqR1OBgPE3pfSIyvX7Hhf9TN-5oM7GSrCmwtVGhFyI3SH1VukYg63PjwrsBMlwi1l-WvOkKgDmishC7-bn2sep2z0GEGMZHC6eipt7kYOVsK19QSq-U9Z2yDWfOgctmRShZx0V0BbvqXonHFej8yD79nFEasX5BsrWhUXEldjU2teKB-cQjPFju-GjSKJEOybtRf_Pu0XBjJngaHOpjMzX-s9Xolg <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="se"></span>kubectl config set-context tkgi-cluster-1-antrea --cluster<span class="o">=</span>tkgi-cluster-1-antrea --user<span class="o">=</span>93a89395-658d-4058-b1f2-5a47a50b51f9 <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="se"></span>kubectl config use-context tkgi-cluster-1-antrea
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">Cluster <span class="s2">&#34;tkgi-cluster-1-antrea&#34;</span> set.
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">Property <span class="s2">&#34;clusters.tkgi-cluster-1-antrea.certificate-authority-data&#34;</span> set.
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">User <span class="s2">&#34;93a89395-658d-4058-b1f2-5a47a50b51f9&#34;</span> set.
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">Context <span class="s2">&#34;tkgi-cluster-1-antrea&#34;</span> created.
</span></span><span class="line"><span class="ln">10</span><span class="cl">Switched to context <span class="s2">&#34;tkgi-cluster-1-antrea&#34;</span>.
</span></span><span class="line"><span class="ln">11</span><span class="cl">andreasm@ubuntu02:~/tkgi/cluster-1-antrea$ k config current-context
</span></span><span class="line"><span class="ln">12</span><span class="cl">tkgi-cluster-1-antrea
</span></span><span class="line"><span class="ln">13</span><span class="cl">andreasm@ubuntu02:~/tkgi/cluster-1-antrea$ k get nodes
</span></span><span class="line"><span class="ln">14</span><span class="cl">NAME                                   STATUS   ROLES    AGE   VERSION
</span></span><span class="line"><span class="ln">15</span><span class="cl">7c0f802f-0ecf-47c7-adc6-2dbf3f8b3ccb   Ready    &lt;none&gt;   54m   v1.27.5+vmware.1
</span></span><span class="line"><span class="ln">16</span><span class="cl">9b83d6a1-402a-46b2-9645-cebfe5db5f23   Ready    &lt;none&gt;   58m   v1.27.5+vmware.1
</span></span><span class="line"><span class="ln">17</span><span class="cl">dac2d224-22cb-4254-be93-bebf131f40e7   Ready    &lt;none&gt;   50m   v1.27.5+vmware.1
</span></span></code></pre></div><p>Now I just need to do the same steps as in the section where I used NSX/NCP to configure NSX ALB as my L4 and L7 provider in my Kubernetes cluster</p>
<h3 id="configure-nsx-advanced-loadbalancer-as-layer-4-and-layer-7-provider-inside-kubernetes-cluster">Configure NSX Advanced Loadbalancer as Layer 4 and Layer 7 provider inside Kubernetes cluster</h3>
<p>I am logged into my Kubernetes cluster <em>tkgi-cluster-1-antrea</em></p>
<p>I need to check whether a certain Antrea feature is enabled, the NodePortLocal. So I will check the configmap of Antrea and confirm whether this is enabled or not. I do think it is default enabled from a certain Antrea version and up, but its good to be sure.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@ubuntu02:~/tkgi/cluster-1-antrea$ k get configmaps -n kube-system antrea-config -oyaml
</span></span><span class="line"><span class="ln">2</span><span class="cl">    <span class="c1"># Enable NodePortLocal feature to make the Pods reachable externally through NodePort</span>
</span></span><span class="line"><span class="ln">3</span><span class="cl">      NodePortLocal: <span class="nb">true</span>
</span></span></code></pre></div><p>The reason I want to know this is because I can then configure AKO to use NPL instead of NodePort or ClusterIP. NPL has some benefits over the two.</p>
<p>Now, prepare my AKO value yaml. Below is the the value yaml I will use when deploying AKO for this cluster:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln">  1</span><span class="cl"><span class="c"># Default values for ako.</span><span class="w">
</span></span></span><span class="line"><span class="ln">  2</span><span class="cl"><span class="w"></span><span class="c"># This is a YAML-formatted file.</span><span class="w">
</span></span></span><span class="line"><span class="ln">  3</span><span class="cl"><span class="w"></span><span class="c"># Declare variables to be passed into your templates.</span><span class="w">
</span></span></span><span class="line"><span class="ln">  4</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">  5</span><span class="cl"><span class="w"></span><span class="nt">replicaCount</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="ln">  6</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">  7</span><span class="cl"><span class="w"></span><span class="nt">image</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">  8</span><span class="cl"><span class="w">  </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l">projects.registry.vmware.com/ako/ako</span><span class="w">
</span></span></span><span class="line"><span class="ln">  9</span><span class="cl"><span class="w">  </span><span class="nt">pullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">IfNotPresent</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 10</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 11</span><span class="cl"><span class="w"></span><span class="c">### This section outlines the generic AKO settings</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 12</span><span class="cl"><span class="w"></span><span class="nt">AKOSettings</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 13</span><span class="cl"><span class="w">  </span><span class="nt">primaryInstance: true # Defines AKO instance is primary or not. Value `true` indicates that AKO instance is primary. In a multiple AKO deployment in a cluster, only one AKO instance should be primary. Default value</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="l">.</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 14</span><span class="cl"><span class="w">  </span><span class="nt">enableEvents</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;true&#39;</span><span class="w"> </span><span class="c"># Enables/disables Event broadcasting via AKO</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 15</span><span class="cl"><span class="w">  </span><span class="nt">logLevel: WARN   # enum</span><span class="p">:</span><span class="w"> </span><span class="l">INFO|DEBUG|WARN|ERROR</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 16</span><span class="cl"><span class="w">  </span><span class="nt">fullSyncFrequency</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;1800&#39;</span><span class="w"> </span><span class="c"># This frequency controls how often AKO polls the Avi controller to update itself with cloud configurations.</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 17</span><span class="cl"><span class="w">  </span><span class="nt">apiServerPort</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w"> </span><span class="c"># Internal port for AKO&#39;s API server for the liveness probe of the AKO pod default=8080</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 18</span><span class="cl"><span class="w">  </span><span class="nt">deleteConfig</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;false&#39;</span><span class="w"> </span><span class="c"># Has to be set to true in configmap if user wants to delete AKO created objects from AVI</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 19</span><span class="cl"><span class="w">  </span><span class="nt">disableStaticRouteSync</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;false&#39;</span><span class="w"> </span><span class="c"># If the POD networks are reachable from the Avi SE, set this knob to true.</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 20</span><span class="cl"><span class="w">  </span><span class="nt">clusterName</span><span class="p">:</span><span class="w"> </span><span class="l">tkgi-cluster-1-antrea  </span><span class="w"> </span><span class="c"># A unique identifier for the kubernetes cluster, that helps distinguish the objects for this cluster in the avi controller. // MUST-EDIT</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 21</span><span class="cl"><span class="w">  </span><span class="nt">cniPlugin: &#39;antrea&#39; # Set the string if your CNI is calico or openshift or ovn-kubernetes. For Cilium CNI, set the string as cilium only when using Cluster Scope mode for IPAM and leave it empty if using Kubernetes Host Scope mode for IPAM. enum</span><span class="p">:</span><span class="w"> </span><span class="l">calico|canal|flannel|openshift|antrea|ncp|ovn-kubernetes|cilium</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 22</span><span class="cl"><span class="w">  </span><span class="nt">enableEVH</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="c"># This enables the Enhanced Virtual Hosting Model in Avi Controller for the Virtual Services</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 23</span><span class="cl"><span class="w">  </span><span class="nt">layer7Only</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="c"># If this flag is switched on, then AKO will only do layer 7 loadbalancing.</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 24</span><span class="cl"><span class="w">  </span><span class="c"># NamespaceSelector contains label key and value used for namespacemigration</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 25</span><span class="cl"><span class="w">  </span><span class="c"># Same label has to be present on namespace/s which needs migration/sync to AKO</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 26</span><span class="cl"><span class="w">  </span><span class="nt">namespaceSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 27</span><span class="cl"><span class="w">    </span><span class="nt">labelKey</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 28</span><span class="cl"><span class="w">    </span><span class="nt">labelValue</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 29</span><span class="cl"><span class="w">  </span><span class="nt">servicesAPI: false # Flag that enables AKO in services API mode</span><span class="p">:</span><span class="w"> </span><span class="l">https://kubernetes-sigs.github.io/service-apis/. Currently implemented only for L4. This flag uses the upstream GA APIs which are not backward compatible</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 30</span><span class="cl"><span class="w">                     </span><span class="c"># with the advancedL4 APIs which uses a fork and a version of v1alpha1pre1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 31</span><span class="cl"><span class="w">  </span><span class="nt">vipPerNamespace</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;false&#39;</span><span class="w"> </span><span class="c"># Enabling this flag would tell AKO to create Parent VS per Namespace in EVH mode</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 32</span><span class="cl"><span class="w">  </span><span class="nt">istioEnabled</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="c"># This flag needs to be enabled when AKO is be to brought up in an Istio environment</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 33</span><span class="cl"><span class="w">  </span><span class="c"># This is the list of system namespaces from which AKO will not listen any Kubernetes or Openshift object event.</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 34</span><span class="cl"><span class="w">  </span><span class="nt">blockedNamespaceList</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 35</span><span class="cl"><span class="w">  </span><span class="c"># blockedNamespaceList:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 36</span><span class="cl"><span class="w">  </span><span class="c">#   - kube-system</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 37</span><span class="cl"><span class="w">  </span><span class="c">#   - kube-public</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 38</span><span class="cl"><span class="w">  </span><span class="nt">ipFamily</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="c"># This flag can take values V4 or V6 (default V4). This is for the backend pools to use ipv6 or ipv4. For frontside VS, use v6cidr</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 39</span><span class="cl"><span class="w">  </span><span class="nt">useDefaultSecretsOnly</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;false&#39;</span><span class="w"> </span><span class="c"># If this flag is set to true, AKO will only handle default secrets from the namespace where AKO is installed.</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 40</span><span class="cl"><span class="w">                                 </span><span class="c"># This flag is applicable only to Openshift clusters.</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 41</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 42</span><span class="cl"><span class="w"></span><span class="c">### This section outlines the network settings for virtualservices.</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 43</span><span class="cl"><span class="w"></span><span class="nt">NetworkSettings</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 44</span><span class="cl"><span class="w">  </span><span class="c">## This list of network and cidrs are used in pool placement network for vcenter cloud.</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 45</span><span class="cl"><span class="w">  </span><span class="c">## Node Network details are not needed when in nodeport mode / static routes are disabled / non vcenter clouds.</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 46</span><span class="cl"><span class="w">  </span><span class="c">## Either networkName or networkUUID should be specified.</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 47</span><span class="cl"><span class="w">  </span><span class="c">## If duplicate networks are present for the network name, networkUUID should be used for appropriate network.</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 48</span><span class="cl"><span class="w">  </span><span class="nt">nodeNetworkList</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 49</span><span class="cl"><span class="w">    </span>- <span class="nt">networkName</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;ls-tkgi-service-network&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 50</span><span class="cl"><span class="w">      </span><span class="nt">cidrs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 51</span><span class="cl"><span class="w">        </span>- <span class="m">10.146.41.0</span><span class="l">/24</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 52</span><span class="cl"><span class="w">  </span><span class="c">#       - 11.0.0.1/24</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 53</span><span class="cl"><span class="w">  </span><span class="nt">enableRHI</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="c"># This is a cluster wide setting for BGP peering.</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 54</span><span class="cl"><span class="w">  </span><span class="nt">nsxtT1LR</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;/infra/tier-1s/The-Tier-1&#39;</span><span class="w"> </span><span class="c"># T1 Logical Segment mapping for backend network. Only applies to NSX-T cloud.</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 55</span><span class="cl"><span class="w">  </span><span class="nt">bgpPeerLabels</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="c"># Select BGP peers using bgpPeerLabels, for selective VsVip advertisement.</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 56</span><span class="cl"><span class="w">  </span><span class="c"># bgpPeerLabels:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 57</span><span class="cl"><span class="w">  </span><span class="c">#   - peer1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 58</span><span class="cl"><span class="w">  </span><span class="c">#   - peer2</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 59</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 60</span><span class="cl"><span class="w">  </span><span class="c"># Network information of the VIP network. Multiple networks allowed only for AWS Cloud.</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 61</span><span class="cl"><span class="w">  </span><span class="c"># Either networkName or networkUUID should be specified.</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 62</span><span class="cl"><span class="w">  </span><span class="c"># If duplicate networks are present for the network name, networkUUID should be used for appropriate network.</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 63</span><span class="cl"><span class="w">  </span><span class="nt">vipNetworkList</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 64</span><span class="cl"><span class="w">   </span>- <span class="nt">networkName</span><span class="p">:</span><span class="w"> </span><span class="l">vip-l4-incluster-tkgi</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 65</span><span class="cl"><span class="w">     </span><span class="nt">cidr</span><span class="p">:</span><span class="w"> </span><span class="m">10.146.102.0</span><span class="l">/24</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 66</span><span class="cl"><span class="w">  </span><span class="c">#    v6cidr: 2002:🔢abcd:ffff:c0a8:101/64 # Setting this will enable the VS networks to use ipv6</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 67</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 68</span><span class="cl"><span class="w"></span><span class="c">### This section outlines all the knobs  used to control Layer 7 loadbalancing settings in AKO.</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 69</span><span class="cl"><span class="w"></span><span class="nt">L7Settings</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 70</span><span class="cl"><span class="w">  </span><span class="nt">defaultIngController</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;true&#39;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 71</span><span class="cl"><span class="w">  </span><span class="nt">noPGForSNI</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="c"># Switching this knob to true, will get rid of poolgroups from SNI VSes. Do not use this flag, if you don&#39;t want http caching. This will be deprecated once the controller support caching on PGs.</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 72</span><span class="cl"><span class="w">  </span><span class="nt">serviceType</span><span class="p">:</span><span class="w"> </span><span class="l">NodePortLocal</span><span class="w"> </span><span class="c"># enum NodePort|ClusterIP|NodePortLocal</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 73</span><span class="cl"><span class="w">  </span><span class="nt">shardVSSize: SMALL   # Use this to control the layer 7 VS numbers. This applies to both secure/insecure VSes but does not apply for passthrough. ENUMs</span><span class="p">:</span><span class="w"> </span><span class="l">LARGE, MEDIUM, SMALL, DEDICATED</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 74</span><span class="cl"><span class="w">  </span><span class="nt">passthroughShardSize: SMALL   # Control the passthrough virtualservice numbers using this ENUM. ENUMs</span><span class="p">:</span><span class="w"> </span><span class="l">LARGE, MEDIUM, SMALL</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 75</span><span class="cl"><span class="w">  </span><span class="nt">enableMCI</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;false&#39;</span><span class="w"> </span><span class="c"># Enabling this flag would tell AKO to start processing multi-cluster ingress objects.</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 76</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 77</span><span class="cl"><span class="w"></span><span class="c">### This section outlines all the knobs  used to control Layer 4 loadbalancing settings in AKO.</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 78</span><span class="cl"><span class="w"></span><span class="nt">L4Settings</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 79</span><span class="cl"><span class="w">  </span><span class="nt">defaultDomain</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="c"># If multiple sub-domains are configured in the cloud, use this knob to set the default sub-domain to use for L4 VSes.</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 80</span><span class="cl"><span class="w">  </span><span class="nt">autoFQDN: flat   # ENUM</span><span class="p">:</span><span class="w"> </span><span class="l">default(&lt;svc&gt;.&lt;ns&gt;.&lt;subdomain&gt;), flat (&lt;svc&gt;-&lt;ns&gt;.&lt;subdomain&gt;), &#34;disabled&#34; If the value is disabled then the FQDN generation is disabled.</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 81</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 82</span><span class="cl"><span class="w"></span><span class="c">### This section outlines settings on the Avi controller that affects AKO&#39;s functionality.</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 83</span><span class="cl"><span class="w"></span><span class="nt">ControllerSettings</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 84</span><span class="cl"><span class="w">  </span><span class="nt">serviceEngineGroupName</span><span class="p">:</span><span class="w"> </span><span class="l">se-group-generic  </span><span class="w"> </span><span class="c"># Name of the ServiceEngine Group.</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 85</span><span class="cl"><span class="w">  </span><span class="nt">controllerVersion</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;22.1.4&#39;</span><span class="w"> </span><span class="c"># The controller API version</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 86</span><span class="cl"><span class="w">  </span><span class="nt">cloudName</span><span class="p">:</span><span class="w"> </span><span class="l">nsx-t-lhr  </span><span class="w"> </span><span class="c"># The configured cloud name on the Avi controller.</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 87</span><span class="cl"><span class="w">  </span><span class="nt">controllerHost</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;172.60.146.50&#39;</span><span class="w"> </span><span class="c"># IP address or Hostname of Avi Controller</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 88</span><span class="cl"><span class="w">  </span><span class="nt">tenantName</span><span class="p">:</span><span class="w"> </span><span class="l">admin  </span><span class="w"> </span><span class="c"># Name of the tenant where all the AKO objects will be created in AVI.</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 89</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 90</span><span class="cl"><span class="w"></span><span class="nt">nodePortSelector</span><span class="p">:</span><span class="w"> </span><span class="c"># Only applicable if serviceType is NodePort</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 91</span><span class="cl"><span class="w">  </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 92</span><span class="cl"><span class="w">  </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 93</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 94</span><span class="cl"><span class="w"></span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 95</span><span class="cl"><span class="w">  </span><span class="nt">limits</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 96</span><span class="cl"><span class="w">    </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="l">350m</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 97</span><span class="cl"><span class="w">    </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l">400Mi</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 98</span><span class="cl"><span class="w">  </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 99</span><span class="cl"><span class="w">    </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="l">200m</span><span class="w">
</span></span></span><span class="line"><span class="ln">100</span><span class="cl"><span class="w">    </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l">300Mi</span><span class="w">
</span></span></span><span class="line"><span class="ln">101</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">102</span><span class="cl"><span class="w"></span><span class="nt">securityContext</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="ln">103</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">104</span><span class="cl"><span class="w"></span><span class="nt">podSecurityContext</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="ln">105</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">106</span><span class="cl"><span class="w"></span><span class="nt">rbac</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">107</span><span class="cl"><span class="w">  </span><span class="c"># Creates the pod security policy if set to true</span><span class="w">
</span></span></span><span class="line"><span class="ln">108</span><span class="cl"><span class="w">  </span><span class="nt">pspEnable</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span></code></pre></div><p>Now its time do deploy AKO</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">andreasm@ubuntu02:~/tkgi/cluster-1-antrea$ k create ns avi-system
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">namespace/avi-system created
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">andreasm@ubuntu02:~/tkgi/cluster-1-antrea$ helm install --generate-name oci://projects.registry.vmware.com/ako/helm-charts/ako --version 1.10.3 -f ako-values.1.10.3.yaml --namespace avi-system
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">Pulled: projects.registry.vmware.com/ako/helm-charts/ako:1.10.3
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">Digest: sha256:1f2f9b89f4166737ed0d0acf4ebfb5853fb6f67b08ca1c8dae48e1dd99d31ab6
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">NAME: ako-1701427075
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">LAST DEPLOYED: Fri Dec  <span class="m">1</span> 10:38:03 <span class="m">2023</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">NAMESPACE: avi-system
</span></span><span class="line"><span class="ln">10</span><span class="cl">STATUS: deployed
</span></span><span class="line"><span class="ln">11</span><span class="cl">REVISION: <span class="m">1</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">TEST SUITE: None
</span></span><span class="line"><span class="ln">13</span><span class="cl">
</span></span><span class="line"><span class="ln">14</span><span class="cl">andreasm@ubuntu02:~/tkgi/cluster-1-antrea$ k get ingressclasses.networking.k8s.io
</span></span><span class="line"><span class="ln">15</span><span class="cl">NAME     CONTROLLER              PARAMETERS   AGE
</span></span><span class="line"><span class="ln">16</span><span class="cl">avi-lb   ako.vmware.com/avi-lb   &lt;none&gt;       19s
</span></span><span class="line"><span class="ln">17</span><span class="cl">
</span></span><span class="line"><span class="ln">18</span><span class="cl">andreasm@ubuntu02:~/tkgi/cluster-1-antrea$ k get pods -n avi-system
</span></span><span class="line"><span class="ln">19</span><span class="cl">NAME    READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="ln">20</span><span class="cl">ako-0   1/1     Running   <span class="m">0</span>          36s
</span></span><span class="line"><span class="ln">21</span><span class="cl">
</span></span><span class="line"><span class="ln">22</span><span class="cl">andreasm@ubuntu02:~/tkgi/cluster-1-antrea$ k logs -n avi-system ako-0
</span></span><span class="line"><span class="ln">23</span><span class="cl">2023-12-01T10:38:15.457Z	INFO	api/api.go:52	Setting route <span class="k">for</span> GET /api/status
</span></span><span class="line"><span class="ln">24</span><span class="cl">2023-12-01T10:38:15.458Z	INFO	ako-main/main.go:72	AKO is running with version: v1.10.3
</span></span><span class="line"><span class="ln">25</span><span class="cl">2023-12-01T10:38:15.458Z	INFO	ako-main/main.go:82	We are running inside kubernetes cluster. Won<span class="s1">&#39;t use kubeconfig files.
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="s1">2023-12-01T10:38:15.458Z	INFO	api/api.go:110	Starting API server at :8080
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="s1">2023-12-01T10:38:15.540Z	INFO	ako-main/main.go:157	Kubernetes cluster apiserver version 1.27
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="s1">2023-12-01T10:38:15.551Z	INFO	utils/utils.go:168	Initializing configmap informer in avi-system
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="s1">2023-12-01T10:38:15.551Z	INFO	lib/dynamic_client.go:137	Skipped initializing dynamic informers for cniPlugin antrea
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="s1">2023-12-01T10:38:16.029Z	INFO	utils/avi_rest_utils.go:116	Overwriting the controller version 22.1.4 to max Avi version 22.1.3
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="s1">2023-12-01T10:38:16.030Z	INFO	utils/avi_rest_utils.go:119	Setting the client version to the current controller version 22.1.3
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="s1">2023-12-01T10:38:17.176Z	INFO	cache/controller_obj_cache.go:2345	Avi cluster state is CLUSTER_UP_NO_HA
</span></span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="s1">2023-12-01T10:38:17.337Z	INFO	cache/controller_obj_cache.go:3116	Setting cloud vType: CLOUD_NSXT
</span></span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="s1">2023-12-01T10:38:17.337Z	INFO	cache/controller_obj_cache.go:3119	Setting cloud uuid: cloud-b739e6b0-f0c8-4259-b36b-450d227c633c
</span></span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="s1">2023-12-01T10:38:17.337Z	INFO	lib/lib.go:291	Setting AKOUser: ako-tkgi-cluster-1-antrea for Avi Objects
</span></span></span><span class="line"><span class="ln">36</span><span class="cl"><span class="s1">2023-12-01T10:38:17.337Z	INFO	cache/controller_obj_cache.go:2855	Skipping the check for SE group labels
</span></span></span><span class="line"><span class="ln">37</span><span class="cl"><span class="s1">2023-12-01T10:38:17.337Z	INFO	cache/controller_obj_cache.go:3395	Skipping the check for Node Network
</span></span></span><span class="line"><span class="ln">38</span><span class="cl"><span class="s1">2023-12-01T10:38:17.442Z	INFO	cache/controller_obj_cache.go:3526	Setting VRF The-Tier-1 found from network vip-l4-incluster-tkgi
</span></span></span><span class="line"><span class="ln">39</span><span class="cl"><span class="s1">2023-12-01T10:38:17.443Z	INFO	record/event.go:282	Event(v1.ObjectReference{Kind:&#34;Pod&#34;, Namespace:&#34;avi-system&#34;, Name:&#34;ako-0&#34;, UID:&#34;3891605f-8d92-43ed-8b4f-a03b7bf3e0d4&#34;, APIVersion:&#34;v1&#34;, ResourceVersion:&#34;21070&#34;, FieldPath:&#34;&#34;}): type: &#39;</span>Normal<span class="s1">&#39; reason: &#39;</span>ValidatedUserInput<span class="err">&#39;</span> User input validation completed.
</span></span><span class="line"><span class="ln">40</span><span class="cl">2023-12-01T10:38:17.449Z	INFO	lib/lib.go:230	Setting Disable Sync to: <span class="nb">false</span>
</span></span><span class="line"><span class="ln">41</span><span class="cl">2023-12-01T10:38:17.456Z	INFO	k8s/ako_init.go:271	avi k8s configmap created
</span></span></code></pre></div><p>Thats it.. Now its time for some test applications. Exact same procedure as previous. The Yelb app and the Banana/Apple Ingress application. First out the L4 ServiceType Loadbalancer (Yelb).</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">andreasm@ubuntu02:~/tkgi$ k create ns yelb
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">namespace/yelb created
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">andreasm@ubuntu02:~/tkgi$ <span class="nb">cd</span> examples/
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">andreasm@ubuntu02:~/tkgi/examples$ k apply -f yelb-lb-backend.yaml
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">service/redis-server created
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">service/yelb-db created
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">service/yelb-appserver created
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">deployment.apps/redis-server created
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">deployment.apps/yelb-db created
</span></span><span class="line"><span class="ln">10</span><span class="cl">deployment.apps/yelb-appserver created
</span></span></code></pre></div><p>Waiting for them to be downloaded and started, then the frontend and I should get an service in NSX ALB created for me.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">andreasm@ubuntu02:~/tkgi/examples$ k get pods -n yelb
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">NAME                             READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">redis-server-6cf478df95-t96fn    1/1     Running   <span class="m">0</span>          48s
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">yelb-appserver-bf75dbb5b-vdrr5   1/1     Running   <span class="m">0</span>          48s
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">yelb-db-d4c64d9c-mmfbz           1/1     Running   <span class="m">0</span>          48s
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">andreasm@ubuntu02:~/tkgi/examples$ k apply -f yelb-lb-frontend
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">yelb-lb-frontend-w-lb.class.yaml  yelb-lb-frontend.yaml
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">andreasm@ubuntu02:~/tkgi/examples$ k apply -f yelb-lb-frontend.yaml
</span></span><span class="line"><span class="ln">10</span><span class="cl">service/yelb-ui created
</span></span><span class="line"><span class="ln">11</span><span class="cl">deployment.apps/yelb-ui created
</span></span><span class="line"><span class="ln">12</span><span class="cl">andreasm@ubuntu02:~/tkgi/examples$ k get svc -n yelb
</span></span><span class="line"><span class="ln">13</span><span class="cl">NAME             TYPE           CLUSTER-IP      EXTERNAL-IP      PORT<span class="o">(</span>S<span class="o">)</span>        AGE
</span></span><span class="line"><span class="ln">14</span><span class="cl">redis-server     ClusterIP      10.20.99.56     &lt;none&gt;           6379/TCP       93s
</span></span><span class="line"><span class="ln">15</span><span class="cl">yelb-appserver   ClusterIP      10.20.190.198   &lt;none&gt;           4567/TCP       93s
</span></span><span class="line"><span class="ln">16</span><span class="cl">yelb-db          ClusterIP      10.20.241.6     &lt;none&gt;           5432/TCP       93s
</span></span><span class="line"><span class="ln">17</span><span class="cl">yelb-ui          LoadBalancer   10.20.150.139   10.146.102.100   80:32498/TCP   4s
</span></span></code></pre></div><p>Anything in NSX ALB?</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="yelb"
      
        class="image_figure image_internal image_processed"
        width="2518"
        height="1418"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231201114252482.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Yes it is, does it work?</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="ln"> 1</span><span class="cl">andreasm@ubuntu02:~/tkgi/examples$ curl yelb-ui-yelb.this-is-a.domain.net
</span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="cp">&lt;!doctype html&gt;</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">charset</span><span class="o">=</span><span class="s">&#34;utf-8&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">    <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>Yelb<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">    <span class="p">&lt;</span><span class="nt">base</span> <span class="na">href</span><span class="o">=</span><span class="s">&#34;/&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">name</span><span class="o">=</span><span class="s">&#34;viewport&#34;</span> <span class="na">content</span><span class="o">=</span><span class="s">&#34;width=device-width, initial-scale=1&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">    <span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">&#34;icon&#34;</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;image/x-icon&#34;</span> <span class="na">href</span><span class="o">=</span><span class="s">&#34;favicon.ico?v=2&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="p">&lt;</span><span class="nt">yelb</span><span class="p">&gt;</span>Loading...<span class="p">&lt;/</span><span class="nt">yelb</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;text/javascript&#34;</span> <span class="na">src</span><span class="o">=</span><span class="s">&#34;inline.bundle.js&#34;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;text/javascript&#34;</span> <span class="na">src</span><span class="o">=</span><span class="s">&#34;styles.bundle.js&#34;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;text/javascript&#34;</span> <span class="na">src</span><span class="o">=</span><span class="s">&#34;scripts.bundle.js&#34;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;text/javascript&#34;</span> <span class="na">src</span><span class="o">=</span><span class="s">&#34;vendor.bundle.js&#34;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;text/javascript&#34;</span> <span class="na">src</span><span class="o">=</span><span class="s">&#34;main.bundle.js&#34;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</span></span></code></pre></div><p>Yes it does. Now the last step is an Ingress.</p>
<p>Same procedure as previous there also.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">andreasm@ubuntu02:~/tkgi/examples$ k create ns fruit
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">namespace/fruit created
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">andreasm@ubuntu02:~/tkgi/examples$ k apply  -f apple.yaml -f banana.yaml
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">pod/apple-app created
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">service/apple-service created
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">pod/banana-app created
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">service/banana-service created
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">andreasm@ubuntu02:~/tkgi/examples$ k get svc -n fruit
</span></span><span class="line"><span class="ln">10</span><span class="cl">NAME             TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>    AGE
</span></span><span class="line"><span class="ln">11</span><span class="cl">apple-service    ClusterIP   10.20.143.112   &lt;none&gt;        5678/TCP   21s
</span></span><span class="line"><span class="ln">12</span><span class="cl">banana-service   ClusterIP   10.20.184.169   &lt;none&gt;        5678/TCP   21s
</span></span></code></pre></div><p>Now the Ingress</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@ubuntu02:~/tkgi/examples$ k apply -f ingress-example-generic.yaml
</span></span><span class="line"><span class="ln">2</span><span class="cl">ingress.networking.k8s.io/ingress-example created
</span></span><span class="line"><span class="ln">3</span><span class="cl">andreasm@ubuntu02:~/tkgi/examples$ k get ingress -n fruit
</span></span><span class="line"><span class="ln">4</span><span class="cl">NAME              CLASS    HOSTS                             ADDRESS          PORTS   AGE
</span></span><span class="line"><span class="ln">5</span><span class="cl">ingress-example   avi-lb   fruit-tkgi.this-is-a.domain.net   10.146.102.102   <span class="m">80</span>      5s
</span></span></code></pre></div><p>Anything in NSX-ALB?</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="ingress"
      
        class="image_figure image_internal image_processed"
        width="2788"
        height="1616"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231201114648451.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Yes it is, notice even the ports and the backend IPs.. It is using NodeportLocal and pointing to the nodes holding the pods apple and banana.</p>
<p>Does it work?</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@ubuntu02:~/tkgi/examples$ curl fruit-tkgi.this-is-a.domain.net/banana
</span></span><span class="line"><span class="ln">2</span><span class="cl">banana
</span></span><span class="line"><span class="ln">3</span><span class="cl">andreasm@ubuntu02:~/tkgi/examples$ curl fruit-tkgi.this-is-a.domain.net/apple
</span></span><span class="line"><span class="ln">4</span><span class="cl">apple
</span></span></code></pre></div><p>Yes it does. This concludes this excercise. Continue for the closout section...</p>
<h2 id="a-note-on-the-vip">A note on the VIP</h2>
<p>A often get the question on how the VIP is being realized. In NSX ALB we can configure the VIP to arp'ed (in lack of other words) in the same network as the SEs dataplane nic. Or it can be something completely different. It is the SEs that are responsible of &quot;advertising&quot; the VIP for a VS. So one way or the other the network overall needs to know where this VIP is coming from.
The simplest method (if not having the benefit of using NSX) is advertising the VIP inside the same network as the SE dataplane network. That means the VIP will be part of the same subnet as the SEs actual dataplane ip. This dont require any routes configured in the the network as the VIP will be arp'ed by the responsible SEs in that same network using the same subnet.</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="se-data-vip"
      
        class="image_figure image_internal image_processed"
        width="1572"
        height="777"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231127204237154.png"
      
      
    />

    </picture>
</figure>
</p>
<p>But what if one does not want to use the same network as the SE dataplane network. Well, that can be done also. But then we suddenly need to consider how to advertise this VIP. It can be done using a specific nic on the SE only used for VIPs (this also consumes the available nics on the SEs) or it can be used by just creating a VIP address and advertise/inform the network where it comes from and how to reach it. This approach is what I have been using in this whole post. I will quickly explain how this can be done with NSX ALB configured with a NSX-T cloud. Very basic explained. This way I will configure the SEs with min 2 nics. One for the management, to NSX ALB controller connectivity, and one as a dedicated dataplane nic. When I create a VIP IP profile in NSX-ALB I can create Virtual Services to use these VIP IP profiles as ip addresses for my VS VIPs. The benefit of using a NSX cloud here is that Avi will automatically inject static routes on the Tier-1 router to announce where this VIP comes from, where the static route is a host route /32 pointng to the SEs that are realising the VIP. So the Tier will advertise this to the Tier-0 (if confiugured in NSX to do so) and the Tier-0 will further advertise it to its BGP peer and out in the &quot;wild&quot; (physical network).</p>
<p>If not using NSX, Avi also supports BGP natively and can advertise the vips on its own. Meaning the SEs needs to be confgured to peer with BGP neighbours or one can use static routes. In terms of redundancy, availability BGP is the preferred method.</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="bgp in avi"
      
        class="image_figure image_internal image_processed"
        width="1487"
        height="1071"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231201115813298.png"
      
      
    />

    </picture>
</figure>
</p>
<p>A diagram using NSX cloud and VIPs not tied to any SE nic or network, but a VIP true to its name (Virtual IP).</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="vip-static-routes"
      
        class="image_figure image_internal image_processed"
        width="2100"
        height="1098"
        src="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/images/image-20231201121006110.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Thats it for me..</p>
<p>Lets see what I will write about the next time. Something completely different maybe... who knows what the future might bring.</p>

    </div>




  </article>
<aside class="sidebar">
  <section class="sidebar_inner">
    <br>
    
  
  <div class="search">
    <input type="search" class="search_field form_field" placeholder='Search...' id="find" autocomplete="off" data-scope='post'>
    <label for="find" class="search_label"><svg class="icon">
  <title>search</title>
  <use xlink:href="#search"></use>
</svg>

    </label>
    
    <div class="search_results results"></div>
  </div>

        <h2>Hi there</h2>
      <div class="author_bio">
        This blog is a WIP, sometimes I just throw up some topics for myself to remember to be finished later. Stay tuned...
      </div>
      <a href='https://blog.andreasm.io/about/' class="button mt-1" role="button" title='Read More'>Read More</a>

    
    
    <h2 class="mt-4">Recent Posts</h2>
    <ul class="flex-column">
      <li>
        <a href="https://blog.andreasm.io/2024/02/04/argo-cd-vsphere-with-tanzu/" class="nav-link" title="Argo CD &amp; vSphere with Tanzu">Argo CD &amp; vSphere with Tanzu</a>
      </li>
      <li>
        <a href="https://blog.andreasm.io/2024/01/15/proxmox-with-opentofu-kubespray-and-kubernetes/" class="nav-link" title="Proxmox with OpenTofu Kubespray and Kubernetes">Proxmox with OpenTofu Kubespray and Kubernetes</a>
      </li>
      <li>
        <a href="https://blog.andreasm.io/2023/12/26/traefik-proxy-in-kubernetes/" class="nav-link" title="Traefik Proxy in Kubernetes">Traefik Proxy in Kubernetes</a>
      </li>
      <li>
        <a href="https://blog.andreasm.io/2023/12/18/a-quick-glance-at-cilium-cni/" class="nav-link" title="A Quick Glance at Cilium CNI">A Quick Glance at Cilium CNI</a>
      </li>
      <li>
        <a href="https://blog.andreasm.io/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/" class="nav-link" title="TKGi with NSX and NSX Advanced LoadBalancer">TKGi with NSX and NSX Advanced LoadBalancer</a>
      </li>
      <li>
        <a href="https://blog.andreasm.io/2023/09/25/antrea-multi-cluster-in-tkg-and-vsphere-with-tanzu/" class="nav-link" title="Antrea Multi-cluster - in TKG and vSphere with Tanzu">Antrea Multi-cluster - in TKG and vSphere with Tanzu</a>
      </li>
      <li>
        <a href="https://blog.andreasm.io/2023/09/23/vsphere-with-tanzu-8-u2-using-nsx-and-nsx-advanced-loadbalancer/" class="nav-link" title="vSphere with Tanzu 8 U2 using NSX AND NSX Advanced Loadbalancer">vSphere with Tanzu 8 U2 using NSX AND NSX Advanced Loadbalancer</a>
      </li>
      <li>
        <a href="https://blog.andreasm.io/2023/09/19/vsphere-with-tanzu-and-haproxy/" class="nav-link" title="vSphere with Tanzu and HAproxy">vSphere with Tanzu and HAproxy</a>
      </li>
    </ul>
    <div>
      <h2 class="mt-4 taxonomy" id="categories-section">Categories</h2>
      <nav class="tags_nav">
        <a href='https://blog.andreasm.io/categories/kubernetes/' class="post_tag button button_translucent" title="kubernetes">
          KUBERNETES
          <span class="button_tally">39</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/networking/' class="post_tag button button_translucent" title="networking">
          NETWORKING
          <span class="button_tally">20</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/tanzu/' class="post_tag button button_translucent" title="tanzu">
          TANZU
          <span class="button_tally">12</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/loadbalancing/' class="post_tag button button_translucent" title="loadbalancing">
          LOADBALANCING
          <span class="button_tally">9</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/cni/' class="post_tag button button_translucent" title="cni">
          CNI
          <span class="button_tally">8</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/security/' class="post_tag button button_translucent" title="security">
          SECURITY
          <span class="button_tally">6</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/avi/' class="post_tag button button_translucent" title="avi">
          AVI
          <span class="button_tally">5</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/nsx/' class="post_tag button button_translucent" title="nsx">
          NSX
          <span class="button_tally">4</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/antrea/' class="post_tag button button_translucent" title="antrea">
          ANTREA
          <span class="button_tally">3</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/automation/' class="post_tag button button_translucent" title="automation">
          AUTOMATION
          <span class="button_tally">2</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/blog/' class="post_tag button button_translucent" title="blog">
          BLOG
          <span class="button_tally">2</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/monitoring/' class="post_tag button button_translucent" title="monitoring">
          MONITORING
          <span class="button_tally">2</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/network/' class="post_tag button button_translucent" title="network">
          NETWORK
          <span class="button_tally">2</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/vmware-nsx/' class="post_tag button button_translucent" title="vmware-nsx">
          VMWARE-NSX
          <span class="button_tally">2</span>
        </a>
        
        
        <br>
        <div class="post_tags_toggle button">All Categories</div>
        <div class="post_tags">
          <div class="tags_list">
            
            <a href='https://blog.andreasm.io/categories/antrea/' class=" post_tag button button_translucent" data-position=3 title="antrea">ANTREA<span class="button_tally">3</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/argocd/' class=" post_tag button button_translucent" data-position=1 title="argocd">ARGOCD<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/automation/' class=" post_tag button button_translucent" data-position=2 title="automation">AUTOMATION<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/autoscaling/' class=" post_tag button button_translucent" data-position=1 title="autoscaling">AUTOSCALING<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/avi/' class=" post_tag button button_translucent" data-position=5 title="avi">AVI<span class="button_tally">5</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/blog/' class=" post_tag button button_translucent" data-position=2 title="blog">BLOG<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/certificate/' class=" post_tag button button_translucent" data-position=1 title="certificate">CERTIFICATE<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/cni/' class=" post_tag button button_translucent" data-position=8 title="cni">CNI<span class="button_tally">8</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/docker/' class=" post_tag button button_translucent" data-position=1 title="docker">DOCKER<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/ebpf/' class=" post_tag button button_translucent" data-position=1 title="ebpf">EBPF<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/github/' class=" post_tag button button_translucent" data-position=1 title="github">GITHUB<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/gitops/' class=" post_tag button button_translucent" data-position=1 title="gitops">GITOPS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/harbor/' class=" post_tag button button_translucent" data-position=1 title="harbor">HARBOR<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/helm/' class=" post_tag button button_translucent" data-position=1 title="helm">HELM<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/home-automation/' class=" post_tag button button_translucent" data-position=1 title="home-automation">HOME-AUTOMATION<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/hugo/' class=" post_tag button button_translucent" data-position=1 title="hugo">HUGO<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/ingress/' class=" post_tag button button_translucent" data-position=1 title="ingress">INGRESS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/kubernetes/' class=" post_tag button button_translucent" data-position=39 title="kubernetes">KUBERNETES<span class="button_tally">39</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/lcm/' class=" post_tag button button_translucent" data-position=1 title="lcm">LCM<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/lifecycle-management/' class=" post_tag button button_translucent" data-position=1 title="lifecycle-management">LIFECYCLE-MANAGEMENT<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/loadbalancing/' class=" post_tag button button_translucent" data-position=9 title="loadbalancing">LOADBALANCING<span class="button_tally">9</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/logging/' class=" post_tag button button_translucent" data-position=1 title="logging">LOGGING<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/management/' class=" post_tag button button_translucent" data-position=1 title="management">MANAGEMENT<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/monitoring/' class=" post_tag button button_translucent" data-position=2 title="monitoring">MONITORING<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/netowkring/' class=" post_tag button button_translucent" data-position=1 title="netowkring">NETOWKRING<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/network/' class=" post_tag button button_translucent" data-position=2 title="network">NETWORK<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/networking/' class=" post_tag button button_translucent" data-position=20 title="networking">NETWORKING<span class="button_tally">20</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/nsx/' class=" post_tag button button_translucent" data-position=4 title="nsx">NSX<span class="button_tally">4</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/nsx-alb/' class=" post_tag button button_translucent" data-position=1 title="nsx-alb">NSX-ALB<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/nsx-t/' class=" post_tag button button_translucent" data-position=1 title="nsx-t">NSX-T<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/pinniped/' class=" post_tag button button_translucent" data-position=1 title="pinniped">PINNIPED<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/rbac/' class=" post_tag button button_translucent" data-position=1 title="rbac">RBAC<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/security/' class=" post_tag button button_translucent" data-position=6 title="security">SECURITY<span class="button_tally">6</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/storage/' class=" post_tag button button_translucent" data-position=1 title="storage">STORAGE<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/tanzu/' class=" post_tag button button_translucent" data-position=12 title="tanzu">TANZU<span class="button_tally">12</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/tanzu-mission-control/' class=" post_tag button button_translucent" data-position=1 title="tanzu-mission-control">TANZU-MISSION-CONTROL<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/tkg/' class=" post_tag button button_translucent" data-position=1 title="tkg">TKG<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/tkgi/' class=" post_tag button button_translucent" data-position=1 title="tkgi">TKGI<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/tmc/' class=" post_tag button button_translucent" data-position=1 title="tmc">TMC<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/troubleshooting/' class=" post_tag button button_translucent" data-position=1 title="troubleshooting">TROUBLESHOOTING<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/virtualization/' class=" post_tag button button_translucent" data-position=1 title="virtualization">VIRTUALIZATION<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/vmare-nsx-intelligence/' class=" post_tag button button_translucent" data-position=1 title="vmare-nsx-intelligence">VMARE-NSX-INTELLIGENCE<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/vmware-cloud/' class=" post_tag button button_translucent" data-position=1 title="vmware-cloud">VMWARE-CLOUD<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/vmware-nsx/' class=" post_tag button button_translucent" data-position=2 title="vmware-nsx">VMWARE-NSX<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/vsphere/' class=" post_tag button button_translucent" data-position=1 title="vsphere">VSPHERE<span class="button_tally">1</span>
            </a>
            
            <div class="tags_sort"><span title="sort alphabetically">[A~Z]</span><span title="sort by count">[0~9]</span>
            </div>
            <span class="tags_hide"><svg class="icon">
            <use xlink:href="#closeme"></use>
          </svg></span>
          </div>
        </div>
      </nav>
    </div>
    <div>
      <h2 class="mt-4 taxonomy" id="tags-section">Tags</h2>
      <nav class="tags_nav">
        <a href='https://blog.andreasm.io/tags/kubernetes/' class="post_tag button button_translucent" title="kubernetes">
          KUBERNETES
          <span class="button_tally">21</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/tanzu/' class="post_tag button button_translucent" title="tanzu">
          TANZU
          <span class="button_tally">14</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/nsx/' class="post_tag button button_translucent" title="nsx">
          NSX
          <span class="button_tally">12</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/antrea/' class="post_tag button button_translucent" title="antrea">
          ANTREA
          <span class="button_tally">11</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/ako/' class="post_tag button button_translucent" title="ako">
          AKO
          <span class="button_tally">8</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/avi/' class="post_tag button button_translucent" title="avi">
          AVI
          <span class="button_tally">6</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/loadbalancing/' class="post_tag button button_translucent" title="loadbalancing">
          LOADBALANCING
          <span class="button_tally">6</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/security/' class="post_tag button button_translucent" title="security">
          SECURITY
          <span class="button_tally">6</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/ingress/' class="post_tag button button_translucent" title="ingress">
          INGRESS
          <span class="button_tally">5</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/availability/' class="post_tag button button_translucent" title="availability">
          AVAILABILITY
          <span class="button_tally">3</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/cert-manager/' class="post_tag button button_translucent" title="cert-manager">
          CERT-MANAGER
          <span class="button_tally">3</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/cni/' class="post_tag button button_translucent" title="cni">
          CNI
          <span class="button_tally">3</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/network/' class="post_tag button button_translucent" title="network">
          NETWORK
          <span class="button_tally">3</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/authentication/' class="post_tag button button_translucent" title="authentication">
          AUTHENTICATION
          <span class="button_tally">2</span>
        </a>
        
        
        <br>
        <div class="post_tags_toggle button">All Tags</div>
        <div class="post_tags">
          <div class="tags_list">
            
            <a href='https://blog.andreasm.io/tags/ako/' class=" post_tag button button_translucent" data-position=8 title="ako">AKO<span class="button_tally">8</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/amko/' class=" post_tag button button_translucent" data-position=1 title="amko">AMKO<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/ansible/' class=" post_tag button button_translucent" data-position=1 title="ansible">ANSIBLE<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/antrea/' class=" post_tag button button_translucent" data-position=11 title="antrea">ANTREA<span class="button_tally">11</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/argocd/' class=" post_tag button button_translucent" data-position=1 title="argocd">ARGOCD<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/authentication/' class=" post_tag button button_translucent" data-position=2 title="authentication">AUTHENTICATION<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/automation/' class=" post_tag button button_translucent" data-position=1 title="automation">AUTOMATION<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/autoscaling/' class=" post_tag button button_translucent" data-position=1 title="autoscaling">AUTOSCALING<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/availability/' class=" post_tag button button_translucent" data-position=3 title="availability">AVAILABILITY<span class="button_tally">3</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/avi/' class=" post_tag button button_translucent" data-position=6 title="avi">AVI<span class="button_tally">6</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/cert-manager/' class=" post_tag button button_translucent" data-position=3 title="cert-manager">CERT-MANAGER<span class="button_tally">3</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/certificate/' class=" post_tag button button_translucent" data-position=1 title="certificate">CERTIFICATE<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/cilium/' class=" post_tag button button_translucent" data-position=1 title="cilium">CILIUM<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/cni/' class=" post_tag button button_translucent" data-position=3 title="cni">CNI<span class="button_tally">3</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/custom-resource-definitions/' class=" post_tag button button_translucent" data-position=1 title="custom-resource-definitions">CUSTOM-RESOURCE-DEFINITIONS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/distributed-firewall/' class=" post_tag button button_translucent" data-position=1 title="distributed-firewall">DISTRIBUTED-FIREWALL<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/dns-service/' class=" post_tag button button_translucent" data-position=1 title="dns-service">DNS-SERVICE<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/docker/' class=" post_tag button button_translucent" data-position=2 title="docker">DOCKER<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/ebpf/' class=" post_tag button button_translucent" data-position=1 title="ebpf">EBPF<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/github/' class=" post_tag button button_translucent" data-position=1 title="github">GITHUB<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/gitops/' class=" post_tag button button_translucent" data-position=1 title="gitops">GITOPS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/grafana/' class=" post_tag button button_translucent" data-position=1 title="grafana">GRAFANA<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/gslb/' class=" post_tag button button_translucent" data-position=1 title="gslb">GSLB<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/harbor/' class=" post_tag button button_translucent" data-position=1 title="harbor">HARBOR<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/home-assistant/' class=" post_tag button button_translucent" data-position=1 title="home-assistant">HOME-ASSISTANT<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/hugo/' class=" post_tag button button_translucent" data-position=2 title="hugo">HUGO<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/ids/' class=" post_tag button button_translucent" data-position=1 title="ids">IDS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/informational/' class=" post_tag button button_translucent" data-position=2 title="informational">INFORMATIONAL<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/ingress/' class=" post_tag button button_translucent" data-position=5 title="ingress">INGRESS<span class="button_tally">5</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/ips/' class=" post_tag button button_translucent" data-position=1 title="ips">IPS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/keycloak/' class=" post_tag button button_translucent" data-position=1 title="keycloak">KEYCLOAK<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/kubernetes/' class=" post_tag button button_translucent" data-position=21 title="kubernetes">KUBERNETES<span class="button_tally">21</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/kubernetes-api-endpoint/' class=" post_tag button button_translucent" data-position=1 title="kubernetes-api-endpoint">KUBERNETES-API-ENDPOINT<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/kubespray/' class=" post_tag button button_translucent" data-position=1 title="kubespray">KUBESPRAY<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/lifecycle-management/' class=" post_tag button button_translucent" data-position=1 title="lifecycle-management">LIFECYCLE-MANAGEMENT<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/load-balancing/' class=" post_tag button button_translucent" data-position=1 title="load-balancing">LOAD-BALANCING<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/loadbalancer/' class=" post_tag button button_translucent" data-position=1 title="loadbalancer">LOADBALANCER<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/loadbalancing/' class=" post_tag button button_translucent" data-position=6 title="loadbalancing">LOADBALANCING<span class="button_tally">6</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/lodbalancing/' class=" post_tag button button_translucent" data-position=1 title="lodbalancing">LODBALANCING<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/loki/' class=" post_tag button button_translucent" data-position=1 title="loki">LOKI<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/management/' class=" post_tag button button_translucent" data-position=1 title="management">MANAGEMENT<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/multi-cluster/' class=" post_tag button button_translucent" data-position=1 title="multi-cluster">MULTI-CLUSTER<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/multi-dc/' class=" post_tag button button_translucent" data-position=1 title="multi-dc">MULTI-DC<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/network/' class=" post_tag button button_translucent" data-position=3 title="network">NETWORK<span class="button_tally">3</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/network-policies/' class=" post_tag button button_translucent" data-position=2 title="network-policies">NETWORK-POLICIES<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/networking/' class=" post_tag button button_translucent" data-position=2 title="networking">NETWORKING<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/nfs/' class=" post_tag button button_translucent" data-position=1 title="nfs">NFS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/nsx/' class=" post_tag button button_translucent" data-position=12 title="nsx">NSX<span class="button_tally">12</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/nsx-advanced-loadbalancer/' class=" post_tag button button_translucent" data-position=1 title="nsx-advanced-loadbalancer">NSX-ADVANCED-LOADBALANCER<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/nsx-alb/' class=" post_tag button button_translucent" data-position=1 title="nsx-alb">NSX-ALB<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/nsx-application-platform/' class=" post_tag button button_translucent" data-position=1 title="nsx-application-platform">NSX-APPLICATION-PLATFORM<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/nsx-t/' class=" post_tag button button_translucent" data-position=2 title="nsx-t">NSX-T<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/opentofu/' class=" post_tag button button_translucent" data-position=1 title="opentofu">OPENTOFU<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/persistent-storage/' class=" post_tag button button_translucent" data-position=1 title="persistent-storage">PERSISTENT-STORAGE<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/pinniped/' class=" post_tag button button_translucent" data-position=1 title="pinniped">PINNIPED<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/prometheus/' class=" post_tag button button_translucent" data-position=1 title="prometheus">PROMETHEUS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/promtail/' class=" post_tag button button_translucent" data-position=1 title="promtail">PROMTAIL<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/proxmox/' class=" post_tag button button_translucent" data-position=1 title="proxmox">PROXMOX<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/proxy/' class=" post_tag button button_translucent" data-position=1 title="proxy">PROXY<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/pvc/' class=" post_tag button button_translucent" data-position=1 title="pvc">PVC<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/rbac/' class=" post_tag button button_translucent" data-position=1 title="rbac">RBAC<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/registry/' class=" post_tag button button_translucent" data-position=1 title="registry">REGISTRY<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/security/' class=" post_tag button button_translucent" data-position=6 title="security">SECURITY<span class="button_tally">6</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/static-content-generator/' class=" post_tag button button_translucent" data-position=1 title="static-content-generator">STATIC-CONTENT-GENERATOR<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/static-site-generator/' class=" post_tag button button_translucent" data-position=1 title="static-site-generator">STATIC-SITE-GENERATOR<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/tanzu/' class=" post_tag button button_translucent" data-position=14 title="tanzu">TANZU<span class="button_tally">14</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/tanzu-kubernetes-grid/' class=" post_tag button button_translucent" data-position=1 title="tanzu-kubernetes-grid">TANZU-KUBERNETES-GRID<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/terraform/' class=" post_tag button button_translucent" data-position=1 title="terraform">TERRAFORM<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/tkg/' class=" post_tag button button_translucent" data-position=1 title="tkg">TKG<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/tkg-2.1/' class=" post_tag button button_translucent" data-position=1 title="tkg-2.1">TKG-2.1<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/tkgi/' class=" post_tag button button_translucent" data-position=1 title="tkgi">TKGI<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/tkgs/' class=" post_tag button button_translucent" data-position=1 title="tkgs">TKGS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/tmc/' class=" post_tag button button_translucent" data-position=1 title="tmc">TMC<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/tmc-local/' class=" post_tag button button_translucent" data-position=1 title="tmc-local">TMC-LOCAL<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/tmc-sm/' class=" post_tag button button_translucent" data-position=1 title="tmc-sm">TMC-SM<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/traefik/' class=" post_tag button button_translucent" data-position=1 title="traefik">TRAEFIK<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/troubleshooting/' class=" post_tag button button_translucent" data-position=2 title="troubleshooting">TROUBLESHOOTING<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/unifi/' class=" post_tag button button_translucent" data-position=1 title="unifi">UNIFI<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/vmconaws/' class=" post_tag button button_translucent" data-position=1 title="vmconaws">VMCONAWS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/vsphere/' class=" post_tag button button_translucent" data-position=2 title="vsphere">VSPHERE<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/vsphere-replication/' class=" post_tag button button_translucent" data-position=1 title="vsphere-replication">VSPHERE-REPLICATION<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/vsphere-with-tanzu/' class=" post_tag button button_translucent" data-position=1 title="vsphere-with-tanzu">VSPHERE-WITH-TANZU<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/zwave/' class=" post_tag button button_translucent" data-position=1 title="zwave">ZWAVE<span class="button_tally">1</span>
            </a>
            
            <div class="tags_sort"><span title="sort alphabetically">[A~Z]</span><span title="sort by count">[0~9]</span>
            </div>
            <span class="tags_hide"><svg class="icon">
            <use xlink:href="#closeme"></use>
          </svg></span>
          </div>
        </div>
      </nav>
    </div>
  </section>
</aside>

  
</div>
    </main><svg width="0" height="0" class="hidden">
  <symbol viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" id="facebook">
    <path d="M437 0H75C33.648 0 0 33.648 0 75v362c0 41.352 33.648 75 75 75h151V331h-60v-90h60v-61c0-49.629 40.371-90 90-90h91v90h-91v61h91l-15 90h-76v181h121c41.352 0 75-33.648 75-75V75c0-41.352-33.648-75-75-75zm0 0"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18.001 18.001" id="twitter">
    <path d="M15.891 4.013c.808-.496 1.343-1.173 1.605-2.034a8.68 8.68 0 0 1-2.351.861c-.703-.756-1.593-1.14-2.66-1.14-1.043 0-1.924.366-2.643 1.078a3.56 3.56 0 0 0-1.076 2.605c0 .309.039.585.117.819-3.076-.105-5.622-1.381-7.628-3.837-.34.601-.51 1.213-.51 1.846 0 1.301.549 2.332 1.645 3.089-.625-.053-1.176-.211-1.645-.47 0 .929.273 1.705.82 2.388a3.623 3.623 0 0 0 2.115 1.291c-.312.08-.641.118-.979.118-.312 0-.533-.026-.664-.083.23.757.664 1.371 1.291 1.841a3.652 3.652 0 0 0 2.152.743C4.148 14.173 2.625 14.69.902 14.69c-.422 0-.721-.006-.902-.038 1.697 1.102 3.586 1.649 5.676 1.649 2.139 0 4.029-.542 5.674-1.626 1.645-1.078 2.859-2.408 3.639-3.974a10.77 10.77 0 0 0 1.172-4.892v-.468a7.788 7.788 0 0 0 1.84-1.921 8.142 8.142 0 0 1-2.11.593z"
      ></path>
  </symbol>
  <symbol aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id="mail">
    <path  d="M502.3 190.8c3.9-3.1 9.7-.2 9.7 4.7V400c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V195.6c0-5 5.7-7.8 9.7-4.7 22.4 17.4 52.1 39.5 154.1 113.6 21.1 15.4 56.7 47.8 92.2 47.6 35.7.3 72-32.8 92.3-47.6 102-74.1 131.6-96.3 154-113.7zM256 320c23.2.4 56.6-29.2 73.4-41.4 132.7-96.3 142.8-104.7 173.4-128.7 5.8-4.5 9.2-11.5 9.2-18.9v-19c0-26.5-21.5-48-48-48H48C21.5 64 0 85.5 0 112v19c0 7.4 3.4 14.3 9.2 18.9 30.6 23.9 40.7 32.4 173.4 128.7 16.8 12.2 50.2 41.8 73.4 41.4z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id="calendar">
    <path d="M452 40h-24V0h-40v40H124V0H84v40H60C26.916 40 0 66.916 0 100v352c0 33.084 26.916 60 60 60h392c33.084 0 60-26.916 60-60V100c0-33.084-26.916-60-60-60zm20 412c0 11.028-8.972 20-20 20H60c-11.028 0-20-8.972-20-20V188h432v264zm0-304H40v-48c0-11.028 8.972-20 20-20h24v40h40V80h264v40h40V80h24c11.028 0 20 8.972 20 20v48z"></path>
    <path d="M76 230h40v40H76zm80 0h40v40h-40zm80 0h40v40h-40zm80 0h40v40h-40zm80 0h40v40h-40zM76 310h40v40H76zm80 0h40v40h-40zm80 0h40v40h-40zm80 0h40v40h-40zM76 390h40v40H76zm80 0h40v40h-40zm80 0h40v40h-40zm80 0h40v40h-40zm80-80h40v40h-40z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id="github">
    <path d="M255.968 5.329C114.624 5.329 0 120.401 0 262.353c0 113.536 73.344 209.856 175.104 243.872 12.8 2.368 17.472-5.568 17.472-12.384 0-6.112-.224-22.272-.352-43.712-71.2 15.52-86.24-34.464-86.24-34.464-11.616-29.696-28.416-37.6-28.416-37.6-23.264-15.936 1.728-15.616 1.728-15.616 25.696 1.824 39.2 26.496 39.2 26.496 22.848 39.264 59.936 27.936 74.528 21.344 2.304-16.608 8.928-27.936 16.256-34.368-56.832-6.496-116.608-28.544-116.608-127.008 0-28.064 9.984-51.008 26.368-68.992-2.656-6.496-11.424-32.64 2.496-68 0 0 21.504-6.912 70.4 26.336 20.416-5.696 42.304-8.544 64.096-8.64 21.728.128 43.648 2.944 64.096 8.672 48.864-33.248 70.336-26.336 70.336-26.336 13.952 35.392 5.184 61.504 2.56 68 16.416 17.984 26.304 40.928 26.304 68.992 0 98.72-59.84 120.448-116.864 126.816 9.184 7.936 17.376 23.616 17.376 47.584 0 34.368-.32 62.08-.32 70.496 0 6.88 4.608 14.88 17.6 12.352C438.72 472.145 512 375.857 512 262.353 512 120.401 397.376 5.329 255.968 5.329z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 212 212" id="gitlab">
    <path d="M12.3 74.7h54L43.3 3c-1-3.6-6.4-3.6-7.6 0L12.3 74.8z" />
    <path d="M12.3 74.7L.5 111c-1 3.2 0 6.8 3 8.8l101.6 74-92.5-119z"/>
    <path d="M105 193.7l-38.6-119h-54l92.7 119z"/>
    <path d="M105 193.7l38.7-119H66.4l38.7 119z"/>
    <path d="M105 193.7l38.7-119H198l-93 119z"/>
    <path d="M198 74.7l11.6 36.2c1 3 0 6.6-3 8.6l-101.5 74 93-119z"/>
    <path d="M198 74.7h-54.3L167 3c1.2-3.6 6.4-3.6 7.6 0L198 74.8z"/> 
  </symbol>
  <symbol viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" id="rss">
    <circle cx="3.429" cy="20.571" r="3.429"></circle>
    <path d="M11.429 24h4.57C15.999 15.179 8.821 8.001 0 8v4.572c6.302.001 11.429 5.126 11.429 11.428z"></path>
    <path d="M24 24C24 10.766 13.234 0 0 0v4.571c10.714 0 19.43 8.714 19.43 19.429z"></path>
  </symbol>
  <symbol viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" id="linkedin">
    <path d="M437 0H75C33.648 0 0 33.648 0 75v362c0 41.352 33.648 75 75 75h362c41.352 0 75-33.648 75-75V75c0-41.352-33.648-75-75-75zM181 406h-60V196h60zm0-240h-60v-60h60zm210 240h-60V286c0-16.54-13.46-30-30-30s-30 13.46-30 30v120h-60V196h60v11.309C286.719 202.422 296.93 196 316 196c40.691.043 75 36.547 75 79.688zm0 0"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 612 612" id="to-top">
    <path d="M604.501 440.509L325.398 134.956c-5.331-5.357-12.423-7.627-19.386-7.27-6.989-.357-14.056 1.913-19.387 7.27L7.499 440.509c-9.999 10.024-9.999 26.298 0 36.323s26.223 10.024 36.222 0l262.293-287.164L568.28 476.832c9.999 10.024 26.222 10.024 36.221 0 9.999-10.023 9.999-26.298 0-36.323z"></path>
  </symbol>
  <symbol viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" id="carly">
    <path d="M504.971 239.029L448 182.059V84c0-46.317-37.682-84-84-84h-44c-13.255 0-24 10.745-24 24s10.745 24 24 24h44c19.851 0 36 16.149 36 36v108c0 6.365 2.529 12.47 7.029 16.971L454.059 256l-47.029 47.029A24.002 24.002 0 0 0 400 320v108c0 19.851-16.149 36-36 36h-44c-13.255 0-24 10.745-24 24s10.745 24 24 24h44c46.318 0 84-37.683 84-84v-98.059l56.971-56.971c9.372-9.372 9.372-24.568 0-33.941zM112 192V84c0-19.851 16.149-36 36-36h44c13.255 0 24-10.745 24-24S205.255 0 192 0h-44c-46.318 0-84 37.683-84 84v98.059l-56.971 56.97c-9.373 9.373-9.373 24.568 0 33.941L64 329.941V428c0 46.317 37.682 84 84 84h44c13.255 0 24-10.745 24-24s-10.745-24-24-24h-44c-19.851 0-36-16.149-36-36V320c0-6.365-2.529-12.47-7.029-16.971L57.941 256l47.029-47.029A24.002 24.002 0 0 0 112 192z"></path>
  </symbol>
  <symbol viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" id="copy">
    <path d="M23 2.75A2.75 2.75 0 0 0 20.25 0H8.75A2.75 2.75 0 0 0 6 2.75v13.5A2.75 2.75 0 0 0 8.75 19h11.5A2.75 2.75 0 0 0 23 16.25zM18.25 14.5h-7.5a.75.75 0 0 1 0-1.5h7.5a.75.75 0 0 1 0 1.5zm0-3h-7.5a.75.75 0 0 1 0-1.5h7.5a.75.75 0 0 1 0 1.5zm0-3h-7.5a.75.75 0 0 1 0-1.5h7.5a.75.75 0 0 1 0 1.5z"></path>
    <path d="M8.75 20.5a4.255 4.255 0 0 1-4.25-4.25V2.75c0-.086.02-.166.025-.25H3.75A2.752 2.752 0 0 0 1 5.25v16A2.752 2.752 0 0 0 3.75 24h12a2.752 2.752 0 0 0 2.75-2.75v-.75z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512.001 512.001" id="closeme">
    <path d="M284.286 256.002L506.143 34.144c7.811-7.811 7.811-20.475 0-28.285-7.811-7.81-20.475-7.811-28.285 0L256 227.717 34.143 5.859c-7.811-7.811-20.475-7.811-28.285 0-7.81 7.811-7.811 20.475 0 28.285l221.857 221.857L5.858 477.859c-7.811 7.811-7.811 20.475 0 28.285a19.938 19.938 0 0 0 14.143 5.857 19.94 19.94 0 0 0 14.143-5.857L256 284.287l221.857 221.857c3.905 3.905 9.024 5.857 14.143 5.857s10.237-1.952 14.143-5.857c7.811-7.811 7.811-20.475 0-28.285L284.286 256.002z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id="open-menu">
    <path d="M492 236H20c-11.046 0-20 8.954-20 20s8.954 20 20 20h472c11.046 0 20-8.954 20-20s-8.954-20-20-20zm0-160H20C8.954 76 0 84.954 0 96s8.954 20 20 20h472c11.046 0 20-8.954 20-20s-8.954-20-20-20zm0 320H20c-11.046 0-20 8.954-20 20s8.954 20 20 20h472c11.046 0 20-8.954 20-20s-8.954-20-20-20z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="instagram">
    <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id=youtube>
    <path d="M19.615 3.184c-3.604-.246-11.631-.245-15.23 0-3.897.266-4.356 2.62-4.385 8.816.029 6.185.484 8.549 4.385 8.816 3.6.245 11.626.246 15.23 0 3.897-.266 4.356-2.62 4.385-8.816-.029-6.185-.484-8.549-4.385-8.816zm-10.615 12.816v-8l8 3.993-8 4.007z"/>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="stackoverflow">
    <path d="M21 27v-8h3v11H0V19h3v8h18z"></path><path d="M17.1.2L15 1.8l7.9 10.6 2.1-1.6L17.1.2zm3.7 14.7L10.6 6.4l1.7-2 10.2 8.5-1.7 2zM7.2 12.3l12 5.6 1.1-2.4-12-5.6-1.1 2.4zm-1.8 6.8l13.56 1.96.17-2.38-13.26-2.55-.47 2.97zM19 25H5v-3h14v3z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="xing">
    <path d="M18.188 0c-.517 0-.741.325-.927.66 0 0-7.455 13.224-7.702 13.657.015.024 4.919 9.023 4.919 9.023.17.308.436.66.967.66h3.454c.211 0 .375-.078.463-.22.089-.151.089-.346-.009-.536l-4.879-8.916c-.004-.006-.004-.016 0-.022L22.139.756c.095-.191.097-.387.006-.535C22.056.078 21.894 0 21.686 0h-3.498zM3.648 4.74c-.211 0-.385.074-.473.216-.09.149-.078.339.02.531l2.34 4.05c.004.01.004.016 0 .021L1.86 16.051c-.099.188-.093.381 0 .529.085.142.239.234.45.234h3.461c.518 0 .766-.348.945-.667l3.734-6.609-2.378-4.155c-.172-.315-.434-.659-.962-.659H3.648v.016z"/>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 71 55" id="discord">
    <path d="M60.1045 4.8978C55.5792 2.8214 50.7265 1.2916 45.6527 0.41542C45.5603 0.39851 45.468 0.440769 45.4204 0.525289C44.7963 1.6353 44.105 3.0834 43.6209 4.2216C38.1637 3.4046 32.7345 3.4046 27.3892 4.2216C26.905 3.0581 26.1886 1.6353 25.5617 0.525289C25.5141 0.443589 25.4218 0.40133 25.3294 0.41542C20.2584 1.2888 15.4057 2.8186 10.8776 4.8978C10.8384 4.9147 10.8048 4.9429 10.7825 4.9795C1.57795 18.7309 -0.943561 32.1443 0.293408 45.3914C0.299005 45.4562 0.335386 45.5182 0.385761 45.5576C6.45866 50.0174 12.3413 52.7249 18.1147 54.5195C18.2071 54.5477 18.305 54.5139 18.3638 54.4378C19.7295 52.5728 20.9469 50.6063 21.9907 48.5383C22.0523 48.4172 21.9935 48.2735 21.8676 48.2256C19.9366 47.4931 18.0979 46.6 16.3292 45.5858C16.1893 45.5041 16.1781 45.304 16.3068 45.2082C16.679 44.9293 17.0513 44.6391 17.4067 44.3461C17.471 44.2926 17.5606 44.2813 17.6362 44.3151C29.2558 49.6202 41.8354 49.6202 53.3179 44.3151C53.3935 44.2785 53.4831 44.2898 53.5502 44.3433C53.9057 44.6363 54.2779 44.9293 54.6529 45.2082C54.7816 45.304 54.7732 45.5041 54.6333 45.5858C52.8646 46.6197 51.0259 47.4931 49.0921 48.2228C48.9662 48.2707 48.9102 48.4172 48.9718 48.5383C50.038 50.6034 51.2554 52.5699 52.5959 54.435C52.6519 54.5139 52.7526 54.5477 52.845 54.5195C58.6464 52.7249 64.529 50.0174 70.6019 45.5576C70.6551 45.5182 70.6887 45.459 70.6943 45.3942C72.1747 30.0791 68.2147 16.7757 60.1968 4.9823C60.1772 4.9429 60.1437 4.9147 60.1045 4.8978ZM23.7259 37.3253C20.2276 37.3253 17.3451 34.1136 17.3451 30.1693C17.3451 26.225 20.1717 23.0133 23.7259 23.0133C27.308 23.0133 30.1626 26.2532 30.1066 30.1693C30.1066 34.1136 27.28 37.3253 23.7259 37.3253ZM47.3178 37.3253C43.8196 37.3253 40.9371 34.1136 40.9371 30.1693C40.9371 26.225 43.7636 23.0133 47.3178 23.0133C50.9 23.0133 53.7545 26.2532 53.6986 30.1693C53.6986 34.1136 50.9 37.3253 47.3178 37.3253Z"/>
  </symbol>
</svg>


<footer class="footer">
  <div class="footer_inner wrap pale">
    <img src='https://blog.andreasm.io/icons/apple-touch-icon.png' class="icon icon_2 transparent" alt="From 0.985mhz... to several Ghz">
    <p>Copyright&nbsp;2016-&nbsp;<span class="year"></span>&nbsp;FROM 0.985MHZ... TO SEVERAL GHZ. All Rights Reserved</p><a class="to_top" href="#documentTop">
  <svg class="icon">
  <title>to-top</title>
  <use xlink:href="#to-top"></use>
</svg>

</a>

  </div>
</footer>

<script type="text/javascript" src="https://blog.andreasm.io/en/js/bundle.5548d358738600c857a1f05f0459418da7143d4426c66a08bf3f15ded1b39dd2136bf104a559247a909fc4dcc45b8e06bad0870ece4c71ee5303d30550def8bd.js" integrity="sha512-VUjTWHOGAMhXofBfBFlBjacUPUQmxmoIvz8V3tGzndITa/EEpVkkepCfxNzEW44GutCHDs5Mce5TA9MFUN74vQ==" crossorigin="anonymous"></script>

  <script src="https://blog.andreasm.io/js/search.min.df4d84e4983f0c71dd495e07a09815d920553c3ddf3d0767801c73373573aa17e1b489e4453272dbf4ce2a38a3d01a10b170744e50dd6bec85a598221867ba9a.js"></script>

  </body>
</html>
