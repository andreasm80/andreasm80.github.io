<!DOCTYPE html>
<html lang="en" dir="ltr" class="scroll-smooth" data-default-appearance="dark"
  data-auto-appearance="true"><head>
  <meta charset="utf-8" />
  
  <meta http-equiv="content-language" content="en" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  
  <title>A Quick Glance at Cilium CNI &middot; blog.andreasm.io</title>
  <meta name="title" content="A Quick Glance at Cilium CNI &middot; blog.andreasm.io" />
  
  <meta name="description" content="In this post I will deploy Cilium in my k8s cluster and test some features and how it is to manage" />
  <meta name="keywords" content="cilium, kubernetes, cni, networking, ebpf, " />
  
  
  <link rel="canonical" href="https://blog.andreasm.io/2023/12/18/a-quick-glance-at-cilium-cni/" />
  
  
  
  
  
  
  
  
  
  
  
  
  <link type="text/css" rel="stylesheet" href="/css/main.bundle.min.48d290696564c2380c4233780f3fd414aa6e2b0b67ed916e9d918c48c05f5b20b641bf892fadd408e43ec21d2feb2ec1fe6fd1f021df2806a254977fe2f80a64.css"
    integrity="sha512-SNKQaWVkwjgMQjN4Dz/UFKpuKwtn7ZFunZGMSMBfWyC2Qb&#43;JL63UCOQ&#43;wh0v6y7B/m/R8CHfKAaiVJd/4vgKZA==" />
  
  
  <script type="text/javascript" src="/js/appearance.min.a85bd6dc99d1fecae166deb56a1fee6375588c72533c4b8c690e4a9ec5a04174ff780e41e2ac770382a8e67818cb2b89766afa3e23965c9102424a080dafbb0c.js"
    integrity="sha512-qFvW3JnR/srhZt61ah/uY3VYjHJTPEuMaQ5KnsWgQXT/eA5B4qx3A4Ko5ngYyyuJdmr6PiOWXJECQkoIDa&#43;7DA=="></script>
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <script defer type="text/javascript" id="script-bundle" src="/js/main.bundle.min.a2d78d78672e549fbfc972ece871725b5478ba0b65708dda20cb97ab80a865eae6d247e1b05a4aec6ebbf78647ec3233bad8b2609ed98eee53cd58aa17128bc7.js"
    integrity="sha512-oteNeGcuVJ&#43;/yXLs6HFyW1R4ugtlcI3aIMuXq4CoZerm0kfhsFpK7G6794ZH7DIzutiyYJ7Zju5TzViqFxKLxw==" data-copy="" data-copied=""></script>
  
  
  
  <script src="/lib/zoom/zoom.min.37d2094687372da3f7343a221a470f6b8806f7891aa46a5a03966af7f0ebd38b9fe536cb154e6ad28f006d184b294525a7c4054b6bbb4be62d8b453b42db99bd.js" integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S&#43;Yti0U7QtuZvQ=="></script>
  
  
  
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
  <link rel="manifest" href="/site.webmanifest" />
  
  
  
  
  
  
  
  
  <meta property="og:url" content="https://blog.andreasm.io/2023/12/18/a-quick-glance-at-cilium-cni/">
  <meta property="og:site_name" content="blog.andreasm.io">
  <meta property="og:title" content="A Quick Glance at Cilium CNI">
  <meta property="og:description" content="Deploying Cilium in my upstream K8s cluster and test some features">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2023-12-18T11:49:56+01:00">
    <meta property="article:modified_time" content="2023-12-18T11:49:56+01:00">
    <meta property="article:tag" content="Cilium">
    <meta property="article:tag" content="Kubernetes">
    <meta property="article:tag" content="Cni">
    <meta property="article:tag" content="Networking">
    <meta property="article:tag" content="Ebpf">
    <meta property="og:image" content="https://blog.andreasm.io/2023/12/18/a-quick-glance-at-cilium-cni/feature-cilium.jpg">

  
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://blog.andreasm.io/2023/12/18/a-quick-glance-at-cilium-cni/feature-cilium.jpg">
  <meta name="twitter:title" content="A Quick Glance at Cilium CNI">
  <meta name="twitter:description" content="Deploying Cilium in my upstream K8s cluster and test some features">

  
  <script type="application/ld+json">
  [{
    "@context": "https://schema.org",
    "@type": "Article",
    "articleSection": "Posts",
    "name": "A Quick Glance at Cilium CNI",
    "headline": "A Quick Glance at Cilium CNI",
    "description": "Deploying Cilium in my upstream K8s cluster and test some features",
    "abstract": "In this post I will deploy Cilium in my k8s cluster and test some features and how it is to manage",
    "inLanguage": "en",
    "url" : "https:\/\/blog.andreasm.io\/2023\/12\/18\/a-quick-glance-at-cilium-cni\/",
    "author" : {
      "@type": "Person",
      "name": "Andreas Marqvardsen"
    },
    "copyrightYear": "2023",
    "dateCreated": "2023-12-18T11:49:56\u002b01:00",
    "datePublished": "2023-12-18T11:49:56\u002b01:00",
    
    "dateModified": "2023-12-18T11:49:56\u002b01:00",
    
    "keywords": ["cilium","kubernetes","cni","networking","ebpf"],
    
    "mainEntityOfPage": "true",
    "wordCount": "8012"
  }]
  </script>


  
  
  <meta name="author" content="Andreas Marqvardsen" />
  
  
  
  <link href="mailto:andreas.marqvardsen[AT]gmail.com" rel="me" />
  
  
  <link href="https://blog.andreasm.io/" rel="me" />
  
  
  <link href="https://github.com/andreasm80" rel="me" />
  
  
  <link href="https://linkedin.com/in/andreas-marqvardsen" rel="me" />
  
  
  <link href="https://vmst.io/@andreasm" rel="me" />
  
  
  <link href="https://x.com/NATsoFast" rel="me" />
  
  
  
  

<script src="/lib/jquery/jquery.slim.min.b0dca576e87d7eaa5850ae4e61759c065786cdb6489d68fcc82240539eebd5da522bdb4fda085ffd245808c8fe2acb2516408eb774ef26b5f6015fc6737c0ea8.js" integrity="sha512-sNylduh9fqpYUK5OYXWcBleGzbZInWj8yCJAU57r1dpSK9tP2ghf/SRYCMj&#43;KsslFkCOt3TvJrX2AV/Gc3wOqA=="></script>






















  
  

<script async src="https://www.googletagmanager.com/gtag/js?id=G-TVPYDVE8KR"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-TVPYDVE8KR');
</script>



  
  
  <meta name="theme-color"/>
  
  
</head>
<body
  class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32 scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600">
  <div id="the-top" class="absolute flex self-center">
    <a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600"
      href="#main-content"><span
        class="font-bold text-primary-600 ltr:pr-2 rtl:pl-2 dark:text-primary-400">&darr;</span>Skip to main content</a>
  </div>
  
  
  <div class="min-h-[148px]"></div>
<div class="fixed inset-x-0 pl-[24px] pr-[24px]" style="z-index:100">
  <div id="menu-blur" class="absolute opacity-0 inset-x-0 top-0 h-full single_hero_background nozoom backdrop-blur-2xl shadow-2xl"></div>
  <div class="relative max-w-[64rem] ml-auto mr-auto">
    <div style="padding-left:0;padding-right:0;padding-top:2px;padding-bottom:3px"
    class="main-menu flex items-center justify-between px-4 py-6 sm:px-6 md:justify-start space-x-3">
    
    
    
    <div>
        <a href="/" class="flex">
            <span class="sr-only">blog.andreasm.io</span>

            
            <img src="/ynwa2.png" width="300" height="342"
                class="logo max-h-[5rem] max-w-[5rem] object-scale-down object-left nozoom" alt="blog.andreasm.io" />
            

        </a>
    </div>
    
    <div class="flex flex-1 items-center justify-between">
        <nav class="flex space-x-3">

            
            <a href="/" class="text-base font-medium text-gray-500 hover:text-gray-900">blog.andreasm.io</a>
            

        </nav>
        <nav class="hidden md:flex items-center space-x-5 md:ml-12 h-12">

            
            
            
  <a href="/posts/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
    
    <p class="text-base font-medium" title="">
        Posts
    </p>
</a>



            
            
  <a href="/about/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
    
    <p class="text-base font-medium" title="">
        About
    </p>
</a>



            
            
  <a href="/categories/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
    
    <p class="text-base font-medium" title="">
        Categories
    </p>
</a>



            
            
  <a href="/tags/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
    
    <p class="text-base font-medium" title="">
        Tags
    </p>
</a>



            
            

            


            
            <button id="search-button" aria-label="Search" class="text-base hover:text-primary-600 dark:hover:text-primary-400"
                title="">
                

  <span class="relative block icon">
    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>

  </span>


            </button>
            


            
            
            <div
                class="ltr:mr-14 rtl:ml-14 flex items-center">
                <button id="appearance-switcher" aria-label="Dark mode switcher" type="button" class="text-base hover:text-primary-600 dark:hover:text-primary-400">
                    <div class="flex items-center justify-center dark:hidden">
                        

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M32 256c0-123.8 100.3-224 223.8-224c11.36 0 29.7 1.668 40.9 3.746c9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3c9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480C132.1 480 32 379.6 32 256z"/></svg>

  </span>


                    </div>
                    <div class="items-center justify-center hidden dark:flex">
                        

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02 0-95.1 42.98-95.1 95.1S202.1 351.1 256 351.1s95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347L446.1 255.1l63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7l-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89L164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6L12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256l-63.15 91.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7l19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109l109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69 0-127.1-57.31-127.1-127.1c0-70.69 57.31-127.1 127.1-127.1s127.1 57.3 127.1 127.1C383.1 326.7 326.7 383.1 256 383.1z"/></svg>

  </span>


                    </div>
                </button>
            </div>
            

        </nav>
        <div class="flex md:hidden items-center space-x-5 md:ml-12 h-12">

            <span></span>

            


            
            <button id="search-button-mobile" aria-label="Search" class="text-base hover:text-primary-600 dark:hover:text-primary-400"
                title="">
                

  <span class="relative block icon">
    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>

  </span>


            </button>
            

            
            
            <button id="appearance-switcher-mobile" aria-label="Dark mode switcher" type="button" class="text-base hover:text-primary-600 dark:hover:text-primary-400" style="margin-right:5px">
                <div class="flex items-center justify-center dark:hidden">
                    

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M32 256c0-123.8 100.3-224 223.8-224c11.36 0 29.7 1.668 40.9 3.746c9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3c9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480C132.1 480 32 379.6 32 256z"/></svg>

  </span>


                </div>
                <div class="items-center justify-center hidden dark:flex">
                    

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02 0-95.1 42.98-95.1 95.1S202.1 351.1 256 351.1s95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347L446.1 255.1l63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7l-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89L164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6L12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256l-63.15 91.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7l19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109l109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69 0-127.1-57.31-127.1-127.1c0-70.69 57.31-127.1 127.1-127.1s127.1 57.3 127.1 127.1C383.1 326.7 326.7 383.1 256 383.1z"/></svg>

  </span>


                </div>
            </button>
            

        </div>
    </div>
    <div class="-my-2 -mr-2 md:hidden">

        <label id="menu-button" class="block">
            
            <div class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400">
                

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M0 96C0 78.33 14.33 64 32 64H416C433.7 64 448 78.33 448 96C448 113.7 433.7 128 416 128H32C14.33 128 0 113.7 0 96zM0 256C0 238.3 14.33 224 32 224H416C433.7 224 448 238.3 448 256C448 273.7 433.7 288 416 288H32C14.33 288 0 273.7 0 256zM416 448H32C14.33 448 0 433.7 0 416C0 398.3 14.33 384 32 384H416C433.7 384 448 398.3 448 416C448 433.7 433.7 448 416 448z"/></svg>

  </span>


            </div>
            <div id="menu-wrapper" style="padding-top:5px;"
                class="fixed inset-0 z-30 invisible w-screen h-screen m-0 overflow-auto transition-opacity opacity-0 cursor-default bg-neutral-100/50 backdrop-blur-sm dark:bg-neutral-900/50">
                <ul
                    class="flex space-y-2 mt-3 flex-col items-end w-full px-6 py-6 mx-auto overflow-visible list-none ltr:text-right rtl:text-left max-w-7xl">

                    <li id="menu-close-button">
                        <span
                            class="cursor-pointer inline-block align-text-bottom hover:text-primary-600 dark:hover:text-primary-400">

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75 0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3L54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75 0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75 0-45.25s32.75-12.5 45.25 0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25 0s12.5 32.75 0 45.25l-105.4 105.4L310.6 361.4z"/></svg>

  </span>

</span>
                    </li>

                    

                    
  <li class="mt-1">
    <a href="/posts/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
        
        <p class="text-bg font-bg" title="">
            Posts
        </p>
    </a>
</li>




                    

                    
  <li class="mt-1">
    <a href="/about/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
        
        <p class="text-bg font-bg" title="">
            About
        </p>
    </a>
</li>




                    

                    
  <li class="mt-1">
    <a href="/categories/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
        
        <p class="text-bg font-bg" title="">
            Categories
        </p>
    </a>
</li>




                    

                    
  <li class="mt-1">
    <a href="/tags/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
        
        <p class="text-bg font-bg" title="">
            Tags
        </p>
    </a>
</li>




                    

                </ul>
                
                

            </div>
        </label>
    </div>
</div>




<script>
    (function () {
        var $mainmenu = $('.main-menu');
        var path = window.location.pathname;
        $mainmenu.find('a[href="' + path + '"]').each(function (i, e) {
            $(e).children('p').addClass('active');
        });
    })();
</script>


  </div>
</div>
<script>
  window.addEventListener('scroll', function (e) {
    var scroll = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop || 0;
    var background_blur = document.getElementById('menu-blur');
    background_blur.style.opacity = (scroll / 300);
  });
</script>

  
  <div class="relative flex flex-col grow">
    <main id="main-content" class="grow">
      


<article>
  
  
  
  
  
  


<div id="hero" class="h-[150px] md:h-[200px]"></div>



    
    <div class="fixed inset-x-0 top-0 h-[800px] single_hero_background nozoom"
    style="background-image:url(/2023/12/18/a-quick-glance-at-cilium-cni/feature-cilium.jpg);">
    


    <div class="absolute inset-0 bg-gradient-to-t from-neutral dark:from-neutral-800 to-transparent mix-blend-normal">
    </div>
    <div
        class="absolute inset-0 opacity-60 bg-gradient-to-t from-neutral dark:from-neutral-800 to-neutral-100 dark:to-neutral-800 mix-blend-normal">
    </div>
</div>

<div id="background-blur" class="fixed opacity-0 inset-x-0 top-0 h-full single_hero_background nozoom backdrop-blur-2xl"></div>
<script>
    window.addEventListener('scroll', function (e) {
        var scroll = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop || 0;
        var background_blur = document.getElementById('background-blur');
        background_blur.style.opacity = (scroll / 300)
    });
</script>

  
  

  <header id="single_header" class="mt-5 max-w-prose">
    
    <ol class="text-sm text-neutral-500 dark:text-neutral-400 print:hidden">
  
  
    
  
    
  
  <li class="inline hidden">
    <a
      class="hover:underline decoration-neutral-300 dark:underline-neutral-600"
      href="/"
      >blog.andreasm.io</a
    ><span class="px-1 text-primary-500">/</span>
  </li>

  
  <li class="inline ">
    <a
      class="hover:underline decoration-neutral-300 dark:underline-neutral-600"
      href="/posts/"
      >Posts</a
    ><span class="px-1 text-primary-500">/</span>
  </li>

  
  <li class="inline hidden">
    <a
      class="hover:underline decoration-neutral-300 dark:underline-neutral-600"
      href="/2023/12/18/a-quick-glance-at-cilium-cni/"
      >A Quick Glance at Cilium CNI</a
    ><span class="px-1 text-primary-500">/</span>
  </li>

</ol>


    
    <h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">
      A Quick Glance at Cilium CNI
    </h1>
    <div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden">
      





  
  







  





  



  













<div class="flex flex-row flex-wrap items-center">
  
  
  <time datetime="2023-12-18T11:49:56&#43;01:00">18 December 2023</time><span class="px-2 text-primary-500">&middot;</span><span>8012 words</span><span class="px-2 text-primary-500">&middot;</span><span title="Reading time">38 mins</span>
  

  
  
</div>


<div class="flex flex-row flex-wrap items-center">
  
  
  
  
  
  
  
  
  
  
  
</div>




<div class="flex flex-row flex-wrap items-center">
  
  
  
  
  
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/kubernetes/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Kubernetes
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/cni/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    CNI
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/networking/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Networking
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/security/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Security
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/monitoring/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Monitoring
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/ebpf/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    EBPF
  </span>
</span>
  </span>
  
  
  
  
  
  
  
  
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/cilium/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Cilium
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/kubernetes/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Kubernetes
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/cni/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Cni
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/networking/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Networking
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/ebpf/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Ebpf
  </span>
</span>
  </span>
  
  
  
  
</div>




    </div>

    
    
    
    
    

    

    
      
      
        
        
<div class="flex author">
  
    
    
      
    
    
      
      <img class="!mt-0 !mb-0 h-24 w-24 rounded-full ltr:mr-4 rtl:ml-4" width="96" height="96"
      alt="Andreas Marqvardsen" src="/profile.png" />
    
  
  <div class="place-self-center">
    
    <div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">
      Author
    </div>
    <div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">
      Andreas Marqvardsen
    </div>
    
    
    <div class="text-sm text-neutral-700 dark:text-neutral-400">Always curious, always learning</div>
    
    <div class="text-2xl sm:text-lg">
  <div class="flex flex-wrap text-neutral-400 dark:text-neutral-500">
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="mailto:andreas.marqvardsen[AT]gmail.com"
          target="_blank"
          aria-label="Email"
          rel="me noopener noreferrer"
          ><span class="inline-block align-text-bottom">

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M207.8 20.73c-93.45 18.32-168.7 93.66-187 187.1c-27.64 140.9 68.65 266.2 199.1 285.1c19.01 2.888 36.17-12.26 36.17-31.49l.0001-.6631c0-15.74-11.44-28.88-26.84-31.24c-84.35-12.98-149.2-86.13-149.2-174.2c0-102.9 88.61-185.5 193.4-175.4c91.54 8.869 158.6 91.25 158.6 183.2l0 16.16c0 22.09-17.94 40.05-40 40.05s-40.01-17.96-40.01-40.05v-120.1c0-8.847-7.161-16.02-16.01-16.02l-31.98 .0036c-7.299 0-13.2 4.992-15.12 11.68c-24.85-12.15-54.24-16.38-86.06-5.106c-38.75 13.73-68.12 48.91-73.72 89.64c-9.483 69.01 43.81 128 110.9 128c26.44 0 50.43-9.544 69.59-24.88c24 31.3 65.23 48.69 109.4 37.49C465.2 369.3 496 324.1 495.1 277.2V256.3C495.1 107.1 361.2-9.332 207.8 20.73zM239.1 304.3c-26.47 0-48-21.56-48-48.05s21.53-48.05 48-48.05s48 21.56 48 48.05S266.5 304.3 239.1 304.3z"/></svg>

  </span>

</span></a
        >
      
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="https://blog.andreasm.io/"
          target="_blank"
          aria-label="Link"
          rel="me noopener noreferrer"
          ><span class="inline-block align-text-bottom">

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><path fill="currentColor" d="M172.5 131.1C228.1 75.51 320.5 75.51 376.1 131.1C426.1 181.1 433.5 260.8 392.4 318.3L391.3 319.9C381 334.2 361 337.6 346.7 327.3C332.3 317 328.9 297 339.2 282.7L340.3 281.1C363.2 249 359.6 205.1 331.7 177.2C300.3 145.8 249.2 145.8 217.7 177.2L105.5 289.5C73.99 320.1 73.99 372 105.5 403.5C133.3 431.4 177.3 435 209.3 412.1L210.9 410.1C225.3 400.7 245.3 404 255.5 418.4C265.8 432.8 262.5 452.8 248.1 463.1L246.5 464.2C188.1 505.3 110.2 498.7 60.21 448.8C3.741 392.3 3.741 300.7 60.21 244.3L172.5 131.1zM467.5 380C411 436.5 319.5 436.5 263 380C213 330 206.5 251.2 247.6 193.7L248.7 192.1C258.1 177.8 278.1 174.4 293.3 184.7C307.7 194.1 311.1 214.1 300.8 229.3L299.7 230.9C276.8 262.1 280.4 306.9 308.3 334.8C339.7 366.2 390.8 366.2 422.3 334.8L534.5 222.5C566 191 566 139.1 534.5 108.5C506.7 80.63 462.7 76.99 430.7 99.9L429.1 101C414.7 111.3 394.7 107.1 384.5 93.58C374.2 79.2 377.5 59.21 391.9 48.94L393.5 47.82C451 6.731 529.8 13.25 579.8 63.24C636.3 119.7 636.3 211.3 579.8 267.7L467.5 380z"/></svg>

  </span>

</span></a
        >
      
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="https://github.com/andreasm80"
          target="_blank"
          aria-label="Github"
          rel="me noopener noreferrer"
          ><span class="inline-block align-text-bottom">

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>

  </span>

</span></a
        >
      
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="https://linkedin.com/in/andreas-marqvardsen"
          target="_blank"
          aria-label="Linkedin"
          rel="me noopener noreferrer"
          ><span class="inline-block align-text-bottom">

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg>

  </span>

</span></a
        >
      
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="https://vmst.io/@andreasm"
          target="_blank"
          aria-label="Mastodon"
          rel="me noopener noreferrer"
          ><span class="inline-block align-text-bottom">

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48 0 0 0-63.72 28.5-63.72 125.7 0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54 0 0 1-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"/></svg>

  </span>

</span></a
        >
      
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="https://x.com/NATsoFast"
          target="_blank"
          aria-label="X-Twitter"
          rel="me noopener noreferrer"
          ><span class="inline-block align-text-bottom">

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8L200.7 275.5 26.8 48H172.4L272.9 180.9 389.2 48zM364.4 421.8h39.1L151.1 88h-42L364.4 421.8z"/></svg>
  </span>

</span></a
        >
      
    
  </div>

</div>
  </div>
</div>

      

      

      
      <div class="mb-5"></div>
      

    

  </header>
  
  <section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row">
    
     <div
      class="order-first lg:ml-auto px-0 lg:order-last ltr:lg:pl-8 rtl:lg:pr-8">
      <div class="toc ltr:pl-5 rtl:pr-5 print:hidden lg:sticky lg:top-[140px]">

         <details open id="TOCView"
  class="toc-right mt-0 overflow-y-scroll overscroll-contain scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600 rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 hidden lg:block">
  <summary
    class="block py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">
    Table of Contents
  </summary>
  <div
    class="min-w-[220px] py-2 border-dotted ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#what-is-ebpfhttpsebpfiowhat-is-ebpfwhat-is-ebpf"><a href="https://ebpf.io/what-is-ebpf/#what-is-ebpf">What is eBPF?</a></a></li>
    <li><a href="#preparations">Preparations</a></li>
    <li><a href="#installation-of-cilium">Installation of Cilium</a>
      <ul>
        <li><a href="#kubeadm-init-with-no-kube-proxy">kubeadm init with no-kube-proxy</a></li>
      </ul>
    </li>
    <li><a href="#install-cilium-cni">Install Cilium CNI</a>
      <ul>
        <li><a href="#install-cilium-on-a-cluster-with-no-kube-proxy">Install Cilium on a cluster with no kube-proxy</a></li>
        <li><a href="#enabling-features-using-helm">Enabling features using Helm</a></li>
        <li><a href="#enabling-features-using-cilium-cli">Enabling features using Cilium cli</a></li>
      </ul>
    </li>
    <li><a href="#observability-and-flow-monitoring---hubble-observability">Observability and flow-monitoring - Hubble Observability</a></li>
    <li><a href="#lb-ipam">LB-IPAM</a></li>
    <li><a href="#bgp-control-plane">BGP Control Plane</a></li>
    <li><a href="#lb-ipam---does-it-actually-loadbalance">LB-IPAM - does it actually loadbalance?</a></li>
    <li><a href="#cilium-ingress">Cilium Ingress</a></li>
    <li><a href="#cilium-gateway-api">Cilium Gateway API</a></li>
    <li><a href="#hubble-ui">Hubble UI</a></li>
    <li><a href="#things-i-have-not-covered-yet-wich-i-will-at-a-later-stage">Things I have not covered yet wich I will at a later stage</a></li>
  </ul>
</nav>
  </div>
</details>
<details class="toc-inside mt-0 overflow-hidden rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 lg:hidden">
  <summary
    class="py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">
    Table of Contents
  </summary>
  <div
    class="py-2 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#what-is-ebpfhttpsebpfiowhat-is-ebpfwhat-is-ebpf"><a href="https://ebpf.io/what-is-ebpf/#what-is-ebpf">What is eBPF?</a></a></li>
    <li><a href="#preparations">Preparations</a></li>
    <li><a href="#installation-of-cilium">Installation of Cilium</a>
      <ul>
        <li><a href="#kubeadm-init-with-no-kube-proxy">kubeadm init with no-kube-proxy</a></li>
      </ul>
    </li>
    <li><a href="#install-cilium-cni">Install Cilium CNI</a>
      <ul>
        <li><a href="#install-cilium-on-a-cluster-with-no-kube-proxy">Install Cilium on a cluster with no kube-proxy</a></li>
        <li><a href="#enabling-features-using-helm">Enabling features using Helm</a></li>
        <li><a href="#enabling-features-using-cilium-cli">Enabling features using Cilium cli</a></li>
      </ul>
    </li>
    <li><a href="#observability-and-flow-monitoring---hubble-observability">Observability and flow-monitoring - Hubble Observability</a></li>
    <li><a href="#lb-ipam">LB-IPAM</a></li>
    <li><a href="#bgp-control-plane">BGP Control Plane</a></li>
    <li><a href="#lb-ipam---does-it-actually-loadbalance">LB-IPAM - does it actually loadbalance?</a></li>
    <li><a href="#cilium-ingress">Cilium Ingress</a></li>
    <li><a href="#cilium-gateway-api">Cilium Gateway API</a></li>
    <li><a href="#hubble-ui">Hubble UI</a></li>
    <li><a href="#things-i-have-not-covered-yet-wich-i-will-at-a-later-stage">Things I have not covered yet wich I will at a later stage</a></li>
  </ul>
</nav>
  </div>
</details>

<script>

  var margin = 200;
  var marginError = 50;

  (function () {
    var $window = $(window);
    var $toc = $('#TOCView');
    var tocHeight = $toc.height();

    function onResize() {
      var windowAndMarginHeight = $window.height() - margin;
      if(tocHeight >= windowAndMarginHeight) {
        $toc.css("overflow-y", "scroll")
        $toc.css("max-height", (windowAndMarginHeight + marginError) + "px")
      } else {
        $toc.css("overflow-y", "hidden")
        $toc.css("max-height", "9999999px")
      }
    }

    $window.on('resize', onResize);
    $(document).ready(onResize);
  })();



  (function () {
    var $toc = $('#TableOfContents');
    if ($toc.length > 0) {
      var $window = $(window);

      function onScroll() {
        var currentScroll = $window.scrollTop();
        var h = $('.anchor');
        var id = "";
        h.each(function (i, e) {
          e = $(e);
          if (e.offset().top - $(window).height()/3 <= currentScroll) {
            id = decodeURIComponent(e.attr('id'));
          }
        });
        var active = $toc.find('a.active');      
        if (active.length == 1 && active.eq(0).attr('href') == '#' + id) return true;

        active.each(function (i, e) {
          
            $(e).removeClass('active');
          
        });
        $toc.find('a[href="#' + id + '"]').addClass('active')
        $toc.find('a[href="#' + id + '"]').parentsUntil('#TableOfContents').each(function (i, e) {
          $(e).children('a').parents('ul').show();          
        });
      }

      $window.on('scroll', onScroll);
      $(document).ready(function () {
        
        onScroll();
      });
    }
  })();


</script>
   </div>
      </div>
      

      <div class="min-w-0 min-h-0 max-w-fit">
        
        


        <div class="article-content max-w-prose mb-20">
          

<h1 class="relative group">About Cilium 
    <div id="about-cilium" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#about-cilium" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<p>Instead of me using my own words I will just copy the text from the official Cilium <a href="https://cilium.io/" target="_blank">website</a>:</p>
<blockquote>


<h1 class="relative group">eBPF-based Networking, Observability, Security 
    <div id="ebpf-based-networking-observability-security" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#ebpf-based-networking-observability-security" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<p>Cilium is an open source, cloud native solution for providing, securing, and observing network connectivity between workloads, fueled by the revolutionary Kernel technology eBPF</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/12/18/a-quick-glance-at-cilium-cni/images/hero-illustration.png"
        alt="eBPF-based Networking, Observability, Security"
      />
      
    </figure>
</p>
</blockquote>
<p>Now what is eBPF?</p>
<p>From <a href="https://ebpf.io/what-is-ebpf/" target="_blank">ebpf.io</a></p>
<blockquote>


<h1 class="relative group">Dynamically program the kernel for efficient networking, observability, tracing, and security 
    <div id="dynamically-program-the-kernel-for-efficient-networking-observability-tracing-and-security" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#dynamically-program-the-kernel-for-efficient-networking-observability-tracing-and-security" aria-label="Anchor">#</a>
    </span>        
    
</h1>


<h2 class="relative group"><a href="https://ebpf.io/what-is-ebpf/#what-is-ebpf" target="_blank">What is eBPF?</a> 
    <div id="what-is-ebpfhttpsebpfiowhat-is-ebpfwhat-is-ebpf" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#what-is-ebpfhttpsebpfiowhat-is-ebpfwhat-is-ebpf" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>eBPF is a revolutionary technology with origins in the Linux kernel that can run sandboxed programs in a privileged context such as the operating system kernel. It is used to safely and efficiently extend the capabilities of the kernel without requiring to change kernel source code or load kernel modules.</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/12/18/a-quick-glance-at-cilium-cni/images/overview.png"
        alt="Overview"
      />
      
    </figure>
</p>
</blockquote>
<p>As it is always interesting to learn new technology I thought writing a post about Cilium was about time. At first look Cilium is kind of a Swiss Army knife with a lot interesting features. I will go through this post beginning with a basic installation of Cilium on a new cluster (upstream K8s based on Ubuntu nodes). Then I will continune with some of the features I found interesting, and needed myself in my lab, and how to enable and configure them.</p>
<p>This post will be divided into dedicated sections for the installtion part and the different features respectively, starting with the installation of Cilium as the CNI in my Kubernetes cluster.</p>


<h2 class="relative group">Preparations 
    <div id="preparations" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#preparations" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>This post assumes the following:</p>
<ul>
<li>Already prepared the Kubernetes nodes with all the software installed ready to do the kubeadm init.</li>
<li>A jumphost or Linux mgmt vm/server to operate from</li>
<li>Helm installed and configured on the Linux jumphost</li>
<li>Kubectl installed on the Linux jumphost</li>
<li>Cilium CLI installed on the Linux jumphost</li>
</ul>
<p>Cilium-cli is installed using this command:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nv">CILIUM_CLI_VERSION</span><span class="o">=</span><span class="k">$(</span>curl -s https://raw.githubusercontent.com/cilium/cilium-cli/main/stable.txt<span class="k">)</span>
</span></span><span class="line"><span class="cl"><span class="nv">CLI_ARCH</span><span class="o">=</span>amd64
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="k">$(</span>uname -m<span class="k">)</span><span class="s2">&#34;</span> <span class="o">=</span> <span class="s2">&#34;aarch64&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span> <span class="nv">CLI_ARCH</span><span class="o">=</span>arm64<span class="p">;</span> <span class="k">fi</span>
</span></span><span class="line"><span class="cl">curl -L --fail --remote-name-all https://github.com/cilium/cilium-cli/releases/download/<span class="si">${</span><span class="nv">CILIUM_CLI_VERSION</span><span class="si">}</span>/cilium-linux-<span class="si">${</span><span class="nv">CLI_ARCH</span><span class="si">}</span>.tar.gz<span class="o">{</span>,.sha256sum<span class="o">}</span>
</span></span><span class="line"><span class="cl">sha256sum --check cilium-linux-<span class="si">${</span><span class="nv">CLI_ARCH</span><span class="si">}</span>.tar.gz.sha256sum
</span></span><span class="line"><span class="cl">sudo tar xzvfC cilium-linux-<span class="si">${</span><span class="nv">CLI_ARCH</span><span class="si">}</span>.tar.gz /usr/local/bin
</span></span><span class="line"><span class="cl">rm cilium-linux-<span class="si">${</span><span class="nv">CLI_ARCH</span><span class="si">}</span>.tar.gz<span class="o">{</span>,.sha256sum<span class="o">}</span>
</span></span></code></pre></div><p>For more information have a look <a href="https://docs.cilium.io/en/stable/gettingstarted/k8s-install-default/" target="_blank">here</a></p>
<p>Below is my lab&rsquo;s topology for this post:</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/12/18/a-quick-glance-at-cilium-cni/images/image-20231219124247767.png"
        alt="my-lab-topology"
      />
      
    </figure>
</p>


<h2 class="relative group">Installation of Cilium 
    <div id="installation-of-cilium" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#installation-of-cilium" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>Cililum can be installed using Helm or using Ciliums nifty <em>cilium-cli</em> tool.</p>
<div class="notice info">
<p>One can use Helm to configure/install features but also the Cilium cli tool. In my post I will mostly use Helm when adding some features or changing certain settings and cilium-cli for others just to showcase how easy it is to use cilium cli for certain features/tasks.</p>
<p>According to the official docs:</p>
<blockquote>
<p>Install the latest version of the Cilium CLI. The Cilium CLI can be used to install Cilium, inspect the state of a Cilium installation, and enable/disable various features (e.g. clustermesh, Hubble).</p>
</blockquote>
</div>
<p>The first feature of Cilium in this post is how it can fully replace kube-proxy by providing distributed load balancing using eBPF. Naturally I would like to use this feature. This means I need to deploy my Kubernetes cluster without kube-proxy. That is easiest done during the initial upbringing of the Kubernetes cluster. It can be done post-upringing also, see more info <a href="https://docs.cilium.io/en/stable/network/kubernetes/kubeproxy-free/#kubeproxy-free" target="_blank">here</a></p>


<h3 class="relative group">kubeadm init with no-kube-proxy 
    <div id="kubeadm-init-with-no-kube-proxy" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#kubeadm-init-with-no-kube-proxy" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>To bring up my Kubernetes cluster without kube-proxy, this is the command I will use on my first control-plane node:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo kubeadm init --pod-network-cidr<span class="o">=</span>10.22.0.0/16 --service-cidr<span class="o">=</span>10.23.0.0/16  --control-plane-endpoint <span class="s2">&#34;test-cluster-1.my-doamin.net&#34;</span> --upload-certs --skip-phases<span class="o">=</span>addon/kube-proxy --cri-socket unix:///var/run/containerd/containerd.sock
</span></span></code></pre></div><blockquote>
<p>This is the parameter to disable kube-proxy <em>&ndash;skip-phases=addon/kube-proxy</em></p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">I1219 14:08:17.376790   <span class="m">13327</span> version.go:256<span class="o">]</span> remote version is much newer: v1.29.0<span class="p">;</span> falling back to: stable-1.28
</span></span><span class="line"><span class="cl"><span class="o">[</span>init<span class="o">]</span> Using Kubernetes version: v1.28.4
</span></span><span class="line"><span class="cl"><span class="o">[</span>preflight<span class="o">]</span> Running pre-flight checks
</span></span><span class="line"><span class="cl"><span class="o">[</span>preflight<span class="o">]</span> Pulling images required <span class="k">for</span> setting up a Kubernetes cluster
</span></span><span class="line"><span class="cl"><span class="o">[</span>preflight<span class="o">]</span> This might take a minute or two, depending on the speed of your internet connection
</span></span><span class="line"><span class="cl"><span class="o">[</span>preflight<span class="o">]</span> You can also perform this action in beforehand using <span class="s1">&#39;kubeadm config images pull&#39;</span>
</span></span><span class="line"><span class="cl">W1219 14:08:33.520592   <span class="m">13327</span> checks.go:835<span class="o">]</span> detected that the sandbox image <span class="s2">&#34;registry.k8s.io/pause:3.5&#34;</span> of the container runtime is inconsistent with that used by kubeadm. It is recommended that using <span class="s2">&#34;registry.k8s.io/pause:3.9&#34;</span> as the CRI sandbox image.
</span></span><span class="line"><span class="cl"><span class="o">[</span>certs<span class="o">]</span> Using certificateDir folder <span class="s2">&#34;/etc/kubernetes/pki&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>certs<span class="o">]</span> Generating <span class="s2">&#34;ca&#34;</span> certificate and key
</span></span><span class="line"><span class="cl"><span class="o">[</span>certs<span class="o">]</span> Generating <span class="s2">&#34;apiserver&#34;</span> certificate and key
</span></span><span class="line"><span class="cl"><span class="o">[</span>certs<span class="o">]</span> apiserver serving cert is signed <span class="k">for</span> DNS names <span class="o">[</span>k8s-master-01 kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local test-cluster-1.my-domain.net<span class="o">]</span> and IPs <span class="o">[</span>10.23.0.1 10.160.1.10<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>certs<span class="o">]</span> Generating <span class="s2">&#34;apiserver-kubelet-client&#34;</span> certificate and key
</span></span><span class="line"><span class="cl"><span class="o">[</span>certs<span class="o">]</span> Generating <span class="s2">&#34;front-proxy-ca&#34;</span> certificate and key
</span></span><span class="line"><span class="cl"><span class="o">[</span>certs<span class="o">]</span> Generating <span class="s2">&#34;front-proxy-client&#34;</span> certificate and key
</span></span><span class="line"><span class="cl"><span class="o">[</span>certs<span class="o">]</span> Generating <span class="s2">&#34;etcd/ca&#34;</span> certificate and key
</span></span><span class="line"><span class="cl"><span class="o">[</span>certs<span class="o">]</span> Generating <span class="s2">&#34;etcd/server&#34;</span> certificate and key
</span></span><span class="line"><span class="cl"><span class="o">[</span>certs<span class="o">]</span> etcd/server serving cert is signed <span class="k">for</span> DNS names <span class="o">[</span>k8s-master-01 localhost<span class="o">]</span> and IPs <span class="o">[</span>10.160.1.10 127.0.0.1 ::1<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>certs<span class="o">]</span> Generating <span class="s2">&#34;etcd/peer&#34;</span> certificate and key
</span></span><span class="line"><span class="cl"><span class="o">[</span>certs<span class="o">]</span> etcd/peer serving cert is signed <span class="k">for</span> DNS names <span class="o">[</span>k8s-master-01 localhost<span class="o">]</span> and IPs <span class="o">[</span>10.160.1.10 127.0.0.1 ::1<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>certs<span class="o">]</span> Generating <span class="s2">&#34;etcd/healthcheck-client&#34;</span> certificate and key
</span></span><span class="line"><span class="cl"><span class="o">[</span>certs<span class="o">]</span> Generating <span class="s2">&#34;apiserver-etcd-client&#34;</span> certificate and key
</span></span><span class="line"><span class="cl"><span class="o">[</span>certs<span class="o">]</span> Generating <span class="s2">&#34;sa&#34;</span> key and public key
</span></span><span class="line"><span class="cl"><span class="o">[</span>kubeconfig<span class="o">]</span> Using kubeconfig folder <span class="s2">&#34;/etc/kubernetes&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>kubeconfig<span class="o">]</span> Writing <span class="s2">&#34;admin.conf&#34;</span> kubeconfig file
</span></span><span class="line"><span class="cl"><span class="o">[</span>kubeconfig<span class="o">]</span> Writing <span class="s2">&#34;kubelet.conf&#34;</span> kubeconfig file
</span></span><span class="line"><span class="cl"><span class="o">[</span>kubeconfig<span class="o">]</span> Writing <span class="s2">&#34;controller-manager.conf&#34;</span> kubeconfig file
</span></span><span class="line"><span class="cl"><span class="o">[</span>kubeconfig<span class="o">]</span> Writing <span class="s2">&#34;scheduler.conf&#34;</span> kubeconfig file
</span></span><span class="line"><span class="cl"><span class="o">[</span>etcd<span class="o">]</span> Creating static Pod manifest <span class="k">for</span> <span class="nb">local</span> etcd in <span class="s2">&#34;/etc/kubernetes/manifests&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>control-plane<span class="o">]</span> Using manifest folder <span class="s2">&#34;/etc/kubernetes/manifests&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>control-plane<span class="o">]</span> Creating static Pod manifest <span class="k">for</span> <span class="s2">&#34;kube-apiserver&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>control-plane<span class="o">]</span> Creating static Pod manifest <span class="k">for</span> <span class="s2">&#34;kube-controller-manager&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>control-plane<span class="o">]</span> Creating static Pod manifest <span class="k">for</span> <span class="s2">&#34;kube-scheduler&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>kubelet-start<span class="o">]</span> Writing kubelet environment file with flags to file <span class="s2">&#34;/var/lib/kubelet/kubeadm-flags.env&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>kubelet-start<span class="o">]</span> Writing kubelet configuration to file <span class="s2">&#34;/var/lib/kubelet/config.yaml&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>kubelet-start<span class="o">]</span> Starting the kubelet
</span></span><span class="line"><span class="cl"><span class="o">[</span>wait-control-plane<span class="o">]</span> Waiting <span class="k">for</span> the kubelet to boot up the control plane as static Pods from directory <span class="s2">&#34;/etc/kubernetes/manifests&#34;</span>. This can take up to 4m0s
</span></span><span class="line"><span class="cl"><span class="o">[</span>kubelet-check<span class="o">]</span> Initial timeout of 40s passed.
</span></span><span class="line"><span class="cl"><span class="o">[</span>apiclient<span class="o">]</span> All control plane components are healthy after 106.047476 seconds
</span></span><span class="line"><span class="cl"><span class="o">[</span>upload-config<span class="o">]</span> Storing the configuration used in ConfigMap <span class="s2">&#34;kubeadm-config&#34;</span> in the <span class="s2">&#34;kube-system&#34;</span> Namespace
</span></span><span class="line"><span class="cl"><span class="o">[</span>kubelet<span class="o">]</span> Creating a ConfigMap <span class="s2">&#34;kubelet-config&#34;</span> in namespace kube-system with the configuration <span class="k">for</span> the kubelets in the cluster
</span></span><span class="line"><span class="cl"><span class="o">[</span>upload-certs<span class="o">]</span> Storing the certificates in Secret <span class="s2">&#34;kubeadm-certs&#34;</span> in the <span class="s2">&#34;kube-system&#34;</span> Namespace
</span></span><span class="line"><span class="cl"><span class="o">[</span>upload-certs<span class="o">]</span> Using certificate key:
</span></span><span class="line"><span class="cl">3c9fa959a7538baaaf484e931ade45fbad07934dc40d456cae54839a7d888715
</span></span><span class="line"><span class="cl"><span class="o">[</span>mark-control-plane<span class="o">]</span> Marking the node k8s-master-01 as control-plane by adding the labels: <span class="o">[</span>node-role.kubernetes.io/control-plane node.kubernetes.io/exclude-from-external-load-balancers<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>mark-control-plane<span class="o">]</span> Marking the node k8s-master-01 as control-plane by adding the taints <span class="o">[</span>node-role.kubernetes.io/control-plane:NoSchedule<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>bootstrap-token<span class="o">]</span> Using token: q495cj.apdasczda14j87tc
</span></span><span class="line"><span class="cl"><span class="o">[</span>bootstrap-token<span class="o">]</span> Configuring bootstrap tokens, cluster-info ConfigMap, RBAC Roles
</span></span><span class="line"><span class="cl"><span class="o">[</span>bootstrap-token<span class="o">]</span> Configured RBAC rules to allow Node Bootstrap tokens to get nodes
</span></span><span class="line"><span class="cl"><span class="o">[</span>bootstrap-token<span class="o">]</span> Configured RBAC rules to allow Node Bootstrap tokens to post CSRs in order <span class="k">for</span> nodes to get long term certificate credentials
</span></span><span class="line"><span class="cl"><span class="o">[</span>bootstrap-token<span class="o">]</span> Configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token
</span></span><span class="line"><span class="cl"><span class="o">[</span>bootstrap-token<span class="o">]</span> Configured RBAC rules to allow certificate rotation <span class="k">for</span> all node client certificates in the cluster
</span></span><span class="line"><span class="cl"><span class="o">[</span>bootstrap-token<span class="o">]</span> Creating the <span class="s2">&#34;cluster-info&#34;</span> ConfigMap in the <span class="s2">&#34;kube-public&#34;</span> namespace
</span></span><span class="line"><span class="cl"><span class="o">[</span>kubelet-finalize<span class="o">]</span> Updating <span class="s2">&#34;/etc/kubernetes/kubelet.conf&#34;</span> to point to a rotatable kubelet client certificate and key
</span></span><span class="line"><span class="cl"><span class="o">[</span>addons<span class="o">]</span> Applied essential addon: CoreDNS
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Your Kubernetes control-plane has initialized successfully!
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">To start using your cluster, you need to run the following as a regular user:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  mkdir -p <span class="nv">$HOME</span>/.kube
</span></span><span class="line"><span class="cl">  sudo cp -i /etc/kubernetes/admin.conf <span class="nv">$HOME</span>/.kube/config
</span></span><span class="line"><span class="cl">  sudo chown <span class="k">$(</span>id -u<span class="k">)</span>:<span class="k">$(</span>id -g<span class="k">)</span> <span class="nv">$HOME</span>/.kube/config
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Alternatively, <span class="k">if</span> you are the root user, you can run:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nb">export</span> <span class="nv">KUBECONFIG</span><span class="o">=</span>/etc/kubernetes/admin.conf
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">You should now deploy a pod network to the cluster.
</span></span><span class="line"><span class="cl">Run <span class="s2">&#34;kubectl apply -f [podnetwork].yaml&#34;</span> with one of the options listed at:
</span></span><span class="line"><span class="cl">  https://kubernetes.io/docs/concepts/cluster-administration/addons/
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">You can now join any number of the control-plane node running the following <span class="nb">command</span> on each as root:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  kubeadm join test-cluster-1.my-domain.net:6443 --token q4da14j87tc <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	--discovery-token-ca-cert-hash sha256: <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	--control-plane --certificate-key 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Please note that the certificate-key gives access to cluster sensitive data, keep it secret!
</span></span><span class="line"><span class="cl">As a safeguard, uploaded-certs will be deleted in two hours<span class="p">;</span> If necessary, you can use
</span></span><span class="line"><span class="cl"><span class="s2">&#34;kubeadm init phase upload-certs --upload-certs&#34;</span> to reload certs afterward.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Then you can join any number of worker nodes by running the following on each as root:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">kubeadm join test-cluster-1.my-domain.net:6443 --token q4aczda14j87tc <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	--discovery-token-ca-cert-hash sha256:
</span></span></code></pre></div><p>NB, notice that it &ldquo;complains&rdquo; <em>No kubeproxy.config.k8s.io/v1alpha1 config is loaded. Continuing without it: configmaps &ldquo;kube-proxy&rdquo;</em></p>
<p>Now on my worker nodes:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubeadm join test-cluster-1.my-domain.net:6443 --token q414j87tc <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	--discovery-token-ca-cert-hash sha256:edf4d18883f94f0b5aa646001606147
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>preflight<span class="o">]</span> Running pre-flight checks
</span></span><span class="line"><span class="cl"><span class="o">[</span>preflight<span class="o">]</span> Reading configuration from the cluster...
</span></span><span class="line"><span class="cl"><span class="o">[</span>preflight<span class="o">]</span> FYI: You can look at this config file with <span class="s1">&#39;kubectl -n kube-system get cm kubeadm-config -o yaml&#39;</span>
</span></span><span class="line"><span class="cl">W1219 16:25:57.203844    <span class="m">1279</span> configset.go:78<span class="o">]</span> Warning: No kubeproxy.config.k8s.io/v1alpha1 config is loaded. Continuing without it: configmaps <span class="s2">&#34;kube-proxy&#34;</span> is forbidden: User <span class="s2">&#34;system:bootstrap:q495cj&#34;</span> cannot get resource <span class="s2">&#34;configmaps&#34;</span> in API group <span class="s2">&#34;&#34;</span> in the namespace <span class="s2">&#34;kube-system&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>kubelet-start<span class="o">]</span> Writing kubelet configuration to file <span class="s2">&#34;/var/lib/kubelet/config.yaml&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>kubelet-start<span class="o">]</span> Writing kubelet environment file with flags to file <span class="s2">&#34;/var/lib/kubelet/kubeadm-flags.env&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>kubelet-start<span class="o">]</span> Starting the kubelet
</span></span><span class="line"><span class="cl"><span class="o">[</span>kubelet-start<span class="o">]</span> Waiting <span class="k">for</span> the kubelet to perform the TLS Bootstrap...
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">This node has joined the cluster:
</span></span><span class="line"><span class="cl">* Certificate signing request was sent to apiserver and a response was received.
</span></span><span class="line"><span class="cl">* The Kubelet was informed of the new secure connection details.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Run <span class="s1">&#39;kubectl get nodes&#39;</span> on the control-plane to see this node join the cluster.
</span></span></code></pre></div><p>NB, notice that it &ldquo;complains&rdquo; <em>No kubeproxy.config.k8s.io/v1alpha1 config is loaded. Continuing without it: configmaps &ldquo;kube-proxy&rdquo;</em></p>
<p>When all worker nodes has been joined:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@linuxmgmt01:~/test-cluster-1$ k get nodes
</span></span><span class="line"><span class="cl">NAME            STATUS   ROLES           AGE     VERSION
</span></span><span class="line"><span class="cl">k8s-master-01   Ready    control-plane   135m    v1.28.2
</span></span><span class="line"><span class="cl">k8s-worker-01   Ready    &lt;none&gt;          12s     v1.28.2
</span></span><span class="line"><span class="cl">k8s-worker-02   Ready    &lt;none&gt;          38s     v1.28.2
</span></span><span class="line"><span class="cl">k8s-worker-03   Ready    &lt;none&gt;          4m28s   v1.28.2
</span></span></code></pre></div><p>Notice they are not ready. CoreDNS is pending and there is no CNI in place to cover IPAM etc..</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@linuxmgmt01:~/test-cluster-1$ k get pods -A
</span></span><span class="line"><span class="cl">NAMESPACE     NAME                                    READY   STATUS    RESTARTS      AGE
</span></span><span class="line"><span class="cl">kube-system   coredns-5dd5756b68-c5xml                0/1     Pending   <span class="m">0</span>             35m
</span></span><span class="line"><span class="cl">kube-system   coredns-5dd5756b68-fgdzj                0/1     Pending   <span class="m">0</span>             35m
</span></span><span class="line"><span class="cl">kube-system   etcd-k8s-master-01                      1/1     Running   <span class="m">0</span>             35m
</span></span><span class="line"><span class="cl">kube-system   kube-apiserver-k8s-master-01            1/1     Running   <span class="m">0</span>             35m
</span></span><span class="line"><span class="cl">kube-system   kube-controller-manager-k8s-master-01   1/1     Running   <span class="m">1</span> <span class="o">(</span>19m ago<span class="o">)</span>   35m
</span></span><span class="line"><span class="cl">kube-system   kube-scheduler-k8s-master-01            1/1     Running   <span class="m">1</span> <span class="o">(</span>19m ago<span class="o">)</span>   35m
</span></span></code></pre></div><p>Now its time to jump over to my jumphost where I will do all the remaining configurations/interactions with my test-cluster-1.</p>


<h2 class="relative group">Install Cilium CNI 
    <div id="install-cilium-cni" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#install-cilium-cni" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>From my jumphost I already have all the tools I need to deploy Cilium. To install the Cilium CNI I will just use the cilium-cli tool as it is so easy. With a very short command it will automatically install Cilium on all my worker/control-plane nodes. The cilium-cli will act according to the kube context you are in, so make sure you are in the correct context (the context that needs Cilium to be installed):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@linuxmgmt01:~/test-cluster-1$ k config current-context
</span></span><span class="line"><span class="cl">test-cluster-1-admin@kubernetes
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">andreasm@linuxmgmt01:~/test-cluster-1$ cilium install --version 1.14.5
</span></span><span class="line"><span class="cl">ℹ️  Using Cilium version 1.14.5
</span></span><span class="line"><span class="cl">🔮 Auto-detected cluster name: test-cluster-1
</span></span><span class="line"><span class="cl">🔮 Auto-detected kube-proxy has not been installed
</span></span><span class="line"><span class="cl">ℹ️  Cilium will fully replace all functionalities of kube-proxy
</span></span></code></pre></div><p>Thats it&hellip;. &#x1f604;</p>
<p>Version 1.14.5 is the latest stable at the writing of this post.</p>


<h3 class="relative group">Install Cilium on a cluster with no kube-proxy 
    <div id="install-cilium-on-a-cluster-with-no-kube-proxy" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#install-cilium-on-a-cluster-with-no-kube-proxy" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>If I have prepared my cluster as above with no kube-proxy I need to install Cilium using the following command:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nv">API_SERVER_IP</span><span class="o">=</span>10.160.1.111
</span></span><span class="line"><span class="cl"><span class="nv">API_SERVER_PORT</span><span class="o">=</span><span class="m">6443</span>
</span></span><span class="line"><span class="cl">helm install cilium cilium/cilium --version 1.14.5 -f cilium.1.14.5.values-prod-cluster-1.yaml <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --namespace kube-system <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --set <span class="nv">kubeProxyReplacement</span><span class="o">=</span>strict <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --set <span class="nv">k8sServiceHost</span><span class="o">=</span><span class="si">${</span><span class="nv">API_SERVER_IP</span><span class="si">}</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --set <span class="nv">k8sServicePort</span><span class="o">=</span><span class="si">${</span><span class="nv">API_SERVER_PORT</span><span class="si">}</span>
</span></span></code></pre></div><p>Where the API_SERVER_PORT is one of my k8s control plane node (I did try to use the loadbalanced IP for the k8s api endpoint as I have 3 control plane nodes but that did not work out so I went with the IP of my first cp node). The value file is the value file I am using to set all the Cilium settings, more on that later.</p>
<p>Now, whats inside my Kubernetes cluster now:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@linuxmgmt01:~/test-cluster-1$ k get pods -A
</span></span><span class="line"><span class="cl">NAMESPACE     NAME                                    READY   STATUS    RESTARTS       AGE
</span></span><span class="line"><span class="cl">kube-system   cilium-6gx5b                            1/1     Running   <span class="m">0</span>              11m
</span></span><span class="line"><span class="cl">kube-system   cilium-bsqzw                            1/1     Running   <span class="m">1</span>              11m
</span></span><span class="line"><span class="cl">kube-system   cilium-ct8n4                            1/1     Running   <span class="m">0</span>              53s
</span></span><span class="line"><span class="cl">kube-system   cilium-operator-545dc68d55-fsh6s        1/1     Running   <span class="m">1</span>              11m
</span></span><span class="line"><span class="cl">kube-system   cilium-v7rdz                            1/1     Running   <span class="m">0</span>              5m9s
</span></span><span class="line"><span class="cl">kube-system   coredns-5dd5756b68-j9vwm                1/1     Running   <span class="m">0</span>              77s
</span></span><span class="line"><span class="cl">kube-system   coredns-5dd5756b68-mjbzk                1/1     Running   <span class="m">0</span>              78s
</span></span><span class="line"><span class="cl">kube-system   etcd-k8s-master-01                      1/1     Running   <span class="m">0</span>              136m
</span></span><span class="line"><span class="cl">kube-system   hubble-relay-d478c79c8-pbn4v            1/1     Running   <span class="m">0</span>              16m
</span></span><span class="line"><span class="cl">kube-system   kube-apiserver-k8s-master-01            1/1     Running   <span class="m">0</span>              136m
</span></span><span class="line"><span class="cl">kube-system   kube-controller-manager-k8s-master-01   1/1     Running   <span class="m">1</span> <span class="o">(</span>120m ago<span class="o">)</span>   136m
</span></span><span class="line"><span class="cl">kube-system   kube-scheduler-k8s-master-01            1/1     Running   <span class="m">1</span> <span class="o">(</span>120m ago<span class="o">)</span>   136m
</span></span></code></pre></div><p>Everything is up and running.
The Cilium cli contains a lot of useful features. Like checking the status of Cilium. Lets test that:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@linuxmgmt01:~/test-cluster-1$ cilium status
</span></span><span class="line"><span class="cl">    /¯¯<span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span> /¯¯<span class="se">\_</span>_/¯¯<span class="se">\ </span>   Cilium:             OK
</span></span><span class="line"><span class="cl"> <span class="se">\_</span>_/¯¯<span class="se">\_</span>_/    Operator:           OK
</span></span><span class="line"><span class="cl"> /¯¯<span class="se">\_</span>_/¯¯<span class="se">\ </span>   Envoy DaemonSet:    disabled <span class="o">(</span>using embedded mode<span class="o">)</span>
</span></span><span class="line"><span class="cl"> <span class="se">\_</span>_/¯¯<span class="se">\_</span>_/    Hubble Relay:       disabled
</span></span><span class="line"><span class="cl">    <span class="se">\_</span>_/       ClusterMesh:        disabled
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">DaemonSet              cilium             Desired: 4, Ready: 4/4, Available: 4/4
</span></span><span class="line"><span class="cl">Deployment             cilium-operator    Desired: 1, Ready: 1/1, Available: 1/1
</span></span><span class="line"><span class="cl">Containers:            cilium             Running: <span class="m">4</span>
</span></span><span class="line"><span class="cl">                       cilium-operator    Running: <span class="m">1</span>
</span></span><span class="line"><span class="cl">Cluster Pods:          2/2 managed by Cilium
</span></span><span class="line"><span class="cl">Helm chart version:    1.14.5
</span></span><span class="line"><span class="cl">Image versions         cilium-operator    quay.io/cilium/operator-generic:v1.14.5@sha256:303f9076bdc73b3fc32aaedee64a14f6f44c8bb08ee9e3956d443021103ebe7a: <span class="m">1</span>
</span></span><span class="line"><span class="cl">                       cilium             quay.io/cilium/cilium:v1.14.5@sha256:d3b287029755b6a47dee01420e2ea469469f1b174a2089c10af7e5e9289ef05b: <span class="m">4</span>
</span></span></code></pre></div><p>Looks great</p>
<p>Did you notice above that the Cilium installer discovered there was no kube-proxy and that it told me it will replace all the feature of kube-proxy? Well it did.. Lets check the config of Cilium and see if that is also reflected there. Look after this key-value:</p>
<p><code>kube-proxy-replacement                            strict</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@linuxmgmt01:~/test-cluster-1$ cilium config view
</span></span><span class="line"><span class="cl">agent-not-ready-taint-key                         node.cilium.io/agent-not-ready
</span></span><span class="line"><span class="cl">arping-refresh-period                             30s
</span></span><span class="line"><span class="cl">auto-direct-node-routes                           <span class="nb">false</span>
</span></span><span class="line"><span class="cl">bpf-lb-external-clusterip                         <span class="nb">false</span>
</span></span><span class="line"><span class="cl">bpf-lb-map-max                                    <span class="m">65536</span>
</span></span><span class="line"><span class="cl">bpf-lb-sock                                       <span class="nb">false</span>
</span></span><span class="line"><span class="cl">bpf-map-dynamic-size-ratio                        0.0025
</span></span><span class="line"><span class="cl">bpf-policy-map-max                                <span class="m">16384</span>
</span></span><span class="line"><span class="cl">bpf-root                                          /sys/fs/bpf
</span></span><span class="line"><span class="cl">cgroup-root                                       /run/cilium/cgroupv2
</span></span><span class="line"><span class="cl">cilium-endpoint-gc-interval                       5m0s
</span></span><span class="line"><span class="cl">cluster-id                                        <span class="m">0</span>
</span></span><span class="line"><span class="cl">cluster-name                                      test-cluster-1
</span></span><span class="line"><span class="cl">cluster-pool-ipv4-cidr                            10.0.0.0/8
</span></span><span class="line"><span class="cl">cluster-pool-ipv4-mask-size                       <span class="m">24</span>
</span></span><span class="line"><span class="cl">cni-exclusive                                     <span class="nb">true</span>
</span></span><span class="line"><span class="cl">cni-log-file                                      /var/run/cilium/cilium-cni.log
</span></span><span class="line"><span class="cl">cnp-node-status-gc-interval                       0s
</span></span><span class="line"><span class="cl">custom-cni-conf                                   <span class="nb">false</span>
</span></span><span class="line"><span class="cl">debug                                             <span class="nb">false</span>
</span></span><span class="line"><span class="cl">debug-verbose
</span></span><span class="line"><span class="cl">disable-cnp-status-updates                        <span class="nb">true</span>
</span></span><span class="line"><span class="cl">egress-gateway-reconciliation-trigger-interval    1s
</span></span><span class="line"><span class="cl">enable-auto-protect-node-port-range               <span class="nb">true</span>
</span></span><span class="line"><span class="cl">enable-bgp-control-plane                          <span class="nb">false</span>
</span></span><span class="line"><span class="cl">enable-bpf-clock-probe                            <span class="nb">false</span>
</span></span><span class="line"><span class="cl">enable-endpoint-health-checking                   <span class="nb">true</span>
</span></span><span class="line"><span class="cl">enable-health-check-nodeport                      <span class="nb">true</span>
</span></span><span class="line"><span class="cl">enable-health-checking                            <span class="nb">true</span>
</span></span><span class="line"><span class="cl">enable-hubble                                     <span class="nb">true</span>
</span></span><span class="line"><span class="cl">enable-ipv4                                       <span class="nb">true</span>
</span></span><span class="line"><span class="cl">enable-ipv4-big-tcp                               <span class="nb">false</span>
</span></span><span class="line"><span class="cl">enable-ipv4-masquerade                            <span class="nb">true</span>
</span></span><span class="line"><span class="cl">enable-ipv6                                       <span class="nb">false</span>
</span></span><span class="line"><span class="cl">enable-ipv6-big-tcp                               <span class="nb">false</span>
</span></span><span class="line"><span class="cl">enable-ipv6-masquerade                            <span class="nb">true</span>
</span></span><span class="line"><span class="cl">enable-k8s-networkpolicy                          <span class="nb">true</span>
</span></span><span class="line"><span class="cl">enable-k8s-terminating-endpoint                   <span class="nb">true</span>
</span></span><span class="line"><span class="cl">enable-l2-neigh-discovery                         <span class="nb">true</span>
</span></span><span class="line"><span class="cl">enable-l7-proxy                                   <span class="nb">true</span>
</span></span><span class="line"><span class="cl">enable-local-redirect-policy                      <span class="nb">false</span>
</span></span><span class="line"><span class="cl">enable-policy                                     default
</span></span><span class="line"><span class="cl">enable-remote-node-identity                       <span class="nb">true</span>
</span></span><span class="line"><span class="cl">enable-sctp                                       <span class="nb">false</span>
</span></span><span class="line"><span class="cl">enable-svc-source-range-check                     <span class="nb">true</span>
</span></span><span class="line"><span class="cl">enable-vtep                                       <span class="nb">false</span>
</span></span><span class="line"><span class="cl">enable-well-known-identities                      <span class="nb">false</span>
</span></span><span class="line"><span class="cl">enable-xt-socket-fallback                         <span class="nb">true</span>
</span></span><span class="line"><span class="cl">external-envoy-proxy                              <span class="nb">false</span>
</span></span><span class="line"><span class="cl">hubble-disable-tls                                <span class="nb">false</span>
</span></span><span class="line"><span class="cl">hubble-listen-address                             :4244
</span></span><span class="line"><span class="cl">hubble-socket-path                                /var/run/cilium/hubble.sock
</span></span><span class="line"><span class="cl">hubble-tls-cert-file                              /var/lib/cilium/tls/hubble/server.crt
</span></span><span class="line"><span class="cl">hubble-tls-client-ca-files                        /var/lib/cilium/tls/hubble/client-ca.crt
</span></span><span class="line"><span class="cl">hubble-tls-key-file                               /var/lib/cilium/tls/hubble/server.key
</span></span><span class="line"><span class="cl">identity-allocation-mode                          crd
</span></span><span class="line"><span class="cl">identity-gc-interval                              15m0s
</span></span><span class="line"><span class="cl">identity-heartbeat-timeout                        30m0s
</span></span><span class="line"><span class="cl">install-no-conntrack-iptables-rules               <span class="nb">false</span>
</span></span><span class="line"><span class="cl">ipam                                              cluster-pool
</span></span><span class="line"><span class="cl">ipam-cilium-node-update-rate                      15s
</span></span><span class="line"><span class="cl">k8s-client-burst                                  <span class="m">10</span>
</span></span><span class="line"><span class="cl">k8s-client-qps                                    <span class="m">5</span>
</span></span><span class="line"><span class="cl">kube-proxy-replacement                            strict
</span></span><span class="line"><span class="cl">kube-proxy-replacement-healthz-bind-address
</span></span><span class="line"><span class="cl">mesh-auth-enabled                                 <span class="nb">true</span>
</span></span><span class="line"><span class="cl">mesh-auth-gc-interval                             5m0s
</span></span><span class="line"><span class="cl">mesh-auth-queue-size                              <span class="m">1024</span>
</span></span><span class="line"><span class="cl">mesh-auth-rotated-identities-queue-size           <span class="m">1024</span>
</span></span><span class="line"><span class="cl">monitor-aggregation                               medium
</span></span><span class="line"><span class="cl">monitor-aggregation-flags                         all
</span></span><span class="line"><span class="cl">monitor-aggregation-interval                      5s
</span></span><span class="line"><span class="cl">node-port-bind-protection                         <span class="nb">true</span>
</span></span><span class="line"><span class="cl">nodes-gc-interval                                 5m0s
</span></span><span class="line"><span class="cl">operator-api-serve-addr                           127.0.0.1:9234
</span></span><span class="line"><span class="cl">preallocate-bpf-maps                              <span class="nb">false</span>
</span></span><span class="line"><span class="cl">procfs                                            /host/proc
</span></span><span class="line"><span class="cl">proxy-connect-timeout                             <span class="m">2</span>
</span></span><span class="line"><span class="cl">proxy-max-connection-duration-seconds             <span class="m">0</span>
</span></span><span class="line"><span class="cl">proxy-max-requests-per-connection                 <span class="m">0</span>
</span></span><span class="line"><span class="cl">proxy-prometheus-port                             <span class="m">9964</span>
</span></span><span class="line"><span class="cl">remove-cilium-node-taints                         <span class="nb">true</span>
</span></span><span class="line"><span class="cl">routing-mode                                      tunnel
</span></span><span class="line"><span class="cl">set-cilium-is-up-condition                        <span class="nb">true</span>
</span></span><span class="line"><span class="cl">set-cilium-node-taints                            <span class="nb">true</span>
</span></span><span class="line"><span class="cl">sidecar-istio-proxy-image                         cilium/istio_proxy
</span></span><span class="line"><span class="cl">skip-cnp-status-startup-clean                     <span class="nb">false</span>
</span></span><span class="line"><span class="cl">synchronize-k8s-nodes                             <span class="nb">true</span>
</span></span><span class="line"><span class="cl">tofqdns-dns-reject-response-code                  refused
</span></span><span class="line"><span class="cl">tofqdns-enable-dns-compression                    <span class="nb">true</span>
</span></span><span class="line"><span class="cl">tofqdns-endpoint-max-ip-per-hostname              <span class="m">50</span>
</span></span><span class="line"><span class="cl">tofqdns-idle-connection-grace-period              0s
</span></span><span class="line"><span class="cl">tofqdns-max-deferred-connection-deletes           <span class="m">10000</span>
</span></span><span class="line"><span class="cl">tofqdns-proxy-response-max-delay                  100ms
</span></span><span class="line"><span class="cl">tunnel-protocol                                   vxlan
</span></span><span class="line"><span class="cl">unmanaged-pod-watcher-interval                    <span class="m">15</span>
</span></span><span class="line"><span class="cl">vtep-cidr
</span></span><span class="line"><span class="cl">vtep-endpoint
</span></span><span class="line"><span class="cl">vtep-mac
</span></span><span class="line"><span class="cl">vtep-mask
</span></span><span class="line"><span class="cl">write-cni-conf-when-ready                         /host/etc/cni/net.d/05-cilium.conflist
</span></span></code></pre></div><p>One can also verify with this command:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@linuxmgmt01:~/test-cluster-1$ kubectl -n kube-system <span class="nb">exec</span> ds/cilium -- cilium status <span class="p">|</span> grep KubeProxyReplacement
</span></span><span class="line"><span class="cl">Defaulted container <span class="s2">&#34;cilium-agent&#34;</span> out of: cilium-agent, config <span class="o">(</span>init<span class="o">)</span>, mount-cgroup <span class="o">(</span>init<span class="o">)</span>, apply-sysctl-overwrites <span class="o">(</span>init<span class="o">)</span>, mount-bpf-fs <span class="o">(</span>init<span class="o">)</span>, clean-cilium-state <span class="o">(</span>init<span class="o">)</span>, install-cni-binaries <span class="o">(</span>init<span class="o">)</span>
</span></span><span class="line"><span class="cl">KubeProxyReplacement:    Strict   <span class="o">[</span>ens18 10.160.1.11 <span class="o">(</span>Direct Routing<span class="o">)]</span>
</span></span></code></pre></div><p>The feature to easily list all features and the status on them is valuable and a really helpful feature.</p>
<p>It took a couple of seconds and Cilium CNI was installed. Now the fun begins to explore some of the features. Lets tag along</p>


<h3 class="relative group">Enabling features using Helm 
    <div id="enabling-features-using-helm" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#enabling-features-using-helm" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>When I installed Cilium using the cilium-cli tool, it actually deploys using Helm in the background. Lets see if there is a Helm manifest in the kube-system:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@linuxmgmt01:~/test-cluster-1$ helm list -n kube-system
</span></span><span class="line"><span class="cl">NAME  	NAMESPACE  	REVISION	UPDATED                                	STATUS  	CHART        	APP VERSION
</span></span><span class="line"><span class="cl">cilium	kube-system	<span class="m">1</span>       	2023-12-19 13:50:40.121866679 +0000 UTC	deployed	cilium-1.14.5	1.14.5
</span></span></code></pre></div><p>Well there it is..</p>
<p>That makes it all more interesting. As I will use Helm to update certain parameters going forward in this post I will take a &ldquo;snapshot&rdquo; of the current values in the manifest above and altered in the next sections when I enabel additional features. How does the values look like now?</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="l">From the configMap cilium-config</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">agent-not-ready-taint-key</span><span class="p">:</span><span class="w"> </span><span class="l">node.cilium.io/agent-not-ready</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">arping-refresh-period</span><span class="p">:</span><span class="w"> </span><span class="l">30s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">auto-direct-node-routes</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;false&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">bpf-lb-external-clusterip</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;false&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">bpf-lb-map-max</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;65536&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">bpf-lb-sock</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;false&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">bpf-map-dynamic-size-ratio</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;0.0025&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">bpf-policy-map-max</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;16384&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">bpf-root</span><span class="p">:</span><span class="w"> </span><span class="l">/sys/fs/bpf</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">cgroup-root</span><span class="p">:</span><span class="w"> </span><span class="l">/run/cilium/cgroupv2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">cilium-endpoint-gc-interval</span><span class="p">:</span><span class="w"> </span><span class="l">5m0s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">cluster-id</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;0&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">cluster-name</span><span class="p">:</span><span class="w"> </span><span class="l">test-cluster-1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">cluster-pool-ipv4-cidr</span><span class="p">:</span><span class="w"> </span><span class="m">10.0.0.0</span><span class="l">/8</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">cluster-pool-ipv4-mask-size</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;24&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">cni-exclusive</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">cni-log-file</span><span class="p">:</span><span class="w"> </span><span class="l">/var/run/cilium/cilium-cni.log</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">cnp-node-status-gc-interval</span><span class="p">:</span><span class="w"> </span><span class="l">0s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">custom-cni-conf</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;false&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">debug</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;false&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">debug-verbose</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">disable-cnp-status-updates</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">egress-gateway-reconciliation-trigger-interval</span><span class="p">:</span><span class="w"> </span><span class="l">1s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">enable-auto-protect-node-port-range</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">enable-bgp-control-plane</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;false&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">enable-bpf-clock-probe</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;false&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">enable-endpoint-health-checking</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">enable-health-check-nodeport</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">enable-health-checking</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">enable-hubble</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">enable-ipv4</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">enable-ipv4-big-tcp</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;false&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">enable-ipv4-masquerade</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">enable-ipv6</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;false&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">enable-ipv6-big-tcp</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;false&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">enable-ipv6-masquerade</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">enable-k8s-networkpolicy</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">enable-k8s-terminating-endpoint</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">enable-l2-neigh-discovery</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">enable-l7-proxy</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">enable-local-redirect-policy</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;false&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">enable-policy</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">enable-remote-node-identity</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">enable-sctp</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;false&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">enable-svc-source-range-check</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">enable-vtep</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;false&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">enable-well-known-identities</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;false&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">enable-xt-socket-fallback</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">external-envoy-proxy</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;false&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">hubble-disable-tls</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;false&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">hubble-listen-address</span><span class="p">:</span><span class="w"> </span><span class="p">:</span><span class="m">4244</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">hubble-socket-path</span><span class="p">:</span><span class="w"> </span><span class="l">/var/run/cilium/hubble.sock</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">hubble-tls-cert-file</span><span class="p">:</span><span class="w"> </span><span class="l">/var/lib/cilium/tls/hubble/server.crt</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">hubble-tls-client-ca-files</span><span class="p">:</span><span class="w"> </span><span class="l">/var/lib/cilium/tls/hubble/client-ca.crt</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">hubble-tls-key-file</span><span class="p">:</span><span class="w"> </span><span class="l">/var/lib/cilium/tls/hubble/server.key</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">identity-allocation-mode</span><span class="p">:</span><span class="w"> </span><span class="l">crd</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">identity-gc-interval</span><span class="p">:</span><span class="w"> </span><span class="l">15m0s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">identity-heartbeat-timeout</span><span class="p">:</span><span class="w"> </span><span class="l">30m0s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">install-no-conntrack-iptables-rules</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;false&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ipam</span><span class="p">:</span><span class="w"> </span><span class="l">cluster-pool</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ipam-cilium-node-update-rate</span><span class="p">:</span><span class="w"> </span><span class="l">15s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">k8s-client-burst</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;10&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">k8s-client-qps</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;5&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">kube-proxy-replacement</span><span class="p">:</span><span class="w"> </span><span class="l">strict</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">kube-proxy-replacement-healthz-bind-address</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">mesh-auth-enabled</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">mesh-auth-gc-interval</span><span class="p">:</span><span class="w"> </span><span class="l">5m0s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">mesh-auth-queue-size</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;1024&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">mesh-auth-rotated-identities-queue-size</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;1024&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">monitor-aggregation</span><span class="p">:</span><span class="w"> </span><span class="l">medium</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">monitor-aggregation-flags</span><span class="p">:</span><span class="w"> </span><span class="l">all</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">monitor-aggregation-interval</span><span class="p">:</span><span class="w"> </span><span class="l">5s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">node-port-bind-protection</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">nodes-gc-interval</span><span class="p">:</span><span class="w"> </span><span class="l">5m0s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">operator-api-serve-addr</span><span class="p">:</span><span class="w"> </span><span class="m">127.0.0.1</span><span class="p">:</span><span class="m">9234</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">preallocate-bpf-maps</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;false&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">procfs</span><span class="p">:</span><span class="w"> </span><span class="l">/host/proc</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">proxy-connect-timeout</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">proxy-max-connection-duration-seconds</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;0&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">proxy-max-requests-per-connection</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;0&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">proxy-prometheus-port</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;9964&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">remove-cilium-node-taints</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">routing-mode</span><span class="p">:</span><span class="w"> </span><span class="l">tunnel</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">set-cilium-is-up-condition</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">set-cilium-node-taints</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">sidecar-istio-proxy-image</span><span class="p">:</span><span class="w"> </span><span class="l">cilium/istio_proxy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">skip-cnp-status-startup-clean</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;false&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">synchronize-k8s-nodes</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">tofqdns-dns-reject-response-code</span><span class="p">:</span><span class="w"> </span><span class="l">refused</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">tofqdns-enable-dns-compression</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">tofqdns-endpoint-max-ip-per-hostname</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;50&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">tofqdns-idle-connection-grace-period</span><span class="p">:</span><span class="w"> </span><span class="l">0s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">tofqdns-max-deferred-connection-deletes</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;10000&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">tofqdns-proxy-response-max-delay</span><span class="p">:</span><span class="w"> </span><span class="l">100ms</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">tunnel-protocol</span><span class="p">:</span><span class="w"> </span><span class="l">vxlan</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">unmanaged-pod-watcher-interval</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;15&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">vtep-cidr</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">vtep-endpoint</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">vtep-mac</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">vtep-mask</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">write-cni-conf-when-ready</span><span class="p">:</span><span class="w"> </span><span class="l">/host/etc/cni/net.d/05-cilium.conflist</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">meta.helm.sh/release-name</span><span class="p">:</span><span class="w"> </span><span class="l">cilium</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">meta.helm.sh/release-namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-system</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2023-12-19T13:50:42Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app.kubernetes.io/managed-by</span><span class="p">:</span><span class="w"> </span><span class="l">Helm</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cilium-config</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-system</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resourceVersion</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;4589&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">uid</span><span class="p">:</span><span class="w"> </span><span class="l">f501a3d0-8b33-43af-9fae-63625dcd6df1</span><span class="w">
</span></span></span></code></pre></div><p>These are the two settings that have been changed from being completely default:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="w">  </span><span class="nt">cluster-name</span><span class="p">:</span><span class="w"> </span><span class="l">test-cluster-1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">kube-proxy-replacement</span><span class="p">:</span><span class="w"> </span><span class="l">strict</span><span class="w">
</span></span></span></code></pre></div><p>I prefer editing the changes in a dedicated value.yaml file and run <em>helm upgrade -f value.yaml</em> each time I want to do a change so going forward I will be the adding/changing certain settings in this value.yaml file to update the settings in Cilium.</p>
<p>I grabbed the default value yaml from the Helm repo and use that to alter the settings in the next sections.</p>


<h3 class="relative group">Enabling features using Cilium cli 
    <div id="enabling-features-using-cilium-cli" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#enabling-features-using-cilium-cli" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>The cilium-cli can also be used to enable disable features certain features like Hubble and clustermesh. An example on how to install Hubble with cilium-cli is shown below in the next chapter, but I can also use Helm to achieve the same. I enable Hubble using cilium-cli just to show how easy it is.</p>
<p>But as I mention above, I prefer using the Helm method as I can keep better track of the settings and have them consistent each time I alter an update and refering to my value.yaml file.</p>


<h2 class="relative group">Observability and flow-monitoring - Hubble Observability 
    <div id="observability-and-flow-monitoring---hubble-observability" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#observability-and-flow-monitoring---hubble-observability" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>Cilium comes with a very neat monitor tool out of the box called Hubble. It is enabled by default but I need to enable the Hubble Relay and Hubble UI feature to get the information from my nodes, pods etc available in a nice dashboard (Hubble UI), so this is a feature I certainly want to enable as one of the first features to test out.</p>
<p>More details <a href="https://docs.cilium.io/en/stable/gettingstarted/hubble/" target="_blank">here</a> and <a href="https://docs.cilium.io/en/stable/gettingstarted/hubble_setup/" target="_blank">here</a></p>
<p>If I do a quick check with cilium cli now I can see the Hubble Relay is disabled.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@linuxmgmt01:~/test-cluster-1$ cilium status
</span></span><span class="line"><span class="cl">    /¯¯<span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span> /¯¯<span class="se">\_</span>_/¯¯<span class="se">\ </span>   Cilium:             OK
</span></span><span class="line"><span class="cl"> <span class="se">\_</span>_/¯¯<span class="se">\_</span>_/    Operator:           OK
</span></span><span class="line"><span class="cl"> /¯¯<span class="se">\_</span>_/¯¯<span class="se">\ </span>   Envoy DaemonSet:    disabled <span class="o">(</span>using embedded mode<span class="o">)</span>
</span></span><span class="line"><span class="cl"> <span class="se">\_</span>_/¯¯<span class="se">\_</span>_/    Hubble Relay:       disabled
</span></span><span class="line"><span class="cl">    <span class="se">\_</span>_/       ClusterMesh:        disabled
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">DaemonSet              cilium             Desired: 4, Ready: 4/4, Available: 4/4
</span></span><span class="line"><span class="cl">Deployment             cilium-operator    Desired: 1, Ready: 1/1, Available: 1/1
</span></span><span class="line"><span class="cl">Containers:            cilium             Running: <span class="m">4</span>
</span></span><span class="line"><span class="cl">                       cilium-operator    Running: <span class="m">1</span>
</span></span><span class="line"><span class="cl">Cluster Pods:          2/2 managed by Cilium
</span></span><span class="line"><span class="cl">Helm chart version:    1.14.5
</span></span><span class="line"><span class="cl">Image versions         cilium             quay.io/cilium/cilium:v1.14.5@sha256:d3b287029755b6a47dee01420e2ea469469f1b174a2089c10af7e5e9289ef05b: <span class="m">4</span>
</span></span><span class="line"><span class="cl">                       cilium-operator    quay.io/cilium/operator-generic:v1.14.5@sha256:303f9076bdc73b3fc32aaedee64a14f6f44c8bb08ee9e3956d443021103ebe7a: <span class="m">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">andreasm@linuxmgmt01:~/test-cluster-1$ k get svc -n kube-system
</span></span><span class="line"><span class="cl">NAME          TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>                  AGE
</span></span><span class="line"><span class="cl">hubble-peer   ClusterIP   10.23.182.223   &lt;none&gt;        443/TCP                  69m
</span></span><span class="line"><span class="cl">kube-dns      ClusterIP   10.23.0.10      &lt;none&gt;        53/UDP,53/TCP,9153/TCP   109m
</span></span></code></pre></div><p>To enable it, it is as simple as running this command:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@linuxmgmt01:~/test-cluster-1$ cilium hubble <span class="nb">enable</span>
</span></span></code></pre></div><p>This command enables the Hubble Relay.</p>
<p>Lets check the stats of Cilium:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@linuxmgmt01:~/test-cluster-1$ cilium status
</span></span><span class="line"><span class="cl">    /¯¯<span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span> /¯¯<span class="se">\_</span>_/¯¯<span class="se">\ </span>   Cilium:             OK
</span></span><span class="line"><span class="cl"> <span class="se">\_</span>_/¯¯<span class="se">\_</span>_/    Operator:           OK
</span></span><span class="line"><span class="cl"> /¯¯<span class="se">\_</span>_/¯¯<span class="se">\ </span>   Envoy DaemonSet:    disabled <span class="o">(</span>using embedded mode<span class="o">)</span>
</span></span><span class="line"><span class="cl"> <span class="se">\_</span>_/¯¯<span class="se">\_</span>_/    Hubble Relay:       OK
</span></span><span class="line"><span class="cl">    <span class="se">\_</span>_/       ClusterMesh:        disabled
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">DaemonSet              cilium             Desired: 4, Ready: 4/4, Available: 4/4
</span></span><span class="line"><span class="cl">Deployment             cilium-operator    Desired: 1, Ready: 1/1, Available: 1/1
</span></span><span class="line"><span class="cl">Deployment             hubble-relay       Desired: 1, Ready: 1/1, Available: 1/1
</span></span><span class="line"><span class="cl">Containers:            cilium             Running: <span class="m">4</span>
</span></span><span class="line"><span class="cl">                       cilium-operator    Running: <span class="m">1</span>
</span></span><span class="line"><span class="cl">                       hubble-relay       Running: <span class="m">1</span>
</span></span><span class="line"><span class="cl">Cluster Pods:          3/3 managed by Cilium
</span></span><span class="line"><span class="cl">Helm chart version:    1.14.5
</span></span><span class="line"><span class="cl">Image versions         cilium             quay.io/cilium/cilium:v1.14.5@sha256:d3b287029755b6a47dee01420e2ea469469f1b174a2089c10af7e5e9289ef05b: <span class="m">4</span>
</span></span><span class="line"><span class="cl">                       cilium-operator    quay.io/cilium/operator-generic:v1.14.5@sha256:303f9076bdc73b3fc32aaedee64a14f6f44c8bb08ee9e3956d443021103ebe7a: <span class="m">1</span>
</span></span><span class="line"><span class="cl">                       hubble-relay       quay.io/cilium/hubble-relay:v1.14.5@sha256:dbef89f924a927043d02b40c18e417c1ea0e8f58b44523b80fef7e3652db24d4: <span class="m">1</span>
</span></span></code></pre></div><p>Hubble Relay OK</p>
<p>Now I need to enable the Hubble UI.</p>
<p>Again, uisng Cilium-CLI its a very quick and simple operation:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@linuxmgmt01:~$ cilium hubble <span class="nb">enable</span> --ui
</span></span></code></pre></div><p>Lets check the services in my cluster:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@linuxmgmt01:~$ k get svc -n kube-system
</span></span><span class="line"><span class="cl">NAME           TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>                  AGE
</span></span><span class="line"><span class="cl">hubble-peer    ClusterIP   10.23.182.223   &lt;none&gt;        443/TCP                  6h19m
</span></span><span class="line"><span class="cl">hubble-relay   ClusterIP   10.23.182.76    &lt;none&gt;        80/TCP                   4h34m
</span></span><span class="line"><span class="cl">hubble-ui      ClusterIP   10.23.31.4      &lt;none&gt;        80/TCP                   42s
</span></span><span class="line"><span class="cl">kube-dns       ClusterIP   10.23.0.10      &lt;none&gt;        53/UDP,53/TCP,9153/TCP   6h59m
</span></span></code></pre></div><p>Hubble Relay and Hubble UI service is enabled. The issue though is that they are exposed using clusterIP, I need to reach them from the outside of my cluster. Lets continue with the next feature to test: LB-IPAM.</p>
<p><strong>Using Helm to enable Hubble Relay and Hubble-UI</strong></p>
<p>Instead of using clilium cli I would have enabled the Relay and UI in my value.yaml file and run the following command:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@linuxmgmt01:~/test-cluster-1$ helm upgrade -n kube-system cilium cilium/cilium --version 1.14.5 -f cilium-values-feature-by-feature.yaml
</span></span><span class="line"><span class="cl">Release <span class="s2">&#34;cilium&#34;</span> has been upgraded. Happy Helming!
</span></span><span class="line"><span class="cl">NAME: cilium
</span></span><span class="line"><span class="cl">LAST DEPLOYED: Tue Dec <span class="m">19</span> 20:32:12 <span class="m">2023</span>
</span></span><span class="line"><span class="cl">NAMESPACE: kube-system
</span></span><span class="line"><span class="cl">STATUS: deployed
</span></span><span class="line"><span class="cl">REVISION: <span class="m">13</span>
</span></span><span class="line"><span class="cl">TEST SUITE: None
</span></span><span class="line"><span class="cl">NOTES:
</span></span><span class="line"><span class="cl">You have successfully installed Cilium with Hubble Relay and Hubble UI.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Your release version is 1.14.5.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">For any further help, visit https://docs.cilium.io/en/v1.14/gettinghelp
</span></span></code></pre></div><p>Where I have changed these settings in the value.yaml:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="w"> </span><span class="nt">relay</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># -- Enable Hubble Relay (requires hubble.enabled=true)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="l">......</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="nt">ui</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># -- Whether to enable the Hubble UI.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="l">........</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="nt">hubble</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># -- Enable Hubble (true by default).</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">...</span><span class="l">.........</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># -- Buffer size of the channel Hubble uses to receive monitor events. If this</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># value is not set, the queue size is set to the default monitor queue size.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># eventQueueSize: &#34;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># -- Number of recent flows for Hubble to cache. Defaults to 4095.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># Possible values are:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c">#   1, 3, 7, 15, 31, 63, 127, 255, 511, 1023,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c">#   2047, 4095, 8191, 16383, 32767, 65535</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># eventBufferCapacity: &#34;4095&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># -- Hubble metrics configuration.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># See https://docs.cilium.io/en/stable/observability/metrics/#hubble-metrics</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># for more comprehensive documentation about Hubble metrics.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">metrics</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># -- Configures the list of metrics to collect. If empty or null, metrics</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># are disabled.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># Example:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c">#</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c">#   enabled:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c">#   - dns:query;ignoreAAAA</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c">#   - drop</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c">#   - tcp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c">#   - flow</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c">#   - icmp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c">#   - http</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c">#</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># You can specify the list of metrics from the helm CLI:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c">#</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c">#   --set metrics.enabled=&#34;{dns:query;ignoreAAAA,drop,tcp,flow,icmp,http}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c">#</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">dns:query;ignoreAAAA </span><span class="w"> </span><span class="c">### added these</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">drop                 </span><span class="w"> </span><span class="c">### added these</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">tcp                  </span><span class="w"> </span><span class="c">### added these</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">flow                 </span><span class="w"> </span><span class="c">### added these</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">icmp                 </span><span class="w"> </span><span class="c">### added these</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">http                 </span><span class="w"> </span><span class="c">### added these</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="l">.........</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"> 
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@linuxmgmt01:~/test-cluster-1$ cilium status
</span></span><span class="line"><span class="cl">    /¯¯<span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span> /¯¯<span class="se">\_</span>_/¯¯<span class="se">\ </span>   Cilium:             OK
</span></span><span class="line"><span class="cl"> <span class="se">\_</span>_/¯¯<span class="se">\_</span>_/    Operator:           OK
</span></span><span class="line"><span class="cl"> /¯¯<span class="se">\_</span>_/¯¯<span class="se">\ </span>   Envoy DaemonSet:    disabled <span class="o">(</span>using embedded mode<span class="o">)</span>
</span></span><span class="line"><span class="cl"> <span class="se">\_</span>_/¯¯<span class="se">\_</span>_/    Hubble Relay:       OK
</span></span><span class="line"><span class="cl">    <span class="se">\_</span>_/       ClusterMesh:        disabled
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Deployment             cilium-operator    Desired: 2, Ready: 2/2, Available: 2/2
</span></span><span class="line"><span class="cl">DaemonSet              cilium             Desired: 4, Ready: 4/4, Available: 4/4
</span></span><span class="line"><span class="cl">Deployment             hubble-ui          Desired: 1, Ready: 1/1, Available: 1/1
</span></span><span class="line"><span class="cl">Deployment             hubble-relay       Desired: 1, Ready: 1/1, Available: 1/1
</span></span><span class="line"><span class="cl">Containers:            cilium             Running: <span class="m">4</span>
</span></span><span class="line"><span class="cl">                       hubble-ui          Running: <span class="m">1</span>
</span></span><span class="line"><span class="cl">                       hubble-relay       Running: <span class="m">1</span>
</span></span><span class="line"><span class="cl">                       cilium-operator    Running: <span class="m">2</span>
</span></span><span class="line"><span class="cl">Cluster Pods:          4/4 managed by Cilium
</span></span><span class="line"><span class="cl">Helm chart version:    1.14.5
</span></span><span class="line"><span class="cl">Image versions         cilium             quay.io/cilium/cilium:v1.14.5@sha256:d3b287029755b6a47dee01420e2ea469469f1b174a2089c10af7e5e9289ef05b: <span class="m">4</span>
</span></span><span class="line"><span class="cl">                       hubble-ui          quay.io/cilium/hubble-ui:v0.12.1@sha256:9e5f81ee747866480ea1ac4630eb6975ff9227f9782b7c93919c081c33f38267: <span class="m">1</span>
</span></span><span class="line"><span class="cl">                       hubble-ui          quay.io/cilium/hubble-ui-backend:v0.12.1@sha256:1f86f3400827a0451e6332262467f894eeb7caf0eb8779bd951e2caa9d027cbe: <span class="m">1</span>
</span></span><span class="line"><span class="cl">                       hubble-relay       quay.io/cilium/hubble-relay:v1.14.5@sha256:dbef89f924a927043d02b40c18e417c1ea0e8f58b44523b80fef7e3652db24d4: <span class="m">1</span>
</span></span><span class="line"><span class="cl">                       cilium-operator    quay.io/cilium/operator-generic:v1.14.5@sha256:303f9076bdc73b3fc32aaedee64a14f6f44c8bb08ee9e3956d443021103ebe7a: <span class="m">2</span>
</span></span></code></pre></div><p>I will get back to the Hubble UI later&hellip;</p>


<h2 class="relative group">LB-IPAM 
    <div id="lb-ipam" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#lb-ipam" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>Exposing a service from Kubernetes to be accessible from outside the cluster can be done in a couple of ways:</p>
<ul>
<li>Exporting the service by binding it to a node using NodePort (not scalable and manageable).</li>
<li>Exporting the service using a servicetype of loadBalancer, only Layer4, though scalable. Usually requires external load balancer installed or some additional component installed and configured to support your Kubernetes platform.</li>
<li>Exporting using Ingress, Layer7, requires a loadbalancer to provide exernal IP address</li>
<li>Exporting using GatewayAPI (Ingress successor), requires a loadbalancer to provide exernal IP address.</li>
</ul>
<p>Cilium has really made it simple here, it comes with a built in LoadBalancer-IPAM. More info <a href="https://docs.cilium.io/en/stable/network/lb-ipam/" target="_blank">here</a>.</p>
<p>This is already enabled, no feature to install or enable. The only thing I need to do is to configure an IP pool that will provide ip addresses from a defined subnet when I request a serviceType loadBalancer, Ingress or Gateway. We can configure multiple pools with different subnets,  and configure a serviceSelector matching on labels or expressions.</p>
<p>In my lab I have already configured a couple of IP pools, using different subnets and different serviceSelectors so I can control which service gets IP addresses from which pool.</p>
<p>A couple of example pools from my lab:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;cilium.io/v2alpha1&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">CiliumLoadBalancerIPPool</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;gateway-api-pool-10.150.14.x&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">cidrs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">cidr</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;10.150.14.0/24&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">serviceSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchExpressions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- {<span class="nt">key: io.kubernetes.service.namespace, operator: In, values</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="l">harbor, booking]}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;cilium.io/v2alpha1&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">CiliumLoadBalancerIPPool</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;lb-pool-prod.10.150.11.x&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">cidrs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">cidr</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;10.150.11.0/24&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">serviceSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchExpressions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- {<span class="nt">key: env, operator: In, values</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="l">prod]}</span><span class="w">
</span></span></span></code></pre></div><p>The first pool will only provide IP addresses to services being deployed in any of the two namespaces &ldquo;harbor&rdquo; or &ldquo;booking&rdquo;. This is an &ldquo;OR&rdquo; selection, not AND, meaning it can be deployed in any of the namespaces, not both. The second will use lablels and match on the key-value: env=prod.</p>
<div class="notice info">
<p>Bear in mind that these IP Pools will only listen for services (serviceType loadBalancer) not Ingress pr say. That means each time you create an Ingress or a Gateway the serviceType loadBalancer will be auto-created as a reaction to the Ingress/Gateway creation. So if you try to create labels on the Ingress/Gatewat object it will not be noticed by the LB-IPAM pool. Instead you can adjust the selection based on the namespace you know it will be created in, or use this label that is auto-created on the svc: &ldquo;Labels:                   io.cilium.gateway/owning-gateway=&ldquo;name-of-gateway&rdquo;&rdquo;</p>
</div>
<p>As soon as you have created an ip-pool, applied it, it will immediately start to serve requests by providing IP addresses to them. This is very nice.
There is a small catch though. If I create IP Pools, as above, which is outside of my nodes subnet how does my network know how to reach these subnets? Creating static routes and pointing to my nodes that potentially holds these ip addresses? Nah.. Not scalable, nor manageable.  Some kind of dynamic routing protocol would be best here,  BGP or OSPF.
Did I mention that Cilium also includes support for BGP out of the box?</p>


<h2 class="relative group">BGP Control Plane 
    <div id="bgp-control-plane" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#bgp-control-plane" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>Yes, you guessed it, Cilium includes BGP. A brilliant way of advertising all my IP pools. Creating many IP pools with a bunch of subnets have never been more fun. This is the same concept as I write about <a href="https://blog.andreasm.io/2023/02/20/antrea-egress/" target="_blank">here</a>, the biggest difference is that with Cilium this only needs to be enabled as a feature and then define a yaml to confgure the bgp settings. Nothing additional to install, just Plug&rsquo;nPlay.</p>
<p>For more info on the BGP control plane, read <a href="https://docs.cilium.io/en/stable/network/bgp-control-plane/" target="_blank">here</a>.</p>
<p>First out, enable the BGP control plane feature. To enable it I will alter my Helm value.yaml file with this setting:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># -- This feature set enables virtual BGP routers to be created via</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># CiliumBGPPeeringPolicy CRDs.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">bgpControlPlane</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># -- Enables the BGP control plane.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span></code></pre></div><p>Then run the command:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">helm upgrade -n kube-system cilium cilium/cilium --version 1.14.5 -f cilium-values-feature-by-feature.yaml
</span></span></code></pre></div><p>This will enable the bgp control plane feature:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="l">andreasm@linuxmgmt01:~/test-cluster-1$ cilium config view</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">agent-not-ready-taint-key                         node.cilium.io/agent-not-ready</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">arping-refresh-period                             30s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">auto-direct-node-routes                           false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">bpf-lb-external-clusterip                         false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">bpf-lb-map-max                                    65536</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">bpf-lb-sock                                       false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">bpf-map-dynamic-size-ratio                        0.0025</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">bpf-policy-map-max                                16384</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">bpf-root                                          /sys/fs/bpf</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">cgroup-root                                       /run/cilium/cgroupv2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">cilium-endpoint-gc-interval                       5m0s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">cluster-id                                        0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">cluster-name                                      test-cluster-1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">cluster-pool-ipv4-cidr                            10.0.0.0/8</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">cluster-pool-ipv4-mask-size                       24</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">cni-exclusive                                     true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">cni-log-file                                      /var/run/cilium/cilium-cni.log</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">cnp-node-status-gc-interval                       0s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">custom-cni-conf                                   false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">debug                                             false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">disable-cnp-status-updates                        true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">egress-gateway-reconciliation-trigger-interval    1s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">enable-auto-protect-node-port-range               true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">enable-bgp-control-plane                          true</span><span class="w"> </span><span class="c">#### Here it is</span><span class="w">
</span></span></span></code></pre></div><p>Now I need to create a yaml that contains the BGP peering info I need for my workers to peer to my upstream router. For reference I will paste my lab topology here again:</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/12/18/a-quick-glance-at-cilium-cni/images/image-20231219124247767.png"
        alt="my-lab-topology"
      />
      
    </figure>
</p>
<p>When I apply my below BGPPeeringPolicy yaml, my nodes will enable a BGP peering session to the switch (their upstream bgp neighbor) they are connected to in the diagram above. This switch has also been configured to allow them as BGP neigbors. Please take into consideration creating some ip-prefix/route-maps so we dont accidentally advertise routes that confilcts, or should not be advertised into the network to prevent BGP blackholes etc&hellip;</p>
<p>Here is my BGP config I apply on my cluster:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;cilium.io/v2alpha1&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">CiliumBGPPeeringPolicy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="m">01</span>-<span class="l">bgp-peering-policy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="nt">nodeSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="nt">bgp-policy</span><span class="p">:</span><span class="w"> </span><span class="l">worker-nodes</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="nt">virtualRouters</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span>- <span class="nt">localASN</span><span class="p">:</span><span class="w"> </span><span class="m">64520</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="nt">serviceSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="nt">matchExpressions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- {<span class="nt">key: somekey, operator: NotIn, values</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;never-used-value&#39;</span><span class="p">]</span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="nt">exportPodCIDR</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="nt">neighbors</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">peerAddress</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;10.160.1.1/24&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">peerASN</span><span class="p">:</span><span class="w"> </span><span class="m">64512</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">eBGPMultihopTTL</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">connectRetryTimeSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">120</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">holdTimeSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">12</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">keepAliveTimeSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">4</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">gracefulRestart</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">restartTimeSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">120</span><span class="w">
</span></span></span></code></pre></div><p>Here we can also configure a serviceSelector to prevent services we dont want to be advertised. I used used the example from the official docs to allow everything. If I also have a good BGP route-map config on my switch side or upstream bgp neighbour subnets that are not allowed will never be advertised.</p>
<p>Now that I have applied it I can check the bgp peering status using the Cilium cli:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@linuxmgmt01:~/prod-cluster-1/cilium$ cilium bgp peers
</span></span><span class="line"><span class="cl">Node               Local AS   Peer AS   Peer Address   Session State   Uptime     Family         Received   Advertised
</span></span><span class="line"><span class="cl">k8s-prod-node-01   <span class="m">64520</span>      <span class="m">64512</span>     10.160.1.1     established     13h2m53s   ipv4/unicast   <span class="m">47</span>         <span class="m">6</span>
</span></span><span class="line"><span class="cl">                                                                                  ipv6/unicast   <span class="m">0</span>          <span class="m">0</span>
</span></span><span class="line"><span class="cl">k8s-prod-node-02   <span class="m">64520</span>      <span class="m">64512</span>     10.160.1.1     established     13h2m25s   ipv4/unicast   <span class="m">45</span>         <span class="m">6</span>
</span></span><span class="line"><span class="cl">                                                                                  ipv6/unicast   <span class="m">0</span>          <span class="m">0</span>
</span></span><span class="line"><span class="cl">k8s-prod-node-03   <span class="m">64520</span>      <span class="m">64512</span>     10.160.1.1     established     13h2m27s   ipv4/unicast   <span class="m">43</span>         <span class="m">6</span>
</span></span><span class="line"><span class="cl">                                                                                  ipv6/unicast   <span class="m">0</span>          <span class="m">0</span>
</span></span></code></pre></div><p>I can see some prefixes being Advertised and some being Received and the Session State is Established. I can also confirm that on my switch, and the routes they advertise:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">GUZ-SW-01# show ip bgp summary
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> Peer Information
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  Remote Address  Remote-AS Local-AS State         Admin Status
</span></span><span class="line"><span class="cl">  --------------- --------- -------- ------------- ------------
</span></span><span class="line"><span class="cl">  10.160.1.114    <span class="m">64520</span>     <span class="m">64512</span>    Established   Start
</span></span><span class="line"><span class="cl">  10.160.1.115    <span class="m">64520</span>     <span class="m">64512</span>    Established   Start
</span></span><span class="line"><span class="cl">  10.160.1.116    <span class="m">64520</span>     <span class="m">64512</span>    Established   Start
</span></span><span class="line"><span class="cl">  172.18.1.1      <span class="m">64500</span>     <span class="m">64512</span>    Established   Start
</span></span><span class="line"><span class="cl">GUZ-SW-01# show ip bgp
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  Local AS            : <span class="m">64512</span>         Local Router-id  : 172.18.1.2
</span></span><span class="line"><span class="cl">  BGP Table Version   : <span class="m">1706</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  Status codes: * - valid, &gt; - best, i - internal, e - external, s - stale
</span></span><span class="line"><span class="cl">  Origin codes: i - IGP, e - EGP, ? - incomplete
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     Network            Nexthop         Metric     LocalPref  Weight AsPath
</span></span><span class="line"><span class="cl">     ------------------ --------------- ---------- ---------- ------ ---------
</span></span><span class="line"><span class="cl">* e  10.150.11.10/32    10.160.1.114    <span class="m">0</span>                     <span class="m">0</span>      <span class="m">64520</span>    i
</span></span><span class="line"><span class="cl">*&gt;e  10.150.11.10/32    10.160.1.115    <span class="m">0</span>                     <span class="m">0</span>      <span class="m">64520</span>    i
</span></span><span class="line"><span class="cl">* e  10.150.11.10/32    10.160.1.116    <span class="m">0</span>                     <span class="m">0</span>      <span class="m">64520</span>    i
</span></span><span class="line"><span class="cl">* e  10.150.11.199/32   10.160.1.114    <span class="m">0</span>                     <span class="m">0</span>      <span class="m">64520</span>    i
</span></span><span class="line"><span class="cl">* e  10.150.11.199/32   10.160.1.115    <span class="m">0</span>                     <span class="m">0</span>      <span class="m">64520</span>    i
</span></span><span class="line"><span class="cl">*&gt;e  10.150.11.199/32   10.160.1.116    <span class="m">0</span>                     <span class="m">0</span>      <span class="m">64520</span>    i
</span></span><span class="line"><span class="cl">* e  10.150.12.4/32     10.160.1.114    <span class="m">0</span>                     <span class="m">0</span>      <span class="m">64520</span>    i
</span></span><span class="line"><span class="cl">* e  10.150.12.4/32     10.160.1.115    <span class="m">0</span>                     <span class="m">0</span>      <span class="m">64520</span>    i
</span></span><span class="line"><span class="cl">*&gt;e  10.150.12.4/32     10.160.1.116    <span class="m">0</span>                     <span class="m">0</span>      <span class="m">64520</span>    i
</span></span><span class="line"><span class="cl">* e  10.150.14.32/32    10.160.1.114    <span class="m">0</span>                     <span class="m">0</span>      <span class="m">64520</span>    i
</span></span><span class="line"><span class="cl">* e  10.150.14.32/32    10.160.1.115    <span class="m">0</span>                     <span class="m">0</span>      <span class="m">64520</span>    i
</span></span><span class="line"><span class="cl">*&gt;e  10.150.14.32/32    10.160.1.116    <span class="m">0</span>                     <span class="m">0</span>      <span class="m">64520</span>    i
</span></span><span class="line"><span class="cl">* e  10.150.14.150/32   10.160.1.114    <span class="m">0</span>                     <span class="m">0</span>      <span class="m">64520</span>    i
</span></span><span class="line"><span class="cl">*&gt;e  10.150.14.150/32   10.160.1.115    <span class="m">0</span>                     <span class="m">0</span>      <span class="m">64520</span>    i
</span></span><span class="line"><span class="cl">* e  10.150.14.150/32   10.160.1.116    <span class="m">0</span>                     <span class="m">0</span>      <span class="m">64520</span>    i
</span></span><span class="line"><span class="cl">* e  10.150.15.100/32   10.160.1.114    <span class="m">0</span>                     <span class="m">0</span>      <span class="m">64520</span>    i
</span></span><span class="line"><span class="cl">* e  10.150.15.100/32   10.160.1.115    <span class="m">0</span>                     <span class="m">0</span>      <span class="m">64520</span>    i
</span></span><span class="line"><span class="cl">*&gt;e  10.150.15.100/32   10.160.1.116    <span class="m">0</span>                     <span class="m">0</span>      <span class="m">64520</span>    i
</span></span></code></pre></div><p>Now I can just create my IP Pools, create some services and they should be immediately advertised and reachable in my network (unless they are being stopped by some route-maps ofcourse).</p>
<p>Note, it will only advertise ip-addresses in use by a service, not the whole subnet I define in my IP-Pools. That means I will only see host-routes advertised (as seen above).</p>


<h2 class="relative group">LB-IPAM - does it actually loadbalance? 
    <div id="lb-ipam---does-it-actually-loadbalance" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#lb-ipam---does-it-actually-loadbalance" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>It says LoadBalancer IPAM, but does it actually loadbalance? Let me quicly put that to a test.</p>
<p>I have exposed a web service using serviceType loadBalancer consisting of three simple nginx web pods.</p>
<p>Here is the yaml I am using (think I grabbed it from the offical Cilium docs)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">test-lb</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">example</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="nt">env</span><span class="p">:</span><span class="w"> </span><span class="l">prod</span><span class="w"> </span><span class="c">#### added this label to match with my ip pool</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">LoadBalancer</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">http</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">svc</span><span class="p">:</span><span class="w"> </span><span class="l">test-lb</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">example</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">svc</span><span class="p">:</span><span class="w"> </span><span class="l">test-lb</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">svc</span><span class="p">:</span><span class="w"> </span><span class="l">test-lb</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">web</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">IfNotPresent</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">readinessProbe</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">httpGet</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span></code></pre></div><p>Initially it deploys one pod, I will scale it up to three</p>
<p>They are running here, perfectly distributed across all my worker nodes:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@linuxmgmt01:~/prod-cluster-1/cilium$ k get pods -n example -owide
</span></span><span class="line"><span class="cl">NAME                     READY   STATUS    RESTARTS   AGE    IP           NODE               NOMINATED NODE   READINESS GATES
</span></span><span class="line"><span class="cl">nginx-698447f456-5xczj   1/1     Running   <span class="m">0</span>          18s    10.0.0.239   k8s-prod-node-01   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">nginx-698447f456-plknk   1/1     Running   <span class="m">0</span>          117s   10.0.4.167   k8s-prod-node-02   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">nginx-698447f456-xs4jq   1/1     Running   <span class="m">0</span>          18s    10.0.5.226   k8s-prod-node-03   &lt;none&gt;           &lt;none&gt;
</span></span></code></pre></div><p>And here is the LB service:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">example        test-lb                             LoadBalancer   10.21.69.190    10.150.11.48    80:31745/TCP
</span></span></code></pre></div><p>Now let me do a curl against the LoadBalancer IP and see if something changes:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">Every 0.5s: curl http://10.150.11.48                                               linuxmgmt01: Wed Dec <span class="m">20</span> 07:58:14 <span class="m">2023</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
</span></span><span class="line"><span class="cl">                                 Dload  Upload   Total   Spent    Left  Speed
</span></span><span class="line"><span class="cl">   <span class="m">0</span>     <span class="m">0</span>    <span class="m">0</span>     <span class="m">0</span>    <span class="m">0</span>     <span class="m">0</span>      <span class="m">0</span>      <span class="m">0</span> --:--:-- --:--:-- --:--:--     <span class="m">0</span> <span class="m">100</span>   <span class="m">567</span>  <span class="m">100</span>   <span class="m">567</span>    <span class="m">0</span>     <span class="m">0</span>   184k
</span></span><span class="line"><span class="cl">    <span class="m">0</span> --:--:-- --:--:-- --:--:--  276k
</span></span><span class="line"><span class="cl">&lt;!DOCTYPE html&gt;
</span></span><span class="line"><span class="cl">&lt;html&gt;
</span></span><span class="line"><span class="cl">&lt;head&gt;
</span></span><span class="line"><span class="cl">Pod <span class="m">2</span>   <span class="c1">##### Notice this </span>
</span></span><span class="line"><span class="cl">&lt;style&gt;
</span></span><span class="line"><span class="cl">html <span class="o">{</span> color-scheme: light dark<span class="p">;</span> <span class="o">}</span>
</span></span><span class="line"><span class="cl">body <span class="o">{</span> width: 35em<span class="p">;</span> margin: <span class="m">0</span> auto<span class="p">;</span>
</span></span><span class="line"><span class="cl">font-family: Tahoma, Verdana, Arial, sans-serif<span class="p">;</span> <span class="o">}</span>
</span></span><span class="line"><span class="cl">&lt;/style&gt;
</span></span><span class="line"><span class="cl">&lt;/head&gt;
</span></span><span class="line"><span class="cl">&lt;body&gt;
</span></span><span class="line"><span class="cl">Pod <span class="m">2</span>
</span></span><span class="line"><span class="cl">&lt;p&gt;If you see this page, the nginx web server is successfully installed and
</span></span><span class="line"><span class="cl">working. Further configuration is required.&lt;/p&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;p&gt;For online documentation and support please refer to
</span></span><span class="line"><span class="cl">&lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&#34;http://nginx.org/&#34;</span>&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;
</span></span><span class="line"><span class="cl">Commercial support is available at
</span></span><span class="line"><span class="cl">&lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&#34;http://nginx.com/&#34;</span>&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;p&gt;&lt;em&gt;Thank you <span class="k">for</span> using nginx.&lt;/em&gt;&lt;/p&gt;
</span></span><span class="line"><span class="cl">&lt;/body&gt;
</span></span><span class="line"><span class="cl">&lt;/html&gt;
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">Every 0.5s: curl http://10.150.11.48                                               linuxmgmt01: Wed Dec <span class="m">20</span> 07:59:15 <span class="m">2023</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
</span></span><span class="line"><span class="cl">                                 Dload  Upload   Total   Spent    Left  Speed
</span></span><span class="line"><span class="cl">   <span class="m">0</span>     <span class="m">0</span>    <span class="m">0</span>     <span class="m">0</span>    <span class="m">0</span>     <span class="m">0</span>      <span class="m">0</span>      <span class="m">0</span> --:--:-- --:--:-- --:--:--     <span class="m">0</span> <span class="m">100</span>   <span class="m">567</span>  <span class="m">100</span>   <span class="m">567</span>    <span class="m">0</span>     <span class="m">0</span>   110k
</span></span><span class="line"><span class="cl">    <span class="m">0</span> --:--:-- --:--:-- --:--:--  138k
</span></span><span class="line"><span class="cl">&lt;!DOCTYPE html&gt;
</span></span><span class="line"><span class="cl">&lt;html&gt;
</span></span><span class="line"><span class="cl">&lt;head&gt;
</span></span><span class="line"><span class="cl">Pod <span class="m">1</span>     <span class="c1">##### Notice this</span>
</span></span><span class="line"><span class="cl">&lt;style&gt;
</span></span><span class="line"><span class="cl">html <span class="o">{</span> color-scheme: light dark<span class="p">;</span> <span class="o">}</span>
</span></span><span class="line"><span class="cl">body <span class="o">{</span> width: 35em<span class="p">;</span> margin: <span class="m">0</span> auto<span class="p">;</span>
</span></span><span class="line"><span class="cl">font-family: Tahoma, Verdana, Arial, sans-serif<span class="p">;</span> <span class="o">}</span>
</span></span><span class="line"><span class="cl">&lt;/style&gt;
</span></span><span class="line"><span class="cl">&lt;/head&gt;
</span></span><span class="line"><span class="cl">&lt;body&gt;
</span></span><span class="line"><span class="cl">Pod <span class="m">1</span>
</span></span><span class="line"><span class="cl">&lt;p&gt;If you see this page, the nginx web server is successfully installed and
</span></span><span class="line"><span class="cl">working. Further configuration is required.&lt;/p&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;p&gt;For online documentation and support please refer to
</span></span><span class="line"><span class="cl">&lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&#34;http://nginx.org/&#34;</span>&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;
</span></span><span class="line"><span class="cl">Commercial support is available at
</span></span><span class="line"><span class="cl">&lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&#34;http://nginx.com/&#34;</span>&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;p&gt;&lt;em&gt;Thank you <span class="k">for</span> using nginx.&lt;/em&gt;&lt;/p&gt;
</span></span><span class="line"><span class="cl">&lt;/body&gt;
</span></span><span class="line"><span class="cl">&lt;/html&gt;
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">Every 0.5s: curl http://10.150.11.48                                               linuxmgmt01: Wed Dec <span class="m">20</span> 08:01:02 <span class="m">2023</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
</span></span><span class="line"><span class="cl">                                 Dload  Upload   Total   Spent    Left  Speed
</span></span><span class="line"><span class="cl">   <span class="m">0</span>     <span class="m">0</span>    <span class="m">0</span>     <span class="m">0</span>    <span class="m">0</span>     <span class="m">0</span>      <span class="m">0</span>      <span class="m">0</span> --:--:-- --:--:-- --:--:--     <span class="m">0</span> <span class="m">100</span>   <span class="m">567</span>  <span class="m">100</span>   <span class="m">567</span>    <span class="m">0</span>     <span class="m">0</span>   553k
</span></span><span class="line"><span class="cl">    <span class="m">0</span> --:--:-- --:--:-- --:--:--  553k
</span></span><span class="line"><span class="cl">&lt;!DOCTYPE html&gt;
</span></span><span class="line"><span class="cl">&lt;html&gt;
</span></span><span class="line"><span class="cl">&lt;head&gt;
</span></span><span class="line"><span class="cl">Pod <span class="m">3</span>    <span class="c1">##### Notice this</span>
</span></span><span class="line"><span class="cl">&lt;style&gt;
</span></span><span class="line"><span class="cl">html <span class="o">{</span> color-scheme: light dark<span class="p">;</span> <span class="o">}</span>
</span></span><span class="line"><span class="cl">body <span class="o">{</span> width: 35em<span class="p">;</span> margin: <span class="m">0</span> auto<span class="p">;</span>
</span></span><span class="line"><span class="cl">font-family: Tahoma, Verdana, Arial, sans-serif<span class="p">;</span> <span class="o">}</span>
</span></span><span class="line"><span class="cl">&lt;/style&gt;
</span></span><span class="line"><span class="cl">&lt;/head&gt;
</span></span><span class="line"><span class="cl">&lt;body&gt;
</span></span><span class="line"><span class="cl">Pod <span class="m">3</span>
</span></span><span class="line"><span class="cl">&lt;p&gt;If you see this page, the nginx web server is successfully installed and
</span></span><span class="line"><span class="cl">working. Further configuration is required.&lt;/p&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;p&gt;For online documentation and support please refer to
</span></span><span class="line"><span class="cl">&lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&#34;http://nginx.org/&#34;</span>&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;
</span></span><span class="line"><span class="cl">Commercial support is available at
</span></span><span class="line"><span class="cl">&lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&#34;http://nginx.com/&#34;</span>&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;p&gt;&lt;em&gt;Thank you <span class="k">for</span> using nginx.&lt;/em&gt;&lt;/p&gt;
</span></span><span class="line"><span class="cl">&lt;/body&gt;
</span></span><span class="line"><span class="cl">&lt;/html&gt;
</span></span></code></pre></div><p>Well, it is actually load-balancing the requests to the three different pods, running on three different nodes.
And it took me about 5 seconds to apply the ip-pool yaml and the bgppeeringpolicy yaml and I had a fully functioning load-balancer.</p>
<p>A bit more info on this feature from the offical Cilium docs:</p>
<blockquote>
<p>LB IPAM works in conjunction with features like the <a href="https://docs.cilium.io/en/stable/network/bgp-control-plane/#bgp-control-plane" target="_blank">Cilium BGP Control Plane (Beta)</a>. Where LB IPAM is responsible for allocation and assigning of IPs to Service objects and other features are responsible for load balancing and/or advertisement of these IPs.</p>
</blockquote>
<p>So I assume the actual loadbalancing is done by BGP here.</p>


<h2 class="relative group">Cilium Ingress 
    <div id="cilium-ingress" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#cilium-ingress" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>As I covered above serviceType loadBalancer, let me quickly cover how to enable Cilium IngressController.
More info can be found <a href="https://docs.cilium.io/en/stable/network/servicemesh/ingress/#gs-ingress" target="_blank">here</a></p>
<p>I will head into my Helm value.yaml and edit the following:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">ingressController</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># -- Enable cilium ingress controller</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># This will automatically set enable-envoy-config as well.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># -- Set cilium ingress controller to be the default ingress controller</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># This will let cilium ingress controller route entries without ingress class set</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">default</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># -- Default ingress load balancer mode</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># Supported values: shared, dedicated</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># For granular control, use the following annotations on the ingress resource</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># ingress.cilium.io/loadbalancer-mode: shared|dedicated,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">loadbalancerMode</span><span class="p">:</span><span class="w"> </span><span class="l">dedicated</span><span class="w">
</span></span></span></code></pre></div><p>The Cilium Ingress controller can be dedicated or shared, meaning that it can support a shared IP for multiple Ingress objects. Nice if we are IP limited etc. Additionally we can edit the shared Ingress to configured with a specific IP like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="w">  </span><span class="c"># -- Load-balancer service in shared mode.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># This is a single load-balancer service for all Ingress resources.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># -- Service name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cilium-ingress</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># -- Labels to be added for the shared LB service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">labels</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># -- Annotations to be added for the shared LB service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">annotations</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># -- Service type for the shared LB service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">LoadBalancer</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># -- Configure a specific nodePort for insecure HTTP traffic on the shared LB service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">insecureNodePort</span><span class="p">:</span><span class="w"> </span><span class="l">~</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># -- Configure a specific nodePort for secure HTTPS traffic on the shared LB service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">secureNodePort </span><span class="p">:</span><span class="w"> </span><span class="l">~</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># -- Configure a specific loadBalancerClass on the shared LB service (requires Kubernetes 1.24+)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">loadBalancerClass</span><span class="p">:</span><span class="w"> </span><span class="l">~</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># -- Configure a specific loadBalancerIP on the shared LB service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">loadBalancerIP </span><span class="p">:</span><span class="w"> </span><span class="m">10.150.11.100</span><span class="w"> </span><span class="c">### Set your preferred IP here</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># -- Configure if node port allocation is required for LB service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># ref: https://kubernetes.io/docs/concepts/services-networking/service/#load-balancer-nodeport-allocation</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">allocateLoadBalancerNodePorts</span><span class="p">:</span><span class="w"> </span><span class="l">~</span><span class="w">
</span></span></span></code></pre></div><p>This will dictate that the shared Ingress object will get this IP address.</p>
<p>Now save changes and run the helm upgrade command:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@linuxmgmt01:~/test-cluster-1$ helm upgrade -n kube-system cilium cilium/cilium --version 1.14.5 -f cilium-values-feature-by-feature.yaml
</span></span><span class="line"><span class="cl">Release <span class="s2">&#34;cilium&#34;</span> has been upgraded. Happy Helming!
</span></span><span class="line"><span class="cl">NAME: cilium
</span></span><span class="line"><span class="cl">LAST DEPLOYED: Wed Dec <span class="m">20</span> 08:18:58 <span class="m">2023</span>
</span></span><span class="line"><span class="cl">NAMESPACE: kube-system
</span></span><span class="line"><span class="cl">STATUS: deployed
</span></span><span class="line"><span class="cl">REVISION: <span class="m">15</span>
</span></span><span class="line"><span class="cl">TEST SUITE: None
</span></span><span class="line"><span class="cl">NOTES:
</span></span><span class="line"><span class="cl">You have successfully installed Cilium with Hubble Relay and Hubble UI.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Your release version is 1.14.5.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">For any further help, visit https://docs.cilium.io/en/v1.14/gettinghelp
</span></span></code></pre></div><p>Now is also a good time to restart the Cilium Operator and Cilium Agents to re-read the new configMap.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@linuxmgmt01:~/test-cluster-1$ kubectl -n kube-system rollout restart deployment/cilium-operator
</span></span><span class="line"><span class="cl">deployment.apps/cilium-operator restarted
</span></span><span class="line"><span class="cl">andreasm@linuxmgmt01:~/test-cluster-1$ kubectl -n kube-system rollout restart ds/cilium
</span></span><span class="line"><span class="cl">daemonset.apps/cilium restarted
</span></span></code></pre></div><p>Also check the Cilium status by running this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@linuxmgmt01:~/test-cluster-1$ cilium status
</span></span><span class="line"><span class="cl">    /¯¯<span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span> /¯¯<span class="se">\_</span>_/¯¯<span class="se">\ </span>   Cilium:             OK
</span></span><span class="line"><span class="cl"> <span class="se">\_</span>_/¯¯<span class="se">\_</span>_/    Operator:           OK
</span></span><span class="line"><span class="cl"> /¯¯<span class="se">\_</span>_/¯¯<span class="se">\ </span>   Envoy DaemonSet:    disabled <span class="o">(</span>using embedded mode<span class="o">)</span>
</span></span><span class="line"><span class="cl"> <span class="se">\_</span>_/¯¯<span class="se">\_</span>_/    Hubble Relay:       OK
</span></span><span class="line"><span class="cl">    <span class="se">\_</span>_/       ClusterMesh:        disabled
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Deployment             hubble-ui          Desired: 1, Ready: 1/1, Available: 1/1
</span></span><span class="line"><span class="cl">DaemonSet              cilium             Desired: 4, Ready: 4/4, Available: 4/4
</span></span><span class="line"><span class="cl">Deployment             cilium-operator    Desired: 2, Ready: 2/2, Available: 2/2
</span></span><span class="line"><span class="cl">Deployment             hubble-relay       Desired: 1, Ready: 1/1, Available: 1/1
</span></span><span class="line"><span class="cl">Containers:            cilium             Running: <span class="m">4</span>
</span></span><span class="line"><span class="cl">                       hubble-ui          Running: <span class="m">1</span>
</span></span><span class="line"><span class="cl">                       cilium-operator    Running: <span class="m">2</span>
</span></span><span class="line"><span class="cl">                       hubble-relay       Running: <span class="m">1</span>
</span></span><span class="line"><span class="cl">Cluster Pods:          4/4 managed by Cilium
</span></span><span class="line"><span class="cl">Helm chart version:    1.14.5
</span></span><span class="line"><span class="cl">Image versions         hubble-ui          quay.io/cilium/hubble-ui:v0.12.1@sha256:9e5f81ee747866480ea1ac4630eb6975ff9227f9782b7c93919c081c33f38267: <span class="m">1</span>
</span></span><span class="line"><span class="cl">                       hubble-ui          quay.io/cilium/hubble-ui-backend:v0.12.1@sha256:1f86f3400827a0451e6332262467f894eeb7caf0eb8779bd951e2caa9d027cbe: <span class="m">1</span>
</span></span><span class="line"><span class="cl">                       cilium-operator    quay.io/cilium/operator-generic:v1.14.5@sha256:303f9076bdc73b3fc32aaedee64a14f6f44c8bb08ee9e3956d443021103ebe7a: <span class="m">2</span>
</span></span><span class="line"><span class="cl">                       hubble-relay       quay.io/cilium/hubble-relay:v1.14.5@sha256:dbef89f924a927043d02b40c18e417c1ea0e8f58b44523b80fef7e3652db24d4: <span class="m">1</span>
</span></span><span class="line"><span class="cl">                       cilium             quay.io/cilium/cilium:v1.14.5@sha256:d3b287029755b6a47dee01420e2ea469469f1b174a2089c10af7e5e9289ef05b: <span class="m">4</span>
</span></span></code></pre></div><p>As soon as I enable the Ingress controller it will create this object for me, and provide an IngressClass in my cluster.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@linuxmgmt01:~/test-cluster-1$ k get ingressclasses.networking.k8s.io
</span></span><span class="line"><span class="cl">NAME     CONTROLLER                     PARAMETERS   AGE
</span></span><span class="line"><span class="cl">cilium   cilium.io/ingress-controller   &lt;none&gt;       86s
</span></span></code></pre></div><p>Now I suddenly have an IngressController also. Let me deploy a test app to test this.</p>
<p>First I deploy two pods with their corresponding clusterIP services:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">apple-app</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">apple</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">fruit</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">apple-app</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">hashicorp/http-echo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">args</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="s2">&#34;-text=apple&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">apple-service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">fruit</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">apple</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">5678</span><span class="w"> </span><span class="c"># Default port for image</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">banana-app</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">banana</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">fruit</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">banana-app</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">hashicorp/http-echo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">args</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="s2">&#34;-text=banana&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">banana-service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">fruit</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">banana</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">5678</span><span class="w"> </span><span class="c"># Default port for image</span><span class="w">
</span></span></span></code></pre></div><p>And then the Ingress pointing to the two services apple and banana:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">networking.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Ingress</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">ingress-example</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">fruit</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">env</span><span class="p">:</span><span class="w"> </span><span class="l">test</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ingress.cilium.io/loadbalancer-mode</span><span class="p">:</span><span class="w"> </span><span class="l">dedicated</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ingressClassName</span><span class="p">:</span><span class="w"> </span><span class="l">cilium</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l">fruit.my-domain.net</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">http</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">paths</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/apple</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l">Prefix</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">backend</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">apple-service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">port</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="m">5678</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/banana</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l">Prefix</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">backend</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">banana-service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">port</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="m">5678</span><span class="w">
</span></span></span></code></pre></div><p>Notice the only annotation I have used is the loadbalancer-mode: dedicated. The other value that is accepted is <em>shared</em>. By using this annotation I can choose on specific Ingresses whether they should be using the ip from the shared Ingress object or if I want it to be a dedicated one with its own IP address.  If I dont want this Ingress to consume a specific IP address I will use <em>shared</em>, if I want to create a dedicated IP for this Ingress I can use <em>dedicated</em>. The shared service for Ingress object is automatically created when enabling the IngressController. You can see this here:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@linuxmgmt01:~$ k get svc -n kube-system
</span></span><span class="line"><span class="cl">NAME                    TYPE           CLUSTER-IP      EXTERNAL-IP     PORT<span class="o">(</span>S<span class="o">)</span>                      AGE
</span></span><span class="line"><span class="cl">cilium-shared-ingress   LoadBalancer   10.21.104.15    10.150.15.100   80:30810/TCP,443:31104/TCP   46h
</span></span></code></pre></div><p>I have configured this shared-ingress to use a specific ip-address.
When using dedicated it will create a cilium-ingress-name-of-Ingress on a new IP address (as can be seen below).</p>
<p>As soon as this has been applied Cilium will automatically take care of the serviceType loadBalancer object by getting an IP address from one of the IP pools that matches my serviceSelections (depending on shared or dedicated ofcourse). Then BGP will automatically advertise the host-route to my BGP router. And the Ingress object should now be listening on HTTP requests on this IP.
Here is the services/objects created:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@linuxmgmt01:~/prod-cluster-1/cilium$ k get ingress -n fruit
</span></span><span class="line"><span class="cl">NAME              CLASS    HOSTS               ADDRESS       PORTS   AGE
</span></span><span class="line"><span class="cl">ingress-example   cilium   fruit.my-domain.net   10.150.12.4   <span class="m">80</span>      44h
</span></span><span class="line"><span class="cl">andreasm@linuxmgmt01:~/prod-cluster-1/cilium$ k get svc -n fruit
</span></span><span class="line"><span class="cl">NAME                             TYPE           CLUSTER-IP      EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>                      AGE
</span></span><span class="line"><span class="cl">apple-service                    ClusterIP      10.21.243.103   &lt;none&gt;        5678/TCP                     4d9h
</span></span><span class="line"><span class="cl">banana-service                   ClusterIP      10.21.124.111   &lt;none&gt;        5678/TCP                     4d9h
</span></span><span class="line"><span class="cl">cilium-ingress-ingress-example   LoadBalancer   10.21.50.107    10.150.12.4   80:30792/TCP,443:31553/TCP   43h
</span></span></code></pre></div><p>Let me see if the Ingress responds to my http requests (I have registered the IP above with a DNS record so I can resolve it):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@linuxmgmt01:~$ curl http://fruit.my-domain.net/apple
</span></span><span class="line"><span class="cl">apple
</span></span><span class="line"><span class="cl">andreasm@linuxmgmt01:~$ curl http://fruit.my-domain.net/banana
</span></span><span class="line"><span class="cl">banana
</span></span></code></pre></div><p>The Ingress works.
Again for more information on Cilium IngressController (like supported annotations etc) head over <a href="https://docs.cilium.io/en/stable/network/servicemesh/ingress/#gs-ingress" target="_blank">here</a></p>


<h2 class="relative group">Cilium Gateway API 
    <div id="cilium-gateway-api" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#cilium-gateway-api" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>Another ingress solution to use is Gateway API, read more about that <a href="https://gateway-api.sigs.k8s.io/" target="_blank">here</a></p>
<p>Gateway API is an &ldquo;evolution&rdquo; of the regular Ingress, so it would be natural to take this into consideration going forward. Again Cilium supports Gateway API out of the box, I will use Helm to enable it and it just needs a couple of CRDs to be installed.
Read more on Cilium API support <a href="https://docs.cilium.io/en/stable/network/servicemesh/gateway-api/gateway-api/" target="_blank">here</a>.</p>
<p>To enable Cilium Gateway API I did the following:</p>
<ul>
<li>Edit my Helm value.yaml with the following setting:</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">gatewayAPI</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># -- Enable support for Gateway API in cilium</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># This will automatically set enable-envoy-config as well.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span></code></pre></div><ul>
<li>Installed these CRDs before I ran the Helm upgrade command</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ kubectl apply -f https://raw.githubusercontent.com/kubernetes-sigs/gateway-api/v0.7.0/config/crd/standard/gateway.networking.k8s.io_gatewayclasses.yaml
</span></span><span class="line"><span class="cl">$ kubectl apply -f https://raw.githubusercontent.com/kubernetes-sigs/gateway-api/v0.7.0/config/crd/standard/gateway.networking.k8s.io_gateways.yaml
</span></span><span class="line"><span class="cl">$ kubectl apply -f https://raw.githubusercontent.com/kubernetes-sigs/gateway-api/v0.7.0/config/crd/standard/gateway.networking.k8s.io_httproutes.yaml
</span></span><span class="line"><span class="cl">$ kubectl apply -f https://raw.githubusercontent.com/kubernetes-sigs/gateway-api/v0.7.0/config/crd/standard/gateway.networking.k8s.io_referencegrants.yaml
</span></span><span class="line"><span class="cl">$ kubectl apply -f https://raw.githubusercontent.com/kubernetes-sigs/gateway-api/v0.7.0/config/crd/experimental/gateway.networking.k8s.io_tlsroutes.yaml
</span></span></code></pre></div><ul>
<li>Run the helm upgrade command:</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@linuxmgmt01:~/test-cluster-1$ helm upgrade -n kube-system cilium cilium/cilium --version 1.14.5 -f cilium-values-feature-by-feature.yaml
</span></span><span class="line"><span class="cl">Release <span class="s2">&#34;cilium&#34;</span> has been upgraded. Happy Helming!
</span></span><span class="line"><span class="cl">NAME: cilium
</span></span><span class="line"><span class="cl">LAST DEPLOYED: Wed Dec <span class="m">20</span> 11:12:55 <span class="m">2023</span>
</span></span><span class="line"><span class="cl">NAMESPACE: kube-system
</span></span><span class="line"><span class="cl">STATUS: deployed
</span></span><span class="line"><span class="cl">REVISION: <span class="m">16</span>
</span></span><span class="line"><span class="cl">TEST SUITE: None
</span></span><span class="line"><span class="cl">NOTES:
</span></span><span class="line"><span class="cl">You have successfully installed Cilium with Hubble Relay and Hubble UI.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Your release version is 1.14.5.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">For any further help, visit https://docs.cilium.io/en/v1.14/gettinghelp
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">andreasm@linuxmgmt01:~/test-cluster-1$ kubectl -n kube-system rollout restart deployment/cilium-operator
</span></span><span class="line"><span class="cl">deployment.apps/cilium-operator restarted
</span></span><span class="line"><span class="cl">andreasm@linuxmgmt01:~/test-cluster-1$ kubectl -n kube-system rollout restart ds/cilium
</span></span><span class="line"><span class="cl">daemonset.apps/cilium restarted
</span></span></code></pre></div><div class="notice info">
<p>It is very important to install the above CRDs first before attempting to enable the GatewayAPI in Cilium. Otherwise it will create any gatewayclass, aka no GatewayAPI realized.</p>
</div>
<p>Now I should have a gatewayClass:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@linuxmgmt01:~/test-cluster-1$ k get gatewayclasses.gateway.networking.k8s.io
</span></span><span class="line"><span class="cl">NAME     CONTROLLER                     ACCEPTED   AGE
</span></span><span class="line"><span class="cl">cilium   io.cilium/gateway-controller   True       96s
</span></span></code></pre></div><p>Now I can just go ahead and create a gateway and some httproutes. When it comes to providing an external IP address for my gateway, this is provided by my ip-pools the same way as for the IngressController.</p>
<p>Lets go ahead and create a gateway, and for this excercise  I will be creating a gateway with corresponding httproutes to support my Harbor registry installation.</p>
<p>Below is the config I have used, this has also been configured to do a https redirect (from http to https):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">gateway.networking.k8s.io/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Gateway</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">harbor-tls-gateway</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">harbor</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">gatewayClassName</span><span class="p">:</span><span class="w"> </span><span class="l">cilium</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">listeners</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">http</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">HTTP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">hostname</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;registry.my-domain.net&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">https</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#    allowedRoutes:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#      namespaces:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#        from: Same</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">HTTPS</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">443</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">hostname</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;registry.my-domain.net&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#    allowedRoutes:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#      namespaces:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#        from: Same</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">tls</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l">Terminate</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">certificateRefs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Secret</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">harbor-tls-prod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">harbor</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">gateway.networking.k8s.io/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">HTTPRoute</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">harbor-tls-redirect</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">harbor</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">parentRefs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">harbor-tls-gateway</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">sectionName</span><span class="p">:</span><span class="w"> </span><span class="l">http</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">harbor</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">hostnames</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">registry.my-domain.net</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">filters</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">RequestRedirect</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">requestRedirect</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">scheme</span><span class="p">:</span><span class="w"> </span><span class="l">https</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">443</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">gateway.networking.k8s.io/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">HTTPRoute</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">harbor-api-route</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">harbor</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">parentRefs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">harbor-tls-gateway</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">sectionName</span><span class="p">:</span><span class="w"> </span><span class="l">https</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">harbor</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">hostnames</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">registry.my-domain.net</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">matches</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">path</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">PathPrefix</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l">/api/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">backendRefs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">harbor</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">matches</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">path</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">PathPrefix</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l">/service/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">backendRefs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">harbor</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">matches</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">path</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">PathPrefix</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l">/v2/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">backendRefs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">harbor</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">matches</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">path</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">PathPrefix</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l">/chartrepo/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">backendRefs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">harbor</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">matches</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">path</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">PathPrefix</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l">/c/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">backendRefs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">harbor</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">matches</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">path</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">PathPrefix</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l">/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">backendRefs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">harbor-portal</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span></code></pre></div><p>I have already created the certificate as the secret I refer to in the yaml above.</p>
<p>Lets have a look at the gateway, httproutes and the svc that provides the external IP address , also the Harbor services the httproutes refer to:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">#### gateway created #####</span>
</span></span><span class="line"><span class="cl">andreasm@linuxmgmt01:~/prod-cluster-1/harbor$ k get gateway -n harbor
</span></span><span class="line"><span class="cl">NAME                 CLASS    ADDRESS        PROGRAMMED   AGE
</span></span><span class="line"><span class="cl">harbor-tls-gateway   cilium   10.150.14.32   True         28h
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">#### HTTPROUTES ####</span>
</span></span><span class="line"><span class="cl">andreasm@linuxmgmt01:~/prod-cluster-1/harbor$ k get httproutes.gateway.networking.k8s.io -n harbor
</span></span><span class="line"><span class="cl">NAME                  HOSTNAMES                  AGE
</span></span><span class="line"><span class="cl">harbor-api-route      <span class="o">[</span><span class="s2">&#34;registry.my-domain.net&#34;</span><span class="o">]</span>   28h
</span></span><span class="line"><span class="cl">harbor-tls-redirect   <span class="o">[</span><span class="s2">&#34;registry.my-domain.net&#34;</span><span class="o">]</span>   28h
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@linuxmgmt01:~/prod-cluster-1/harbor$ k get svc -n harbor
</span></span><span class="line"><span class="cl">NAME                                TYPE           CLUSTER-IP      EXTERNAL-IP    PORT<span class="o">(</span>S<span class="o">)</span>                      AGE
</span></span><span class="line"><span class="cl">cilium-gateway-harbor-tls-gateway   LoadBalancer   10.21.27.25     10.150.14.32   80:32393/TCP,443:31932/TCP   28h
</span></span></code></pre></div><p>Then the services that Harbor installs:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@linuxmgmt01:~/prod-cluster-1/harbor$ k get svc -n harbor
</span></span><span class="line"><span class="cl">NAME                                TYPE           CLUSTER-IP      EXTERNAL-IP    PORT<span class="o">(</span>S<span class="o">)</span>                      AGE
</span></span><span class="line"><span class="cl">harbor                              ClusterIP      10.21.101.75    &lt;none&gt;         80/TCP                       40h
</span></span><span class="line"><span class="cl">harbor-core                         ClusterIP      10.21.1.68      &lt;none&gt;         80/TCP                       40h
</span></span><span class="line"><span class="cl">harbor-database                     ClusterIP      10.21.193.216   &lt;none&gt;         5432/TCP                     40h
</span></span><span class="line"><span class="cl">harbor-jobservice                   ClusterIP      10.21.120.54    &lt;none&gt;         80/TCP                       40h
</span></span><span class="line"><span class="cl">harbor-portal                       ClusterIP      10.21.64.138    &lt;none&gt;         80/TCP                       40h
</span></span><span class="line"><span class="cl">harbor-redis                        ClusterIP      10.21.213.160   &lt;none&gt;         6379/TCP                     40h
</span></span><span class="line"><span class="cl">harbor-registry                     ClusterIP      10.21.212.118   &lt;none&gt;         5000/TCP,8080/TCP            40h
</span></span><span class="line"><span class="cl">harbor-trivy                        ClusterIP      10.21.138.224   &lt;none&gt;         8080/TCP                     40h
</span></span></code></pre></div><p>Now I can reach my Harbor using the UI and docker cli all through the Gateway API&hellip;</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/12/18/a-quick-glance-at-cilium-cni/images/image-20231220144715121.png"
        alt="harbor"
      />
      
    </figure>
</p>
<p>I will use Harbor in the next chapter with Hubble UI..</p>


<h2 class="relative group">Hubble UI 
    <div id="hubble-ui" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#hubble-ui" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>As you may recall, I did enable the two features Hubble Relay and Hubble UI as we can se below:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@linuxmgmt01:~$ k get svc -n kube-system
</span></span><span class="line"><span class="cl">NAME             TYPE           CLUSTER-IP      EXTERNAL-IP     PORT<span class="o">(</span>S<span class="o">)</span>                      AGE
</span></span><span class="line"><span class="cl">hubble-metrics   ClusterIP      None            &lt;none&gt;          9965/TCP                     35h
</span></span><span class="line"><span class="cl">hubble-peer      ClusterIP      10.23.182.223   &lt;none&gt;          443/TCP                      42h
</span></span><span class="line"><span class="cl">hubble-relay     ClusterIP      10.23.182.76    &lt;none&gt;          80/TCP                       40h
</span></span><span class="line"><span class="cl">hubble-ui        ClusterIP      10.23.31.4      &lt;none&gt;          80/TCP                       36h
</span></span></code></pre></div><p>It is not exposed so I can reach from outside the Kubernetes cluster. So let me first start by just creating a serviceType loadBalancer service to expose the Hubble UI clusterIP service. Below is the yaml I use for that:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">hubble-ui-lb</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-system</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">env</span><span class="p">:</span><span class="w"> </span><span class="l">prod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">&#34;io.cilium/lb-ipam-ips&#34;: </span><span class="s2">&#34;10.150.11.10&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">LoadBalancer</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8081</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">8081</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">http</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l">hubble-ui</span><span class="w">
</span></span></span></code></pre></div><p>Apply it and I should see the service:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@linuxmgmt01:~/prod-cluster-1/cilium/services$ k get svc -n kube-system
</span></span><span class="line"><span class="cl">NAME                    TYPE           CLUSTER-IP      EXTERNAL-IP     PORT<span class="o">(</span>S<span class="o">)</span>                      AGE
</span></span><span class="line"><span class="cl">hubble-ui-lb            LoadBalancer   10.21.47.47     10.150.11.10    8081:32328/TCP               3d11h
</span></span></code></pre></div><p>There it is, now open my browser and point to this ip:port</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/12/18/a-quick-glance-at-cilium-cni/images/image-20231221093222729.png"
        alt="hubble-ui-frontpage"
      />
      
    </figure>
</p>
<p>Now let me go to a test application I have deployed in the yelb namespace. Click on it from the list or the dropdown top left corner:</p>
<img src=images/image-20231221093346599.png style="width:400px" />
<p>Soo much empty&hellip;</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/12/18/a-quick-glance-at-cilium-cni/images/image-20231221093448609.png"
        alt="yelb-ns"
      />
      
    </figure>
</p>
<p>I can see the pods are running:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@linuxmgmt01:~/prod-cluster-1/cilium/services$ k get pods -n yelb
</span></span><span class="line"><span class="cl">NAME                            READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">redis-server-84f4bf49b5-fq26l   1/1     Running   <span class="m">0</span>          5d18h
</span></span><span class="line"><span class="cl">yelb-appserver-6dc7cd98-s6kt7   1/1     Running   <span class="m">0</span>          5d18h
</span></span><span class="line"><span class="cl">yelb-db-84d6f6fc6c-m7xvd        1/1     Running   <span class="m">0</span>          5d18h
</span></span></code></pre></div><p>They are probably not so interested in talking to each other unless they have to. Let me deploy the Fronted service and create some interactions.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@linuxmgmt01:~/prod-cluster-1/cilium$ k apply -f yelb-lb-frontend.yaml
</span></span><span class="line"><span class="cl">service/yelb-ui created
</span></span><span class="line"><span class="cl">deployment.apps/yelb-ui created
</span></span><span class="line"><span class="cl">andreasm@linuxmgmt01:~/prod-cluster-1/cilium$ k get svc -n yelb
</span></span><span class="line"><span class="cl">NAME             TYPE           CLUSTER-IP      EXTERNAL-IP     PORT<span class="o">(</span>S<span class="o">)</span>        AGE
</span></span><span class="line"><span class="cl">redis-server     ClusterIP      10.21.67.23     &lt;none&gt;          6379/TCP       5d18h
</span></span><span class="line"><span class="cl">yelb-appserver   ClusterIP      10.21.81.95     &lt;none&gt;          4567/TCP       5d18h
</span></span><span class="line"><span class="cl">yelb-db          ClusterIP      10.21.188.43    &lt;none&gt;          5432/TCP       5d18h
</span></span><span class="line"><span class="cl">yelb-ui          LoadBalancer   10.21.207.114   10.150.11.221   80:32335/TCP   49s
</span></span></code></pre></div><p>I will now open the Yelb UI and do some quick &ldquo;votes&rdquo;</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/12/18/a-quick-glance-at-cilium-cni/images/image-20231221093909070.png"
        alt="yelb-ui"
      />
      
    </figure>
</p>
<p>Instantly, even by just opening the yelb webpage I get a lot of flow information in Hubble. And not only that, it automatically creates a &ldquo;service-map&rdquo; so I can see the involved services in the Yelb app.</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/12/18/a-quick-glance-at-cilium-cni/images/image-20231221093840226.png"
        alt="yelb-hubble"
      />
      
    </figure>
</p>
<p>This will only show me L4 information. What about Layer 7? Lets test that also by heading over to Harbor</p>
<p>In Hubble I will switch to the namespace <em>harbor</em></p>
<p>A nice diagram with all involced services, but no L7 Information yet. Well there is, but I have no recent interactions to Harbor using the Gateway API, as soon as I use docker or web-ui against harbor what happens then?</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/12/18/a-quick-glance-at-cilium-cni/images/image-20231221094209948.png"
        alt="harbor-hubble-1"
      />
      
    </figure>
</p>
<p>Whats this, an ingress object?</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/12/18/a-quick-glance-at-cilium-cni/images/image-20231221094631886.png"
        alt="harbor-hubble-2"
      />
      
    </figure>
</p>
<p>Now when I click on the ingress object:</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/12/18/a-quick-glance-at-cilium-cni/images/image-20231221094803374.png"
        alt="harbor-ingress-l7"
      />
      
    </figure>
</p>
<p>Look at the L7 info coming there.</p>
<p>I logged out from Harbor:</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/12/18/a-quick-glance-at-cilium-cni/images/image-20231221094905742.png"
        alt="log-out"
      />
      
    </figure>
</p>
<p>Logged back in:</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/12/18/a-quick-glance-at-cilium-cni/images/image-20231221095015193.png"
        alt="log-in"
      />
      
    </figure>
</p>
<p>Browsing the Harbor Projects/repositories:</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/12/18/a-quick-glance-at-cilium-cni/images/image-20231221095055734.png"
        alt="browsing"
      />
      
    </figure>
</p>
<p>Very rich set of information presented in a very snappy and responsive dashbord. Its instantly updated as soon as there is a request coming.</p>
<p>For now, this concludes this post.</p>
<p>It has been a nice experience getting a bit more under the hood of Cilium, and so far I must say it looks very good.</p>


<h2 class="relative group">Things I have not covered yet wich I will at a later stage 
    <div id="things-i-have-not-covered-yet-wich-i-will-at-a-later-stage" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#things-i-have-not-covered-yet-wich-i-will-at-a-later-stage" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>I will update this post with some other features at a later stage. Some of the features I am interested looking at is:</p>
<ul>
<li>Security policies with Cilium - just have quick look <a href="https://docs.cilium.io/en/stable/security/" target="_blank">here</a> many interesting <a href="https://docs.cilium.io/en/stable/security/" target="_blank">topics</a>, Host Firewall?</li>
<li>Egress</li>
<li>Cilium Multi-Cluster</li>
</ul>

          
          
          
        </div>
        
        

        
        
  
  <section class="flex flex-row flex-wrap justify-center pt-4 text-xl">
    
      
      <a
      target="_blank"
      class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800"
      href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://blog.andreasm.io/2023/12/18/a-quick-glance-at-cilium-cni/&amp;title=A%20Quick%20Glance%20at%20Cilium%20CNI"
      title="Share on LinkedIn"
      aria-label="Share on LinkedIn"
      >
      

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg>

  </span>


    </a>
      
    
      
      <a
      target="_blank"
      class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800"
      href="https://twitter.com/intent/tweet/?url=https://blog.andreasm.io/2023/12/18/a-quick-glance-at-cilium-cni/&amp;text=A%20Quick%20Glance%20at%20Cilium%20CNI"
      title="Tweet on Twitter"
      aria-label="Tweet on Twitter"
      >
      

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8L200.7 275.5 26.8 48H172.4L272.9 180.9 389.2 48zM364.4 421.8h39.1L151.1 88h-42L364.4 421.8z"/></svg>
  </span>


    </a>
      
    
      
      <a
      target="_blank"
      class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800"
      href="https://s2f.kytta.dev/?text=A%20Quick%20Glance%20at%20Cilium%20CNI%20https://blog.andreasm.io/2023/12/18/a-quick-glance-at-cilium-cni/"
      title=""
      aria-label=""
      >
      

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48 0 0 0-63.72 28.5-63.72 125.7 0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54 0 0 1-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"/></svg>

  </span>


    </a>
      
    
      
      <a
      target="_blank"
      class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800"
      href="mailto:?body=https://blog.andreasm.io/2023/12/18/a-quick-glance-at-cilium-cni/&amp;subject=A%20Quick%20Glance%20at%20Cilium%20CNI"
      title="Send via email"
      aria-label="Send via email"
      >
      

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M207.8 20.73c-93.45 18.32-168.7 93.66-187 187.1c-27.64 140.9 68.65 266.2 199.1 285.1c19.01 2.888 36.17-12.26 36.17-31.49l.0001-.6631c0-15.74-11.44-28.88-26.84-31.24c-84.35-12.98-149.2-86.13-149.2-174.2c0-102.9 88.61-185.5 193.4-175.4c91.54 8.869 158.6 91.25 158.6 183.2l0 16.16c0 22.09-17.94 40.05-40 40.05s-40.01-17.96-40.01-40.05v-120.1c0-8.847-7.161-16.02-16.01-16.02l-31.98 .0036c-7.299 0-13.2 4.992-15.12 11.68c-24.85-12.15-54.24-16.38-86.06-5.106c-38.75 13.73-68.12 48.91-73.72 89.64c-9.483 69.01 43.81 128 110.9 128c26.44 0 50.43-9.544 69.59-24.88c24 31.3 65.23 48.69 109.4 37.49C465.2 369.3 496 324.1 495.1 277.2V256.3C495.1 107.1 361.2-9.332 207.8 20.73zM239.1 304.3c-26.47 0-48-21.56-48-48.05s21.53-48.05 48-48.05s48 21.56 48 48.05S266.5 304.3 239.1 304.3z"/></svg>

  </span>


    </a>
      
    
  </section>


        


<h2 class="mt-8 text-2xl font-extrabold mb-10">Related</h2>
<section class="w-full grid gap-4 sm:grid-cols-2 md:grid-cols-3">
  
  

  <a href="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/" class="min-w-full">
    
    <div class="min-h-full border border-neutral-200 dark:border-neutral-700 border-2 rounded overflow-hidden shadow-2xl relative">
        
        <div class="w-full thumbnail_card_related nozoom" style="background-image:url(/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/feature-antrea-1.png);"></div>
        
      

      <div class="px-6 py-4">

        
        <div class="font-bold text-xl text-neutral-800 decoration-primary-500 hover:underline hover:underline-offset-2 dark:text-neutral"
          href="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/">Securing Kubernetes clusters with Antrea Network Policies</div>
        

        <div class="text-sm text-neutral-500 dark:text-neutral-400">
          











  





  



  













<div class="flex flex-row flex-wrap items-center">
  
  
  <time datetime="2023-06-21T10:01:46&#43;02:00">21 June 2023</time><span class="px-2 text-primary-500">&middot;</span><span>6048 words</span><span class="px-2 text-primary-500">&middot;</span><span title="Reading time">29 mins</span>
  

  
  
</div>


<div class="flex flex-row flex-wrap items-center">
  
  
  
  
  
  
  
  
  
  
  
</div>




<div class="flex flex-row flex-wrap items-center">
  
  
  
  
  
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/kubernetes/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Kubernetes
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/cni/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    CNI
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/antrea/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Antrea
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/security/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Security
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/tmc/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    TMC
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/tanzu-mission-control/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Tanzu Mission Control
  </span>
</span>
  </span>
  
  
  
  
  
  
  
  
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/security/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Security
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/cni/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Cni
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/kubernetes/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Kubernetes
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/antrea/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Antrea
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/tmc/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Tmc
  </span>
</span>
  </span>
  
  
  
  
</div>




        </div>

        
        <div class="py-1 prose dark:prose-invert">
          In this post I will go through how to utilize Antrea Network policies with Tanzu Mission Control and a little bit NSX. So jump in and hopefully get some ideas how what we can do with Antrea Network Policies and how to use them.
        </div>
        
      </div>
      <div class="px-6 pt-4 pb-2">

      </div>
    </div>
  </a>

  
  

  <a href="/2023/09/25/antrea-multi-cluster-in-tkg-and-vsphere-with-tanzu/" class="min-w-full">
    
    <div class="min-h-full border border-neutral-200 dark:border-neutral-700 border-2 rounded overflow-hidden shadow-2xl relative">
        
        <div class="w-full thumbnail_card_related nozoom" style="background-image:url(/2023/09/25/antrea-multi-cluster-in-tkg-and-vsphere-with-tanzu/feature-antrea-1.png);"></div>
        
      

      <div class="px-6 py-4">

        
        <div class="font-bold text-xl text-neutral-800 decoration-primary-500 hover:underline hover:underline-offset-2 dark:text-neutral"
          href="/2023/09/25/antrea-multi-cluster-in-tkg-and-vsphere-with-tanzu/">Antrea Multi-cluster - in TKG and vSphere with Tanzu</div>
        

        <div class="text-sm text-neutral-500 dark:text-neutral-400">
          











  





  



  













<div class="flex flex-row flex-wrap items-center">
  
  
  <time datetime="2023-09-25T10:59:30&#43;02:00">25 September 2023</time><span class="px-2 text-primary-500">&middot;</span><span>11466 words</span><span class="px-2 text-primary-500">&middot;</span><span title="Reading time">54 mins</span>
  

  
  
</div>


<div class="flex flex-row flex-wrap items-center">
  
  
  
  
  
  
  
  
  
  
  
</div>




<div class="flex flex-row flex-wrap items-center">
  
  
  
  
  
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/kubernetes/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Kubernetes
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/cni/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    CNI
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/antrea/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Antrea
  </span>
</span>
  </span>
  
  
  
  
  
  
  
  
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/kubernetes/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Kubernetes
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/tanzu/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Tanzu
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/antrea/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Antrea
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/cni/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Cni
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/multi-cluster/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Multi-Cluster
  </span>
</span>
  </span>
  
  
  
  
</div>




        </div>

        
        <div class="py-1 prose dark:prose-invert">
          In this post I will go through how to configure and use the Antrea feature gate Multi-cluster in both TKGs and TKG
        </div>
        
      </div>
      <div class="px-6 pt-4 pb-2">

      </div>
    </div>
  </a>

  
  

  <a href="/2023/02/20/antrea-egress/" class="min-w-full">
    
    <div class="min-h-full border border-neutral-200 dark:border-neutral-700 border-2 rounded overflow-hidden shadow-2xl relative">
        
        <div class="w-full thumbnail_card_related nozoom" style="background-image:url(/2023/02/20/antrea-egress/feature-antrea-stacked-color3.webp);"></div>
        
      

      <div class="px-6 py-4">

        
        <div class="font-bold text-xl text-neutral-800 decoration-primary-500 hover:underline hover:underline-offset-2 dark:text-neutral"
          href="/2023/02/20/antrea-egress/">Antrea Egress</div>
        

        <div class="text-sm text-neutral-500 dark:text-neutral-400">
          











  





  



  













<div class="flex flex-row flex-wrap items-center">
  
  
  <time datetime="2023-02-20T15:42:54&#43;01:00">20 February 2023</time><span class="px-2 text-primary-500">&middot;</span><span>3485 words</span><span class="px-2 text-primary-500">&middot;</span><span title="Reading time">17 mins</span>
  

  
  
</div>


<div class="flex flex-row flex-wrap items-center">
  
  
  
  
  
  
  
  
  
  
  
</div>




<div class="flex flex-row flex-wrap items-center">
  
  
  
  
  
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/kubernetes/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Kubernetes
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/networking/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Networking
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/cni/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    CNI
  </span>
</span>
  </span>
  
  
  
  
  
  
  
  
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/antrea/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Antrea
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/kubernetes/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Kubernetes
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/tanzu/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Tanzu
  </span>
</span>
  </span>
  
  
  
  
</div>




        </div>

        
        <div class="py-1 prose dark:prose-invert">
          Antrea Egress: # What is Egress when we talk about Kubernetes?
        </div>
        
      </div>
      <div class="px-6 pt-4 pb-2">

      </div>
    </div>
  </a>

  
</section>

  
      </div>
     
      
      
        
        
          
          
        
      <script>
        var oid = "views_posts\/2023-12-18-a-quick-glance-at-cilium\/index.md"
        var oid_likes = "likes_posts\/2023-12-18-a-quick-glance-at-cilium\/index.md"
      </script>
      
      
      <script type="text/javascript" src="/js/page.min.0860cf4e04fa2d72cc33ddba263083464d48f67de06114529043cb4623319efed4f484fd7f1730df5abea0e2da6f3538855634081d02f2d6e920b956f063e823.js" integrity="sha512-CGDPTgT6LXLMM926JjCDRk1I9n3gYRRSkEPLRiMxnv7U9IT9fxcw31q&#43;oOLabzU4hVY0CB0C8tbpILlW8GPoIw=="></script>
      
  
    </section>
  <footer class="pt-8 max-w-prose print:hidden">

    
  
    
    
    
    <div class="pt-8">
      <hr class="border-dotted border-neutral-300 dark:border-neutral-600" />
      <div class="flex justify-between pt-3">
        <span>
          
            <a class="flex group mr-3" href="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/">
              <span
                class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400"
                >&larr;</span
              >
              <span
                class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400"
                >&rarr;</span
              >
              <span class="flex flex-col">
                <span
                  class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500"
                  >TKGi with NSX and NSX Advanced LoadBalancer</span
                >
                <span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400">
                  
                    <time datetime="2023-11-23T08:17:49&#43;01:00">23 November 2023</time>
                  
                </span>
              </span>
            </a>
          
        </span>
        <span>
          
            <a class="flex text-right group ml-3" href="/2023/12/26/traefik-proxy-in-kubernetes/">
              <span class="flex flex-col">
                <span
                  class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500"
                  >Traefik Proxy in Kubernetes</span
                >
                <span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400">
                  
                    <time datetime="2023-12-26T20:31:45&#43;01:00">26 December 2023</time>
                  
                </span>
              </span>
              <span
                class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400"
                >&rarr;</span
              >
              <span
                class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400"
                >&larr;</span
              >
            </a>
          
        </span>
      </div>
    </div>
  


    
  </footer>
</article>

      <div id="top-scroller" class="pointer-events-none absolute top-[110vh] bottom-0 w-12 ltr:right-0 rtl:left-0">
  <a href="#the-top"
    class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 mb-16 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400"
    aria-label="Scroll to top" title="Scroll to top">
    &uarr;
  </a>
</div>
    </main><footer id="site-footer" class="py-10 print:hidden">
  
  
    
    <nav class="flex flex-row pb-4 text-base font-medium text-neutral-500 dark:text-neutral-400">
      <ul class="flex flex-col list-none sm:flex-row">
        
        <li class="flex mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0">
          <a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2 flex items-center" href="/tags/"
            title="">
            
            Tags
          </a>
        </li>
        
        <li class="flex mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0">
          <a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2 flex items-center" href="/categories/"
            title="">
            
            Categories
          </a>
        </li>
        
      </ul>
    </nav>
    
  
  <div class="flex items-center justify-between">

    
    
    <p class="text-sm text-neutral-500 dark:text-neutral-400">
      &copy;
      2025
      Andreas Marqvardsen
    </p>
    

    
    
    <p class="text-xs text-neutral-500 dark:text-neutral-400">
      
      
      Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500"
        href="https://gohugo.io/" target="_blank" rel="noopener noreferrer">Hugo</a> &amp; <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500"
        href="https://blowfish.page/" target="_blank" rel="noopener noreferrer">Blowfish</a>
    </p>
    

  </div>
  <script>
    
    mediumZoom(document.querySelectorAll("img:not(.nozoom)"), {
      margin: 24,
      background: 'rgba(0,0,0,0.5)',
      scrollOffset: 0,
    })
    
  </script>
  
  
  <script type="text/javascript" src="/js/process.min.ee03488f19c93c2efb199e2e3014ea5f3cb2ce7d45154adb3399a158cac27ca52831db249ede5bb602700ef87eb02434139de0858af1818ab0fb4182472204a4.js" integrity="sha512-7gNIjxnJPC77GZ4uMBTqXzyyzn1FFUrbM5mhWMrCfKUoMdsknt5btgJwDvh&#43;sCQ0E53ghYrxgYqw&#43;0GCRyIEpA=="></script>
  
  
</footer>
<div
  id="search-wrapper"
  class="invisible fixed inset-0 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh]"
  data-url="https://blog.andreasm.io/"
  style="z-index:500"
>
  <div
    id="search-modal"
    class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"
  >
    <header class="relative z-10 flex items-center justify-between flex-none px-2">
      <form class="flex items-center flex-auto min-w-0">
        <div class="flex items-center justify-center w-8 h-8 text-neutral-400">
          

  <span class="relative block icon">
    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>

  </span>


        </div>
        <input
          type="search"
          id="search-query"
          class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent"
          placeholder="Search"
          tabindex="0"
        />
      </form>
      <button
        id="close-search-button"
        class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400"
        title="Close (Esc)"
      >
        

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75 0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3L54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75 0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75 0-45.25s32.75-12.5 45.25 0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25 0s12.5 32.75 0 45.25l-105.4 105.4L310.6 361.4z"/></svg>

  </span>


      </button>
    </header>
    <section class="flex-auto px-2 overflow-auto">
      <ul id="search-results">
        
      </ul>
    </section>
  </div>
</div>

  </div>
</body>

</html>
