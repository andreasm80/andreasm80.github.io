
<!DOCTYPE html>
<html
  lang="en"
  data-figures=""
  
    class="page"
  
  
  
    data-mode="dim"
  >
  <head>
<title>A Quick Glance at Cilium CNI | From 0.985mhz... to several Ghz</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-TVPYDVE8KR"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-TVPYDVE8KR');
</script>



  
<meta property="og:locale" content="en" />

<meta property="og:type" content="article">
<meta name="description" content="Deploying Cilium in my upstream K8s cluster and test some features" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:creator" content="">
<meta name="twitter:title" content="A Quick Glance at Cilium CNI" />
<meta name="twitter:image" content="https://blog.andreasm.io/2023/12/18/a-quick-glance-at-cilium-cni/images/logo-1-cilium.png"/>
<meta property="og:url" content="https://blog.andreasm.io/2023/12/18/a-quick-glance-at-cilium-cni/" />
<meta property="og:title" content="A Quick Glance at Cilium CNI" />
<meta property="og:description" content="Deploying Cilium in my upstream K8s cluster and test some features" />
<meta property="og:image" content="https://blog.andreasm.io/2023/12/18/a-quick-glance-at-cilium-cni/images/logo-1-cilium.png" />
  <meta name="keywords" content="nsx,vmware,networking,infrastucture,lodbalancing,tanzu,security,cni,antrea,cilium,kubernetes" />

<link rel="apple-touch-icon" sizes="180x180" href="https://blog.andreasm.io/icons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://blog.andreasm.io/icons/favicon-32x32.png">
<link rel="manifest" href="https://blog.andreasm.io/icons/site.webmanifest">

<link rel="canonical" href="https://blog.andreasm.io/2023/12/18/a-quick-glance-at-cilium-cni/">



<link rel="preload" href="https://blog.andreasm.io/css/styles.6c67fa3a7f5290a2facfb027358dd2bdb5450d04b8de427c8a74d79f524a7fb716b470b14b6ba95f1b7cf3aa9a2219a7294a6adeaf16a1080f432eae45d8c03c.css" integrity = "sha512-bGf6On9SkKL6z7AnNY3SvbVFDQS43kJ8inTXn1JKf7cWtHCxS2upXxt886qaIhmnKUpq3q8WoQgPQy6uRdjAPA==" as="style" crossorigin="anonymous">



<link rel="preload" href="https://blog.andreasm.io/en/js/bundle.5548d358738600c857a1f05f0459418da7143d4426c66a08bf3f15ded1b39dd2136bf104a559247a909fc4dcc45b8e06bad0870ece4c71ee5303d30550def8bd.js" as="script" integrity=
"sha512-VUjTWHOGAMhXofBfBFlBjacUPUQmxmoIvz8V3tGzndITa/EEpVkkepCfxNzEW44GutCHDs5Mce5TA9MFUN74vQ==" crossorigin="anonymous">


<link rel="stylesheet" type="text/css" href="https://blog.andreasm.io/css/styles.6c67fa3a7f5290a2facfb027358dd2bdb5450d04b8de427c8a74d79f524a7fb716b470b14b6ba95f1b7cf3aa9a2219a7294a6adeaf16a1080f432eae45d8c03c.css" integrity="sha512-bGf6On9SkKL6z7AnNY3SvbVFDQS43kJ8inTXn1JKf7cWtHCxS2upXxt886qaIhmnKUpq3q8WoQgPQy6uRdjAPA==" crossorigin="anonymous">


  </head>
  <body
    data-code="15"
    data-lines="false"
    id="documentTop"
    data-lang="en"
  >

<header class="nav_header" >
  <nav class="nav"><a href='https://blog.andreasm.io/' class="nav_brand nav_item" title="From 0.985mhz... to several Ghz">
  <img src="https://blog.andreasm.io/quote3.png" class="logo" alt="From 0.985mhz... to several Ghz">
  <div class="nav_close">
    <div><svg class="icon">
  <title>open-menu</title>
  <use xlink:href="#open-menu"></use>
</svg>
<svg class="icon">
  <title>closeme</title>
  <use xlink:href="#closeme"></use>
</svg>
</div>
  </div>
</a>

    <div class='nav_body nav_body_left'>
      
      
      
        

  <div class="nav_parent">
    <a href="https://blog.andreasm.io/" class="nav_item" title="Home">Home </a>
  </div>
  <div class="nav_parent">
    <a href="https://blog.andreasm.io/about/" class="nav_item" title="About">About </a>
  </div>
      
<div class='follow'>
    
  <a href="https://blog.andreasm.io/index.xml">
    <svg class="icon">
  <title>rss</title>
  <use xlink:href="#rss"></use>
</svg>

  </a>
<div class="color_mode">
  <input type="checkbox" class="color_choice" id="mode">
</div>

</div>

    </div>
  </nav>
</header>

    <main>
  
<div class="grid-inverse wrap content">
  <article class="post_content">
    <h1 class="post_title">A Quick Glance at Cilium CNI</h1>
  <div class="post_meta">
    <span><svg class="icon">
  <title>calendar</title>
  <use xlink:href="#calendar"></use>
</svg>
</span>
    <span class="post_date">
      18-12-2023</span>
    <span class="post_time"> ¬∑ 41 min read</span><span>&nbsp;¬∑ <a href='https://blog.andreasm.io/tags/cilium/' title="cilium" class="post_tag button button_translucent">cilium
        </a><a href='https://blog.andreasm.io/tags/kubernetes/' title="kubernetes" class="post_tag button button_translucent">kubernetes
        </a><a href='https://blog.andreasm.io/tags/cni/' title="cni" class="post_tag button button_translucent">cni
        </a><a href='https://blog.andreasm.io/tags/networking/' title="networking" class="post_tag button button_translucent">networking
        </a><a href='https://blog.andreasm.io/tags/ebpf/' title="ebpf" class="post_tag button button_translucent">ebpf
        </a>
    </span>
    <span class="page_only">&nbsp;¬∑
  <div class="post_share">
    Share on:
    <a href="https://twitter.com/intent/tweet?text=A%20Quick%20Glance%20at%20Cilium%20CNI&url=https%3a%2f%2fblog.andreasm.io%2f2023%2f12%2f18%2fa-quick-glance-at-cilium-cni%2f&tw_p=tweetbutton" class="twitter" title="Share on Twitter" target="_blank" rel="nofollow">
      <svg class="icon">
  <title>twitter</title>
  <use xlink:href="#twitter"></use>
</svg>

    </a>
    <a href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fblog.andreasm.io%2f2023%2f12%2f18%2fa-quick-glance-at-cilium-cni%2f&t=A%20Quick%20Glance%20at%20Cilium%20CNI" class="facebook" title="Share on Facebook" target="_blank" rel="nofollow">
      <svg class="icon">
  <title>facebook</title>
  <use xlink:href="#facebook"></use>
</svg>

    </a>
    <a href="#linkedinshare" id = "linkedinshare" class="linkedin" title="Share on LinkedIn" rel="nofollow">
      <svg class="icon">
  <title>linkedin</title>
  <use xlink:href="#linkedin"></use>
</svg>

    </a>
    <a href="https://blog.andreasm.io/2023/12/18/a-quick-glance-at-cilium-cni/" title="Copy Link" class="link link_yank">
      <svg class="icon">
  <title>copy</title>
  <use xlink:href="#copy"></use>
</svg>

    </a>
  </div>
  </span>
  </div>

      <div class="post_toc">
        <h2>Overview</h2>
        <nav id="TableOfContents">
  <ul>
    <li><a href="#what-is-ebpfhttpsebpfiowhat-is-ebpfwhat-is-ebpf"><a href="https://ebpf.io/what-is-ebpf/#what-is-ebpf">What is eBPF?</a></a></li>
    <li><a href="#preparations">Preparations</a></li>
    <li><a href="#installation-of-cilium">Installation of Cilium</a>
      <ul>
        <li><a href="#kubeadm-init-with-no-kube-proxy">kubeadm init with no-kube-proxy</a></li>
      </ul>
    </li>
    <li><a href="#install-cilium-cni">Install Cilium CNI</a>
      <ul>
        <li><a href="#install-cilium-on-a-cluster-with-no-kube-proxy">Install Cilium on a cluster with no kube-proxy</a></li>
        <li><a href="#enabling-features-using-helm">Enabling features using Helm</a></li>
        <li><a href="#enabling-features-using-cilium-cli">Enabling features using Cilium cli</a></li>
      </ul>
    </li>
    <li><a href="#observability-and-flow-monitoring---hubble-observability">Observability and flow-monitoring - Hubble Observability</a></li>
    <li><a href="#lb-ipam">LB-IPAM</a></li>
    <li><a href="#bgp-control-plane">BGP Control Plane</a></li>
    <li><a href="#lb-ipam---does-it-actually-loadbalance">LB-IPAM - does it actually loadbalance?</a></li>
    <li><a href="#cilium-ingress">Cilium Ingress</a></li>
    <li><a href="#cilium-gateway-api">Cilium Gateway API</a></li>
    <li><a href="#hubble-ui">Hubble UI</a></li>
    <li><a href="#things-i-have-not-covered-yet-wich-i-will-at-a-later-stage">Things I have not covered yet wich I will at a later stage</a></li>
  </ul>
</nav>
      </div>
    
    <div class="post_body"><h1 id="about-cilium">About Cilium</h1>
<p>Instead of me using my own words I will just copy the text from the official Cilium <a href="https://cilium.io/">website</a>:</p>
<blockquote>
<h1 id="ebpf-based-networking-observability-security">eBPF-based Networking, Observability, Security</h1>
<p>Cilium is an open source, cloud native solution for providing, securing, and observing network connectivity between workloads, fueled by the revolutionary Kernel technology eBPF</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="eBPF-based Networking, Observability, Security"
      
        class="image_figure image_internal image_processed"
        width="761"
        height="555"
        src="/2023/12/18/a-quick-glance-at-cilium-cni/images/hero-illustration.png"
      
      
    />

    </picture>
</figure>
</p>
</blockquote>
<p>Now what is eBPF?</p>
<p>From <a href="https://ebpf.io/what-is-ebpf/">ebpf.io</a></p>
<blockquote>
<h1 id="dynamically-program-the-kernel-for-efficient-networking-observability-tracing-and-security">Dynamically program the kernel for efficient networking, observability, tracing, and security</h1>
<h2 id="what-is-ebpfhttpsebpfiowhat-is-ebpfwhat-is-ebpf"><a href="https://ebpf.io/what-is-ebpf/#what-is-ebpf">What is eBPF?</a></h2>
<p>eBPF is a revolutionary technology with origins in the Linux kernel that can run sandboxed programs in a privileged context such as the operating system kernel. It is used to safely and efficiently extend the capabilities of the kernel without requiring to change kernel source code or load kernel modules.</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="Overview"
      
        class="image_figure image_internal image_processed"
        width="960"
        height="495"
        src="/2023/12/18/a-quick-glance-at-cilium-cni/images/overview.png"
      
      
    />

    </picture>
</figure>
</p>
</blockquote>
<p>As it is always interesting to learn new technology I thought writing a post about Cilium was about time. At first look Cilium is kind of a Swiss Army knife with a lot interesting features. I will go through this post beginning with a basic installation of Cilium on a new cluster (upstream K8s based on Ubuntu nodes). Then I will continune with some of the features I found interesting, and needed myself in my lab, and how to enable and configure them.</p>
<p>This post will be divided into dedicated sections for the installtion part and the different features respectively, starting with the installation of Cilium as the CNI in my Kubernetes cluster.</p>
<h2 id="preparations">Preparations</h2>
<p>This post assumes the following:</p>
<ul>
<li>Already prepared the Kubernetes nodes with all the software installed ready to do the kubeadm init.</li>
<li>A jumphost or Linux mgmt vm/server to operate from</li>
<li>Helm installed and configured on the Linux jumphost</li>
<li>Kubectl installed on the Linux jumphost</li>
<li>Cilium CLI installed on the Linux jumphost</li>
</ul>
<p>Cilium-cli is installed using this command:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl"><span class="nv">CILIUM_CLI_VERSION</span><span class="o">=</span><span class="k">$(</span>curl -s https://raw.githubusercontent.com/cilium/cilium-cli/main/stable.txt<span class="k">)</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="nv">CLI_ARCH</span><span class="o">=</span>amd64
</span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="k">if</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="k">$(</span>uname -m<span class="k">)</span><span class="s2">&#34;</span> <span class="o">=</span> <span class="s2">&#34;aarch64&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span> <span class="nv">CLI_ARCH</span><span class="o">=</span>arm64<span class="p">;</span> <span class="k">fi</span>
</span></span><span class="line"><span class="ln">4</span><span class="cl">curl -L --fail --remote-name-all https://github.com/cilium/cilium-cli/releases/download/<span class="si">${</span><span class="nv">CILIUM_CLI_VERSION</span><span class="si">}</span>/cilium-linux-<span class="si">${</span><span class="nv">CLI_ARCH</span><span class="si">}</span>.tar.gz<span class="o">{</span>,.sha256sum<span class="o">}</span>
</span></span><span class="line"><span class="ln">5</span><span class="cl">sha256sum --check cilium-linux-<span class="si">${</span><span class="nv">CLI_ARCH</span><span class="si">}</span>.tar.gz.sha256sum
</span></span><span class="line"><span class="ln">6</span><span class="cl">sudo tar xzvfC cilium-linux-<span class="si">${</span><span class="nv">CLI_ARCH</span><span class="si">}</span>.tar.gz /usr/local/bin
</span></span><span class="line"><span class="ln">7</span><span class="cl">rm cilium-linux-<span class="si">${</span><span class="nv">CLI_ARCH</span><span class="si">}</span>.tar.gz<span class="o">{</span>,.sha256sum<span class="o">}</span>
</span></span></code></pre></div><p>For more information have a look <a href="https://docs.cilium.io/en/stable/gettingstarted/k8s-install-default/">here</a></p>
<p>Below is my lab's topology for this post:</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="my-lab-topology"
      
        class="image_figure image_internal image_processed"
        width="1521"
        height="842"
        src="/2023/12/18/a-quick-glance-at-cilium-cni/images/image-20231219124247767.png"
      
      
    />

    </picture>
</figure>
</p>
<h2 id="installation-of-cilium">Installation of Cilium</h2>
<p>Cililum can be installed using Helm or using Ciliums nifty <em>cilium-cli</em> tool.</p>

<div class="notices info">
    <div class="label">Info</div>
    <p>One can use Helm to configure/install features but also the Cilium cli tool. In my post I will mostly use Helm when adding some features or changing certain settings and cilium-cli for others just to showcase how easy it is to use cilium cli for certain features/tasks.</p>
<p>According to the official docs:</p>
<blockquote>
<p>Install the latest version of the Cilium CLI. The Cilium CLI can be used to install Cilium, inspect the state of a Cilium installation, and enable/disable various features (e.g. clustermesh, Hubble).</p>
</blockquote>

  </div>

<p>The first feature of Cilium in this post is how it can fully replace kube-proxy by providing distributed load balancing using eBPF. Naturally I would like to use this feature. This means I need to deploy my Kubernetes cluster without kube-proxy. That is easiest done during the initial upbringing of the Kubernetes cluster. It can be done post-upringing also, see more info <a href="https://docs.cilium.io/en/stable/network/kubernetes/kubeproxy-free/#kubeproxy-free">here</a></p>
<h3 id="kubeadm-init-with-no-kube-proxy">kubeadm init with no-kube-proxy</h3>
<p>To bring up my Kubernetes cluster without kube-proxy, this is the command I will use on my first control-plane node:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">sudo kubeadm init --pod-network-cidr<span class="o">=</span>10.22.0.0/16 --service-cidr<span class="o">=</span>10.23.0.0/16  --control-plane-endpoint <span class="s2">&#34;test-cluster-1.my-doamin.net&#34;</span> --upload-certs --skip-phases<span class="o">=</span>addon/kube-proxy --cri-socket unix:///var/run/containerd/containerd.sock
</span></span></code></pre></div><blockquote>
<p>This is the parameter to disable kube-proxy <em>--skip-phases=addon/kube-proxy</em></p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">I1219 14:08:17.376790   <span class="m">13327</span> version.go:256<span class="o">]</span> remote version is much newer: v1.29.0<span class="p">;</span> falling back to: stable-1.28
</span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="o">[</span>init<span class="o">]</span> Using Kubernetes version: v1.28.4
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="o">[</span>preflight<span class="o">]</span> Running pre-flight checks
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="o">[</span>preflight<span class="o">]</span> Pulling images required <span class="k">for</span> setting up a Kubernetes cluster
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="o">[</span>preflight<span class="o">]</span> This might take a minute or two, depending on the speed of your internet connection
</span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="o">[</span>preflight<span class="o">]</span> You can also perform this action in beforehand using <span class="s1">&#39;kubeadm config images pull&#39;</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">W1219 14:08:33.520592   <span class="m">13327</span> checks.go:835<span class="o">]</span> detected that the sandbox image <span class="s2">&#34;registry.k8s.io/pause:3.5&#34;</span> of the container runtime is inconsistent with that used by kubeadm. It is recommended that using <span class="s2">&#34;registry.k8s.io/pause:3.9&#34;</span> as the CRI sandbox image.
</span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="o">[</span>certs<span class="o">]</span> Using certificateDir folder <span class="s2">&#34;/etc/kubernetes/pki&#34;</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="o">[</span>certs<span class="o">]</span> Generating <span class="s2">&#34;ca&#34;</span> certificate and key
</span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="o">[</span>certs<span class="o">]</span> Generating <span class="s2">&#34;apiserver&#34;</span> certificate and key
</span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="o">[</span>certs<span class="o">]</span> apiserver serving cert is signed <span class="k">for</span> DNS names <span class="o">[</span>k8s-master-01 kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local test-cluster-1.my-domain.net<span class="o">]</span> and IPs <span class="o">[</span>10.23.0.1 10.160.1.10<span class="o">]</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="o">[</span>certs<span class="o">]</span> Generating <span class="s2">&#34;apiserver-kubelet-client&#34;</span> certificate and key
</span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="o">[</span>certs<span class="o">]</span> Generating <span class="s2">&#34;front-proxy-ca&#34;</span> certificate and key
</span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="o">[</span>certs<span class="o">]</span> Generating <span class="s2">&#34;front-proxy-client&#34;</span> certificate and key
</span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="o">[</span>certs<span class="o">]</span> Generating <span class="s2">&#34;etcd/ca&#34;</span> certificate and key
</span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="o">[</span>certs<span class="o">]</span> Generating <span class="s2">&#34;etcd/server&#34;</span> certificate and key
</span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="o">[</span>certs<span class="o">]</span> etcd/server serving cert is signed <span class="k">for</span> DNS names <span class="o">[</span>k8s-master-01 localhost<span class="o">]</span> and IPs <span class="o">[</span>10.160.1.10 127.0.0.1 ::1<span class="o">]</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="o">[</span>certs<span class="o">]</span> Generating <span class="s2">&#34;etcd/peer&#34;</span> certificate and key
</span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="o">[</span>certs<span class="o">]</span> etcd/peer serving cert is signed <span class="k">for</span> DNS names <span class="o">[</span>k8s-master-01 localhost<span class="o">]</span> and IPs <span class="o">[</span>10.160.1.10 127.0.0.1 ::1<span class="o">]</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="o">[</span>certs<span class="o">]</span> Generating <span class="s2">&#34;etcd/healthcheck-client&#34;</span> certificate and key
</span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="o">[</span>certs<span class="o">]</span> Generating <span class="s2">&#34;apiserver-etcd-client&#34;</span> certificate and key
</span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="o">[</span>certs<span class="o">]</span> Generating <span class="s2">&#34;sa&#34;</span> key and public key
</span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="o">[</span>kubeconfig<span class="o">]</span> Using kubeconfig folder <span class="s2">&#34;/etc/kubernetes&#34;</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="o">[</span>kubeconfig<span class="o">]</span> Writing <span class="s2">&#34;admin.conf&#34;</span> kubeconfig file
</span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="o">[</span>kubeconfig<span class="o">]</span> Writing <span class="s2">&#34;kubelet.conf&#34;</span> kubeconfig file
</span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="o">[</span>kubeconfig<span class="o">]</span> Writing <span class="s2">&#34;controller-manager.conf&#34;</span> kubeconfig file
</span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="o">[</span>kubeconfig<span class="o">]</span> Writing <span class="s2">&#34;scheduler.conf&#34;</span> kubeconfig file
</span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="o">[</span>etcd<span class="o">]</span> Creating static Pod manifest <span class="k">for</span> <span class="nb">local</span> etcd in <span class="s2">&#34;/etc/kubernetes/manifests&#34;</span>
</span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="o">[</span>control-plane<span class="o">]</span> Using manifest folder <span class="s2">&#34;/etc/kubernetes/manifests&#34;</span>
</span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="o">[</span>control-plane<span class="o">]</span> Creating static Pod manifest <span class="k">for</span> <span class="s2">&#34;kube-apiserver&#34;</span>
</span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="o">[</span>control-plane<span class="o">]</span> Creating static Pod manifest <span class="k">for</span> <span class="s2">&#34;kube-controller-manager&#34;</span>
</span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="o">[</span>control-plane<span class="o">]</span> Creating static Pod manifest <span class="k">for</span> <span class="s2">&#34;kube-scheduler&#34;</span>
</span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="o">[</span>kubelet-start<span class="o">]</span> Writing kubelet environment file with flags to file <span class="s2">&#34;/var/lib/kubelet/kubeadm-flags.env&#34;</span>
</span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="o">[</span>kubelet-start<span class="o">]</span> Writing kubelet configuration to file <span class="s2">&#34;/var/lib/kubelet/config.yaml&#34;</span>
</span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="o">[</span>kubelet-start<span class="o">]</span> Starting the kubelet
</span></span><span class="line"><span class="ln">36</span><span class="cl"><span class="o">[</span>wait-control-plane<span class="o">]</span> Waiting <span class="k">for</span> the kubelet to boot up the control plane as static Pods from directory <span class="s2">&#34;/etc/kubernetes/manifests&#34;</span>. This can take up to 4m0s
</span></span><span class="line"><span class="ln">37</span><span class="cl"><span class="o">[</span>kubelet-check<span class="o">]</span> Initial timeout of 40s passed.
</span></span><span class="line"><span class="ln">38</span><span class="cl"><span class="o">[</span>apiclient<span class="o">]</span> All control plane components are healthy after 106.047476 seconds
</span></span><span class="line"><span class="ln">39</span><span class="cl"><span class="o">[</span>upload-config<span class="o">]</span> Storing the configuration used in ConfigMap <span class="s2">&#34;kubeadm-config&#34;</span> in the <span class="s2">&#34;kube-system&#34;</span> Namespace
</span></span><span class="line"><span class="ln">40</span><span class="cl"><span class="o">[</span>kubelet<span class="o">]</span> Creating a ConfigMap <span class="s2">&#34;kubelet-config&#34;</span> in namespace kube-system with the configuration <span class="k">for</span> the kubelets in the cluster
</span></span><span class="line"><span class="ln">41</span><span class="cl"><span class="o">[</span>upload-certs<span class="o">]</span> Storing the certificates in Secret <span class="s2">&#34;kubeadm-certs&#34;</span> in the <span class="s2">&#34;kube-system&#34;</span> Namespace
</span></span><span class="line"><span class="ln">42</span><span class="cl"><span class="o">[</span>upload-certs<span class="o">]</span> Using certificate key:
</span></span><span class="line"><span class="ln">43</span><span class="cl">3c9fa959a7538baaaf484e931ade45fbad07934dc40d456cae54839a7d888715
</span></span><span class="line"><span class="ln">44</span><span class="cl"><span class="o">[</span>mark-control-plane<span class="o">]</span> Marking the node k8s-master-01 as control-plane by adding the labels: <span class="o">[</span>node-role.kubernetes.io/control-plane node.kubernetes.io/exclude-from-external-load-balancers<span class="o">]</span>
</span></span><span class="line"><span class="ln">45</span><span class="cl"><span class="o">[</span>mark-control-plane<span class="o">]</span> Marking the node k8s-master-01 as control-plane by adding the taints <span class="o">[</span>node-role.kubernetes.io/control-plane:NoSchedule<span class="o">]</span>
</span></span><span class="line"><span class="ln">46</span><span class="cl"><span class="o">[</span>bootstrap-token<span class="o">]</span> Using token: q495cj.apdasczda14j87tc
</span></span><span class="line"><span class="ln">47</span><span class="cl"><span class="o">[</span>bootstrap-token<span class="o">]</span> Configuring bootstrap tokens, cluster-info ConfigMap, RBAC Roles
</span></span><span class="line"><span class="ln">48</span><span class="cl"><span class="o">[</span>bootstrap-token<span class="o">]</span> Configured RBAC rules to allow Node Bootstrap tokens to get nodes
</span></span><span class="line"><span class="ln">49</span><span class="cl"><span class="o">[</span>bootstrap-token<span class="o">]</span> Configured RBAC rules to allow Node Bootstrap tokens to post CSRs in order <span class="k">for</span> nodes to get long term certificate credentials
</span></span><span class="line"><span class="ln">50</span><span class="cl"><span class="o">[</span>bootstrap-token<span class="o">]</span> Configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token
</span></span><span class="line"><span class="ln">51</span><span class="cl"><span class="o">[</span>bootstrap-token<span class="o">]</span> Configured RBAC rules to allow certificate rotation <span class="k">for</span> all node client certificates in the cluster
</span></span><span class="line"><span class="ln">52</span><span class="cl"><span class="o">[</span>bootstrap-token<span class="o">]</span> Creating the <span class="s2">&#34;cluster-info&#34;</span> ConfigMap in the <span class="s2">&#34;kube-public&#34;</span> namespace
</span></span><span class="line"><span class="ln">53</span><span class="cl"><span class="o">[</span>kubelet-finalize<span class="o">]</span> Updating <span class="s2">&#34;/etc/kubernetes/kubelet.conf&#34;</span> to point to a rotatable kubelet client certificate and key
</span></span><span class="line"><span class="ln">54</span><span class="cl"><span class="o">[</span>addons<span class="o">]</span> Applied essential addon: CoreDNS
</span></span><span class="line"><span class="ln">55</span><span class="cl">
</span></span><span class="line"><span class="ln">56</span><span class="cl">Your Kubernetes control-plane has initialized successfully!
</span></span><span class="line"><span class="ln">57</span><span class="cl">
</span></span><span class="line"><span class="ln">58</span><span class="cl">To start using your cluster, you need to run the following as a regular user:
</span></span><span class="line"><span class="ln">59</span><span class="cl">
</span></span><span class="line"><span class="ln">60</span><span class="cl">  mkdir -p <span class="nv">$HOME</span>/.kube
</span></span><span class="line"><span class="ln">61</span><span class="cl">  sudo cp -i /etc/kubernetes/admin.conf <span class="nv">$HOME</span>/.kube/config
</span></span><span class="line"><span class="ln">62</span><span class="cl">  sudo chown <span class="k">$(</span>id -u<span class="k">)</span>:<span class="k">$(</span>id -g<span class="k">)</span> <span class="nv">$HOME</span>/.kube/config
</span></span><span class="line"><span class="ln">63</span><span class="cl">
</span></span><span class="line"><span class="ln">64</span><span class="cl">Alternatively, <span class="k">if</span> you are the root user, you can run:
</span></span><span class="line"><span class="ln">65</span><span class="cl">
</span></span><span class="line"><span class="ln">66</span><span class="cl">  <span class="nb">export</span> <span class="nv">KUBECONFIG</span><span class="o">=</span>/etc/kubernetes/admin.conf
</span></span><span class="line"><span class="ln">67</span><span class="cl">
</span></span><span class="line"><span class="ln">68</span><span class="cl">You should now deploy a pod network to the cluster.
</span></span><span class="line"><span class="ln">69</span><span class="cl">Run <span class="s2">&#34;kubectl apply -f [podnetwork].yaml&#34;</span> with one of the options listed at:
</span></span><span class="line"><span class="ln">70</span><span class="cl">  https://kubernetes.io/docs/concepts/cluster-administration/addons/
</span></span><span class="line"><span class="ln">71</span><span class="cl">
</span></span><span class="line"><span class="ln">72</span><span class="cl">You can now join any number of the control-plane node running the following <span class="nb">command</span> on each as root:
</span></span><span class="line"><span class="ln">73</span><span class="cl">
</span></span><span class="line"><span class="ln">74</span><span class="cl">  kubeadm join test-cluster-1.my-domain.net:6443 --token q4da14j87tc <span class="se">\
</span></span></span><span class="line"><span class="ln">75</span><span class="cl"><span class="se"></span>	--discovery-token-ca-cert-hash sha256: <span class="se">\
</span></span></span><span class="line"><span class="ln">76</span><span class="cl"><span class="se"></span>	--control-plane --certificate-key 
</span></span><span class="line"><span class="ln">77</span><span class="cl">
</span></span><span class="line"><span class="ln">78</span><span class="cl">Please note that the certificate-key gives access to cluster sensitive data, keep it secret!
</span></span><span class="line"><span class="ln">79</span><span class="cl">As a safeguard, uploaded-certs will be deleted in two hours<span class="p">;</span> If necessary, you can use
</span></span><span class="line"><span class="ln">80</span><span class="cl"><span class="s2">&#34;kubeadm init phase upload-certs --upload-certs&#34;</span> to reload certs afterward.
</span></span><span class="line"><span class="ln">81</span><span class="cl">
</span></span><span class="line"><span class="ln">82</span><span class="cl">Then you can join any number of worker nodes by running the following on each as root:
</span></span><span class="line"><span class="ln">83</span><span class="cl">
</span></span><span class="line"><span class="ln">84</span><span class="cl">kubeadm join test-cluster-1.my-domain.net:6443 --token q4aczda14j87tc <span class="se">\
</span></span></span><span class="line"><span class="ln">85</span><span class="cl"><span class="se"></span>	--discovery-token-ca-cert-hash sha256:
</span></span></code></pre></div><p>NB, notice that it &quot;complains&quot; <em>No kubeproxy.config.k8s.io/v1alpha1 config is loaded. Continuing without it: configmaps &quot;kube-proxy&quot;</em></p>
<p>Now on my worker nodes:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">kubeadm join test-cluster-1.my-domain.net:6443 --token q414j87tc <span class="se">\
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="se"></span>	--discovery-token-ca-cert-hash sha256:edf4d18883f94f0b5aa646001606147
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="o">[</span>preflight<span class="o">]</span> Running pre-flight checks
</span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="o">[</span>preflight<span class="o">]</span> Reading configuration from the cluster...
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="o">[</span>preflight<span class="o">]</span> FYI: You can look at this config file with <span class="s1">&#39;kubectl -n kube-system get cm kubeadm-config -o yaml&#39;</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">W1219 16:25:57.203844    <span class="m">1279</span> configset.go:78<span class="o">]</span> Warning: No kubeproxy.config.k8s.io/v1alpha1 config is loaded. Continuing without it: configmaps <span class="s2">&#34;kube-proxy&#34;</span> is forbidden: User <span class="s2">&#34;system:bootstrap:q495cj&#34;</span> cannot get resource <span class="s2">&#34;configmaps&#34;</span> in API group <span class="s2">&#34;&#34;</span> in the namespace <span class="s2">&#34;kube-system&#34;</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="o">[</span>kubelet-start<span class="o">]</span> Writing kubelet configuration to file <span class="s2">&#34;/var/lib/kubelet/config.yaml&#34;</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="o">[</span>kubelet-start<span class="o">]</span> Writing kubelet environment file with flags to file <span class="s2">&#34;/var/lib/kubelet/kubeadm-flags.env&#34;</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="o">[</span>kubelet-start<span class="o">]</span> Starting the kubelet
</span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="o">[</span>kubelet-start<span class="o">]</span> Waiting <span class="k">for</span> the kubelet to perform the TLS Bootstrap...
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">
</span></span><span class="line"><span class="ln">10</span><span class="cl">This node has joined the cluster:
</span></span><span class="line"><span class="ln">11</span><span class="cl">* Certificate signing request was sent to apiserver and a response was received.
</span></span><span class="line"><span class="ln">12</span><span class="cl">* The Kubelet was informed of the new secure connection details.
</span></span><span class="line"><span class="ln">13</span><span class="cl">
</span></span><span class="line"><span class="ln">14</span><span class="cl">Run <span class="s1">&#39;kubectl get nodes&#39;</span> on the control-plane to see this node join the cluster.
</span></span></code></pre></div><p>NB, notice that it &quot;complains&quot; <em>No kubeproxy.config.k8s.io/v1alpha1 config is loaded. Continuing without it: configmaps &quot;kube-proxy&quot;</em></p>
<p>When all worker nodes has been joined:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@linuxmgmt01:~/test-cluster-1$ k get nodes
</span></span><span class="line"><span class="ln">2</span><span class="cl">NAME            STATUS   ROLES           AGE     VERSION
</span></span><span class="line"><span class="ln">3</span><span class="cl">k8s-master-01   Ready    control-plane   135m    v1.28.2
</span></span><span class="line"><span class="ln">4</span><span class="cl">k8s-worker-01   Ready    &lt;none&gt;          12s     v1.28.2
</span></span><span class="line"><span class="ln">5</span><span class="cl">k8s-worker-02   Ready    &lt;none&gt;          38s     v1.28.2
</span></span><span class="line"><span class="ln">6</span><span class="cl">k8s-worker-03   Ready    &lt;none&gt;          4m28s   v1.28.2
</span></span></code></pre></div><p>Notice they are not ready. CoreDNS is pending and there is no CNI in place to cover IPAM etc..</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@linuxmgmt01:~/test-cluster-1$ k get pods -A
</span></span><span class="line"><span class="ln">2</span><span class="cl">NAMESPACE     NAME                                    READY   STATUS    RESTARTS      AGE
</span></span><span class="line"><span class="ln">3</span><span class="cl">kube-system   coredns-5dd5756b68-c5xml                0/1     Pending   <span class="m">0</span>             35m
</span></span><span class="line"><span class="ln">4</span><span class="cl">kube-system   coredns-5dd5756b68-fgdzj                0/1     Pending   <span class="m">0</span>             35m
</span></span><span class="line"><span class="ln">5</span><span class="cl">kube-system   etcd-k8s-master-01                      1/1     Running   <span class="m">0</span>             35m
</span></span><span class="line"><span class="ln">6</span><span class="cl">kube-system   kube-apiserver-k8s-master-01            1/1     Running   <span class="m">0</span>             35m
</span></span><span class="line"><span class="ln">7</span><span class="cl">kube-system   kube-controller-manager-k8s-master-01   1/1     Running   <span class="m">1</span> <span class="o">(</span>19m ago<span class="o">)</span>   35m
</span></span><span class="line"><span class="ln">8</span><span class="cl">kube-system   kube-scheduler-k8s-master-01            1/1     Running   <span class="m">1</span> <span class="o">(</span>19m ago<span class="o">)</span>   35m
</span></span></code></pre></div><p>Now its time to jump over to my jumphost where I will do all the remaining configurations/interactions with my test-cluster-1.</p>
<h2 id="install-cilium-cni">Install Cilium CNI</h2>
<p>From my jumphost I already have all the tools I need to deploy Cilium. To install the Cilium CNI I will just use the cilium-cli tool as it is so easy. With a very short command it will automatically install Cilium on all my worker/control-plane nodes. The cilium-cli will act according to the kube context you are in, so make sure you are in the correct context (the context that needs Cilium to be installed):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@linuxmgmt01:~/test-cluster-1$ k config current-context
</span></span><span class="line"><span class="ln">2</span><span class="cl">test-cluster-1-admin@kubernetes
</span></span><span class="line"><span class="ln">3</span><span class="cl">
</span></span><span class="line"><span class="ln">4</span><span class="cl">andreasm@linuxmgmt01:~/test-cluster-1$ cilium install --version 1.14.5
</span></span><span class="line"><span class="ln">5</span><span class="cl">‚ÑπÔ∏è  Using Cilium version 1.14.5
</span></span><span class="line"><span class="ln">6</span><span class="cl">üîÆ Auto-detected cluster name: test-cluster-1
</span></span><span class="line"><span class="ln">7</span><span class="cl">üîÆ Auto-detected kube-proxy has not been installed
</span></span><span class="line"><span class="ln">8</span><span class="cl">‚ÑπÔ∏è  Cilium will fully replace all functionalities of kube-proxy
</span></span></code></pre></div><p>Thats it.... &#x1f604;</p>
<p>Version 1.14.5 is the latest stable at the writing of this post.</p>
<h3 id="install-cilium-on-a-cluster-with-no-kube-proxy">Install Cilium on a cluster with no kube-proxy</h3>
<p>If I have prepared my cluster as above with no kube-proxy I need to install Cilium using the following command:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl"><span class="nv">API_SERVER_IP</span><span class="o">=</span>10.160.1.111
</span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="nv">API_SERVER_PORT</span><span class="o">=</span><span class="m">6443</span>
</span></span><span class="line"><span class="ln">3</span><span class="cl">helm install cilium cilium/cilium --version 1.14.5 -f cilium.1.14.5.values-prod-cluster-1.yaml <span class="se">\
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="se"></span>    --namespace kube-system <span class="se">\
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="se"></span>    --set <span class="nv">kubeProxyReplacement</span><span class="o">=</span>strict <span class="se">\
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="se"></span>    --set <span class="nv">k8sServiceHost</span><span class="o">=</span><span class="si">${</span><span class="nv">API_SERVER_IP</span><span class="si">}</span> <span class="se">\
</span></span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="se"></span>    --set <span class="nv">k8sServicePort</span><span class="o">=</span><span class="si">${</span><span class="nv">API_SERVER_PORT</span><span class="si">}</span>
</span></span></code></pre></div><p>Where the API_SERVER_PORT is one of my k8s control plane node (I did try to use the loadbalanced IP for the k8s api endpoint as I have 3 control plane nodes but that did not work out so I went with the IP of my first cp node). The value file is the value file I am using to set all the Cilium settings, more on that later.</p>
<p>Now, whats inside my Kubernetes cluster now:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">andreasm@linuxmgmt01:~/test-cluster-1$ k get pods -A
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">NAMESPACE     NAME                                    READY   STATUS    RESTARTS       AGE
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">kube-system   cilium-6gx5b                            1/1     Running   <span class="m">0</span>              11m
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">kube-system   cilium-bsqzw                            1/1     Running   <span class="m">1</span>              11m
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">kube-system   cilium-ct8n4                            1/1     Running   <span class="m">0</span>              53s
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">kube-system   cilium-operator-545dc68d55-fsh6s        1/1     Running   <span class="m">1</span>              11m
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">kube-system   cilium-v7rdz                            1/1     Running   <span class="m">0</span>              5m9s
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">kube-system   coredns-5dd5756b68-j9vwm                1/1     Running   <span class="m">0</span>              77s
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">kube-system   coredns-5dd5756b68-mjbzk                1/1     Running   <span class="m">0</span>              78s
</span></span><span class="line"><span class="ln">10</span><span class="cl">kube-system   etcd-k8s-master-01                      1/1     Running   <span class="m">0</span>              136m
</span></span><span class="line"><span class="ln">11</span><span class="cl">kube-system   hubble-relay-d478c79c8-pbn4v            1/1     Running   <span class="m">0</span>              16m
</span></span><span class="line"><span class="ln">12</span><span class="cl">kube-system   kube-apiserver-k8s-master-01            1/1     Running   <span class="m">0</span>              136m
</span></span><span class="line"><span class="ln">13</span><span class="cl">kube-system   kube-controller-manager-k8s-master-01   1/1     Running   <span class="m">1</span> <span class="o">(</span>120m ago<span class="o">)</span>   136m
</span></span><span class="line"><span class="ln">14</span><span class="cl">kube-system   kube-scheduler-k8s-master-01            1/1     Running   <span class="m">1</span> <span class="o">(</span>120m ago<span class="o">)</span>   136m
</span></span></code></pre></div><p>Everything is up and running.
The Cilium cli contains a lot of useful features. Like checking the status of Cilium. Lets test that:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">andreasm@linuxmgmt01:~/test-cluster-1$ cilium status
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">    /¬Ø¬Ø<span class="se">\
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="se"></span> /¬Ø¬Ø<span class="se">\_</span>_/¬Ø¬Ø<span class="se">\ </span>   Cilium:             OK
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"> <span class="se">\_</span>_/¬Ø¬Ø<span class="se">\_</span>_/    Operator:           OK
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"> /¬Ø¬Ø<span class="se">\_</span>_/¬Ø¬Ø<span class="se">\ </span>   Envoy DaemonSet:    disabled <span class="o">(</span>using embedded mode<span class="o">)</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl"> <span class="se">\_</span>_/¬Ø¬Ø<span class="se">\_</span>_/    Hubble Relay:       disabled
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">    <span class="se">\_</span>_/       ClusterMesh:        disabled
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">DaemonSet              cilium             Desired: 4, Ready: 4/4, Available: 4/4
</span></span><span class="line"><span class="ln">10</span><span class="cl">Deployment             cilium-operator    Desired: 1, Ready: 1/1, Available: 1/1
</span></span><span class="line"><span class="ln">11</span><span class="cl">Containers:            cilium             Running: <span class="m">4</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">                       cilium-operator    Running: <span class="m">1</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">Cluster Pods:          2/2 managed by Cilium
</span></span><span class="line"><span class="ln">14</span><span class="cl">Helm chart version:    1.14.5
</span></span><span class="line"><span class="ln">15</span><span class="cl">Image versions         cilium-operator    quay.io/cilium/operator-generic:v1.14.5@sha256:303f9076bdc73b3fc32aaedee64a14f6f44c8bb08ee9e3956d443021103ebe7a: <span class="m">1</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">                       cilium             quay.io/cilium/cilium:v1.14.5@sha256:d3b287029755b6a47dee01420e2ea469469f1b174a2089c10af7e5e9289ef05b: <span class="m">4</span>
</span></span></code></pre></div><p>Looks great</p>
<p>Did you notice above that the Cilium installer discovered there was no kube-proxy and that it told me it will replace all the feature of kube-proxy? Well it did.. Lets check the config of Cilium and see if that is also reflected there. Look after this key-value:</p>
<p><code>kube-proxy-replacement                            strict</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">  1</span><span class="cl">andreasm@linuxmgmt01:~/test-cluster-1$ cilium config view
</span></span><span class="line"><span class="ln">  2</span><span class="cl">agent-not-ready-taint-key                         node.cilium.io/agent-not-ready
</span></span><span class="line"><span class="ln">  3</span><span class="cl">arping-refresh-period                             30s
</span></span><span class="line"><span class="ln">  4</span><span class="cl">auto-direct-node-routes                           <span class="nb">false</span>
</span></span><span class="line"><span class="ln">  5</span><span class="cl">bpf-lb-external-clusterip                         <span class="nb">false</span>
</span></span><span class="line"><span class="ln">  6</span><span class="cl">bpf-lb-map-max                                    <span class="m">65536</span>
</span></span><span class="line"><span class="ln">  7</span><span class="cl">bpf-lb-sock                                       <span class="nb">false</span>
</span></span><span class="line"><span class="ln">  8</span><span class="cl">bpf-map-dynamic-size-ratio                        0.0025
</span></span><span class="line"><span class="ln">  9</span><span class="cl">bpf-policy-map-max                                <span class="m">16384</span>
</span></span><span class="line"><span class="ln"> 10</span><span class="cl">bpf-root                                          /sys/fs/bpf
</span></span><span class="line"><span class="ln"> 11</span><span class="cl">cgroup-root                                       /run/cilium/cgroupv2
</span></span><span class="line"><span class="ln"> 12</span><span class="cl">cilium-endpoint-gc-interval                       5m0s
</span></span><span class="line"><span class="ln"> 13</span><span class="cl">cluster-id                                        <span class="m">0</span>
</span></span><span class="line"><span class="ln"> 14</span><span class="cl">cluster-name                                      test-cluster-1
</span></span><span class="line"><span class="ln"> 15</span><span class="cl">cluster-pool-ipv4-cidr                            10.0.0.0/8
</span></span><span class="line"><span class="ln"> 16</span><span class="cl">cluster-pool-ipv4-mask-size                       <span class="m">24</span>
</span></span><span class="line"><span class="ln"> 17</span><span class="cl">cni-exclusive                                     <span class="nb">true</span>
</span></span><span class="line"><span class="ln"> 18</span><span class="cl">cni-log-file                                      /var/run/cilium/cilium-cni.log
</span></span><span class="line"><span class="ln"> 19</span><span class="cl">cnp-node-status-gc-interval                       0s
</span></span><span class="line"><span class="ln"> 20</span><span class="cl">custom-cni-conf                                   <span class="nb">false</span>
</span></span><span class="line"><span class="ln"> 21</span><span class="cl">debug                                             <span class="nb">false</span>
</span></span><span class="line"><span class="ln"> 22</span><span class="cl">debug-verbose
</span></span><span class="line"><span class="ln"> 23</span><span class="cl">disable-cnp-status-updates                        <span class="nb">true</span>
</span></span><span class="line"><span class="ln"> 24</span><span class="cl">egress-gateway-reconciliation-trigger-interval    1s
</span></span><span class="line"><span class="ln"> 25</span><span class="cl">enable-auto-protect-node-port-range               <span class="nb">true</span>
</span></span><span class="line"><span class="ln"> 26</span><span class="cl">enable-bgp-control-plane                          <span class="nb">false</span>
</span></span><span class="line"><span class="ln"> 27</span><span class="cl">enable-bpf-clock-probe                            <span class="nb">false</span>
</span></span><span class="line"><span class="ln"> 28</span><span class="cl">enable-endpoint-health-checking                   <span class="nb">true</span>
</span></span><span class="line"><span class="ln"> 29</span><span class="cl">enable-health-check-nodeport                      <span class="nb">true</span>
</span></span><span class="line"><span class="ln"> 30</span><span class="cl">enable-health-checking                            <span class="nb">true</span>
</span></span><span class="line"><span class="ln"> 31</span><span class="cl">enable-hubble                                     <span class="nb">true</span>
</span></span><span class="line"><span class="ln"> 32</span><span class="cl">enable-ipv4                                       <span class="nb">true</span>
</span></span><span class="line"><span class="ln"> 33</span><span class="cl">enable-ipv4-big-tcp                               <span class="nb">false</span>
</span></span><span class="line"><span class="ln"> 34</span><span class="cl">enable-ipv4-masquerade                            <span class="nb">true</span>
</span></span><span class="line"><span class="ln"> 35</span><span class="cl">enable-ipv6                                       <span class="nb">false</span>
</span></span><span class="line"><span class="ln"> 36</span><span class="cl">enable-ipv6-big-tcp                               <span class="nb">false</span>
</span></span><span class="line"><span class="ln"> 37</span><span class="cl">enable-ipv6-masquerade                            <span class="nb">true</span>
</span></span><span class="line"><span class="ln"> 38</span><span class="cl">enable-k8s-networkpolicy                          <span class="nb">true</span>
</span></span><span class="line"><span class="ln"> 39</span><span class="cl">enable-k8s-terminating-endpoint                   <span class="nb">true</span>
</span></span><span class="line"><span class="ln"> 40</span><span class="cl">enable-l2-neigh-discovery                         <span class="nb">true</span>
</span></span><span class="line"><span class="ln"> 41</span><span class="cl">enable-l7-proxy                                   <span class="nb">true</span>
</span></span><span class="line"><span class="ln"> 42</span><span class="cl">enable-local-redirect-policy                      <span class="nb">false</span>
</span></span><span class="line"><span class="ln"> 43</span><span class="cl">enable-policy                                     default
</span></span><span class="line"><span class="ln"> 44</span><span class="cl">enable-remote-node-identity                       <span class="nb">true</span>
</span></span><span class="line"><span class="ln"> 45</span><span class="cl">enable-sctp                                       <span class="nb">false</span>
</span></span><span class="line"><span class="ln"> 46</span><span class="cl">enable-svc-source-range-check                     <span class="nb">true</span>
</span></span><span class="line"><span class="ln"> 47</span><span class="cl">enable-vtep                                       <span class="nb">false</span>
</span></span><span class="line"><span class="ln"> 48</span><span class="cl">enable-well-known-identities                      <span class="nb">false</span>
</span></span><span class="line"><span class="ln"> 49</span><span class="cl">enable-xt-socket-fallback                         <span class="nb">true</span>
</span></span><span class="line"><span class="ln"> 50</span><span class="cl">external-envoy-proxy                              <span class="nb">false</span>
</span></span><span class="line"><span class="ln"> 51</span><span class="cl">hubble-disable-tls                                <span class="nb">false</span>
</span></span><span class="line"><span class="ln"> 52</span><span class="cl">hubble-listen-address                             :4244
</span></span><span class="line"><span class="ln"> 53</span><span class="cl">hubble-socket-path                                /var/run/cilium/hubble.sock
</span></span><span class="line"><span class="ln"> 54</span><span class="cl">hubble-tls-cert-file                              /var/lib/cilium/tls/hubble/server.crt
</span></span><span class="line"><span class="ln"> 55</span><span class="cl">hubble-tls-client-ca-files                        /var/lib/cilium/tls/hubble/client-ca.crt
</span></span><span class="line"><span class="ln"> 56</span><span class="cl">hubble-tls-key-file                               /var/lib/cilium/tls/hubble/server.key
</span></span><span class="line"><span class="ln"> 57</span><span class="cl">identity-allocation-mode                          crd
</span></span><span class="line"><span class="ln"> 58</span><span class="cl">identity-gc-interval                              15m0s
</span></span><span class="line"><span class="ln"> 59</span><span class="cl">identity-heartbeat-timeout                        30m0s
</span></span><span class="line"><span class="ln"> 60</span><span class="cl">install-no-conntrack-iptables-rules               <span class="nb">false</span>
</span></span><span class="line"><span class="ln"> 61</span><span class="cl">ipam                                              cluster-pool
</span></span><span class="line"><span class="ln"> 62</span><span class="cl">ipam-cilium-node-update-rate                      15s
</span></span><span class="line"><span class="ln"> 63</span><span class="cl">k8s-client-burst                                  <span class="m">10</span>
</span></span><span class="line"><span class="ln"> 64</span><span class="cl">k8s-client-qps                                    <span class="m">5</span>
</span></span><span class="line"><span class="ln"> 65</span><span class="cl">kube-proxy-replacement                            strict
</span></span><span class="line"><span class="ln"> 66</span><span class="cl">kube-proxy-replacement-healthz-bind-address
</span></span><span class="line"><span class="ln"> 67</span><span class="cl">mesh-auth-enabled                                 <span class="nb">true</span>
</span></span><span class="line"><span class="ln"> 68</span><span class="cl">mesh-auth-gc-interval                             5m0s
</span></span><span class="line"><span class="ln"> 69</span><span class="cl">mesh-auth-queue-size                              <span class="m">1024</span>
</span></span><span class="line"><span class="ln"> 70</span><span class="cl">mesh-auth-rotated-identities-queue-size           <span class="m">1024</span>
</span></span><span class="line"><span class="ln"> 71</span><span class="cl">monitor-aggregation                               medium
</span></span><span class="line"><span class="ln"> 72</span><span class="cl">monitor-aggregation-flags                         all
</span></span><span class="line"><span class="ln"> 73</span><span class="cl">monitor-aggregation-interval                      5s
</span></span><span class="line"><span class="ln"> 74</span><span class="cl">node-port-bind-protection                         <span class="nb">true</span>
</span></span><span class="line"><span class="ln"> 75</span><span class="cl">nodes-gc-interval                                 5m0s
</span></span><span class="line"><span class="ln"> 76</span><span class="cl">operator-api-serve-addr                           127.0.0.1:9234
</span></span><span class="line"><span class="ln"> 77</span><span class="cl">preallocate-bpf-maps                              <span class="nb">false</span>
</span></span><span class="line"><span class="ln"> 78</span><span class="cl">procfs                                            /host/proc
</span></span><span class="line"><span class="ln"> 79</span><span class="cl">proxy-connect-timeout                             <span class="m">2</span>
</span></span><span class="line"><span class="ln"> 80</span><span class="cl">proxy-max-connection-duration-seconds             <span class="m">0</span>
</span></span><span class="line"><span class="ln"> 81</span><span class="cl">proxy-max-requests-per-connection                 <span class="m">0</span>
</span></span><span class="line"><span class="ln"> 82</span><span class="cl">proxy-prometheus-port                             <span class="m">9964</span>
</span></span><span class="line"><span class="ln"> 83</span><span class="cl">remove-cilium-node-taints                         <span class="nb">true</span>
</span></span><span class="line"><span class="ln"> 84</span><span class="cl">routing-mode                                      tunnel
</span></span><span class="line"><span class="ln"> 85</span><span class="cl">set-cilium-is-up-condition                        <span class="nb">true</span>
</span></span><span class="line"><span class="ln"> 86</span><span class="cl">set-cilium-node-taints                            <span class="nb">true</span>
</span></span><span class="line"><span class="ln"> 87</span><span class="cl">sidecar-istio-proxy-image                         cilium/istio_proxy
</span></span><span class="line"><span class="ln"> 88</span><span class="cl">skip-cnp-status-startup-clean                     <span class="nb">false</span>
</span></span><span class="line"><span class="ln"> 89</span><span class="cl">synchronize-k8s-nodes                             <span class="nb">true</span>
</span></span><span class="line"><span class="ln"> 90</span><span class="cl">tofqdns-dns-reject-response-code                  refused
</span></span><span class="line"><span class="ln"> 91</span><span class="cl">tofqdns-enable-dns-compression                    <span class="nb">true</span>
</span></span><span class="line"><span class="ln"> 92</span><span class="cl">tofqdns-endpoint-max-ip-per-hostname              <span class="m">50</span>
</span></span><span class="line"><span class="ln"> 93</span><span class="cl">tofqdns-idle-connection-grace-period              0s
</span></span><span class="line"><span class="ln"> 94</span><span class="cl">tofqdns-max-deferred-connection-deletes           <span class="m">10000</span>
</span></span><span class="line"><span class="ln"> 95</span><span class="cl">tofqdns-proxy-response-max-delay                  100ms
</span></span><span class="line"><span class="ln"> 96</span><span class="cl">tunnel-protocol                                   vxlan
</span></span><span class="line"><span class="ln"> 97</span><span class="cl">unmanaged-pod-watcher-interval                    <span class="m">15</span>
</span></span><span class="line"><span class="ln"> 98</span><span class="cl">vtep-cidr
</span></span><span class="line"><span class="ln"> 99</span><span class="cl">vtep-endpoint
</span></span><span class="line"><span class="ln">100</span><span class="cl">vtep-mac
</span></span><span class="line"><span class="ln">101</span><span class="cl">vtep-mask
</span></span><span class="line"><span class="ln">102</span><span class="cl">write-cni-conf-when-ready                         /host/etc/cni/net.d/05-cilium.conflist
</span></span></code></pre></div><p>One can also verify with this command:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@linuxmgmt01:~/test-cluster-1$ kubectl -n kube-system <span class="nb">exec</span> ds/cilium -- cilium status <span class="p">|</span> grep KubeProxyReplacement
</span></span><span class="line"><span class="ln">2</span><span class="cl">Defaulted container <span class="s2">&#34;cilium-agent&#34;</span> out of: cilium-agent, config <span class="o">(</span>init<span class="o">)</span>, mount-cgroup <span class="o">(</span>init<span class="o">)</span>, apply-sysctl-overwrites <span class="o">(</span>init<span class="o">)</span>, mount-bpf-fs <span class="o">(</span>init<span class="o">)</span>, clean-cilium-state <span class="o">(</span>init<span class="o">)</span>, install-cni-binaries <span class="o">(</span>init<span class="o">)</span>
</span></span><span class="line"><span class="ln">3</span><span class="cl">KubeProxyReplacement:    Strict   <span class="o">[</span>ens18 10.160.1.11 <span class="o">(</span>Direct Routing<span class="o">)]</span>
</span></span></code></pre></div><p>The feature to easily list all features and the status on them is valuable and a really helpful feature.</p>
<p>It took a couple of seconds and Cilium CNI was installed. Now the fun begins to explore some of the features. Lets tag along</p>
<h3 id="enabling-features-using-helm">Enabling features using Helm</h3>
<p>When I installed Cilium using the cilium-cli tool, it actually deploys using Helm in the background. Lets see if there is a Helm manifest in the kube-system:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@linuxmgmt01:~/test-cluster-1$ helm list -n kube-system
</span></span><span class="line"><span class="ln">2</span><span class="cl">NAME  	NAMESPACE  	REVISION	UPDATED                                	STATUS  	CHART        	APP VERSION
</span></span><span class="line"><span class="ln">3</span><span class="cl">cilium	kube-system	<span class="m">1</span>       	2023-12-19 13:50:40.121866679 +0000 UTC	deployed	cilium-1.14.5	1.14.5
</span></span></code></pre></div><p>Well there it is..</p>
<p>That makes it all more interesting. As I will use Helm to update certain parameters going forward in this post I will take a &quot;snapshot&quot; of the current values in the manifest above and altered in the next sections when I enabel additional features. How does the values look like now?</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln">  1</span><span class="cl"><span class="l">From the configMap cilium-config</span><span class="w">
</span></span></span><span class="line"><span class="ln">  2</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="ln">  3</span><span class="cl"><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">  4</span><span class="cl"><span class="w">  </span><span class="nt">agent-not-ready-taint-key</span><span class="p">:</span><span class="w"> </span><span class="l">node.cilium.io/agent-not-ready</span><span class="w">
</span></span></span><span class="line"><span class="ln">  5</span><span class="cl"><span class="w">  </span><span class="nt">arping-refresh-period</span><span class="p">:</span><span class="w"> </span><span class="l">30s</span><span class="w">
</span></span></span><span class="line"><span class="ln">  6</span><span class="cl"><span class="w">  </span><span class="nt">auto-direct-node-routes</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;false&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">  7</span><span class="cl"><span class="w">  </span><span class="nt">bpf-lb-external-clusterip</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;false&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">  8</span><span class="cl"><span class="w">  </span><span class="nt">bpf-lb-map-max</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;65536&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">  9</span><span class="cl"><span class="w">  </span><span class="nt">bpf-lb-sock</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;false&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 10</span><span class="cl"><span class="w">  </span><span class="nt">bpf-map-dynamic-size-ratio</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;0.0025&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 11</span><span class="cl"><span class="w">  </span><span class="nt">bpf-policy-map-max</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;16384&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 12</span><span class="cl"><span class="w">  </span><span class="nt">bpf-root</span><span class="p">:</span><span class="w"> </span><span class="l">/sys/fs/bpf</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 13</span><span class="cl"><span class="w">  </span><span class="nt">cgroup-root</span><span class="p">:</span><span class="w"> </span><span class="l">/run/cilium/cgroupv2</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 14</span><span class="cl"><span class="w">  </span><span class="nt">cilium-endpoint-gc-interval</span><span class="p">:</span><span class="w"> </span><span class="l">5m0s</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 15</span><span class="cl"><span class="w">  </span><span class="nt">cluster-id</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;0&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 16</span><span class="cl"><span class="w">  </span><span class="nt">cluster-name</span><span class="p">:</span><span class="w"> </span><span class="l">test-cluster-1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 17</span><span class="cl"><span class="w">  </span><span class="nt">cluster-pool-ipv4-cidr</span><span class="p">:</span><span class="w"> </span><span class="m">10.0.0.0</span><span class="l">/8</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 18</span><span class="cl"><span class="w">  </span><span class="nt">cluster-pool-ipv4-mask-size</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;24&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 19</span><span class="cl"><span class="w">  </span><span class="nt">cni-exclusive</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 20</span><span class="cl"><span class="w">  </span><span class="nt">cni-log-file</span><span class="p">:</span><span class="w"> </span><span class="l">/var/run/cilium/cilium-cni.log</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 21</span><span class="cl"><span class="w">  </span><span class="nt">cnp-node-status-gc-interval</span><span class="p">:</span><span class="w"> </span><span class="l">0s</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 22</span><span class="cl"><span class="w">  </span><span class="nt">custom-cni-conf</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;false&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 23</span><span class="cl"><span class="w">  </span><span class="nt">debug</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;false&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 24</span><span class="cl"><span class="w">  </span><span class="nt">debug-verbose</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 25</span><span class="cl"><span class="w">  </span><span class="nt">disable-cnp-status-updates</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 26</span><span class="cl"><span class="w">  </span><span class="nt">egress-gateway-reconciliation-trigger-interval</span><span class="p">:</span><span class="w"> </span><span class="l">1s</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 27</span><span class="cl"><span class="w">  </span><span class="nt">enable-auto-protect-node-port-range</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 28</span><span class="cl"><span class="w">  </span><span class="nt">enable-bgp-control-plane</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;false&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 29</span><span class="cl"><span class="w">  </span><span class="nt">enable-bpf-clock-probe</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;false&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 30</span><span class="cl"><span class="w">  </span><span class="nt">enable-endpoint-health-checking</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 31</span><span class="cl"><span class="w">  </span><span class="nt">enable-health-check-nodeport</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 32</span><span class="cl"><span class="w">  </span><span class="nt">enable-health-checking</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 33</span><span class="cl"><span class="w">  </span><span class="nt">enable-hubble</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 34</span><span class="cl"><span class="w">  </span><span class="nt">enable-ipv4</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 35</span><span class="cl"><span class="w">  </span><span class="nt">enable-ipv4-big-tcp</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;false&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 36</span><span class="cl"><span class="w">  </span><span class="nt">enable-ipv4-masquerade</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 37</span><span class="cl"><span class="w">  </span><span class="nt">enable-ipv6</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;false&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 38</span><span class="cl"><span class="w">  </span><span class="nt">enable-ipv6-big-tcp</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;false&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 39</span><span class="cl"><span class="w">  </span><span class="nt">enable-ipv6-masquerade</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 40</span><span class="cl"><span class="w">  </span><span class="nt">enable-k8s-networkpolicy</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 41</span><span class="cl"><span class="w">  </span><span class="nt">enable-k8s-terminating-endpoint</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 42</span><span class="cl"><span class="w">  </span><span class="nt">enable-l2-neigh-discovery</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 43</span><span class="cl"><span class="w">  </span><span class="nt">enable-l7-proxy</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 44</span><span class="cl"><span class="w">  </span><span class="nt">enable-local-redirect-policy</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;false&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 45</span><span class="cl"><span class="w">  </span><span class="nt">enable-policy</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 46</span><span class="cl"><span class="w">  </span><span class="nt">enable-remote-node-identity</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 47</span><span class="cl"><span class="w">  </span><span class="nt">enable-sctp</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;false&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 48</span><span class="cl"><span class="w">  </span><span class="nt">enable-svc-source-range-check</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 49</span><span class="cl"><span class="w">  </span><span class="nt">enable-vtep</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;false&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 50</span><span class="cl"><span class="w">  </span><span class="nt">enable-well-known-identities</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;false&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 51</span><span class="cl"><span class="w">  </span><span class="nt">enable-xt-socket-fallback</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 52</span><span class="cl"><span class="w">  </span><span class="nt">external-envoy-proxy</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;false&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 53</span><span class="cl"><span class="w">  </span><span class="nt">hubble-disable-tls</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;false&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 54</span><span class="cl"><span class="w">  </span><span class="nt">hubble-listen-address</span><span class="p">:</span><span class="w"> </span><span class="p">:</span><span class="m">4244</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 55</span><span class="cl"><span class="w">  </span><span class="nt">hubble-socket-path</span><span class="p">:</span><span class="w"> </span><span class="l">/var/run/cilium/hubble.sock</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 56</span><span class="cl"><span class="w">  </span><span class="nt">hubble-tls-cert-file</span><span class="p">:</span><span class="w"> </span><span class="l">/var/lib/cilium/tls/hubble/server.crt</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 57</span><span class="cl"><span class="w">  </span><span class="nt">hubble-tls-client-ca-files</span><span class="p">:</span><span class="w"> </span><span class="l">/var/lib/cilium/tls/hubble/client-ca.crt</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 58</span><span class="cl"><span class="w">  </span><span class="nt">hubble-tls-key-file</span><span class="p">:</span><span class="w"> </span><span class="l">/var/lib/cilium/tls/hubble/server.key</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 59</span><span class="cl"><span class="w">  </span><span class="nt">identity-allocation-mode</span><span class="p">:</span><span class="w"> </span><span class="l">crd</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 60</span><span class="cl"><span class="w">  </span><span class="nt">identity-gc-interval</span><span class="p">:</span><span class="w"> </span><span class="l">15m0s</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 61</span><span class="cl"><span class="w">  </span><span class="nt">identity-heartbeat-timeout</span><span class="p">:</span><span class="w"> </span><span class="l">30m0s</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 62</span><span class="cl"><span class="w">  </span><span class="nt">install-no-conntrack-iptables-rules</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;false&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 63</span><span class="cl"><span class="w">  </span><span class="nt">ipam</span><span class="p">:</span><span class="w"> </span><span class="l">cluster-pool</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 64</span><span class="cl"><span class="w">  </span><span class="nt">ipam-cilium-node-update-rate</span><span class="p">:</span><span class="w"> </span><span class="l">15s</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 65</span><span class="cl"><span class="w">  </span><span class="nt">k8s-client-burst</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;10&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 66</span><span class="cl"><span class="w">  </span><span class="nt">k8s-client-qps</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;5&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 67</span><span class="cl"><span class="w">  </span><span class="nt">kube-proxy-replacement</span><span class="p">:</span><span class="w"> </span><span class="l">strict</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 68</span><span class="cl"><span class="w">  </span><span class="nt">kube-proxy-replacement-healthz-bind-address</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 69</span><span class="cl"><span class="w">  </span><span class="nt">mesh-auth-enabled</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 70</span><span class="cl"><span class="w">  </span><span class="nt">mesh-auth-gc-interval</span><span class="p">:</span><span class="w"> </span><span class="l">5m0s</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 71</span><span class="cl"><span class="w">  </span><span class="nt">mesh-auth-queue-size</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;1024&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 72</span><span class="cl"><span class="w">  </span><span class="nt">mesh-auth-rotated-identities-queue-size</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;1024&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 73</span><span class="cl"><span class="w">  </span><span class="nt">monitor-aggregation</span><span class="p">:</span><span class="w"> </span><span class="l">medium</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 74</span><span class="cl"><span class="w">  </span><span class="nt">monitor-aggregation-flags</span><span class="p">:</span><span class="w"> </span><span class="l">all</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 75</span><span class="cl"><span class="w">  </span><span class="nt">monitor-aggregation-interval</span><span class="p">:</span><span class="w"> </span><span class="l">5s</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 76</span><span class="cl"><span class="w">  </span><span class="nt">node-port-bind-protection</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 77</span><span class="cl"><span class="w">  </span><span class="nt">nodes-gc-interval</span><span class="p">:</span><span class="w"> </span><span class="l">5m0s</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 78</span><span class="cl"><span class="w">  </span><span class="nt">operator-api-serve-addr</span><span class="p">:</span><span class="w"> </span><span class="m">127.0.0.1</span><span class="p">:</span><span class="m">9234</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 79</span><span class="cl"><span class="w">  </span><span class="nt">preallocate-bpf-maps</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;false&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 80</span><span class="cl"><span class="w">  </span><span class="nt">procfs</span><span class="p">:</span><span class="w"> </span><span class="l">/host/proc</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 81</span><span class="cl"><span class="w">  </span><span class="nt">proxy-connect-timeout</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 82</span><span class="cl"><span class="w">  </span><span class="nt">proxy-max-connection-duration-seconds</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;0&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 83</span><span class="cl"><span class="w">  </span><span class="nt">proxy-max-requests-per-connection</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;0&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 84</span><span class="cl"><span class="w">  </span><span class="nt">proxy-prometheus-port</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;9964&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 85</span><span class="cl"><span class="w">  </span><span class="nt">remove-cilium-node-taints</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 86</span><span class="cl"><span class="w">  </span><span class="nt">routing-mode</span><span class="p">:</span><span class="w"> </span><span class="l">tunnel</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 87</span><span class="cl"><span class="w">  </span><span class="nt">set-cilium-is-up-condition</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 88</span><span class="cl"><span class="w">  </span><span class="nt">set-cilium-node-taints</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 89</span><span class="cl"><span class="w">  </span><span class="nt">sidecar-istio-proxy-image</span><span class="p">:</span><span class="w"> </span><span class="l">cilium/istio_proxy</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 90</span><span class="cl"><span class="w">  </span><span class="nt">skip-cnp-status-startup-clean</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;false&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 91</span><span class="cl"><span class="w">  </span><span class="nt">synchronize-k8s-nodes</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 92</span><span class="cl"><span class="w">  </span><span class="nt">tofqdns-dns-reject-response-code</span><span class="p">:</span><span class="w"> </span><span class="l">refused</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 93</span><span class="cl"><span class="w">  </span><span class="nt">tofqdns-enable-dns-compression</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 94</span><span class="cl"><span class="w">  </span><span class="nt">tofqdns-endpoint-max-ip-per-hostname</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;50&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 95</span><span class="cl"><span class="w">  </span><span class="nt">tofqdns-idle-connection-grace-period</span><span class="p">:</span><span class="w"> </span><span class="l">0s</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 96</span><span class="cl"><span class="w">  </span><span class="nt">tofqdns-max-deferred-connection-deletes</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;10000&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 97</span><span class="cl"><span class="w">  </span><span class="nt">tofqdns-proxy-response-max-delay</span><span class="p">:</span><span class="w"> </span><span class="l">100ms</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 98</span><span class="cl"><span class="w">  </span><span class="nt">tunnel-protocol</span><span class="p">:</span><span class="w"> </span><span class="l">vxlan</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 99</span><span class="cl"><span class="w">  </span><span class="nt">unmanaged-pod-watcher-interval</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;15&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">100</span><span class="cl"><span class="w">  </span><span class="nt">vtep-cidr</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">101</span><span class="cl"><span class="w">  </span><span class="nt">vtep-endpoint</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">102</span><span class="cl"><span class="w">  </span><span class="nt">vtep-mac</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">103</span><span class="cl"><span class="w">  </span><span class="nt">vtep-mask</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">104</span><span class="cl"><span class="w">  </span><span class="nt">write-cni-conf-when-ready</span><span class="p">:</span><span class="w"> </span><span class="l">/host/etc/cni/net.d/05-cilium.conflist</span><span class="w">
</span></span></span><span class="line"><span class="ln">105</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap</span><span class="w">
</span></span></span><span class="line"><span class="ln">106</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">107</span><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">108</span><span class="cl"><span class="w">    </span><span class="nt">meta.helm.sh/release-name</span><span class="p">:</span><span class="w"> </span><span class="l">cilium</span><span class="w">
</span></span></span><span class="line"><span class="ln">109</span><span class="cl"><span class="w">    </span><span class="nt">meta.helm.sh/release-namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-system</span><span class="w">
</span></span></span><span class="line"><span class="ln">110</span><span class="cl"><span class="w">  </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2023-12-19T13:50:42Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">111</span><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">112</span><span class="cl"><span class="w">    </span><span class="nt">app.kubernetes.io/managed-by</span><span class="p">:</span><span class="w"> </span><span class="l">Helm</span><span class="w">
</span></span></span><span class="line"><span class="ln">113</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cilium-config</span><span class="w">
</span></span></span><span class="line"><span class="ln">114</span><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-system</span><span class="w">
</span></span></span><span class="line"><span class="ln">115</span><span class="cl"><span class="w">  </span><span class="nt">resourceVersion</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;4589&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">116</span><span class="cl"><span class="w">  </span><span class="nt">uid</span><span class="p">:</span><span class="w"> </span><span class="l">f501a3d0-8b33-43af-9fae-63625dcd6df1</span><span class="w">
</span></span></span></code></pre></div><p>These are the two settings that have been changed from being completely default:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln">1</span><span class="cl"><span class="w">  </span><span class="nt">cluster-name</span><span class="p">:</span><span class="w"> </span><span class="l">test-cluster-1</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w">  </span><span class="nt">kube-proxy-replacement</span><span class="p">:</span><span class="w"> </span><span class="l">strict</span><span class="w">
</span></span></span></code></pre></div><p>I prefer editing the changes in a dedicated value.yaml file and run <em>helm upgrade -f value.yaml</em> each time I want to do a change so going forward I will be the adding/changing certain settings in this value.yaml file to update the settings in Cilium.</p>
<p>I grabbed the default value yaml from the Helm repo and use that to alter the settings in the next sections.</p>
<h3 id="enabling-features-using-cilium-cli">Enabling features using Cilium cli</h3>
<p>The cilium-cli can also be used to enable disable features certain features like Hubble and clustermesh. An example on how to install Hubble with cilium-cli is shown below in the next chapter, but I can also use Helm to achieve the same. I enable Hubble using cilium-cli just to show how easy it is.</p>
<p>But as I mention above, I prefer using the Helm method as I can keep better track of the settings and have them consistent each time I alter an update and refering to my value.yaml file.</p>
<h2 id="observability-and-flow-monitoring---hubble-observability">Observability and flow-monitoring - Hubble Observability</h2>
<p>Cilium comes with a very neat monitor tool out of the box called Hubble. It is enabled by default but I need to enable the Hubble Relay and Hubble UI feature to get the information from my nodes, pods etc available in a nice dashboard (Hubble UI), so this is a feature I certainly want to enable as one of the first features to test out.</p>
<p>More details <a href="https://docs.cilium.io/en/stable/gettingstarted/hubble/">here</a> and <a href="https://docs.cilium.io/en/stable/gettingstarted/hubble_setup/">here</a></p>
<p>If I do a quick check with cilium cli now I can see the Hubble Relay is disabled.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">andreasm@linuxmgmt01:~/test-cluster-1$ cilium status
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">    /¬Ø¬Ø<span class="se">\
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="se"></span> /¬Ø¬Ø<span class="se">\_</span>_/¬Ø¬Ø<span class="se">\ </span>   Cilium:             OK
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"> <span class="se">\_</span>_/¬Ø¬Ø<span class="se">\_</span>_/    Operator:           OK
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"> /¬Ø¬Ø<span class="se">\_</span>_/¬Ø¬Ø<span class="se">\ </span>   Envoy DaemonSet:    disabled <span class="o">(</span>using embedded mode<span class="o">)</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl"> <span class="se">\_</span>_/¬Ø¬Ø<span class="se">\_</span>_/    Hubble Relay:       disabled
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">    <span class="se">\_</span>_/       ClusterMesh:        disabled
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">DaemonSet              cilium             Desired: 4, Ready: 4/4, Available: 4/4
</span></span><span class="line"><span class="ln">10</span><span class="cl">Deployment             cilium-operator    Desired: 1, Ready: 1/1, Available: 1/1
</span></span><span class="line"><span class="ln">11</span><span class="cl">Containers:            cilium             Running: <span class="m">4</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">                       cilium-operator    Running: <span class="m">1</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">Cluster Pods:          2/2 managed by Cilium
</span></span><span class="line"><span class="ln">14</span><span class="cl">Helm chart version:    1.14.5
</span></span><span class="line"><span class="ln">15</span><span class="cl">Image versions         cilium             quay.io/cilium/cilium:v1.14.5@sha256:d3b287029755b6a47dee01420e2ea469469f1b174a2089c10af7e5e9289ef05b: <span class="m">4</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">                       cilium-operator    quay.io/cilium/operator-generic:v1.14.5@sha256:303f9076bdc73b3fc32aaedee64a14f6f44c8bb08ee9e3956d443021103ebe7a: <span class="m">1</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">
</span></span><span class="line"><span class="ln">18</span><span class="cl">andreasm@linuxmgmt01:~/test-cluster-1$ k get svc -n kube-system
</span></span><span class="line"><span class="ln">19</span><span class="cl">NAME          TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>                  AGE
</span></span><span class="line"><span class="ln">20</span><span class="cl">hubble-peer   ClusterIP   10.23.182.223   &lt;none&gt;        443/TCP                  69m
</span></span><span class="line"><span class="ln">21</span><span class="cl">kube-dns      ClusterIP   10.23.0.10      &lt;none&gt;        53/UDP,53/TCP,9153/TCP   109m
</span></span></code></pre></div><p>To enable it, it is as simple as running this command:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@linuxmgmt01:~/test-cluster-1$ cilium hubble <span class="nb">enable</span>
</span></span></code></pre></div><p>This command enables the Hubble Relay.</p>
<p>Lets check the stats of Cilium:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">andreasm@linuxmgmt01:~/test-cluster-1$ cilium status
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">    /¬Ø¬Ø<span class="se">\
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="se"></span> /¬Ø¬Ø<span class="se">\_</span>_/¬Ø¬Ø<span class="se">\ </span>   Cilium:             OK
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"> <span class="se">\_</span>_/¬Ø¬Ø<span class="se">\_</span>_/    Operator:           OK
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"> /¬Ø¬Ø<span class="se">\_</span>_/¬Ø¬Ø<span class="se">\ </span>   Envoy DaemonSet:    disabled <span class="o">(</span>using embedded mode<span class="o">)</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl"> <span class="se">\_</span>_/¬Ø¬Ø<span class="se">\_</span>_/    Hubble Relay:       OK
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">    <span class="se">\_</span>_/       ClusterMesh:        disabled
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">DaemonSet              cilium             Desired: 4, Ready: 4/4, Available: 4/4
</span></span><span class="line"><span class="ln">10</span><span class="cl">Deployment             cilium-operator    Desired: 1, Ready: 1/1, Available: 1/1
</span></span><span class="line"><span class="ln">11</span><span class="cl">Deployment             hubble-relay       Desired: 1, Ready: 1/1, Available: 1/1
</span></span><span class="line"><span class="ln">12</span><span class="cl">Containers:            cilium             Running: <span class="m">4</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">                       cilium-operator    Running: <span class="m">1</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">                       hubble-relay       Running: <span class="m">1</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">Cluster Pods:          3/3 managed by Cilium
</span></span><span class="line"><span class="ln">16</span><span class="cl">Helm chart version:    1.14.5
</span></span><span class="line"><span class="ln">17</span><span class="cl">Image versions         cilium             quay.io/cilium/cilium:v1.14.5@sha256:d3b287029755b6a47dee01420e2ea469469f1b174a2089c10af7e5e9289ef05b: <span class="m">4</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">                       cilium-operator    quay.io/cilium/operator-generic:v1.14.5@sha256:303f9076bdc73b3fc32aaedee64a14f6f44c8bb08ee9e3956d443021103ebe7a: <span class="m">1</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">                       hubble-relay       quay.io/cilium/hubble-relay:v1.14.5@sha256:dbef89f924a927043d02b40c18e417c1ea0e8f58b44523b80fef7e3652db24d4: <span class="m">1</span>
</span></span></code></pre></div><p>Hubble Relay OK</p>
<p>Now I need to enable the Hubble UI.</p>
<p>Again, uisng Cilium-CLI its a very quick and simple operation:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@linuxmgmt01:~$ cilium hubble <span class="nb">enable</span> --ui
</span></span></code></pre></div><p>Lets check the services in my cluster:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@linuxmgmt01:~$ k get svc -n kube-system
</span></span><span class="line"><span class="ln">2</span><span class="cl">NAME           TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>                  AGE
</span></span><span class="line"><span class="ln">3</span><span class="cl">hubble-peer    ClusterIP   10.23.182.223   &lt;none&gt;        443/TCP                  6h19m
</span></span><span class="line"><span class="ln">4</span><span class="cl">hubble-relay   ClusterIP   10.23.182.76    &lt;none&gt;        80/TCP                   4h34m
</span></span><span class="line"><span class="ln">5</span><span class="cl">hubble-ui      ClusterIP   10.23.31.4      &lt;none&gt;        80/TCP                   42s
</span></span><span class="line"><span class="ln">6</span><span class="cl">kube-dns       ClusterIP   10.23.0.10      &lt;none&gt;        53/UDP,53/TCP,9153/TCP   6h59m
</span></span></code></pre></div><p>Hubble Relay and Hubble UI service is enabled. The issue though is that they are exposed using clusterIP, I need to reach them from the outside of my cluster. Lets continue with the next feature to test: LB-IPAM.</p>
<p><strong>Using Helm to enable Hubble Relay and Hubble-UI</strong></p>
<p>Instead of using clilium cli I would have enabled the Relay and UI in my value.yaml file and run the following command:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">andreasm@linuxmgmt01:~/test-cluster-1$ helm upgrade -n kube-system cilium cilium/cilium --version 1.14.5 -f cilium-values-feature-by-feature.yaml
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">Release <span class="s2">&#34;cilium&#34;</span> has been upgraded. Happy Helming!
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">NAME: cilium
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">LAST DEPLOYED: Tue Dec <span class="m">19</span> 20:32:12 <span class="m">2023</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">NAMESPACE: kube-system
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">STATUS: deployed
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">REVISION: <span class="m">13</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">TEST SUITE: None
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">NOTES:
</span></span><span class="line"><span class="ln">10</span><span class="cl">You have successfully installed Cilium with Hubble Relay and Hubble UI.
</span></span><span class="line"><span class="ln">11</span><span class="cl">
</span></span><span class="line"><span class="ln">12</span><span class="cl">Your release version is 1.14.5.
</span></span><span class="line"><span class="ln">13</span><span class="cl">
</span></span><span class="line"><span class="ln">14</span><span class="cl">For any further help, visit https://docs.cilium.io/en/v1.14/gettinghelp
</span></span></code></pre></div><p>Where I have changed these settings in the value.yaml:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="w"> </span><span class="nt">relay</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">    </span><span class="c"># -- Enable Hubble Relay (requires hubble.enabled=true)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w"> </span><span class="l">......</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">   </span><span class="nt">ui</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="c"># -- Whether to enable the Hubble UI.</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w"> </span><span class="l">........</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w"> </span><span class="nt">hubble</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">  </span><span class="c"># -- Enable Hubble (true by default).</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w"></span><span class="nn">...</span><span class="l">.........</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">  </span><span class="c"># -- Buffer size of the channel Hubble uses to receive monitor events. If this</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">  </span><span class="c"># value is not set, the queue size is set to the default monitor queue size.</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">  </span><span class="c"># eventQueueSize: &#34;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">  </span><span class="c"># -- Number of recent flows for Hubble to cache. Defaults to 4095.</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">  </span><span class="c"># Possible values are:</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">  </span><span class="c">#   1, 3, 7, 15, 31, 63, 127, 255, 511, 1023,</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">  </span><span class="c">#   2047, 4095, 8191, 16383, 32767, 65535</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">  </span><span class="c"># eventBufferCapacity: &#34;4095&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">  </span><span class="c"># -- Hubble metrics configuration.</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">  </span><span class="c"># See https://docs.cilium.io/en/stable/observability/metrics/#hubble-metrics</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">  </span><span class="c"># for more comprehensive documentation about Hubble metrics.</span><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w">  </span><span class="nt">metrics</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w">    </span><span class="c"># -- Configures the list of metrics to collect. If empty or null, metrics</span><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w">    </span><span class="c"># are disabled.</span><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">    </span><span class="c"># Example:</span><span class="w">
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w">    </span><span class="c">#</span><span class="w">
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="w">    </span><span class="c">#   enabled:</span><span class="w">
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="w">    </span><span class="c">#   - dns:query;ignoreAAAA</span><span class="w">
</span></span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="w">    </span><span class="c">#   - drop</span><span class="w">
</span></span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="w">    </span><span class="c">#   - tcp</span><span class="w">
</span></span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="w">    </span><span class="c">#   - flow</span><span class="w">
</span></span></span><span class="line"><span class="ln">36</span><span class="cl"><span class="w">    </span><span class="c">#   - icmp</span><span class="w">
</span></span></span><span class="line"><span class="ln">37</span><span class="cl"><span class="w">    </span><span class="c">#   - http</span><span class="w">
</span></span></span><span class="line"><span class="ln">38</span><span class="cl"><span class="w">    </span><span class="c">#</span><span class="w">
</span></span></span><span class="line"><span class="ln">39</span><span class="cl"><span class="w">    </span><span class="c"># You can specify the list of metrics from the helm CLI:</span><span class="w">
</span></span></span><span class="line"><span class="ln">40</span><span class="cl"><span class="w">    </span><span class="c">#</span><span class="w">
</span></span></span><span class="line"><span class="ln">41</span><span class="cl"><span class="w">    </span><span class="c">#   --set metrics.enabled=&#34;{dns:query;ignoreAAAA,drop,tcp,flow,icmp,http}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">42</span><span class="cl"><span class="w">    </span><span class="c">#</span><span class="w">
</span></span></span><span class="line"><span class="ln">43</span><span class="cl"><span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">44</span><span class="cl"><span class="w">    </span>- <span class="l">dns:query;ignoreAAAA </span><span class="w"> </span><span class="c">### added these</span><span class="w">
</span></span></span><span class="line"><span class="ln">45</span><span class="cl"><span class="w">    </span>- <span class="l">drop                 </span><span class="w"> </span><span class="c">### added these</span><span class="w">
</span></span></span><span class="line"><span class="ln">46</span><span class="cl"><span class="w">    </span>- <span class="l">tcp                  </span><span class="w"> </span><span class="c">### added these</span><span class="w">
</span></span></span><span class="line"><span class="ln">47</span><span class="cl"><span class="w">    </span>- <span class="l">flow                 </span><span class="w"> </span><span class="c">### added these</span><span class="w">
</span></span></span><span class="line"><span class="ln">48</span><span class="cl"><span class="w">    </span>- <span class="l">icmp                 </span><span class="w"> </span><span class="c">### added these</span><span class="w">
</span></span></span><span class="line"><span class="ln">49</span><span class="cl"><span class="w">    </span>- <span class="l">http                 </span><span class="w"> </span><span class="c">### added these</span><span class="w">
</span></span></span><span class="line"><span class="ln">50</span><span class="cl"><span class="w"> </span><span class="l">.........</span><span class="w">
</span></span></span><span class="line"><span class="ln">51</span><span class="cl"><span class="w"> 
</span></span></span><span class="line"><span class="ln">52</span><span class="cl"><span class="w"> 
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">andreasm@linuxmgmt01:~/test-cluster-1$ cilium status
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">    /¬Ø¬Ø<span class="se">\
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="se"></span> /¬Ø¬Ø<span class="se">\_</span>_/¬Ø¬Ø<span class="se">\ </span>   Cilium:             OK
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"> <span class="se">\_</span>_/¬Ø¬Ø<span class="se">\_</span>_/    Operator:           OK
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"> /¬Ø¬Ø<span class="se">\_</span>_/¬Ø¬Ø<span class="se">\ </span>   Envoy DaemonSet:    disabled <span class="o">(</span>using embedded mode<span class="o">)</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl"> <span class="se">\_</span>_/¬Ø¬Ø<span class="se">\_</span>_/    Hubble Relay:       OK
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">    <span class="se">\_</span>_/       ClusterMesh:        disabled
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">Deployment             cilium-operator    Desired: 2, Ready: 2/2, Available: 2/2
</span></span><span class="line"><span class="ln">10</span><span class="cl">DaemonSet              cilium             Desired: 4, Ready: 4/4, Available: 4/4
</span></span><span class="line"><span class="ln">11</span><span class="cl">Deployment             hubble-ui          Desired: 1, Ready: 1/1, Available: 1/1
</span></span><span class="line"><span class="ln">12</span><span class="cl">Deployment             hubble-relay       Desired: 1, Ready: 1/1, Available: 1/1
</span></span><span class="line"><span class="ln">13</span><span class="cl">Containers:            cilium             Running: <span class="m">4</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">                       hubble-ui          Running: <span class="m">1</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">                       hubble-relay       Running: <span class="m">1</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">                       cilium-operator    Running: <span class="m">2</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">Cluster Pods:          4/4 managed by Cilium
</span></span><span class="line"><span class="ln">18</span><span class="cl">Helm chart version:    1.14.5
</span></span><span class="line"><span class="ln">19</span><span class="cl">Image versions         cilium             quay.io/cilium/cilium:v1.14.5@sha256:d3b287029755b6a47dee01420e2ea469469f1b174a2089c10af7e5e9289ef05b: <span class="m">4</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">                       hubble-ui          quay.io/cilium/hubble-ui:v0.12.1@sha256:9e5f81ee747866480ea1ac4630eb6975ff9227f9782b7c93919c081c33f38267: <span class="m">1</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl">                       hubble-ui          quay.io/cilium/hubble-ui-backend:v0.12.1@sha256:1f86f3400827a0451e6332262467f894eeb7caf0eb8779bd951e2caa9d027cbe: <span class="m">1</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl">                       hubble-relay       quay.io/cilium/hubble-relay:v1.14.5@sha256:dbef89f924a927043d02b40c18e417c1ea0e8f58b44523b80fef7e3652db24d4: <span class="m">1</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl">                       cilium-operator    quay.io/cilium/operator-generic:v1.14.5@sha256:303f9076bdc73b3fc32aaedee64a14f6f44c8bb08ee9e3956d443021103ebe7a: <span class="m">2</span>
</span></span></code></pre></div><p>I will get back to the Hubble UI later...</p>
<h2 id="lb-ipam">LB-IPAM</h2>
<p>Exposing a service from Kubernetes to be accessible from outside the cluster can be done in a couple of ways:</p>
<ul>
<li>Exporting the service by binding it to a node using NodePort (not scalable and manageable).</li>
<li>Exporting the service using a servicetype of loadBalancer, only Layer4, though scalable. Usually requires external load balancer installed or some additional component installed and configured to support your Kubernetes platform.</li>
<li>Exporting using Ingress, Layer7, requires a loadbalancer to provide exernal IP address</li>
<li>Exporting using GatewayAPI (Ingress successor), requires a loadbalancer to provide exernal IP address.</li>
</ul>
<p>Cilium has really made it simple here, it comes with a built in LoadBalancer-IPAM. More info <a href="https://docs.cilium.io/en/stable/network/lb-ipam/">here</a>.</p>
<p>This is already enabled, no feature to install or enable. The only thing I need to do is to configure an IP pool that will provide ip addresses from a defined subnet when I request a serviceType loadBalancer, Ingress or Gateway. We can configure multiple pools with different subnets,  and configure a serviceSelector matching on labels or expressions.</p>
<p>In my lab I have already configured a couple of IP pools, using different subnets and different serviceSelectors so I can control which service gets IP addresses from which pool.</p>
<p>A couple of example pools from my lab:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;cilium.io/v2alpha1&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">CiliumLoadBalancerIPPool</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;gateway-api-pool-10.150.14.x&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">  </span><span class="nt">cidrs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">  </span>- <span class="nt">cidr</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;10.150.14.0/24&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">  </span><span class="nt">serviceSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    </span><span class="nt">matchExpressions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">      </span>- {<span class="nt">key: io.kubernetes.service.namespace, operator: In, values</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="l">harbor, booking]}</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;cilium.io/v2alpha1&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">CiliumLoadBalancerIPPool</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;lb-pool-prod.10.150.11.x&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">  </span><span class="nt">cidrs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">  </span>- <span class="nt">cidr</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;10.150.11.0/24&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">  </span><span class="nt">serviceSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">    </span><span class="nt">matchExpressions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">      </span>- {<span class="nt">key: env, operator: In, values</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="l">prod]}</span><span class="w">
</span></span></span></code></pre></div><p>The first pool will only provide IP addresses to services being deployed in any of the two namespaces &quot;harbor&quot; or &quot;booking&quot;. This is an &quot;OR&quot; selection, not AND, meaning it can be deployed in any of the namespaces, not both. The second will use lablels and match on the key-value: env=prod.</p>

<div class="notices info">
    <div class="label">Info</div>
    <p>Bear in mind that these IP Pools will only listen for services (serviceType loadBalancer) not Ingress pr say. That means each time you create an Ingress or a Gateway the serviceType loadBalancer will be auto-created as a reaction to the Ingress/Gateway creation. So if you try to create labels on the Ingress/Gatewat object it will not be noticed by the LB-IPAM pool. Instead you can adjust the selection based on the namespace you know it will be created in, or use this label that is auto-created on the svc: &quot;Labels:                   io.cilium.gateway/owning-gateway=&quot;name-of-gateway&quot;&quot;</p>

  </div>

<p>As soon as you have created an ip-pool, applied it, it will immediately start to serve requests by providing IP addresses to them. This is very nice.
There is a small catch though. If I create IP Pools, as above, which is outside of my nodes subnet how does my network know how to reach these subnets? Creating static routes and pointing to my nodes that potentially holds these ip addresses? Nah.. Not scalable, nor manageable.  Some kind of dynamic routing protocol would be best here,  BGP or OSPF.
Did I mention that Cilium also includes support for BGP out of the box?</p>
<h2 id="bgp-control-plane">BGP Control Plane</h2>
<p>Yes, you guessed it, Cilium includes BGP. A brilliant way of advertising all my IP pools. Creating many IP pools with a bunch of subnets have never been more fun. This is the same concept as I write about <a href="https://blog.andreasm.io/2023/02/20/antrea-egress/">here</a>, the biggest difference is that with Cilium this only needs to be enabled as a feature and then define a yaml to confgure the bgp settings. Nothing additional to install, just Plug'nPlay.</p>
<p>For more info on the BGP control plane, read <a href="https://docs.cilium.io/en/stable/network/bgp-control-plane/">here</a>.</p>
<p>First out, enable the BGP control plane feature. To enable it I will alter my Helm value.yaml file with this setting:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln">1</span><span class="cl"><span class="c"># -- This feature set enables virtual BGP routers to be created via</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="c"># CiliumBGPPeeringPolicy CRDs.</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w"></span><span class="nt">bgpControlPlane</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w">  </span><span class="c"># -- Enables the BGP control plane.</span><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span></code></pre></div><p>Then run the command:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">helm upgrade -n kube-system cilium cilium/cilium --version 1.14.5 -f cilium-values-feature-by-feature.yaml
</span></span></code></pre></div><p>This will enable the bgp control plane feature:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="l">andreasm@linuxmgmt01:~/test-cluster-1$ cilium config view</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="l">agent-not-ready-taint-key                         node.cilium.io/agent-not-ready</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="l">arping-refresh-period                             30s</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w"></span><span class="l">auto-direct-node-routes                           false</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w"></span><span class="l">bpf-lb-external-clusterip                         false</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w"></span><span class="l">bpf-lb-map-max                                    65536</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w"></span><span class="l">bpf-lb-sock                                       false</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w"></span><span class="l">bpf-map-dynamic-size-ratio                        0.0025</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w"></span><span class="l">bpf-policy-map-max                                16384</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w"></span><span class="l">bpf-root                                          /sys/fs/bpf</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w"></span><span class="l">cgroup-root                                       /run/cilium/cgroupv2</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w"></span><span class="l">cilium-endpoint-gc-interval                       5m0s</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w"></span><span class="l">cluster-id                                        0</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w"></span><span class="l">cluster-name                                      test-cluster-1</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w"></span><span class="l">cluster-pool-ipv4-cidr                            10.0.0.0/8</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w"></span><span class="l">cluster-pool-ipv4-mask-size                       24</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w"></span><span class="l">cni-exclusive                                     true</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w"></span><span class="l">cni-log-file                                      /var/run/cilium/cilium-cni.log</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w"></span><span class="l">cnp-node-status-gc-interval                       0s</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w"></span><span class="l">custom-cni-conf                                   false</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w"></span><span class="l">debug                                             false</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w"></span><span class="l">disable-cnp-status-updates                        true</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w"></span><span class="l">egress-gateway-reconciliation-trigger-interval    1s</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w"></span><span class="l">enable-auto-protect-node-port-range               true</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w"></span><span class="l">enable-bgp-control-plane                          true</span><span class="w"> </span><span class="c">#### Here it is</span><span class="w">
</span></span></span></code></pre></div><p>Now I need to create a yaml that contains the BGP peering info I need for my workers to peer to my upstream router. For reference I will paste my lab topology here again:</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="my-lab-topology"
      
        class="image_figure image_internal image_processed"
        width="1521"
        height="842"
        src="/2023/12/18/a-quick-glance-at-cilium-cni/images/image-20231219124247767.png"
      
      
    />

    </picture>
</figure>
</p>
<p>When I apply my below BGPPeeringPolicy yaml, my nodes will enable a BGP peering session to the switch (their upstream bgp neighbor) they are connected to in the diagram above. This switch has also been configured to allow them as BGP neigbors. Please take into consideration creating some ip-prefix/route-maps so we dont accidentally advertise routes that confilcts, or should not be advertised into the network to prevent BGP blackholes etc...</p>
<p>Here is my BGP config I apply on my cluster:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;cilium.io/v2alpha1&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">CiliumBGPPeeringPolicy</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="m">01</span>-<span class="l">bgp-peering-policy</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w"> </span><span class="nt">nodeSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">   </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">     </span><span class="nt">bgp-policy</span><span class="p">:</span><span class="w"> </span><span class="l">worker-nodes</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w"> </span><span class="nt">virtualRouters</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w"> </span>- <span class="nt">localASN</span><span class="p">:</span><span class="w"> </span><span class="m">64520</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">   </span><span class="nt">serviceSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">     </span><span class="nt">matchExpressions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">        </span>- {<span class="nt">key: somekey, operator: NotIn, values</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;never-used-value&#39;</span><span class="p">]</span>}<span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">   </span><span class="nt">exportPodCIDR</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">   </span><span class="nt">neighbors</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">    </span>- <span class="nt">peerAddress</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;10.160.1.1/24&#39;</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">      </span><span class="nt">peerASN</span><span class="p">:</span><span class="w"> </span><span class="m">64512</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">      </span><span class="nt">eBGPMultihopTTL</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">      </span><span class="nt">connectRetryTimeSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">120</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">      </span><span class="nt">holdTimeSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">12</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">      </span><span class="nt">keepAliveTimeSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">4</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">      </span><span class="nt">gracefulRestart</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">        </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">        </span><span class="nt">restartTimeSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">120</span><span class="w">
</span></span></span></code></pre></div><p>Here we can also configure a serviceSelector to prevent services we dont want to be advertised. I used used the example from the official docs to allow everything. If I also have a good BGP route-map config on my switch side or upstream bgp neighbour subnets that are not allowed will never be advertised.</p>
<p>Now that I have applied it I can check the bgp peering status using the Cilium cli:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@linuxmgmt01:~/prod-cluster-1/cilium$ cilium bgp peers
</span></span><span class="line"><span class="ln">2</span><span class="cl">Node               Local AS   Peer AS   Peer Address   Session State   Uptime     Family         Received   Advertised
</span></span><span class="line"><span class="ln">3</span><span class="cl">k8s-prod-node-01   <span class="m">64520</span>      <span class="m">64512</span>     10.160.1.1     established     13h2m53s   ipv4/unicast   <span class="m">47</span>         <span class="m">6</span>
</span></span><span class="line"><span class="ln">4</span><span class="cl">                                                                                  ipv6/unicast   <span class="m">0</span>          <span class="m">0</span>
</span></span><span class="line"><span class="ln">5</span><span class="cl">k8s-prod-node-02   <span class="m">64520</span>      <span class="m">64512</span>     10.160.1.1     established     13h2m25s   ipv4/unicast   <span class="m">45</span>         <span class="m">6</span>
</span></span><span class="line"><span class="ln">6</span><span class="cl">                                                                                  ipv6/unicast   <span class="m">0</span>          <span class="m">0</span>
</span></span><span class="line"><span class="ln">7</span><span class="cl">k8s-prod-node-03   <span class="m">64520</span>      <span class="m">64512</span>     10.160.1.1     established     13h2m27s   ipv4/unicast   <span class="m">43</span>         <span class="m">6</span>
</span></span><span class="line"><span class="ln">8</span><span class="cl">                                                                                  ipv6/unicast   <span class="m">0</span>          <span class="m">0</span>
</span></span></code></pre></div><p>I can see some prefixes being Advertised and some being Received and the Session State is Established. I can also confirm that on my switch, and the routes they advertise:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">GUZ-SW-01# show ip bgp summary
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"> Peer Information
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">  Remote Address  Remote-AS Local-AS State         Admin Status
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">  --------------- --------- -------- ------------- ------------
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">  10.160.1.114    <span class="m">64520</span>     <span class="m">64512</span>    Established   Start
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">  10.160.1.115    <span class="m">64520</span>     <span class="m">64512</span>    Established   Start
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">  10.160.1.116    <span class="m">64520</span>     <span class="m">64512</span>    Established   Start
</span></span><span class="line"><span class="ln">10</span><span class="cl">  172.18.1.1      <span class="m">64500</span>     <span class="m">64512</span>    Established   Start
</span></span><span class="line"><span class="ln">11</span><span class="cl">GUZ-SW-01# show ip bgp
</span></span><span class="line"><span class="ln">12</span><span class="cl">
</span></span><span class="line"><span class="ln">13</span><span class="cl">  Local AS            : <span class="m">64512</span>         Local Router-id  : 172.18.1.2
</span></span><span class="line"><span class="ln">14</span><span class="cl">  BGP Table Version   : <span class="m">1706</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">
</span></span><span class="line"><span class="ln">16</span><span class="cl">  Status codes: * - valid, &gt; - best, i - internal, e - external, s - stale
</span></span><span class="line"><span class="ln">17</span><span class="cl">  Origin codes: i - IGP, e - EGP, ? - incomplete
</span></span><span class="line"><span class="ln">18</span><span class="cl">
</span></span><span class="line"><span class="ln">19</span><span class="cl">     Network            Nexthop         Metric     LocalPref  Weight AsPath
</span></span><span class="line"><span class="ln">20</span><span class="cl">     ------------------ --------------- ---------- ---------- ------ ---------
</span></span><span class="line"><span class="ln">21</span><span class="cl">* e  10.150.11.10/32    10.160.1.114    <span class="m">0</span>                     <span class="m">0</span>      <span class="m">64520</span>    i
</span></span><span class="line"><span class="ln">22</span><span class="cl">*&gt;e  10.150.11.10/32    10.160.1.115    <span class="m">0</span>                     <span class="m">0</span>      <span class="m">64520</span>    i
</span></span><span class="line"><span class="ln">23</span><span class="cl">* e  10.150.11.10/32    10.160.1.116    <span class="m">0</span>                     <span class="m">0</span>      <span class="m">64520</span>    i
</span></span><span class="line"><span class="ln">24</span><span class="cl">* e  10.150.11.199/32   10.160.1.114    <span class="m">0</span>                     <span class="m">0</span>      <span class="m">64520</span>    i
</span></span><span class="line"><span class="ln">25</span><span class="cl">* e  10.150.11.199/32   10.160.1.115    <span class="m">0</span>                     <span class="m">0</span>      <span class="m">64520</span>    i
</span></span><span class="line"><span class="ln">26</span><span class="cl">*&gt;e  10.150.11.199/32   10.160.1.116    <span class="m">0</span>                     <span class="m">0</span>      <span class="m">64520</span>    i
</span></span><span class="line"><span class="ln">27</span><span class="cl">* e  10.150.12.4/32     10.160.1.114    <span class="m">0</span>                     <span class="m">0</span>      <span class="m">64520</span>    i
</span></span><span class="line"><span class="ln">28</span><span class="cl">* e  10.150.12.4/32     10.160.1.115    <span class="m">0</span>                     <span class="m">0</span>      <span class="m">64520</span>    i
</span></span><span class="line"><span class="ln">29</span><span class="cl">*&gt;e  10.150.12.4/32     10.160.1.116    <span class="m">0</span>                     <span class="m">0</span>      <span class="m">64520</span>    i
</span></span><span class="line"><span class="ln">30</span><span class="cl">* e  10.150.14.32/32    10.160.1.114    <span class="m">0</span>                     <span class="m">0</span>      <span class="m">64520</span>    i
</span></span><span class="line"><span class="ln">31</span><span class="cl">* e  10.150.14.32/32    10.160.1.115    <span class="m">0</span>                     <span class="m">0</span>      <span class="m">64520</span>    i
</span></span><span class="line"><span class="ln">32</span><span class="cl">*&gt;e  10.150.14.32/32    10.160.1.116    <span class="m">0</span>                     <span class="m">0</span>      <span class="m">64520</span>    i
</span></span><span class="line"><span class="ln">33</span><span class="cl">* e  10.150.14.150/32   10.160.1.114    <span class="m">0</span>                     <span class="m">0</span>      <span class="m">64520</span>    i
</span></span><span class="line"><span class="ln">34</span><span class="cl">*&gt;e  10.150.14.150/32   10.160.1.115    <span class="m">0</span>                     <span class="m">0</span>      <span class="m">64520</span>    i
</span></span><span class="line"><span class="ln">35</span><span class="cl">* e  10.150.14.150/32   10.160.1.116    <span class="m">0</span>                     <span class="m">0</span>      <span class="m">64520</span>    i
</span></span><span class="line"><span class="ln">36</span><span class="cl">* e  10.150.15.100/32   10.160.1.114    <span class="m">0</span>                     <span class="m">0</span>      <span class="m">64520</span>    i
</span></span><span class="line"><span class="ln">37</span><span class="cl">* e  10.150.15.100/32   10.160.1.115    <span class="m">0</span>                     <span class="m">0</span>      <span class="m">64520</span>    i
</span></span><span class="line"><span class="ln">38</span><span class="cl">*&gt;e  10.150.15.100/32   10.160.1.116    <span class="m">0</span>                     <span class="m">0</span>      <span class="m">64520</span>    i
</span></span></code></pre></div><p>Now I can just create my IP Pools, create some services and they should be immediately advertised and reachable in my network (unless they are being stopped by some route-maps ofcourse).</p>
<p>Note, it will only advertise ip-addresses in use by a service, not the whole subnet I define in my IP-Pools. That means I will only see host-routes advertised (as seen above).</p>
<h2 id="lb-ipam---does-it-actually-loadbalance">LB-IPAM - does it actually loadbalance?</h2>
<p>It says LoadBalancer IPAM, but does it actually loadbalance? Let me quicly put that to a test.</p>
<p>I have exposed a web service using serviceType loadBalancer consisting of three simple nginx web pods.</p>
<p>Here is the yaml I am using (think I grabbed it from the offical Cilium docs)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">test-lb</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">example</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">     </span><span class="nt">env</span><span class="p">:</span><span class="w"> </span><span class="l">prod</span><span class="w"> </span><span class="c">#### added this label to match with my ip pool</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">LoadBalancer</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">  </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">    </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">    </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">http</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">    </span><span class="nt">svc</span><span class="p">:</span><span class="w"> </span><span class="l">test-lb</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">example</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w">      </span><span class="nt">svc</span><span class="p">:</span><span class="w"> </span><span class="l">test-lb</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w">        </span><span class="nt">svc</span><span class="p">:</span><span class="w"> </span><span class="l">test-lb</span><span class="w">
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">web</span><span class="w">
</span></span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="w">        </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">IfNotPresent</span><span class="w">
</span></span></span><span class="line"><span class="ln">36</span><span class="cl"><span class="w">        </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">37</span><span class="cl"><span class="w">        </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="ln">38</span><span class="cl"><span class="w">        </span><span class="nt">readinessProbe</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">39</span><span class="cl"><span class="w">          </span><span class="nt">httpGet</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">40</span><span class="cl"><span class="w">            </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/</span><span class="w">
</span></span></span><span class="line"><span class="ln">41</span><span class="cl"><span class="w">            </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span></code></pre></div><p>Initially it deploys one pod, I will scale it up to three</p>
<p>They are running here, perfectly distributed across all my worker nodes:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@linuxmgmt01:~/prod-cluster-1/cilium$ k get pods -n example -owide
</span></span><span class="line"><span class="ln">2</span><span class="cl">NAME                     READY   STATUS    RESTARTS   AGE    IP           NODE               NOMINATED NODE   READINESS GATES
</span></span><span class="line"><span class="ln">3</span><span class="cl">nginx-698447f456-5xczj   1/1     Running   <span class="m">0</span>          18s    10.0.0.239   k8s-prod-node-01   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="ln">4</span><span class="cl">nginx-698447f456-plknk   1/1     Running   <span class="m">0</span>          117s   10.0.4.167   k8s-prod-node-02   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="ln">5</span><span class="cl">nginx-698447f456-xs4jq   1/1     Running   <span class="m">0</span>          18s    10.0.5.226   k8s-prod-node-03   &lt;none&gt;           &lt;none&gt;
</span></span></code></pre></div><p>And here is the LB service:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">example        test-lb                             LoadBalancer   10.21.69.190    10.150.11.48    80:31745/TCP
</span></span></code></pre></div><p>Now let me do a curl against the LoadBalancer IP and see if something changes:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">Every 0.5s: curl http://10.150.11.48                                               linuxmgmt01: Wed Dec <span class="m">20</span> 07:58:14 <span class="m">2023</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">                                 Dload  Upload   Total   Spent    Left  Speed
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">   <span class="m">0</span>     <span class="m">0</span>    <span class="m">0</span>     <span class="m">0</span>    <span class="m">0</span>     <span class="m">0</span>      <span class="m">0</span>      <span class="m">0</span> --:--:-- --:--:-- --:--:--     <span class="m">0</span> <span class="m">100</span>   <span class="m">567</span>  <span class="m">100</span>   <span class="m">567</span>    <span class="m">0</span>     <span class="m">0</span>   184k
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">    <span class="m">0</span> --:--:-- --:--:-- --:--:--  276k
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">&lt;!DOCTYPE html&gt;
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">&lt;html&gt;
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">&lt;head&gt;
</span></span><span class="line"><span class="ln">10</span><span class="cl">Pod <span class="m">2</span>   <span class="c1">##### Notice this </span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">&lt;style&gt;
</span></span><span class="line"><span class="ln">12</span><span class="cl">html <span class="o">{</span> color-scheme: light dark<span class="p">;</span> <span class="o">}</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">body <span class="o">{</span> width: 35em<span class="p">;</span> margin: <span class="m">0</span> auto<span class="p">;</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">font-family: Tahoma, Verdana, Arial, sans-serif<span class="p">;</span> <span class="o">}</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">&lt;/style&gt;
</span></span><span class="line"><span class="ln">16</span><span class="cl">&lt;/head&gt;
</span></span><span class="line"><span class="ln">17</span><span class="cl">&lt;body&gt;
</span></span><span class="line"><span class="ln">18</span><span class="cl">Pod <span class="m">2</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">&lt;p&gt;If you see this page, the nginx web server is successfully installed and
</span></span><span class="line"><span class="ln">20</span><span class="cl">working. Further configuration is required.&lt;/p&gt;
</span></span><span class="line"><span class="ln">21</span><span class="cl">
</span></span><span class="line"><span class="ln">22</span><span class="cl">&lt;p&gt;For online documentation and support please refer to
</span></span><span class="line"><span class="ln">23</span><span class="cl">&lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&#34;http://nginx.org/&#34;</span>&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;
</span></span><span class="line"><span class="ln">24</span><span class="cl">Commercial support is available at
</span></span><span class="line"><span class="ln">25</span><span class="cl">&lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&#34;http://nginx.com/&#34;</span>&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;
</span></span><span class="line"><span class="ln">26</span><span class="cl">
</span></span><span class="line"><span class="ln">27</span><span class="cl">&lt;p&gt;&lt;em&gt;Thank you <span class="k">for</span> using nginx.&lt;/em&gt;&lt;/p&gt;
</span></span><span class="line"><span class="ln">28</span><span class="cl">&lt;/body&gt;
</span></span><span class="line"><span class="ln">29</span><span class="cl">&lt;/html&gt;
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">Every 0.5s: curl http://10.150.11.48                                               linuxmgmt01: Wed Dec <span class="m">20</span> 07:59:15 <span class="m">2023</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">                                 Dload  Upload   Total   Spent    Left  Speed
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">   <span class="m">0</span>     <span class="m">0</span>    <span class="m">0</span>     <span class="m">0</span>    <span class="m">0</span>     <span class="m">0</span>      <span class="m">0</span>      <span class="m">0</span> --:--:-- --:--:-- --:--:--     <span class="m">0</span> <span class="m">100</span>   <span class="m">567</span>  <span class="m">100</span>   <span class="m">567</span>    <span class="m">0</span>     <span class="m">0</span>   110k
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">    <span class="m">0</span> --:--:-- --:--:-- --:--:--  138k
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">&lt;!DOCTYPE html&gt;
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">&lt;html&gt;
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">&lt;head&gt;
</span></span><span class="line"><span class="ln">10</span><span class="cl">Pod <span class="m">1</span>     <span class="c1">##### Notice this</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">&lt;style&gt;
</span></span><span class="line"><span class="ln">12</span><span class="cl">html <span class="o">{</span> color-scheme: light dark<span class="p">;</span> <span class="o">}</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">body <span class="o">{</span> width: 35em<span class="p">;</span> margin: <span class="m">0</span> auto<span class="p">;</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">font-family: Tahoma, Verdana, Arial, sans-serif<span class="p">;</span> <span class="o">}</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">&lt;/style&gt;
</span></span><span class="line"><span class="ln">16</span><span class="cl">&lt;/head&gt;
</span></span><span class="line"><span class="ln">17</span><span class="cl">&lt;body&gt;
</span></span><span class="line"><span class="ln">18</span><span class="cl">Pod <span class="m">1</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">&lt;p&gt;If you see this page, the nginx web server is successfully installed and
</span></span><span class="line"><span class="ln">20</span><span class="cl">working. Further configuration is required.&lt;/p&gt;
</span></span><span class="line"><span class="ln">21</span><span class="cl">
</span></span><span class="line"><span class="ln">22</span><span class="cl">&lt;p&gt;For online documentation and support please refer to
</span></span><span class="line"><span class="ln">23</span><span class="cl">&lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&#34;http://nginx.org/&#34;</span>&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;
</span></span><span class="line"><span class="ln">24</span><span class="cl">Commercial support is available at
</span></span><span class="line"><span class="ln">25</span><span class="cl">&lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&#34;http://nginx.com/&#34;</span>&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;
</span></span><span class="line"><span class="ln">26</span><span class="cl">
</span></span><span class="line"><span class="ln">27</span><span class="cl">&lt;p&gt;&lt;em&gt;Thank you <span class="k">for</span> using nginx.&lt;/em&gt;&lt;/p&gt;
</span></span><span class="line"><span class="ln">28</span><span class="cl">&lt;/body&gt;
</span></span><span class="line"><span class="ln">29</span><span class="cl">&lt;/html&gt;
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">Every 0.5s: curl http://10.150.11.48                                               linuxmgmt01: Wed Dec <span class="m">20</span> 08:01:02 <span class="m">2023</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">                                 Dload  Upload   Total   Spent    Left  Speed
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">   <span class="m">0</span>     <span class="m">0</span>    <span class="m">0</span>     <span class="m">0</span>    <span class="m">0</span>     <span class="m">0</span>      <span class="m">0</span>      <span class="m">0</span> --:--:-- --:--:-- --:--:--     <span class="m">0</span> <span class="m">100</span>   <span class="m">567</span>  <span class="m">100</span>   <span class="m">567</span>    <span class="m">0</span>     <span class="m">0</span>   553k
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">    <span class="m">0</span> --:--:-- --:--:-- --:--:--  553k
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">&lt;!DOCTYPE html&gt;
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">&lt;html&gt;
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">&lt;head&gt;
</span></span><span class="line"><span class="ln">10</span><span class="cl">Pod <span class="m">3</span>    <span class="c1">##### Notice this</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">&lt;style&gt;
</span></span><span class="line"><span class="ln">12</span><span class="cl">html <span class="o">{</span> color-scheme: light dark<span class="p">;</span> <span class="o">}</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">body <span class="o">{</span> width: 35em<span class="p">;</span> margin: <span class="m">0</span> auto<span class="p">;</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">font-family: Tahoma, Verdana, Arial, sans-serif<span class="p">;</span> <span class="o">}</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">&lt;/style&gt;
</span></span><span class="line"><span class="ln">16</span><span class="cl">&lt;/head&gt;
</span></span><span class="line"><span class="ln">17</span><span class="cl">&lt;body&gt;
</span></span><span class="line"><span class="ln">18</span><span class="cl">Pod <span class="m">3</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">&lt;p&gt;If you see this page, the nginx web server is successfully installed and
</span></span><span class="line"><span class="ln">20</span><span class="cl">working. Further configuration is required.&lt;/p&gt;
</span></span><span class="line"><span class="ln">21</span><span class="cl">
</span></span><span class="line"><span class="ln">22</span><span class="cl">&lt;p&gt;For online documentation and support please refer to
</span></span><span class="line"><span class="ln">23</span><span class="cl">&lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&#34;http://nginx.org/&#34;</span>&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;
</span></span><span class="line"><span class="ln">24</span><span class="cl">Commercial support is available at
</span></span><span class="line"><span class="ln">25</span><span class="cl">&lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&#34;http://nginx.com/&#34;</span>&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;
</span></span><span class="line"><span class="ln">26</span><span class="cl">
</span></span><span class="line"><span class="ln">27</span><span class="cl">&lt;p&gt;&lt;em&gt;Thank you <span class="k">for</span> using nginx.&lt;/em&gt;&lt;/p&gt;
</span></span><span class="line"><span class="ln">28</span><span class="cl">&lt;/body&gt;
</span></span><span class="line"><span class="ln">29</span><span class="cl">&lt;/html&gt;
</span></span></code></pre></div><p>Well, it is actually load-balancing the requests to the three different pods, running on three different nodes.
And it took me about 5 seconds to apply the ip-pool yaml and the bgppeeringpolicy yaml and I had a fully functioning load-balancer.</p>
<p>A bit more info on this feature from the offical Cilium docs:</p>
<blockquote>
<p>LB IPAM works in conjunction with features like the <a href="https://docs.cilium.io/en/stable/network/bgp-control-plane/#bgp-control-plane">Cilium BGP Control Plane (Beta)</a>. Where LB IPAM is responsible for allocation and assigning of IPs to Service objects and other features are responsible for load balancing and/or advertisement of these IPs.</p>
</blockquote>
<p>So I assume the actual loadbalancing is done by BGP here.</p>
<h2 id="cilium-ingress">Cilium Ingress</h2>
<p>As I covered above serviceType loadBalancer, let me quickly cover how to enable Cilium IngressController.
More info can be found <a href="https://docs.cilium.io/en/stable/network/servicemesh/ingress/#gs-ingress">here</a></p>
<p>I will head into my Helm value.yaml and edit the following:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nt">ingressController</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">  </span><span class="c"># -- Enable cilium ingress controller</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">  </span><span class="c"># This will automatically set enable-envoy-config as well.</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">  </span><span class="c"># -- Set cilium ingress controller to be the default ingress controller</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">  </span><span class="c"># This will let cilium ingress controller route entries without ingress class set</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">  </span><span class="nt">default</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">  </span><span class="c"># -- Default ingress load balancer mode</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">  </span><span class="c"># Supported values: shared, dedicated</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">  </span><span class="c"># For granular control, use the following annotations on the ingress resource</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">  </span><span class="c"># ingress.cilium.io/loadbalancer-mode: shared|dedicated,</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">  </span><span class="nt">loadbalancerMode</span><span class="p">:</span><span class="w"> </span><span class="l">dedicated</span><span class="w">
</span></span></span></code></pre></div><p>The Cilium Ingress controller can be dedicated or shared, meaning that it can support a shared IP for multiple Ingress objects. Nice if we are IP limited etc. Additionally we can edit the shared Ingress to configured with a specific IP like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="w">  </span><span class="c"># -- Load-balancer service in shared mode.</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">  </span><span class="c"># This is a single load-balancer service for all Ingress resources.</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">  </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="c"># -- Service name</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cilium-ingress</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="c"># -- Labels to be added for the shared LB service</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">    </span><span class="nt">labels</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">    </span><span class="c"># -- Annotations to be added for the shared LB service</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    </span><span class="nt">annotations</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="c"># -- Service type for the shared LB service</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">LoadBalancer</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">    </span><span class="c"># -- Configure a specific nodePort for insecure HTTP traffic on the shared LB service</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">    </span><span class="nt">insecureNodePort</span><span class="p">:</span><span class="w"> </span><span class="l">~</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">    </span><span class="c"># -- Configure a specific nodePort for secure HTTPS traffic on the shared LB service</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">    </span><span class="nt">secureNodePort </span><span class="p">:</span><span class="w"> </span><span class="l">~</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">    </span><span class="c"># -- Configure a specific loadBalancerClass on the shared LB service (requires Kubernetes 1.24+)</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">    </span><span class="nt">loadBalancerClass</span><span class="p">:</span><span class="w"> </span><span class="l">~</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">    </span><span class="c"># -- Configure a specific loadBalancerIP on the shared LB service</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">    </span><span class="nt">loadBalancerIP </span><span class="p">:</span><span class="w"> </span><span class="m">10.150.11.100</span><span class="w"> </span><span class="c">### Set your preferred IP here</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">    </span><span class="c"># -- Configure if node port allocation is required for LB service</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">    </span><span class="c"># ref: https://kubernetes.io/docs/concepts/services-networking/service/#load-balancer-nodeport-allocation</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">    </span><span class="nt">allocateLoadBalancerNodePorts</span><span class="p">:</span><span class="w"> </span><span class="l">~</span><span class="w">
</span></span></span></code></pre></div><p>This will dictate that the shared Ingress object will get this IP address.</p>
<p>Now save changes and run the helm upgrade command:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">andreasm@linuxmgmt01:~/test-cluster-1$ helm upgrade -n kube-system cilium cilium/cilium --version 1.14.5 -f cilium-values-feature-by-feature.yaml
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">Release <span class="s2">&#34;cilium&#34;</span> has been upgraded. Happy Helming!
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">NAME: cilium
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">LAST DEPLOYED: Wed Dec <span class="m">20</span> 08:18:58 <span class="m">2023</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">NAMESPACE: kube-system
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">STATUS: deployed
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">REVISION: <span class="m">15</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">TEST SUITE: None
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">NOTES:
</span></span><span class="line"><span class="ln">10</span><span class="cl">You have successfully installed Cilium with Hubble Relay and Hubble UI.
</span></span><span class="line"><span class="ln">11</span><span class="cl">
</span></span><span class="line"><span class="ln">12</span><span class="cl">Your release version is 1.14.5.
</span></span><span class="line"><span class="ln">13</span><span class="cl">
</span></span><span class="line"><span class="ln">14</span><span class="cl">For any further help, visit https://docs.cilium.io/en/v1.14/gettinghelp
</span></span></code></pre></div><p>Now is also a good time to restart the Cilium Operator and Cilium Agents to re-read the new configMap.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@linuxmgmt01:~/test-cluster-1$ kubectl -n kube-system rollout restart deployment/cilium-operator
</span></span><span class="line"><span class="ln">2</span><span class="cl">deployment.apps/cilium-operator restarted
</span></span><span class="line"><span class="ln">3</span><span class="cl">andreasm@linuxmgmt01:~/test-cluster-1$ kubectl -n kube-system rollout restart ds/cilium
</span></span><span class="line"><span class="ln">4</span><span class="cl">daemonset.apps/cilium restarted
</span></span></code></pre></div><p>Also check the Cilium status by running this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">andreasm@linuxmgmt01:~/test-cluster-1$ cilium status
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">    /¬Ø¬Ø<span class="se">\
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="se"></span> /¬Ø¬Ø<span class="se">\_</span>_/¬Ø¬Ø<span class="se">\ </span>   Cilium:             OK
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"> <span class="se">\_</span>_/¬Ø¬Ø<span class="se">\_</span>_/    Operator:           OK
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"> /¬Ø¬Ø<span class="se">\_</span>_/¬Ø¬Ø<span class="se">\ </span>   Envoy DaemonSet:    disabled <span class="o">(</span>using embedded mode<span class="o">)</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl"> <span class="se">\_</span>_/¬Ø¬Ø<span class="se">\_</span>_/    Hubble Relay:       OK
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">    <span class="se">\_</span>_/       ClusterMesh:        disabled
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">Deployment             hubble-ui          Desired: 1, Ready: 1/1, Available: 1/1
</span></span><span class="line"><span class="ln">10</span><span class="cl">DaemonSet              cilium             Desired: 4, Ready: 4/4, Available: 4/4
</span></span><span class="line"><span class="ln">11</span><span class="cl">Deployment             cilium-operator    Desired: 2, Ready: 2/2, Available: 2/2
</span></span><span class="line"><span class="ln">12</span><span class="cl">Deployment             hubble-relay       Desired: 1, Ready: 1/1, Available: 1/1
</span></span><span class="line"><span class="ln">13</span><span class="cl">Containers:            cilium             Running: <span class="m">4</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">                       hubble-ui          Running: <span class="m">1</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">                       cilium-operator    Running: <span class="m">2</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">                       hubble-relay       Running: <span class="m">1</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">Cluster Pods:          4/4 managed by Cilium
</span></span><span class="line"><span class="ln">18</span><span class="cl">Helm chart version:    1.14.5
</span></span><span class="line"><span class="ln">19</span><span class="cl">Image versions         hubble-ui          quay.io/cilium/hubble-ui:v0.12.1@sha256:9e5f81ee747866480ea1ac4630eb6975ff9227f9782b7c93919c081c33f38267: <span class="m">1</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">                       hubble-ui          quay.io/cilium/hubble-ui-backend:v0.12.1@sha256:1f86f3400827a0451e6332262467f894eeb7caf0eb8779bd951e2caa9d027cbe: <span class="m">1</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl">                       cilium-operator    quay.io/cilium/operator-generic:v1.14.5@sha256:303f9076bdc73b3fc32aaedee64a14f6f44c8bb08ee9e3956d443021103ebe7a: <span class="m">2</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl">                       hubble-relay       quay.io/cilium/hubble-relay:v1.14.5@sha256:dbef89f924a927043d02b40c18e417c1ea0e8f58b44523b80fef7e3652db24d4: <span class="m">1</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl">                       cilium             quay.io/cilium/cilium:v1.14.5@sha256:d3b287029755b6a47dee01420e2ea469469f1b174a2089c10af7e5e9289ef05b: <span class="m">4</span>
</span></span></code></pre></div><p>As soon as I enable the Ingress controller it will create this object for me, and provide an IngressClass in my cluster.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@linuxmgmt01:~/test-cluster-1$ k get ingressclasses.networking.k8s.io
</span></span><span class="line"><span class="ln">2</span><span class="cl">NAME     CONTROLLER                     PARAMETERS   AGE
</span></span><span class="line"><span class="ln">3</span><span class="cl">cilium   cilium.io/ingress-controller   &lt;none&gt;       86s
</span></span></code></pre></div><p>Now I suddenly have an IngressController also. Let me deploy a test app to test this.</p>
<p>First I deploy two pods with their corresponding clusterIP services:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">apple-app</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">apple</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">fruit</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">apple-app</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">hashicorp/http-echo</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">      </span><span class="nt">args</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">        </span>- <span class="s2">&#34;-text=apple&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">apple-service</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">fruit</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">apple</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w">    </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">5678</span><span class="w"> </span><span class="c"># Default port for image</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">banana-app</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">banana</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">fruit</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">banana-app</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">hashicorp/http-echo</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">      </span><span class="nt">args</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">        </span>- <span class="s2">&#34;-text=banana&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">banana-service</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">fruit</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">banana</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w">    </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">5678</span><span class="w"> </span><span class="c"># Default port for image</span><span class="w">
</span></span></span></code></pre></div><p>And then the Ingress pointing to the two services apple and banana:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">networking.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Ingress</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">ingress-example</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">fruit</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">    </span><span class="nt">env</span><span class="p">:</span><span class="w"> </span><span class="l">test</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    </span><span class="nt">ingress.cilium.io/loadbalancer-mode</span><span class="p">:</span><span class="w"> </span><span class="l">dedicated</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">  </span><span class="nt">ingressClassName</span><span class="p">:</span><span class="w"> </span><span class="l">cilium</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">  </span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">    </span>- <span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l">fruit.my-domain.net</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">      </span><span class="nt">http</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">        </span><span class="nt">paths</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">        </span>- <span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/apple</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">          </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l">Prefix</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">          </span><span class="nt">backend</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">            </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">apple-service</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">              </span><span class="nt">port</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">                </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="m">5678</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">        </span>- <span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/banana</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">          </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l">Prefix</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">          </span><span class="nt">backend</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w">            </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">banana-service</span><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w">              </span><span class="nt">port</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">                </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="m">5678</span><span class="w">
</span></span></span></code></pre></div><p>Notice the only annotation I have used is the loadbalancer-mode: dedicated. The other value that is accepted is <em>shared</em>. By using this annotation I can choose on specific Ingresses whether they should be using the ip from the shared Ingress object or if I want it to be a dedicated one with its own IP address.  If I dont want this Ingress to consume a specific IP address I will use <em>shared</em>, if I want to create a dedicated IP for this Ingress I can use <em>dedicated</em>. The shared service for Ingress object is automatically created when enabling the IngressController. You can see this here:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@linuxmgmt01:~$ k get svc -n kube-system
</span></span><span class="line"><span class="ln">2</span><span class="cl">NAME                    TYPE           CLUSTER-IP      EXTERNAL-IP     PORT<span class="o">(</span>S<span class="o">)</span>                      AGE
</span></span><span class="line"><span class="ln">3</span><span class="cl">cilium-shared-ingress   LoadBalancer   10.21.104.15    10.150.15.100   80:30810/TCP,443:31104/TCP   46h
</span></span></code></pre></div><p>I have configured this shared-ingress to use a specific ip-address.
When using dedicated it will create a cilium-ingress-name-of-Ingress on a new IP address (as can be seen below).</p>
<p>As soon as this has been applied Cilium will automatically take care of the serviceType loadBalancer object by getting an IP address from one of the IP pools that matches my serviceSelections (depending on shared or dedicated ofcourse). Then BGP will automatically advertise the host-route to my BGP router. And the Ingress object should now be listening on HTTP requests on this IP.
Here is the services/objects created:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@linuxmgmt01:~/prod-cluster-1/cilium$ k get ingress -n fruit
</span></span><span class="line"><span class="ln">2</span><span class="cl">NAME              CLASS    HOSTS               ADDRESS       PORTS   AGE
</span></span><span class="line"><span class="ln">3</span><span class="cl">ingress-example   cilium   fruit.my-domain.net   10.150.12.4   <span class="m">80</span>      44h
</span></span><span class="line"><span class="ln">4</span><span class="cl">andreasm@linuxmgmt01:~/prod-cluster-1/cilium$ k get svc -n fruit
</span></span><span class="line"><span class="ln">5</span><span class="cl">NAME                             TYPE           CLUSTER-IP      EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>                      AGE
</span></span><span class="line"><span class="ln">6</span><span class="cl">apple-service                    ClusterIP      10.21.243.103   &lt;none&gt;        5678/TCP                     4d9h
</span></span><span class="line"><span class="ln">7</span><span class="cl">banana-service                   ClusterIP      10.21.124.111   &lt;none&gt;        5678/TCP                     4d9h
</span></span><span class="line"><span class="ln">8</span><span class="cl">cilium-ingress-ingress-example   LoadBalancer   10.21.50.107    10.150.12.4   80:30792/TCP,443:31553/TCP   43h
</span></span></code></pre></div><p>Let me see if the Ingress responds to my http requests (I have registered the IP above with a DNS record so I can resolve it):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@linuxmgmt01:~$ curl http://fruit.my-domain.net/apple
</span></span><span class="line"><span class="ln">2</span><span class="cl">apple
</span></span><span class="line"><span class="ln">3</span><span class="cl">andreasm@linuxmgmt01:~$ curl http://fruit.my-domain.net/banana
</span></span><span class="line"><span class="ln">4</span><span class="cl">banana
</span></span></code></pre></div><p>The Ingress works.
Again for more information on Cilium IngressController (like supported annotations etc) head over <a href="https://docs.cilium.io/en/stable/network/servicemesh/ingress/#gs-ingress">here</a></p>
<h2 id="cilium-gateway-api">Cilium Gateway API</h2>
<p>Another ingress solution to use is Gateway API, read more about that <a href="https://gateway-api.sigs.k8s.io/">here</a></p>
<p>Gateway API is an &quot;evolution&quot; of the regular Ingress, so it would be natural to take this into consideration going forward. Again Cilium supports Gateway API out of the box, I will use Helm to enable it and it just needs a couple of CRDs to be installed.
Read more on Cilium API support <a href="https://docs.cilium.io/en/stable/network/servicemesh/gateway-api/gateway-api/">here</a>.</p>
<p>To enable Cilium Gateway API I did the following:</p>
<ul>
<li>Edit my Helm value.yaml with the following setting:</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln">1</span><span class="cl"><span class="nt">gatewayAPI</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w">  </span><span class="c"># -- Enable support for Gateway API in cilium</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w">  </span><span class="c"># This will automatically set enable-envoy-config as well.</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span></code></pre></div><ul>
<li>Installed these CRDs before I ran the Helm upgrade command</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">$ kubectl apply -f https://raw.githubusercontent.com/kubernetes-sigs/gateway-api/v0.7.0/config/crd/standard/gateway.networking.k8s.io_gatewayclasses.yaml
</span></span><span class="line"><span class="ln">2</span><span class="cl">$ kubectl apply -f https://raw.githubusercontent.com/kubernetes-sigs/gateway-api/v0.7.0/config/crd/standard/gateway.networking.k8s.io_gateways.yaml
</span></span><span class="line"><span class="ln">3</span><span class="cl">$ kubectl apply -f https://raw.githubusercontent.com/kubernetes-sigs/gateway-api/v0.7.0/config/crd/standard/gateway.networking.k8s.io_httproutes.yaml
</span></span><span class="line"><span class="ln">4</span><span class="cl">$ kubectl apply -f https://raw.githubusercontent.com/kubernetes-sigs/gateway-api/v0.7.0/config/crd/standard/gateway.networking.k8s.io_referencegrants.yaml
</span></span><span class="line"><span class="ln">5</span><span class="cl">$ kubectl apply -f https://raw.githubusercontent.com/kubernetes-sigs/gateway-api/v0.7.0/config/crd/experimental/gateway.networking.k8s.io_tlsroutes.yaml
</span></span></code></pre></div><ul>
<li>Run the helm upgrade command:</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">andreasm@linuxmgmt01:~/test-cluster-1$ helm upgrade -n kube-system cilium cilium/cilium --version 1.14.5 -f cilium-values-feature-by-feature.yaml
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">Release <span class="s2">&#34;cilium&#34;</span> has been upgraded. Happy Helming!
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">NAME: cilium
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">LAST DEPLOYED: Wed Dec <span class="m">20</span> 11:12:55 <span class="m">2023</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">NAMESPACE: kube-system
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">STATUS: deployed
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">REVISION: <span class="m">16</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">TEST SUITE: None
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">NOTES:
</span></span><span class="line"><span class="ln">10</span><span class="cl">You have successfully installed Cilium with Hubble Relay and Hubble UI.
</span></span><span class="line"><span class="ln">11</span><span class="cl">
</span></span><span class="line"><span class="ln">12</span><span class="cl">Your release version is 1.14.5.
</span></span><span class="line"><span class="ln">13</span><span class="cl">
</span></span><span class="line"><span class="ln">14</span><span class="cl">For any further help, visit https://docs.cilium.io/en/v1.14/gettinghelp
</span></span><span class="line"><span class="ln">15</span><span class="cl">
</span></span><span class="line"><span class="ln">16</span><span class="cl">andreasm@linuxmgmt01:~/test-cluster-1$ kubectl -n kube-system rollout restart deployment/cilium-operator
</span></span><span class="line"><span class="ln">17</span><span class="cl">deployment.apps/cilium-operator restarted
</span></span><span class="line"><span class="ln">18</span><span class="cl">andreasm@linuxmgmt01:~/test-cluster-1$ kubectl -n kube-system rollout restart ds/cilium
</span></span><span class="line"><span class="ln">19</span><span class="cl">daemonset.apps/cilium restarted
</span></span></code></pre></div>
<div class="notices warning">
    <div class="label">Info</div>
    <p>It is very important to install the above CRDs first before attempting to enable the GatewayAPI in Cilium. Otherwise it will create any gatewayclass, aka no GatewayAPI realized.</p>

  </div>

<p>Now I should have a gatewayClass:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@linuxmgmt01:~/test-cluster-1$ k get gatewayclasses.gateway.networking.k8s.io
</span></span><span class="line"><span class="ln">2</span><span class="cl">NAME     CONTROLLER                     ACCEPTED   AGE
</span></span><span class="line"><span class="ln">3</span><span class="cl">cilium   io.cilium/gateway-controller   True       96s
</span></span></code></pre></div><p>Now I can just go ahead and create a gateway and some httproutes. When it comes to providing an external IP address for my gateway, this is provided by my ip-pools the same way as for the IngressController.</p>
<p>Lets go ahead and create a gateway, and for this excercise  I will be creating a gateway with corresponding httproutes to support my Harbor registry installation.</p>
<p>Below is the config I have used, this has also been configured to do a https redirect (from http to https):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln">  1</span><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">gateway.networking.k8s.io/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="ln">  2</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Gateway</span><span class="w">
</span></span></span><span class="line"><span class="ln">  3</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">  4</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">harbor-tls-gateway</span><span class="w">
</span></span></span><span class="line"><span class="ln">  5</span><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">harbor</span><span class="w">
</span></span></span><span class="line"><span class="ln">  6</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">  7</span><span class="cl"><span class="w">  </span><span class="nt">gatewayClassName</span><span class="p">:</span><span class="w"> </span><span class="l">cilium</span><span class="w">
</span></span></span><span class="line"><span class="ln">  8</span><span class="cl"><span class="w">  </span><span class="nt">listeners</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">  9</span><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">http</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 10</span><span class="cl"><span class="w">    </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">HTTP</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 11</span><span class="cl"><span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 12</span><span class="cl"><span class="w">    </span><span class="nt">hostname</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;registry.my-domain.net&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 13</span><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">https</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 14</span><span class="cl"><span class="w"></span><span class="c">#    allowedRoutes:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 15</span><span class="cl"><span class="w"></span><span class="c">#      namespaces:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 16</span><span class="cl"><span class="w"></span><span class="c">#        from: Same</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 17</span><span class="cl"><span class="w">    </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">HTTPS</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 18</span><span class="cl"><span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">443</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 19</span><span class="cl"><span class="w">    </span><span class="nt">hostname</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;registry.my-domain.net&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 20</span><span class="cl"><span class="w"></span><span class="c">#    allowedRoutes:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 21</span><span class="cl"><span class="w"></span><span class="c">#      namespaces:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 22</span><span class="cl"><span class="w"></span><span class="c">#        from: Same</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 23</span><span class="cl"><span class="w">    </span><span class="nt">tls</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 24</span><span class="cl"><span class="w">      </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l">Terminate</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 25</span><span class="cl"><span class="w">      </span><span class="nt">certificateRefs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 26</span><span class="cl"><span class="w">      </span>- <span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Secret</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 27</span><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">harbor-tls-prod</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 28</span><span class="cl"><span class="w">        </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">harbor</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 29</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 30</span><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 31</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">gateway.networking.k8s.io/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 32</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">HTTPRoute</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 33</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 34</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">harbor-tls-redirect</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 35</span><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">harbor</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 36</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 37</span><span class="cl"><span class="w">  </span><span class="nt">parentRefs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 38</span><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">harbor-tls-gateway</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 39</span><span class="cl"><span class="w">    </span><span class="nt">sectionName</span><span class="p">:</span><span class="w"> </span><span class="l">http</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 40</span><span class="cl"><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">harbor</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 41</span><span class="cl"><span class="w">  </span><span class="nt">hostnames</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 42</span><span class="cl"><span class="w">  </span>- <span class="l">registry.my-domain.net</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 43</span><span class="cl"><span class="w">  </span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 44</span><span class="cl"><span class="w">  </span>- <span class="nt">filters</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 45</span><span class="cl"><span class="w">    </span>- <span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">RequestRedirect</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 46</span><span class="cl"><span class="w">      </span><span class="nt">requestRedirect</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 47</span><span class="cl"><span class="w">        </span><span class="nt">scheme</span><span class="p">:</span><span class="w"> </span><span class="l">https</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 48</span><span class="cl"><span class="w">        </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">443</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 49</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 50</span><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 51</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">gateway.networking.k8s.io/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 52</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">HTTPRoute</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 53</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 54</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">harbor-api-route</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 55</span><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">harbor</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 56</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 57</span><span class="cl"><span class="w">  </span><span class="nt">parentRefs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 58</span><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">harbor-tls-gateway</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 59</span><span class="cl"><span class="w">    </span><span class="nt">sectionName</span><span class="p">:</span><span class="w"> </span><span class="l">https</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 60</span><span class="cl"><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">harbor</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 61</span><span class="cl"><span class="w">  </span><span class="nt">hostnames</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 62</span><span class="cl"><span class="w">  </span>- <span class="l">registry.my-domain.net</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 63</span><span class="cl"><span class="w">  </span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 64</span><span class="cl"><span class="w">  </span>- <span class="nt">matches</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 65</span><span class="cl"><span class="w">    </span>- <span class="nt">path</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 66</span><span class="cl"><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">PathPrefix</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 67</span><span class="cl"><span class="w">        </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l">/api/</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 68</span><span class="cl"><span class="w">    </span><span class="nt">backendRefs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 69</span><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">harbor</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 70</span><span class="cl"><span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 71</span><span class="cl"><span class="w">  </span>- <span class="nt">matches</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 72</span><span class="cl"><span class="w">    </span>- <span class="nt">path</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 73</span><span class="cl"><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">PathPrefix</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 74</span><span class="cl"><span class="w">        </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l">/service/</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 75</span><span class="cl"><span class="w">    </span><span class="nt">backendRefs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 76</span><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">harbor</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 77</span><span class="cl"><span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 78</span><span class="cl"><span class="w">  </span>- <span class="nt">matches</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 79</span><span class="cl"><span class="w">    </span>- <span class="nt">path</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 80</span><span class="cl"><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">PathPrefix</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 81</span><span class="cl"><span class="w">        </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l">/v2/</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 82</span><span class="cl"><span class="w">    </span><span class="nt">backendRefs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 83</span><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">harbor</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 84</span><span class="cl"><span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 85</span><span class="cl"><span class="w">  </span>- <span class="nt">matches</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 86</span><span class="cl"><span class="w">    </span>- <span class="nt">path</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 87</span><span class="cl"><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">PathPrefix</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 88</span><span class="cl"><span class="w">        </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l">/chartrepo/</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 89</span><span class="cl"><span class="w">    </span><span class="nt">backendRefs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 90</span><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">harbor</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 91</span><span class="cl"><span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 92</span><span class="cl"><span class="w">  </span>- <span class="nt">matches</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 93</span><span class="cl"><span class="w">    </span>- <span class="nt">path</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 94</span><span class="cl"><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">PathPrefix</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 95</span><span class="cl"><span class="w">        </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l">/c/</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 96</span><span class="cl"><span class="w">    </span><span class="nt">backendRefs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 97</span><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">harbor</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 98</span><span class="cl"><span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 99</span><span class="cl"><span class="w">  </span>- <span class="nt">matches</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">100</span><span class="cl"><span class="w">    </span>- <span class="nt">path</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">101</span><span class="cl"><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">PathPrefix</span><span class="w">
</span></span></span><span class="line"><span class="ln">102</span><span class="cl"><span class="w">        </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l">/</span><span class="w">
</span></span></span><span class="line"><span class="ln">103</span><span class="cl"><span class="w">    </span><span class="nt">backendRefs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">104</span><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">harbor-portal</span><span class="w">
</span></span></span><span class="line"><span class="ln">105</span><span class="cl"><span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span></code></pre></div><p>I have already created the certificate as the secret I refer to in the yaml above.</p>
<p>Lets have a look at the gateway, httproutes and the svc that provides the external IP address , also the Harbor services the httproutes refer to:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1">#### gateway created #####</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">andreasm@linuxmgmt01:~/prod-cluster-1/harbor$ k get gateway -n harbor
</span></span><span class="line"><span class="ln">3</span><span class="cl">NAME                 CLASS    ADDRESS        PROGRAMMED   AGE
</span></span><span class="line"><span class="ln">4</span><span class="cl">harbor-tls-gateway   cilium   10.150.14.32   True         28h
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1">#### HTTPROUTES ####</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">andreasm@linuxmgmt01:~/prod-cluster-1/harbor$ k get httproutes.gateway.networking.k8s.io -n harbor
</span></span><span class="line"><span class="ln">3</span><span class="cl">NAME                  HOSTNAMES                  AGE
</span></span><span class="line"><span class="ln">4</span><span class="cl">harbor-api-route      <span class="o">[</span><span class="s2">&#34;registry.my-domain.net&#34;</span><span class="o">]</span>   28h
</span></span><span class="line"><span class="ln">5</span><span class="cl">harbor-tls-redirect   <span class="o">[</span><span class="s2">&#34;registry.my-domain.net&#34;</span><span class="o">]</span>   28h
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@linuxmgmt01:~/prod-cluster-1/harbor$ k get svc -n harbor
</span></span><span class="line"><span class="ln">2</span><span class="cl">NAME                                TYPE           CLUSTER-IP      EXTERNAL-IP    PORT<span class="o">(</span>S<span class="o">)</span>                      AGE
</span></span><span class="line"><span class="ln">3</span><span class="cl">cilium-gateway-harbor-tls-gateway   LoadBalancer   10.21.27.25     10.150.14.32   80:32393/TCP,443:31932/TCP   28h
</span></span></code></pre></div><p>Then the services that Harbor installs:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">andreasm@linuxmgmt01:~/prod-cluster-1/harbor$ k get svc -n harbor
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">NAME                                TYPE           CLUSTER-IP      EXTERNAL-IP    PORT<span class="o">(</span>S<span class="o">)</span>                      AGE
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">harbor                              ClusterIP      10.21.101.75    &lt;none&gt;         80/TCP                       40h
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">harbor-core                         ClusterIP      10.21.1.68      &lt;none&gt;         80/TCP                       40h
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">harbor-database                     ClusterIP      10.21.193.216   &lt;none&gt;         5432/TCP                     40h
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">harbor-jobservice                   ClusterIP      10.21.120.54    &lt;none&gt;         80/TCP                       40h
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">harbor-portal                       ClusterIP      10.21.64.138    &lt;none&gt;         80/TCP                       40h
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">harbor-redis                        ClusterIP      10.21.213.160   &lt;none&gt;         6379/TCP                     40h
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">harbor-registry                     ClusterIP      10.21.212.118   &lt;none&gt;         5000/TCP,8080/TCP            40h
</span></span><span class="line"><span class="ln">10</span><span class="cl">harbor-trivy                        ClusterIP      10.21.138.224   &lt;none&gt;         8080/TCP                     40h
</span></span></code></pre></div><p>Now I can reach my Harbor using the UI and docker cli all through the Gateway API...</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="harbor"
      
        class="image_figure image_internal image_processed"
        width="3574"
        height="1676"
        src="/2023/12/18/a-quick-glance-at-cilium-cni/images/image-20231220144715121.png"
      
      
    />

    </picture>
</figure>
</p>
<p>I will use Harbor in the next chapter with Hubble UI..</p>
<h2 id="hubble-ui">Hubble UI</h2>
<p>As you may recall, I did enable the two features Hubble Relay and Hubble UI as we can se below:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@linuxmgmt01:~$ k get svc -n kube-system
</span></span><span class="line"><span class="ln">2</span><span class="cl">NAME             TYPE           CLUSTER-IP      EXTERNAL-IP     PORT<span class="o">(</span>S<span class="o">)</span>                      AGE
</span></span><span class="line"><span class="ln">3</span><span class="cl">hubble-metrics   ClusterIP      None            &lt;none&gt;          9965/TCP                     35h
</span></span><span class="line"><span class="ln">4</span><span class="cl">hubble-peer      ClusterIP      10.23.182.223   &lt;none&gt;          443/TCP                      42h
</span></span><span class="line"><span class="ln">5</span><span class="cl">hubble-relay     ClusterIP      10.23.182.76    &lt;none&gt;          80/TCP                       40h
</span></span><span class="line"><span class="ln">6</span><span class="cl">hubble-ui        ClusterIP      10.23.31.4      &lt;none&gt;          80/TCP                       36h
</span></span></code></pre></div><p>It is not exposed so I can reach from outside the Kubernetes cluster. So let me first start by just creating a serviceType loadBalancer service to expose the Hubble UI clusterIP service. Below is the yaml I use for that:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">hubble-ui-lb</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-system</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">    </span><span class="nt">env</span><span class="p">:</span><span class="w"> </span><span class="l">prod</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    </span><span class="nt">&#34;io.cilium/lb-ipam-ips&#34;: </span><span class="s2">&#34;10.150.11.10&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">LoadBalancer</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">  </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8081</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">    </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">8081</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">    </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">http</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">    </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l">hubble-ui</span><span class="w">
</span></span></span></code></pre></div><p>Apply it and I should see the service:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@linuxmgmt01:~/prod-cluster-1/cilium/services$ k get svc -n kube-system
</span></span><span class="line"><span class="ln">2</span><span class="cl">NAME                    TYPE           CLUSTER-IP      EXTERNAL-IP     PORT<span class="o">(</span>S<span class="o">)</span>                      AGE
</span></span><span class="line"><span class="ln">3</span><span class="cl">hubble-ui-lb            LoadBalancer   10.21.47.47     10.150.11.10    8081:32328/TCP               3d11h
</span></span></code></pre></div><p>There it is, now open my browser and point to this ip:port</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="hubble-ui-frontpage"
      
        class="image_figure image_internal image_processed"
        width="3452"
        height="1474"
        src="/2023/12/18/a-quick-glance-at-cilium-cni/images/image-20231221093222729.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Now let me go to a test application I have deployed in the yelb namespace. Click on it from the list or the dropdown top left corner:</p>
<img src=images/image-20231221093346599.png style="width:400px" />
<p>Soo much empty...</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="yelb-ns"
      
        class="image_figure image_internal image_processed"
        width="3564"
        height="2034"
        src="/2023/12/18/a-quick-glance-at-cilium-cni/images/image-20231221093448609.png"
      
      
    />

    </picture>
</figure>
</p>
<p>I can see the pods are running:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@linuxmgmt01:~/prod-cluster-1/cilium/services$ k get pods -n yelb
</span></span><span class="line"><span class="ln">2</span><span class="cl">NAME                            READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="ln">3</span><span class="cl">redis-server-84f4bf49b5-fq26l   1/1     Running   <span class="m">0</span>          5d18h
</span></span><span class="line"><span class="ln">4</span><span class="cl">yelb-appserver-6dc7cd98-s6kt7   1/1     Running   <span class="m">0</span>          5d18h
</span></span><span class="line"><span class="ln">5</span><span class="cl">yelb-db-84d6f6fc6c-m7xvd        1/1     Running   <span class="m">0</span>          5d18h
</span></span></code></pre></div><p>They are probably not so interested in talking to each other unless they have to. Let me deploy the Fronted service and create some interactions.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@linuxmgmt01:~/prod-cluster-1/cilium$ k apply -f yelb-lb-frontend.yaml
</span></span><span class="line"><span class="ln">2</span><span class="cl">service/yelb-ui created
</span></span><span class="line"><span class="ln">3</span><span class="cl">deployment.apps/yelb-ui created
</span></span><span class="line"><span class="ln">4</span><span class="cl">andreasm@linuxmgmt01:~/prod-cluster-1/cilium$ k get svc -n yelb
</span></span><span class="line"><span class="ln">5</span><span class="cl">NAME             TYPE           CLUSTER-IP      EXTERNAL-IP     PORT<span class="o">(</span>S<span class="o">)</span>        AGE
</span></span><span class="line"><span class="ln">6</span><span class="cl">redis-server     ClusterIP      10.21.67.23     &lt;none&gt;          6379/TCP       5d18h
</span></span><span class="line"><span class="ln">7</span><span class="cl">yelb-appserver   ClusterIP      10.21.81.95     &lt;none&gt;          4567/TCP       5d18h
</span></span><span class="line"><span class="ln">8</span><span class="cl">yelb-db          ClusterIP      10.21.188.43    &lt;none&gt;          5432/TCP       5d18h
</span></span><span class="line"><span class="ln">9</span><span class="cl">yelb-ui          LoadBalancer   10.21.207.114   10.150.11.221   80:32335/TCP   49s
</span></span></code></pre></div><p>I will now open the Yelb UI and do some quick &quot;votes&quot;</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="yelb-ui"
      
        class="image_figure image_internal image_processed"
        width="2424"
        height="1145"
        src="/2023/12/18/a-quick-glance-at-cilium-cni/images/image-20231221093909070.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Instantly, even by just opening the yelb webpage I get a lot of flow information in Hubble. And not only that, it automatically creates a &quot;service-map&quot; so I can see the involved services in the Yelb app.</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="yelb-hubble"
      
        class="image_figure image_internal image_processed"
        width="3578"
        height="2028"
        src="/2023/12/18/a-quick-glance-at-cilium-cni/images/image-20231221093840226.png"
      
      
    />

    </picture>
</figure>
</p>
<p>This will only show me L4 information. What about Layer 7? Lets test that also by heading over to Harbor</p>
<p>In Hubble I will switch to the namespace <em>harbor</em></p>
<p>A nice diagram with all involced services, but no L7 Information yet. Well there is, but I have no recent interactions to Harbor using the Gateway API, as soon as I use docker or web-ui against harbor what happens then?</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="harbor-hubble-1"
      
        class="image_figure image_internal image_processed"
        width="3568"
        height="2002"
        src="/2023/12/18/a-quick-glance-at-cilium-cni/images/image-20231221094209948.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Whats this, an ingress object?</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="harbor-hubble-2"
      
        class="image_figure image_internal image_processed"
        width="3560"
        height="1392"
        src="/2023/12/18/a-quick-glance-at-cilium-cni/images/image-20231221094631886.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Now when I click on the ingress object:</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="harbor-ingress-l7"
      
        class="image_figure image_internal image_processed"
        width="3564"
        height="2014"
        src="/2023/12/18/a-quick-glance-at-cilium-cni/images/image-20231221094803374.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Look at the L7 info coming there.</p>
<p>I logged out from Harbor:</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="log-out"
      
        class="image_figure image_internal image_processed"
        width="3558"
        height="374"
        src="/2023/12/18/a-quick-glance-at-cilium-cni/images/image-20231221094905742.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Logged back in:</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="log-in"
      
        class="image_figure image_internal image_processed"
        width="3548"
        height="62"
        src="/2023/12/18/a-quick-glance-at-cilium-cni/images/image-20231221095015193.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Browsing the Harbor Projects/repositories:</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="browsing"
      
        class="image_figure image_internal image_processed"
        width="3542"
        height="294"
        src="/2023/12/18/a-quick-glance-at-cilium-cni/images/image-20231221095055734.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Very rich set of information presented in a very snappy and responsive dashbord. Its instantly updated as soon as there is a request coming.</p>
<p>For now, this concludes this post.</p>
<p>It has been a nice experience getting a bit more under the hood of Cilium, and so far I must say it looks very good.</p>
<h2 id="things-i-have-not-covered-yet-wich-i-will-at-a-later-stage">Things I have not covered yet wich I will at a later stage</h2>
<p>I will update this post with some other features at a later stage. Some of the features I am interested looking at is:</p>
<ul>
<li>Security policies with Cilium - just have quick look <a href="https://docs.cilium.io/en/stable/security/">here</a> many interesting <a href="https://docs.cilium.io/en/stable/security/">topics</a>, Host Firewall?</li>
<li>Egress</li>
<li>Cilium Multi-Cluster</li>
</ul>

    </div>




  </article>
<aside class="sidebar">
  <section class="sidebar_inner">
    <br>
    
  
  <div class="search">
    <input type="search" class="search_field form_field" placeholder='Search...' id="find" autocomplete="off" data-scope='post'>
    <label for="find" class="search_label"><svg class="icon">
  <title>search</title>
  <use xlink:href="#search"></use>
</svg>

    </label>
    
    <div class="search_results results"></div>
  </div>

        <h2>Hi there</h2>
      <div class="author_bio">
        This is Andreas Marqvardsen's blog, a Lead Solution Engineer at VMware by Broadcom. This blog focuses on Kubernetes, Kubernetes infrastructure such as networking and security and stuff he finds interesting.
      </div>
      <a href='https://blog.andreasm.io/about/' class="button mt-1" role="button" title='Read More'>Read More</a>

    
    
    <h2 class="mt-4">Recent Posts</h2>
    <ul class="flex-column">
      <li>
        <a href="https://blog.andreasm.io/2024/06/10/arista-automated-configuration-using-ansible/" class="nav-link" title="Arista Automated Configuration using Ansible">Arista Automated Configuration using Ansible</a>
      </li>
      <li>
        <a href="https://blog.andreasm.io/2024/05/13/neuvector-by-suse-security-where-it-is-needed-part-1/" class="nav-link" title="NeuVector by SUSE - security where it is needed - part 1">NeuVector by SUSE - security where it is needed - part 1</a>
      </li>
      <li>
        <a href="https://blog.andreasm.io/2024/05/05/taking-rancher-by-suse-for-a-spin/" class="nav-link" title="Taking Rancher by SUSE for a Spin">Taking Rancher by SUSE for a Spin</a>
      </li>
      <li>
        <a href="https://blog.andreasm.io/2024/04/16/exploring-some-antrea-features/" class="nav-link" title="Exploring some Antrea Features">Exploring some Antrea Features</a>
      </li>
      <li>
        <a href="https://blog.andreasm.io/2024/04/08/vsphere-with-tanzu-avi-and-multiple-supervisors/" class="nav-link" title="vSphere with Tanzu - Avi and Multiple Supervisors">vSphere with Tanzu - Avi and Multiple Supervisors</a>
      </li>
      <li>
        <a href="https://blog.andreasm.io/2024/02/04/argo-cd-vsphere-with-tanzu/" class="nav-link" title="Argo CD &amp; vSphere with Tanzu">Argo CD &amp; vSphere with Tanzu</a>
      </li>
      <li>
        <a href="https://blog.andreasm.io/2024/01/15/proxmox-with-opentofu-kubespray-and-kubernetes/" class="nav-link" title="Proxmox with OpenTofu Kubespray and Kubernetes">Proxmox with OpenTofu Kubespray and Kubernetes</a>
      </li>
      <li>
        <a href="https://blog.andreasm.io/2023/12/26/traefik-proxy-in-kubernetes/" class="nav-link" title="Traefik Proxy in Kubernetes">Traefik Proxy in Kubernetes</a>
      </li>
    </ul>
    <div>
      <h2 class="mt-4 taxonomy" id="categories-section">Categories</h2>
      <nav class="tags_nav">
        <a href='https://blog.andreasm.io/categories/kubernetes/' class="post_tag button button_translucent" title="kubernetes">
          KUBERNETES
          <span class="button_tally">42</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/networking/' class="post_tag button button_translucent" title="networking">
          NETWORKING
          <span class="button_tally">21</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/tanzu/' class="post_tag button button_translucent" title="tanzu">
          TANZU
          <span class="button_tally">13</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/cni/' class="post_tag button button_translucent" title="cni">
          CNI
          <span class="button_tally">9</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/loadbalancing/' class="post_tag button button_translucent" title="loadbalancing">
          LOADBALANCING
          <span class="button_tally">9</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/security/' class="post_tag button button_translucent" title="security">
          SECURITY
          <span class="button_tally">7</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/avi/' class="post_tag button button_translucent" title="avi">
          AVI
          <span class="button_tally">6</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/nsx/' class="post_tag button button_translucent" title="nsx">
          NSX
          <span class="button_tally">5</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/antrea/' class="post_tag button button_translucent" title="antrea">
          ANTREA
          <span class="button_tally">4</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/automation/' class="post_tag button button_translucent" title="automation">
          AUTOMATION
          <span class="button_tally">3</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/blog/' class="post_tag button button_translucent" title="blog">
          BLOG
          <span class="button_tally">2</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/network/' class="post_tag button button_translucent" title="network">
          NETWORK
          <span class="button_tally">2</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/vmware-nsx/' class="post_tag button button_translucent" title="vmware nsx">
          VMWARE NSX
          <span class="button_tally">2</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/argocd/' class="post_tag button button_translucent" title="argocd">
          ARGOCD
          <span class="button_tally">1</span>
        </a>
        
        
        <br>
        <div class="post_tags_toggle button">All Categories</div>
        <div class="post_tags">
          <div class="tags_list">
            
            <a href='https://blog.andreasm.io/categories/antrea/' class=" post_tag button button_translucent" data-position=4 title="antrea">ANTREA<span class="button_tally">4</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/argocd/' class=" post_tag button button_translucent" data-position=1 title="argocd">ARGOCD<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/automation/' class=" post_tag button button_translucent" data-position=3 title="automation">AUTOMATION<span class="button_tally">3</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/autoscaling/' class=" post_tag button button_translucent" data-position=1 title="autoscaling">AUTOSCALING<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/avi/' class=" post_tag button button_translucent" data-position=6 title="avi">AVI<span class="button_tally">6</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/blog/' class=" post_tag button button_translucent" data-position=2 title="blog">BLOG<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/certificate/' class=" post_tag button button_translucent" data-position=1 title="certificate">CERTIFICATE<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/cni/' class=" post_tag button button_translucent" data-position=9 title="cni">CNI<span class="button_tally">9</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/compliance/' class=" post_tag button button_translucent" data-position=1 title="compliance">COMPLIANCE<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/docker/' class=" post_tag button button_translucent" data-position=1 title="docker">DOCKER<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/ebpf/' class=" post_tag button button_translucent" data-position=1 title="ebpf">EBPF<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/github/' class=" post_tag button button_translucent" data-position=1 title="github">GITHUB<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/gitops/' class=" post_tag button button_translucent" data-position=1 title="gitops">GITOPS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/harbor/' class=" post_tag button button_translucent" data-position=1 title="harbor">HARBOR<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/helm/' class=" post_tag button button_translucent" data-position=1 title="helm">HELM<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/home-automation/' class=" post_tag button button_translucent" data-position=1 title="home-automation">HOME-AUTOMATION<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/hugo/' class=" post_tag button button_translucent" data-position=1 title="hugo">HUGO<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/ingress/' class=" post_tag button button_translucent" data-position=1 title="ingress">INGRESS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/kubernetes/' class=" post_tag button button_translucent" data-position=42 title="kubernetes">KUBERNETES<span class="button_tally">42</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/kubernetes-management/' class=" post_tag button button_translucent" data-position=1 title="kubernetes-management">KUBERNETES-MANAGEMENT<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/lcm/' class=" post_tag button button_translucent" data-position=1 title="lcm">LCM<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/lifecycle-management/' class=" post_tag button button_translucent" data-position=1 title="lifecycle-management">LIFECYCLE-MANAGEMENT<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/loadbalancing/' class=" post_tag button button_translucent" data-position=9 title="loadbalancing">LOADBALANCING<span class="button_tally">9</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/management/' class=" post_tag button button_translucent" data-position=1 title="management">MANAGEMENT<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/monitoring/' class=" post_tag button button_translucent" data-position=1 title="monitoring">MONITORING<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/netowkring/' class=" post_tag button button_translucent" data-position=1 title="netowkring">NETOWKRING<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/network/' class=" post_tag button button_translucent" data-position=2 title="network">NETWORK<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/networking/' class=" post_tag button button_translucent" data-position=21 title="networking">NETWORKING<span class="button_tally">21</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/neuvector/' class=" post_tag button button_translucent" data-position=1 title="neuvector">NEUVECTOR<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/nsx/' class=" post_tag button button_translucent" data-position=5 title="nsx">NSX<span class="button_tally">5</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/nsx-alb/' class=" post_tag button button_translucent" data-position=1 title="nsx-alb">NSX-ALB<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/nsx-t/' class=" post_tag button button_translucent" data-position=1 title="nsx-t">NSX-T<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/pinniped/' class=" post_tag button button_translucent" data-position=1 title="pinniped">PINNIPED<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/provisioning/' class=" post_tag button button_translucent" data-position=1 title="provisioning">PROVISIONING<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/rancher/' class=" post_tag button button_translucent" data-position=1 title="rancher">RANCHER<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/rbac/' class=" post_tag button button_translucent" data-position=1 title="rbac">RBAC<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/rke2/' class=" post_tag button button_translucent" data-position=1 title="rke2">RKE2<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/security/' class=" post_tag button button_translucent" data-position=7 title="security">SECURITY<span class="button_tally">7</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/storage/' class=" post_tag button button_translucent" data-position=1 title="storage">STORAGE<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/suse/' class=" post_tag button button_translucent" data-position=1 title="suse">SUSE<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/tanzu/' class=" post_tag button button_translucent" data-position=13 title="tanzu">TANZU<span class="button_tally">13</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/tanzu-mission-control/' class=" post_tag button button_translucent" data-position=1 title="tanzu mission control">TANZU MISSION CONTROL<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/tkg/' class=" post_tag button button_translucent" data-position=1 title="tkg">TKG<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/tkgi/' class=" post_tag button button_translucent" data-position=1 title="tkgi">TKGI<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/tmc/' class=" post_tag button button_translucent" data-position=1 title="tmc">TMC<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/troubleshooting/' class=" post_tag button button_translucent" data-position=1 title="troubleshooting">TROUBLESHOOTING<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/virtualization/' class=" post_tag button button_translucent" data-position=1 title="virtualization">VIRTUALIZATION<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/vmare-nsx-intelligence/' class=" post_tag button button_translucent" data-position=1 title="vmare nsx intelligence">VMARE NSX INTELLIGENCE<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/vmware-nsx/' class=" post_tag button button_translucent" data-position=2 title="vmware nsx">VMWARE NSX<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/vmware-cloud/' class=" post_tag button button_translucent" data-position=1 title="vmware-cloud">VMWARE-CLOUD<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/vsphere/' class=" post_tag button button_translucent" data-position=1 title="vsphere">VSPHERE<span class="button_tally">1</span>
            </a>
            
            <div class="tags_sort"><span title="sort alphabetically">[A~Z]</span><span title="sort by count">[0~9]</span>
            </div>
            <span class="tags_hide"><svg class="icon">
            <use xlink:href="#closeme"></use>
          </svg></span>
          </div>
        </div>
      </nav>
    </div>
    <div>
      <h2 class="mt-4 taxonomy" id="tags-section">Tags</h2>
      <nav class="tags_nav">
        <a href='https://blog.andreasm.io/tags/kubernetes/' class="post_tag button button_translucent" title="kubernetes">
          KUBERNETES
          <span class="button_tally">24</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/tanzu/' class="post_tag button button_translucent" title="tanzu">
          TANZU
          <span class="button_tally">14</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/nsx/' class="post_tag button button_translucent" title="nsx">
          NSX
          <span class="button_tally">13</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/antrea/' class="post_tag button button_translucent" title="antrea">
          ANTREA
          <span class="button_tally">12</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/ako/' class="post_tag button button_translucent" title="ako">
          AKO
          <span class="button_tally">8</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/avi/' class="post_tag button button_translucent" title="avi">
          AVI
          <span class="button_tally">7</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/loadbalancing/' class="post_tag button button_translucent" title="loadbalancing">
          LOADBALANCING
          <span class="button_tally">7</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/security/' class="post_tag button button_translucent" title="security">
          SECURITY
          <span class="button_tally">7</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/ingress/' class="post_tag button button_translucent" title="ingress">
          INGRESS
          <span class="button_tally">5</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/cni/' class="post_tag button button_translucent" title="cni">
          CNI
          <span class="button_tally">4</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/networking/' class="post_tag button button_translucent" title="networking">
          NETWORKING
          <span class="button_tally">4</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/availability/' class="post_tag button button_translucent" title="availability">
          AVAILABILITY
          <span class="button_tally">3</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/cert-manager/' class="post_tag button button_translucent" title="cert-manager">
          CERT-MANAGER
          <span class="button_tally">3</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/network/' class="post_tag button button_translucent" title="network">
          NETWORK
          <span class="button_tally">3</span>
        </a>
        
        
        <br>
        <div class="post_tags_toggle button">All Tags</div>
        <div class="post_tags">
          <div class="tags_list">
            
            <a href='https://blog.andreasm.io/tags/ako/' class=" post_tag button button_translucent" data-position=8 title="ako">AKO<span class="button_tally">8</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/amko/' class=" post_tag button button_translucent" data-position=1 title="amko">AMKO<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/ansible/' class=" post_tag button button_translucent" data-position=1 title="ansible">ANSIBLE<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/antrea/' class=" post_tag button button_translucent" data-position=12 title="antrea">ANTREA<span class="button_tally">12</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/argocd/' class=" post_tag button button_translucent" data-position=1 title="argocd">ARGOCD<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/authentication/' class=" post_tag button button_translucent" data-position=2 title="authentication">AUTHENTICATION<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/automation/' class=" post_tag button button_translucent" data-position=2 title="automation">AUTOMATION<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/autoscaling/' class=" post_tag button button_translucent" data-position=1 title="autoscaling">AUTOSCALING<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/availability/' class=" post_tag button button_translucent" data-position=3 title="availability">AVAILABILITY<span class="button_tally">3</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/avi/' class=" post_tag button button_translucent" data-position=7 title="avi">AVI<span class="button_tally">7</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/cert-manager/' class=" post_tag button button_translucent" data-position=3 title="cert-manager">CERT-MANAGER<span class="button_tally">3</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/certificate/' class=" post_tag button button_translucent" data-position=1 title="certificate">CERTIFICATE<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/cilium/' class=" post_tag button button_translucent" data-position=1 title="cilium">CILIUM<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/cni/' class=" post_tag button button_translucent" data-position=4 title="cni">CNI<span class="button_tally">4</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/compliance/' class=" post_tag button button_translucent" data-position=1 title="compliance">COMPLIANCE<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/custom-resource-definitions/' class=" post_tag button button_translucent" data-position=1 title="custom-resource-definitions">CUSTOM-RESOURCE-DEFINITIONS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/distributed-firewall/' class=" post_tag button button_translucent" data-position=1 title="distributed-firewall">DISTRIBUTED-FIREWALL<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/dns-service/' class=" post_tag button button_translucent" data-position=1 title="dns-service">DNS-SERVICE<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/docker/' class=" post_tag button button_translucent" data-position=2 title="docker">DOCKER<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/ebpf/' class=" post_tag button button_translucent" data-position=1 title="ebpf">EBPF<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/github/' class=" post_tag button button_translucent" data-position=1 title="github">GITHUB<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/gitops/' class=" post_tag button button_translucent" data-position=1 title="gitops">GITOPS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/gslb/' class=" post_tag button button_translucent" data-position=1 title="gslb">GSLB<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/harbor/' class=" post_tag button button_translucent" data-position=1 title="harbor">HARBOR<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/home-assistant/' class=" post_tag button button_translucent" data-position=1 title="home-assistant">HOME-ASSISTANT<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/hugo/' class=" post_tag button button_translucent" data-position=2 title="hugo">HUGO<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/ids/' class=" post_tag button button_translucent" data-position=1 title="ids">IDS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/informational/' class=" post_tag button button_translucent" data-position=2 title="informational">INFORMATIONAL<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/ingress/' class=" post_tag button button_translucent" data-position=5 title="ingress">INGRESS<span class="button_tally">5</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/ips/' class=" post_tag button button_translucent" data-position=1 title="ips">IPS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/keycloak/' class=" post_tag button button_translucent" data-position=1 title="keycloak">KEYCLOAK<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/kubernetes/' class=" post_tag button button_translucent" data-position=24 title="kubernetes">KUBERNETES<span class="button_tally">24</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/kubernetes-api-endpoint/' class=" post_tag button button_translucent" data-position=1 title="kubernetes-api-endpoint">KUBERNETES-API-ENDPOINT<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/kubernetes-management/' class=" post_tag button button_translucent" data-position=1 title="kubernetes-management">KUBERNETES-MANAGEMENT<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/kubespray/' class=" post_tag button button_translucent" data-position=1 title="kubespray">KUBESPRAY<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/lifecycle-management/' class=" post_tag button button_translucent" data-position=1 title="lifecycle-management">LIFECYCLE-MANAGEMENT<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/load-balancing/' class=" post_tag button button_translucent" data-position=1 title="load-balancing">LOAD-BALANCING<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/loadbalancer/' class=" post_tag button button_translucent" data-position=1 title="loadbalancer">LOADBALANCER<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/loadbalancing/' class=" post_tag button button_translucent" data-position=7 title="loadbalancing">LOADBALANCING<span class="button_tally">7</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/lodbalancing/' class=" post_tag button button_translucent" data-position=1 title="lodbalancing">LODBALANCING<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/management/' class=" post_tag button button_translucent" data-position=1 title="management">MANAGEMENT<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/multi-cluster/' class=" post_tag button button_translucent" data-position=1 title="multi-cluster">MULTI-CLUSTER<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/multi-dc/' class=" post_tag button button_translucent" data-position=1 title="multi-dc">MULTI-DC<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/multi-tenancy/' class=" post_tag button button_translucent" data-position=1 title="multi-tenancy">MULTI-TENANCY<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/network/' class=" post_tag button button_translucent" data-position=3 title="network">NETWORK<span class="button_tally">3</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/network-policies/' class=" post_tag button button_translucent" data-position=2 title="network-policies">NETWORK-POLICIES<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/networking/' class=" post_tag button button_translucent" data-position=4 title="networking">NETWORKING<span class="button_tally">4</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/neuvector/' class=" post_tag button button_translucent" data-position=1 title="neuvector">NEUVECTOR<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/nfs/' class=" post_tag button button_translucent" data-position=1 title="nfs">NFS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/nsx/' class=" post_tag button button_translucent" data-position=13 title="nsx">NSX<span class="button_tally">13</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/nsx-advanced-loadbalancer/' class=" post_tag button button_translucent" data-position=1 title="nsx advanced loadbalancer">NSX ADVANCED LOADBALANCER<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/nsx-alb/' class=" post_tag button button_translucent" data-position=1 title="nsx-alb">NSX-ALB<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/nsx-application-platform/' class=" post_tag button button_translucent" data-position=1 title="nsx-application-platform">NSX-APPLICATION-PLATFORM<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/nsx-t/' class=" post_tag button button_translucent" data-position=2 title="nsx-t">NSX-T<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/opentofu/' class=" post_tag button button_translucent" data-position=1 title="opentofu">OPENTOFU<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/persistent-storage/' class=" post_tag button button_translucent" data-position=1 title="persistent-storage">PERSISTENT-STORAGE<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/pinniped/' class=" post_tag button button_translucent" data-position=1 title="pinniped">PINNIPED<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/provisioning/' class=" post_tag button button_translucent" data-position=1 title="provisioning">PROVISIONING<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/proxmox/' class=" post_tag button button_translucent" data-position=1 title="proxmox">PROXMOX<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/proxy/' class=" post_tag button button_translucent" data-position=1 title="proxy">PROXY<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/pvc/' class=" post_tag button button_translucent" data-position=1 title="pvc">PVC<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/rancher/' class=" post_tag button button_translucent" data-position=1 title="rancher">RANCHER<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/rbac/' class=" post_tag button button_translucent" data-position=1 title="rbac">RBAC<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/registry/' class=" post_tag button button_translucent" data-position=1 title="registry">REGISTRY<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/rke2/' class=" post_tag button button_translucent" data-position=1 title="rke2">RKE2<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/security/' class=" post_tag button button_translucent" data-position=7 title="security">SECURITY<span class="button_tally">7</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/static-content-generator/' class=" post_tag button button_translucent" data-position=1 title="static-content-generator">STATIC-CONTENT-GENERATOR<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/static-site-generator/' class=" post_tag button button_translucent" data-position=1 title="static-site-generator">STATIC-SITE-GENERATOR<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/suse/' class=" post_tag button button_translucent" data-position=2 title="suse">SUSE<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/tanzu/' class=" post_tag button button_translucent" data-position=14 title="tanzu">TANZU<span class="button_tally">14</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/tanzu-kubernetes-grid/' class=" post_tag button button_translucent" data-position=1 title="tanzu-kubernetes-grid">TANZU-KUBERNETES-GRID<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/terraform/' class=" post_tag button button_translucent" data-position=1 title="terraform">TERRAFORM<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/tkg/' class=" post_tag button button_translucent" data-position=1 title="tkg">TKG<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/tkg-2.1/' class=" post_tag button button_translucent" data-position=1 title="tkg 2.1">TKG 2.1<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/tkgi/' class=" post_tag button button_translucent" data-position=1 title="tkgi">TKGI<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/tkgs/' class=" post_tag button button_translucent" data-position=1 title="tkgs">TKGS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/tmc/' class=" post_tag button button_translucent" data-position=1 title="tmc">TMC<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/tmc-local/' class=" post_tag button button_translucent" data-position=1 title="tmc-local">TMC-LOCAL<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/tmc-sm/' class=" post_tag button button_translucent" data-position=1 title="tmc-sm">TMC-SM<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/traefik/' class=" post_tag button button_translucent" data-position=1 title="traefik">TRAEFIK<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/troubleshooting/' class=" post_tag button button_translucent" data-position=2 title="troubleshooting">TROUBLESHOOTING<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/unifi/' class=" post_tag button button_translucent" data-position=1 title="unifi">UNIFI<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/vmconaws/' class=" post_tag button button_translucent" data-position=1 title="vmconaws">VMCONAWS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/vsphere/' class=" post_tag button button_translucent" data-position=2 title="vsphere">VSPHERE<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/vsphere-replication/' class=" post_tag button button_translucent" data-position=1 title="vsphere-replication">VSPHERE-REPLICATION<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/vsphere-with-tanzu/' class=" post_tag button button_translucent" data-position=1 title="vsphere-with-tanzu">VSPHERE-WITH-TANZU<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/zwave/' class=" post_tag button button_translucent" data-position=1 title="zwave">ZWAVE<span class="button_tally">1</span>
            </a>
            
            <div class="tags_sort"><span title="sort alphabetically">[A~Z]</span><span title="sort by count">[0~9]</span>
            </div>
            <span class="tags_hide"><svg class="icon">
            <use xlink:href="#closeme"></use>
          </svg></span>
          </div>
        </div>
      </nav>
    </div>
  </section>
</aside>

  
</div>
    </main><svg width="0" height="0" class="hidden">
  <symbol viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" id="facebook">
    <path d="M437 0H75C33.648 0 0 33.648 0 75v362c0 41.352 33.648 75 75 75h151V331h-60v-90h60v-61c0-49.629 40.371-90 90-90h91v90h-91v61h91l-15 90h-76v181h121c41.352 0 75-33.648 75-75V75c0-41.352-33.648-75-75-75zm0 0"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18.001 18.001" id="twitter">
    <path d="M15.891 4.013c.808-.496 1.343-1.173 1.605-2.034a8.68 8.68 0 0 1-2.351.861c-.703-.756-1.593-1.14-2.66-1.14-1.043 0-1.924.366-2.643 1.078a3.56 3.56 0 0 0-1.076 2.605c0 .309.039.585.117.819-3.076-.105-5.622-1.381-7.628-3.837-.34.601-.51 1.213-.51 1.846 0 1.301.549 2.332 1.645 3.089-.625-.053-1.176-.211-1.645-.47 0 .929.273 1.705.82 2.388a3.623 3.623 0 0 0 2.115 1.291c-.312.08-.641.118-.979.118-.312 0-.533-.026-.664-.083.23.757.664 1.371 1.291 1.841a3.652 3.652 0 0 0 2.152.743C4.148 14.173 2.625 14.69.902 14.69c-.422 0-.721-.006-.902-.038 1.697 1.102 3.586 1.649 5.676 1.649 2.139 0 4.029-.542 5.674-1.626 1.645-1.078 2.859-2.408 3.639-3.974a10.77 10.77 0 0 0 1.172-4.892v-.468a7.788 7.788 0 0 0 1.84-1.921 8.142 8.142 0 0 1-2.11.593z"
      ></path>
  </symbol>
  <symbol aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id="mail">
    <path  d="M502.3 190.8c3.9-3.1 9.7-.2 9.7 4.7V400c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V195.6c0-5 5.7-7.8 9.7-4.7 22.4 17.4 52.1 39.5 154.1 113.6 21.1 15.4 56.7 47.8 92.2 47.6 35.7.3 72-32.8 92.3-47.6 102-74.1 131.6-96.3 154-113.7zM256 320c23.2.4 56.6-29.2 73.4-41.4 132.7-96.3 142.8-104.7 173.4-128.7 5.8-4.5 9.2-11.5 9.2-18.9v-19c0-26.5-21.5-48-48-48H48C21.5 64 0 85.5 0 112v19c0 7.4 3.4 14.3 9.2 18.9 30.6 23.9 40.7 32.4 173.4 128.7 16.8 12.2 50.2 41.8 73.4 41.4z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id="calendar">
    <path d="M452 40h-24V0h-40v40H124V0H84v40H60C26.916 40 0 66.916 0 100v352c0 33.084 26.916 60 60 60h392c33.084 0 60-26.916 60-60V100c0-33.084-26.916-60-60-60zm20 412c0 11.028-8.972 20-20 20H60c-11.028 0-20-8.972-20-20V188h432v264zm0-304H40v-48c0-11.028 8.972-20 20-20h24v40h40V80h264v40h40V80h24c11.028 0 20 8.972 20 20v48z"></path>
    <path d="M76 230h40v40H76zm80 0h40v40h-40zm80 0h40v40h-40zm80 0h40v40h-40zm80 0h40v40h-40zM76 310h40v40H76zm80 0h40v40h-40zm80 0h40v40h-40zm80 0h40v40h-40zM76 390h40v40H76zm80 0h40v40h-40zm80 0h40v40h-40zm80 0h40v40h-40zm80-80h40v40h-40z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id="github">
    <path d="M255.968 5.329C114.624 5.329 0 120.401 0 262.353c0 113.536 73.344 209.856 175.104 243.872 12.8 2.368 17.472-5.568 17.472-12.384 0-6.112-.224-22.272-.352-43.712-71.2 15.52-86.24-34.464-86.24-34.464-11.616-29.696-28.416-37.6-28.416-37.6-23.264-15.936 1.728-15.616 1.728-15.616 25.696 1.824 39.2 26.496 39.2 26.496 22.848 39.264 59.936 27.936 74.528 21.344 2.304-16.608 8.928-27.936 16.256-34.368-56.832-6.496-116.608-28.544-116.608-127.008 0-28.064 9.984-51.008 26.368-68.992-2.656-6.496-11.424-32.64 2.496-68 0 0 21.504-6.912 70.4 26.336 20.416-5.696 42.304-8.544 64.096-8.64 21.728.128 43.648 2.944 64.096 8.672 48.864-33.248 70.336-26.336 70.336-26.336 13.952 35.392 5.184 61.504 2.56 68 16.416 17.984 26.304 40.928 26.304 68.992 0 98.72-59.84 120.448-116.864 126.816 9.184 7.936 17.376 23.616 17.376 47.584 0 34.368-.32 62.08-.32 70.496 0 6.88 4.608 14.88 17.6 12.352C438.72 472.145 512 375.857 512 262.353 512 120.401 397.376 5.329 255.968 5.329z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 212 212" id="gitlab">
    <path d="M12.3 74.7h54L43.3 3c-1-3.6-6.4-3.6-7.6 0L12.3 74.8z" />
    <path d="M12.3 74.7L.5 111c-1 3.2 0 6.8 3 8.8l101.6 74-92.5-119z"/>
    <path d="M105 193.7l-38.6-119h-54l92.7 119z"/>
    <path d="M105 193.7l38.7-119H66.4l38.7 119z"/>
    <path d="M105 193.7l38.7-119H198l-93 119z"/>
    <path d="M198 74.7l11.6 36.2c1 3 0 6.6-3 8.6l-101.5 74 93-119z"/>
    <path d="M198 74.7h-54.3L167 3c1.2-3.6 6.4-3.6 7.6 0L198 74.8z"/> 
  </symbol>
  <symbol viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" id="rss">
    <circle cx="3.429" cy="20.571" r="3.429"></circle>
    <path d="M11.429 24h4.57C15.999 15.179 8.821 8.001 0 8v4.572c6.302.001 11.429 5.126 11.429 11.428z"></path>
    <path d="M24 24C24 10.766 13.234 0 0 0v4.571c10.714 0 19.43 8.714 19.43 19.429z"></path>
  </symbol>
  <symbol viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" id="linkedin">
    <path d="M437 0H75C33.648 0 0 33.648 0 75v362c0 41.352 33.648 75 75 75h362c41.352 0 75-33.648 75-75V75c0-41.352-33.648-75-75-75zM181 406h-60V196h60zm0-240h-60v-60h60zm210 240h-60V286c0-16.54-13.46-30-30-30s-30 13.46-30 30v120h-60V196h60v11.309C286.719 202.422 296.93 196 316 196c40.691.043 75 36.547 75 79.688zm0 0"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 612 612" id="to-top">
    <path d="M604.501 440.509L325.398 134.956c-5.331-5.357-12.423-7.627-19.386-7.27-6.989-.357-14.056 1.913-19.387 7.27L7.499 440.509c-9.999 10.024-9.999 26.298 0 36.323s26.223 10.024 36.222 0l262.293-287.164L568.28 476.832c9.999 10.024 26.222 10.024 36.221 0 9.999-10.023 9.999-26.298 0-36.323z"></path>
  </symbol>
  <symbol viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" id="carly">
    <path d="M504.971 239.029L448 182.059V84c0-46.317-37.682-84-84-84h-44c-13.255 0-24 10.745-24 24s10.745 24 24 24h44c19.851 0 36 16.149 36 36v108c0 6.365 2.529 12.47 7.029 16.971L454.059 256l-47.029 47.029A24.002 24.002 0 0 0 400 320v108c0 19.851-16.149 36-36 36h-44c-13.255 0-24 10.745-24 24s10.745 24 24 24h44c46.318 0 84-37.683 84-84v-98.059l56.971-56.971c9.372-9.372 9.372-24.568 0-33.941zM112 192V84c0-19.851 16.149-36 36-36h44c13.255 0 24-10.745 24-24S205.255 0 192 0h-44c-46.318 0-84 37.683-84 84v98.059l-56.971 56.97c-9.373 9.373-9.373 24.568 0 33.941L64 329.941V428c0 46.317 37.682 84 84 84h44c13.255 0 24-10.745 24-24s-10.745-24-24-24h-44c-19.851 0-36-16.149-36-36V320c0-6.365-2.529-12.47-7.029-16.971L57.941 256l47.029-47.029A24.002 24.002 0 0 0 112 192z"></path>
  </symbol>
  <symbol viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" id="copy">
    <path d="M23 2.75A2.75 2.75 0 0 0 20.25 0H8.75A2.75 2.75 0 0 0 6 2.75v13.5A2.75 2.75 0 0 0 8.75 19h11.5A2.75 2.75 0 0 0 23 16.25zM18.25 14.5h-7.5a.75.75 0 0 1 0-1.5h7.5a.75.75 0 0 1 0 1.5zm0-3h-7.5a.75.75 0 0 1 0-1.5h7.5a.75.75 0 0 1 0 1.5zm0-3h-7.5a.75.75 0 0 1 0-1.5h7.5a.75.75 0 0 1 0 1.5z"></path>
    <path d="M8.75 20.5a4.255 4.255 0 0 1-4.25-4.25V2.75c0-.086.02-.166.025-.25H3.75A2.752 2.752 0 0 0 1 5.25v16A2.752 2.752 0 0 0 3.75 24h12a2.752 2.752 0 0 0 2.75-2.75v-.75z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512.001 512.001" id="closeme">
    <path d="M284.286 256.002L506.143 34.144c7.811-7.811 7.811-20.475 0-28.285-7.811-7.81-20.475-7.811-28.285 0L256 227.717 34.143 5.859c-7.811-7.811-20.475-7.811-28.285 0-7.81 7.811-7.811 20.475 0 28.285l221.857 221.857L5.858 477.859c-7.811 7.811-7.811 20.475 0 28.285a19.938 19.938 0 0 0 14.143 5.857 19.94 19.94 0 0 0 14.143-5.857L256 284.287l221.857 221.857c3.905 3.905 9.024 5.857 14.143 5.857s10.237-1.952 14.143-5.857c7.811-7.811 7.811-20.475 0-28.285L284.286 256.002z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id="open-menu">
    <path d="M492 236H20c-11.046 0-20 8.954-20 20s8.954 20 20 20h472c11.046 0 20-8.954 20-20s-8.954-20-20-20zm0-160H20C8.954 76 0 84.954 0 96s8.954 20 20 20h472c11.046 0 20-8.954 20-20s-8.954-20-20-20zm0 320H20c-11.046 0-20 8.954-20 20s8.954 20 20 20h472c11.046 0 20-8.954 20-20s-8.954-20-20-20z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="instagram">
    <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id=youtube>
    <path d="M19.615 3.184c-3.604-.246-11.631-.245-15.23 0-3.897.266-4.356 2.62-4.385 8.816.029 6.185.484 8.549 4.385 8.816 3.6.245 11.626.246 15.23 0 3.897-.266 4.356-2.62 4.385-8.816-.029-6.185-.484-8.549-4.385-8.816zm-10.615 12.816v-8l8 3.993-8 4.007z"/>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="stackoverflow">
    <path d="M21 27v-8h3v11H0V19h3v8h18z"></path><path d="M17.1.2L15 1.8l7.9 10.6 2.1-1.6L17.1.2zm3.7 14.7L10.6 6.4l1.7-2 10.2 8.5-1.7 2zM7.2 12.3l12 5.6 1.1-2.4-12-5.6-1.1 2.4zm-1.8 6.8l13.56 1.96.17-2.38-13.26-2.55-.47 2.97zM19 25H5v-3h14v3z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="xing">
    <path d="M18.188 0c-.517 0-.741.325-.927.66 0 0-7.455 13.224-7.702 13.657.015.024 4.919 9.023 4.919 9.023.17.308.436.66.967.66h3.454c.211 0 .375-.078.463-.22.089-.151.089-.346-.009-.536l-4.879-8.916c-.004-.006-.004-.016 0-.022L22.139.756c.095-.191.097-.387.006-.535C22.056.078 21.894 0 21.686 0h-3.498zM3.648 4.74c-.211 0-.385.074-.473.216-.09.149-.078.339.02.531l2.34 4.05c.004.01.004.016 0 .021L1.86 16.051c-.099.188-.093.381 0 .529.085.142.239.234.45.234h3.461c.518 0 .766-.348.945-.667l3.734-6.609-2.378-4.155c-.172-.315-.434-.659-.962-.659H3.648v.016z"/>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 71 55" id="discord">
    <path d="M60.1045 4.8978C55.5792 2.8214 50.7265 1.2916 45.6527 0.41542C45.5603 0.39851 45.468 0.440769 45.4204 0.525289C44.7963 1.6353 44.105 3.0834 43.6209 4.2216C38.1637 3.4046 32.7345 3.4046 27.3892 4.2216C26.905 3.0581 26.1886 1.6353 25.5617 0.525289C25.5141 0.443589 25.4218 0.40133 25.3294 0.41542C20.2584 1.2888 15.4057 2.8186 10.8776 4.8978C10.8384 4.9147 10.8048 4.9429 10.7825 4.9795C1.57795 18.7309 -0.943561 32.1443 0.293408 45.3914C0.299005 45.4562 0.335386 45.5182 0.385761 45.5576C6.45866 50.0174 12.3413 52.7249 18.1147 54.5195C18.2071 54.5477 18.305 54.5139 18.3638 54.4378C19.7295 52.5728 20.9469 50.6063 21.9907 48.5383C22.0523 48.4172 21.9935 48.2735 21.8676 48.2256C19.9366 47.4931 18.0979 46.6 16.3292 45.5858C16.1893 45.5041 16.1781 45.304 16.3068 45.2082C16.679 44.9293 17.0513 44.6391 17.4067 44.3461C17.471 44.2926 17.5606 44.2813 17.6362 44.3151C29.2558 49.6202 41.8354 49.6202 53.3179 44.3151C53.3935 44.2785 53.4831 44.2898 53.5502 44.3433C53.9057 44.6363 54.2779 44.9293 54.6529 45.2082C54.7816 45.304 54.7732 45.5041 54.6333 45.5858C52.8646 46.6197 51.0259 47.4931 49.0921 48.2228C48.9662 48.2707 48.9102 48.4172 48.9718 48.5383C50.038 50.6034 51.2554 52.5699 52.5959 54.435C52.6519 54.5139 52.7526 54.5477 52.845 54.5195C58.6464 52.7249 64.529 50.0174 70.6019 45.5576C70.6551 45.5182 70.6887 45.459 70.6943 45.3942C72.1747 30.0791 68.2147 16.7757 60.1968 4.9823C60.1772 4.9429 60.1437 4.9147 60.1045 4.8978ZM23.7259 37.3253C20.2276 37.3253 17.3451 34.1136 17.3451 30.1693C17.3451 26.225 20.1717 23.0133 23.7259 23.0133C27.308 23.0133 30.1626 26.2532 30.1066 30.1693C30.1066 34.1136 27.28 37.3253 23.7259 37.3253ZM47.3178 37.3253C43.8196 37.3253 40.9371 34.1136 40.9371 30.1693C40.9371 26.225 43.7636 23.0133 47.3178 23.0133C50.9 23.0133 53.7545 26.2532 53.6986 30.1693C53.6986 34.1136 50.9 37.3253 47.3178 37.3253Z"/>
  </symbol>
</svg>


<footer class="footer">
  <div class="footer_inner wrap pale">
    <img src='https://blog.andreasm.io/icons/apple-touch-icon.png' class="icon icon_2 transparent" alt="From 0.985mhz... to several Ghz">
    <p>Copyright&nbsp;2016-&nbsp;<span class="year"></span>&nbsp;FROM 0.985MHZ... TO SEVERAL GHZ. All Rights Reserved</p><a class="to_top" href="#documentTop">
  <svg class="icon">
  <title>to-top</title>
  <use xlink:href="#to-top"></use>
</svg>

</a>

  </div>
</footer>

<script type="text/javascript" src="https://blog.andreasm.io/en/js/bundle.5548d358738600c857a1f05f0459418da7143d4426c66a08bf3f15ded1b39dd2136bf104a559247a909fc4dcc45b8e06bad0870ece4c71ee5303d30550def8bd.js" integrity="sha512-VUjTWHOGAMhXofBfBFlBjacUPUQmxmoIvz8V3tGzndITa/EEpVkkepCfxNzEW44GutCHDs5Mce5TA9MFUN74vQ==" crossorigin="anonymous"></script>

  <script src="https://blog.andreasm.io/js/search.min.95a6a82b7db565e9830200f15d8809e9663868dd57209f6f86afd54bb19568b9fbdfb9b479ebcc5d37e3b2e2136e396c05135d268cd68b21728a0bc176a8a809.js"></script>

  </body>
</html>
