
<!DOCTYPE html>
<html
  lang="en"
  data-figures=""
  
    class="page"
  
  
  
    data-mode="dim"
  >
  <head>
<title>TKG 2.3 deployment in multiple availability zones | From 0.985mhz... to several Ghz</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-TVPYDVE8KR"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-TVPYDVE8KR');
</script>



  
<meta property="og:locale" content="en" />

<meta property="og:type" content="article">
<meta name="description" content="How to configure TKG with multiple AZs" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:creator" content="">
<meta name="twitter:title" content="TKG 2.3 deployment in multiple availability zones" />
<meta name="twitter:image" content="https://blog.andreasm.io/2023/08/29/tkg-2.3-deployment-in-multiple-availability-zones/images/logo-vmware-tanzu.png"/>
<meta property="og:url" content="https://blog.andreasm.io/2023/08/29/tkg-2.3-deployment-in-multiple-availability-zones/" />
<meta property="og:title" content="TKG 2.3 deployment in multiple availability zones" />
<meta property="og:description" content="How to configure TKG with multiple AZs" />
<meta property="og:image" content="https://blog.andreasm.io/2023/08/29/tkg-2.3-deployment-in-multiple-availability-zones/images/logo-vmware-tanzu.png" />
  <meta name="keywords" content="nsx,vmware,networking,infrastucture,lodbalancing,tanzu,security,cni,antrea,cilium,kubernetes" />

<link rel="apple-touch-icon" sizes="180x180" href="https://blog.andreasm.io/icons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://blog.andreasm.io/icons/favicon-32x32.png">
<link rel="manifest" href="https://blog.andreasm.io/icons/site.webmanifest">

<link rel="canonical" href="https://blog.andreasm.io/2023/08/29/tkg-2.3-deployment-in-multiple-availability-zones/">



<link rel="preload" href="https://blog.andreasm.io/css/styles.6c67fa3a7f5290a2facfb027358dd2bdb5450d04b8de427c8a74d79f524a7fb716b470b14b6ba95f1b7cf3aa9a2219a7294a6adeaf16a1080f432eae45d8c03c.css" integrity = "sha512-bGf6On9SkKL6z7AnNY3SvbVFDQS43kJ8inTXn1JKf7cWtHCxS2upXxt886qaIhmnKUpq3q8WoQgPQy6uRdjAPA==" as="style" crossorigin="anonymous">



<link rel="preload" href="https://blog.andreasm.io/en/js/bundle.5548d358738600c857a1f05f0459418da7143d4426c66a08bf3f15ded1b39dd2136bf104a559247a909fc4dcc45b8e06bad0870ece4c71ee5303d30550def8bd.js" as="script" integrity=
"sha512-VUjTWHOGAMhXofBfBFlBjacUPUQmxmoIvz8V3tGzndITa/EEpVkkepCfxNzEW44GutCHDs5Mce5TA9MFUN74vQ==" crossorigin="anonymous">


<link rel="stylesheet" type="text/css" href="https://blog.andreasm.io/css/styles.6c67fa3a7f5290a2facfb027358dd2bdb5450d04b8de427c8a74d79f524a7fb716b470b14b6ba95f1b7cf3aa9a2219a7294a6adeaf16a1080f432eae45d8c03c.css" integrity="sha512-bGf6On9SkKL6z7AnNY3SvbVFDQS43kJ8inTXn1JKf7cWtHCxS2upXxt886qaIhmnKUpq3q8WoQgPQy6uRdjAPA==" crossorigin="anonymous">


  </head>
  <body
    data-code="15"
    data-lines="false"
    id="documentTop"
    data-lang="en"
  >

<header class="nav_header" >
  <nav class="nav"><a href='https://blog.andreasm.io/' class="nav_brand nav_item" title="From 0.985mhz... to several Ghz">
  <img src="https://blog.andreasm.io/quote3.png" class="logo" alt="From 0.985mhz... to several Ghz">
  <div class="nav_close">
    <div><svg class="icon">
  <title>open-menu</title>
  <use xlink:href="#open-menu"></use>
</svg>
<svg class="icon">
  <title>closeme</title>
  <use xlink:href="#closeme"></use>
</svg>
</div>
  </div>
</a>

    <div class='nav_body nav_body_left'>
      
      
      
        

  <div class="nav_parent">
    <a href="https://blog.andreasm.io/" class="nav_item" title="Home">Home </a>
  </div>
  <div class="nav_parent">
    <a href="https://blog.andreasm.io/about/" class="nav_item" title="About">About </a>
  </div>
      
<div class='follow'>
    
  <a href="https://blog.andreasm.io/index.xml">
    <svg class="icon">
  <title>rss</title>
  <use xlink:href="#rss"></use>
</svg>

  </a>
<div class="color_mode">
  <input type="checkbox" class="color_choice" id="mode">
</div>

</div>

    </div>
  </nav>
</header>

    <main>
  
<div class="grid-inverse wrap content">
  <article class="post_content">
    <h1 class="post_title">TKG 2.3 deployment in multiple availability zones</h1>
  <div class="post_meta">
    <span><svg class="icon">
  <title>calendar</title>
  <use xlink:href="#calendar"></use>
</svg>
</span>
    <span class="post_date">
      29-08-2023</span>
    <span class="post_time"> · 39 min read</span><span>&nbsp;· <a href='https://blog.andreasm.io/tags/tanzu-kubernetes-grid/' title="tanzu-kubernetes-grid" class="post_tag button button_translucent">tanzu-kubernetes-grid
        </a><a href='https://blog.andreasm.io/tags/availability/' title="availability" class="post_tag button button_translucent">availability
        </a>
    </span>
    <span class="page_only">&nbsp;·
  <div class="post_share">
    Share on:
    <a href="https://twitter.com/intent/tweet?text=TKG%202.3%20deployment%20in%20multiple%20availability%20zones&url=https%3a%2f%2fblog.andreasm.io%2f2023%2f08%2f29%2ftkg-2.3-deployment-in-multiple-availability-zones%2f&tw_p=tweetbutton" class="twitter" title="Share on Twitter" target="_blank" rel="nofollow">
      <svg class="icon">
  <title>twitter</title>
  <use xlink:href="#twitter"></use>
</svg>

    </a>
    <a href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fblog.andreasm.io%2f2023%2f08%2f29%2ftkg-2.3-deployment-in-multiple-availability-zones%2f&t=TKG%202.3%20deployment%20in%20multiple%20availability%20zones" class="facebook" title="Share on Facebook" target="_blank" rel="nofollow">
      <svg class="icon">
  <title>facebook</title>
  <use xlink:href="#facebook"></use>
</svg>

    </a>
    <a href="#linkedinshare" id = "linkedinshare" class="linkedin" title="Share on LinkedIn" rel="nofollow">
      <svg class="icon">
  <title>linkedin</title>
  <use xlink:href="#linkedin"></use>
</svg>

    </a>
    <a href="https://blog.andreasm.io/2023/08/29/tkg-2.3-deployment-in-multiple-availability-zones/" title="Copy Link" class="link link_yank">
      <svg class="icon">
  <title>copy</title>
  <use xlink:href="#copy"></use>
</svg>

    </a>
  </div>
  </span>
  </div>

      <div class="post_toc">
        <h2>Overview</h2>
        <nav id="TableOfContents">
  <ul>
    <li><a href="#preparations">Preparations</a>
      <ul>
        <li><a href="#linux-jumphost-with-necessary-tanzu-cli-tools">Linux jumphost with necessary Tanzu CLI tools</a></li>
      </ul>
    </li>
    <li><a href="#vsphere-preparations">vSphere preparations</a>
      <ul>
        <li><a href="#vcenter-tkg-kubernetes-ova-template">vCenter TKG Kubernetes OVA template</a></li>
      </ul>
    </li>
    <li><a href="#vspherevcenter-availability-zones">vSphere/vCenter availability zones</a>
      <ul>
        <li><a href="#vsphere-drs-host-groups">vSphere DRS Host-Groups</a></li>
        <li><a href="#vsphere-clusters">vSphere Clusters</a></li>
        <li><a href="#vcenter-tags---using-vsphere-cluster-and-datacenter">vCenter Tags - using vSphere cluster and datacenter</a></li>
        <li><a href="#vcenter-tags---using-vsphere-drs-host-groups">vCenter Tags - using vSphere DRS host-groups</a></li>
      </ul>
    </li>
    <li><a href="#tkg---management-cluster">TKG - Management Cluster</a>
      <ul>
        <li><a href="#tkg-multi-az-config-file---using-vcenter-drs-host-groups">TKG multi-az config file - using vCenter DRS host-groups</a></li>
        <li><a href="#tkg-multi-az-config-file---using-vsphere-cluster-and-datacenter">TKG multi-az config file - using vSphere cluster and datacenter</a></li>
        <li><a href="#tkg-bootstrap-yaml---common-for-both-vsphere-cluster-and-drs-host-groups">TKG bootstrap yaml - common for both vSphere cluster and DRS host-groups</a></li>
      </ul>
    </li>
    <li><a href="#tkg-deployment">TKG Deployment</a>
      <ul>
        <li><a href="#tkg-mgmt-cluster-deployment-with-multi-availability-zones">TKG Mgmt Cluster deployment with multi-availability-zones</a></li>
        <li><a href="#adding-or-adjusting-the-vspherefailuredomains-and-vspheredeploymentzone">Adding or adjusting the vSphereFailureDomains and vSphereDeploymentZone</a></li>
        <li><a href="#tkg-workload-cluster-deployment-with-multi-availability-zones---using-vsphere-clusters-as-azs">TKG Workload Cluster deployment with multi-availability-zones - using vSphere clusters as AZs</a></li>
        <li><a href="#tkg-workload-cluster-deployment-with-multi-availability-zones---using-vcenter-host-groups-as-azs">TKG Workload Cluster deployment with multi-availability-zones - using vCenter host-groups as AZs</a></li>
      </ul>
    </li>
    <li><a href="#deploy-applications-on-workload-cluster-in-a-multi-az-environment">Deploy applications on workload cluster in a multi-az environment</a>
      <ul>
        <li><a href="#applicationpod-placement-using-nodeaffinity">Application/pod placement using nodeAffinity</a></li>
      </ul>
    </li>
    <li><a href="#failure-simulations">Failure simulations</a></li>
    <li><a href="#update-existing-tkg-cluster-to-use-new-availability-zones">Update existing TKG cluster to use new Availability Zones</a></li>
    <li><a href="#wrapping-up">Wrapping up</a></li>
  </ul>
</nav>
      </div>
    
    <div class="post_body"><h1 id="tanzu-kubernetes-grid-23-and-availability-zones">Tanzu Kubernetes Grid 2.3 and availability zones</h1>
<p>TKG 2.3 brings support for multiple availability zones (AZs) in the <a href="https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid/2/about-tkg/support-policies.html#states">stable</a> feature set. So I wanted to explore this possibility and how to configure it. I will go through the configuratuons steps needed before deployment of a new TKG management cluster and TKG workload cluster using different availability zones. This post's primary focus is the multi availability zone feature, so I will not go into details in general TKG configurations such networking, loadbalancing as I already have a post covering a &quot;standard&quot; installation of TKG.</p>
<p>I will start by deploying the TKG management worker nodes on two of my three vSphere clusters (Cluster-2 and 3) and control-plane nodes in my vSphere Cluster-1, just to illustrate that with TKG 2.3 I can control where the respective type of nodes will be placed. Then I will deploy a TKG workload cluster (tkg-cluster-1) using the same zone-placement as the TKG management cluster. Both the TKG management cluster deployment and first workload cluster will be using vSphere clusters as availability zones. It will end up looking like this:

  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="mgmt-wld-cluster-placement"
      
        class="image_figure image_internal image_processed"
        width="3514"
        height="1062"
        src="/2023/08/29/tkg-2.3-deployment-in-multiple-availability-zones/images/image-20230904074757152.png"
      
      
    />

    </picture>
</figure>
</p>
<p>When I have deployed my tkg-cluster-1 (workload cluster) I will apply another zone-config using vSphere DRS host-groups and provision a second TKG workload cluster (tkg-cluster-2-hostgroups) using a zone config configured to use vSphere DRS host-groups where I will define DRS rules on Cluster-3 dividing the four hosts into two zones, something like this:</p>
<img src=images/image-20230904075516401.png style="width:500px" />
<p>This post will be using a vSphere as the TKG infrastructure provider. The vSphere environment consists of 1 vCenter server, 3 vSphere clusters with 4 hosts in each ( a total of 12 ESXi hosts equally distributed across 3 vSphere clusters). All vSphere clusters are providing their own vSAN datastore local to their vSphere cluster. There is no stretched vSAN nor any datastore replication going on. NSX is the underlaying network infrastructure and NSX-ALB for all loadbalancing needs. To get started there is some steps that needs to be done in vCenter, a prepared linux jumphost/bootstrap client with necessary cli tools. So lets start with the preparations.</p>
<h2 id="preparations">Preparations</h2>
<p>This section will cover all the needed preparations to get TKG 2.3 up and running in multiple availability zones. First out is the Linux jumphost, then vCenter configurations before doing the deployment. For more details on all requirements I dont cover in this post, head over to the offical documentation <a href="https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid/2.3/tkg-deploy-mc/mgmt-reqs-prep-vsphere.html">here</a></p>
<h3 id="linux-jumphost-with-necessary-tanzu-cli-tools">Linux jumphost with necessary Tanzu CLI tools</h3>
<p>The Linux jumphost needs to be configured with the following specifications:</p>
<ul>
<li>A Linux, Windows, or macOS operating system running on a physical or virtual machine that has the following hardware:
<ul>
<li>At least 8 GB of RAM. VMware recommends 16 GB of RAM.</li>
<li>A disk with 50 GB of available storage.</li>
<li>2 or 4 2-core CPUs.</li>
<li>Docker installed and running.</li>
</ul>
</li>
</ul>
<p>When that is sorted, log into the jumphost and start by grabbing the Tanzu CLI. This has become very easy compared to earlier.
My Linux jumphost is running Ubuntu, so I just need to add the repository for the Tanzu CLI like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">sudo apt update
</span></span><span class="line"><span class="ln">2</span><span class="cl">sudo apt install -y ca-certificates curl gpg
</span></span><span class="line"><span class="ln">3</span><span class="cl">sudo mkdir -p /etc/apt/keyrings
</span></span><span class="line"><span class="ln">4</span><span class="cl">curl -fsSL https://packages.vmware.com/tools/keys/VMWARE-PACKAGING-GPG-RSA-KEY.pub <span class="p">|</span> sudo gpg --dearmor -o /etc/apt/keyrings/tanzu-archive-keyring.gpg
</span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;deb [signed-by=/etc/apt/keyrings/tanzu-archive-keyring.gpg] https://storage.googleapis.com/tanzu-cli-os-packages/apt tanzu-cli-jessie main&#34;</span> <span class="p">|</span> sudo tee /etc/apt/sources.list.d/tanzu.list
</span></span><span class="line"><span class="ln">6</span><span class="cl">sudo apt update
</span></span><span class="line"><span class="ln">7</span><span class="cl">sudo apt install -y tanzu-cli
</span></span></code></pre></div><p>If not using Ubuntu, or you prefer another method of installation, read <a href="https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid/2.3/tkg-deploy-mc/install-cli.html">here</a> for more options.</p>
<p>Then I need to install the necessary Tanzu CLI plugins like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">andreasm@tkg-bootstrap:~$ tanzu plugin group get vmware-tkg/default:v2.3.0 <span class="c1"># to list them</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="o">[</span>i<span class="o">]</span> Reading plugin inventory <span class="k">for</span> <span class="s2">&#34;projects.registry.vmware.com/tanzu_cli/plugins/plugin-inventory:latest&#34;</span>, this will take a few seconds.
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">Plugins in Group:  vmware-tkg/default:v2.3.0
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">  NAME                TARGET      VERSION
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">  isolated-cluster    global      v0.30.1
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">  management-cluster  kubernetes  v0.30.1
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">  package             kubernetes  v0.30.1
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">  pinniped-auth       global      v0.30.1
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">  secret              kubernetes  v0.30.1
</span></span><span class="line"><span class="ln">10</span><span class="cl">  telemetry           kubernetes  v0.30.1
</span></span><span class="line"><span class="ln">11</span><span class="cl">andreasm@tkg-bootstrap:~/.config$ tanzu plugin install --group vmware-tkg/default:v2.3.0 <span class="c1"># to install them</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="o">[</span>i<span class="o">]</span> The tanzu cli essential plugins have not been installed and are being installed now. The install may take a few seconds.
</span></span><span class="line"><span class="ln">13</span><span class="cl">
</span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="o">[</span>i<span class="o">]</span> Installing plugin <span class="s1">&#39;isolated-cluster:v0.30.1&#39;</span> with target <span class="s1">&#39;global&#39;</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="o">[</span>i<span class="o">]</span> Installing plugin <span class="s1">&#39;management-cluster:v0.30.1&#39;</span> with target <span class="s1">&#39;kubernetes&#39;</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="o">[</span>i<span class="o">]</span> Installing plugin <span class="s1">&#39;package:v0.30.1&#39;</span> with target <span class="s1">&#39;kubernetes&#39;</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="o">[</span>i<span class="o">]</span> Installing plugin <span class="s1">&#39;pinniped-auth:v0.30.1&#39;</span> with target <span class="s1">&#39;global&#39;</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="o">[</span>i<span class="o">]</span> Installing plugin <span class="s1">&#39;secret:v0.30.1&#39;</span> with target <span class="s1">&#39;kubernetes&#39;</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="o">[</span>i<span class="o">]</span> Installing plugin <span class="s1">&#39;telemetry:v0.30.1&#39;</span> with target <span class="s1">&#39;kubernetes&#39;</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="o">[</span>ok<span class="o">]</span> successfully installed all plugins from group <span class="s1">&#39;vmware-tkg/default:v2.3.0&#39;</span>
</span></span></code></pre></div><p>Then I need the Kubernetes CLI, &quot;kubectl cli v1.26.5 for Linux&quot; for TKG 2.3 which can be found <a href="https://customerconnect.vmware.com/en/downloads/info/slug/infrastructure_operations_management/vmware_tanzu_kubernetes_grid/2_x">here</a>. After I have downloaded it, I copy it over to the Linux jumphost, extract it and place the binary <em>kubectl</em> in the folder <em>/usr/local/bin</em> so its in my path.</p>
<p>To verify the CLI tools and plugins are in place, I will run these commands:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1"># Verify Tanzu CLI version:</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">andreasm@tkg-bootstrap:~/.config$ tanzu version
</span></span><span class="line"><span class="ln">3</span><span class="cl">version: v1.0.0
</span></span><span class="line"><span class="ln">4</span><span class="cl">buildDate: 2023-08-08
</span></span><span class="line"><span class="ln">5</span><span class="cl">sha: 006d0429
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1"># Verify Tanzu CLI plugins:</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">andreasm@tkg-bootstrap:~/.config$ tanzu plugin list
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">Standalone Plugins
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">  NAME                DESCRIPTION                                                        TARGET      VERSION  STATUS
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">  isolated-cluster    Prepopulating images/bundle <span class="k">for</span> internet-restricted environments   global      v0.30.1  installed
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">  pinniped-auth       Pinniped authentication operations <span class="o">(</span>usually not directly invoked<span class="o">)</span>  global      v0.30.1  installed
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">  telemetry           configure cluster-wide settings <span class="k">for</span> vmware tanzu telemetry         global      v1.1.0   installed
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">  management-cluster  Kubernetes management cluster operations                           kubernetes  v0.30.1  installed
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">  package             Tanzu package management                                           kubernetes  v0.30.1  installed
</span></span><span class="line"><span class="ln">10</span><span class="cl">  secret              Tanzu secret management                                            kubernetes  v0.30.1  installed
</span></span><span class="line"><span class="ln">11</span><span class="cl">  telemetry           configure cluster-wide settings <span class="k">for</span> vmware tanzu telemetry         kubernetes  v0.30.1  installed
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1"># verify kubectl version - look for &#34;Client Version&#34;</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">andreasm@tkg-bootstrap:~/.config$ kubectl version
</span></span><span class="line"><span class="ln">3</span><span class="cl">WARNING: This version information is deprecated and will be replaced with the output from kubectl version --short.  Use --output<span class="o">=</span>yaml<span class="p">|</span>json to get the full version.
</span></span><span class="line"><span class="ln">4</span><span class="cl">Client Version: version.Info<span class="o">{</span>Major:<span class="s2">&#34;1&#34;</span>, Minor:<span class="s2">&#34;26&#34;</span>, GitVersion:<span class="s2">&#34;v1.26.5+vmware.2&#34;</span>, GitCommit:<span class="s2">&#34;83112f368344a8ff6d13b89f120d5e646cd3bf19&#34;</span>, GitTreeState:<span class="s2">&#34;clean&#34;</span>, BuildDate:<span class="s2">&#34;2023-06-26T06:47:19Z&#34;</span>, GoVersion:<span class="s2">&#34;go1.19.9&#34;</span>, Compiler:<span class="s2">&#34;gc&#34;</span>, Platform:<span class="s2">&#34;linux/amd64&#34;</span><span class="o">}</span>
</span></span><span class="line"><span class="ln">5</span><span class="cl">Kustomize Version: v4.5.7
</span></span></code></pre></div><p>Next up is some preparations that needs to be done in vCenter.</p>
<h2 id="vsphere-preparations">vSphere preparations</h2>
<p>As vSphere is the platform where I deploy TKG there are a couple of things that needs to be done to prepare for the deployment of TKG in general but also how the different availability zones will be configured. Apart from the necessary functions such as networking and storage to support a TKG deployment.</p>
<h3 id="vcenter-tkg-kubernetes-ova-template">vCenter TKG Kubernetes OVA template</h3>
<p>A small but important part is the OVA template to be used for the controlplane/worker nodes. I need to upload the right Kubernetes OVA template, it needs to be version 1.26.5, where I am using the latest Ubuntu 2004 Kubernetes v1.26.5 OVA. This I have downloaded from [here](<a href="https://customerconnect.vmware.com/en/downloads/info/slug/infrastructure_operations_management/vmware_tanzu_kubernetes_grid/2_x">the Tanzu Kubernetes Grid downloads page</a>), uploaded it to my vCenter server, then converted it to a template, not changing anything on it, name etc.</p>
<h2 id="vspherevcenter-availability-zones">vSphere/vCenter availability zones</h2>
<p>With TKG 2.3 running on vSphere there is two ways to define the availability zones. There is the option to use vSphere clusters as availability zones or vSphere DRS host-groups. This gives flexibility and the possibility to define the availability zones according to how the underlaying vSphere environment has been configured. We can potentially have many availability zones for TKG to consume, some using host-groups, some using vSphere clusters and even different vCenter servers. It all depends on the needs and where it makes sense. Regardless of using vSphere clusters or DRS host-groups we need to define define a region and a zone for TKG to use. In vCenter we need to create tag associated with a category. The category can be whatever you want to call it, they just need to be reflected correctly when defining the vSphereFailureDomain later on. You may end up with several vSphere tag-categories as this depend on the environment and how you want to use the availability zones.  These tag and categories are defined a bit different between vSphere clusters and DRS host-groups. When using vSphere clusters the region is defined on the Datacenter object and the zone is the actual vsphere cluster. When using DRS host-groups the vSphere cluster is defined as the the regions and the host-group as the zone.</p>
<img src=images/image-20230831084930074.png style="width:500px" />
<img src=images/image-20230831085904923.png style="width:500px" />
<h3 id="vsphere-drs-host-groups">vSphere DRS Host-Groups</h3>
<p>The option to use host-groups (DRS objects) is to create &quot;logical&quot; zones based on host-groups/vm-groups affinity rules to place the TKG nodes in their respective host-groups inside same vSphere Cluster. This done by creating the host-groups, place the corresponding esxi hosts in the respective host-group and use vCenter <em>Tags &amp; Custom Attributes</em> specifying tags on these objects respectively. This can be a good use case if the vSphere hosts are in the same vSphere cluster but spread across several racks. That means I can create a host-group pr rack, and define these host-groups as my availability zones for TKG to place the nodes accordingly. Lets pretend I have 12 ESXi hosts, equally divided and placed in their own rack. I can then create 3 host-groups called <em>rack-1</em>, <em>rack-2</em> and <em>rack-3</em>.</p>
<img src=images/image-20230831080601895.png style="width:500px" />
<h3 id="vsphere-clusters">vSphere Clusters</h3>
<p>Using the vSphere clusters option we define the vCenter Datacenter object as the region and the vSphere clusters as the zones. We define that easily by using the vCenter <em>Tags &amp; Custom Attributes</em> specifying tags on these objects respectively. We tag the specific vSphere Datacenter to become a region and we tag the vSphere clusters to be a specific zone. In mye lab I have vSphere hosts in three different vSphere clusters. With that I have defined my vCenter Server's only Datacenter object to be a region, and all my three vSphere clusters as three different zones within that one region. In short that means if I have only one Datacenter object in my vCenter that is a region. In this Datecenter object I have my three vSphere host clusters which will be three different zones for TKG to be aware of for potential placement of the TKG nodes.</p>
<img src=images/image-20230831091608292.png style="width:500px" />
<p>For more information on multiple availability zones head over to the offical docs <a href="https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid/2.3/using-tkg/workload-clusters-multi-az-vsphere.html">here</a>.</p>
<p>Next up is how configured the AZs in vCenter using vSphere clusters and DRS host-groups</p>
<h3 id="vcenter-tags---using-vsphere-cluster-and-datacenter">vCenter Tags - using vSphere cluster and datacenter</h3>
<p>As I am using vSphere Clusters as my zones and vSphere Datacenter it is very straight forward. The first thing that needs to be done is to create two categories under Tags &amp; Custom Attributes here:</p>
<img src=images/image-20230830082443709.png style="width:300px" />
<img src=images/image-20230830082626594.png style="width:300px" />
<p>The two categories is the <em>region</em> and <em>zone</em>. These two categories are created like this.</p>
<p>Region category:</p>
<img src=images/image-20230830084002391.png style="width:600px" />
<p>Then the Zone category:</p>
<img src=images/image-20230830084148111.png style="width:600px" />
<p>The categories can also be created using a cli tool called <a href="https://github.com/vmware/govmomi/tree/main/govc">govc</a> like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@tkg-bootstrap:~$ govc tags.category.create -t Datacenter k8s-region
</span></span><span class="line"><span class="ln">2</span><span class="cl">urn:vmomi:InventoryServiceCategory:a0248c5d-7050-4891-9635-1b5cbcb89f29:GLOBAL
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@tkg-bootstrap:~$ govc tags.category.create -t ClusterComputeResource k8s-zone
</span></span><span class="line"><span class="ln">2</span><span class="cl">urn:vmomi:InventoryServiceCategory:1d13b59d-1d2c-433a-b3ac-4f6528254f98:GLOBAL
</span></span></code></pre></div><p>I should now see the categories like this in my vCenter UI:</p>
<img src=images/image-20230830091325042.png style="width:600px" />
<p>Now when I have created the categories, I need to create the tags using the newly created categories respectively.</p>
<p>The k8s-region category is used on the vCenter/vSphere Datacenter object. I will create a tag using the category <em>k8s-region</em> with some kind of meaningful name for the Datacenter object, and then attach this tag to the Datacenter object.</p>
<p>Create Datacenter Tag:</p>
<img src=images/image-20230830091733652.png style="width:500px" />
<p>Then attach it to the Datacenter object:</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="assign-dc-tag"
      
        class="image_figure image_internal image_processed"
        width="2952"
        height="976"
        src="/2023/08/29/tkg-2.3-deployment-in-multiple-availability-zones/images/image-20230830091929380.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Or using govc to attach/assign the tag:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@tkg-bootstrap:~$ govc tags.attach -c k8s-region wdc-region /cPod-NSXAM-WDC
</span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="c1"># There is no output after execution of this command...</span>
</span></span></code></pre></div><p>Next up is the tags using the <em>k8s-zone</em> category. I am creating three tags for this as I have three vSphere clusters I want to use a three different Availability Zones. The tags are created the same as before only using the category <em>k8s-zone</em> instead.</p>
<p>I will end up with three tags called <em>wdc-zone-1</em>,<em>wdc-zone-2</em>, and <em>wdc-zone-3</em>.</p>
<img src=images/image-20230830092250715.png style="width:500px" />
<p>And here they are:</p>
<img src=images/image-20230830092351366.png style="width:500px" />
<p>Now I need to attach them to my vSphere clusters respectively, Cluster-1 = wdc-zone-1, Cluster-2 = wdc-zone-2 and Cluster-3 = wdc-zone-3.</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="cluster-tag-assign"
      
        class="image_figure image_internal image_processed"
        width="2412"
        height="942"
        src="/2023/08/29/tkg-2.3-deployment-in-multiple-availability-zones/images/image-20230830092629367.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Again, the creation of the tags and attaching them can be done using <em>govc</em>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1"># Creating the tags using the correct category</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">andreasm@tkg-bootstrap:~$ govc tags.create -c k8s-zone wdc-zone-1
</span></span><span class="line"><span class="ln">3</span><span class="cl">andreasm@tkg-bootstrap:~$ govc tags.create -c k8s-zone wdc-zone-2
</span></span><span class="line"><span class="ln">4</span><span class="cl">andreasm@tkg-bootstrap:~$ govc tags.create -c k8s-zone wdc-zone-3
</span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="c1"># Attaching the tags to the respective clusters</span>
</span></span><span class="line"><span class="ln">6</span><span class="cl">andreasm@tkg-bootstrap:~$ govc tags.attach -c k8s-zone wdc-zone-1 /cPod-NSXAM-WDC/host/Cluster-1
</span></span><span class="line"><span class="ln">7</span><span class="cl">andreasm@tkg-bootstrap:~$ govc tags.attach -c k8s-zone wdc-zone-2 /cPod-NSXAM-WDC/host/Cluster-2
</span></span><span class="line"><span class="ln">8</span><span class="cl">andreasm@tkg-bootstrap:~$ govc tags.attach -c k8s-zone wdc-zone-3 /cPod-NSXAM-WDC/host/Cluster-3
</span></span></code></pre></div><h3 id="vcenter-tags---using-vsphere-drs-host-groups">vCenter Tags - using vSphere DRS host-groups</h3>
<p>If using vSphere DRS host-groups this how how we can confgure vCenter using DRS host-groups as availability zones for TKG. In this section I will &quot;simulate&quot; that my vSphere Cluster-3 with 4 ESXi hosts is equally divided into two &quot;racks&quot; (2 ESXi hosts in each host-group). So I will create two host-groups, to reflect two availability zones inside Cluster-3.</p>
<img src=images/image-20230831102005973.png style="width:500px" />
<p>First I need to create two host-groups where I add my corresponding ESXi hosts. Group-1 will contain ESXi-9 and ESXi-12 and Group-2 will contain ESXi-11 and ESXi-12.
From the vCenter UI:</p>
<img src=images/image-20230831102907279.png style="width:500px" />
<p>Click add:
I am naming the host-groups <em>rack-1</em> and <em>rack-2</em> respectively, adding two hosts in each group.</p>
<img src=images/image-20230831103211900.png style="width:500px" />
<p>The two host-groups:</p>
<img src=images/image-20230831103317977.png style="width:600px" />
<p>When the host-groups have been created and defined with the esxi host membership, I need to define two DRS VM-groups.
From the same place as I created the host-groups, I click add and create a VM group instead.</p>
<img src=images/image-20230831103908045.png style="width:400px" />
<p>I need to add a &quot;dummy&quot; vm to be allowed to save and create the group. This is only when creating the group via the vCenter UI.</p>
<img src=images/image-20230831104206108.png style="width:400px" />
<p>Both vm groups created:</p>
<img src=images/image-20230831104328764.png style="width:600px" />
<p>To create these groups with cli using <em>govc</em>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1"># Create Host Groups</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">andreasm@tkg-bootstrap:~$ govc cluster.group.create -cluster<span class="o">=</span>Cluster-3 -name<span class="o">=</span>rack-1 -host esx01 esx02
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="o">[</span>31-08-23 08:49:30<span class="o">]</span> Reconfigure /cPod-NSXAM-WDC/host/Cluster-3...OK
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">andreasm@tkg-bootstrap:~$ govc cluster.group.create -cluster<span class="o">=</span>Cluster-3 -name<span class="o">=</span>rack-2 -host esx03 esx04
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="o">[</span>31-08-23 08:48:30<span class="o">]</span> Reconfigure /cPod-NSXAM-WDC/host/Cluster-3...OK
</span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="c1"># Create VM groups</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">andreasm@tkg-bootstrap:~$ govc cluster.group.create -cluster<span class="o">=</span>Cluster-3 -name<span class="o">=</span>rack-1-vm-group -vm
</span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="o">[</span>31-08-23 08:52:00<span class="o">]</span> Reconfigure /cPod-NSXAM-WDC/host/Cluster-3...OK
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">andreasm@tkg-bootstrap:~$ govc cluster.group.create -cluster<span class="o">=</span>Cluster-3 -name<span class="o">=</span>rack-2-vm-group -vm
</span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="o">[</span>31-08-23 08:52:04<span class="o">]</span> Reconfigure /cPod-NSXAM-WDC/host/Cluster-3...OK
</span></span></code></pre></div><p>Now I need to create affinity rules restricting the corresponding vm-group to only reside in the correct host-group.</p>
<p>Group-1 rule</p>
<img src=images/image-20230831105836834.png style="width:500px" />
<p>and group 2 rule</p>
<img src=images/image-20230831105945023.png style="width:500px" />
<p>Now its just creating the corresponding tag categories k8s-region and k8s-zone and the respective tags pr cluster and host-groups that have been created. Lets start by creating the categories, first from the vCenter UI then later using cli with <em>govc</em>.
Note that these DRS host-groups are not the objects being tagged as the actual zones later on, they are just the logical boundary used in vCenter for vm placement. The ESXi hosts themselves will be the ones that are tagged with the zone tag, where the ESXi hosts are part of a host-group with a VM affinity rule.</p>
<p>Category <em>k8s-region</em>:</p>
<p>I already have the k8s-region category from earlier, I just need to update it to also allow cluster.</p>
<img src=images/image-20230831112428462.png style="width:500px" />
<p>Category <em>k8s-zone</em>:</p>
<p>I already have the <em>k8s-zone</em> category from earlier, I just need to update it to also allow Host.</p>
<img src=images/image-20230831112709293.png style="width:500px" />
<p>Then I need to create the tag using the correct category, starting with the region tag.
Create tag called <em>room1</em> (in lack of own fantasy)</p>
<img src=images/image-20230831113118169.png style="width:500px" />
<p>Then the two tags pr zone/host-group:</p>
<p>Rack1</p>
<img src=images/image-20230831113221327.png style="width:500px" />
<p>Rack2</p>
<img src=images/image-20230831113309054.png style="width:500px" />
<p>Now I need to attach the above tags to the correct objects in vCenter. The region tag will be used on the Cluster-3 object, the k8s-zone tags will be used on the ESXi host objects.
The region <em>room1</em> tag:</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="region-room1-tag"
      
        class="image_figure image_internal image_processed"
        width="2602"
        height="828"
        src="/2023/08/29/tkg-2.3-deployment-in-multiple-availability-zones/images/image-20230831114701855.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Then the zone tag <em>rack1</em> and <em>rack2</em></p>
<p>Rack1</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="esxi1-zone-tag"
      
        class="image_figure image_internal image_processed"
        width="2204"
        height="716"
        src="/2023/08/29/tkg-2.3-deployment-in-multiple-availability-zones/images/image-20230831114913112.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Rack2</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="esxi3-zone-tag"
      
        class="image_figure image_internal image_processed"
        width="2316"
        height="774"
        src="/2023/08/29/tkg-2.3-deployment-in-multiple-availability-zones/images/image-20230831115026621.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Now I have tagged the region and the zones, and should now have 2 availability zones for TKG to use.</p>
<p>To configure the categories, tags and attachment from cli using <em>govc</em>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="ln"> 1</span><span class="cl"># Creating the categories if not already created, if already created run the tags.category.update
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">andreasm@tkg-bootstrap:~$ govc tags.category.create -t ClusterComputeResource k8s-region
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">andreasm@tkg-bootstrap:~$ govc tags.category.create -t HostSystem k8s-zone
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"># Create the region tag
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">andreasm@tkg-bootstrap:~$ govc tags.create -c k8s-region room1
</span></span><span class="line"><span class="ln"> 6</span><span class="cl"># Create the zone tag
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">andreasm@tkg-bootstrap:~$ govc tags.create -c k8s-zone rack1
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">andreasm@tkg-bootstrap:~$ govc tags.create -c k8s-zone rack2
</span></span><span class="line"><span class="ln"> 9</span><span class="cl"># Attach the region tag to vSphere Cluster-3
</span></span><span class="line"><span class="ln">10</span><span class="cl">andreasm@tkg-bootstrap:~$ govc tags.attach -c k8s-region room1 /cPod-NSXAM-WDC/host/Cluster-3
</span></span><span class="line"><span class="ln">11</span><span class="cl"># Attach the zone tag to the ESXi hosts
</span></span><span class="line"><span class="ln">12</span><span class="cl">andreasm@tkg-bootstrap:~$ govc tags.attach -c k8s-zone rack1 /cPod-NSXAM-WDC/host/Cluster-3/esxi-01.fqdn
</span></span><span class="line"><span class="ln">13</span><span class="cl">andreasm@tkg-bootstrap:~$ govc tags.attach -c k8s-zone rack1 /cPod-NSXAM-WDC/host/Cluster-3/esxi-02.fqdn
</span></span><span class="line"><span class="ln">14</span><span class="cl">andreasm@tkg-bootstrap:~$ govc tags.attach -c k8s-zone rack2 /cPod-NSXAM-WDC/host/Cluster-3/esxi-03.fqdn
</span></span><span class="line"><span class="ln">15</span><span class="cl">andreasm@tkg-bootstrap:~$ govc tags.attach -c k8s-zone rack2 /cPod-NSXAM-WDC/host/Cluster-3/esxi-04.fqdn
</span></span></code></pre></div><p>Now that the necessary tags and categories have been created and assigned in vCenter, I can continue to prepare the necessary configs for TKG to use them.</p>

<div class="notices warning">
    <div class="label">Be aware</div>
    <p>If the categories are already in place from previous installations, and you want to add these AZs also - Create new categories as the CSI installation will fail complaining on this error:
<em>&quot;plugin registration failed with err: rpc error: code = Internal desc = failed to retrieve topology information for Node: &quot;&quot;. Error: &quot;failed to fetch topology information for the nodeVM &quot;&quot;. Error: duplicate values detected for category k8s-zone as &quot;rack1&quot; and &quot;wdc-zone-3&quot;&quot;, restarting registration container.&quot;</em></p>
<p>These new categories must be updated accordingly in the multi-az.yaml file and tkg-workload cluster manifest before deployment. It can also make sense to have different categories to distinguish the different environments better.</p>

  </div>

<h2 id="tkg---management-cluster">TKG - Management Cluster</h2>
<p>Before I can deploy a TKG management cluster I need to prepare a bootstrap yaml file and a multi-zone file so it knows about how the cluster should be configured and the availability zones.
For TKG to use the tags created in vCenter we need to define these as Kubernetes FailureDomain and Deployment-Zone objects. This is done by creating a separate yaml file describing this. In this multi-zone file I need to define the <em>region</em>, <em>zone</em> and <em>topology</em>. The category and zone tags created in vCenter and the ones I have used in this post is only to keep it simple. We can have several categories depending on the environment you deploy it on. For more information on this head over <a href="https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid/2.3/using-tkg/workload-clusters-multi-az-vsphere.html#create-failuredomain-and-deployment-zone-objects-in-kubernetes-4">here</a>.
Here it is also possible to define different networks and storage.
A short explanation of the two CRDs in the example below: vSphereFailureDomain is where you provide the necessary information about the region/zones defined in vCenter such as the tags pr region/zone aka Datacenter/Clusters, networks and datastore.
The vSphereDeploymentZone is used for placement constraints, using the vSphereFailureDomains and makes it possible mapping them using labels like I am doing below. A bit more on that later when I come to the actual deployment.</p>
<h3 id="tkg-multi-az-config-file---using-vcenter-drs-host-groups">TKG multi-az config file - using vCenter DRS host-groups</h3>
<p>Below is the yaml file I have prepared to deploy my TKG Management cluster when using vCenter DRS host-groups as availability zones. Comments inline:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">infrastructure.cluster.x-k8s.io/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">VSphereFailureDomain</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">rack1</span><span class="w"> </span><span class="c"># A name for this specifc zone, does not have to be the same as the tag used in vCenter</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">    </span><span class="nt">region</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">room1</span><span class="w"> </span><span class="c"># The specific tag created and assigned to the Datacenter object in vCenter</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">ComputeCluster</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">        </span><span class="nt">tagCategory</span><span class="p">:</span><span class="w"> </span><span class="l">k8s-region</span><span class="w"> </span><span class="c"># The specific tag category created earlier in vCenter</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">    </span><span class="nt">zone</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">rack1</span><span class="w"> </span><span class="c"># The specific tag created and assigned to the cluster object in vCenter</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">HostGroup</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">        </span><span class="nt">tagCategory</span><span class="p">:</span><span class="w"> </span><span class="l">k8s-zone</span><span class="w"> </span><span class="c"># The specific tag category created earlier in vCenter</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">    </span><span class="nt">topology</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">        </span><span class="nt">datacenter</span><span class="p">:</span><span class="w"> </span><span class="l">/cPod-NSXAM-WDC</span><span class="w"> </span><span class="c"># Specifies which Datacenter in vCenter</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">        </span><span class="nt">computeCluster</span><span class="p">:</span><span class="w"> </span><span class="l">Cluster-3</span><span class="w"> </span><span class="c"># Specifices which Cluster in vCenter</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">        </span><span class="nt">hosts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">          </span><span class="nt">vmGroupName</span><span class="p">:</span><span class="w"> </span><span class="l">rack-1-vm-group</span><span class="w"> </span><span class="c"># The vm group name created earlier in vCenter</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">          </span><span class="nt">hostGroupName</span><span class="p">:</span><span class="w"> </span><span class="l">rack-1</span><span class="w"> </span><span class="c"># The host group name created earlier in vCenter</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">        </span><span class="nt">networks</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">            </span>- <span class="l">/cPod-NSXAM-WDC/network/ls-tkg-mgmt</span><span class="w"> </span><span class="c"># Specify the network the nodes shall use in this region/cluster</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">        </span><span class="nt">datastore</span><span class="p">:</span><span class="w"> </span><span class="l">/cPod-NSXAM-WDC/datastore/vsanDatastore-wdc-3</span><span class="w"> </span><span class="c"># Specify the datastore the nodes shall use in this region/cluster</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">infrastructure.cluster.x-k8s.io/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">VSphereFailureDomain</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">rack2</span><span class="w"> </span><span class="c"># A name for this specifc zone, does not have to be the same as the tag used in vCenter</span><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w">    </span><span class="nt">region</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">room1</span><span class="w"> </span><span class="c"># The specific tag created and assigned to the Datacenter object in vCenter</span><span class="w">
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">ComputeCluster</span><span class="w">
</span></span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="w">        </span><span class="nt">tagCategory</span><span class="p">:</span><span class="w"> </span><span class="l">k8s-region</span><span class="w"> </span><span class="c"># The specific tag category created earlier in vCenter</span><span class="w">
</span></span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="w">    </span><span class="nt">zone</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">rack2</span><span class="w"> </span><span class="c"># The specific tag created and assigned to the cluster object in vCenter</span><span class="w">
</span></span></span><span class="line"><span class="ln">36</span><span class="cl"><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">HostGroup</span><span class="w">
</span></span></span><span class="line"><span class="ln">37</span><span class="cl"><span class="w">        </span><span class="nt">tagCategory</span><span class="p">:</span><span class="w"> </span><span class="l">k8s-zone</span><span class="w"> </span><span class="c"># The specific tag category created earlier in vCenter</span><span class="w">
</span></span></span><span class="line"><span class="ln">38</span><span class="cl"><span class="w">    </span><span class="nt">topology</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">39</span><span class="cl"><span class="w">        </span><span class="nt">datacenter</span><span class="p">:</span><span class="w"> </span><span class="l">/cPod-NSXAM-WDC</span><span class="w"> </span><span class="c"># Specifies which Datacenter in vCenter</span><span class="w">
</span></span></span><span class="line"><span class="ln">40</span><span class="cl"><span class="w">        </span><span class="nt">computeCluster</span><span class="p">:</span><span class="w"> </span><span class="l">Cluster-3</span><span class="w"> </span><span class="c"># Specifices which Cluster in vCenter</span><span class="w">
</span></span></span><span class="line"><span class="ln">41</span><span class="cl"><span class="w">        </span><span class="nt">hosts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">42</span><span class="cl"><span class="w">          </span><span class="nt">vmGroupName</span><span class="p">:</span><span class="w"> </span><span class="l">rack-2-vm-group</span><span class="w"> </span><span class="c"># The vm group name created earlier in vCenter</span><span class="w">
</span></span></span><span class="line"><span class="ln">43</span><span class="cl"><span class="w">          </span><span class="nt">hostGroupName</span><span class="p">:</span><span class="w"> </span><span class="l">rack-2</span><span class="w"> </span><span class="c"># The host group name created earlier in vCenter</span><span class="w">
</span></span></span><span class="line"><span class="ln">44</span><span class="cl"><span class="w">        </span><span class="nt">networks</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">45</span><span class="cl"><span class="w">            </span>- <span class="l">/cPod-NSXAM-WDC/network/ls-tkg-mgmt</span><span class="w"> </span><span class="c"># Specify the network the nodes shall use in this region/cluster</span><span class="w">
</span></span></span><span class="line"><span class="ln">46</span><span class="cl"><span class="w">        </span><span class="nt">datastore</span><span class="p">:</span><span class="w"> </span><span class="l">/cPod-NSXAM-WDC/datastore/vsanDatastore-wdc-3</span><span class="w"> </span><span class="c"># Specify the datastore the nodes shall use in this region/cluster</span><span class="w">
</span></span></span><span class="line"><span class="ln">47</span><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="ln">48</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">infrastructure.cluster.x-k8s.io/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="ln">49</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">VSphereDeploymentZone</span><span class="w">
</span></span></span><span class="line"><span class="ln">50</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">51</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">rack1</span><span class="w"> </span><span class="c"># Give the deploymentzone a name</span><span class="w">
</span></span></span><span class="line"><span class="ln">52</span><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">53</span><span class="cl"><span class="w">    </span><span class="nt">region</span><span class="p">:</span><span class="w"> </span><span class="l">room1</span><span class="w"> </span><span class="c"># For controlplane placement</span><span class="w">
</span></span></span><span class="line"><span class="ln">54</span><span class="cl"><span class="w">    </span><span class="nt">tkg-cp</span><span class="p">:</span><span class="w"> </span><span class="l">allowed</span><span class="w"> </span><span class="c"># For controlplane placement </span><span class="w">
</span></span></span><span class="line"><span class="ln">55</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">56</span><span class="cl"><span class="w">    </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="l">vcsa.fqdn</span><span class="w">
</span></span></span><span class="line"><span class="ln">57</span><span class="cl"><span class="w">    </span><span class="nt">failureDomain</span><span class="p">:</span><span class="w"> </span><span class="l">rack1</span><span class="w"> </span><span class="c"># Calls on the vSphereFailureDomain defined above</span><span class="w">
</span></span></span><span class="line"><span class="ln">58</span><span class="cl"><span class="w">    </span><span class="nt">placementConstraint</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">59</span><span class="cl"><span class="w">        </span><span class="nt">resourcePool</span><span class="p">:</span><span class="w"> </span><span class="l">/cPod-NSXAM-WDC/host/Cluster-3/Resources</span><span class="w">
</span></span></span><span class="line"><span class="ln">60</span><span class="cl"><span class="w">        </span><span class="nt">folder</span><span class="p">:</span><span class="w"> </span><span class="l">/cPod-NSXAM-WDC/vm/TKGm</span><span class="w">
</span></span></span><span class="line"><span class="ln">61</span><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="ln">62</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">infrastructure.cluster.x-k8s.io/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="ln">63</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">VSphereDeploymentZone</span><span class="w">
</span></span></span><span class="line"><span class="ln">64</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">65</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">rack2</span><span class="w"> </span><span class="c"># Give the deploymentzone a name</span><span class="w">
</span></span></span><span class="line"><span class="ln">66</span><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">67</span><span class="cl"><span class="w">    </span><span class="nt">region</span><span class="p">:</span><span class="w"> </span><span class="l">room1</span><span class="w">
</span></span></span><span class="line"><span class="ln">68</span><span class="cl"><span class="w">    </span><span class="nt">tkg-cp</span><span class="p">:</span><span class="w"> </span><span class="l">allowed</span><span class="w">
</span></span></span><span class="line"><span class="ln">69</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">70</span><span class="cl"><span class="w">    </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="l">vcsa.fqdn</span><span class="w">
</span></span></span><span class="line"><span class="ln">71</span><span class="cl"><span class="w">    </span><span class="nt">failureDomain</span><span class="p">:</span><span class="w"> </span><span class="l">rack2</span><span class="w"> </span><span class="c"># Calls on the vSphereFailureDomain defined above</span><span class="w">
</span></span></span><span class="line"><span class="ln">72</span><span class="cl"><span class="w">    </span><span class="nt">placementConstraint</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">73</span><span class="cl"><span class="w">        </span><span class="nt">resourcePool</span><span class="p">:</span><span class="w"> </span><span class="l">/cPod-NSXAM-WDC/host/Cluster-3/Resources</span><span class="w">
</span></span></span><span class="line"><span class="ln">74</span><span class="cl"><span class="w">        </span><span class="nt">folder</span><span class="p">:</span><span class="w"> </span><span class="l">/cPod-NSXAM-WDC/vm/TKGm</span><span class="w">
</span></span></span><span class="line"><span class="ln">75</span><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span></code></pre></div><h3 id="tkg-multi-az-config-file---using-vsphere-cluster-and-datacenter">TKG multi-az config file - using vSphere cluster and datacenter</h3>
<p>Below is the yaml file I have prepared to deploy my TKG Management cluster with when using vSphere clusters as availability zones. Comments inline:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln">  1</span><span class="cl"><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="ln">  2</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">infrastructure.cluster.x-k8s.io/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="ln">  3</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">VSphereFailureDomain</span><span class="w">
</span></span></span><span class="line"><span class="ln">  4</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">  5</span><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">wdc-zone-1</span><span class="w"> </span><span class="c"># A name for this specifc zone, does not have to be the same as the tag used in vCenter</span><span class="w">
</span></span></span><span class="line"><span class="ln">  6</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">  7</span><span class="cl"><span class="w">    </span><span class="nt">region</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">  8</span><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">wdc-region</span><span class="w"> </span><span class="c"># The specific tag created and assigned to the Datacenter object in vCenter</span><span class="w">
</span></span></span><span class="line"><span class="ln">  9</span><span class="cl"><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Datacenter</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 10</span><span class="cl"><span class="w">        </span><span class="nt">tagCategory</span><span class="p">:</span><span class="w"> </span><span class="l">k8s-region</span><span class="w"> </span><span class="c"># The specific tag category created earlier in vCenter</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 11</span><span class="cl"><span class="w">    </span><span class="nt">zone</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 12</span><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">wdc-zone-1</span><span class="w"> </span><span class="c"># The specific tag created and assigned to the cluster object in vCenter</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 13</span><span class="cl"><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">ComputeCluster</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 14</span><span class="cl"><span class="w">        </span><span class="nt">tagCategory</span><span class="p">:</span><span class="w"> </span><span class="l">k8s-zone</span><span class="w"> </span><span class="c"># The specific tag category created earlier in vCenter</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 15</span><span class="cl"><span class="w">    </span><span class="nt">topology</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 16</span><span class="cl"><span class="w">        </span><span class="nt">datacenter</span><span class="p">:</span><span class="w"> </span><span class="l">/cPod-NSXAM-WDC</span><span class="w"> </span><span class="c"># Specifies which Datacenter in vCenter</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 17</span><span class="cl"><span class="w">        </span><span class="nt">computeCluster</span><span class="p">:</span><span class="w"> </span><span class="l">Cluster-1</span><span class="w"> </span><span class="c"># Specifices which Cluster in vCenter</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 18</span><span class="cl"><span class="w">        </span><span class="nt">networks</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 19</span><span class="cl"><span class="w">            </span>- <span class="l">/cPod-NSXAM-WDC/network/ls-tkg-mgmt</span><span class="w"> </span><span class="c"># Specify the network the nodes shall use in this region/cluster</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 20</span><span class="cl"><span class="w">        </span><span class="nt">datastore</span><span class="p">:</span><span class="w"> </span><span class="l">/cPod-NSXAM-WDC/datastore/vsanDatastore-wdc-01</span><span class="w"> </span><span class="c"># Specify the datastore the nodes shall use in this region/cluster</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 21</span><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 22</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">infrastructure.cluster.x-k8s.io/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 23</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">VSphereFailureDomain</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 24</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 25</span><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">wdc-zone-2</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 26</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 27</span><span class="cl"><span class="w">    </span><span class="nt">region</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 28</span><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">wdc-region</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 29</span><span class="cl"><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Datacenter</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 30</span><span class="cl"><span class="w">        </span><span class="nt">tagCategory</span><span class="p">:</span><span class="w"> </span><span class="l">k8s-region</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 31</span><span class="cl"><span class="w">    </span><span class="nt">zone</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 32</span><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">wdc-zone-2</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 33</span><span class="cl"><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">ComputeCluster</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 34</span><span class="cl"><span class="w">        </span><span class="nt">tagCategory</span><span class="p">:</span><span class="w"> </span><span class="l">k8s-zone</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 35</span><span class="cl"><span class="w">    </span><span class="nt">topology</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 36</span><span class="cl"><span class="w">        </span><span class="nt">datacenter</span><span class="p">:</span><span class="w"> </span><span class="l">/cPod-NSXAM-WDC</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 37</span><span class="cl"><span class="w">        </span><span class="nt">computeCluster</span><span class="p">:</span><span class="w"> </span><span class="l">Cluster-2</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 38</span><span class="cl"><span class="w">        </span><span class="nt">networks</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 39</span><span class="cl"><span class="w">            </span>- <span class="l">/cPod-NSXAM-WDC/network/ls-tkg-mgmt</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 40</span><span class="cl"><span class="w">        </span><span class="nt">datastore</span><span class="p">:</span><span class="w"> </span><span class="l">/cPod-NSXAM-WDC/datastore/vsanDatastore-wdc-02</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 41</span><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 42</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">infrastructure.cluster.x-k8s.io/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 43</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">VSphereFailureDomain</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 44</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 45</span><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">wdc-zone-3</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 46</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 47</span><span class="cl"><span class="w">    </span><span class="nt">region</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 48</span><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">wdc-region</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 49</span><span class="cl"><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Datacenter</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 50</span><span class="cl"><span class="w">        </span><span class="nt">tagCategory</span><span class="p">:</span><span class="w"> </span><span class="l">k8s-region</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 51</span><span class="cl"><span class="w">    </span><span class="nt">zone</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 52</span><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">wdc-zone-3</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 53</span><span class="cl"><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">ComputeCluster</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 54</span><span class="cl"><span class="w">        </span><span class="nt">tagCategory</span><span class="p">:</span><span class="w"> </span><span class="l">k8s-zone</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 55</span><span class="cl"><span class="w">    </span><span class="nt">topology</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 56</span><span class="cl"><span class="w">        </span><span class="nt">datacenter</span><span class="p">:</span><span class="w"> </span><span class="l">/cPod-NSXAM-WDC</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 57</span><span class="cl"><span class="w">        </span><span class="nt">computeCluster</span><span class="p">:</span><span class="w"> </span><span class="l">Cluster-3</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 58</span><span class="cl"><span class="w">        </span><span class="nt">networks</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 59</span><span class="cl"><span class="w">            </span>- <span class="l">/cPod-NSXAM-WDC/network/ls-tkg-mgmt</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 60</span><span class="cl"><span class="w">        </span><span class="nt">datastore</span><span class="p">:</span><span class="w"> </span><span class="l">/cPod-NSXAM-WDC/datastore/vsanDatastore-wdc-3</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 61</span><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 62</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">infrastructure.cluster.x-k8s.io/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 63</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">VSphereDeploymentZone</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 64</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 65</span><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">wdc-zone-1</span><span class="w"> </span><span class="c"># A name for the DeploymentZone. Does not have to be the same as above</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 66</span><span class="cl"><span class="w">    </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 67</span><span class="cl"><span class="w">        </span><span class="nt">region</span><span class="p">:</span><span class="w"> </span><span class="l">wdc-region</span><span class="w"> </span><span class="c"># A specific label to be used for placement restriction, allowing flexibility of node placement.</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 68</span><span class="cl"><span class="w">        </span><span class="nt">tkg-cp</span><span class="p">:</span><span class="w"> </span><span class="l">allowed</span><span class="w"> </span><span class="c"># A specific label to be used for placement restriction, allowing flexibility of node placement.</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 69</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 70</span><span class="cl"><span class="w">    </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="l">vcsa.fqdn</span><span class="w"> </span><span class="c"># Specifies the vCenter IP or FQDN</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 71</span><span class="cl"><span class="w">    </span><span class="nt">failureDomain</span><span class="p">:</span><span class="w"> </span><span class="l">wdc-zone-1</span><span class="w"> </span><span class="c"># Calls on the respective vSphereFailureDomain defined above</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 72</span><span class="cl"><span class="w">    </span><span class="nt">placementConstraint</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 73</span><span class="cl"><span class="w">        </span><span class="nt">resourcePool</span><span class="p">:</span><span class="w"> </span><span class="l">/cPod-NSXAM-WDC/host/Cluster-1/Resources</span><span class="w"> </span><span class="c"># Specify which ResourcePool or Cluster directly</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 74</span><span class="cl"><span class="w">        </span><span class="nt">folder</span><span class="p">:</span><span class="w"> </span><span class="l">/cPod-NSXAM-WDC/vm/TKGm</span><span class="w"> </span><span class="c"># Specify which folder in vCenter to use for node placement</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 75</span><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 76</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">infrastructure.cluster.x-k8s.io/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 77</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">VSphereDeploymentZone</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 78</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 79</span><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">wdc-zone-2</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 80</span><span class="cl"><span class="w">    </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 81</span><span class="cl"><span class="w">        </span><span class="nt">region</span><span class="p">:</span><span class="w"> </span><span class="l">wdc-region</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 82</span><span class="cl"><span class="w">        </span><span class="nt">tkg-cp</span><span class="p">:</span><span class="w"> </span><span class="l">allowed</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 83</span><span class="cl"><span class="w">        </span><span class="nt">worker</span><span class="p">:</span><span class="w"> </span><span class="l">allowed</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 84</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 85</span><span class="cl"><span class="w">    </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="l">vcsa.fqdn</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 86</span><span class="cl"><span class="w">    </span><span class="nt">failureDomain</span><span class="p">:</span><span class="w"> </span><span class="l">wdc-zone-2</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 87</span><span class="cl"><span class="w">    </span><span class="nt">placementConstraint</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 88</span><span class="cl"><span class="w">        </span><span class="nt">resourcePool</span><span class="p">:</span><span class="w"> </span><span class="l">/cPod-NSXAM-WDC/host/Cluster-2/Resources</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 89</span><span class="cl"><span class="w">        </span><span class="nt">folder</span><span class="p">:</span><span class="w"> </span><span class="l">/cPod-NSXAM-WDC/vm/TKGm</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 90</span><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 91</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">infrastructure.cluster.x-k8s.io/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 92</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">VSphereDeploymentZone</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 93</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 94</span><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">wdc-zone-3</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 95</span><span class="cl"><span class="w">    </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 96</span><span class="cl"><span class="w">        </span><span class="nt">region</span><span class="p">:</span><span class="w"> </span><span class="l">wdc-region</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 97</span><span class="cl"><span class="w">        </span><span class="nt">tkg-cp</span><span class="p">:</span><span class="w"> </span><span class="l">allowed</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 98</span><span class="cl"><span class="w">        </span><span class="nt">worker</span><span class="p">:</span><span class="w"> </span><span class="l">allowed</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 99</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">100</span><span class="cl"><span class="w">    </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="l">vcsa.fqdn</span><span class="w">
</span></span></span><span class="line"><span class="ln">101</span><span class="cl"><span class="w">    </span><span class="nt">failureDomain</span><span class="p">:</span><span class="w"> </span><span class="l">wdc-zone-3</span><span class="w">
</span></span></span><span class="line"><span class="ln">102</span><span class="cl"><span class="w">    </span><span class="nt">placementConstraint</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">103</span><span class="cl"><span class="w">        </span><span class="nt">resourcePool</span><span class="p">:</span><span class="w"> </span><span class="l">/cPod-NSXAM-WDC/host/Cluster-3/Resources</span><span class="w">
</span></span></span><span class="line"><span class="ln">104</span><span class="cl"><span class="w">        </span><span class="nt">folder</span><span class="p">:</span><span class="w"> </span><span class="l">/cPod-NSXAM-WDC/vm/TKGm</span><span class="w">
</span></span></span></code></pre></div><p>The <em>multi-az</em> yaml file above is now ready to be used deploying my TKG mgmt cluster in a multi-az environment using vSphere Clusters as the Availability Zones.  I have added a label in my multi-az configuration under the vSphereDeploymentZones: <em>tkg-cp: allowed</em>. This custom label is used for the placement of the TKG controlplane nodes. I only want the worker nodes to be placed on AZ-2 and AZ-3 (wdc-zone-2 and wdc-zone-3) where AZ-1 or wdc-zone-1 is only for Control Plane node placement. This is one usecase for the vSphereDeploymentZone, placement constraints. Using these labels to specify the control-plane placement. The worker nodes placement for both TKG management cluster and workload cluster is defined in the bootstrap yaml or the cluster-class manifest for workload cluster.</p>
<h3 id="tkg-bootstrap-yaml---common-for-both-vsphere-cluster-and-drs-host-groups">TKG bootstrap yaml - common for both vSphere cluster and DRS host-groups</h3>
<p>In additon to the regular settings that is needed in the bootstrap yaml file I need to add these lines to take into consideration the Availability zones.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c">#! ---------------------------------------------------------------------</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="c">#! Multi-AZ configuration</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="c">#! ---------------------------------------------------------------------</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w"></span><span class="nt">USE_TOPOLOGY_CATEGORIES</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w"></span><span class="nt">VSPHERE_REGION</span><span class="p">:</span><span class="w"> </span><span class="l">k8s-region</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w"></span><span class="nt">VSPHERE_ZONE</span><span class="p">:</span><span class="w"> </span><span class="l">k8s-zone</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w"></span><span class="nt">VSPHERE_AZ_0</span><span class="p">:</span><span class="w"> </span><span class="l">wdc-zone-2</span><span class="w"> </span><span class="c"># Here I am defining the zone placement for the workers that ends with md-0</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w"></span><span class="nt">VSPHERE_AZ_1</span><span class="p">:</span><span class="w"> </span><span class="l">wdc-zone-3</span><span class="w"> </span><span class="c"># Here I am defining the zone placement for the workers that ends with md-1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w"></span><span class="nt">VSPHERE_AZ_2</span><span class="p">:</span><span class="w"> </span><span class="l">wdc-zone-3</span><span class="w"> </span><span class="c"># Here I am defining the zone placement for the workers that ends with md-2</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w"></span><span class="nt">VSPHERE_AZ_CONTROL_PLANE_MATCHING_LABELS</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;region=wdc-region,tkg-cp=allowed&#34;</span><span class="w"> </span><span class="c">#This defines and uses the vSphereDeploymentsZone labels I have added to instruct the control-plane node placement</span><span class="w">
</span></span></span></code></pre></div><p><strong>Note!</strong> The Zone names under vSphere_AZ_0-2 needs to reflect the correct zone tag/label used in your corresponding multi-az.yaml file pr vSphereDeploymentZone. The same goes for the VSPHERE_AZ_CONTROL_PLANE_MATCHING_LABELS: the values needs to reflect the labels used/added.</p>
<p>Now my full bootstrap.yaml below:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln">  1</span><span class="cl"><span class="c">#! ---------------</span><span class="w">
</span></span></span><span class="line"><span class="ln">  2</span><span class="cl"><span class="w"></span><span class="c">#! Basic config</span><span class="w">
</span></span></span><span class="line"><span class="ln">  3</span><span class="cl"><span class="w"></span><span class="c">#! -------------</span><span class="w">
</span></span></span><span class="line"><span class="ln">  4</span><span class="cl"><span class="w"></span><span class="nt">CLUSTER_NAME</span><span class="p">:</span><span class="w"> </span><span class="l">tkg-wdc-az-mgmt</span><span class="w">
</span></span></span><span class="line"><span class="ln">  5</span><span class="cl"><span class="w"></span><span class="nt">CLUSTER_PLAN</span><span class="p">:</span><span class="w"> </span><span class="l">prod</span><span class="w">
</span></span></span><span class="line"><span class="ln">  6</span><span class="cl"><span class="w"></span><span class="nt">INFRASTRUCTURE_PROVIDER</span><span class="p">:</span><span class="w"> </span><span class="l">vsphere</span><span class="w">
</span></span></span><span class="line"><span class="ln">  7</span><span class="cl"><span class="w"></span><span class="nt">ENABLE_CEIP_PARTICIPATION</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;false&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">  8</span><span class="cl"><span class="w"></span><span class="nt">ENABLE_AUDIT_LOGGING</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;false&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">  9</span><span class="cl"><span class="w"></span><span class="nt">CLUSTER_CIDR</span><span class="p">:</span><span class="w"> </span><span class="m">100.96.0.0</span><span class="l">/11</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 10</span><span class="cl"><span class="w"></span><span class="nt">SERVICE_CIDR</span><span class="p">:</span><span class="w"> </span><span class="m">100.64.0.0</span><span class="l">/13</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 11</span><span class="cl"><span class="w"></span><span class="nt">TKG_IP_FAMILY</span><span class="p">:</span><span class="w"> </span><span class="l">ipv4</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 12</span><span class="cl"><span class="w"></span><span class="nt">DEPLOY_TKG_ON_VSPHERE7</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 13</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 14</span><span class="cl"><span class="w"></span><span class="c">#! ---------------</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 15</span><span class="cl"><span class="w"></span><span class="c">#! vSphere config</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 16</span><span class="cl"><span class="w"></span><span class="c">#! -------------</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 17</span><span class="cl"><span class="w"></span><span class="nt">VSPHERE_DATACENTER</span><span class="p">:</span><span class="w"> </span><span class="l">/cPod-NSXAM-WDC</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 18</span><span class="cl"><span class="w"></span><span class="nt">VSPHERE_DATASTORE</span><span class="p">:</span><span class="w"> </span><span class="l">/cPod-NSXAM-WDC/datastore/vsanDatastore-wdc-01</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 19</span><span class="cl"><span class="w"></span><span class="nt">VSPHERE_FOLDER</span><span class="p">:</span><span class="w"> </span><span class="l">/cPod-NSXAM-WDC/vm/TKGm</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 20</span><span class="cl"><span class="w"></span><span class="nt">VSPHERE_INSECURE</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;false&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 21</span><span class="cl"><span class="w"></span><span class="nt">VSPHERE_NETWORK</span><span class="p">:</span><span class="w"> </span><span class="l">/cPod-NSXAM-WDC/network/ls-tkg-mgmt</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 22</span><span class="cl"><span class="w"></span><span class="nt">VSPHERE_CONTROL_PLANE_ENDPOINT</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 23</span><span class="cl"><span class="w"></span><span class="nt">VSPHERE_PASSWORD</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;password&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 24</span><span class="cl"><span class="w"></span><span class="nt">VSPHERE_RESOURCE_POOL</span><span class="p">:</span><span class="w"> </span><span class="l">/cPod-NSXAM-WDC/host/Cluster-1/Resources</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 25</span><span class="cl"><span class="w"></span><span class="nt">VSPHERE_SERVER</span><span class="p">:</span><span class="w"> </span><span class="l">vcsa.fqdn</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 26</span><span class="cl"><span class="w"></span><span class="nt">VSPHERE_SSH_AUTHORIZED_KEY</span><span class="p">:</span><span class="w"> </span><span class="l">ssh-rsa </span><span class="w">
</span></span></span><span class="line"><span class="ln"> 27</span><span class="cl"><span class="w"></span><span class="nt">VSPHERE_TLS_THUMBPRINT</span><span class="p">:</span><span class="w"> </span><span class="l">F:::::::::E</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 28</span><span class="cl"><span class="w"></span><span class="nt">VSPHERE_USERNAME</span><span class="p">:</span><span class="w"> </span><span class="l">andreasm@vsphereSSOdomain.net</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 29</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 30</span><span class="cl"><span class="w"></span><span class="c">#! ---------------------------------------------------------------------</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 31</span><span class="cl"><span class="w"></span><span class="c">#! Multi-AZ configuration</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 32</span><span class="cl"><span class="w"></span><span class="c">#! ---------------------------------------------------------------------</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 33</span><span class="cl"><span class="w"></span><span class="nt">USE_TOPOLOGY_CATEGORIES</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 34</span><span class="cl"><span class="w"></span><span class="nt">VSPHERE_REGION</span><span class="p">:</span><span class="w"> </span><span class="l">k8s-region</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 35</span><span class="cl"><span class="w"></span><span class="nt">VSPHERE_ZONE</span><span class="p">:</span><span class="w"> </span><span class="l">k8s-zone</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 36</span><span class="cl"><span class="w"></span><span class="nt">VSPHERE_AZ_0</span><span class="p">:</span><span class="w"> </span><span class="l">wdc-zone-2</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 37</span><span class="cl"><span class="w"></span><span class="nt">VSPHERE_AZ_1</span><span class="p">:</span><span class="w"> </span><span class="l">wdc-zone-3</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 38</span><span class="cl"><span class="w"></span><span class="nt">VSPHERE_AZ_2</span><span class="p">:</span><span class="w"> </span><span class="l">wdc-zone-3</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 39</span><span class="cl"><span class="w"></span><span class="nt">VSPHERE_AZ_CONTROL_PLANE_MATCHING_LABELS</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;region=wdc-region,tkg-cp=allowed&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 40</span><span class="cl"><span class="w"></span><span class="nt">AZ_FILE_PATH</span><span class="p">:</span><span class="w"> </span><span class="l">/home/andreasm/tanzu-v-2.3/multi-az/multi-az.yaml</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 41</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 42</span><span class="cl"><span class="w"></span><span class="c">#! ---------------</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 43</span><span class="cl"><span class="w"></span><span class="c">#! Node config</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 44</span><span class="cl"><span class="w"></span><span class="c">#! -------------</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 45</span><span class="cl"><span class="w"></span><span class="nt">OS_ARCH</span><span class="p">:</span><span class="w"> </span><span class="l">amd64</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 46</span><span class="cl"><span class="w"></span><span class="nt">OS_NAME</span><span class="p">:</span><span class="w"> </span><span class="l">ubuntu</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 47</span><span class="cl"><span class="w"></span><span class="nt">OS_VERSION</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;20.04&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 48</span><span class="cl"><span class="w"></span><span class="nt">VSPHERE_CONTROL_PLANE_DISK_GIB</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;20&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 49</span><span class="cl"><span class="w"></span><span class="nt">VSPHERE_CONTROL_PLANE_MEM_MIB</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;4096&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 50</span><span class="cl"><span class="w"></span><span class="nt">VSPHERE_CONTROL_PLANE_NUM_CPUS</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 51</span><span class="cl"><span class="w"></span><span class="nt">VSPHERE_WORKER_DISK_GIB</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;20&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 52</span><span class="cl"><span class="w"></span><span class="nt">VSPHERE_WORKER_MEM_MIB</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;4096&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 53</span><span class="cl"><span class="w"></span><span class="nt">VSPHERE_WORKER_NUM_CPUS</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 54</span><span class="cl"><span class="w"></span><span class="c">#CONTROL_PLANE_MACHINE_COUNT: 3</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 55</span><span class="cl"><span class="w"></span><span class="c">#WORKER_MACHINE_COUNT: 3</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 56</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 57</span><span class="cl"><span class="w"></span><span class="c">#! ---------------</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 58</span><span class="cl"><span class="w"></span><span class="c">#! Avi config</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 59</span><span class="cl"><span class="w"></span><span class="c">#! -------------</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 60</span><span class="cl"><span class="w"></span><span class="nt">AVI_CA_DATA_B64</span><span class="p">:</span><span class="w"> </span><span class="l">BASE64ENC</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 61</span><span class="cl"><span class="w"></span><span class="nt">AVI_CLOUD_NAME</span><span class="p">:</span><span class="w"> </span><span class="l">wdc-1-nsx</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 62</span><span class="cl"><span class="w"></span><span class="nt">AVI_CONTROL_PLANE_HA_PROVIDER</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 63</span><span class="cl"><span class="w"></span><span class="nt">AVI_CONTROLLER</span><span class="p">:</span><span class="w"> </span><span class="m">172.21.101.50</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 64</span><span class="cl"><span class="w"></span><span class="c"># Network used to place workload clusters&#39; endpoint VIPs</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 65</span><span class="cl"><span class="w"></span><span class="nt">AVI_CONTROL_PLANE_NETWORK</span><span class="p">:</span><span class="w"> </span><span class="l">vip-tkg-wld-l4</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 66</span><span class="cl"><span class="w"></span><span class="nt">AVI_CONTROL_PLANE_NETWORK_CIDR</span><span class="p">:</span><span class="w"> </span><span class="m">10.101.114.0</span><span class="l">/24</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 67</span><span class="cl"><span class="w"></span><span class="c"># Network used to place workload clusters&#39; services external IPs (load balancer &amp; ingress services)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 68</span><span class="cl"><span class="w"></span><span class="nt">AVI_DATA_NETWORK</span><span class="p">:</span><span class="w"> </span><span class="l">vip-tkg-wld-l7</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 69</span><span class="cl"><span class="w"></span><span class="nt">AVI_DATA_NETWORK_CIDR</span><span class="p">:</span><span class="w"> </span><span class="m">10.101.115.0</span><span class="l">/24</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 70</span><span class="cl"><span class="w"></span><span class="c"># Network used to place management clusters&#39; services external IPs (load balancer &amp; ingress services)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 71</span><span class="cl"><span class="w"></span><span class="nt">AVI_MANAGEMENT_CLUSTER_VIP_NETWORK_CIDR</span><span class="p">:</span><span class="w"> </span><span class="m">10.101.113.0</span><span class="l">/24</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 72</span><span class="cl"><span class="w"></span><span class="nt">AVI_MANAGEMENT_CLUSTER_VIP_NETWORK_NAME</span><span class="p">:</span><span class="w"> </span><span class="l">vip-tkg-mgmt-l7</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 73</span><span class="cl"><span class="w"></span><span class="c"># Network used to place management clusters&#39; endpoint VIPs</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 74</span><span class="cl"><span class="w"></span><span class="nt">AVI_MANAGEMENT_CLUSTER_CONTROL_PLANE_VIP_NETWORK_NAME</span><span class="p">:</span><span class="w"> </span><span class="l">vip-tkg-mgmt-l4</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 75</span><span class="cl"><span class="w"></span><span class="nt">AVI_MANAGEMENT_CLUSTER_CONTROL_PLANE_VIP_NETWORK_CIDR</span><span class="p">:</span><span class="w"> </span><span class="m">10.101.112.0</span><span class="l">/24</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 76</span><span class="cl"><span class="w"></span><span class="nt">AVI_NSXT_T1LR</span><span class="p">:</span><span class="w"> </span><span class="l">Tier-1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 77</span><span class="cl"><span class="w"></span><span class="nt">AVI_CONTROLLER_VERSION</span><span class="p">:</span><span class="w"> </span><span class="m">22.1.2</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 78</span><span class="cl"><span class="w"></span><span class="nt">AVI_ENABLE</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 79</span><span class="cl"><span class="w"></span><span class="nt">AVI_LABELS</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 80</span><span class="cl"><span class="w"></span><span class="nt">AVI_PASSWORD</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;password&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 81</span><span class="cl"><span class="w"></span><span class="nt">AVI_SERVICE_ENGINE_GROUP</span><span class="p">:</span><span class="w"> </span><span class="l">nsx-se-generic-group</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 82</span><span class="cl"><span class="w"></span><span class="nt">AVI_MANAGEMENT_CLUSTER_SERVICE_ENGINE_GROUP</span><span class="p">:</span><span class="w"> </span><span class="l">nsx-se-generic-group</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 83</span><span class="cl"><span class="w"></span><span class="nt">AVI_USERNAME</span><span class="p">:</span><span class="w"> </span><span class="l">admin</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 84</span><span class="cl"><span class="w"></span><span class="nt">AVI_DISABLE_STATIC_ROUTE_SYNC</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 85</span><span class="cl"><span class="w"></span><span class="nt">AVI_INGRESS_DEFAULT_INGRESS_CONTROLLER</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 86</span><span class="cl"><span class="w"></span><span class="nt">AVI_INGRESS_SHARD_VS_SIZE</span><span class="p">:</span><span class="w"> </span><span class="l">SMALL</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 87</span><span class="cl"><span class="w"></span><span class="nt">AVI_INGRESS_SERVICE_TYPE</span><span class="p">:</span><span class="w"> </span><span class="l">NodePortLocal</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 88</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 89</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 90</span><span class="cl"><span class="w"></span><span class="c">#! ---------------</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 91</span><span class="cl"><span class="w"></span><span class="c">#! Proxy config</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 92</span><span class="cl"><span class="w"></span><span class="c">#! -------------</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 93</span><span class="cl"><span class="w"></span><span class="nt">TKG_HTTP_PROXY_ENABLED</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;false&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 94</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 95</span><span class="cl"><span class="w"></span><span class="c">#! ---------------------------------------------------------------------</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 96</span><span class="cl"><span class="w"></span><span class="c">#! Antrea CNI configuration</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 97</span><span class="cl"><span class="w"></span><span class="c">#! ---------------------------------------------------------------------</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 98</span><span class="cl"><span class="w"></span><span class="nt">ANTREA_NODEPORTLOCAL</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 99</span><span class="cl"><span class="w"></span><span class="nt">ANTREA_PROXY</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="ln">100</span><span class="cl"><span class="w"></span><span class="nt">ANTREA_ENDPOINTSLICE</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="ln">101</span><span class="cl"><span class="w"></span><span class="nt">ANTREA_POLICY</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="ln">102</span><span class="cl"><span class="w"></span><span class="nt">ANTREA_TRACEFLOW</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="ln">103</span><span class="cl"><span class="w"></span><span class="nt">ANTREA_NETWORKPOLICY_STATS</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="ln">104</span><span class="cl"><span class="w"></span><span class="nt">ANTREA_EGRESS</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="ln">105</span><span class="cl"><span class="w"></span><span class="nt">ANTREA_IPAM</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="ln">106</span><span class="cl"><span class="w"></span><span class="nt">ANTREA_FLOWEXPORTER</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="ln">107</span><span class="cl"><span class="w"></span><span class="nt">ANTREA_SERVICE_EXTERNALIP</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="ln">108</span><span class="cl"><span class="w"></span><span class="nt">ANTREA_MULTICAST</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="ln">109</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">110</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">111</span><span class="cl"><span class="w"></span><span class="c">#! ---------------------------------------------------------------------</span><span class="w">
</span></span></span><span class="line"><span class="ln">112</span><span class="cl"><span class="w"></span><span class="c">#! Machine Health Check configuration</span><span class="w">
</span></span></span><span class="line"><span class="ln">113</span><span class="cl"><span class="w"></span><span class="c">#! ---------------------------------------------------------------------</span><span class="w">
</span></span></span><span class="line"><span class="ln">114</span><span class="cl"><span class="w"></span><span class="nt">ENABLE_MHC</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">115</span><span class="cl"><span class="w"></span><span class="nt">ENABLE_MHC_CONTROL_PLANE</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="ln">116</span><span class="cl"><span class="w"></span><span class="nt">ENABLE_MHC_WORKER_NODE</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="ln">117</span><span class="cl"><span class="w"></span><span class="nt">MHC_UNKNOWN_STATUS_TIMEOUT</span><span class="p">:</span><span class="w"> </span><span class="l">5m</span><span class="w">
</span></span></span><span class="line"><span class="ln">118</span><span class="cl"><span class="w"></span><span class="nt">MHC_FALSE_STATUS_TIMEOUT</span><span class="p">:</span><span class="w"> </span><span class="l">12m</span><span class="w">
</span></span></span></code></pre></div><p>One last thing to do before heading over to the actual deployment is to add the following to my current Linux jumphost session:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@tkg-bootstrap:~$ <span class="nb">export</span> <span class="nv">SKIP_MULTI_AZ_VERIFY</span><span class="o">=</span><span class="s2">&#34;true&#34;</span>
</span></span></code></pre></div><p>This is needed as there is no mgmt cluster yet, and there is no way for anything that's not there to verify anything &#x1f63a;</p>
<h2 id="tkg-deployment">TKG Deployment</h2>
<p>Now that I have done all the needed preparations it is time to do the actual deployment and see if my Availability Zones are being used as I wanted. When the TKG management cluster has been deployed I should end up with all the Control Plane (3) nodes distributed across all my 3 AZs. Then the worker nodes should only be placed in the AZ-2 and AZ-3.</p>
<h3 id="tkg-mgmt-cluster-deployment-with-multi-availability-zones">TKG Mgmt Cluster deployment with multi-availability-zones</h3>
<p>From my Linux jumphost where I have all the CLI tools in place I am now ready to execute the following command to deploy the mgmt cluster. 3 Control Plane Nodes and 3 Worker Nodes.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@tkg-bootstrap:~$ tanzu mc create -f my-tkg-mgmt-bootstrap.yaml --az-file my-multi-az-file.yaml
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">Validating the pre-requisites...
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">vSphere <span class="m">8</span> with Tanzu Detected.
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">You have connected to a vSphere <span class="m">8</span> with Tanzu environment that includes an integrated Tanzu Kubernetes Grid Service which
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">turns a vSphere cluster into a platform <span class="k">for</span> running Kubernetes workloads in dedicated resource pools. Configuring Tanzu
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">Kubernetes Grid Service is <span class="k">done</span> through the vSphere HTML5 Client.
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">Tanzu Kubernetes Grid Service is the preferred way to consume Tanzu Kubernetes Grid in vSphere <span class="m">8</span> environments. Alternatively you may
</span></span><span class="line"><span class="ln">10</span><span class="cl">deploy a non-integrated Tanzu Kubernetes Grid instance on vSphere 8.
</span></span><span class="line"><span class="ln">11</span><span class="cl">Deploying TKG management cluster on vSphere <span class="m">8</span> ...
</span></span><span class="line"><span class="ln">12</span><span class="cl">Identity Provider not configured. Some authentication features won<span class="err">&#39;</span>t work.
</span></span><span class="line"><span class="ln">13</span><span class="cl">Using default value <span class="k">for</span> <span class="nv">CONTROL_PLANE_MACHINE_COUNT</span> <span class="o">=</span> 3. Reason: CONTROL_PLANE_MACHINE_COUNT variable is not <span class="nb">set</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">Using default value <span class="k">for</span> <span class="nv">WORKER_MACHINE_COUNT</span> <span class="o">=</span> 3. Reason: WORKER_MACHINE_COUNT variable is not <span class="nb">set</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">
</span></span><span class="line"><span class="ln">16</span><span class="cl">Setting up management cluster...
</span></span><span class="line"><span class="ln">17</span><span class="cl">Validating configuration...
</span></span><span class="line"><span class="ln">18</span><span class="cl">Using infrastructure provider vsphere:v1.7.0
</span></span><span class="line"><span class="ln">19</span><span class="cl">Generating cluster configuration...
</span></span><span class="line"><span class="ln">20</span><span class="cl">Setting up bootstrapper...
</span></span></code></pre></div><p>Sit back and enjoy while the kind cluster is being deployed locally and hopefully provisioned in your vCenter server..</p>
<p>When you see the below: <em>Start creating management cluster</em> something should start to happen in the vCenter server.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">Management cluster config file has been generated and stored at: <span class="s1">&#39;/home/andreasm/.config/tanzu/tkg/clusterconfigs/tkg-wdc-az-mgmt.yaml&#39;</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">Start creating management cluster...
</span></span></code></pre></div><p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="tkg-vms-deploying"
      
        class="image_figure image_internal image_processed"
        width="2714"
        height="1042"
        src="/2023/08/29/tkg-2.3-deployment-in-multiple-availability-zones/images/image-20230830123219285.png"
      
      
    />

    </picture>
</figure>
</p>
<p>And by just clicking on the respective TKG VM so far I can see that they are respecting my zone placement.</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="worker-md-2"
      
        class="image_figure image_internal image_processed"
        width="2936"
        height="292"
        src="/2023/08/29/tkg-2.3-deployment-in-multiple-availability-zones/images/image-20230830123436090.png"
      
      
    />

    </picture>
</figure>
</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="worker-md-1"
      
        class="image_figure image_internal image_processed"
        width="2880"
        height="270"
        src="/2023/08/29/tkg-2.3-deployment-in-multiple-availability-zones/images/image-20230830123509547.png"
      
      
    />

    </picture>
</figure>
</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="worker-md-0"
      
        class="image_figure image_internal image_processed"
        width="2868"
        height="270"
        src="/2023/08/29/tkg-2.3-deployment-in-multiple-availability-zones/images/image-20230830123543531.png"
      
      
    />

    </picture>
</figure>
</p>
<p>That is very well. Now just wait for the two last control plane nodes also.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">You can now access the management cluster tkg-wdc-az-mgmt by running <span class="s1">&#39;kubectl config use-context tkg-wdc-az-mgmt-admin@tkg-wdc-az-mgmt&#39;</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">Management cluster created!
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">You can now create your first workload cluster by running the following:
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">  tanzu cluster create <span class="o">[</span>name<span class="o">]</span> -f <span class="o">[</span>file<span class="o">]</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">
</span></span><span class="line"><span class="ln">10</span><span class="cl">
</span></span><span class="line"><span class="ln">11</span><span class="cl">Some addons might be getting installed! Check their status by running the following:
</span></span><span class="line"><span class="ln">12</span><span class="cl">
</span></span><span class="line"><span class="ln">13</span><span class="cl">  kubectl get apps -A
</span></span></code></pre></div><p>Exciting, lets have a look at the control plane nodes placement:</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="tkg-cp-1"
      
        class="image_figure image_internal image_processed"
        width="2842"
        height="316"
        src="/2023/08/29/tkg-2.3-deployment-in-multiple-availability-zones/images/image-20230830125444962.png"
      
      
    />

    </picture>
</figure>
</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="tkg-cp-2"
      
        class="image_figure image_internal image_processed"
        width="2848"
        height="306"
        src="/2023/08/29/tkg-2.3-deployment-in-multiple-availability-zones/images/image-20230830125515241.png"
      
      
    />

    </picture>
</figure>
</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="tkg-cp-3"
      
        class="image_figure image_internal image_processed"
        width="2838"
        height="312"
        src="/2023/08/29/tkg-2.3-deployment-in-multiple-availability-zones/images/image-20230830125539285.png"
      
      
    />

    </picture>
</figure>
</p>
<p>They have been distributed across my three cluster as wanted. Perfect.</p>
<p>Now next step is to deploy a workload cluster to achieve the same placement constraints there.</p>
<h3 id="adding-or-adjusting-the-vspherefailuredomains-and-vspheredeploymentzone">Adding or adjusting the vSphereFailureDomains and vSphereDeploymentZone</h3>
<p>In my TKG management cluster deployment above I have used the vSphereFailureDomains and vSphereDeploymentZones for vSphere clusters as my availability zones. If I want to have workload clusters deployed in other availability zones, different zones or even new zones I can add these to the management cluster. In the example below I will add the availability zones configured to use vCenter DRS host-groups using the vsphere-zones yaml config <a href="/2023/08/29/tkg-2.3-deployment-in-multiple-availability-zones/#tkg-multi-az-config-file---using-vcenter-drs-host-groups">here</a>.</p>
<p>To check which zones are available  for the management cluster:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1"># vSphereFailureDomains</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">andreasm@tkg-bootstrap:~$ k get vspherefailuredomains.infrastructure.cluster.x-k8s.io -A
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">NAME         AGE
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">wdc-zone-1   24h
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">wdc-zone-2   24h
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">wdc-zone-3   24h
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="c1"># vSphereDeploymentZones</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">andreasm@tkg-bootstrap:~$ k get vspheredeploymentzones.infrastructure.cluster.x-k8s.io -A
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">NAME         AGE
</span></span><span class="line"><span class="ln">10</span><span class="cl">wdc-zone-1   24h
</span></span><span class="line"><span class="ln">11</span><span class="cl">wdc-zone-2   24h
</span></span><span class="line"><span class="ln">12</span><span class="cl">wdc-zone-3   24h
</span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="c1"># I have defined both FailureDomains and DeploymentsZone with the same name</span>
</span></span></code></pre></div><p>Now, let me add the DRS host-groups zones.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@tkg-bootstrap:~$ kubectl apply -f multi-az-host-groups.yaml <span class="c1">#The file containing host-groups definition</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">vspherefailuredomain.infrastructure.cluster.x-k8s.io/rack1 created
</span></span><span class="line"><span class="ln">3</span><span class="cl">vspherefailuredomain.infrastructure.cluster.x-k8s.io/rack2 created
</span></span><span class="line"><span class="ln">4</span><span class="cl">vspheredeploymentzone.infrastructure.cluster.x-k8s.io/rack1 created
</span></span><span class="line"><span class="ln">5</span><span class="cl">vspheredeploymentzone.infrastructure.cluster.x-k8s.io/rack2 created
</span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="c1"># Or</span>
</span></span><span class="line"><span class="ln">7</span><span class="cl">andreasm@tkg-bootstrap:~$ tanzu mc az <span class="nb">set</span> -f multi-az-host-groups.yaml
</span></span><span class="line"><span class="ln">8</span><span class="cl"><span class="c1"># This command actually validate the settings if the export SKIP_MULTI_AZ_VERIFY=&#34;true&#34; is not set ofcourse</span>
</span></span></code></pre></div><p>Now check the failuredomains and placementzones:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@tkg-bootstrap:~$ k get vspherefailuredomains.infrastructure.cluster.x-k8s.io -A
</span></span><span class="line"><span class="ln">2</span><span class="cl">NAME         AGE
</span></span><span class="line"><span class="ln">3</span><span class="cl">rack1        13s
</span></span><span class="line"><span class="ln">4</span><span class="cl">rack2        13s
</span></span><span class="line"><span class="ln">5</span><span class="cl">wdc-zone-1   24h
</span></span><span class="line"><span class="ln">6</span><span class="cl">wdc-zone-2   24h
</span></span><span class="line"><span class="ln">7</span><span class="cl">wdc-zone-3   24h
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@tkg-bootstrap:~$ k get vspheredeploymentzones.infrastructure.cluster.x-k8s.io -A
</span></span><span class="line"><span class="ln">2</span><span class="cl">NAME         AGE
</span></span><span class="line"><span class="ln">3</span><span class="cl">rack1        2m44s
</span></span><span class="line"><span class="ln">4</span><span class="cl">rack2        2m44s
</span></span><span class="line"><span class="ln">5</span><span class="cl">wdc-zone-1   24h
</span></span><span class="line"><span class="ln">6</span><span class="cl">wdc-zone-2   24h
</span></span><span class="line"><span class="ln">7</span><span class="cl">wdc-zone-3   24h
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@tkg-bootstrap:~$ tanzu mc available-zone list -a
</span></span><span class="line"><span class="ln">2</span><span class="cl">  AZNAME      ZONENAME    ZONETYPE        REGIONNAME  REGIONTYPE      DATASTORE                                       NETWORK                              OWNERCLUSTER   STATUS
</span></span><span class="line"><span class="ln">3</span><span class="cl">  rack1       rack1       HostGroup       room1       ComputeCluster  /cPod-NSXAM-WDC/datastore/vsanDatastore-wdc-01  /cPod-NSXAM-WDC/network/ls-tkg-mgmt                 not ready
</span></span><span class="line"><span class="ln">4</span><span class="cl">  rack2       rack2       HostGroup       room1       ComputeCluster  /cPod-NSXAM-WDC/datastore/vsanDatastore-wdc-01  /cPod-NSXAM-WDC/network/ls-tkg-mgmt                 not ready
</span></span><span class="line"><span class="ln">5</span><span class="cl">  wdc-zone-1  wdc-zone-1  ComputeCluster  wdc-region  Datacenter      /cPod-NSXAM-WDC/datastore/vsanDatastore-wdc-01  /cPod-NSXAM-WDC/network/ls-tkg-mgmt                 ready
</span></span><span class="line"><span class="ln">6</span><span class="cl">  wdc-zone-2  wdc-zone-2  ComputeCluster  wdc-region  Datacenter      /cPod-NSXAM-WDC/datastore/vsanDatastore-wdc-02  /cPod-NSXAM-WDC/network/ls-tkg-mgmt  tkg-cluster-1  ready
</span></span><span class="line"><span class="ln">7</span><span class="cl">  wdc-zone-3  wdc-zone-3  ComputeCluster  wdc-region  Datacenter      /cPod-NSXAM-WDC/datastore/vsanDatastore-wdc-3   /cPod-NSXAM-WDC/network/ls-tkg-mgmt  tkg-cluster-1  ready
</span></span></code></pre></div><p>I had the variable <em>export SKIP_MULTI_AZ_VERIFY=&quot;true&quot;</em> set so it did not validate my settings and just applied it. Therefore I have the two new zones/AZs in a not ready state. Deleting them, updated the config so it was correct. Sat the <em>export SKIP_MULTI_AZ_VERIFY=&quot;false&quot;</em>. Reapplied using the mc set command it came out ready:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@tkg-bootstrap:~$ tanzu mc az <span class="nb">set</span> -f multi-az-host-groups.yaml
</span></span><span class="line"><span class="ln">2</span><span class="cl">andreasm@tkg-bootstrap:~$ tanzu mc available-zone list -a
</span></span><span class="line"><span class="ln">3</span><span class="cl">  AZNAME      ZONENAME    ZONETYPE        REGIONNAME  REGIONTYPE      DATASTORE                                       NETWORK                              OWNERCLUSTER   STATUS
</span></span><span class="line"><span class="ln">4</span><span class="cl">  rack1       rack1       HostGroup       room1       ComputeCluster  /cPod-NSXAM-WDC/datastore/vsanDatastore-wdc-3   /cPod-NSXAM-WDC/network/ls-tkg-mgmt                 ready
</span></span><span class="line"><span class="ln">5</span><span class="cl">  rack2       rack2       HostGroup       room1       ComputeCluster  /cPod-NSXAM-WDC/datastore/vsanDatastore-wdc-3   /cPod-NSXAM-WDC/network/ls-tkg-mgmt                 ready
</span></span><span class="line"><span class="ln">6</span><span class="cl">  wdc-zone-1  wdc-zone-1  ComputeCluster  wdc-region  Datacenter      /cPod-NSXAM-WDC/datastore/vsanDatastore-wdc-01  /cPod-NSXAM-WDC/network/ls-tkg-mgmt                 ready
</span></span><span class="line"><span class="ln">7</span><span class="cl">  wdc-zone-2  wdc-zone-2  ComputeCluster  wdc-region  Datacenter      /cPod-NSXAM-WDC/datastore/vsanDatastore-wdc-02  /cPod-NSXAM-WDC/network/ls-tkg-mgmt  tkg-cluster-1  ready
</span></span><span class="line"><span class="ln">8</span><span class="cl">  wdc-zone-3  wdc-zone-3  ComputeCluster  wdc-region  Datacenter      /cPod-NSXAM-WDC/datastore/vsanDatastore-wdc-3   /cPod-NSXAM-WDC/network/ls-tkg-mgmt  tkg-cluster-1  ready
</span></span></code></pre></div><h3 id="tkg-workload-cluster-deployment-with-multi-availability-zones---using-vsphere-clusters-as-azs">TKG Workload Cluster deployment with multi-availability-zones - using vSphere clusters as AZs</h3>
<p>At this stage I will use the values already provided earlier, like the multi-az config, network, vCenter folder placements and so on. If I like I could have added a specific multi-az file for the workload cluster, changed the network settings, folder etc. But I am just using the config already in place from the management cluster for now.</p>
<p>We have already done the hard work. So the workload cluster deployment is now more or less walk in the park. To generate the necessary workload-cluster yaml definition I execute the following command (<em>this will accommodate the necessary AZs setting, so if you already have a class-based cluster yaml file from previous TKG clusters make sure to add this or just run the command below</em>):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@tkg-bootstrap:~$ tanzu cluster create tkg-cluster-1 --namespace tkg-ns-1 --file tkg-mgmt-bootstrap-for-wld.az.yaml --dry-run &gt; workload-cluster/tkg-cluster-1.yaml
</span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="c1"># tanzu cluster create tkg-cluster-1 gives the cluster the name tkg-cluster-1</span>
</span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="c1"># --namespace is the namespace I have created in my management cluster to place this workload cluster in</span>
</span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="c1"># --file points to the bootstrap.yaml file used to deploy the management cluster</span>
</span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="c1"># --dry-run &gt; generates my workload-cluster.yaml file called tkg-cluster-1.yaml under the folder workload-cluster</span>
</span></span></code></pre></div><p>This process convert the flat bootstrap.yaml file to a cluster-class config-file.</p>
<p>The most interesting part in this file is whether the placement constraints have been considered. Lets have a look:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">controlPlane</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">      </span><span class="nt">value</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">        </span><span class="nt">machine</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">          </span><span class="nt">diskGiB</span><span class="p">:</span><span class="w"> </span><span class="m">20</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">          </span><span class="nt">memoryMiB</span><span class="p">:</span><span class="w"> </span><span class="m">4096</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">          </span><span class="nt">numCPUs</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">worker</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">      </span><span class="nt">value</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">        </span><span class="nt">machine</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">          </span><span class="nt">diskGiB</span><span class="p">:</span><span class="w"> </span><span class="m">20</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">          </span><span class="nt">memoryMiB</span><span class="p">:</span><span class="w"> </span><span class="m">4096</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">          </span><span class="nt">numCPUs</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">controlPlaneZoneMatchingLabels</span><span class="w"> </span><span class="c"># check</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">      </span><span class="nt">value</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">        </span><span class="nt">region</span><span class="p">:</span><span class="w"> </span><span class="l">k8s-region</span><span class="w"> </span><span class="c"># check - will place my control planes only in the zones with the correct label</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">        </span><span class="nt">tkg-cp</span><span class="p">:</span><span class="w"> </span><span class="l">allowed</span><span class="w"> </span><span class="c"># check - will place my control planes only in the zones with the correct label</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">security</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">      </span><span class="nt">value</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">        </span><span class="nt">fileIntegrityMonitoring</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">          </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">        </span><span class="nt">imagePolicy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">          </span><span class="nt">pullAlways</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">          </span><span class="nt">webhook</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">            </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">            </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w">              </span><span class="nt">allowTTL</span><span class="p">:</span><span class="w"> </span><span class="m">50</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w">              </span><span class="nt">defaultAllow</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w">              </span><span class="nt">denyTTL</span><span class="p">:</span><span class="w"> </span><span class="m">60</span><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">              </span><span class="nt">retryBackoff</span><span class="p">:</span><span class="w"> </span><span class="m">500</span><span class="w">
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w">        </span><span class="nt">kubeletOptions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="w">          </span><span class="nt">eventQPS</span><span class="p">:</span><span class="w"> </span><span class="m">50</span><span class="w">
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="w">          </span><span class="nt">streamConnectionIdleTimeout</span><span class="p">:</span><span class="w"> </span><span class="l">4h0m0s</span><span class="w">
</span></span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="w">        </span><span class="nt">systemCryptoPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="w">    </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l">v1.26.5+vmware.2-tkg.1</span><span class="w">
</span></span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="w">    </span><span class="nt">workers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">36</span><span class="cl"><span class="w">      </span><span class="nt">machineDeployments</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">37</span><span class="cl"><span class="w">      </span>- <span class="nt">class</span><span class="p">:</span><span class="w"> </span><span class="l">tkg-worker</span><span class="w">
</span></span></span><span class="line"><span class="ln">38</span><span class="cl"><span class="w">        </span><span class="nt">failureDomain</span><span class="p">:</span><span class="w"> </span><span class="l">wdc-zone-2</span><span class="w"> </span><span class="c"># check - worker in zone-2</span><span class="w">
</span></span></span><span class="line"><span class="ln">39</span><span class="cl"><span class="w">        </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">40</span><span class="cl"><span class="w">          </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">41</span><span class="cl"><span class="w">            </span><span class="nt">run.tanzu.vmware.com/resolve-os-image</span><span class="p">:</span><span class="w"> </span><span class="l">image-type=ova,os-name=ubuntu</span><span class="w">
</span></span></span><span class="line"><span class="ln">42</span><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">md-0</span><span class="w">
</span></span></span><span class="line"><span class="ln">43</span><span class="cl"><span class="w">        </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="ln">44</span><span class="cl"><span class="w">        </span><span class="nt">strategy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">45</span><span class="cl"><span class="w">          </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">RollingUpdate</span><span class="w">
</span></span></span><span class="line"><span class="ln">46</span><span class="cl"><span class="w">      </span>- <span class="nt">class</span><span class="p">:</span><span class="w"> </span><span class="l">tkg-worker</span><span class="w">
</span></span></span><span class="line"><span class="ln">47</span><span class="cl"><span class="w">        </span><span class="nt">failureDomain</span><span class="p">:</span><span class="w"> </span><span class="l">wdc-zone-3</span><span class="w"> </span><span class="c"># check - worker in zone-3</span><span class="w">
</span></span></span><span class="line"><span class="ln">48</span><span class="cl"><span class="w">        </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">49</span><span class="cl"><span class="w">          </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">50</span><span class="cl"><span class="w">            </span><span class="nt">run.tanzu.vmware.com/resolve-os-image</span><span class="p">:</span><span class="w"> </span><span class="l">image-type=ova,os-name=ubuntu</span><span class="w">
</span></span></span><span class="line"><span class="ln">51</span><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">md-1</span><span class="w">
</span></span></span><span class="line"><span class="ln">52</span><span class="cl"><span class="w">        </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="ln">53</span><span class="cl"><span class="w">        </span><span class="nt">strategy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">54</span><span class="cl"><span class="w">          </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">RollingUpdate</span><span class="w">
</span></span></span><span class="line"><span class="ln">55</span><span class="cl"><span class="w">      </span>- <span class="nt">class</span><span class="p">:</span><span class="w"> </span><span class="l">tkg-worker</span><span class="w">
</span></span></span><span class="line"><span class="ln">56</span><span class="cl"><span class="w">        </span><span class="nt">failureDomain</span><span class="p">:</span><span class="w"> </span><span class="l">wdc-zone-3</span><span class="w"> </span><span class="c"># check - worker in zone-3</span><span class="w">
</span></span></span><span class="line"><span class="ln">57</span><span class="cl"><span class="w">        </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">58</span><span class="cl"><span class="w">          </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">59</span><span class="cl"><span class="w">            </span><span class="nt">run.tanzu.vmware.com/resolve-os-image</span><span class="p">:</span><span class="w"> </span><span class="l">image-type=ova,os-name=ubuntu</span><span class="w">
</span></span></span><span class="line"><span class="ln">60</span><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">md-2</span><span class="w">
</span></span></span><span class="line"><span class="ln">61</span><span class="cl"><span class="w">        </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="ln">62</span><span class="cl"><span class="w">        </span><span class="nt">strategy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">63</span><span class="cl"><span class="w">          </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">RollingUpdate</span><span class="w">
</span></span></span></code></pre></div><p>The file  looks good. Lets deploy it.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@tkg-bootstrap:~$ tanzu cluster create --file tkg-cluster-1.yaml
</span></span><span class="line"><span class="ln">2</span><span class="cl">Validating configuration...
</span></span><span class="line"><span class="ln">3</span><span class="cl">cluster class based input file detected, getting tkr version from input yaml
</span></span><span class="line"><span class="ln">4</span><span class="cl">input TKR Version: v1.26.5+vmware.2-tkg.1
</span></span><span class="line"><span class="ln">5</span><span class="cl">TKR Version v1.26.5+vmware.2-tkg.1, Kubernetes Version v1.26.5+vmware.2-tkg.1 configured
</span></span><span class="line"><span class="ln">6</span><span class="cl">Warning: Pinniped configuration not found<span class="p">;</span> Authentication via Pinniped will not be <span class="nb">set</span> up in this cluster. If you wish to <span class="nb">set</span> up Pinniped after the cluster is created, please refer to the documentation.
</span></span><span class="line"><span class="ln">7</span><span class="cl">Skip checking VIP overlap when the VIP is empty. Cluster<span class="s1">&#39;s endpoint VIP will be allocated by NSX ALB IPAM.
</span></span></span><span class="line"><span class="ln">8</span><span class="cl"><span class="s1">creating workload cluster &#39;</span>tkg-cluster-1<span class="err">&#39;</span>...
</span></span></code></pre></div><p>After a couple of minutes or cups of coffee (depends on your environment):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">Workload cluster <span class="s1">&#39;tkg-cluster-1&#39;</span> created
</span></span></code></pre></div><p>Now lets go the same with the nodes here also, where are they placed in my vSphere environment.</p>
<p>Control plane nodes placement:</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="tkg-wld-cp-1"
      
        class="image_figure image_internal image_processed"
        width="2816"
        height="366"
        src="/2023/08/29/tkg-2.3-deployment-in-multiple-availability-zones/images/image-20230830145333591.png"
      
      
    />

    </picture>
</figure>
</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="tkg-wld-cp-2"
      
        class="image_figure image_internal image_processed"
        width="2842"
        height="370"
        src="/2023/08/29/tkg-2.3-deployment-in-multiple-availability-zones/images/image-20230830145408244.png"
      
      
    />

    </picture>
</figure>
</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="tkg-wld-cp-3"
      
        class="image_figure image_internal image_processed"
        width="2882"
        height="356"
        src="/2023/08/29/tkg-2.3-deployment-in-multiple-availability-zones/images/image-20230830145444962.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Worker nodes placemement:</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="tkg-wld-worker-1"
      
        class="image_figure image_internal image_processed"
        width="2852"
        height="328"
        src="/2023/08/29/tkg-2.3-deployment-in-multiple-availability-zones/images/image-20230830145556003.png"
      
      
    />

    </picture>
</figure>
</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="tkg-wld-worker-2"
      
        class="image_figure image_internal image_processed"
        width="2840"
        height="370"
        src="/2023/08/29/tkg-2.3-deployment-in-multiple-availability-zones/images/image-20230830145626914.png"
      
      
    />

    </picture>
</figure>
</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="tkg-wld-worker-3"
      
        class="image_figure image_internal image_processed"
        width="2822"
        height="376"
        src="/2023/08/29/tkg-2.3-deployment-in-multiple-availability-zones/images/image-20230830145655861.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Nice, just according to plan.</p>
<h3 id="tkg-workload-cluster-deployment-with-multi-availability-zones---using-vcenter-host-groups-as-azs">TKG Workload Cluster deployment with multi-availability-zones - using vCenter host-groups as AZs</h3>
<p>In the first workload cluster deployment above I deployed the cluster to use my availability zones configured to use vSphere clusters as AZs. Now I will deploy a second workload cluster using the zones <a href="/2023/08/29/tkg-2.3-deployment-in-multiple-availability-zones/#tkg-multi-az-config-file---using-vcenter-drs-host-groups">here</a> added after the TKG management cluster was deployed. I will just reuse the workload-cluster.yaml from the first cluster, edit the names, namespaces and zones/regions accordingly.</p>
<p>Lets deploy it:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">andreasm@tkg-bootstrap:~$ tanzu cluster create --file tkg-cluster-2-host-groups.yaml
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">Validating configuration...
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">cluster class based input file detected, getting tkr version from input yaml
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">input TKR Version: v1.26.5+vmware.2-tkg.1
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">TKR Version v1.26.5+vmware.2-tkg.1, Kubernetes Version v1.26.5+vmware.2-tkg.1 configured
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">Warning: Pinniped configuration not found<span class="p">;</span> Authentication via Pinniped will not be <span class="nb">set</span> up in this cluster. If you wish to <span class="nb">set</span> up Pinniped after the cluster is created, please refer to the documentation.
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">Skip checking VIP overlap when the VIP is empty. Clusters endpoint VIP will be allocated by NSX ALB IPAM.
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">creating workload cluster <span class="s1">&#39;tkg-cluster-2-hostgroup&#39;</span>...
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">waiting <span class="k">for</span> cluster to be initialized...
</span></span><span class="line"><span class="ln">10</span><span class="cl">cluster control plane is still being initialized: ScalingUp
</span></span><span class="line"><span class="ln">11</span><span class="cl">waiting <span class="k">for</span> cluster nodes to be available...
</span></span><span class="line"><span class="ln">12</span><span class="cl">unable to get the autoscaler deployment, maybe it is not exist
</span></span><span class="line"><span class="ln">13</span><span class="cl">waiting <span class="k">for</span> addons core packages installation...
</span></span><span class="line"><span class="ln">14</span><span class="cl">
</span></span><span class="line"><span class="ln">15</span><span class="cl">Workload cluster <span class="s1">&#39;tkg-cluster-2-hostgroup&#39;</span> created
</span></span></code></pre></div><p>This cluster should now only be deployed to Cluster 3, using the DRS host-group based Availability Zones.</p>
<p>And here the cluster has been deployed in Cluster-3, using the AZs <em>rack1</em> and <em>rack2</em> (nodes <em>tkg-cluster-2-hostgroup-xxxx</em>)</p>
<img src=images/image-20230831165211734.png style="width:400px" />
<p>Next up is to deploy a test application in the workload cluster utilizing the availability zones.</p>
<h2 id="deploy-applications-on-workload-cluster-in-a-multi-az-environment">Deploy applications on workload cluster in a multi-az environment</h2>
<p>In my scenario so far I have placed all the control plane nodes evenly distributed across all the vSphere Clusters/AZs. The worker nodes on the other hand is placed only on AZ-2 and AZ-3. Now I want to deploy an application in my workload cluster where I do a placement decision on where the different pods will be placed, according to the available zones the workload cluster is in.</p>
<h3 id="applicationpod-placement-using-nodeaffinity">Application/pod placement using nodeAffinity</h3>
<p>When a TKG workload cluster or TKG management cluster has been deployed with availability zones, the nodes will get updated label information that is referencing the availability zone the worker and control-plane nodes have been deployed in. This information can be used if one want to deploy the application in a specific zone. So in this chapter I will do exactly that. Deploy an application consisting of 4 pods, define the placement of the pods using the zone information available on the nodes.</p>
<p>To find the labels for the different placements I need to have a look at the nodes. There should be some labels indicating where they reside. I will clean up the output as I am only looking for something that starts with <em>topology</em> and define the zones, and the worker nodes only. So the output below gives me this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@tkg-bootstrap:~$ k get nodes --show-labels
</span></span><span class="line"><span class="ln">2</span><span class="cl">NAME                                              STATUS   ROLES           AGE   VERSION            LABELS
</span></span><span class="line"><span class="ln">3</span><span class="cl">tkg-cluster-1-md-0-b4pfl-6d66f94fcdxnjnf6-t57dj   Ready    &lt;none&gt;          82m   v1.26.5+vmware.2   topology.kubernetes.io/zone<span class="o">=</span>wdc-zone-2
</span></span><span class="line"><span class="ln">4</span><span class="cl">tkg-cluster-1-md-1-vfzhk-5b6bbbbc5cxqk85x-tj4df   Ready    &lt;none&gt;          82m   v1.26.5+vmware.2   topology.kubernetes.io/zone<span class="o">=</span>wdc-zone-3
</span></span><span class="line"><span class="ln">5</span><span class="cl">tkg-cluster-1-md-2-rpk4z-78466846fdxkdjsp-vfd9h   Ready    &lt;none&gt;          82m   v1.26.5+vmware.2   topology.kubernetes.io/zone<span class="o">=</span>wdc-zone-3
</span></span></code></pre></div><p>One can also see the failuredomain  placement using the following commands:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@tkg-bootstrap:~$ kubectl get machinedeployment -n tkg-ns-1  -o<span class="o">=</span>custom-columns<span class="o">=</span>NAME:.metadata.name,FAILUREDOMAIN:.spec.template.spec.failureDomain
</span></span><span class="line"><span class="ln">2</span><span class="cl">NAME                       FAILUREDOMAIN
</span></span><span class="line"><span class="ln">3</span><span class="cl">tkg-cluster-1-md-0-b4pfl   wdc-zone-2
</span></span><span class="line"><span class="ln">4</span><span class="cl">tkg-cluster-1-md-1-vfzhk   wdc-zone-3
</span></span><span class="line"><span class="ln">5</span><span class="cl">tkg-cluster-1-md-2-rpk4z   wdc-zone-3
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@tkg-bootstrap:~$ kubectl get machine -n tkg-ns-1 -o<span class="o">=</span>custom-columns<span class="o">=</span>NAME:.metadata.name,FAILUREDOMAIN:.spec.failureDomain
</span></span><span class="line"><span class="ln">2</span><span class="cl">NAME                                              FAILUREDOMAIN
</span></span><span class="line"><span class="ln">3</span><span class="cl">tkg-cluster-1-md-0-b4pfl-6d66f94fcdxnjnf6-t57dj   wdc-zone-2
</span></span><span class="line"><span class="ln">4</span><span class="cl">tkg-cluster-1-md-1-vfzhk-5b6bbbbc5cxqk85x-tj4df   wdc-zone-3
</span></span><span class="line"><span class="ln">5</span><span class="cl">tkg-cluster-1-md-2-rpk4z-78466846fdxkdjsp-vfd9h   wdc-zone-3
</span></span><span class="line"><span class="ln">6</span><span class="cl">tkg-cluster-1-znr8h-4v2tm                         wdc-zone-2
</span></span><span class="line"><span class="ln">7</span><span class="cl">tkg-cluster-1-znr8h-d72g5                         wdc-zone-1
</span></span><span class="line"><span class="ln">8</span><span class="cl">tkg-cluster-1-znr8h-j6899                         wdc-zone-3
</span></span></code></pre></div><p>Now I need to update my application deployment adding a section where I can define the placement information, this is done by using <em>affinity</em>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln">1</span><span class="cl"><span class="w">      </span><span class="nt">affinity</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w">        </span><span class="nt">nodeAffinity</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w">          </span><span class="nt">requiredDuringSchedulingIgnoredDuringExecution</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w">            </span><span class="nt">nodeSelectorTerms</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w">            </span>- <span class="nt">matchExpressions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="w">              </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">topology.kubernetes.io/zone</span><span class="w">
</span></span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="w">                </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l">In</span><span class="w">
</span></span></span><span class="line"><span class="ln">8</span><span class="cl"><span class="w">                </span><span class="nt">values</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">9</span><span class="cl"><span class="w">                </span>- <span class="l">wdc-zone-X</span><span class="w">
</span></span></span></code></pre></div><p>My example application has been updated with the relevant information below. With this deployment I am allowing deployment in the wdc-zone-2 and wdc-zone-3 for the yelb-ui deployment, the 3 other deployments are only allowed to be placed in wdc-zone-3.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln">  1</span><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="ln">  2</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="ln">  3</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">  4</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">redis-server</span><span class="w">
</span></span></span><span class="line"><span class="ln">  5</span><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">  6</span><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">redis-server</span><span class="w">
</span></span></span><span class="line"><span class="ln">  7</span><span class="cl"><span class="w">    </span><span class="nt">tier</span><span class="p">:</span><span class="w"> </span><span class="l">cache</span><span class="w">
</span></span></span><span class="line"><span class="ln">  8</span><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">yelb</span><span class="w">
</span></span></span><span class="line"><span class="ln">  9</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 10</span><span class="cl"><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterIP</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 11</span><span class="cl"><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 12</span><span class="cl"><span class="w">  </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">6379</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 13</span><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 14</span><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">redis-server</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 15</span><span class="cl"><span class="w">    </span><span class="nt">tier</span><span class="p">:</span><span class="w"> </span><span class="l">cache</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 16</span><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 17</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 18</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 19</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 20</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">yelb-db</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 21</span><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 22</span><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">yelb-db</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 23</span><span class="cl"><span class="w">    </span><span class="nt">tier</span><span class="p">:</span><span class="w"> </span><span class="l">backenddb</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 24</span><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">yelb</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 25</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 26</span><span class="cl"><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterIP</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 27</span><span class="cl"><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 28</span><span class="cl"><span class="w">  </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">5432</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 29</span><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 30</span><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">yelb-db</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 31</span><span class="cl"><span class="w">    </span><span class="nt">tier</span><span class="p">:</span><span class="w"> </span><span class="l">backenddb</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 32</span><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 33</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 34</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 35</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 36</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">yelb-appserver</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 37</span><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 38</span><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">yelb-appserver</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 39</span><span class="cl"><span class="w">    </span><span class="nt">tier</span><span class="p">:</span><span class="w"> </span><span class="l">middletier</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 40</span><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">yelb</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 41</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 42</span><span class="cl"><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterIP</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 43</span><span class="cl"><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 44</span><span class="cl"><span class="w">  </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">4567</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 45</span><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 46</span><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">yelb-appserver</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 47</span><span class="cl"><span class="w">    </span><span class="nt">tier</span><span class="p">:</span><span class="w"> </span><span class="l">middletier</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 48</span><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 49</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 50</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 51</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 52</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">yelb-ui</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 53</span><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 54</span><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">yelb-ui</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 55</span><span class="cl"><span class="w">    </span><span class="nt">tier</span><span class="p">:</span><span class="w"> </span><span class="l">frontend</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 56</span><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">yelb</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 57</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 58</span><span class="cl"><span class="w">  </span><span class="nt">loadBalancerClass</span><span class="p">:</span><span class="w"> </span><span class="l">ako.vmware.com/avi-lb</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 59</span><span class="cl"><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">LoadBalancer</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 60</span><span class="cl"><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 61</span><span class="cl"><span class="w">  </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 62</span><span class="cl"><span class="w">    </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 63</span><span class="cl"><span class="w">    </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 64</span><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 65</span><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">yelb-ui</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 66</span><span class="cl"><span class="w">    </span><span class="nt">tier</span><span class="p">:</span><span class="w"> </span><span class="l">frontend</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 67</span><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 68</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 69</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 70</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 71</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">yelb-ui</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 72</span><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">yelb</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 73</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 74</span><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 75</span><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 76</span><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">yelb-ui</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 77</span><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 78</span><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 79</span><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 80</span><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 81</span><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">yelb-ui</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 82</span><span class="cl"><span class="w">        </span><span class="nt">tier</span><span class="p">:</span><span class="w"> </span><span class="l">frontend</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 83</span><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 84</span><span class="cl"><span class="w">      </span><span class="nt">affinity</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 85</span><span class="cl"><span class="w">        </span><span class="nt">nodeAffinity</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 86</span><span class="cl"><span class="w">          </span><span class="nt">requiredDuringSchedulingIgnoredDuringExecution</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 87</span><span class="cl"><span class="w">            </span><span class="nt">nodeSelectorTerms</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 88</span><span class="cl"><span class="w">            </span>- <span class="nt">matchExpressions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 89</span><span class="cl"><span class="w">              </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">topology.kubernetes.io/zone</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 90</span><span class="cl"><span class="w">                </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l">In</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 91</span><span class="cl"><span class="w">                </span><span class="nt">values</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 92</span><span class="cl"><span class="w">                </span>- <span class="l">wdc-zone-2</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 93</span><span class="cl"><span class="w">                </span>- <span class="l">wdc-zone-3</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 94</span><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 95</span><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">yelb-ui</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 96</span><span class="cl"><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">registry.guzware.net/yelb/yelb-ui:0.3</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 97</span><span class="cl"><span class="w">        </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Always</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 98</span><span class="cl"><span class="w">        </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 99</span><span class="cl"><span class="w">        </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="ln">100</span><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="ln">101</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="ln">102</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="ln">103</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">104</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">redis-server</span><span class="w">
</span></span></span><span class="line"><span class="ln">105</span><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">yelb</span><span class="w">
</span></span></span><span class="line"><span class="ln">106</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">107</span><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">108</span><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">109</span><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">redis-server</span><span class="w">
</span></span></span><span class="line"><span class="ln">110</span><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="ln">111</span><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">112</span><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">113</span><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">114</span><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">redis-server</span><span class="w">
</span></span></span><span class="line"><span class="ln">115</span><span class="cl"><span class="w">        </span><span class="nt">tier</span><span class="p">:</span><span class="w"> </span><span class="l">cache</span><span class="w">
</span></span></span><span class="line"><span class="ln">116</span><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">117</span><span class="cl"><span class="w">      </span><span class="nt">affinity</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">118</span><span class="cl"><span class="w">        </span><span class="nt">nodeAffinity</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">119</span><span class="cl"><span class="w">          </span><span class="nt">requiredDuringSchedulingIgnoredDuringExecution</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">120</span><span class="cl"><span class="w">            </span><span class="nt">nodeSelectorTerms</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">121</span><span class="cl"><span class="w">            </span>- <span class="nt">matchExpressions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">122</span><span class="cl"><span class="w">              </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">topology.kubernetes.io/zone</span><span class="w">
</span></span></span><span class="line"><span class="ln">123</span><span class="cl"><span class="w">                </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l">In</span><span class="w">
</span></span></span><span class="line"><span class="ln">124</span><span class="cl"><span class="w">                </span><span class="nt">values</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">125</span><span class="cl"><span class="w">                </span>- <span class="l">wdc-zone-3</span><span class="w">
</span></span></span><span class="line"><span class="ln">126</span><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">127</span><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">redis-server</span><span class="w">
</span></span></span><span class="line"><span class="ln">128</span><span class="cl"><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">registry.guzware.net/yelb/redis:4.0.2</span><span class="w">
</span></span></span><span class="line"><span class="ln">129</span><span class="cl"><span class="w">        </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">130</span><span class="cl"><span class="w">        </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">6379</span><span class="w">
</span></span></span><span class="line"><span class="ln">131</span><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="ln">132</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="ln">133</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="ln">134</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">135</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">yelb-db</span><span class="w">
</span></span></span><span class="line"><span class="ln">136</span><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">yelb</span><span class="w">
</span></span></span><span class="line"><span class="ln">137</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">138</span><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">139</span><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">140</span><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">yelb-db</span><span class="w">
</span></span></span><span class="line"><span class="ln">141</span><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="ln">142</span><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">143</span><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">144</span><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">145</span><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">yelb-db</span><span class="w">
</span></span></span><span class="line"><span class="ln">146</span><span class="cl"><span class="w">        </span><span class="nt">tier</span><span class="p">:</span><span class="w"> </span><span class="l">backenddb</span><span class="w">
</span></span></span><span class="line"><span class="ln">147</span><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">148</span><span class="cl"><span class="w">      </span><span class="nt">affinity</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">149</span><span class="cl"><span class="w">        </span><span class="nt">nodeAffinity</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">150</span><span class="cl"><span class="w">          </span><span class="nt">requiredDuringSchedulingIgnoredDuringExecution</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">151</span><span class="cl"><span class="w">            </span><span class="nt">nodeSelectorTerms</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">152</span><span class="cl"><span class="w">            </span>- <span class="nt">matchExpressions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">153</span><span class="cl"><span class="w">              </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">topology.kubernetes.io/zone</span><span class="w">
</span></span></span><span class="line"><span class="ln">154</span><span class="cl"><span class="w">                </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l">In</span><span class="w">
</span></span></span><span class="line"><span class="ln">155</span><span class="cl"><span class="w">                </span><span class="nt">values</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">156</span><span class="cl"><span class="w">                </span>- <span class="l">wdc-zone-3</span><span class="w">
</span></span></span><span class="line"><span class="ln">157</span><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">158</span><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">yelb-db</span><span class="w">
</span></span></span><span class="line"><span class="ln">159</span><span class="cl"><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">registry.guzware.net/yelb/yelb-db:0.3</span><span class="w">
</span></span></span><span class="line"><span class="ln">160</span><span class="cl"><span class="w">        </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">161</span><span class="cl"><span class="w">        </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">5432</span><span class="w">
</span></span></span><span class="line"><span class="ln">162</span><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="ln">163</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="ln">164</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="ln">165</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">166</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">yelb-appserver</span><span class="w">
</span></span></span><span class="line"><span class="ln">167</span><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">yelb</span><span class="w">
</span></span></span><span class="line"><span class="ln">168</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">169</span><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">170</span><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">171</span><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">yelb-appserver</span><span class="w">
</span></span></span><span class="line"><span class="ln">172</span><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="ln">173</span><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">174</span><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">175</span><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">176</span><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">yelb-appserver</span><span class="w">
</span></span></span><span class="line"><span class="ln">177</span><span class="cl"><span class="w">        </span><span class="nt">tier</span><span class="p">:</span><span class="w"> </span><span class="l">middletier</span><span class="w">
</span></span></span><span class="line"><span class="ln">178</span><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">179</span><span class="cl"><span class="w">      </span><span class="nt">affinity</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">180</span><span class="cl"><span class="w">        </span><span class="nt">nodeAffinity</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">181</span><span class="cl"><span class="w">          </span><span class="nt">requiredDuringSchedulingIgnoredDuringExecution</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">182</span><span class="cl"><span class="w">            </span><span class="nt">nodeSelectorTerms</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">183</span><span class="cl"><span class="w">            </span>- <span class="nt">matchExpressions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">184</span><span class="cl"><span class="w">              </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">topology.kubernetes.io/zone</span><span class="w">
</span></span></span><span class="line"><span class="ln">185</span><span class="cl"><span class="w">                </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l">In</span><span class="w">
</span></span></span><span class="line"><span class="ln">186</span><span class="cl"><span class="w">                </span><span class="nt">values</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">187</span><span class="cl"><span class="w">                </span>- <span class="l">wdc-zone-3</span><span class="w">
</span></span></span><span class="line"><span class="ln">188</span><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">189</span><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">yelb-appserver</span><span class="w">
</span></span></span><span class="line"><span class="ln">190</span><span class="cl"><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">registry.guzware.net/yelb/yelb-appserver:0.3</span><span class="w">
</span></span></span><span class="line"><span class="ln">191</span><span class="cl"><span class="w">        </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">192</span><span class="cl"><span class="w">        </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">4567</span><span class="w">
</span></span></span></code></pre></div><p>Now to apply it and check the outcome.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@tkg-bootstrap:~$ k get pods -n yelb -o wide
</span></span><span class="line"><span class="ln">2</span><span class="cl">NAME                            READY   STATUS    RESTARTS   AGE   IP            NODE                                              NOMINATED NODE   READINESS GATES
</span></span><span class="line"><span class="ln">3</span><span class="cl">redis-server-5997cbfdf7-f7wgh   1/1     Running   <span class="m">0</span>          10m   100.96.3.16   tkg-cluster-1-md-1-vfzhk-5b6bbbbc5cxqk85x-tj4df   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="ln">4</span><span class="cl">yelb-appserver-6d65cc8-xt82g    1/1     Running   <span class="m">0</span>          10m   100.96.3.17   tkg-cluster-1-md-1-vfzhk-5b6bbbbc5cxqk85x-tj4df   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="ln">5</span><span class="cl">yelb-db-7d4c56597f-58zd4        1/1     Running   <span class="m">0</span>          10m   100.96.2.3    tkg-cluster-1-md-2-rpk4z-78466846fdxkdjsp-vfd9h   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="ln">6</span><span class="cl">yelb-ui-6c6fdfc66f-ngjnm        1/1     Running   <span class="m">0</span>          10m   100.96.2.2    tkg-cluster-1-md-2-rpk4z-78466846fdxkdjsp-vfd9h   &lt;none&gt;           &lt;none&gt;
</span></span></code></pre></div><p>If I compare this to the nodes below:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">NAME                                              FAILUREDOMAIN
</span></span><span class="line"><span class="ln">2</span><span class="cl">tkg-cluster-1-md-0-b4pfl-6d66f94fcdxnjnf6-t57dj   wdc-zone-2
</span></span><span class="line"><span class="ln">3</span><span class="cl">tkg-cluster-1-md-1-vfzhk-5b6bbbbc5cxqk85x-tj4df   wdc-zone-3
</span></span><span class="line"><span class="ln">4</span><span class="cl">tkg-cluster-1-md-2-rpk4z-78466846fdxkdjsp-vfd9h   wdc-zone-3
</span></span></code></pre></div><p>So far eveything looks good. All pods have been deployed in wdc-zone-3. The ui-pod is also allowed to be placed in wdc-zone-2.
What happens if I scale it up with a couple of pods.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">andreasm@tkg-bootstrap:~$ k scale deployment -n yelb --replicas <span class="m">5</span> yelb-ui
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">deployment.apps/yelb-ui scaled
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">NAME                            READY   STATUS    RESTARTS   AGE    IP            NODE                                              NOMINATED NODE   READINESS GATES
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">redis-server-5997cbfdf7-f7wgh   1/1     Running   <span class="m">0</span>          22m    100.96.3.16   tkg-cluster-1-md-1-vfzhk-5b6bbbbc5cxqk85x-tj4df   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">yelb-appserver-6d65cc8-xt82g    1/1     Running   <span class="m">0</span>          22m    100.96.3.17   tkg-cluster-1-md-1-vfzhk-5b6bbbbc5cxqk85x-tj4df   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">yelb-db-7d4c56597f-58zd4        1/1     Running   <span class="m">0</span>          22m    100.96.2.3    tkg-cluster-1-md-2-rpk4z-78466846fdxkdjsp-vfd9h   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">yelb-ui-6c6fdfc66f-59zqs        1/1     Running   <span class="m">0</span>          5m2s   100.96.1.5    tkg-cluster-1-md-0-b4pfl-6d66f94fcdxnjnf6-t57dj   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">yelb-ui-6c6fdfc66f-8w48g        1/1     Running   <span class="m">0</span>          5m2s   100.96.2.4    tkg-cluster-1-md-2-rpk4z-78466846fdxkdjsp-vfd9h   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">yelb-ui-6c6fdfc66f-mprxx        1/1     Running   <span class="m">0</span>          5m2s   100.96.1.4    tkg-cluster-1-md-0-b4pfl-6d66f94fcdxnjnf6-t57dj   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="ln">10</span><span class="cl">yelb-ui-6c6fdfc66f-n9slz        1/1     Running   <span class="m">0</span>          5m2s   100.96.3.19   tkg-cluster-1-md-1-vfzhk-5b6bbbbc5cxqk85x-tj4df   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="ln">11</span><span class="cl">yelb-ui-6c6fdfc66f-ngjnm        1/1     Running   <span class="m">0</span>          22m    100.96.2.2    tkg-cluster-1-md-2-rpk4z-78466846fdxkdjsp-vfd9h   &lt;none&gt;           &lt;none&gt;
</span></span></code></pre></div><p>Two of the ui-pods has been placed in wdc-zone-2</p>
<p>Now that I have full control of the app placement, lets test some failure scenarios.</p>
<h2 id="failure-simulations">Failure simulations</h2>
<p>In this chapter I will quickly simulate an outage of Zone-2 or vSphere Cluster-2 where the 1 of the TKG mgmt control plane is residing, 1 of the workload Cluster-1 is residing plus 1 worker node for both the management cluster and tkg-cluster-1:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1"># TKG management cluster placement in my vSphere environment</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">Nodes in the cluster with the <span class="s1">&#39;node.cluster.x-k8s.io/esxi-host&#39;</span> label:
</span></span><span class="line"><span class="ln">3</span><span class="cl">
</span></span><span class="line"><span class="ln">4</span><span class="cl">Node: tkg-wdc-az-mgmt-hgt2v-hb7vj <span class="p">|</span> ESXi Host: esx04.cpod-nsxam-wdc <span class="c1">#controlplane node on Zone-1</span>
</span></span><span class="line"><span class="ln">5</span><span class="cl">Node: tkg-wdc-az-mgmt-hgt2v-w6r64 <span class="p">|</span> ESXi Host: esx03.cpod-nsxam-wdc-03 <span class="c1">#controlplane node on Zone-3</span>
</span></span><span class="line"><span class="ln">6</span><span class="cl">Node: tkg-wdc-az-mgmt-hgt2v-zl5k9 <span class="p">|</span> ESXi Host: esx04.cpod-nsxam-wdc-02 <span class="c1">#controlplane node on Zone-2</span>
</span></span><span class="line"><span class="ln">7</span><span class="cl">Node: tkg-wdc-az-mgmt-md-0-xn6cg-79f97555c7x45h4b-6ghbg <span class="p">|</span> ESXi Host: esx04.cpod-nsxam-wdc-02 <span class="c1">#worker node on Zone 2</span>
</span></span><span class="line"><span class="ln">8</span><span class="cl">Node: tkg-wdc-az-mgmt-md-1-zmr4d-56ff586997xxndn8-hzs7f <span class="p">|</span> ESXi Host: esx01.cpod-nsxam-wdc-03 <span class="c1">#worker node on Zone-3</span>
</span></span><span class="line"><span class="ln">9</span><span class="cl">Node: tkg-wdc-az-mgmt-md-2-67dm4-64f79b7dd7x6f56s-76qhv <span class="p">|</span> ESXi Host: esx02.cpod-nsxam-wdc-03 <span class="c1">#worker node on Zone-3</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1"># TKG workload cluster (tkg-cluster-1) placement in my vSphere environment</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">Nodes in the cluster with the <span class="s1">&#39;node.cluster.x-k8s.io/esxi-host&#39;</span> label:
</span></span><span class="line"><span class="ln">3</span><span class="cl">
</span></span><span class="line"><span class="ln">4</span><span class="cl">Node: tkg-cluster-1-md-0-b4pfl-6d66f94fcdxnjnf6-t57dj <span class="p">|</span> ESXi Host: esx03.cpod-nsxam-wdc-02 <span class="c1">#worker node on Zone-2</span>
</span></span><span class="line"><span class="ln">5</span><span class="cl">Node: tkg-cluster-1-md-1-vfzhk-5b6bbbbc5cxqk85x-tj4df <span class="p">|</span> ESXi Host: esx02.cpod-nsxam-wdc-03 <span class="c1">#worker node on Zone-3</span>
</span></span><span class="line"><span class="ln">6</span><span class="cl">Node: tkg-cluster-1-md-2-rpk4z-78466846fdxkdjsp-vfd9h <span class="p">|</span> ESXi Host: esx03.cpod-nsxam-wdc-03 <span class="c1">#worker node on Zone-3</span>
</span></span><span class="line"><span class="ln">7</span><span class="cl">Node: tkg-cluster-1-znr8h-4v2tm <span class="p">|</span> ESXi Host: esx03.cpod-nsxam-wdc-02 <span class="c1">#controlplane node on Zone-2</span>
</span></span><span class="line"><span class="ln">8</span><span class="cl">Node: tkg-cluster-1-znr8h-d72g5 <span class="p">|</span> ESXi Host: esx04.cpod-nsxam-wdc.az-wdc <span class="c1">#controlplane node on Zone-1</span>
</span></span><span class="line"><span class="ln">9</span><span class="cl">Node: tkg-cluster-1-znr8h-j6899 <span class="p">|</span> ESXi Host: esx04.cpod-nsxam-wdc-03.az-wdc <span class="c1">#controlplane node on Zone-3</span>
</span></span></code></pre></div><p>The Yelb application pods placement:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">NAME                            READY   STATUS    RESTARTS   AGE     IP            NODE                                              NOMINATED NODE   READINESS GATES
</span></span><span class="line"><span class="ln">2</span><span class="cl">redis-server-5997cbfdf7-f7wgh   1/1     Running   <span class="m">0</span>          2d22h   100.96.3.16   tkg-cluster-1-md-1-vfzhk-5b6bbbbc5cxqk85x-tj4df   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="ln">3</span><span class="cl">yelb-appserver-6d65cc8-xt82g    1/1     Running   <span class="m">0</span>          2d22h   100.96.3.17   tkg-cluster-1-md-1-vfzhk-5b6bbbbc5cxqk85x-tj4df   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="ln">4</span><span class="cl">yelb-db-7d4c56597f-58zd4        1/1     Running   <span class="m">0</span>          2d22h   100.96.2.3    tkg-cluster-1-md-2-rpk4z-78466846fdxkdjsp-vfd9h   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="ln">5</span><span class="cl">yelb-ui-6c6fdfc66f-59zqs        1/1     Running   <span class="m">0</span>          2d22h   100.96.1.5    tkg-cluster-1-md-0-b4pfl-6d66f94fcdxnjnf6-t57dj   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="ln">6</span><span class="cl">yelb-ui-6c6fdfc66f-8w48g        1/1     Running   <span class="m">0</span>          2d22h   100.96.2.4    tkg-cluster-1-md-2-rpk4z-78466846fdxkdjsp-vfd9h   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="ln">7</span><span class="cl">yelb-ui-6c6fdfc66f-mprxx        1/1     Running   <span class="m">0</span>          2d22h   100.96.1.4    tkg-cluster-1-md-0-b4pfl-6d66f94fcdxnjnf6-t57dj   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="ln">8</span><span class="cl">yelb-ui-6c6fdfc66f-n9slz        1/1     Running   <span class="m">0</span>          2d22h   100.96.3.19   tkg-cluster-1-md-1-vfzhk-5b6bbbbc5cxqk85x-tj4df   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="ln">9</span><span class="cl">yelb-ui-6c6fdfc66f-ngjnm        1/1     Running   <span class="m">0</span>          2d22h   100.96.2.2    tkg-cluster-1-md-2-rpk4z-78466846fdxkdjsp-vfd9h   &lt;none&gt;           &lt;none&gt;
</span></span></code></pre></div><p>What I want to achieve is an available TKG mgmt cluster control plane, TKG workload tkg-cluster-1 control plane, and the Yelb application still up and running. The simple test I will do is to just go into vCenter power off all the nodes for these TKG cluster in Zone-2/vSphere Cluster-2. I could also shutdown the whole ESXi hosts but I have other services running there depending on this cluster also.</p>
<p>One last observation to see status of the two control planes, or K8s API endpoints is from my NSX-ALB dashboard for both TKG mgmt cluster and TKG-cluster-1.</p>
<p>The TKG mgmt cluster controlplanes/k8s-api endpoint:</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="tkg-mgmt"
      
        class="image_figure image_internal image_processed"
        width="1612"
        height="524"
        src="/2023/08/29/tkg-2.3-deployment-in-multiple-availability-zones/images/image-20230904120530264.png"
      
      
    />

    </picture>
</figure>
</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="tkg-wld-cluster-1"
      
        class="image_figure image_internal image_processed"
        width="1566"
        height="562"
        src="/2023/08/29/tkg-2.3-deployment-in-multiple-availability-zones/images/image-20230904120605059.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Before shutting down I have full access to both the mgmt and tkg-cluster-1 k8s api, and the yelb-app ui is accessible.</p>
<p>Now, powering off the nodes:</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="power-off"
      
        class="image_figure image_internal image_processed"
        width="1942"
        height="942"
        src="/2023/08/29/tkg-2.3-deployment-in-multiple-availability-zones/images/image-20230904120809536.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Some observations after power off:</p>
<p>From NSX-ALB</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="missing cp nodes"
      
        class="image_figure image_internal image_processed"
        width="1824"
        height="1320"
        src="/2023/08/29/tkg-2.3-deployment-in-multiple-availability-zones/images/image-20230904121016839.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Yelb app is still available:</p>
<img src=images/image-20230904121051926.png style="width:500px" />
<p>Is the k8s api available?</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">NAME                                                STATUS     ROLES           AGE     VERSION
</span></span><span class="line"><span class="ln">2</span><span class="cl">tkg-wdc-az-mgmt-hgt2v-hb7vj                         Ready      control-plane   4d23h   v1.26.5+vmware.2
</span></span><span class="line"><span class="ln">3</span><span class="cl">tkg-wdc-az-mgmt-hgt2v-w6r64                         Ready      control-plane   4d23h   v1.26.5+vmware.2
</span></span><span class="line"><span class="ln">4</span><span class="cl">tkg-wdc-az-mgmt-hgt2v-zl5k9                         NotReady   control-plane   4d23h   v1.26.5+vmware.2
</span></span><span class="line"><span class="ln">5</span><span class="cl">tkg-wdc-az-mgmt-md-0-xn6cg-79f97555c7x45h4b-6ghbg   NotReady   &lt;none&gt;          4d23h   v1.26.5+vmware.2
</span></span><span class="line"><span class="ln">6</span><span class="cl">tkg-wdc-az-mgmt-md-1-zmr4d-56ff586997xxndn8-hzs7f   Ready      &lt;none&gt;          4d23h   v1.26.5+vmware.2
</span></span><span class="line"><span class="ln">7</span><span class="cl">tkg-wdc-az-mgmt-md-2-67dm4-64f79b7dd7x6f56s-76qhv   Ready      &lt;none&gt;          4d23h   v1.26.5+vmware.2
</span></span></code></pre></div><p>The management cluster is, though complaining on the two nodes above as not ready. (They are powered off).
The workload cluster k8s api available?</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="ln">1</span><span class="cl">NAME                                              STATUS     ROLES           AGE     VERSION
</span></span><span class="line"><span class="ln">2</span><span class="cl">tkg-cluster-1-md-0-b4pfl-6d66f94fcdxnjnf6-t57dj   Ready      &lt;none&gt;          4d22h   v1.26.5+vmware.2
</span></span><span class="line"><span class="ln">3</span><span class="cl">tkg-cluster-1-md-1-vfzhk-5b6bbbbc5cxqk85x-tj4df   Ready      &lt;none&gt;          4d22h   v1.26.5+vmware.2
</span></span><span class="line"><span class="ln">4</span><span class="cl">tkg-cluster-1-md-2-rpk4z-78466846fdxkdjsp-vfd9h   Ready      &lt;none&gt;          4d22h   v1.26.5+vmware.2
</span></span><span class="line"><span class="ln">5</span><span class="cl">tkg-cluster-1-znr8h-4v2tm                         NotReady   control-plane   4d21h   v1.26.5+vmware.2
</span></span><span class="line"><span class="ln">6</span><span class="cl">tkg-cluster-1-znr8h-d72g5                         Ready      control-plane   4d21h   v1.26.5+vmware.2
</span></span><span class="line"><span class="ln">7</span><span class="cl">tkg-cluster-1-znr8h-j6899                         Ready      control-plane   4d22h   v1.26.5+vmware.2
</span></span></code></pre></div><p>It is. though a control plane node is down.</p>
<p>The Yelb pods:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">NAME                            READY   STATUS    RESTARTS        AGE     IP            NODE                                              NOMINATED NODE   READINESS GATES
</span></span><span class="line"><span class="ln">2</span><span class="cl">redis-server-5997cbfdf7-f7wgh   1/1     Running   <span class="m">0</span>               2d22h   100.96.3.16   tkg-cluster-1-md-1-vfzhk-5b6bbbbc5cxqk85x-tj4df   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="ln">3</span><span class="cl">yelb-appserver-6d65cc8-xt82g    1/1     Running   <span class="m">0</span>               2d22h   100.96.3.17   tkg-cluster-1-md-1-vfzhk-5b6bbbbc5cxqk85x-tj4df   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="ln">4</span><span class="cl">yelb-db-7d4c56597f-58zd4        1/1     Running   <span class="m">0</span>               2d22h   100.96.2.3    tkg-cluster-1-md-2-rpk4z-78466846fdxkdjsp-vfd9h   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="ln">5</span><span class="cl">yelb-ui-6c6fdfc66f-59zqs        1/1     Running   <span class="m">1</span> <span class="o">(</span>6m24s ago<span class="o">)</span>   2d22h   100.96.1.5    tkg-cluster-1-md-0-b4pfl-6d66f94fcdxnjnf6-t57dj   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="ln">6</span><span class="cl">yelb-ui-6c6fdfc66f-8w48g        1/1     Running   <span class="m">0</span>               2d22h   100.96.2.4    tkg-cluster-1-md-2-rpk4z-78466846fdxkdjsp-vfd9h   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="ln">7</span><span class="cl">yelb-ui-6c6fdfc66f-mprxx        1/1     Running   <span class="m">1</span> <span class="o">(</span>6m23s ago<span class="o">)</span>   2d22h   100.96.1.2    tkg-cluster-1-md-0-b4pfl-6d66f94fcdxnjnf6-t57dj   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="ln">8</span><span class="cl">yelb-ui-6c6fdfc66f-n9slz        1/1     Running   <span class="m">0</span>               2d22h   100.96.3.19   tkg-cluster-1-md-1-vfzhk-5b6bbbbc5cxqk85x-tj4df   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="ln">9</span><span class="cl">yelb-ui-6c6fdfc66f-ngjnm        1/1     Running   <span class="m">0</span>               2d22h   100.96.2.2    tkg-cluster-1-md-2-rpk4z-78466846fdxkdjsp-vfd9h   &lt;none&gt;           &lt;none&gt;
</span></span></code></pre></div><p>So it seems everything is still reacheable still after loosing Zone-2. When I did power off the nodes the first time it took around a minute before they were powered back on. I powered them down again and now it seems they are not being powered on again. Will wait a bit and see, otherwise I will try to power them on manually.
After a longer while the tkg-cluster-1 nodes have now this status:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">NAME                                              STATUS                        ROLES           AGE     VERSION
</span></span><span class="line"><span class="ln">2</span><span class="cl">tkg-cluster-1-md-0-b4pfl-6d66f94fcdxnjnf6-t57dj   NotReady,SchedulingDisabled   &lt;none&gt;          4d22h   v1.26.5+vmware.2
</span></span><span class="line"><span class="ln">3</span><span class="cl">tkg-cluster-1-md-1-vfzhk-5b6bbbbc5cxqk85x-tj4df   Ready                         &lt;none&gt;          4d22h   v1.26.5+vmware.2
</span></span><span class="line"><span class="ln">4</span><span class="cl">tkg-cluster-1-md-2-rpk4z-78466846fdxkdjsp-vfd9h   Ready                         &lt;none&gt;          4d22h   v1.26.5+vmware.2
</span></span><span class="line"><span class="ln">5</span><span class="cl">tkg-cluster-1-znr8h-4v2tm                         NotReady,SchedulingDisabled   control-plane   4d21h   v1.26.5+vmware.2
</span></span><span class="line"><span class="ln">6</span><span class="cl">tkg-cluster-1-znr8h-d72g5                         Ready                         control-plane   4d22h   v1.26.5+vmware.2
</span></span><span class="line"><span class="ln">7</span><span class="cl">tkg-cluster-1-znr8h-j6899                         Ready                         control-plane   4d22h   v1.26.5+vmware.2
</span></span></code></pre></div><p>I will try to manually power the nodes back on. I did not have the chance to do that, they are now being deleted and recreated! Wow, cool</p>
<img src=images/image-20230904122601139.png style="width:500px" />
<h2 id="update-existing-tkg-cluster-to-use-new-availability-zones">Update existing TKG cluster to use new Availability Zones</h2>
<p>For details on how to update existing cluster to use new availabilty zones follow the official documentation <a href="https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid/2.3/using-tkg/workload-clusters-multi-az-vsphere.html#update-existing-clusters-to-use-multiple-or-different-availability-zones-6">here</a></p>
<h2 id="wrapping-up">Wrapping up</h2>
<p>This finishes the exploration of this useful feature in TKG 2.3. It is very flexible and allows for very robust design of node placement. Opens up for designs with high availability requirements. I do like very much the choice to use vSphere clusters, vCenter servers and DRS host-groups as the different objects in vCenter to use.</p>

    </div>




  </article>
<aside class="sidebar">
  <section class="sidebar_inner">
    <br>
    
  
  <div class="search">
    <input type="search" class="search_field form_field" placeholder='Search...' id="find" autocomplete="off" data-scope='post'>
    <label for="find" class="search_label"><svg class="icon">
  <title>search</title>
  <use xlink:href="#search"></use>
</svg>

    </label>
    
    <div class="search_results results"></div>
  </div>

        <h2>Hi there</h2>
      <div class="author_bio">
        This is Andreas Marqvardsen's blog, a Systems Engineer at Arista. This blog focuses on stuff he finds interesting and useful. All views and opinions expressed here are his own
      </div>
      <a href='https://blog.andreasm.io/about/' class="button mt-1" role="button" title='Read More'>Read More</a>

    
    
    <h2 class="mt-4">Recent Posts</h2>
    <ul class="flex-column">
      <li>
        <a href="https://blog.andreasm.io/2024/08/22/arista-cloudvision-and-avd-using-containerlab/" class="nav-link" title="Arista Cloudvision and AVD using Containerlab">Arista Cloudvision and AVD using Containerlab</a>
      </li>
      <li>
        <a href="https://blog.andreasm.io/2024/06/10/arista-automated-configuration-using-ansible/" class="nav-link" title="Arista Automated Configuration using Ansible">Arista Automated Configuration using Ansible</a>
      </li>
      <li>
        <a href="https://blog.andreasm.io/2024/04/16/exploring-some-antrea-features/" class="nav-link" title="Exploring some Antrea Features">Exploring some Antrea Features</a>
      </li>
      <li>
        <a href="https://blog.andreasm.io/2024/04/08/vsphere-with-tanzu-avi-and-multiple-supervisors/" class="nav-link" title="vSphere with Tanzu - Avi and Multiple Supervisors">vSphere with Tanzu - Avi and Multiple Supervisors</a>
      </li>
      <li>
        <a href="https://blog.andreasm.io/2024/02/04/argo-cd-vsphere-with-tanzu/" class="nav-link" title="Argo CD &amp; vSphere with Tanzu">Argo CD &amp; vSphere with Tanzu</a>
      </li>
      <li>
        <a href="https://blog.andreasm.io/2024/01/15/proxmox-with-opentofu-kubespray-and-kubernetes/" class="nav-link" title="Proxmox with OpenTofu Kubespray and Kubernetes">Proxmox with OpenTofu Kubespray and Kubernetes</a>
      </li>
      <li>
        <a href="https://blog.andreasm.io/2023/12/26/traefik-proxy-in-kubernetes/" class="nav-link" title="Traefik Proxy in Kubernetes">Traefik Proxy in Kubernetes</a>
      </li>
      <li>
        <a href="https://blog.andreasm.io/2023/12/18/a-quick-glance-at-cilium-cni/" class="nav-link" title="A Quick Glance at Cilium CNI">A Quick Glance at Cilium CNI</a>
      </li>
    </ul>
    <div>
      <h2 class="mt-4 taxonomy" id="categories-section">Categories</h2>
      <nav class="tags_nav">
        <a href='https://blog.andreasm.io/categories/kubernetes/' class="post_tag button button_translucent" title="kubernetes">
          KUBERNETES
          <span class="button_tally">42</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/networking/' class="post_tag button button_translucent" title="networking">
          NETWORKING
          <span class="button_tally">22</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/tanzu/' class="post_tag button button_translucent" title="tanzu">
          TANZU
          <span class="button_tally">13</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/cni/' class="post_tag button button_translucent" title="cni">
          CNI
          <span class="button_tally">9</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/loadbalancing/' class="post_tag button button_translucent" title="loadbalancing">
          LOADBALANCING
          <span class="button_tally">9</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/security/' class="post_tag button button_translucent" title="security">
          SECURITY
          <span class="button_tally">7</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/avi/' class="post_tag button button_translucent" title="avi">
          AVI
          <span class="button_tally">6</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/nsx/' class="post_tag button button_translucent" title="nsx">
          NSX
          <span class="button_tally">5</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/antrea/' class="post_tag button button_translucent" title="antrea">
          ANTREA
          <span class="button_tally">4</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/automation/' class="post_tag button button_translucent" title="automation">
          AUTOMATION
          <span class="button_tally">4</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/blog/' class="post_tag button button_translucent" title="blog">
          BLOG
          <span class="button_tally">2</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/network/' class="post_tag button button_translucent" title="network">
          NETWORK
          <span class="button_tally">2</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/provisioning/' class="post_tag button button_translucent" title="provisioning">
          PROVISIONING
          <span class="button_tally">2</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/vmware-nsx/' class="post_tag button button_translucent" title="vmware nsx">
          VMWARE NSX
          <span class="button_tally">2</span>
        </a>
        
        
        <br>
        <div class="post_tags_toggle button">All Categories</div>
        <div class="post_tags">
          <div class="tags_list">
            
            <a href='https://blog.andreasm.io/categories/antrea/' class=" post_tag button button_translucent" data-position=4 title="antrea">ANTREA<span class="button_tally">4</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/argocd/' class=" post_tag button button_translucent" data-position=1 title="argocd">ARGOCD<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/arista/' class=" post_tag button button_translucent" data-position=1 title="arista">ARISTA<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/automation/' class=" post_tag button button_translucent" data-position=4 title="automation">AUTOMATION<span class="button_tally">4</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/autoscaling/' class=" post_tag button button_translucent" data-position=1 title="autoscaling">AUTOSCALING<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/avi/' class=" post_tag button button_translucent" data-position=6 title="avi">AVI<span class="button_tally">6</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/blog/' class=" post_tag button button_translucent" data-position=2 title="blog">BLOG<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/ceos/' class=" post_tag button button_translucent" data-position=1 title="ceos">CEOS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/certificate/' class=" post_tag button button_translucent" data-position=1 title="certificate">CERTIFICATE<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/cni/' class=" post_tag button button_translucent" data-position=9 title="cni">CNI<span class="button_tally">9</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/compliance/' class=" post_tag button button_translucent" data-position=1 title="compliance">COMPLIANCE<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/docker/' class=" post_tag button button_translucent" data-position=1 title="docker">DOCKER<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/ebpf/' class=" post_tag button button_translucent" data-position=1 title="ebpf">EBPF<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/github/' class=" post_tag button button_translucent" data-position=1 title="github">GITHUB<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/gitops/' class=" post_tag button button_translucent" data-position=1 title="gitops">GITOPS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/harbor/' class=" post_tag button button_translucent" data-position=1 title="harbor">HARBOR<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/helm/' class=" post_tag button button_translucent" data-position=1 title="helm">HELM<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/home-automation/' class=" post_tag button button_translucent" data-position=1 title="home-automation">HOME-AUTOMATION<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/hugo/' class=" post_tag button button_translucent" data-position=1 title="hugo">HUGO<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/ingress/' class=" post_tag button button_translucent" data-position=1 title="ingress">INGRESS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/kubernetes/' class=" post_tag button button_translucent" data-position=42 title="kubernetes">KUBERNETES<span class="button_tally">42</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/kubernetes-management/' class=" post_tag button button_translucent" data-position=1 title="kubernetes-management">KUBERNETES-MANAGEMENT<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/lcm/' class=" post_tag button button_translucent" data-position=1 title="lcm">LCM<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/lifecycle-management/' class=" post_tag button button_translucent" data-position=1 title="lifecycle-management">LIFECYCLE-MANAGEMENT<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/loadbalancing/' class=" post_tag button button_translucent" data-position=9 title="loadbalancing">LOADBALANCING<span class="button_tally">9</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/management/' class=" post_tag button button_translucent" data-position=1 title="management">MANAGEMENT<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/monitoring/' class=" post_tag button button_translucent" data-position=1 title="monitoring">MONITORING<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/netowkring/' class=" post_tag button button_translucent" data-position=1 title="netowkring">NETOWKRING<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/network/' class=" post_tag button button_translucent" data-position=2 title="network">NETWORK<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/networking/' class=" post_tag button button_translucent" data-position=22 title="networking">NETWORKING<span class="button_tally">22</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/neuvector/' class=" post_tag button button_translucent" data-position=1 title="neuvector">NEUVECTOR<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/nsx/' class=" post_tag button button_translucent" data-position=5 title="nsx">NSX<span class="button_tally">5</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/nsx-alb/' class=" post_tag button button_translucent" data-position=1 title="nsx-alb">NSX-ALB<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/nsx-t/' class=" post_tag button button_translucent" data-position=1 title="nsx-t">NSX-T<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/pinniped/' class=" post_tag button button_translucent" data-position=1 title="pinniped">PINNIPED<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/provisioning/' class=" post_tag button button_translucent" data-position=2 title="provisioning">PROVISIONING<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/rancher/' class=" post_tag button button_translucent" data-position=1 title="rancher">RANCHER<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/rbac/' class=" post_tag button button_translucent" data-position=1 title="rbac">RBAC<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/rke2/' class=" post_tag button button_translucent" data-position=1 title="rke2">RKE2<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/security/' class=" post_tag button button_translucent" data-position=7 title="security">SECURITY<span class="button_tally">7</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/storage/' class=" post_tag button button_translucent" data-position=1 title="storage">STORAGE<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/suse/' class=" post_tag button button_translucent" data-position=1 title="suse">SUSE<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/tanzu/' class=" post_tag button button_translucent" data-position=13 title="tanzu">TANZU<span class="button_tally">13</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/tanzu-mission-control/' class=" post_tag button button_translucent" data-position=1 title="tanzu mission control">TANZU MISSION CONTROL<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/tkg/' class=" post_tag button button_translucent" data-position=1 title="tkg">TKG<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/tkgi/' class=" post_tag button button_translucent" data-position=1 title="tkgi">TKGI<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/tmc/' class=" post_tag button button_translucent" data-position=1 title="tmc">TMC<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/troubleshooting/' class=" post_tag button button_translucent" data-position=1 title="troubleshooting">TROUBLESHOOTING<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/veos/' class=" post_tag button button_translucent" data-position=1 title="veos">VEOS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/virtualization/' class=" post_tag button button_translucent" data-position=1 title="virtualization">VIRTUALIZATION<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/vmare-nsx-intelligence/' class=" post_tag button button_translucent" data-position=1 title="vmare nsx intelligence">VMARE NSX INTELLIGENCE<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/vmware-nsx/' class=" post_tag button button_translucent" data-position=2 title="vmware nsx">VMWARE NSX<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/vmware-cloud/' class=" post_tag button button_translucent" data-position=1 title="vmware-cloud">VMWARE-CLOUD<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/vsphere/' class=" post_tag button button_translucent" data-position=1 title="vsphere">VSPHERE<span class="button_tally">1</span>
            </a>
            
            <div class="tags_sort"><span title="sort alphabetically">[A~Z]</span><span title="sort by count">[0~9]</span>
            </div>
            <span class="tags_hide"><svg class="icon">
            <use xlink:href="#closeme"></use>
          </svg></span>
          </div>
        </div>
      </nav>
    </div>
    <div>
      <h2 class="mt-4 taxonomy" id="tags-section">Tags</h2>
      <nav class="tags_nav">
        <a href='https://blog.andreasm.io/tags/kubernetes/' class="post_tag button button_translucent" title="kubernetes">
          KUBERNETES
          <span class="button_tally">24</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/tanzu/' class="post_tag button button_translucent" title="tanzu">
          TANZU
          <span class="button_tally">14</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/nsx/' class="post_tag button button_translucent" title="nsx">
          NSX
          <span class="button_tally">13</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/antrea/' class="post_tag button button_translucent" title="antrea">
          ANTREA
          <span class="button_tally">12</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/ako/' class="post_tag button button_translucent" title="ako">
          AKO
          <span class="button_tally">8</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/avi/' class="post_tag button button_translucent" title="avi">
          AVI
          <span class="button_tally">7</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/loadbalancing/' class="post_tag button button_translucent" title="loadbalancing">
          LOADBALANCING
          <span class="button_tally">7</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/security/' class="post_tag button button_translucent" title="security">
          SECURITY
          <span class="button_tally">7</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/ingress/' class="post_tag button button_translucent" title="ingress">
          INGRESS
          <span class="button_tally">5</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/networking/' class="post_tag button button_translucent" title="networking">
          NETWORKING
          <span class="button_tally">5</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/cni/' class="post_tag button button_translucent" title="cni">
          CNI
          <span class="button_tally">4</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/automation/' class="post_tag button button_translucent" title="automation">
          AUTOMATION
          <span class="button_tally">3</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/availability/' class="post_tag button button_translucent" title="availability">
          AVAILABILITY
          <span class="button_tally">3</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/cert-manager/' class="post_tag button button_translucent" title="cert-manager">
          CERT-MANAGER
          <span class="button_tally">3</span>
        </a>
        
        
        <br>
        <div class="post_tags_toggle button">All Tags</div>
        <div class="post_tags">
          <div class="tags_list">
            
            <a href='https://blog.andreasm.io/tags/ako/' class=" post_tag button button_translucent" data-position=8 title="ako">AKO<span class="button_tally">8</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/amko/' class=" post_tag button button_translucent" data-position=1 title="amko">AMKO<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/ansible/' class=" post_tag button button_translucent" data-position=1 title="ansible">ANSIBLE<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/antrea/' class=" post_tag button button_translucent" data-position=12 title="antrea">ANTREA<span class="button_tally">12</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/argocd/' class=" post_tag button button_translucent" data-position=1 title="argocd">ARGOCD<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/arista/' class=" post_tag button button_translucent" data-position=1 title="arista">ARISTA<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/authentication/' class=" post_tag button button_translucent" data-position=2 title="authentication">AUTHENTICATION<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/automation/' class=" post_tag button button_translucent" data-position=3 title="automation">AUTOMATION<span class="button_tally">3</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/autoscaling/' class=" post_tag button button_translucent" data-position=1 title="autoscaling">AUTOSCALING<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/availability/' class=" post_tag button button_translucent" data-position=3 title="availability">AVAILABILITY<span class="button_tally">3</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/avi/' class=" post_tag button button_translucent" data-position=7 title="avi">AVI<span class="button_tally">7</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/ceos/' class=" post_tag button button_translucent" data-position=1 title="ceos">CEOS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/cert-manager/' class=" post_tag button button_translucent" data-position=3 title="cert-manager">CERT-MANAGER<span class="button_tally">3</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/certificate/' class=" post_tag button button_translucent" data-position=1 title="certificate">CERTIFICATE<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/cilium/' class=" post_tag button button_translucent" data-position=1 title="cilium">CILIUM<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/cni/' class=" post_tag button button_translucent" data-position=4 title="cni">CNI<span class="button_tally">4</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/compliance/' class=" post_tag button button_translucent" data-position=1 title="compliance">COMPLIANCE<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/containerlab/' class=" post_tag button button_translucent" data-position=1 title="containerlab">CONTAINERLAB<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/custom-resource-definitions/' class=" post_tag button button_translucent" data-position=1 title="custom-resource-definitions">CUSTOM-RESOURCE-DEFINITIONS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/distributed-firewall/' class=" post_tag button button_translucent" data-position=1 title="distributed-firewall">DISTRIBUTED-FIREWALL<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/dns-service/' class=" post_tag button button_translucent" data-position=1 title="dns-service">DNS-SERVICE<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/docker/' class=" post_tag button button_translucent" data-position=2 title="docker">DOCKER<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/ebpf/' class=" post_tag button button_translucent" data-position=1 title="ebpf">EBPF<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/github/' class=" post_tag button button_translucent" data-position=1 title="github">GITHUB<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/gitops/' class=" post_tag button button_translucent" data-position=1 title="gitops">GITOPS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/gslb/' class=" post_tag button button_translucent" data-position=1 title="gslb">GSLB<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/harbor/' class=" post_tag button button_translucent" data-position=1 title="harbor">HARBOR<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/home-assistant/' class=" post_tag button button_translucent" data-position=1 title="home-assistant">HOME-ASSISTANT<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/hugo/' class=" post_tag button button_translucent" data-position=2 title="hugo">HUGO<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/ids/' class=" post_tag button button_translucent" data-position=1 title="ids">IDS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/informational/' class=" post_tag button button_translucent" data-position=2 title="informational">INFORMATIONAL<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/ingress/' class=" post_tag button button_translucent" data-position=5 title="ingress">INGRESS<span class="button_tally">5</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/ips/' class=" post_tag button button_translucent" data-position=1 title="ips">IPS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/keycloak/' class=" post_tag button button_translucent" data-position=1 title="keycloak">KEYCLOAK<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/kubernetes/' class=" post_tag button button_translucent" data-position=24 title="kubernetes">KUBERNETES<span class="button_tally">24</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/kubernetes-api-endpoint/' class=" post_tag button button_translucent" data-position=1 title="kubernetes-api-endpoint">KUBERNETES-API-ENDPOINT<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/kubernetes-management/' class=" post_tag button button_translucent" data-position=1 title="kubernetes-management">KUBERNETES-MANAGEMENT<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/kubespray/' class=" post_tag button button_translucent" data-position=1 title="kubespray">KUBESPRAY<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/lifecycle-management/' class=" post_tag button button_translucent" data-position=1 title="lifecycle-management">LIFECYCLE-MANAGEMENT<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/load-balancing/' class=" post_tag button button_translucent" data-position=1 title="load-balancing">LOAD-BALANCING<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/loadbalancer/' class=" post_tag button button_translucent" data-position=1 title="loadbalancer">LOADBALANCER<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/loadbalancing/' class=" post_tag button button_translucent" data-position=7 title="loadbalancing">LOADBALANCING<span class="button_tally">7</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/lodbalancing/' class=" post_tag button button_translucent" data-position=1 title="lodbalancing">LODBALANCING<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/management/' class=" post_tag button button_translucent" data-position=1 title="management">MANAGEMENT<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/multi-cluster/' class=" post_tag button button_translucent" data-position=1 title="multi-cluster">MULTI-CLUSTER<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/multi-dc/' class=" post_tag button button_translucent" data-position=1 title="multi-dc">MULTI-DC<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/multi-tenancy/' class=" post_tag button button_translucent" data-position=1 title="multi-tenancy">MULTI-TENANCY<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/network/' class=" post_tag button button_translucent" data-position=3 title="network">NETWORK<span class="button_tally">3</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/network-policies/' class=" post_tag button button_translucent" data-position=2 title="network-policies">NETWORK-POLICIES<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/networking/' class=" post_tag button button_translucent" data-position=5 title="networking">NETWORKING<span class="button_tally">5</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/neuvector/' class=" post_tag button button_translucent" data-position=1 title="neuvector">NEUVECTOR<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/nfs/' class=" post_tag button button_translucent" data-position=1 title="nfs">NFS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/nsx/' class=" post_tag button button_translucent" data-position=13 title="nsx">NSX<span class="button_tally">13</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/nsx-advanced-loadbalancer/' class=" post_tag button button_translucent" data-position=1 title="nsx advanced loadbalancer">NSX ADVANCED LOADBALANCER<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/nsx-alb/' class=" post_tag button button_translucent" data-position=1 title="nsx-alb">NSX-ALB<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/nsx-application-platform/' class=" post_tag button button_translucent" data-position=1 title="nsx-application-platform">NSX-APPLICATION-PLATFORM<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/nsx-t/' class=" post_tag button button_translucent" data-position=2 title="nsx-t">NSX-T<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/opentofu/' class=" post_tag button button_translucent" data-position=1 title="opentofu">OPENTOFU<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/persistent-storage/' class=" post_tag button button_translucent" data-position=1 title="persistent-storage">PERSISTENT-STORAGE<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/pinniped/' class=" post_tag button button_translucent" data-position=1 title="pinniped">PINNIPED<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/provisioning/' class=" post_tag button button_translucent" data-position=2 title="provisioning">PROVISIONING<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/proxmox/' class=" post_tag button button_translucent" data-position=1 title="proxmox">PROXMOX<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/proxy/' class=" post_tag button button_translucent" data-position=1 title="proxy">PROXY<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/pvc/' class=" post_tag button button_translucent" data-position=1 title="pvc">PVC<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/rancher/' class=" post_tag button button_translucent" data-position=1 title="rancher">RANCHER<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/rbac/' class=" post_tag button button_translucent" data-position=1 title="rbac">RBAC<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/registry/' class=" post_tag button button_translucent" data-position=1 title="registry">REGISTRY<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/rke2/' class=" post_tag button button_translucent" data-position=1 title="rke2">RKE2<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/security/' class=" post_tag button button_translucent" data-position=7 title="security">SECURITY<span class="button_tally">7</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/static-content-generator/' class=" post_tag button button_translucent" data-position=1 title="static-content-generator">STATIC-CONTENT-GENERATOR<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/static-site-generator/' class=" post_tag button button_translucent" data-position=1 title="static-site-generator">STATIC-SITE-GENERATOR<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/suse/' class=" post_tag button button_translucent" data-position=2 title="suse">SUSE<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/tanzu/' class=" post_tag button button_translucent" data-position=14 title="tanzu">TANZU<span class="button_tally">14</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/tanzu-kubernetes-grid/' class=" post_tag button button_translucent" data-position=1 title="tanzu-kubernetes-grid">TANZU-KUBERNETES-GRID<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/terraform/' class=" post_tag button button_translucent" data-position=1 title="terraform">TERRAFORM<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/tkg/' class=" post_tag button button_translucent" data-position=1 title="tkg">TKG<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/tkg-2.1/' class=" post_tag button button_translucent" data-position=1 title="tkg 2.1">TKG 2.1<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/tkgi/' class=" post_tag button button_translucent" data-position=1 title="tkgi">TKGI<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/tkgs/' class=" post_tag button button_translucent" data-position=1 title="tkgs">TKGS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/tmc/' class=" post_tag button button_translucent" data-position=1 title="tmc">TMC<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/tmc-local/' class=" post_tag button button_translucent" data-position=1 title="tmc-local">TMC-LOCAL<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/tmc-sm/' class=" post_tag button button_translucent" data-position=1 title="tmc-sm">TMC-SM<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/traefik/' class=" post_tag button button_translucent" data-position=1 title="traefik">TRAEFIK<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/troubleshooting/' class=" post_tag button button_translucent" data-position=2 title="troubleshooting">TROUBLESHOOTING<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/unifi/' class=" post_tag button button_translucent" data-position=1 title="unifi">UNIFI<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/veos/' class=" post_tag button button_translucent" data-position=1 title="veos">VEOS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/vmconaws/' class=" post_tag button button_translucent" data-position=1 title="vmconaws">VMCONAWS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/vsphere/' class=" post_tag button button_translucent" data-position=2 title="vsphere">VSPHERE<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/vsphere-replication/' class=" post_tag button button_translucent" data-position=1 title="vsphere-replication">VSPHERE-REPLICATION<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/vsphere-with-tanzu/' class=" post_tag button button_translucent" data-position=1 title="vsphere-with-tanzu">VSPHERE-WITH-TANZU<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/zwave/' class=" post_tag button button_translucent" data-position=1 title="zwave">ZWAVE<span class="button_tally">1</span>
            </a>
            
            <div class="tags_sort"><span title="sort alphabetically">[A~Z]</span><span title="sort by count">[0~9]</span>
            </div>
            <span class="tags_hide"><svg class="icon">
            <use xlink:href="#closeme"></use>
          </svg></span>
          </div>
        </div>
      </nav>
    </div>
  </section>
</aside>

  
</div>
    </main><svg width="0" height="0" class="hidden">
  <symbol viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" id="facebook">
    <path d="M437 0H75C33.648 0 0 33.648 0 75v362c0 41.352 33.648 75 75 75h151V331h-60v-90h60v-61c0-49.629 40.371-90 90-90h91v90h-91v61h91l-15 90h-76v181h121c41.352 0 75-33.648 75-75V75c0-41.352-33.648-75-75-75zm0 0"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18.001 18.001" id="twitter">
    <path d="M15.891 4.013c.808-.496 1.343-1.173 1.605-2.034a8.68 8.68 0 0 1-2.351.861c-.703-.756-1.593-1.14-2.66-1.14-1.043 0-1.924.366-2.643 1.078a3.56 3.56 0 0 0-1.076 2.605c0 .309.039.585.117.819-3.076-.105-5.622-1.381-7.628-3.837-.34.601-.51 1.213-.51 1.846 0 1.301.549 2.332 1.645 3.089-.625-.053-1.176-.211-1.645-.47 0 .929.273 1.705.82 2.388a3.623 3.623 0 0 0 2.115 1.291c-.312.08-.641.118-.979.118-.312 0-.533-.026-.664-.083.23.757.664 1.371 1.291 1.841a3.652 3.652 0 0 0 2.152.743C4.148 14.173 2.625 14.69.902 14.69c-.422 0-.721-.006-.902-.038 1.697 1.102 3.586 1.649 5.676 1.649 2.139 0 4.029-.542 5.674-1.626 1.645-1.078 2.859-2.408 3.639-3.974a10.77 10.77 0 0 0 1.172-4.892v-.468a7.788 7.788 0 0 0 1.84-1.921 8.142 8.142 0 0 1-2.11.593z"
      ></path>
  </symbol>
  <symbol aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id="mail">
    <path  d="M502.3 190.8c3.9-3.1 9.7-.2 9.7 4.7V400c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V195.6c0-5 5.7-7.8 9.7-4.7 22.4 17.4 52.1 39.5 154.1 113.6 21.1 15.4 56.7 47.8 92.2 47.6 35.7.3 72-32.8 92.3-47.6 102-74.1 131.6-96.3 154-113.7zM256 320c23.2.4 56.6-29.2 73.4-41.4 132.7-96.3 142.8-104.7 173.4-128.7 5.8-4.5 9.2-11.5 9.2-18.9v-19c0-26.5-21.5-48-48-48H48C21.5 64 0 85.5 0 112v19c0 7.4 3.4 14.3 9.2 18.9 30.6 23.9 40.7 32.4 173.4 128.7 16.8 12.2 50.2 41.8 73.4 41.4z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id="calendar">
    <path d="M452 40h-24V0h-40v40H124V0H84v40H60C26.916 40 0 66.916 0 100v352c0 33.084 26.916 60 60 60h392c33.084 0 60-26.916 60-60V100c0-33.084-26.916-60-60-60zm20 412c0 11.028-8.972 20-20 20H60c-11.028 0-20-8.972-20-20V188h432v264zm0-304H40v-48c0-11.028 8.972-20 20-20h24v40h40V80h264v40h40V80h24c11.028 0 20 8.972 20 20v48z"></path>
    <path d="M76 230h40v40H76zm80 0h40v40h-40zm80 0h40v40h-40zm80 0h40v40h-40zm80 0h40v40h-40zM76 310h40v40H76zm80 0h40v40h-40zm80 0h40v40h-40zm80 0h40v40h-40zM76 390h40v40H76zm80 0h40v40h-40zm80 0h40v40h-40zm80 0h40v40h-40zm80-80h40v40h-40z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id="github">
    <path d="M255.968 5.329C114.624 5.329 0 120.401 0 262.353c0 113.536 73.344 209.856 175.104 243.872 12.8 2.368 17.472-5.568 17.472-12.384 0-6.112-.224-22.272-.352-43.712-71.2 15.52-86.24-34.464-86.24-34.464-11.616-29.696-28.416-37.6-28.416-37.6-23.264-15.936 1.728-15.616 1.728-15.616 25.696 1.824 39.2 26.496 39.2 26.496 22.848 39.264 59.936 27.936 74.528 21.344 2.304-16.608 8.928-27.936 16.256-34.368-56.832-6.496-116.608-28.544-116.608-127.008 0-28.064 9.984-51.008 26.368-68.992-2.656-6.496-11.424-32.64 2.496-68 0 0 21.504-6.912 70.4 26.336 20.416-5.696 42.304-8.544 64.096-8.64 21.728.128 43.648 2.944 64.096 8.672 48.864-33.248 70.336-26.336 70.336-26.336 13.952 35.392 5.184 61.504 2.56 68 16.416 17.984 26.304 40.928 26.304 68.992 0 98.72-59.84 120.448-116.864 126.816 9.184 7.936 17.376 23.616 17.376 47.584 0 34.368-.32 62.08-.32 70.496 0 6.88 4.608 14.88 17.6 12.352C438.72 472.145 512 375.857 512 262.353 512 120.401 397.376 5.329 255.968 5.329z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 212 212" id="gitlab">
    <path d="M12.3 74.7h54L43.3 3c-1-3.6-6.4-3.6-7.6 0L12.3 74.8z" />
    <path d="M12.3 74.7L.5 111c-1 3.2 0 6.8 3 8.8l101.6 74-92.5-119z"/>
    <path d="M105 193.7l-38.6-119h-54l92.7 119z"/>
    <path d="M105 193.7l38.7-119H66.4l38.7 119z"/>
    <path d="M105 193.7l38.7-119H198l-93 119z"/>
    <path d="M198 74.7l11.6 36.2c1 3 0 6.6-3 8.6l-101.5 74 93-119z"/>
    <path d="M198 74.7h-54.3L167 3c1.2-3.6 6.4-3.6 7.6 0L198 74.8z"/> 
  </symbol>
  <symbol viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" id="rss">
    <circle cx="3.429" cy="20.571" r="3.429"></circle>
    <path d="M11.429 24h4.57C15.999 15.179 8.821 8.001 0 8v4.572c6.302.001 11.429 5.126 11.429 11.428z"></path>
    <path d="M24 24C24 10.766 13.234 0 0 0v4.571c10.714 0 19.43 8.714 19.43 19.429z"></path>
  </symbol>
  <symbol viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" id="linkedin">
    <path d="M437 0H75C33.648 0 0 33.648 0 75v362c0 41.352 33.648 75 75 75h362c41.352 0 75-33.648 75-75V75c0-41.352-33.648-75-75-75zM181 406h-60V196h60zm0-240h-60v-60h60zm210 240h-60V286c0-16.54-13.46-30-30-30s-30 13.46-30 30v120h-60V196h60v11.309C286.719 202.422 296.93 196 316 196c40.691.043 75 36.547 75 79.688zm0 0"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 612 612" id="to-top">
    <path d="M604.501 440.509L325.398 134.956c-5.331-5.357-12.423-7.627-19.386-7.27-6.989-.357-14.056 1.913-19.387 7.27L7.499 440.509c-9.999 10.024-9.999 26.298 0 36.323s26.223 10.024 36.222 0l262.293-287.164L568.28 476.832c9.999 10.024 26.222 10.024 36.221 0 9.999-10.023 9.999-26.298 0-36.323z"></path>
  </symbol>
  <symbol viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" id="carly">
    <path d="M504.971 239.029L448 182.059V84c0-46.317-37.682-84-84-84h-44c-13.255 0-24 10.745-24 24s10.745 24 24 24h44c19.851 0 36 16.149 36 36v108c0 6.365 2.529 12.47 7.029 16.971L454.059 256l-47.029 47.029A24.002 24.002 0 0 0 400 320v108c0 19.851-16.149 36-36 36h-44c-13.255 0-24 10.745-24 24s10.745 24 24 24h44c46.318 0 84-37.683 84-84v-98.059l56.971-56.971c9.372-9.372 9.372-24.568 0-33.941zM112 192V84c0-19.851 16.149-36 36-36h44c13.255 0 24-10.745 24-24S205.255 0 192 0h-44c-46.318 0-84 37.683-84 84v98.059l-56.971 56.97c-9.373 9.373-9.373 24.568 0 33.941L64 329.941V428c0 46.317 37.682 84 84 84h44c13.255 0 24-10.745 24-24s-10.745-24-24-24h-44c-19.851 0-36-16.149-36-36V320c0-6.365-2.529-12.47-7.029-16.971L57.941 256l47.029-47.029A24.002 24.002 0 0 0 112 192z"></path>
  </symbol>
  <symbol viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" id="copy">
    <path d="M23 2.75A2.75 2.75 0 0 0 20.25 0H8.75A2.75 2.75 0 0 0 6 2.75v13.5A2.75 2.75 0 0 0 8.75 19h11.5A2.75 2.75 0 0 0 23 16.25zM18.25 14.5h-7.5a.75.75 0 0 1 0-1.5h7.5a.75.75 0 0 1 0 1.5zm0-3h-7.5a.75.75 0 0 1 0-1.5h7.5a.75.75 0 0 1 0 1.5zm0-3h-7.5a.75.75 0 0 1 0-1.5h7.5a.75.75 0 0 1 0 1.5z"></path>
    <path d="M8.75 20.5a4.255 4.255 0 0 1-4.25-4.25V2.75c0-.086.02-.166.025-.25H3.75A2.752 2.752 0 0 0 1 5.25v16A2.752 2.752 0 0 0 3.75 24h12a2.752 2.752 0 0 0 2.75-2.75v-.75z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512.001 512.001" id="closeme">
    <path d="M284.286 256.002L506.143 34.144c7.811-7.811 7.811-20.475 0-28.285-7.811-7.81-20.475-7.811-28.285 0L256 227.717 34.143 5.859c-7.811-7.811-20.475-7.811-28.285 0-7.81 7.811-7.811 20.475 0 28.285l221.857 221.857L5.858 477.859c-7.811 7.811-7.811 20.475 0 28.285a19.938 19.938 0 0 0 14.143 5.857 19.94 19.94 0 0 0 14.143-5.857L256 284.287l221.857 221.857c3.905 3.905 9.024 5.857 14.143 5.857s10.237-1.952 14.143-5.857c7.811-7.811 7.811-20.475 0-28.285L284.286 256.002z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id="open-menu">
    <path d="M492 236H20c-11.046 0-20 8.954-20 20s8.954 20 20 20h472c11.046 0 20-8.954 20-20s-8.954-20-20-20zm0-160H20C8.954 76 0 84.954 0 96s8.954 20 20 20h472c11.046 0 20-8.954 20-20s-8.954-20-20-20zm0 320H20c-11.046 0-20 8.954-20 20s8.954 20 20 20h472c11.046 0 20-8.954 20-20s-8.954-20-20-20z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="instagram">
    <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id=youtube>
    <path d="M19.615 3.184c-3.604-.246-11.631-.245-15.23 0-3.897.266-4.356 2.62-4.385 8.816.029 6.185.484 8.549 4.385 8.816 3.6.245 11.626.246 15.23 0 3.897-.266 4.356-2.62 4.385-8.816-.029-6.185-.484-8.549-4.385-8.816zm-10.615 12.816v-8l8 3.993-8 4.007z"/>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="stackoverflow">
    <path d="M21 27v-8h3v11H0V19h3v8h18z"></path><path d="M17.1.2L15 1.8l7.9 10.6 2.1-1.6L17.1.2zm3.7 14.7L10.6 6.4l1.7-2 10.2 8.5-1.7 2zM7.2 12.3l12 5.6 1.1-2.4-12-5.6-1.1 2.4zm-1.8 6.8l13.56 1.96.17-2.38-13.26-2.55-.47 2.97zM19 25H5v-3h14v3z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="xing">
    <path d="M18.188 0c-.517 0-.741.325-.927.66 0 0-7.455 13.224-7.702 13.657.015.024 4.919 9.023 4.919 9.023.17.308.436.66.967.66h3.454c.211 0 .375-.078.463-.22.089-.151.089-.346-.009-.536l-4.879-8.916c-.004-.006-.004-.016 0-.022L22.139.756c.095-.191.097-.387.006-.535C22.056.078 21.894 0 21.686 0h-3.498zM3.648 4.74c-.211 0-.385.074-.473.216-.09.149-.078.339.02.531l2.34 4.05c.004.01.004.016 0 .021L1.86 16.051c-.099.188-.093.381 0 .529.085.142.239.234.45.234h3.461c.518 0 .766-.348.945-.667l3.734-6.609-2.378-4.155c-.172-.315-.434-.659-.962-.659H3.648v.016z"/>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 71 55" id="discord">
    <path d="M60.1045 4.8978C55.5792 2.8214 50.7265 1.2916 45.6527 0.41542C45.5603 0.39851 45.468 0.440769 45.4204 0.525289C44.7963 1.6353 44.105 3.0834 43.6209 4.2216C38.1637 3.4046 32.7345 3.4046 27.3892 4.2216C26.905 3.0581 26.1886 1.6353 25.5617 0.525289C25.5141 0.443589 25.4218 0.40133 25.3294 0.41542C20.2584 1.2888 15.4057 2.8186 10.8776 4.8978C10.8384 4.9147 10.8048 4.9429 10.7825 4.9795C1.57795 18.7309 -0.943561 32.1443 0.293408 45.3914C0.299005 45.4562 0.335386 45.5182 0.385761 45.5576C6.45866 50.0174 12.3413 52.7249 18.1147 54.5195C18.2071 54.5477 18.305 54.5139 18.3638 54.4378C19.7295 52.5728 20.9469 50.6063 21.9907 48.5383C22.0523 48.4172 21.9935 48.2735 21.8676 48.2256C19.9366 47.4931 18.0979 46.6 16.3292 45.5858C16.1893 45.5041 16.1781 45.304 16.3068 45.2082C16.679 44.9293 17.0513 44.6391 17.4067 44.3461C17.471 44.2926 17.5606 44.2813 17.6362 44.3151C29.2558 49.6202 41.8354 49.6202 53.3179 44.3151C53.3935 44.2785 53.4831 44.2898 53.5502 44.3433C53.9057 44.6363 54.2779 44.9293 54.6529 45.2082C54.7816 45.304 54.7732 45.5041 54.6333 45.5858C52.8646 46.6197 51.0259 47.4931 49.0921 48.2228C48.9662 48.2707 48.9102 48.4172 48.9718 48.5383C50.038 50.6034 51.2554 52.5699 52.5959 54.435C52.6519 54.5139 52.7526 54.5477 52.845 54.5195C58.6464 52.7249 64.529 50.0174 70.6019 45.5576C70.6551 45.5182 70.6887 45.459 70.6943 45.3942C72.1747 30.0791 68.2147 16.7757 60.1968 4.9823C60.1772 4.9429 60.1437 4.9147 60.1045 4.8978ZM23.7259 37.3253C20.2276 37.3253 17.3451 34.1136 17.3451 30.1693C17.3451 26.225 20.1717 23.0133 23.7259 23.0133C27.308 23.0133 30.1626 26.2532 30.1066 30.1693C30.1066 34.1136 27.28 37.3253 23.7259 37.3253ZM47.3178 37.3253C43.8196 37.3253 40.9371 34.1136 40.9371 30.1693C40.9371 26.225 43.7636 23.0133 47.3178 23.0133C50.9 23.0133 53.7545 26.2532 53.6986 30.1693C53.6986 34.1136 50.9 37.3253 47.3178 37.3253Z"/>
  </symbol>
</svg>


<footer class="footer">
  <div class="footer_inner wrap pale">
    <img src='https://blog.andreasm.io/icons/apple-touch-icon.png' class="icon icon_2 transparent" alt="From 0.985mhz... to several Ghz">
    <p>Copyright&nbsp;2016-&nbsp;<span class="year"></span>&nbsp;FROM 0.985MHZ... TO SEVERAL GHZ. All Rights Reserved</p><a class="to_top" href="#documentTop">
  <svg class="icon">
  <title>to-top</title>
  <use xlink:href="#to-top"></use>
</svg>

</a>

  </div>
</footer>

<script type="text/javascript" src="https://blog.andreasm.io/en/js/bundle.5548d358738600c857a1f05f0459418da7143d4426c66a08bf3f15ded1b39dd2136bf104a559247a909fc4dcc45b8e06bad0870ece4c71ee5303d30550def8bd.js" integrity="sha512-VUjTWHOGAMhXofBfBFlBjacUPUQmxmoIvz8V3tGzndITa/EEpVkkepCfxNzEW44GutCHDs5Mce5TA9MFUN74vQ==" crossorigin="anonymous"></script>

  <script src="https://blog.andreasm.io/js/search.min.95a6a82b7db565e9830200f15d8809e9663868dd57209f6f86afd54bb19568b9fbdfb9b479ebcc5d37e3b2e2136e396c05135d268cd68b21728a0bc176a8a809.js"></script>

  </body>
</html>
