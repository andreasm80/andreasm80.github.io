<!DOCTYPE html>
<html lang="en" dir="ltr" class="scroll-smooth" data-default-appearance="dark"
  data-auto-appearance="true"><head>
  <meta charset="utf-8" />
  
  <meta http-equiv="content-language" content="en" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  
  <title>TKG 2.3 deployment in multiple availability zones &middot; blog.andreasm.io</title>
  <meta name="title" content="TKG 2.3 deployment in multiple availability zones &middot; blog.andreasm.io" />
  
  <meta name="description" content="In this post I will go through how to configure and deploy TKG 2.3 in mutliple availability zones using vSphere clusters and how to reconfigure already deployed TKG cluster to new availability zones." />
  <meta name="keywords" content="tanzu-kubernetes-grid, availability, " />
  
  
  <link rel="canonical" href="https://blog.andreasm.io/2023/08/29/tkg-2.3-deployment-in-multiple-availability-zones/" />
  
  
  
  
  
  
  
  
  
  
  
  
  <link type="text/css" rel="stylesheet" href="/css/main.bundle.min.48d290696564c2380c4233780f3fd414aa6e2b0b67ed916e9d918c48c05f5b20b641bf892fadd408e43ec21d2feb2ec1fe6fd1f021df2806a254977fe2f80a64.css"
    integrity="sha512-SNKQaWVkwjgMQjN4Dz/UFKpuKwtn7ZFunZGMSMBfWyC2Qb&#43;JL63UCOQ&#43;wh0v6y7B/m/R8CHfKAaiVJd/4vgKZA==" />
  
  
  <script type="text/javascript" src="/js/appearance.min.a85bd6dc99d1fecae166deb56a1fee6375588c72533c4b8c690e4a9ec5a04174ff780e41e2ac770382a8e67818cb2b89766afa3e23965c9102424a080dafbb0c.js"
    integrity="sha512-qFvW3JnR/srhZt61ah/uY3VYjHJTPEuMaQ5KnsWgQXT/eA5B4qx3A4Ko5ngYyyuJdmr6PiOWXJECQkoIDa&#43;7DA=="></script>
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <script defer type="text/javascript" id="script-bundle" src="/js/main.bundle.min.a2d78d78672e549fbfc972ece871725b5478ba0b65708dda20cb97ab80a865eae6d247e1b05a4aec6ebbf78647ec3233bad8b2609ed98eee53cd58aa17128bc7.js"
    integrity="sha512-oteNeGcuVJ&#43;/yXLs6HFyW1R4ugtlcI3aIMuXq4CoZerm0kfhsFpK7G6794ZH7DIzutiyYJ7Zju5TzViqFxKLxw==" data-copy="" data-copied=""></script>
  
  
  
  <script src="/lib/zoom/zoom.min.37d2094687372da3f7343a221a470f6b8806f7891aa46a5a03966af7f0ebd38b9fe536cb154e6ad28f006d184b294525a7c4054b6bbb4be62d8b453b42db99bd.js" integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S&#43;Yti0U7QtuZvQ=="></script>
  
  
  
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
  <link rel="manifest" href="/site.webmanifest" />
  
  
  
  
  
  
  
  
  <meta property="og:url" content="https://blog.andreasm.io/2023/08/29/tkg-2.3-deployment-in-multiple-availability-zones/">
  <meta property="og:site_name" content="blog.andreasm.io">
  <meta property="og:title" content="TKG 2.3 deployment in multiple availability zones">
  <meta property="og:description" content="How to configure TKG with multiple AZs">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2023-08-29T13:27:52+02:00">
    <meta property="article:modified_time" content="2023-08-29T13:27:52+02:00">
    <meta property="article:tag" content="Tanzu-Kubernetes-Grid">
    <meta property="article:tag" content="Availability">
    <meta property="og:image" content="https://blog.andreasm.io/2023/08/29/tkg-2.3-deployment-in-multiple-availability-zones/feature-vmware_by_broadcom.png">

  
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://blog.andreasm.io/2023/08/29/tkg-2.3-deployment-in-multiple-availability-zones/feature-vmware_by_broadcom.png">
  <meta name="twitter:title" content="TKG 2.3 deployment in multiple availability zones">
  <meta name="twitter:description" content="How to configure TKG with multiple AZs">

  
  <script type="application/ld+json">
  [{
    "@context": "https://schema.org",
    "@type": "Article",
    "articleSection": "Posts",
    "name": "TKG 2.3 deployment in multiple availability zones",
    "headline": "TKG 2.3 deployment in multiple availability zones",
    "description": "How to configure TKG with multiple AZs",
    "abstract": "In this post I will go through how to configure and deploy TKG 2.3 in mutliple availability zones using vSphere clusters and how to reconfigure already deployed TKG cluster to new availability zones.",
    "inLanguage": "en",
    "url" : "https:\/\/blog.andreasm.io\/2023\/08\/29\/tkg-2.3-deployment-in-multiple-availability-zones\/",
    "author" : {
      "@type": "Person",
      "name": "Andreas Marqvardsen"
    },
    "copyrightYear": "2023",
    "dateCreated": "2023-08-29T13:27:52\u002b02:00",
    "datePublished": "2023-08-29T13:27:52\u002b02:00",
    
    "dateModified": "2023-08-29T13:27:52\u002b02:00",
    
    "keywords": ["tanzu-kubernetes-grid","availability"],
    
    "mainEntityOfPage": "true",
    "wordCount": "7729"
  }]
  </script>


  
  
  <meta name="author" content="Andreas Marqvardsen" />
  
  
  
  <link href="mailto:andreas.marqvardsen[AT]gmail.com" rel="me" />
  
  
  <link href="https://blog.andreasm.io/" rel="me" />
  
  
  <link href="https://github.com/andreasm80" rel="me" />
  
  
  <link href="https://linkedin.com/in/andreas-marqvardsen" rel="me" />
  
  
  <link href="https://vmst.io/@andreasm" rel="me" />
  
  
  <link href="https://x.com/NATsoFast" rel="me" />
  
  
  
  

<script src="/lib/jquery/jquery.slim.min.b0dca576e87d7eaa5850ae4e61759c065786cdb6489d68fcc82240539eebd5da522bdb4fda085ffd245808c8fe2acb2516408eb774ef26b5f6015fc6737c0ea8.js" integrity="sha512-sNylduh9fqpYUK5OYXWcBleGzbZInWj8yCJAU57r1dpSK9tP2ghf/SRYCMj&#43;KsslFkCOt3TvJrX2AV/Gc3wOqA=="></script>






















  
  

<script async src="https://www.googletagmanager.com/gtag/js?id=G-TVPYDVE8KR"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-TVPYDVE8KR');
</script>



  
  
  <meta name="theme-color"/>
  
  
</head>
<body
  class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32 scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600">
  <div id="the-top" class="absolute flex self-center">
    <a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600"
      href="#main-content"><span
        class="font-bold text-primary-600 ltr:pr-2 rtl:pl-2 dark:text-primary-400">&darr;</span>Skip to main content</a>
  </div>
  
  
  <div class="min-h-[148px]"></div>
<div class="fixed inset-x-0 pl-[24px] pr-[24px]" style="z-index:100">
  <div id="menu-blur" class="absolute opacity-0 inset-x-0 top-0 h-full single_hero_background nozoom backdrop-blur-2xl shadow-2xl"></div>
  <div class="relative max-w-[64rem] ml-auto mr-auto">
    <div style="padding-left:0;padding-right:0;padding-top:2px;padding-bottom:3px"
    class="main-menu flex items-center justify-between px-4 py-6 sm:px-6 md:justify-start space-x-3">
    
    
    
    <div>
        <a href="/" class="flex">
            <span class="sr-only">blog.andreasm.io</span>

            
            <img src="/ynwa2.png" width="300" height="342"
                class="logo max-h-[5rem] max-w-[5rem] object-scale-down object-left nozoom" alt="blog.andreasm.io" />
            

        </a>
    </div>
    
    <div class="flex flex-1 items-center justify-between">
        <nav class="flex space-x-3">

            
            <a href="/" class="text-base font-medium text-gray-500 hover:text-gray-900">blog.andreasm.io</a>
            

        </nav>
        <nav class="hidden md:flex items-center space-x-5 md:ml-12 h-12">

            
            
            
  <a href="/posts/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
    
    <p class="text-base font-medium" title="">
        Posts
    </p>
</a>



            
            
  <a href="/about/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
    
    <p class="text-base font-medium" title="">
        About
    </p>
</a>



            
            
  <a href="/categories/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
    
    <p class="text-base font-medium" title="">
        Categories
    </p>
</a>



            
            
  <a href="/tags/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
    
    <p class="text-base font-medium" title="">
        Tags
    </p>
</a>



            
            

            


            
            <button id="search-button" aria-label="Search" class="text-base hover:text-primary-600 dark:hover:text-primary-400"
                title="">
                

  <span class="relative block icon">
    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>

  </span>


            </button>
            


            
            
            <div
                class="ltr:mr-14 rtl:ml-14 flex items-center">
                <button id="appearance-switcher" aria-label="Dark mode switcher" type="button" class="text-base hover:text-primary-600 dark:hover:text-primary-400">
                    <div class="flex items-center justify-center dark:hidden">
                        

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M32 256c0-123.8 100.3-224 223.8-224c11.36 0 29.7 1.668 40.9 3.746c9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3c9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480C132.1 480 32 379.6 32 256z"/></svg>

  </span>


                    </div>
                    <div class="items-center justify-center hidden dark:flex">
                        

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02 0-95.1 42.98-95.1 95.1S202.1 351.1 256 351.1s95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347L446.1 255.1l63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7l-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89L164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6L12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256l-63.15 91.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7l19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109l109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69 0-127.1-57.31-127.1-127.1c0-70.69 57.31-127.1 127.1-127.1s127.1 57.3 127.1 127.1C383.1 326.7 326.7 383.1 256 383.1z"/></svg>

  </span>


                    </div>
                </button>
            </div>
            

        </nav>
        <div class="flex md:hidden items-center space-x-5 md:ml-12 h-12">

            <span></span>

            


            
            <button id="search-button-mobile" aria-label="Search" class="text-base hover:text-primary-600 dark:hover:text-primary-400"
                title="">
                

  <span class="relative block icon">
    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>

  </span>


            </button>
            

            
            
            <button id="appearance-switcher-mobile" aria-label="Dark mode switcher" type="button" class="text-base hover:text-primary-600 dark:hover:text-primary-400" style="margin-right:5px">
                <div class="flex items-center justify-center dark:hidden">
                    

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M32 256c0-123.8 100.3-224 223.8-224c11.36 0 29.7 1.668 40.9 3.746c9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3c9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480C132.1 480 32 379.6 32 256z"/></svg>

  </span>


                </div>
                <div class="items-center justify-center hidden dark:flex">
                    

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02 0-95.1 42.98-95.1 95.1S202.1 351.1 256 351.1s95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347L446.1 255.1l63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7l-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89L164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6L12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256l-63.15 91.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7l19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109l109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69 0-127.1-57.31-127.1-127.1c0-70.69 57.31-127.1 127.1-127.1s127.1 57.3 127.1 127.1C383.1 326.7 326.7 383.1 256 383.1z"/></svg>

  </span>


                </div>
            </button>
            

        </div>
    </div>
    <div class="-my-2 -mr-2 md:hidden">

        <label id="menu-button" class="block">
            
            <div class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400">
                

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M0 96C0 78.33 14.33 64 32 64H416C433.7 64 448 78.33 448 96C448 113.7 433.7 128 416 128H32C14.33 128 0 113.7 0 96zM0 256C0 238.3 14.33 224 32 224H416C433.7 224 448 238.3 448 256C448 273.7 433.7 288 416 288H32C14.33 288 0 273.7 0 256zM416 448H32C14.33 448 0 433.7 0 416C0 398.3 14.33 384 32 384H416C433.7 384 448 398.3 448 416C448 433.7 433.7 448 416 448z"/></svg>

  </span>


            </div>
            <div id="menu-wrapper" style="padding-top:5px;"
                class="fixed inset-0 z-30 invisible w-screen h-screen m-0 overflow-auto transition-opacity opacity-0 cursor-default bg-neutral-100/50 backdrop-blur-sm dark:bg-neutral-900/50">
                <ul
                    class="flex space-y-2 mt-3 flex-col items-end w-full px-6 py-6 mx-auto overflow-visible list-none ltr:text-right rtl:text-left max-w-7xl">

                    <li id="menu-close-button">
                        <span
                            class="cursor-pointer inline-block align-text-bottom hover:text-primary-600 dark:hover:text-primary-400">

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75 0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3L54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75 0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75 0-45.25s32.75-12.5 45.25 0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25 0s12.5 32.75 0 45.25l-105.4 105.4L310.6 361.4z"/></svg>

  </span>

</span>
                    </li>

                    

                    
  <li class="mt-1">
    <a href="/posts/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
        
        <p class="text-bg font-bg" title="">
            Posts
        </p>
    </a>
</li>




                    

                    
  <li class="mt-1">
    <a href="/about/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
        
        <p class="text-bg font-bg" title="">
            About
        </p>
    </a>
</li>




                    

                    
  <li class="mt-1">
    <a href="/categories/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
        
        <p class="text-bg font-bg" title="">
            Categories
        </p>
    </a>
</li>




                    

                    
  <li class="mt-1">
    <a href="/tags/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
        
        <p class="text-bg font-bg" title="">
            Tags
        </p>
    </a>
</li>




                    

                </ul>
                
                

            </div>
        </label>
    </div>
</div>




<script>
    (function () {
        var $mainmenu = $('.main-menu');
        var path = window.location.pathname;
        $mainmenu.find('a[href="' + path + '"]').each(function (i, e) {
            $(e).children('p').addClass('active');
        });
    })();
</script>


  </div>
</div>
<script>
  window.addEventListener('scroll', function (e) {
    var scroll = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop || 0;
    var background_blur = document.getElementById('menu-blur');
    background_blur.style.opacity = (scroll / 300);
  });
</script>

  
  <div class="relative flex flex-col grow">
    <main id="main-content" class="grow">
      


<article>
  
  
  
  
  
  


<div id="hero" class="h-[150px] md:h-[200px]"></div>



    
    <div class="fixed inset-x-0 top-0 h-[800px] single_hero_background nozoom"
    style="background-image:url(/2023/08/29/tkg-2.3-deployment-in-multiple-availability-zones/feature-vmware_by_broadcom.png);">
    


    <div class="absolute inset-0 bg-gradient-to-t from-neutral dark:from-neutral-800 to-transparent mix-blend-normal">
    </div>
    <div
        class="absolute inset-0 opacity-60 bg-gradient-to-t from-neutral dark:from-neutral-800 to-neutral-100 dark:to-neutral-800 mix-blend-normal">
    </div>
</div>

<div id="background-blur" class="fixed opacity-0 inset-x-0 top-0 h-full single_hero_background nozoom backdrop-blur-2xl"></div>
<script>
    window.addEventListener('scroll', function (e) {
        var scroll = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop || 0;
        var background_blur = document.getElementById('background-blur');
        background_blur.style.opacity = (scroll / 300)
    });
</script>

  
  

  <header id="single_header" class="mt-5 max-w-prose">
    
    <ol class="text-sm text-neutral-500 dark:text-neutral-400 print:hidden">
  
  
    
  
    
  
  <li class="inline hidden">
    <a
      class="hover:underline decoration-neutral-300 dark:underline-neutral-600"
      href="/"
      >blog.andreasm.io</a
    ><span class="px-1 text-primary-500">/</span>
  </li>

  
  <li class="inline ">
    <a
      class="hover:underline decoration-neutral-300 dark:underline-neutral-600"
      href="/posts/"
      >Posts</a
    ><span class="px-1 text-primary-500">/</span>
  </li>

  
  <li class="inline hidden">
    <a
      class="hover:underline decoration-neutral-300 dark:underline-neutral-600"
      href="/2023/08/29/tkg-2.3-deployment-in-multiple-availability-zones/"
      >TKG 2.3 deployment in multiple availability zones</a
    ><span class="px-1 text-primary-500">/</span>
  </li>

</ol>


    
    <h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">
      TKG 2.3 deployment in multiple availability zones
    </h1>
    <div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden">
      





  
  







  





  



  













<div class="flex flex-row flex-wrap items-center">
  
  
  <time datetime="2023-08-29T13:27:52&#43;02:00">29 August 2023</time><span class="px-2 text-primary-500">&middot;</span><span>7729 words</span><span class="px-2 text-primary-500">&middot;</span><span title="Reading time">37 mins</span>
  

  
  
</div>


<div class="flex flex-row flex-wrap items-center">
  
  
  
  
  
  
  
  
  
  
  
</div>




<div class="flex flex-row flex-wrap items-center">
  
  
  
  
  
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/kubernetes/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Kubernetes
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/tkg/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    TKG
  </span>
</span>
  </span>
  
  
  
  
  
  
  
  
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/tanzu-kubernetes-grid/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Tanzu-Kubernetes-Grid
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/availability/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Availability
  </span>
</span>
  </span>
  
  
  
  
</div>




    </div>

    
    
    
    
    

    

    
      
      
        
        
<div class="flex author">
  
    
    
      
    
    
      
      <img class="!mt-0 !mb-0 h-24 w-24 rounded-full ltr:mr-4 rtl:ml-4" width="96" height="96"
      alt="Andreas Marqvardsen" src="/profile.png" />
    
  
  <div class="place-self-center">
    
    <div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">
      Author
    </div>
    <div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">
      Andreas Marqvardsen
    </div>
    
    
    <div class="text-sm text-neutral-700 dark:text-neutral-400">Always curious, always learning</div>
    
    <div class="text-2xl sm:text-lg">
  <div class="flex flex-wrap text-neutral-400 dark:text-neutral-500">
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="mailto:andreas.marqvardsen[AT]gmail.com"
          target="_blank"
          aria-label="Email"
          rel="me noopener noreferrer"
          ><span class="inline-block align-text-bottom">

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M207.8 20.73c-93.45 18.32-168.7 93.66-187 187.1c-27.64 140.9 68.65 266.2 199.1 285.1c19.01 2.888 36.17-12.26 36.17-31.49l.0001-.6631c0-15.74-11.44-28.88-26.84-31.24c-84.35-12.98-149.2-86.13-149.2-174.2c0-102.9 88.61-185.5 193.4-175.4c91.54 8.869 158.6 91.25 158.6 183.2l0 16.16c0 22.09-17.94 40.05-40 40.05s-40.01-17.96-40.01-40.05v-120.1c0-8.847-7.161-16.02-16.01-16.02l-31.98 .0036c-7.299 0-13.2 4.992-15.12 11.68c-24.85-12.15-54.24-16.38-86.06-5.106c-38.75 13.73-68.12 48.91-73.72 89.64c-9.483 69.01 43.81 128 110.9 128c26.44 0 50.43-9.544 69.59-24.88c24 31.3 65.23 48.69 109.4 37.49C465.2 369.3 496 324.1 495.1 277.2V256.3C495.1 107.1 361.2-9.332 207.8 20.73zM239.1 304.3c-26.47 0-48-21.56-48-48.05s21.53-48.05 48-48.05s48 21.56 48 48.05S266.5 304.3 239.1 304.3z"/></svg>

  </span>

</span></a
        >
      
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="https://blog.andreasm.io/"
          target="_blank"
          aria-label="Link"
          rel="me noopener noreferrer"
          ><span class="inline-block align-text-bottom">

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><path fill="currentColor" d="M172.5 131.1C228.1 75.51 320.5 75.51 376.1 131.1C426.1 181.1 433.5 260.8 392.4 318.3L391.3 319.9C381 334.2 361 337.6 346.7 327.3C332.3 317 328.9 297 339.2 282.7L340.3 281.1C363.2 249 359.6 205.1 331.7 177.2C300.3 145.8 249.2 145.8 217.7 177.2L105.5 289.5C73.99 320.1 73.99 372 105.5 403.5C133.3 431.4 177.3 435 209.3 412.1L210.9 410.1C225.3 400.7 245.3 404 255.5 418.4C265.8 432.8 262.5 452.8 248.1 463.1L246.5 464.2C188.1 505.3 110.2 498.7 60.21 448.8C3.741 392.3 3.741 300.7 60.21 244.3L172.5 131.1zM467.5 380C411 436.5 319.5 436.5 263 380C213 330 206.5 251.2 247.6 193.7L248.7 192.1C258.1 177.8 278.1 174.4 293.3 184.7C307.7 194.1 311.1 214.1 300.8 229.3L299.7 230.9C276.8 262.1 280.4 306.9 308.3 334.8C339.7 366.2 390.8 366.2 422.3 334.8L534.5 222.5C566 191 566 139.1 534.5 108.5C506.7 80.63 462.7 76.99 430.7 99.9L429.1 101C414.7 111.3 394.7 107.1 384.5 93.58C374.2 79.2 377.5 59.21 391.9 48.94L393.5 47.82C451 6.731 529.8 13.25 579.8 63.24C636.3 119.7 636.3 211.3 579.8 267.7L467.5 380z"/></svg>

  </span>

</span></a
        >
      
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="https://github.com/andreasm80"
          target="_blank"
          aria-label="Github"
          rel="me noopener noreferrer"
          ><span class="inline-block align-text-bottom">

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>

  </span>

</span></a
        >
      
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="https://linkedin.com/in/andreas-marqvardsen"
          target="_blank"
          aria-label="Linkedin"
          rel="me noopener noreferrer"
          ><span class="inline-block align-text-bottom">

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg>

  </span>

</span></a
        >
      
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="https://vmst.io/@andreasm"
          target="_blank"
          aria-label="Mastodon"
          rel="me noopener noreferrer"
          ><span class="inline-block align-text-bottom">

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48 0 0 0-63.72 28.5-63.72 125.7 0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54 0 0 1-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"/></svg>

  </span>

</span></a
        >
      
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="https://x.com/NATsoFast"
          target="_blank"
          aria-label="X-Twitter"
          rel="me noopener noreferrer"
          ><span class="inline-block align-text-bottom">

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8L200.7 275.5 26.8 48H172.4L272.9 180.9 389.2 48zM364.4 421.8h39.1L151.1 88h-42L364.4 421.8z"/></svg>
  </span>

</span></a
        >
      
    
  </div>

</div>
  </div>
</div>

      

      

      
      <div class="mb-5"></div>
      

    

  </header>
  
  <section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row">
    
     <div
      class="order-first lg:ml-auto px-0 lg:order-last ltr:lg:pl-8 rtl:lg:pr-8">
      <div class="toc ltr:pl-5 rtl:pr-5 print:hidden lg:sticky lg:top-[140px]">

         <details open id="TOCView"
  class="toc-right mt-0 overflow-y-scroll overscroll-contain scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600 rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 hidden lg:block">
  <summary
    class="block py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">
    Table of Contents
  </summary>
  <div
    class="min-w-[220px] py-2 border-dotted ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#preparations">Preparations</a>
      <ul>
        <li><a href="#linux-jumphost-with-necessary-tanzu-cli-tools">Linux jumphost with necessary Tanzu CLI tools</a></li>
      </ul>
    </li>
    <li><a href="#vsphere-preparations">vSphere preparations</a>
      <ul>
        <li><a href="#vcenter-tkg-kubernetes-ova-template">vCenter TKG Kubernetes OVA template</a></li>
      </ul>
    </li>
    <li><a href="#vspherevcenter-availability-zones">vSphere/vCenter availability zones</a>
      <ul>
        <li><a href="#vsphere-drs-host-groups">vSphere DRS Host-Groups</a></li>
        <li><a href="#vsphere-clusters">vSphere Clusters</a></li>
        <li><a href="#vcenter-tags---using-vsphere-cluster-and-datacenter">vCenter Tags - using vSphere cluster and datacenter</a></li>
        <li><a href="#vcenter-tags---using-vsphere-drs-host-groups">vCenter Tags - using vSphere DRS host-groups</a></li>
      </ul>
    </li>
    <li><a href="#tkg---management-cluster">TKG - Management Cluster</a>
      <ul>
        <li><a href="#tkg-multi-az-config-file---using-vcenter-drs-host-groups">TKG multi-az config file - using vCenter DRS host-groups</a></li>
        <li><a href="#tkg-multi-az-config-file---using-vsphere-cluster-and-datacenter">TKG multi-az config file - using vSphere cluster and datacenter</a></li>
        <li><a href="#tkg-bootstrap-yaml---common-for-both-vsphere-cluster-and-drs-host-groups">TKG bootstrap yaml - common for both vSphere cluster and DRS host-groups</a></li>
      </ul>
    </li>
    <li><a href="#tkg-deployment">TKG Deployment</a>
      <ul>
        <li><a href="#tkg-mgmt-cluster-deployment-with-multi-availability-zones">TKG Mgmt Cluster deployment with multi-availability-zones</a></li>
        <li><a href="#adding-or-adjusting-the-vspherefailuredomains-and-vspheredeploymentzone">Adding or adjusting the vSphereFailureDomains and vSphereDeploymentZone</a></li>
        <li><a href="#tkg-workload-cluster-deployment-with-multi-availability-zones---using-vsphere-clusters-as-azs">TKG Workload Cluster deployment with multi-availability-zones - using vSphere clusters as AZs</a></li>
        <li><a href="#tkg-workload-cluster-deployment-with-multi-availability-zones---using-vcenter-host-groups-as-azs">TKG Workload Cluster deployment with multi-availability-zones - using vCenter host-groups as AZs</a></li>
      </ul>
    </li>
    <li><a href="#deploy-applications-on-workload-cluster-in-a-multi-az-environment">Deploy applications on workload cluster in a multi-az environment</a>
      <ul>
        <li><a href="#applicationpod-placement-using-nodeaffinity">Application/pod placement using nodeAffinity</a></li>
      </ul>
    </li>
    <li><a href="#failure-simulations">Failure simulations</a></li>
    <li><a href="#update-existing-tkg-cluster-to-use-new-availability-zones">Update existing TKG cluster to use new Availability Zones</a></li>
    <li><a href="#wrapping-up">Wrapping up</a></li>
  </ul>
</nav>
  </div>
</details>
<details class="toc-inside mt-0 overflow-hidden rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 lg:hidden">
  <summary
    class="py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">
    Table of Contents
  </summary>
  <div
    class="py-2 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#preparations">Preparations</a>
      <ul>
        <li><a href="#linux-jumphost-with-necessary-tanzu-cli-tools">Linux jumphost with necessary Tanzu CLI tools</a></li>
      </ul>
    </li>
    <li><a href="#vsphere-preparations">vSphere preparations</a>
      <ul>
        <li><a href="#vcenter-tkg-kubernetes-ova-template">vCenter TKG Kubernetes OVA template</a></li>
      </ul>
    </li>
    <li><a href="#vspherevcenter-availability-zones">vSphere/vCenter availability zones</a>
      <ul>
        <li><a href="#vsphere-drs-host-groups">vSphere DRS Host-Groups</a></li>
        <li><a href="#vsphere-clusters">vSphere Clusters</a></li>
        <li><a href="#vcenter-tags---using-vsphere-cluster-and-datacenter">vCenter Tags - using vSphere cluster and datacenter</a></li>
        <li><a href="#vcenter-tags---using-vsphere-drs-host-groups">vCenter Tags - using vSphere DRS host-groups</a></li>
      </ul>
    </li>
    <li><a href="#tkg---management-cluster">TKG - Management Cluster</a>
      <ul>
        <li><a href="#tkg-multi-az-config-file---using-vcenter-drs-host-groups">TKG multi-az config file - using vCenter DRS host-groups</a></li>
        <li><a href="#tkg-multi-az-config-file---using-vsphere-cluster-and-datacenter">TKG multi-az config file - using vSphere cluster and datacenter</a></li>
        <li><a href="#tkg-bootstrap-yaml---common-for-both-vsphere-cluster-and-drs-host-groups">TKG bootstrap yaml - common for both vSphere cluster and DRS host-groups</a></li>
      </ul>
    </li>
    <li><a href="#tkg-deployment">TKG Deployment</a>
      <ul>
        <li><a href="#tkg-mgmt-cluster-deployment-with-multi-availability-zones">TKG Mgmt Cluster deployment with multi-availability-zones</a></li>
        <li><a href="#adding-or-adjusting-the-vspherefailuredomains-and-vspheredeploymentzone">Adding or adjusting the vSphereFailureDomains and vSphereDeploymentZone</a></li>
        <li><a href="#tkg-workload-cluster-deployment-with-multi-availability-zones---using-vsphere-clusters-as-azs">TKG Workload Cluster deployment with multi-availability-zones - using vSphere clusters as AZs</a></li>
        <li><a href="#tkg-workload-cluster-deployment-with-multi-availability-zones---using-vcenter-host-groups-as-azs">TKG Workload Cluster deployment with multi-availability-zones - using vCenter host-groups as AZs</a></li>
      </ul>
    </li>
    <li><a href="#deploy-applications-on-workload-cluster-in-a-multi-az-environment">Deploy applications on workload cluster in a multi-az environment</a>
      <ul>
        <li><a href="#applicationpod-placement-using-nodeaffinity">Application/pod placement using nodeAffinity</a></li>
      </ul>
    </li>
    <li><a href="#failure-simulations">Failure simulations</a></li>
    <li><a href="#update-existing-tkg-cluster-to-use-new-availability-zones">Update existing TKG cluster to use new Availability Zones</a></li>
    <li><a href="#wrapping-up">Wrapping up</a></li>
  </ul>
</nav>
  </div>
</details>

<script>

  var margin = 200;
  var marginError = 50;

  (function () {
    var $window = $(window);
    var $toc = $('#TOCView');
    var tocHeight = $toc.height();

    function onResize() {
      var windowAndMarginHeight = $window.height() - margin;
      if(tocHeight >= windowAndMarginHeight) {
        $toc.css("overflow-y", "scroll")
        $toc.css("max-height", (windowAndMarginHeight + marginError) + "px")
      } else {
        $toc.css("overflow-y", "hidden")
        $toc.css("max-height", "9999999px")
      }
    }

    $window.on('resize', onResize);
    $(document).ready(onResize);
  })();



  (function () {
    var $toc = $('#TableOfContents');
    if ($toc.length > 0) {
      var $window = $(window);

      function onScroll() {
        var currentScroll = $window.scrollTop();
        var h = $('.anchor');
        var id = "";
        h.each(function (i, e) {
          e = $(e);
          if (e.offset().top - $(window).height()/3 <= currentScroll) {
            id = decodeURIComponent(e.attr('id'));
          }
        });
        var active = $toc.find('a.active');      
        if (active.length == 1 && active.eq(0).attr('href') == '#' + id) return true;

        active.each(function (i, e) {
          
            $(e).removeClass('active');
          
        });
        $toc.find('a[href="#' + id + '"]').addClass('active')
        $toc.find('a[href="#' + id + '"]').parentsUntil('#TableOfContents').each(function (i, e) {
          $(e).children('a').parents('ul').show();          
        });
      }

      $window.on('scroll', onScroll);
      $(document).ready(function () {
        
        onScroll();
      });
    }
  })();


</script>
   </div>
      </div>
      

      <div class="min-w-0 min-h-0 max-w-fit">
        
        


        <div class="article-content max-w-prose mb-20">
          

<h1 class="relative group">Tanzu Kubernetes Grid 2.3 and availability zones 
    <div id="tanzu-kubernetes-grid-23-and-availability-zones" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#tanzu-kubernetes-grid-23-and-availability-zones" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<p>TKG 2.3 brings support for multiple availability zones (AZs) in the <a href="https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid/2/about-tkg/support-policies.html#states" target="_blank">stable</a> feature set. So I wanted to explore this possibility and how to configure it. I will go through the configuratuons steps needed before deployment of a new TKG management cluster and TKG workload cluster using different availability zones. This post&rsquo;s primary focus is the multi availability zone feature, so I will not go into details in general TKG configurations such networking, loadbalancing as I already have a post covering a &ldquo;standard&rdquo; installation of TKG.</p>
<p>I will start by deploying the TKG management worker nodes on two of my three vSphere clusters (Cluster-2 and 3) and control-plane nodes in my vSphere Cluster-1, just to illustrate that with TKG 2.3 I can control where the respective type of nodes will be placed. Then I will deploy a TKG workload cluster (tkg-cluster-1) using the same zone-placement as the TKG management cluster. Both the TKG management cluster deployment and first workload cluster will be using vSphere clusters as availability zones. It will end up looking like this:

    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/08/29/tkg-2.3-deployment-in-multiple-availability-zones/images/image-20230904074757152.png"
        alt="mgmt-wld-cluster-placement"
      />
      
    </figure>
</p>
<p>When I have deployed my tkg-cluster-1 (workload cluster) I will apply another zone-config using vSphere DRS host-groups and provision a second TKG workload cluster (tkg-cluster-2-hostgroups) using a zone config configured to use vSphere DRS host-groups where I will define DRS rules on Cluster-3 dividing the four hosts into two zones, something like this:</p>
<img src=images/image-20230904075516401.png style="width:500px" />
<p>This post will be using a vSphere as the TKG infrastructure provider. The vSphere environment consists of 1 vCenter server, 3 vSphere clusters with 4 hosts in each ( a total of 12 ESXi hosts equally distributed across 3 vSphere clusters). All vSphere clusters are providing their own vSAN datastore local to their vSphere cluster. There is no stretched vSAN nor any datastore replication going on. NSX is the underlaying network infrastructure and NSX-ALB for all loadbalancing needs. To get started there is some steps that needs to be done in vCenter, a prepared linux jumphost/bootstrap client with necessary cli tools. So lets start with the preparations.</p>


<h2 class="relative group">Preparations 
    <div id="preparations" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#preparations" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>This section will cover all the needed preparations to get TKG 2.3 up and running in multiple availability zones. First out is the Linux jumphost, then vCenter configurations before doing the deployment. For more details on all requirements I dont cover in this post, head over to the offical documentation <a href="https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid/2.3/tkg-deploy-mc/mgmt-reqs-prep-vsphere.html" target="_blank">here</a></p>


<h3 class="relative group">Linux jumphost with necessary Tanzu CLI tools 
    <div id="linux-jumphost-with-necessary-tanzu-cli-tools" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#linux-jumphost-with-necessary-tanzu-cli-tools" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>The Linux jumphost needs to be configured with the following specifications:</p>
<ul>
<li>A Linux, Windows, or macOS operating system running on a physical or virtual machine that has the following hardware:
<ul>
<li>At least 8 GB of RAM. VMware recommends 16 GB of RAM.</li>
<li>A disk with 50 GB of available storage.</li>
<li>2 or 4 2-core CPUs.</li>
<li>Docker installed and running.</li>
</ul>
</li>
</ul>
<p>When that is sorted, log into the jumphost and start by grabbing the Tanzu CLI. This has become very easy compared to earlier.
My Linux jumphost is running Ubuntu, so I just need to add the repository for the Tanzu CLI like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo apt update
</span></span><span class="line"><span class="cl">sudo apt install -y ca-certificates curl gpg
</span></span><span class="line"><span class="cl">sudo mkdir -p /etc/apt/keyrings
</span></span><span class="line"><span class="cl">curl -fsSL https://packages.vmware.com/tools/keys/VMWARE-PACKAGING-GPG-RSA-KEY.pub <span class="p">|</span> sudo gpg --dearmor -o /etc/apt/keyrings/tanzu-archive-keyring.gpg
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;deb [signed-by=/etc/apt/keyrings/tanzu-archive-keyring.gpg] https://storage.googleapis.com/tanzu-cli-os-packages/apt tanzu-cli-jessie main&#34;</span> <span class="p">|</span> sudo tee /etc/apt/sources.list.d/tanzu.list
</span></span><span class="line"><span class="cl">sudo apt update
</span></span><span class="line"><span class="cl">sudo apt install -y tanzu-cli
</span></span></code></pre></div><p>If not using Ubuntu, or you prefer another method of installation, read <a href="https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid/2.3/tkg-deploy-mc/install-cli.html" target="_blank">here</a> for more options.</p>
<p>Then I need to install the necessary Tanzu CLI plugins like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@tkg-bootstrap:~$ tanzu plugin group get vmware-tkg/default:v2.3.0 <span class="c1"># to list them</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>i<span class="o">]</span> Reading plugin inventory <span class="k">for</span> <span class="s2">&#34;projects.registry.vmware.com/tanzu_cli/plugins/plugin-inventory:latest&#34;</span>, this will take a few seconds.
</span></span><span class="line"><span class="cl">Plugins in Group:  vmware-tkg/default:v2.3.0
</span></span><span class="line"><span class="cl">  NAME                TARGET      VERSION
</span></span><span class="line"><span class="cl">  isolated-cluster    global      v0.30.1
</span></span><span class="line"><span class="cl">  management-cluster  kubernetes  v0.30.1
</span></span><span class="line"><span class="cl">  package             kubernetes  v0.30.1
</span></span><span class="line"><span class="cl">  pinniped-auth       global      v0.30.1
</span></span><span class="line"><span class="cl">  secret              kubernetes  v0.30.1
</span></span><span class="line"><span class="cl">  telemetry           kubernetes  v0.30.1
</span></span><span class="line"><span class="cl">andreasm@tkg-bootstrap:~/.config$ tanzu plugin install --group vmware-tkg/default:v2.3.0 <span class="c1"># to install them</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>i<span class="o">]</span> The tanzu cli essential plugins have not been installed and are being installed now. The install may take a few seconds.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>i<span class="o">]</span> Installing plugin <span class="s1">&#39;isolated-cluster:v0.30.1&#39;</span> with target <span class="s1">&#39;global&#39;</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>i<span class="o">]</span> Installing plugin <span class="s1">&#39;management-cluster:v0.30.1&#39;</span> with target <span class="s1">&#39;kubernetes&#39;</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>i<span class="o">]</span> Installing plugin <span class="s1">&#39;package:v0.30.1&#39;</span> with target <span class="s1">&#39;kubernetes&#39;</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>i<span class="o">]</span> Installing plugin <span class="s1">&#39;pinniped-auth:v0.30.1&#39;</span> with target <span class="s1">&#39;global&#39;</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>i<span class="o">]</span> Installing plugin <span class="s1">&#39;secret:v0.30.1&#39;</span> with target <span class="s1">&#39;kubernetes&#39;</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>i<span class="o">]</span> Installing plugin <span class="s1">&#39;telemetry:v0.30.1&#39;</span> with target <span class="s1">&#39;kubernetes&#39;</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>ok<span class="o">]</span> successfully installed all plugins from group <span class="s1">&#39;vmware-tkg/default:v2.3.0&#39;</span>
</span></span></code></pre></div><p>Then I need the Kubernetes CLI, &ldquo;kubectl cli v1.26.5 for Linux&rdquo; for TKG 2.3 which can be found <a href="https://customerconnect.vmware.com/en/downloads/info/slug/infrastructure_operations_management/vmware_tanzu_kubernetes_grid/2_x" target="_blank">here</a>. After I have downloaded it, I copy it over to the Linux jumphost, extract it and place the binary <em>kubectl</em> in the folder <em>/usr/local/bin</em> so its in my path.</p>
<p>To verify the CLI tools and plugins are in place, I will run these commands:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># Verify Tanzu CLI version:</span>
</span></span><span class="line"><span class="cl">andreasm@tkg-bootstrap:~/.config$ tanzu version
</span></span><span class="line"><span class="cl">version: v1.0.0
</span></span><span class="line"><span class="cl">buildDate: 2023-08-08
</span></span><span class="line"><span class="cl">sha: 006d0429
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># Verify Tanzu CLI plugins:</span>
</span></span><span class="line"><span class="cl">andreasm@tkg-bootstrap:~/.config$ tanzu plugin list
</span></span><span class="line"><span class="cl">Standalone Plugins
</span></span><span class="line"><span class="cl">  NAME                DESCRIPTION                                                        TARGET      VERSION  STATUS
</span></span><span class="line"><span class="cl">  isolated-cluster    Prepopulating images/bundle <span class="k">for</span> internet-restricted environments   global      v0.30.1  installed
</span></span><span class="line"><span class="cl">  pinniped-auth       Pinniped authentication operations <span class="o">(</span>usually not directly invoked<span class="o">)</span>  global      v0.30.1  installed
</span></span><span class="line"><span class="cl">  telemetry           configure cluster-wide settings <span class="k">for</span> vmware tanzu telemetry         global      v1.1.0   installed
</span></span><span class="line"><span class="cl">  management-cluster  Kubernetes management cluster operations                           kubernetes  v0.30.1  installed
</span></span><span class="line"><span class="cl">  package             Tanzu package management                                           kubernetes  v0.30.1  installed
</span></span><span class="line"><span class="cl">  secret              Tanzu secret management                                            kubernetes  v0.30.1  installed
</span></span><span class="line"><span class="cl">  telemetry           configure cluster-wide settings <span class="k">for</span> vmware tanzu telemetry         kubernetes  v0.30.1  installed
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># verify kubectl version - look for &#34;Client Version&#34;</span>
</span></span><span class="line"><span class="cl">andreasm@tkg-bootstrap:~/.config$ kubectl version
</span></span><span class="line"><span class="cl">WARNING: This version information is deprecated and will be replaced with the output from kubectl version --short.  Use --output<span class="o">=</span>yaml<span class="p">|</span>json to get the full version.
</span></span><span class="line"><span class="cl">Client Version: version.Info<span class="o">{</span>Major:<span class="s2">&#34;1&#34;</span>, Minor:<span class="s2">&#34;26&#34;</span>, GitVersion:<span class="s2">&#34;v1.26.5+vmware.2&#34;</span>, GitCommit:<span class="s2">&#34;83112f368344a8ff6d13b89f120d5e646cd3bf19&#34;</span>, GitTreeState:<span class="s2">&#34;clean&#34;</span>, BuildDate:<span class="s2">&#34;2023-06-26T06:47:19Z&#34;</span>, GoVersion:<span class="s2">&#34;go1.19.9&#34;</span>, Compiler:<span class="s2">&#34;gc&#34;</span>, Platform:<span class="s2">&#34;linux/amd64&#34;</span><span class="o">}</span>
</span></span><span class="line"><span class="cl">Kustomize Version: v4.5.7
</span></span></code></pre></div><p>Next up is some preparations that needs to be done in vCenter.</p>


<h2 class="relative group">vSphere preparations 
    <div id="vsphere-preparations" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#vsphere-preparations" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>As vSphere is the platform where I deploy TKG there are a couple of things that needs to be done to prepare for the deployment of TKG in general but also how the different availability zones will be configured. Apart from the necessary functions such as networking and storage to support a TKG deployment.</p>


<h3 class="relative group">vCenter TKG Kubernetes OVA template 
    <div id="vcenter-tkg-kubernetes-ova-template" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#vcenter-tkg-kubernetes-ova-template" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>A small but important part is the OVA template to be used for the controlplane/worker nodes. I need to upload the right Kubernetes OVA template, it needs to be version 1.26.5, where I am using the latest Ubuntu 2004 Kubernetes v1.26.5 OVA. This I have downloaded from [here](<a href="https://customerconnect.vmware.com/en/downloads/info/slug/infrastructure_operations_management/vmware_tanzu_kubernetes_grid/2_x" target="_blank">the Tanzu Kubernetes Grid downloads page</a>), uploaded it to my vCenter server, then converted it to a template, not changing anything on it, name etc.</p>


<h2 class="relative group">vSphere/vCenter availability zones 
    <div id="vspherevcenter-availability-zones" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#vspherevcenter-availability-zones" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>With TKG 2.3 running on vSphere there is two ways to define the availability zones. There is the option to use vSphere clusters as availability zones or vSphere DRS host-groups. This gives flexibility and the possibility to define the availability zones according to how the underlaying vSphere environment has been configured. We can potentially have many availability zones for TKG to consume, some using host-groups, some using vSphere clusters and even different vCenter servers. It all depends on the needs and where it makes sense. Regardless of using vSphere clusters or DRS host-groups we need to define define a region and a zone for TKG to use. In vCenter we need to create tag associated with a category. The category can be whatever you want to call it, they just need to be reflected correctly when defining the vSphereFailureDomain later on. You may end up with several vSphere tag-categories as this depend on the environment and how you want to use the availability zones.  These tag and categories are defined a bit different between vSphere clusters and DRS host-groups. When using vSphere clusters the region is defined on the Datacenter object and the zone is the actual vsphere cluster. When using DRS host-groups the vSphere cluster is defined as the the regions and the host-group as the zone.</p>
<img src=images/image-20230831084930074.png style="width:500px" />
<img src=images/image-20230831085904923.png style="width:500px" />


<h3 class="relative group">vSphere DRS Host-Groups 
    <div id="vsphere-drs-host-groups" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#vsphere-drs-host-groups" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>The option to use host-groups (DRS objects) is to create &ldquo;logical&rdquo; zones based on host-groups/vm-groups affinity rules to place the TKG nodes in their respective host-groups inside same vSphere Cluster. This done by creating the host-groups, place the corresponding esxi hosts in the respective host-group and use vCenter <em>Tags &amp; Custom Attributes</em> specifying tags on these objects respectively. This can be a good use case if the vSphere hosts are in the same vSphere cluster but spread across several racks. That means I can create a host-group pr rack, and define these host-groups as my availability zones for TKG to place the nodes accordingly. Lets pretend I have 12 ESXi hosts, equally divided and placed in their own rack. I can then create 3 host-groups called <em>rack-1</em>, <em>rack-2</em> and <em>rack-3</em>.</p>
<img src=images/image-20230831080601895.png style="width:500px" />


<h3 class="relative group">vSphere Clusters 
    <div id="vsphere-clusters" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#vsphere-clusters" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>Using the vSphere clusters option we define the vCenter Datacenter object as the region and the vSphere clusters as the zones. We define that easily by using the vCenter <em>Tags &amp; Custom Attributes</em> specifying tags on these objects respectively. We tag the specific vSphere Datacenter to become a region and we tag the vSphere clusters to be a specific zone. In mye lab I have vSphere hosts in three different vSphere clusters. With that I have defined my vCenter Server&rsquo;s only Datacenter object to be a region, and all my three vSphere clusters as three different zones within that one region. In short that means if I have only one Datacenter object in my vCenter that is a region. In this Datecenter object I have my three vSphere host clusters which will be three different zones for TKG to be aware of for potential placement of the TKG nodes.</p>
<img src=images/image-20230831091608292.png style="width:500px" />
<p>For more information on multiple availability zones head over to the offical docs <a href="https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid/2.3/using-tkg/workload-clusters-multi-az-vsphere.html" target="_blank">here</a>.</p>
<p>Next up is how configured the AZs in vCenter using vSphere clusters and DRS host-groups</p>


<h3 class="relative group">vCenter Tags - using vSphere cluster and datacenter 
    <div id="vcenter-tags---using-vsphere-cluster-and-datacenter" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#vcenter-tags---using-vsphere-cluster-and-datacenter" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>As I am using vSphere Clusters as my zones and vSphere Datacenter it is very straight forward. The first thing that needs to be done is to create two categories under Tags &amp; Custom Attributes here:</p>
<img src=images/image-20230830082443709.png style="width:300px" />
<img src=images/image-20230830082626594.png style="width:300px" />
<p>The two categories is the <em>region</em> and <em>zone</em>. These two categories are created like this.</p>
<p>Region category:</p>
<img src=images/image-20230830084002391.png style="width:600px" />
<p>Then the Zone category:</p>
<img src=images/image-20230830084148111.png style="width:600px" />
<p>The categories can also be created using a cli tool called <a href="https://github.com/vmware/govmomi/tree/main/govc" target="_blank">govc</a> like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@tkg-bootstrap:~$ govc tags.category.create -t Datacenter k8s-region
</span></span><span class="line"><span class="cl">urn:vmomi:InventoryServiceCategory:a0248c5d-7050-4891-9635-1b5cbcb89f29:GLOBAL
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@tkg-bootstrap:~$ govc tags.category.create -t ClusterComputeResource k8s-zone
</span></span><span class="line"><span class="cl">urn:vmomi:InventoryServiceCategory:1d13b59d-1d2c-433a-b3ac-4f6528254f98:GLOBAL
</span></span></code></pre></div><p>I should now see the categories like this in my vCenter UI:</p>
<img src=images/image-20230830091325042.png style="width:600px" />
<p>Now when I have created the categories, I need to create the tags using the newly created categories respectively.</p>
<p>The k8s-region category is used on the vCenter/vSphere Datacenter object. I will create a tag using the category <em>k8s-region</em> with some kind of meaningful name for the Datacenter object, and then attach this tag to the Datacenter object.</p>
<p>Create Datacenter Tag:</p>
<img src=images/image-20230830091733652.png style="width:500px" />
<p>Then attach it to the Datacenter object:</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/08/29/tkg-2.3-deployment-in-multiple-availability-zones/images/image-20230830091929380.png"
        alt="assign-dc-tag"
      />
      
    </figure>
</p>
<p>Or using govc to attach/assign the tag:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@tkg-bootstrap:~$ govc tags.attach -c k8s-region wdc-region /cPod-NSXAM-WDC
</span></span><span class="line"><span class="cl"><span class="c1"># There is no output after execution of this command...</span>
</span></span></code></pre></div><p>Next up is the tags using the <em>k8s-zone</em> category. I am creating three tags for this as I have three vSphere clusters I want to use a three different Availability Zones. The tags are created the same as before only using the category <em>k8s-zone</em> instead.</p>
<p>I will end up with three tags called <em>wdc-zone-1</em>,<em>wdc-zone-2</em>, and <em>wdc-zone-3</em>.</p>
<img src=images/image-20230830092250715.png style="width:500px" />
<p>And here they are:</p>
<img src=images/image-20230830092351366.png style="width:500px" />
<p>Now I need to attach them to my vSphere clusters respectively, Cluster-1 = wdc-zone-1, Cluster-2 = wdc-zone-2 and Cluster-3 = wdc-zone-3.</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/08/29/tkg-2.3-deployment-in-multiple-availability-zones/images/image-20230830092629367.png"
        alt="cluster-tag-assign"
      />
      
    </figure>
</p>
<p>Again, the creation of the tags and attaching them can be done using <em>govc</em>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># Creating the tags using the correct category</span>
</span></span><span class="line"><span class="cl">andreasm@tkg-bootstrap:~$ govc tags.create -c k8s-zone wdc-zone-1
</span></span><span class="line"><span class="cl">andreasm@tkg-bootstrap:~$ govc tags.create -c k8s-zone wdc-zone-2
</span></span><span class="line"><span class="cl">andreasm@tkg-bootstrap:~$ govc tags.create -c k8s-zone wdc-zone-3
</span></span><span class="line"><span class="cl"><span class="c1"># Attaching the tags to the respective clusters</span>
</span></span><span class="line"><span class="cl">andreasm@tkg-bootstrap:~$ govc tags.attach -c k8s-zone wdc-zone-1 /cPod-NSXAM-WDC/host/Cluster-1
</span></span><span class="line"><span class="cl">andreasm@tkg-bootstrap:~$ govc tags.attach -c k8s-zone wdc-zone-2 /cPod-NSXAM-WDC/host/Cluster-2
</span></span><span class="line"><span class="cl">andreasm@tkg-bootstrap:~$ govc tags.attach -c k8s-zone wdc-zone-3 /cPod-NSXAM-WDC/host/Cluster-3
</span></span></code></pre></div>

<h3 class="relative group">vCenter Tags - using vSphere DRS host-groups 
    <div id="vcenter-tags---using-vsphere-drs-host-groups" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#vcenter-tags---using-vsphere-drs-host-groups" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>If using vSphere DRS host-groups this how how we can confgure vCenter using DRS host-groups as availability zones for TKG. In this section I will &ldquo;simulate&rdquo; that my vSphere Cluster-3 with 4 ESXi hosts is equally divided into two &ldquo;racks&rdquo; (2 ESXi hosts in each host-group). So I will create two host-groups, to reflect two availability zones inside Cluster-3.</p>
<img src=images/image-20230831102005973.png style="width:500px" />
<p>First I need to create two host-groups where I add my corresponding ESXi hosts. Group-1 will contain ESXi-9 and ESXi-12 and Group-2 will contain ESXi-11 and ESXi-12.
From the vCenter UI:</p>
<img src=images/image-20230831102907279.png style="width:500px" />
<p>Click add:
I am naming the host-groups <em>rack-1</em> and <em>rack-2</em> respectively, adding two hosts in each group.</p>
<img src=images/image-20230831103211900.png style="width:500px" />
<p>The two host-groups:</p>
<img src=images/image-20230831103317977.png style="width:600px" />
<p>When the host-groups have been created and defined with the esxi host membership, I need to define two DRS VM-groups.
From the same place as I created the host-groups, I click add and create a VM group instead.</p>
<img src=images/image-20230831103908045.png style="width:400px" />
<p>I need to add a &ldquo;dummy&rdquo; vm to be allowed to save and create the group. This is only when creating the group via the vCenter UI.</p>
<img src=images/image-20230831104206108.png style="width:400px" />
<p>Both vm groups created:</p>
<img src=images/image-20230831104328764.png style="width:600px" />
<p>To create these groups with cli using <em>govc</em>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># Create Host Groups</span>
</span></span><span class="line"><span class="cl">andreasm@tkg-bootstrap:~$ govc cluster.group.create -cluster<span class="o">=</span>Cluster-3 -name<span class="o">=</span>rack-1 -host esx01 esx02
</span></span><span class="line"><span class="cl"><span class="o">[</span>31-08-23 08:49:30<span class="o">]</span> Reconfigure /cPod-NSXAM-WDC/host/Cluster-3...OK
</span></span><span class="line"><span class="cl">andreasm@tkg-bootstrap:~$ govc cluster.group.create -cluster<span class="o">=</span>Cluster-3 -name<span class="o">=</span>rack-2 -host esx03 esx04
</span></span><span class="line"><span class="cl"><span class="o">[</span>31-08-23 08:48:30<span class="o">]</span> Reconfigure /cPod-NSXAM-WDC/host/Cluster-3...OK
</span></span><span class="line"><span class="cl"><span class="c1"># Create VM groups</span>
</span></span><span class="line"><span class="cl">andreasm@tkg-bootstrap:~$ govc cluster.group.create -cluster<span class="o">=</span>Cluster-3 -name<span class="o">=</span>rack-1-vm-group -vm
</span></span><span class="line"><span class="cl"><span class="o">[</span>31-08-23 08:52:00<span class="o">]</span> Reconfigure /cPod-NSXAM-WDC/host/Cluster-3...OK
</span></span><span class="line"><span class="cl">andreasm@tkg-bootstrap:~$ govc cluster.group.create -cluster<span class="o">=</span>Cluster-3 -name<span class="o">=</span>rack-2-vm-group -vm
</span></span><span class="line"><span class="cl"><span class="o">[</span>31-08-23 08:52:04<span class="o">]</span> Reconfigure /cPod-NSXAM-WDC/host/Cluster-3...OK
</span></span></code></pre></div><p>Now I need to create affinity rules restricting the corresponding vm-group to only reside in the correct host-group.</p>
<p>Group-1 rule</p>
<img src=images/image-20230831105836834.png style="width:500px" />
<p>and group 2 rule</p>
<img src=images/image-20230831105945023.png style="width:500px" />
<p>Now its just creating the corresponding tag categories k8s-region and k8s-zone and the respective tags pr cluster and host-groups that have been created. Lets start by creating the categories, first from the vCenter UI then later using cli with <em>govc</em>.
Note that these DRS host-groups are not the objects being tagged as the actual zones later on, they are just the logical boundary used in vCenter for vm placement. The ESXi hosts themselves will be the ones that are tagged with the zone tag, where the ESXi hosts are part of a host-group with a VM affinity rule.</p>
<p>Category <em>k8s-region</em>:</p>
<p>I already have the k8s-region category from earlier, I just need to update it to also allow cluster.</p>
<img src=images/image-20230831112428462.png style="width:500px" />
<p>Category <em>k8s-zone</em>:</p>
<p>I already have the <em>k8s-zone</em> category from earlier, I just need to update it to also allow Host.</p>
<img src=images/image-20230831112709293.png style="width:500px" />
<p>Then I need to create the tag using the correct category, starting with the region tag.
Create tag called <em>room1</em> (in lack of own fantasy)</p>
<img src=images/image-20230831113118169.png style="width:500px" />
<p>Then the two tags pr zone/host-group:</p>
<p>Rack1</p>
<img src=images/image-20230831113221327.png style="width:500px" />
<p>Rack2</p>
<img src=images/image-20230831113309054.png style="width:500px" />
<p>Now I need to attach the above tags to the correct objects in vCenter. The region tag will be used on the Cluster-3 object, the k8s-zone tags will be used on the ESXi host objects.
The region <em>room1</em> tag:</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/08/29/tkg-2.3-deployment-in-multiple-availability-zones/images/image-20230831114701855.png"
        alt="region-room1-tag"
      />
      
    </figure>
</p>
<p>Then the zone tag <em>rack1</em> and <em>rack2</em></p>
<p>Rack1</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/08/29/tkg-2.3-deployment-in-multiple-availability-zones/images/image-20230831114913112.png"
        alt="esxi1-zone-tag"
      />
      
    </figure>
</p>
<p>Rack2</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/08/29/tkg-2.3-deployment-in-multiple-availability-zones/images/image-20230831115026621.png"
        alt="esxi3-zone-tag"
      />
      
    </figure>
</p>
<p>Now I have tagged the region and the zones, and should now have 2 availability zones for TKG to use.</p>
<p>To configure the categories, tags and attachment from cli using <em>govc</em>:</p>
<pre tabindex="0"><code class="language-bash" data-lang="bash"># Creating the categories if not already created, if already created run the tags.category.update
andreasm@tkg-bootstrap:~$ govc tags.category.create -t ClusterComputeResource k8s-region
andreasm@tkg-bootstrap:~$ govc tags.category.create -t HostSystem k8s-zone
# Create the region tag
andreasm@tkg-bootstrap:~$ govc tags.create -c k8s-region room1
# Create the zone tag
andreasm@tkg-bootstrap:~$ govc tags.create -c k8s-zone rack1
andreasm@tkg-bootstrap:~$ govc tags.create -c k8s-zone rack2
# Attach the region tag to vSphere Cluster-3
andreasm@tkg-bootstrap:~$ govc tags.attach -c k8s-region room1 /cPod-NSXAM-WDC/host/Cluster-3
# Attach the zone tag to the ESXi hosts
andreasm@tkg-bootstrap:~$ govc tags.attach -c k8s-zone rack1 /cPod-NSXAM-WDC/host/Cluster-3/esxi-01.fqdn
andreasm@tkg-bootstrap:~$ govc tags.attach -c k8s-zone rack1 /cPod-NSXAM-WDC/host/Cluster-3/esxi-02.fqdn
andreasm@tkg-bootstrap:~$ govc tags.attach -c k8s-zone rack2 /cPod-NSXAM-WDC/host/Cluster-3/esxi-03.fqdn
andreasm@tkg-bootstrap:~$ govc tags.attach -c k8s-zone rack2 /cPod-NSXAM-WDC/host/Cluster-3/esxi-04.fqdn
</code></pre><p>Now that the necessary tags and categories have been created and assigned in vCenter, I can continue to prepare the necessary configs for TKG to use them.</p>
<div class="notice info">
<p>If the categories are already in place from previous installations, and you want to add these AZs also - Create new categories as the CSI installation will fail complaining on this error:
<em>&ldquo;plugin registration failed with err: rpc error: code = Internal desc = failed to retrieve topology information for Node: &ldquo;&rdquo;. Error: &ldquo;failed to fetch topology information for the nodeVM &quot;&quot;. Error: duplicate values detected for category k8s-zone as &quot;rack1&quot; and &quot;wdc-zone-3&quot;&rdquo;, restarting registration container.&rdquo;</em></p>
<p>These new categories must be updated accordingly in the multi-az.yaml file and tkg-workload cluster manifest before deployment. It can also make sense to have different categories to distinguish the different environments better.</p>
</div>


<h2 class="relative group">TKG - Management Cluster 
    <div id="tkg---management-cluster" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#tkg---management-cluster" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>Before I can deploy a TKG management cluster I need to prepare a bootstrap yaml file and a multi-zone file so it knows about how the cluster should be configured and the availability zones.
For TKG to use the tags created in vCenter we need to define these as Kubernetes FailureDomain and Deployment-Zone objects. This is done by creating a separate yaml file describing this. In this multi-zone file I need to define the <em>region</em>, <em>zone</em> and <em>topology</em>. The category and zone tags created in vCenter and the ones I have used in this post is only to keep it simple. We can have several categories depending on the environment you deploy it on. For more information on this head over <a href="https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid/2.3/using-tkg/workload-clusters-multi-az-vsphere.html#create-failuredomain-and-deployment-zone-objects-in-kubernetes-4" target="_blank">here</a>.
Here it is also possible to define different networks and storage.
A short explanation of the two CRDs in the example below: vSphereFailureDomain is where you provide the necessary information about the region/zones defined in vCenter such as the tags pr region/zone aka Datacenter/Clusters, networks and datastore.
The vSphereDeploymentZone is used for placement constraints, using the vSphereFailureDomains and makes it possible mapping them using labels like I am doing below. A bit more on that later when I come to the actual deployment.</p>


<h3 class="relative group">TKG multi-az config file - using vCenter DRS host-groups 
    <div id="tkg-multi-az-config-file---using-vcenter-drs-host-groups" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#tkg-multi-az-config-file---using-vcenter-drs-host-groups" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>Below is the yaml file I have prepared to deploy my TKG Management cluster when using vCenter DRS host-groups as availability zones. Comments inline:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">infrastructure.cluster.x-k8s.io/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">VSphereFailureDomain</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">rack1</span><span class="w"> </span><span class="c"># A name for this specifc zone, does not have to be the same as the tag used in vCenter</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">region</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">room1</span><span class="w"> </span><span class="c"># The specific tag created and assigned to the Datacenter object in vCenter</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">ComputeCluster</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">tagCategory</span><span class="p">:</span><span class="w"> </span><span class="l">k8s-region</span><span class="w"> </span><span class="c"># The specific tag category created earlier in vCenter</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">zone</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">rack1</span><span class="w"> </span><span class="c"># The specific tag created and assigned to the cluster object in vCenter</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">HostGroup</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">tagCategory</span><span class="p">:</span><span class="w"> </span><span class="l">k8s-zone</span><span class="w"> </span><span class="c"># The specific tag category created earlier in vCenter</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">topology</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">datacenter</span><span class="p">:</span><span class="w"> </span><span class="l">/cPod-NSXAM-WDC</span><span class="w"> </span><span class="c"># Specifies which Datacenter in vCenter</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">computeCluster</span><span class="p">:</span><span class="w"> </span><span class="l">Cluster-3</span><span class="w"> </span><span class="c"># Specifices which Cluster in vCenter</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">hosts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">vmGroupName</span><span class="p">:</span><span class="w"> </span><span class="l">rack-1-vm-group</span><span class="w"> </span><span class="c"># The vm group name created earlier in vCenter</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">hostGroupName</span><span class="p">:</span><span class="w"> </span><span class="l">rack-1</span><span class="w"> </span><span class="c"># The host group name created earlier in vCenter</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">networks</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="l">/cPod-NSXAM-WDC/network/ls-tkg-mgmt</span><span class="w"> </span><span class="c"># Specify the network the nodes shall use in this region/cluster</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">datastore</span><span class="p">:</span><span class="w"> </span><span class="l">/cPod-NSXAM-WDC/datastore/vsanDatastore-wdc-3</span><span class="w"> </span><span class="c"># Specify the datastore the nodes shall use in this region/cluster</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">infrastructure.cluster.x-k8s.io/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">VSphereFailureDomain</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">rack2</span><span class="w"> </span><span class="c"># A name for this specifc zone, does not have to be the same as the tag used in vCenter</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">region</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">room1</span><span class="w"> </span><span class="c"># The specific tag created and assigned to the Datacenter object in vCenter</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">ComputeCluster</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">tagCategory</span><span class="p">:</span><span class="w"> </span><span class="l">k8s-region</span><span class="w"> </span><span class="c"># The specific tag category created earlier in vCenter</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">zone</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">rack2</span><span class="w"> </span><span class="c"># The specific tag created and assigned to the cluster object in vCenter</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">HostGroup</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">tagCategory</span><span class="p">:</span><span class="w"> </span><span class="l">k8s-zone</span><span class="w"> </span><span class="c"># The specific tag category created earlier in vCenter</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">topology</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">datacenter</span><span class="p">:</span><span class="w"> </span><span class="l">/cPod-NSXAM-WDC</span><span class="w"> </span><span class="c"># Specifies which Datacenter in vCenter</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">computeCluster</span><span class="p">:</span><span class="w"> </span><span class="l">Cluster-3</span><span class="w"> </span><span class="c"># Specifices which Cluster in vCenter</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">hosts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">vmGroupName</span><span class="p">:</span><span class="w"> </span><span class="l">rack-2-vm-group</span><span class="w"> </span><span class="c"># The vm group name created earlier in vCenter</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">hostGroupName</span><span class="p">:</span><span class="w"> </span><span class="l">rack-2</span><span class="w"> </span><span class="c"># The host group name created earlier in vCenter</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">networks</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="l">/cPod-NSXAM-WDC/network/ls-tkg-mgmt</span><span class="w"> </span><span class="c"># Specify the network the nodes shall use in this region/cluster</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">datastore</span><span class="p">:</span><span class="w"> </span><span class="l">/cPod-NSXAM-WDC/datastore/vsanDatastore-wdc-3</span><span class="w"> </span><span class="c"># Specify the datastore the nodes shall use in this region/cluster</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">infrastructure.cluster.x-k8s.io/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">VSphereDeploymentZone</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">rack1</span><span class="w"> </span><span class="c"># Give the deploymentzone a name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">region</span><span class="p">:</span><span class="w"> </span><span class="l">room1</span><span class="w"> </span><span class="c"># For controlplane placement</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">tkg-cp</span><span class="p">:</span><span class="w"> </span><span class="l">allowed</span><span class="w"> </span><span class="c"># For controlplane placement </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="l">vcsa.fqdn</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">failureDomain</span><span class="p">:</span><span class="w"> </span><span class="l">rack1</span><span class="w"> </span><span class="c"># Calls on the vSphereFailureDomain defined above</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">placementConstraint</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">resourcePool</span><span class="p">:</span><span class="w"> </span><span class="l">/cPod-NSXAM-WDC/host/Cluster-3/Resources</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">folder</span><span class="p">:</span><span class="w"> </span><span class="l">/cPod-NSXAM-WDC/vm/TKGm</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">infrastructure.cluster.x-k8s.io/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">VSphereDeploymentZone</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">rack2</span><span class="w"> </span><span class="c"># Give the deploymentzone a name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">region</span><span class="p">:</span><span class="w"> </span><span class="l">room1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">tkg-cp</span><span class="p">:</span><span class="w"> </span><span class="l">allowed</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="l">vcsa.fqdn</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">failureDomain</span><span class="p">:</span><span class="w"> </span><span class="l">rack2</span><span class="w"> </span><span class="c"># Calls on the vSphereFailureDomain defined above</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">placementConstraint</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">resourcePool</span><span class="p">:</span><span class="w"> </span><span class="l">/cPod-NSXAM-WDC/host/Cluster-3/Resources</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">folder</span><span class="p">:</span><span class="w"> </span><span class="l">/cPod-NSXAM-WDC/vm/TKGm</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span></code></pre></div>

<h3 class="relative group">TKG multi-az config file - using vSphere cluster and datacenter 
    <div id="tkg-multi-az-config-file---using-vsphere-cluster-and-datacenter" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#tkg-multi-az-config-file---using-vsphere-cluster-and-datacenter" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>Below is the yaml file I have prepared to deploy my TKG Management cluster with when using vSphere clusters as availability zones. Comments inline:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">infrastructure.cluster.x-k8s.io/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">VSphereFailureDomain</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">wdc-zone-1</span><span class="w"> </span><span class="c"># A name for this specifc zone, does not have to be the same as the tag used in vCenter</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">region</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">wdc-region</span><span class="w"> </span><span class="c"># The specific tag created and assigned to the Datacenter object in vCenter</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Datacenter</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">tagCategory</span><span class="p">:</span><span class="w"> </span><span class="l">k8s-region</span><span class="w"> </span><span class="c"># The specific tag category created earlier in vCenter</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">zone</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">wdc-zone-1</span><span class="w"> </span><span class="c"># The specific tag created and assigned to the cluster object in vCenter</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">ComputeCluster</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">tagCategory</span><span class="p">:</span><span class="w"> </span><span class="l">k8s-zone</span><span class="w"> </span><span class="c"># The specific tag category created earlier in vCenter</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">topology</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">datacenter</span><span class="p">:</span><span class="w"> </span><span class="l">/cPod-NSXAM-WDC</span><span class="w"> </span><span class="c"># Specifies which Datacenter in vCenter</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">computeCluster</span><span class="p">:</span><span class="w"> </span><span class="l">Cluster-1</span><span class="w"> </span><span class="c"># Specifices which Cluster in vCenter</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">networks</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="l">/cPod-NSXAM-WDC/network/ls-tkg-mgmt</span><span class="w"> </span><span class="c"># Specify the network the nodes shall use in this region/cluster</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">datastore</span><span class="p">:</span><span class="w"> </span><span class="l">/cPod-NSXAM-WDC/datastore/vsanDatastore-wdc-01</span><span class="w"> </span><span class="c"># Specify the datastore the nodes shall use in this region/cluster</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">infrastructure.cluster.x-k8s.io/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">VSphereFailureDomain</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">wdc-zone-2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">region</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">wdc-region</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Datacenter</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">tagCategory</span><span class="p">:</span><span class="w"> </span><span class="l">k8s-region</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">zone</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">wdc-zone-2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">ComputeCluster</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">tagCategory</span><span class="p">:</span><span class="w"> </span><span class="l">k8s-zone</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">topology</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">datacenter</span><span class="p">:</span><span class="w"> </span><span class="l">/cPod-NSXAM-WDC</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">computeCluster</span><span class="p">:</span><span class="w"> </span><span class="l">Cluster-2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">networks</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="l">/cPod-NSXAM-WDC/network/ls-tkg-mgmt</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">datastore</span><span class="p">:</span><span class="w"> </span><span class="l">/cPod-NSXAM-WDC/datastore/vsanDatastore-wdc-02</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">infrastructure.cluster.x-k8s.io/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">VSphereFailureDomain</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">wdc-zone-3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">region</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">wdc-region</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Datacenter</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">tagCategory</span><span class="p">:</span><span class="w"> </span><span class="l">k8s-region</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">zone</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">wdc-zone-3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">ComputeCluster</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">tagCategory</span><span class="p">:</span><span class="w"> </span><span class="l">k8s-zone</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">topology</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">datacenter</span><span class="p">:</span><span class="w"> </span><span class="l">/cPod-NSXAM-WDC</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">computeCluster</span><span class="p">:</span><span class="w"> </span><span class="l">Cluster-3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">networks</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="l">/cPod-NSXAM-WDC/network/ls-tkg-mgmt</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">datastore</span><span class="p">:</span><span class="w"> </span><span class="l">/cPod-NSXAM-WDC/datastore/vsanDatastore-wdc-3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">infrastructure.cluster.x-k8s.io/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">VSphereDeploymentZone</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">wdc-zone-1</span><span class="w"> </span><span class="c"># A name for the DeploymentZone. Does not have to be the same as above</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">region</span><span class="p">:</span><span class="w"> </span><span class="l">wdc-region</span><span class="w"> </span><span class="c"># A specific label to be used for placement restriction, allowing flexibility of node placement.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">tkg-cp</span><span class="p">:</span><span class="w"> </span><span class="l">allowed</span><span class="w"> </span><span class="c"># A specific label to be used for placement restriction, allowing flexibility of node placement.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="l">vcsa.fqdn</span><span class="w"> </span><span class="c"># Specifies the vCenter IP or FQDN</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">failureDomain</span><span class="p">:</span><span class="w"> </span><span class="l">wdc-zone-1</span><span class="w"> </span><span class="c"># Calls on the respective vSphereFailureDomain defined above</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">placementConstraint</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">resourcePool</span><span class="p">:</span><span class="w"> </span><span class="l">/cPod-NSXAM-WDC/host/Cluster-1/Resources</span><span class="w"> </span><span class="c"># Specify which ResourcePool or Cluster directly</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">folder</span><span class="p">:</span><span class="w"> </span><span class="l">/cPod-NSXAM-WDC/vm/TKGm</span><span class="w"> </span><span class="c"># Specify which folder in vCenter to use for node placement</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">infrastructure.cluster.x-k8s.io/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">VSphereDeploymentZone</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">wdc-zone-2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">region</span><span class="p">:</span><span class="w"> </span><span class="l">wdc-region</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">tkg-cp</span><span class="p">:</span><span class="w"> </span><span class="l">allowed</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">worker</span><span class="p">:</span><span class="w"> </span><span class="l">allowed</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="l">vcsa.fqdn</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">failureDomain</span><span class="p">:</span><span class="w"> </span><span class="l">wdc-zone-2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">placementConstraint</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">resourcePool</span><span class="p">:</span><span class="w"> </span><span class="l">/cPod-NSXAM-WDC/host/Cluster-2/Resources</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">folder</span><span class="p">:</span><span class="w"> </span><span class="l">/cPod-NSXAM-WDC/vm/TKGm</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">infrastructure.cluster.x-k8s.io/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">VSphereDeploymentZone</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">wdc-zone-3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">region</span><span class="p">:</span><span class="w"> </span><span class="l">wdc-region</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">tkg-cp</span><span class="p">:</span><span class="w"> </span><span class="l">allowed</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">worker</span><span class="p">:</span><span class="w"> </span><span class="l">allowed</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="l">vcsa.fqdn</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">failureDomain</span><span class="p">:</span><span class="w"> </span><span class="l">wdc-zone-3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">placementConstraint</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">resourcePool</span><span class="p">:</span><span class="w"> </span><span class="l">/cPod-NSXAM-WDC/host/Cluster-3/Resources</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">folder</span><span class="p">:</span><span class="w"> </span><span class="l">/cPod-NSXAM-WDC/vm/TKGm</span><span class="w">
</span></span></span></code></pre></div><p>The <em>multi-az</em> yaml file above is now ready to be used deploying my TKG mgmt cluster in a multi-az environment using vSphere Clusters as the Availability Zones.  I have added a label in my multi-az configuration under the vSphereDeploymentZones: <em>tkg-cp: allowed</em>. This custom label is used for the placement of the TKG controlplane nodes. I only want the worker nodes to be placed on AZ-2 and AZ-3 (wdc-zone-2 and wdc-zone-3) where AZ-1 or wdc-zone-1 is only for Control Plane node placement. This is one usecase for the vSphereDeploymentZone, placement constraints. Using these labels to specify the control-plane placement. The worker nodes placement for both TKG management cluster and workload cluster is defined in the bootstrap yaml or the cluster-class manifest for workload cluster.</p>


<h3 class="relative group">TKG bootstrap yaml - common for both vSphere cluster and DRS host-groups 
    <div id="tkg-bootstrap-yaml---common-for-both-vsphere-cluster-and-drs-host-groups" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#tkg-bootstrap-yaml---common-for-both-vsphere-cluster-and-drs-host-groups" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>In additon to the regular settings that is needed in the bootstrap yaml file I need to add these lines to take into consideration the Availability zones.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c">#! ---------------------------------------------------------------------</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#! Multi-AZ configuration</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#! ---------------------------------------------------------------------</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">USE_TOPOLOGY_CATEGORIES</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">VSPHERE_REGION</span><span class="p">:</span><span class="w"> </span><span class="l">k8s-region</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">VSPHERE_ZONE</span><span class="p">:</span><span class="w"> </span><span class="l">k8s-zone</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">VSPHERE_AZ_0</span><span class="p">:</span><span class="w"> </span><span class="l">wdc-zone-2</span><span class="w"> </span><span class="c"># Here I am defining the zone placement for the workers that ends with md-0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">VSPHERE_AZ_1</span><span class="p">:</span><span class="w"> </span><span class="l">wdc-zone-3</span><span class="w"> </span><span class="c"># Here I am defining the zone placement for the workers that ends with md-1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">VSPHERE_AZ_2</span><span class="p">:</span><span class="w"> </span><span class="l">wdc-zone-3</span><span class="w"> </span><span class="c"># Here I am defining the zone placement for the workers that ends with md-2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">VSPHERE_AZ_CONTROL_PLANE_MATCHING_LABELS</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;region=wdc-region,tkg-cp=allowed&#34;</span><span class="w"> </span><span class="c">#This defines and uses the vSphereDeploymentsZone labels I have added to instruct the control-plane node placement</span><span class="w">
</span></span></span></code></pre></div><p><strong>Note!</strong> The Zone names under vSphere_AZ_0-2 needs to reflect the correct zone tag/label used in your corresponding multi-az.yaml file pr vSphereDeploymentZone. The same goes for the VSPHERE_AZ_CONTROL_PLANE_MATCHING_LABELS: the values needs to reflect the labels used/added.</p>
<p>Now my full bootstrap.yaml below:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c">#! ---------------</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#! Basic config</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#! -------------</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">CLUSTER_NAME</span><span class="p">:</span><span class="w"> </span><span class="l">tkg-wdc-az-mgmt</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">CLUSTER_PLAN</span><span class="p">:</span><span class="w"> </span><span class="l">prod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">INFRASTRUCTURE_PROVIDER</span><span class="p">:</span><span class="w"> </span><span class="l">vsphere</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">ENABLE_CEIP_PARTICIPATION</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;false&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">ENABLE_AUDIT_LOGGING</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;false&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">CLUSTER_CIDR</span><span class="p">:</span><span class="w"> </span><span class="m">100.96.0.0</span><span class="l">/11</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">SERVICE_CIDR</span><span class="p">:</span><span class="w"> </span><span class="m">100.64.0.0</span><span class="l">/13</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">TKG_IP_FAMILY</span><span class="p">:</span><span class="w"> </span><span class="l">ipv4</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">DEPLOY_TKG_ON_VSPHERE7</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#! ---------------</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#! vSphere config</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#! -------------</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">VSPHERE_DATACENTER</span><span class="p">:</span><span class="w"> </span><span class="l">/cPod-NSXAM-WDC</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">VSPHERE_DATASTORE</span><span class="p">:</span><span class="w"> </span><span class="l">/cPod-NSXAM-WDC/datastore/vsanDatastore-wdc-01</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">VSPHERE_FOLDER</span><span class="p">:</span><span class="w"> </span><span class="l">/cPod-NSXAM-WDC/vm/TKGm</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">VSPHERE_INSECURE</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;false&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">VSPHERE_NETWORK</span><span class="p">:</span><span class="w"> </span><span class="l">/cPod-NSXAM-WDC/network/ls-tkg-mgmt</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">VSPHERE_CONTROL_PLANE_ENDPOINT</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">VSPHERE_PASSWORD</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;password&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">VSPHERE_RESOURCE_POOL</span><span class="p">:</span><span class="w"> </span><span class="l">/cPod-NSXAM-WDC/host/Cluster-1/Resources</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">VSPHERE_SERVER</span><span class="p">:</span><span class="w"> </span><span class="l">vcsa.fqdn</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">VSPHERE_SSH_AUTHORIZED_KEY</span><span class="p">:</span><span class="w"> </span><span class="l">ssh-rsa </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">VSPHERE_TLS_THUMBPRINT</span><span class="p">:</span><span class="w"> </span><span class="l">F:::::::::E</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">VSPHERE_USERNAME</span><span class="p">:</span><span class="w"> </span><span class="l">andreasm@vsphereSSOdomain.net</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#! ---------------------------------------------------------------------</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#! Multi-AZ configuration</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#! ---------------------------------------------------------------------</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">USE_TOPOLOGY_CATEGORIES</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">VSPHERE_REGION</span><span class="p">:</span><span class="w"> </span><span class="l">k8s-region</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">VSPHERE_ZONE</span><span class="p">:</span><span class="w"> </span><span class="l">k8s-zone</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">VSPHERE_AZ_0</span><span class="p">:</span><span class="w"> </span><span class="l">wdc-zone-2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">VSPHERE_AZ_1</span><span class="p">:</span><span class="w"> </span><span class="l">wdc-zone-3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">VSPHERE_AZ_2</span><span class="p">:</span><span class="w"> </span><span class="l">wdc-zone-3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">VSPHERE_AZ_CONTROL_PLANE_MATCHING_LABELS</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;region=wdc-region,tkg-cp=allowed&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">AZ_FILE_PATH</span><span class="p">:</span><span class="w"> </span><span class="l">/home/andreasm/tanzu-v-2.3/multi-az/multi-az.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#! ---------------</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#! Node config</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#! -------------</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">OS_ARCH</span><span class="p">:</span><span class="w"> </span><span class="l">amd64</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">OS_NAME</span><span class="p">:</span><span class="w"> </span><span class="l">ubuntu</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">OS_VERSION</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;20.04&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">VSPHERE_CONTROL_PLANE_DISK_GIB</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;20&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">VSPHERE_CONTROL_PLANE_MEM_MIB</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;4096&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">VSPHERE_CONTROL_PLANE_NUM_CPUS</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">VSPHERE_WORKER_DISK_GIB</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;20&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">VSPHERE_WORKER_MEM_MIB</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;4096&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">VSPHERE_WORKER_NUM_CPUS</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#CONTROL_PLANE_MACHINE_COUNT: 3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#WORKER_MACHINE_COUNT: 3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#! ---------------</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#! Avi config</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#! -------------</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">AVI_CA_DATA_B64</span><span class="p">:</span><span class="w"> </span><span class="l">BASE64ENC</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">AVI_CLOUD_NAME</span><span class="p">:</span><span class="w"> </span><span class="l">wdc-1-nsx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">AVI_CONTROL_PLANE_HA_PROVIDER</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">AVI_CONTROLLER</span><span class="p">:</span><span class="w"> </span><span class="m">172.21.101.50</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># Network used to place workload clusters&#39; endpoint VIPs</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">AVI_CONTROL_PLANE_NETWORK</span><span class="p">:</span><span class="w"> </span><span class="l">vip-tkg-wld-l4</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">AVI_CONTROL_PLANE_NETWORK_CIDR</span><span class="p">:</span><span class="w"> </span><span class="m">10.101.114.0</span><span class="l">/24</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># Network used to place workload clusters&#39; services external IPs (load balancer &amp; ingress services)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">AVI_DATA_NETWORK</span><span class="p">:</span><span class="w"> </span><span class="l">vip-tkg-wld-l7</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">AVI_DATA_NETWORK_CIDR</span><span class="p">:</span><span class="w"> </span><span class="m">10.101.115.0</span><span class="l">/24</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># Network used to place management clusters&#39; services external IPs (load balancer &amp; ingress services)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">AVI_MANAGEMENT_CLUSTER_VIP_NETWORK_CIDR</span><span class="p">:</span><span class="w"> </span><span class="m">10.101.113.0</span><span class="l">/24</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">AVI_MANAGEMENT_CLUSTER_VIP_NETWORK_NAME</span><span class="p">:</span><span class="w"> </span><span class="l">vip-tkg-mgmt-l7</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># Network used to place management clusters&#39; endpoint VIPs</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">AVI_MANAGEMENT_CLUSTER_CONTROL_PLANE_VIP_NETWORK_NAME</span><span class="p">:</span><span class="w"> </span><span class="l">vip-tkg-mgmt-l4</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">AVI_MANAGEMENT_CLUSTER_CONTROL_PLANE_VIP_NETWORK_CIDR</span><span class="p">:</span><span class="w"> </span><span class="m">10.101.112.0</span><span class="l">/24</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">AVI_NSXT_T1LR</span><span class="p">:</span><span class="w"> </span><span class="l">Tier-1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">AVI_CONTROLLER_VERSION</span><span class="p">:</span><span class="w"> </span><span class="m">22.1.2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">AVI_ENABLE</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">AVI_LABELS</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">AVI_PASSWORD</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;password&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">AVI_SERVICE_ENGINE_GROUP</span><span class="p">:</span><span class="w"> </span><span class="l">nsx-se-generic-group</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">AVI_MANAGEMENT_CLUSTER_SERVICE_ENGINE_GROUP</span><span class="p">:</span><span class="w"> </span><span class="l">nsx-se-generic-group</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">AVI_USERNAME</span><span class="p">:</span><span class="w"> </span><span class="l">admin</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">AVI_DISABLE_STATIC_ROUTE_SYNC</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">AVI_INGRESS_DEFAULT_INGRESS_CONTROLLER</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">AVI_INGRESS_SHARD_VS_SIZE</span><span class="p">:</span><span class="w"> </span><span class="l">SMALL</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">AVI_INGRESS_SERVICE_TYPE</span><span class="p">:</span><span class="w"> </span><span class="l">NodePortLocal</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#! ---------------</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#! Proxy config</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#! -------------</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">TKG_HTTP_PROXY_ENABLED</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;false&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#! ---------------------------------------------------------------------</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#! Antrea CNI configuration</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#! ---------------------------------------------------------------------</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">ANTREA_NODEPORTLOCAL</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">ANTREA_PROXY</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">ANTREA_ENDPOINTSLICE</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">ANTREA_POLICY</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">ANTREA_TRACEFLOW</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">ANTREA_NETWORKPOLICY_STATS</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">ANTREA_EGRESS</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">ANTREA_IPAM</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">ANTREA_FLOWEXPORTER</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">ANTREA_SERVICE_EXTERNALIP</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">ANTREA_MULTICAST</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#! ---------------------------------------------------------------------</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#! Machine Health Check configuration</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#! ---------------------------------------------------------------------</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">ENABLE_MHC</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">ENABLE_MHC_CONTROL_PLANE</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">ENABLE_MHC_WORKER_NODE</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">MHC_UNKNOWN_STATUS_TIMEOUT</span><span class="p">:</span><span class="w"> </span><span class="l">5m</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">MHC_FALSE_STATUS_TIMEOUT</span><span class="p">:</span><span class="w"> </span><span class="l">12m</span><span class="w">
</span></span></span></code></pre></div><p>One last thing to do before heading over to the actual deployment is to add the following to my current Linux jumphost session:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@tkg-bootstrap:~$ <span class="nb">export</span> <span class="nv">SKIP_MULTI_AZ_VERIFY</span><span class="o">=</span><span class="s2">&#34;true&#34;</span>
</span></span></code></pre></div><p>This is needed as there is no mgmt cluster yet, and there is no way for anything that&rsquo;s not there to verify anything &#x1f63a;</p>


<h2 class="relative group">TKG Deployment 
    <div id="tkg-deployment" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#tkg-deployment" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>Now that I have done all the needed preparations it is time to do the actual deployment and see if my Availability Zones are being used as I wanted. When the TKG management cluster has been deployed I should end up with all the Control Plane (3) nodes distributed across all my 3 AZs. Then the worker nodes should only be placed in the AZ-2 and AZ-3.</p>


<h3 class="relative group">TKG Mgmt Cluster deployment with multi-availability-zones 
    <div id="tkg-mgmt-cluster-deployment-with-multi-availability-zones" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#tkg-mgmt-cluster-deployment-with-multi-availability-zones" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>From my Linux jumphost where I have all the CLI tools in place I am now ready to execute the following command to deploy the mgmt cluster. 3 Control Plane Nodes and 3 Worker Nodes.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@tkg-bootstrap:~$ tanzu mc create -f my-tkg-mgmt-bootstrap.yaml --az-file my-multi-az-file.yaml
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">Validating the pre-requisites...
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">vSphere <span class="m">8</span> with Tanzu Detected.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">You have connected to a vSphere <span class="m">8</span> with Tanzu environment that includes an integrated Tanzu Kubernetes Grid Service which
</span></span><span class="line"><span class="cl">turns a vSphere cluster into a platform <span class="k">for</span> running Kubernetes workloads in dedicated resource pools. Configuring Tanzu
</span></span><span class="line"><span class="cl">Kubernetes Grid Service is <span class="k">done</span> through the vSphere HTML5 Client.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Tanzu Kubernetes Grid Service is the preferred way to consume Tanzu Kubernetes Grid in vSphere <span class="m">8</span> environments. Alternatively you may
</span></span><span class="line"><span class="cl">deploy a non-integrated Tanzu Kubernetes Grid instance on vSphere 8.
</span></span><span class="line"><span class="cl">Deploying TKG management cluster on vSphere <span class="m">8</span> ...
</span></span><span class="line"><span class="cl">Identity Provider not configured. Some authentication features won<span class="err">&#39;</span>t work.
</span></span><span class="line"><span class="cl">Using default value <span class="k">for</span> <span class="nv">CONTROL_PLANE_MACHINE_COUNT</span> <span class="o">=</span> 3. Reason: CONTROL_PLANE_MACHINE_COUNT variable is not <span class="nb">set</span>
</span></span><span class="line"><span class="cl">Using default value <span class="k">for</span> <span class="nv">WORKER_MACHINE_COUNT</span> <span class="o">=</span> 3. Reason: WORKER_MACHINE_COUNT variable is not <span class="nb">set</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Setting up management cluster...
</span></span><span class="line"><span class="cl">Validating configuration...
</span></span><span class="line"><span class="cl">Using infrastructure provider vsphere:v1.7.0
</span></span><span class="line"><span class="cl">Generating cluster configuration...
</span></span><span class="line"><span class="cl">Setting up bootstrapper...
</span></span></code></pre></div><p>Sit back and enjoy while the kind cluster is being deployed locally and hopefully provisioned in your vCenter server..</p>
<p>When you see the below: <em>Start creating management cluster</em> something should start to happen in the vCenter server.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">Management cluster config file has been generated and stored at: <span class="s1">&#39;/home/andreasm/.config/tanzu/tkg/clusterconfigs/tkg-wdc-az-mgmt.yaml&#39;</span>
</span></span><span class="line"><span class="cl">Start creating management cluster...
</span></span></code></pre></div><p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/08/29/tkg-2.3-deployment-in-multiple-availability-zones/images/image-20230830123219285.png"
        alt="tkg-vms-deploying"
      />
      
    </figure>
</p>
<p>And by just clicking on the respective TKG VM so far I can see that they are respecting my zone placement.</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/08/29/tkg-2.3-deployment-in-multiple-availability-zones/images/image-20230830123436090.png"
        alt="worker-md-2"
      />
      
    </figure>
</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/08/29/tkg-2.3-deployment-in-multiple-availability-zones/images/image-20230830123509547.png"
        alt="worker-md-1"
      />
      
    </figure>
</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/08/29/tkg-2.3-deployment-in-multiple-availability-zones/images/image-20230830123543531.png"
        alt="worker-md-0"
      />
      
    </figure>
</p>
<p>That is very well. Now just wait for the two last control plane nodes also.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">You can now access the management cluster tkg-wdc-az-mgmt by running <span class="s1">&#39;kubectl config use-context tkg-wdc-az-mgmt-admin@tkg-wdc-az-mgmt&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Management cluster created!
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">You can now create your first workload cluster by running the following:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  tanzu cluster create <span class="o">[</span>name<span class="o">]</span> -f <span class="o">[</span>file<span class="o">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Some addons might be getting installed! Check their status by running the following:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  kubectl get apps -A
</span></span></code></pre></div><p>Exciting, lets have a look at the control plane nodes placement:</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/08/29/tkg-2.3-deployment-in-multiple-availability-zones/images/image-20230830125444962.png"
        alt="tkg-cp-1"
      />
      
    </figure>
</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/08/29/tkg-2.3-deployment-in-multiple-availability-zones/images/image-20230830125515241.png"
        alt="tkg-cp-2"
      />
      
    </figure>
</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/08/29/tkg-2.3-deployment-in-multiple-availability-zones/images/image-20230830125539285.png"
        alt="tkg-cp-3"
      />
      
    </figure>
</p>
<p>They have been distributed across my three cluster as wanted. Perfect.</p>
<p>Now next step is to deploy a workload cluster to achieve the same placement constraints there.</p>


<h3 class="relative group">Adding or adjusting the vSphereFailureDomains and vSphereDeploymentZone 
    <div id="adding-or-adjusting-the-vspherefailuredomains-and-vspheredeploymentzone" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#adding-or-adjusting-the-vspherefailuredomains-and-vspheredeploymentzone" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>In my TKG management cluster deployment above I have used the vSphereFailureDomains and vSphereDeploymentZones for vSphere clusters as my availability zones. If I want to have workload clusters deployed in other availability zones, different zones or even new zones I can add these to the management cluster. In the example below I will add the availability zones configured to use vCenter DRS host-groups using the vsphere-zones yaml config <a href="#tkg-multi-az-config-file---using-vcenter-drs-host-groups">here</a>.</p>
<p>To check which zones are available  for the management cluster:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># vSphereFailureDomains</span>
</span></span><span class="line"><span class="cl">andreasm@tkg-bootstrap:~$ k get vspherefailuredomains.infrastructure.cluster.x-k8s.io -A
</span></span><span class="line"><span class="cl">NAME         AGE
</span></span><span class="line"><span class="cl">wdc-zone-1   24h
</span></span><span class="line"><span class="cl">wdc-zone-2   24h
</span></span><span class="line"><span class="cl">wdc-zone-3   24h
</span></span><span class="line"><span class="cl"><span class="c1"># vSphereDeploymentZones</span>
</span></span><span class="line"><span class="cl">andreasm@tkg-bootstrap:~$ k get vspheredeploymentzones.infrastructure.cluster.x-k8s.io -A
</span></span><span class="line"><span class="cl">NAME         AGE
</span></span><span class="line"><span class="cl">wdc-zone-1   24h
</span></span><span class="line"><span class="cl">wdc-zone-2   24h
</span></span><span class="line"><span class="cl">wdc-zone-3   24h
</span></span><span class="line"><span class="cl"><span class="c1"># I have defined both FailureDomains and DeploymentsZone with the same name</span>
</span></span></code></pre></div><p>Now, let me add the DRS host-groups zones.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@tkg-bootstrap:~$ kubectl apply -f multi-az-host-groups.yaml <span class="c1">#The file containing host-groups definition</span>
</span></span><span class="line"><span class="cl">vspherefailuredomain.infrastructure.cluster.x-k8s.io/rack1 created
</span></span><span class="line"><span class="cl">vspherefailuredomain.infrastructure.cluster.x-k8s.io/rack2 created
</span></span><span class="line"><span class="cl">vspheredeploymentzone.infrastructure.cluster.x-k8s.io/rack1 created
</span></span><span class="line"><span class="cl">vspheredeploymentzone.infrastructure.cluster.x-k8s.io/rack2 created
</span></span><span class="line"><span class="cl"><span class="c1"># Or</span>
</span></span><span class="line"><span class="cl">andreasm@tkg-bootstrap:~$ tanzu mc az <span class="nb">set</span> -f multi-az-host-groups.yaml
</span></span><span class="line"><span class="cl"><span class="c1"># This command actually validate the settings if the export SKIP_MULTI_AZ_VERIFY=&#34;true&#34; is not set ofcourse</span>
</span></span></code></pre></div><p>Now check the failuredomains and placementzones:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@tkg-bootstrap:~$ k get vspherefailuredomains.infrastructure.cluster.x-k8s.io -A
</span></span><span class="line"><span class="cl">NAME         AGE
</span></span><span class="line"><span class="cl">rack1        13s
</span></span><span class="line"><span class="cl">rack2        13s
</span></span><span class="line"><span class="cl">wdc-zone-1   24h
</span></span><span class="line"><span class="cl">wdc-zone-2   24h
</span></span><span class="line"><span class="cl">wdc-zone-3   24h
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@tkg-bootstrap:~$ k get vspheredeploymentzones.infrastructure.cluster.x-k8s.io -A
</span></span><span class="line"><span class="cl">NAME         AGE
</span></span><span class="line"><span class="cl">rack1        2m44s
</span></span><span class="line"><span class="cl">rack2        2m44s
</span></span><span class="line"><span class="cl">wdc-zone-1   24h
</span></span><span class="line"><span class="cl">wdc-zone-2   24h
</span></span><span class="line"><span class="cl">wdc-zone-3   24h
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@tkg-bootstrap:~$ tanzu mc available-zone list -a
</span></span><span class="line"><span class="cl">  AZNAME      ZONENAME    ZONETYPE        REGIONNAME  REGIONTYPE      DATASTORE                                       NETWORK                              OWNERCLUSTER   STATUS
</span></span><span class="line"><span class="cl">  rack1       rack1       HostGroup       room1       ComputeCluster  /cPod-NSXAM-WDC/datastore/vsanDatastore-wdc-01  /cPod-NSXAM-WDC/network/ls-tkg-mgmt                 not ready
</span></span><span class="line"><span class="cl">  rack2       rack2       HostGroup       room1       ComputeCluster  /cPod-NSXAM-WDC/datastore/vsanDatastore-wdc-01  /cPod-NSXAM-WDC/network/ls-tkg-mgmt                 not ready
</span></span><span class="line"><span class="cl">  wdc-zone-1  wdc-zone-1  ComputeCluster  wdc-region  Datacenter      /cPod-NSXAM-WDC/datastore/vsanDatastore-wdc-01  /cPod-NSXAM-WDC/network/ls-tkg-mgmt                 ready
</span></span><span class="line"><span class="cl">  wdc-zone-2  wdc-zone-2  ComputeCluster  wdc-region  Datacenter      /cPod-NSXAM-WDC/datastore/vsanDatastore-wdc-02  /cPod-NSXAM-WDC/network/ls-tkg-mgmt  tkg-cluster-1  ready
</span></span><span class="line"><span class="cl">  wdc-zone-3  wdc-zone-3  ComputeCluster  wdc-region  Datacenter      /cPod-NSXAM-WDC/datastore/vsanDatastore-wdc-3   /cPod-NSXAM-WDC/network/ls-tkg-mgmt  tkg-cluster-1  ready
</span></span></code></pre></div><p>I had the variable <em>export SKIP_MULTI_AZ_VERIFY=&ldquo;true&rdquo;</em> set so it did not validate my settings and just applied it. Therefore I have the two new zones/AZs in a not ready state. Deleting them, updated the config so it was correct. Sat the <em>export SKIP_MULTI_AZ_VERIFY=&ldquo;false&rdquo;</em>. Reapplied using the mc set command it came out ready:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@tkg-bootstrap:~$ tanzu mc az <span class="nb">set</span> -f multi-az-host-groups.yaml
</span></span><span class="line"><span class="cl">andreasm@tkg-bootstrap:~$ tanzu mc available-zone list -a
</span></span><span class="line"><span class="cl">  AZNAME      ZONENAME    ZONETYPE        REGIONNAME  REGIONTYPE      DATASTORE                                       NETWORK                              OWNERCLUSTER   STATUS
</span></span><span class="line"><span class="cl">  rack1       rack1       HostGroup       room1       ComputeCluster  /cPod-NSXAM-WDC/datastore/vsanDatastore-wdc-3   /cPod-NSXAM-WDC/network/ls-tkg-mgmt                 ready
</span></span><span class="line"><span class="cl">  rack2       rack2       HostGroup       room1       ComputeCluster  /cPod-NSXAM-WDC/datastore/vsanDatastore-wdc-3   /cPod-NSXAM-WDC/network/ls-tkg-mgmt                 ready
</span></span><span class="line"><span class="cl">  wdc-zone-1  wdc-zone-1  ComputeCluster  wdc-region  Datacenter      /cPod-NSXAM-WDC/datastore/vsanDatastore-wdc-01  /cPod-NSXAM-WDC/network/ls-tkg-mgmt                 ready
</span></span><span class="line"><span class="cl">  wdc-zone-2  wdc-zone-2  ComputeCluster  wdc-region  Datacenter      /cPod-NSXAM-WDC/datastore/vsanDatastore-wdc-02  /cPod-NSXAM-WDC/network/ls-tkg-mgmt  tkg-cluster-1  ready
</span></span><span class="line"><span class="cl">  wdc-zone-3  wdc-zone-3  ComputeCluster  wdc-region  Datacenter      /cPod-NSXAM-WDC/datastore/vsanDatastore-wdc-3   /cPod-NSXAM-WDC/network/ls-tkg-mgmt  tkg-cluster-1  ready
</span></span></code></pre></div>

<h3 class="relative group">TKG Workload Cluster deployment with multi-availability-zones - using vSphere clusters as AZs 
    <div id="tkg-workload-cluster-deployment-with-multi-availability-zones---using-vsphere-clusters-as-azs" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#tkg-workload-cluster-deployment-with-multi-availability-zones---using-vsphere-clusters-as-azs" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>At this stage I will use the values already provided earlier, like the multi-az config, network, vCenter folder placements and so on. If I like I could have added a specific multi-az file for the workload cluster, changed the network settings, folder etc. But I am just using the config already in place from the management cluster for now.</p>
<p>We have already done the hard work. So the workload cluster deployment is now more or less walk in the park. To generate the necessary workload-cluster yaml definition I execute the following command (<em>this will accommodate the necessary AZs setting, so if you already have a class-based cluster yaml file from previous TKG clusters make sure to add this or just run the command below</em>):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@tkg-bootstrap:~$ tanzu cluster create tkg-cluster-1 --namespace tkg-ns-1 --file tkg-mgmt-bootstrap-for-wld.az.yaml --dry-run &gt; workload-cluster/tkg-cluster-1.yaml
</span></span><span class="line"><span class="cl"><span class="c1"># tanzu cluster create tkg-cluster-1 gives the cluster the name tkg-cluster-1</span>
</span></span><span class="line"><span class="cl"><span class="c1"># --namespace is the namespace I have created in my management cluster to place this workload cluster in</span>
</span></span><span class="line"><span class="cl"><span class="c1"># --file points to the bootstrap.yaml file used to deploy the management cluster</span>
</span></span><span class="line"><span class="cl"><span class="c1"># --dry-run &gt; generates my workload-cluster.yaml file called tkg-cluster-1.yaml under the folder workload-cluster</span>
</span></span></code></pre></div><p>This process convert the flat bootstrap.yaml file to a cluster-class config-file.</p>
<p>The most interesting part in this file is whether the placement constraints have been considered. Lets have a look:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">controlPlane</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">value</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">machine</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">diskGiB</span><span class="p">:</span><span class="w"> </span><span class="m">20</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">memoryMiB</span><span class="p">:</span><span class="w"> </span><span class="m">4096</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">numCPUs</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">worker</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">value</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">machine</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">diskGiB</span><span class="p">:</span><span class="w"> </span><span class="m">20</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">memoryMiB</span><span class="p">:</span><span class="w"> </span><span class="m">4096</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">numCPUs</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">controlPlaneZoneMatchingLabels</span><span class="w"> </span><span class="c"># check</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">value</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">region</span><span class="p">:</span><span class="w"> </span><span class="l">k8s-region</span><span class="w"> </span><span class="c"># check - will place my control planes only in the zones with the correct label</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">tkg-cp</span><span class="p">:</span><span class="w"> </span><span class="l">allowed</span><span class="w"> </span><span class="c"># check - will place my control planes only in the zones with the correct label</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">security</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">value</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">fileIntegrityMonitoring</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">imagePolicy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">pullAlways</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">webhook</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">allowTTL</span><span class="p">:</span><span class="w"> </span><span class="m">50</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">defaultAllow</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">denyTTL</span><span class="p">:</span><span class="w"> </span><span class="m">60</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">retryBackoff</span><span class="p">:</span><span class="w"> </span><span class="m">500</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">kubeletOptions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">eventQPS</span><span class="p">:</span><span class="w"> </span><span class="m">50</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">streamConnectionIdleTimeout</span><span class="p">:</span><span class="w"> </span><span class="l">4h0m0s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">systemCryptoPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l">v1.26.5+vmware.2-tkg.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">workers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">machineDeployments</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">class</span><span class="p">:</span><span class="w"> </span><span class="l">tkg-worker</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">failureDomain</span><span class="p">:</span><span class="w"> </span><span class="l">wdc-zone-2</span><span class="w"> </span><span class="c"># check - worker in zone-2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">run.tanzu.vmware.com/resolve-os-image</span><span class="p">:</span><span class="w"> </span><span class="l">image-type=ova,os-name=ubuntu</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">md-0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">strategy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">RollingUpdate</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">class</span><span class="p">:</span><span class="w"> </span><span class="l">tkg-worker</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">failureDomain</span><span class="p">:</span><span class="w"> </span><span class="l">wdc-zone-3</span><span class="w"> </span><span class="c"># check - worker in zone-3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">run.tanzu.vmware.com/resolve-os-image</span><span class="p">:</span><span class="w"> </span><span class="l">image-type=ova,os-name=ubuntu</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">md-1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">strategy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">RollingUpdate</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">class</span><span class="p">:</span><span class="w"> </span><span class="l">tkg-worker</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">failureDomain</span><span class="p">:</span><span class="w"> </span><span class="l">wdc-zone-3</span><span class="w"> </span><span class="c"># check - worker in zone-3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">run.tanzu.vmware.com/resolve-os-image</span><span class="p">:</span><span class="w"> </span><span class="l">image-type=ova,os-name=ubuntu</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">md-2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">strategy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">RollingUpdate</span><span class="w">
</span></span></span></code></pre></div><p>The file  looks good. Lets deploy it.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@tkg-bootstrap:~$ tanzu cluster create --file tkg-cluster-1.yaml
</span></span><span class="line"><span class="cl">Validating configuration...
</span></span><span class="line"><span class="cl">cluster class based input file detected, getting tkr version from input yaml
</span></span><span class="line"><span class="cl">input TKR Version: v1.26.5+vmware.2-tkg.1
</span></span><span class="line"><span class="cl">TKR Version v1.26.5+vmware.2-tkg.1, Kubernetes Version v1.26.5+vmware.2-tkg.1 configured
</span></span><span class="line"><span class="cl">Warning: Pinniped configuration not found<span class="p">;</span> Authentication via Pinniped will not be <span class="nb">set</span> up in this cluster. If you wish to <span class="nb">set</span> up Pinniped after the cluster is created, please refer to the documentation.
</span></span><span class="line"><span class="cl">Skip checking VIP overlap when the VIP is empty. Cluster<span class="s1">&#39;s endpoint VIP will be allocated by NSX ALB IPAM.
</span></span></span><span class="line"><span class="cl"><span class="s1">creating workload cluster &#39;</span>tkg-cluster-1<span class="err">&#39;</span>...
</span></span></code></pre></div><p>After a couple of minutes or cups of coffee (depends on your environment):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">Workload cluster <span class="s1">&#39;tkg-cluster-1&#39;</span> created
</span></span></code></pre></div><p>Now lets go the same with the nodes here also, where are they placed in my vSphere environment.</p>
<p>Control plane nodes placement:</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/08/29/tkg-2.3-deployment-in-multiple-availability-zones/images/image-20230830145333591.png"
        alt="tkg-wld-cp-1"
      />
      
    </figure>
</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/08/29/tkg-2.3-deployment-in-multiple-availability-zones/images/image-20230830145408244.png"
        alt="tkg-wld-cp-2"
      />
      
    </figure>
</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/08/29/tkg-2.3-deployment-in-multiple-availability-zones/images/image-20230830145444962.png"
        alt="tkg-wld-cp-3"
      />
      
    </figure>
</p>
<p>Worker nodes placemement:</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/08/29/tkg-2.3-deployment-in-multiple-availability-zones/images/image-20230830145556003.png"
        alt="tkg-wld-worker-1"
      />
      
    </figure>
</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/08/29/tkg-2.3-deployment-in-multiple-availability-zones/images/image-20230830145626914.png"
        alt="tkg-wld-worker-2"
      />
      
    </figure>
</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/08/29/tkg-2.3-deployment-in-multiple-availability-zones/images/image-20230830145655861.png"
        alt="tkg-wld-worker-3"
      />
      
    </figure>
</p>
<p>Nice, just according to plan.</p>


<h3 class="relative group">TKG Workload Cluster deployment with multi-availability-zones - using vCenter host-groups as AZs 
    <div id="tkg-workload-cluster-deployment-with-multi-availability-zones---using-vcenter-host-groups-as-azs" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#tkg-workload-cluster-deployment-with-multi-availability-zones---using-vcenter-host-groups-as-azs" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>In the first workload cluster deployment above I deployed the cluster to use my availability zones configured to use vSphere clusters as AZs. Now I will deploy a second workload cluster using the zones <a href="#tkg-multi-az-config-file---using-vcenter-drs-host-groups">here</a> added after the TKG management cluster was deployed. I will just reuse the workload-cluster.yaml from the first cluster, edit the names, namespaces and zones/regions accordingly.</p>
<p>Lets deploy it:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@tkg-bootstrap:~$ tanzu cluster create --file tkg-cluster-2-host-groups.yaml
</span></span><span class="line"><span class="cl">Validating configuration...
</span></span><span class="line"><span class="cl">cluster class based input file detected, getting tkr version from input yaml
</span></span><span class="line"><span class="cl">input TKR Version: v1.26.5+vmware.2-tkg.1
</span></span><span class="line"><span class="cl">TKR Version v1.26.5+vmware.2-tkg.1, Kubernetes Version v1.26.5+vmware.2-tkg.1 configured
</span></span><span class="line"><span class="cl">Warning: Pinniped configuration not found<span class="p">;</span> Authentication via Pinniped will not be <span class="nb">set</span> up in this cluster. If you wish to <span class="nb">set</span> up Pinniped after the cluster is created, please refer to the documentation.
</span></span><span class="line"><span class="cl">Skip checking VIP overlap when the VIP is empty. Clusters endpoint VIP will be allocated by NSX ALB IPAM.
</span></span><span class="line"><span class="cl">creating workload cluster <span class="s1">&#39;tkg-cluster-2-hostgroup&#39;</span>...
</span></span><span class="line"><span class="cl">waiting <span class="k">for</span> cluster to be initialized...
</span></span><span class="line"><span class="cl">cluster control plane is still being initialized: ScalingUp
</span></span><span class="line"><span class="cl">waiting <span class="k">for</span> cluster nodes to be available...
</span></span><span class="line"><span class="cl">unable to get the autoscaler deployment, maybe it is not exist
</span></span><span class="line"><span class="cl">waiting <span class="k">for</span> addons core packages installation...
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Workload cluster <span class="s1">&#39;tkg-cluster-2-hostgroup&#39;</span> created
</span></span></code></pre></div><p>This cluster should now only be deployed to Cluster 3, using the DRS host-group based Availability Zones.</p>
<p>And here the cluster has been deployed in Cluster-3, using the AZs <em>rack1</em> and <em>rack2</em> (nodes <em>tkg-cluster-2-hostgroup-xxxx</em>)</p>
<img src=images/image-20230831165211734.png style="width:400px" />
<p>Next up is to deploy a test application in the workload cluster utilizing the availability zones.</p>


<h2 class="relative group">Deploy applications on workload cluster in a multi-az environment 
    <div id="deploy-applications-on-workload-cluster-in-a-multi-az-environment" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#deploy-applications-on-workload-cluster-in-a-multi-az-environment" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>In my scenario so far I have placed all the control plane nodes evenly distributed across all the vSphere Clusters/AZs. The worker nodes on the other hand is placed only on AZ-2 and AZ-3. Now I want to deploy an application in my workload cluster where I do a placement decision on where the different pods will be placed, according to the available zones the workload cluster is in.</p>


<h3 class="relative group">Application/pod placement using nodeAffinity 
    <div id="applicationpod-placement-using-nodeaffinity" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#applicationpod-placement-using-nodeaffinity" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>When a TKG workload cluster or TKG management cluster has been deployed with availability zones, the nodes will get updated label information that is referencing the availability zone the worker and control-plane nodes have been deployed in. This information can be used if one want to deploy the application in a specific zone. So in this chapter I will do exactly that. Deploy an application consisting of 4 pods, define the placement of the pods using the zone information available on the nodes.</p>
<p>To find the labels for the different placements I need to have a look at the nodes. There should be some labels indicating where they reside. I will clean up the output as I am only looking for something that starts with <em>topology</em> and define the zones, and the worker nodes only. So the output below gives me this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@tkg-bootstrap:~$ k get nodes --show-labels
</span></span><span class="line"><span class="cl">NAME                                              STATUS   ROLES           AGE   VERSION            LABELS
</span></span><span class="line"><span class="cl">tkg-cluster-1-md-0-b4pfl-6d66f94fcdxnjnf6-t57dj   Ready    &lt;none&gt;          82m   v1.26.5+vmware.2   topology.kubernetes.io/zone<span class="o">=</span>wdc-zone-2
</span></span><span class="line"><span class="cl">tkg-cluster-1-md-1-vfzhk-5b6bbbbc5cxqk85x-tj4df   Ready    &lt;none&gt;          82m   v1.26.5+vmware.2   topology.kubernetes.io/zone<span class="o">=</span>wdc-zone-3
</span></span><span class="line"><span class="cl">tkg-cluster-1-md-2-rpk4z-78466846fdxkdjsp-vfd9h   Ready    &lt;none&gt;          82m   v1.26.5+vmware.2   topology.kubernetes.io/zone<span class="o">=</span>wdc-zone-3
</span></span></code></pre></div><p>One can also see the failuredomain  placement using the following commands:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@tkg-bootstrap:~$ kubectl get machinedeployment -n tkg-ns-1  -o<span class="o">=</span>custom-columns<span class="o">=</span>NAME:.metadata.name,FAILUREDOMAIN:.spec.template.spec.failureDomain
</span></span><span class="line"><span class="cl">NAME                       FAILUREDOMAIN
</span></span><span class="line"><span class="cl">tkg-cluster-1-md-0-b4pfl   wdc-zone-2
</span></span><span class="line"><span class="cl">tkg-cluster-1-md-1-vfzhk   wdc-zone-3
</span></span><span class="line"><span class="cl">tkg-cluster-1-md-2-rpk4z   wdc-zone-3
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@tkg-bootstrap:~$ kubectl get machine -n tkg-ns-1 -o<span class="o">=</span>custom-columns<span class="o">=</span>NAME:.metadata.name,FAILUREDOMAIN:.spec.failureDomain
</span></span><span class="line"><span class="cl">NAME                                              FAILUREDOMAIN
</span></span><span class="line"><span class="cl">tkg-cluster-1-md-0-b4pfl-6d66f94fcdxnjnf6-t57dj   wdc-zone-2
</span></span><span class="line"><span class="cl">tkg-cluster-1-md-1-vfzhk-5b6bbbbc5cxqk85x-tj4df   wdc-zone-3
</span></span><span class="line"><span class="cl">tkg-cluster-1-md-2-rpk4z-78466846fdxkdjsp-vfd9h   wdc-zone-3
</span></span><span class="line"><span class="cl">tkg-cluster-1-znr8h-4v2tm                         wdc-zone-2
</span></span><span class="line"><span class="cl">tkg-cluster-1-znr8h-d72g5                         wdc-zone-1
</span></span><span class="line"><span class="cl">tkg-cluster-1-znr8h-j6899                         wdc-zone-3
</span></span></code></pre></div><p>Now I need to update my application deployment adding a section where I can define the placement information, this is done by using <em>affinity</em>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="w">      </span><span class="nt">affinity</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">nodeAffinity</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">requiredDuringSchedulingIgnoredDuringExecution</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">nodeSelectorTerms</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">matchExpressions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">topology.kubernetes.io/zone</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l">In</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">values</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="l">wdc-zone-X</span><span class="w">
</span></span></span></code></pre></div><p>My example application has been updated with the relevant information below. With this deployment I am allowing deployment in the wdc-zone-2 and wdc-zone-3 for the yelb-ui deployment, the 3 other deployments are only allowed to be placed in wdc-zone-3.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">redis-server</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">redis-server</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">tier</span><span class="p">:</span><span class="w"> </span><span class="l">cache</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">yelb</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterIP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">6379</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">redis-server</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">tier</span><span class="p">:</span><span class="w"> </span><span class="l">cache</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">yelb-db</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">yelb-db</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">tier</span><span class="p">:</span><span class="w"> </span><span class="l">backenddb</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">yelb</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterIP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">5432</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">yelb-db</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">tier</span><span class="p">:</span><span class="w"> </span><span class="l">backenddb</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">yelb-appserver</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">yelb-appserver</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">tier</span><span class="p">:</span><span class="w"> </span><span class="l">middletier</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">yelb</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterIP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">4567</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">yelb-appserver</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">tier</span><span class="p">:</span><span class="w"> </span><span class="l">middletier</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">yelb-ui</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">yelb-ui</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">tier</span><span class="p">:</span><span class="w"> </span><span class="l">frontend</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">yelb</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">loadBalancerClass</span><span class="p">:</span><span class="w"> </span><span class="l">ako.vmware.com/avi-lb</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">LoadBalancer</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">yelb-ui</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">tier</span><span class="p">:</span><span class="w"> </span><span class="l">frontend</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">yelb-ui</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">yelb</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">yelb-ui</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">yelb-ui</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">tier</span><span class="p">:</span><span class="w"> </span><span class="l">frontend</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">affinity</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">nodeAffinity</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">requiredDuringSchedulingIgnoredDuringExecution</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">nodeSelectorTerms</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">matchExpressions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">topology.kubernetes.io/zone</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l">In</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">values</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="l">wdc-zone-2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="l">wdc-zone-3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">yelb-ui</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">registry.guzware.net/yelb/yelb-ui:0.3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Always</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">redis-server</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">yelb</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">redis-server</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">redis-server</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">tier</span><span class="p">:</span><span class="w"> </span><span class="l">cache</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">affinity</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">nodeAffinity</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">requiredDuringSchedulingIgnoredDuringExecution</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">nodeSelectorTerms</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">matchExpressions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">topology.kubernetes.io/zone</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l">In</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">values</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="l">wdc-zone-3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">redis-server</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">registry.guzware.net/yelb/redis:4.0.2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">6379</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">yelb-db</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">yelb</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">yelb-db</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">yelb-db</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">tier</span><span class="p">:</span><span class="w"> </span><span class="l">backenddb</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">affinity</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">nodeAffinity</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">requiredDuringSchedulingIgnoredDuringExecution</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">nodeSelectorTerms</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">matchExpressions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">topology.kubernetes.io/zone</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l">In</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">values</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="l">wdc-zone-3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">yelb-db</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">registry.guzware.net/yelb/yelb-db:0.3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">5432</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">yelb-appserver</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">yelb</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">yelb-appserver</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">yelb-appserver</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">tier</span><span class="p">:</span><span class="w"> </span><span class="l">middletier</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">affinity</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">nodeAffinity</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">requiredDuringSchedulingIgnoredDuringExecution</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">nodeSelectorTerms</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">matchExpressions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">topology.kubernetes.io/zone</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l">In</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">values</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="l">wdc-zone-3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">yelb-appserver</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">registry.guzware.net/yelb/yelb-appserver:0.3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">4567</span><span class="w">
</span></span></span></code></pre></div><p>Now to apply it and check the outcome.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@tkg-bootstrap:~$ k get pods -n yelb -o wide
</span></span><span class="line"><span class="cl">NAME                            READY   STATUS    RESTARTS   AGE   IP            NODE                                              NOMINATED NODE   READINESS GATES
</span></span><span class="line"><span class="cl">redis-server-5997cbfdf7-f7wgh   1/1     Running   <span class="m">0</span>          10m   100.96.3.16   tkg-cluster-1-md-1-vfzhk-5b6bbbbc5cxqk85x-tj4df   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">yelb-appserver-6d65cc8-xt82g    1/1     Running   <span class="m">0</span>          10m   100.96.3.17   tkg-cluster-1-md-1-vfzhk-5b6bbbbc5cxqk85x-tj4df   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">yelb-db-7d4c56597f-58zd4        1/1     Running   <span class="m">0</span>          10m   100.96.2.3    tkg-cluster-1-md-2-rpk4z-78466846fdxkdjsp-vfd9h   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">yelb-ui-6c6fdfc66f-ngjnm        1/1     Running   <span class="m">0</span>          10m   100.96.2.2    tkg-cluster-1-md-2-rpk4z-78466846fdxkdjsp-vfd9h   &lt;none&gt;           &lt;none&gt;
</span></span></code></pre></div><p>If I compare this to the nodes below:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">NAME                                              FAILUREDOMAIN
</span></span><span class="line"><span class="cl">tkg-cluster-1-md-0-b4pfl-6d66f94fcdxnjnf6-t57dj   wdc-zone-2
</span></span><span class="line"><span class="cl">tkg-cluster-1-md-1-vfzhk-5b6bbbbc5cxqk85x-tj4df   wdc-zone-3
</span></span><span class="line"><span class="cl">tkg-cluster-1-md-2-rpk4z-78466846fdxkdjsp-vfd9h   wdc-zone-3
</span></span></code></pre></div><p>So far eveything looks good. All pods have been deployed in wdc-zone-3. The ui-pod is also allowed to be placed in wdc-zone-2.
What happens if I scale it up with a couple of pods.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@tkg-bootstrap:~$ k scale deployment -n yelb --replicas <span class="m">5</span> yelb-ui
</span></span><span class="line"><span class="cl">deployment.apps/yelb-ui scaled
</span></span><span class="line"><span class="cl">NAME                            READY   STATUS    RESTARTS   AGE    IP            NODE                                              NOMINATED NODE   READINESS GATES
</span></span><span class="line"><span class="cl">redis-server-5997cbfdf7-f7wgh   1/1     Running   <span class="m">0</span>          22m    100.96.3.16   tkg-cluster-1-md-1-vfzhk-5b6bbbbc5cxqk85x-tj4df   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">yelb-appserver-6d65cc8-xt82g    1/1     Running   <span class="m">0</span>          22m    100.96.3.17   tkg-cluster-1-md-1-vfzhk-5b6bbbbc5cxqk85x-tj4df   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">yelb-db-7d4c56597f-58zd4        1/1     Running   <span class="m">0</span>          22m    100.96.2.3    tkg-cluster-1-md-2-rpk4z-78466846fdxkdjsp-vfd9h   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">yelb-ui-6c6fdfc66f-59zqs        1/1     Running   <span class="m">0</span>          5m2s   100.96.1.5    tkg-cluster-1-md-0-b4pfl-6d66f94fcdxnjnf6-t57dj   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">yelb-ui-6c6fdfc66f-8w48g        1/1     Running   <span class="m">0</span>          5m2s   100.96.2.4    tkg-cluster-1-md-2-rpk4z-78466846fdxkdjsp-vfd9h   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">yelb-ui-6c6fdfc66f-mprxx        1/1     Running   <span class="m">0</span>          5m2s   100.96.1.4    tkg-cluster-1-md-0-b4pfl-6d66f94fcdxnjnf6-t57dj   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">yelb-ui-6c6fdfc66f-n9slz        1/1     Running   <span class="m">0</span>          5m2s   100.96.3.19   tkg-cluster-1-md-1-vfzhk-5b6bbbbc5cxqk85x-tj4df   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">yelb-ui-6c6fdfc66f-ngjnm        1/1     Running   <span class="m">0</span>          22m    100.96.2.2    tkg-cluster-1-md-2-rpk4z-78466846fdxkdjsp-vfd9h   &lt;none&gt;           &lt;none&gt;
</span></span></code></pre></div><p>Two of the ui-pods has been placed in wdc-zone-2</p>
<p>Now that I have full control of the app placement, lets test some failure scenarios.</p>


<h2 class="relative group">Failure simulations 
    <div id="failure-simulations" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#failure-simulations" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>In this chapter I will quickly simulate an outage of Zone-2 or vSphere Cluster-2 where the 1 of the TKG mgmt control plane is residing, 1 of the workload Cluster-1 is residing plus 1 worker node for both the management cluster and tkg-cluster-1:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># TKG management cluster placement in my vSphere environment</span>
</span></span><span class="line"><span class="cl">Nodes in the cluster with the <span class="s1">&#39;node.cluster.x-k8s.io/esxi-host&#39;</span> label:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Node: tkg-wdc-az-mgmt-hgt2v-hb7vj <span class="p">|</span> ESXi Host: esx04.cpod-nsxam-wdc <span class="c1">#controlplane node on Zone-1</span>
</span></span><span class="line"><span class="cl">Node: tkg-wdc-az-mgmt-hgt2v-w6r64 <span class="p">|</span> ESXi Host: esx03.cpod-nsxam-wdc-03 <span class="c1">#controlplane node on Zone-3</span>
</span></span><span class="line"><span class="cl">Node: tkg-wdc-az-mgmt-hgt2v-zl5k9 <span class="p">|</span> ESXi Host: esx04.cpod-nsxam-wdc-02 <span class="c1">#controlplane node on Zone-2</span>
</span></span><span class="line"><span class="cl">Node: tkg-wdc-az-mgmt-md-0-xn6cg-79f97555c7x45h4b-6ghbg <span class="p">|</span> ESXi Host: esx04.cpod-nsxam-wdc-02 <span class="c1">#worker node on Zone 2</span>
</span></span><span class="line"><span class="cl">Node: tkg-wdc-az-mgmt-md-1-zmr4d-56ff586997xxndn8-hzs7f <span class="p">|</span> ESXi Host: esx01.cpod-nsxam-wdc-03 <span class="c1">#worker node on Zone-3</span>
</span></span><span class="line"><span class="cl">Node: tkg-wdc-az-mgmt-md-2-67dm4-64f79b7dd7x6f56s-76qhv <span class="p">|</span> ESXi Host: esx02.cpod-nsxam-wdc-03 <span class="c1">#worker node on Zone-3</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># TKG workload cluster (tkg-cluster-1) placement in my vSphere environment</span>
</span></span><span class="line"><span class="cl">Nodes in the cluster with the <span class="s1">&#39;node.cluster.x-k8s.io/esxi-host&#39;</span> label:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Node: tkg-cluster-1-md-0-b4pfl-6d66f94fcdxnjnf6-t57dj <span class="p">|</span> ESXi Host: esx03.cpod-nsxam-wdc-02 <span class="c1">#worker node on Zone-2</span>
</span></span><span class="line"><span class="cl">Node: tkg-cluster-1-md-1-vfzhk-5b6bbbbc5cxqk85x-tj4df <span class="p">|</span> ESXi Host: esx02.cpod-nsxam-wdc-03 <span class="c1">#worker node on Zone-3</span>
</span></span><span class="line"><span class="cl">Node: tkg-cluster-1-md-2-rpk4z-78466846fdxkdjsp-vfd9h <span class="p">|</span> ESXi Host: esx03.cpod-nsxam-wdc-03 <span class="c1">#worker node on Zone-3</span>
</span></span><span class="line"><span class="cl">Node: tkg-cluster-1-znr8h-4v2tm <span class="p">|</span> ESXi Host: esx03.cpod-nsxam-wdc-02 <span class="c1">#controlplane node on Zone-2</span>
</span></span><span class="line"><span class="cl">Node: tkg-cluster-1-znr8h-d72g5 <span class="p">|</span> ESXi Host: esx04.cpod-nsxam-wdc.az-wdc <span class="c1">#controlplane node on Zone-1</span>
</span></span><span class="line"><span class="cl">Node: tkg-cluster-1-znr8h-j6899 <span class="p">|</span> ESXi Host: esx04.cpod-nsxam-wdc-03.az-wdc <span class="c1">#controlplane node on Zone-3</span>
</span></span></code></pre></div><p>The Yelb application pods placement:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">NAME                            READY   STATUS    RESTARTS   AGE     IP            NODE                                              NOMINATED NODE   READINESS GATES
</span></span><span class="line"><span class="cl">redis-server-5997cbfdf7-f7wgh   1/1     Running   <span class="m">0</span>          2d22h   100.96.3.16   tkg-cluster-1-md-1-vfzhk-5b6bbbbc5cxqk85x-tj4df   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">yelb-appserver-6d65cc8-xt82g    1/1     Running   <span class="m">0</span>          2d22h   100.96.3.17   tkg-cluster-1-md-1-vfzhk-5b6bbbbc5cxqk85x-tj4df   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">yelb-db-7d4c56597f-58zd4        1/1     Running   <span class="m">0</span>          2d22h   100.96.2.3    tkg-cluster-1-md-2-rpk4z-78466846fdxkdjsp-vfd9h   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">yelb-ui-6c6fdfc66f-59zqs        1/1     Running   <span class="m">0</span>          2d22h   100.96.1.5    tkg-cluster-1-md-0-b4pfl-6d66f94fcdxnjnf6-t57dj   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">yelb-ui-6c6fdfc66f-8w48g        1/1     Running   <span class="m">0</span>          2d22h   100.96.2.4    tkg-cluster-1-md-2-rpk4z-78466846fdxkdjsp-vfd9h   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">yelb-ui-6c6fdfc66f-mprxx        1/1     Running   <span class="m">0</span>          2d22h   100.96.1.4    tkg-cluster-1-md-0-b4pfl-6d66f94fcdxnjnf6-t57dj   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">yelb-ui-6c6fdfc66f-n9slz        1/1     Running   <span class="m">0</span>          2d22h   100.96.3.19   tkg-cluster-1-md-1-vfzhk-5b6bbbbc5cxqk85x-tj4df   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">yelb-ui-6c6fdfc66f-ngjnm        1/1     Running   <span class="m">0</span>          2d22h   100.96.2.2    tkg-cluster-1-md-2-rpk4z-78466846fdxkdjsp-vfd9h   &lt;none&gt;           &lt;none&gt;
</span></span></code></pre></div><p>What I want to achieve is an available TKG mgmt cluster control plane, TKG workload tkg-cluster-1 control plane, and the Yelb application still up and running. The simple test I will do is to just go into vCenter power off all the nodes for these TKG cluster in Zone-2/vSphere Cluster-2. I could also shutdown the whole ESXi hosts but I have other services running there depending on this cluster also.</p>
<p>One last observation to see status of the two control planes, or K8s API endpoints is from my NSX-ALB dashboard for both TKG mgmt cluster and TKG-cluster-1.</p>
<p>The TKG mgmt cluster controlplanes/k8s-api endpoint:</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/08/29/tkg-2.3-deployment-in-multiple-availability-zones/images/image-20230904120530264.png"
        alt="tkg-mgmt"
      />
      
    </figure>
</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/08/29/tkg-2.3-deployment-in-multiple-availability-zones/images/image-20230904120605059.png"
        alt="tkg-wld-cluster-1"
      />
      
    </figure>
</p>
<p>Before shutting down I have full access to both the mgmt and tkg-cluster-1 k8s api, and the yelb-app ui is accessible.</p>
<p>Now, powering off the nodes:</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/08/29/tkg-2.3-deployment-in-multiple-availability-zones/images/image-20230904120809536.png"
        alt="power-off"
      />
      
    </figure>
</p>
<p>Some observations after power off:</p>
<p>From NSX-ALB</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/08/29/tkg-2.3-deployment-in-multiple-availability-zones/images/image-20230904121016839.png"
        alt="missing cp nodes"
      />
      
    </figure>
</p>
<p>Yelb app is still available:</p>
<img src=images/image-20230904121051926.png style="width:500px" />
<p>Is the k8s api available?</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">NAME                                                STATUS     ROLES           AGE     VERSION
</span></span><span class="line"><span class="cl">tkg-wdc-az-mgmt-hgt2v-hb7vj                         Ready      control-plane   4d23h   v1.26.5+vmware.2
</span></span><span class="line"><span class="cl">tkg-wdc-az-mgmt-hgt2v-w6r64                         Ready      control-plane   4d23h   v1.26.5+vmware.2
</span></span><span class="line"><span class="cl">tkg-wdc-az-mgmt-hgt2v-zl5k9                         NotReady   control-plane   4d23h   v1.26.5+vmware.2
</span></span><span class="line"><span class="cl">tkg-wdc-az-mgmt-md-0-xn6cg-79f97555c7x45h4b-6ghbg   NotReady   &lt;none&gt;          4d23h   v1.26.5+vmware.2
</span></span><span class="line"><span class="cl">tkg-wdc-az-mgmt-md-1-zmr4d-56ff586997xxndn8-hzs7f   Ready      &lt;none&gt;          4d23h   v1.26.5+vmware.2
</span></span><span class="line"><span class="cl">tkg-wdc-az-mgmt-md-2-67dm4-64f79b7dd7x6f56s-76qhv   Ready      &lt;none&gt;          4d23h   v1.26.5+vmware.2
</span></span></code></pre></div><p>The management cluster is, though complaining on the two nodes above as not ready. (They are powered off).
The workload cluster k8s api available?</p>
<pre tabindex="0"><code>NAME                                              STATUS     ROLES           AGE     VERSION
tkg-cluster-1-md-0-b4pfl-6d66f94fcdxnjnf6-t57dj   Ready      &lt;none&gt;          4d22h   v1.26.5+vmware.2
tkg-cluster-1-md-1-vfzhk-5b6bbbbc5cxqk85x-tj4df   Ready      &lt;none&gt;          4d22h   v1.26.5+vmware.2
tkg-cluster-1-md-2-rpk4z-78466846fdxkdjsp-vfd9h   Ready      &lt;none&gt;          4d22h   v1.26.5+vmware.2
tkg-cluster-1-znr8h-4v2tm                         NotReady   control-plane   4d21h   v1.26.5+vmware.2
tkg-cluster-1-znr8h-d72g5                         Ready      control-plane   4d21h   v1.26.5+vmware.2
tkg-cluster-1-znr8h-j6899                         Ready      control-plane   4d22h   v1.26.5+vmware.2
</code></pre><p>It is. though a control plane node is down.</p>
<p>The Yelb pods:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">NAME                            READY   STATUS    RESTARTS        AGE     IP            NODE                                              NOMINATED NODE   READINESS GATES
</span></span><span class="line"><span class="cl">redis-server-5997cbfdf7-f7wgh   1/1     Running   <span class="m">0</span>               2d22h   100.96.3.16   tkg-cluster-1-md-1-vfzhk-5b6bbbbc5cxqk85x-tj4df   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">yelb-appserver-6d65cc8-xt82g    1/1     Running   <span class="m">0</span>               2d22h   100.96.3.17   tkg-cluster-1-md-1-vfzhk-5b6bbbbc5cxqk85x-tj4df   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">yelb-db-7d4c56597f-58zd4        1/1     Running   <span class="m">0</span>               2d22h   100.96.2.3    tkg-cluster-1-md-2-rpk4z-78466846fdxkdjsp-vfd9h   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">yelb-ui-6c6fdfc66f-59zqs        1/1     Running   <span class="m">1</span> <span class="o">(</span>6m24s ago<span class="o">)</span>   2d22h   100.96.1.5    tkg-cluster-1-md-0-b4pfl-6d66f94fcdxnjnf6-t57dj   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">yelb-ui-6c6fdfc66f-8w48g        1/1     Running   <span class="m">0</span>               2d22h   100.96.2.4    tkg-cluster-1-md-2-rpk4z-78466846fdxkdjsp-vfd9h   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">yelb-ui-6c6fdfc66f-mprxx        1/1     Running   <span class="m">1</span> <span class="o">(</span>6m23s ago<span class="o">)</span>   2d22h   100.96.1.2    tkg-cluster-1-md-0-b4pfl-6d66f94fcdxnjnf6-t57dj   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">yelb-ui-6c6fdfc66f-n9slz        1/1     Running   <span class="m">0</span>               2d22h   100.96.3.19   tkg-cluster-1-md-1-vfzhk-5b6bbbbc5cxqk85x-tj4df   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">yelb-ui-6c6fdfc66f-ngjnm        1/1     Running   <span class="m">0</span>               2d22h   100.96.2.2    tkg-cluster-1-md-2-rpk4z-78466846fdxkdjsp-vfd9h   &lt;none&gt;           &lt;none&gt;
</span></span></code></pre></div><p>So it seems everything is still reacheable still after loosing Zone-2. When I did power off the nodes the first time it took around a minute before they were powered back on. I powered them down again and now it seems they are not being powered on again. Will wait a bit and see, otherwise I will try to power them on manually.
After a longer while the tkg-cluster-1 nodes have now this status:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">NAME                                              STATUS                        ROLES           AGE     VERSION
</span></span><span class="line"><span class="cl">tkg-cluster-1-md-0-b4pfl-6d66f94fcdxnjnf6-t57dj   NotReady,SchedulingDisabled   &lt;none&gt;          4d22h   v1.26.5+vmware.2
</span></span><span class="line"><span class="cl">tkg-cluster-1-md-1-vfzhk-5b6bbbbc5cxqk85x-tj4df   Ready                         &lt;none&gt;          4d22h   v1.26.5+vmware.2
</span></span><span class="line"><span class="cl">tkg-cluster-1-md-2-rpk4z-78466846fdxkdjsp-vfd9h   Ready                         &lt;none&gt;          4d22h   v1.26.5+vmware.2
</span></span><span class="line"><span class="cl">tkg-cluster-1-znr8h-4v2tm                         NotReady,SchedulingDisabled   control-plane   4d21h   v1.26.5+vmware.2
</span></span><span class="line"><span class="cl">tkg-cluster-1-znr8h-d72g5                         Ready                         control-plane   4d22h   v1.26.5+vmware.2
</span></span><span class="line"><span class="cl">tkg-cluster-1-znr8h-j6899                         Ready                         control-plane   4d22h   v1.26.5+vmware.2
</span></span></code></pre></div><p>I will try to manually power the nodes back on. I did not have the chance to do that, they are now being deleted and recreated! Wow, cool</p>
<img src=images/image-20230904122601139.png style="width:500px" />


<h2 class="relative group">Update existing TKG cluster to use new Availability Zones 
    <div id="update-existing-tkg-cluster-to-use-new-availability-zones" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#update-existing-tkg-cluster-to-use-new-availability-zones" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>For details on how to update existing cluster to use new availabilty zones follow the official documentation <a href="https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid/2.3/using-tkg/workload-clusters-multi-az-vsphere.html#update-existing-clusters-to-use-multiple-or-different-availability-zones-6" target="_blank">here</a></p>


<h2 class="relative group">Wrapping up 
    <div id="wrapping-up" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#wrapping-up" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>This finishes the exploration of this useful feature in TKG 2.3. It is very flexible and allows for very robust design of node placement. Opens up for designs with high availability requirements. I do like very much the choice to use vSphere clusters, vCenter servers and DRS host-groups as the different objects in vCenter to use.</p>

          
          
          
        </div>
        
        

        
        
  
  <section class="flex flex-row flex-wrap justify-center pt-4 text-xl">
    
      
      <a
      target="_blank"
      class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800"
      href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://blog.andreasm.io/2023/08/29/tkg-2.3-deployment-in-multiple-availability-zones/&amp;title=TKG%202.3%20deployment%20in%20multiple%20availability%20zones"
      title="Share on LinkedIn"
      aria-label="Share on LinkedIn"
      >
      

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg>

  </span>


    </a>
      
    
      
      <a
      target="_blank"
      class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800"
      href="https://twitter.com/intent/tweet/?url=https://blog.andreasm.io/2023/08/29/tkg-2.3-deployment-in-multiple-availability-zones/&amp;text=TKG%202.3%20deployment%20in%20multiple%20availability%20zones"
      title="Tweet on Twitter"
      aria-label="Tweet on Twitter"
      >
      

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8L200.7 275.5 26.8 48H172.4L272.9 180.9 389.2 48zM364.4 421.8h39.1L151.1 88h-42L364.4 421.8z"/></svg>
  </span>


    </a>
      
    
      
      <a
      target="_blank"
      class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800"
      href="https://s2f.kytta.dev/?text=TKG%202.3%20deployment%20in%20multiple%20availability%20zones%20https://blog.andreasm.io/2023/08/29/tkg-2.3-deployment-in-multiple-availability-zones/"
      title=""
      aria-label=""
      >
      

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48 0 0 0-63.72 28.5-63.72 125.7 0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54 0 0 1-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"/></svg>

  </span>


    </a>
      
    
      
      <a
      target="_blank"
      class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800"
      href="mailto:?body=https://blog.andreasm.io/2023/08/29/tkg-2.3-deployment-in-multiple-availability-zones/&amp;subject=TKG%202.3%20deployment%20in%20multiple%20availability%20zones"
      title="Send via email"
      aria-label="Send via email"
      >
      

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M207.8 20.73c-93.45 18.32-168.7 93.66-187 187.1c-27.64 140.9 68.65 266.2 199.1 285.1c19.01 2.888 36.17-12.26 36.17-31.49l.0001-.6631c0-15.74-11.44-28.88-26.84-31.24c-84.35-12.98-149.2-86.13-149.2-174.2c0-102.9 88.61-185.5 193.4-175.4c91.54 8.869 158.6 91.25 158.6 183.2l0 16.16c0 22.09-17.94 40.05-40 40.05s-40.01-17.96-40.01-40.05v-120.1c0-8.847-7.161-16.02-16.01-16.02l-31.98 .0036c-7.299 0-13.2 4.992-15.12 11.68c-24.85-12.15-54.24-16.38-86.06-5.106c-38.75 13.73-68.12 48.91-73.72 89.64c-9.483 69.01 43.81 128 110.9 128c26.44 0 50.43-9.544 69.59-24.88c24 31.3 65.23 48.69 109.4 37.49C465.2 369.3 496 324.1 495.1 277.2V256.3C495.1 107.1 361.2-9.332 207.8 20.73zM239.1 304.3c-26.47 0-48-21.56-48-48.05s21.53-48.05 48-48.05s48 21.56 48 48.05S266.5 304.3 239.1 304.3z"/></svg>

  </span>


    </a>
      
    
  </section>


        


<h2 class="mt-8 text-2xl font-extrabold mb-10">Related</h2>
<section class="w-full grid gap-4 sm:grid-cols-2 md:grid-cols-3">
  
  

  <a href="/2023/05/03/vsphere-with-tanzu-and-multi-zones-part2/" class="min-w-full">
    
    <div class="min-h-full border border-neutral-200 dark:border-neutral-700 border-2 rounded overflow-hidden shadow-2xl relative">
        
        <div class="w-full thumbnail_card_related nozoom" style="background-image:url(/2023/05/03/vsphere-with-tanzu-and-multi-zones-part2/feature-logo-vmware-tanzu.png);"></div>
        
      

      <div class="px-6 py-4">

        
        <div class="font-bold text-xl text-neutral-800 decoration-primary-500 hover:underline hover:underline-offset-2 dark:text-neutral"
          href="/2023/05/03/vsphere-with-tanzu-and-multi-zones-part2/">vSphere with Tanzu and Multi Zones part2</div>
        

        <div class="text-sm text-neutral-500 dark:text-neutral-400">
          











  





  



  













<div class="flex flex-row flex-wrap items-center">
  
  
  <time datetime="2023-05-03T07:34:47&#43;02:00">3 May 2023</time><span class="px-2 text-primary-500">&middot;</span><span>1627 words</span><span class="px-2 text-primary-500">&middot;</span><span title="Reading time">8 mins</span>
  

  
  
</div>


<div class="flex flex-row flex-wrap items-center">
  
  
  
  
  
  
  
  
  
  
  
</div>




<div class="flex flex-row flex-wrap items-center">
  
  
  
  
  
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/kubernetes/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Kubernetes
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/tanzu/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Tanzu
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/networking/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Networking
  </span>
</span>
  </span>
  
  
  
  
  
  
  
  
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/availability/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Availability
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/nsx/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Nsx
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/tanzu/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Tanzu
  </span>
</span>
  </span>
  
  
  
  
</div>




        </div>

        
        <div class="py-1 prose dark:prose-invert">
          In this post I will quickly go through how we can use vSphere with Tanzu on three different vSphere clusters - Multi Zones for app placement.
        </div>
        
      </div>
      <div class="px-6 pt-4 pb-2">

      </div>
    </div>
  </a>

  
  

  <a href="/2023/05/03/vsphere-with-tanzu-multi-three-zones-and-nsx/" class="min-w-full">
    
    <div class="min-h-full border border-neutral-200 dark:border-neutral-700 border-2 rounded overflow-hidden shadow-2xl relative">
        
        <div class="w-full thumbnail_card_related nozoom" style="background-image:url(/2023/05/03/vsphere-with-tanzu-multi-three-zones-and-nsx/feature-logo-vmware-tanzu.png);"></div>
        
      

      <div class="px-6 py-4">

        
        <div class="font-bold text-xl text-neutral-800 decoration-primary-500 hover:underline hover:underline-offset-2 dark:text-neutral"
          href="/2023/05/03/vsphere-with-tanzu-multi-three-zones-and-nsx/">vSphere with Tanzu, Multi (three) Zones and NSX</div>
        

        <div class="text-sm text-neutral-500 dark:text-neutral-400">
          











  





  



  













<div class="flex flex-row flex-wrap items-center">
  
  
  <time datetime="2023-05-03T07:34:47&#43;02:00">3 May 2023</time><span class="px-2 text-primary-500">&middot;</span><span>2246 words</span><span class="px-2 text-primary-500">&middot;</span><span title="Reading time">11 mins</span>
  

  
  
</div>


<div class="flex flex-row flex-wrap items-center">
  
  
  
  
  
  
  
  
  
  
  
</div>




<div class="flex flex-row flex-wrap items-center">
  
  
  
  
  
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/kubernetes/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Kubernetes
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/tanzu/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Tanzu
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/networking/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Networking
  </span>
</span>
  </span>
  
  
  
  
  
  
  
  
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/availability/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Availability
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/nsx/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Nsx
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/tanzu/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Tanzu
  </span>
</span>
  </span>
  
  
  
  
</div>




        </div>

        
        <div class="py-1 prose dark:prose-invert">
          In this post I will quickly go through how to deploy vSphere with Tanzu on three different vSphere clusters - Multi Zones
        </div>
        
      </div>
      <div class="px-6 pt-4 pb-2">

      </div>
    </div>
  </a>

  
  

  <a href="/2023/12/18/a-quick-glance-at-cilium-cni/" class="min-w-full">
    
    <div class="min-h-full border border-neutral-200 dark:border-neutral-700 border-2 rounded overflow-hidden shadow-2xl relative">
        
        <div class="w-full thumbnail_card_related nozoom" style="background-image:url(/2023/12/18/a-quick-glance-at-cilium-cni/feature-cilium.jpg);"></div>
        
      

      <div class="px-6 py-4">

        
        <div class="font-bold text-xl text-neutral-800 decoration-primary-500 hover:underline hover:underline-offset-2 dark:text-neutral"
          href="/2023/12/18/a-quick-glance-at-cilium-cni/">A Quick Glance at Cilium CNI</div>
        

        <div class="text-sm text-neutral-500 dark:text-neutral-400">
          











  





  



  













<div class="flex flex-row flex-wrap items-center">
  
  
  <time datetime="2023-12-18T11:49:56&#43;01:00">18 December 2023</time><span class="px-2 text-primary-500">&middot;</span><span>8012 words</span><span class="px-2 text-primary-500">&middot;</span><span title="Reading time">38 mins</span>
  

  
  
</div>


<div class="flex flex-row flex-wrap items-center">
  
  
  
  
  
  
  
  
  
  
  
</div>




<div class="flex flex-row flex-wrap items-center">
  
  
  
  
  
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/kubernetes/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Kubernetes
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/cni/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    CNI
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/networking/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Networking
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/security/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Security
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/monitoring/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Monitoring
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/ebpf/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    EBPF
  </span>
</span>
  </span>
  
  
  
  
  
  
  
  
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/cilium/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Cilium
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/kubernetes/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Kubernetes
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/cni/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Cni
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/networking/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Networking
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/ebpf/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Ebpf
  </span>
</span>
  </span>
  
  
  
  
</div>




        </div>

        
        <div class="py-1 prose dark:prose-invert">
          In this post I will deploy Cilium in my k8s cluster and test some features and how it is to manage
        </div>
        
      </div>
      <div class="px-6 pt-4 pb-2">

      </div>
    </div>
  </a>

  
</section>

  
      </div>
     
      
      
        
        
          
          
        
      <script>
        var oid = "views_posts\/2023-08-29-tkg-2.3-multi-availability-zones\/index.md"
        var oid_likes = "likes_posts\/2023-08-29-tkg-2.3-multi-availability-zones\/index.md"
      </script>
      
      
      <script type="text/javascript" src="/js/page.min.0860cf4e04fa2d72cc33ddba263083464d48f67de06114529043cb4623319efed4f484fd7f1730df5abea0e2da6f3538855634081d02f2d6e920b956f063e823.js" integrity="sha512-CGDPTgT6LXLMM926JjCDRk1I9n3gYRRSkEPLRiMxnv7U9IT9fxcw31q&#43;oOLabzU4hVY0CB0C8tbpILlW8GPoIw=="></script>
      
  
    </section>
  <footer class="pt-8 max-w-prose print:hidden">

    
  
    
    
    
    <div class="pt-8">
      <hr class="border-dotted border-neutral-300 dark:border-neutral-600" />
      <div class="flex justify-between pt-3">
        <span>
          
            <a class="flex group mr-3" href="/2023/07/12/installing-tmc-local-on-vsphere-8-with-tanzu-using-keycloak-as-oidc-provider/">
              <span
                class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400"
                >&larr;</span
              >
              <span
                class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400"
                >&rarr;</span
              >
              <span class="flex flex-col">
                <span
                  class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500"
                  >Installing TMC local on vSphere 8 with Tanzu using Keycloak as OIDC provider</span
                >
                <span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400">
                  
                    <time datetime="2023-07-12T15:22:46&#43;02:00">12 July 2023</time>
                  
                </span>
              </span>
            </a>
          
        </span>
        <span>
          
            <a class="flex text-right group ml-3" href="/2023/09/06/tmc-self-managed-upgrade-to-1.0.1/">
              <span class="flex flex-col">
                <span
                  class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500"
                  >TMC Self-Managed Upgrade to 1.0.1</span
                >
                <span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400">
                  
                    <time datetime="2023-09-06T09:34:04&#43;02:00">6 September 2023</time>
                  
                </span>
              </span>
              <span
                class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400"
                >&rarr;</span
              >
              <span
                class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400"
                >&larr;</span
              >
            </a>
          
        </span>
      </div>
    </div>
  


    
  </footer>
</article>

      <div id="top-scroller" class="pointer-events-none absolute top-[110vh] bottom-0 w-12 ltr:right-0 rtl:left-0">
  <a href="#the-top"
    class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 mb-16 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400"
    aria-label="Scroll to top" title="Scroll to top">
    &uarr;
  </a>
</div>
    </main><footer id="site-footer" class="py-10 print:hidden">
  
  
    
    <nav class="flex flex-row pb-4 text-base font-medium text-neutral-500 dark:text-neutral-400">
      <ul class="flex flex-col list-none sm:flex-row">
        
        <li class="flex mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0">
          <a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2 flex items-center" href="/tags/"
            title="">
            
            Tags
          </a>
        </li>
        
        <li class="flex mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0">
          <a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2 flex items-center" href="/categories/"
            title="">
            
            Categories
          </a>
        </li>
        
      </ul>
    </nav>
    
  
  <div class="flex items-center justify-between">

    
    
    <p class="text-sm text-neutral-500 dark:text-neutral-400">
      &copy;
      2025
      Andreas Marqvardsen
    </p>
    

    
    
    <p class="text-xs text-neutral-500 dark:text-neutral-400">
      
      
      Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500"
        href="https://gohugo.io/" target="_blank" rel="noopener noreferrer">Hugo</a> &amp; <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500"
        href="https://blowfish.page/" target="_blank" rel="noopener noreferrer">Blowfish</a>
    </p>
    

  </div>
  <script>
    
    mediumZoom(document.querySelectorAll("img:not(.nozoom)"), {
      margin: 24,
      background: 'rgba(0,0,0,0.5)',
      scrollOffset: 0,
    })
    
  </script>
  
  
  <script type="text/javascript" src="/js/process.min.ee03488f19c93c2efb199e2e3014ea5f3cb2ce7d45154adb3399a158cac27ca52831db249ede5bb602700ef87eb02434139de0858af1818ab0fb4182472204a4.js" integrity="sha512-7gNIjxnJPC77GZ4uMBTqXzyyzn1FFUrbM5mhWMrCfKUoMdsknt5btgJwDvh&#43;sCQ0E53ghYrxgYqw&#43;0GCRyIEpA=="></script>
  
  
</footer>
<div
  id="search-wrapper"
  class="invisible fixed inset-0 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh]"
  data-url="https://blog.andreasm.io/"
  style="z-index:500"
>
  <div
    id="search-modal"
    class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"
  >
    <header class="relative z-10 flex items-center justify-between flex-none px-2">
      <form class="flex items-center flex-auto min-w-0">
        <div class="flex items-center justify-center w-8 h-8 text-neutral-400">
          

  <span class="relative block icon">
    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>

  </span>


        </div>
        <input
          type="search"
          id="search-query"
          class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent"
          placeholder="Search"
          tabindex="0"
        />
      </form>
      <button
        id="close-search-button"
        class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400"
        title="Close (Esc)"
      >
        

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75 0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3L54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75 0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75 0-45.25s32.75-12.5 45.25 0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25 0s12.5 32.75 0 45.25l-105.4 105.4L310.6 361.4z"/></svg>

  </span>


      </button>
    </header>
    <section class="flex-auto px-2 overflow-auto">
      <ul id="search-results">
        
      </ul>
    </section>
  </div>
</div>

  </div>
</body>

</html>
