<!DOCTYPE html>
<html lang="en" dir="ltr" class="scroll-smooth" data-default-appearance="dark"
  data-auto-appearance="true"><head>
  <meta charset="utf-8" />
  
  <meta http-equiv="content-language" content="en" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  
  <title>Antrea Multi-cluster - in TKG and vSphere with Tanzu &middot; blog.andreasm.io</title>
  <meta name="title" content="Antrea Multi-cluster - in TKG and vSphere with Tanzu &middot; blog.andreasm.io" />
  
  <meta name="description" content="In this post I will go through how to configure and use the Antrea feature gate Multi-cluster in both TKGs and TKG" />
  <meta name="keywords" content="kubernetes, tanzu, antrea, cni, multi-cluster, " />
  
  
  <link rel="canonical" href="https://blog.andreasm.io/2023/09/25/antrea-multi-cluster-in-tkg-and-vsphere-with-tanzu/" />
  
  
  
  
  
  
  
  
  
  
  
  
  <link type="text/css" rel="stylesheet" href="/css/main.bundle.min.48d290696564c2380c4233780f3fd414aa6e2b0b67ed916e9d918c48c05f5b20b641bf892fadd408e43ec21d2feb2ec1fe6fd1f021df2806a254977fe2f80a64.css"
    integrity="sha512-SNKQaWVkwjgMQjN4Dz/UFKpuKwtn7ZFunZGMSMBfWyC2Qb&#43;JL63UCOQ&#43;wh0v6y7B/m/R8CHfKAaiVJd/4vgKZA==" />
  
  
  <script type="text/javascript" src="/js/appearance.min.a85bd6dc99d1fecae166deb56a1fee6375588c72533c4b8c690e4a9ec5a04174ff780e41e2ac770382a8e67818cb2b89766afa3e23965c9102424a080dafbb0c.js"
    integrity="sha512-qFvW3JnR/srhZt61ah/uY3VYjHJTPEuMaQ5KnsWgQXT/eA5B4qx3A4Ko5ngYyyuJdmr6PiOWXJECQkoIDa&#43;7DA=="></script>
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <script defer type="text/javascript" id="script-bundle" src="/js/main.bundle.min.a2d78d78672e549fbfc972ece871725b5478ba0b65708dda20cb97ab80a865eae6d247e1b05a4aec6ebbf78647ec3233bad8b2609ed98eee53cd58aa17128bc7.js"
    integrity="sha512-oteNeGcuVJ&#43;/yXLs6HFyW1R4ugtlcI3aIMuXq4CoZerm0kfhsFpK7G6794ZH7DIzutiyYJ7Zju5TzViqFxKLxw==" data-copy="" data-copied=""></script>
  
  
  
  <script src="/lib/zoom/zoom.min.37d2094687372da3f7343a221a470f6b8806f7891aa46a5a03966af7f0ebd38b9fe536cb154e6ad28f006d184b294525a7c4054b6bbb4be62d8b453b42db99bd.js" integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S&#43;Yti0U7QtuZvQ=="></script>
  
  
  
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
  <link rel="manifest" href="/site.webmanifest" />
  
  
  
  
  
  
  
  
  <meta property="og:url" content="https://blog.andreasm.io/2023/09/25/antrea-multi-cluster-in-tkg-and-vsphere-with-tanzu/">
  <meta property="og:site_name" content="blog.andreasm.io">
  <meta property="og:title" content="Antrea Multi-cluster - in TKG and vSphere with Tanzu">
  <meta property="og:description" content="Configuring Antrea Multi-cluster with Tanzu clusters">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2023-09-25T10:59:30+02:00">
    <meta property="article:modified_time" content="2023-09-25T10:59:30+02:00">
    <meta property="article:tag" content="Kubernetes">
    <meta property="article:tag" content="Tanzu">
    <meta property="article:tag" content="Antrea">
    <meta property="article:tag" content="Cni">
    <meta property="article:tag" content="Multi-Cluster">
    <meta property="og:image" content="https://blog.andreasm.io/2023/09/25/antrea-multi-cluster-in-tkg-and-vsphere-with-tanzu/feature-antrea-1.png">

  
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://blog.andreasm.io/2023/09/25/antrea-multi-cluster-in-tkg-and-vsphere-with-tanzu/feature-antrea-1.png">
  <meta name="twitter:title" content="Antrea Multi-cluster - in TKG and vSphere with Tanzu">
  <meta name="twitter:description" content="Configuring Antrea Multi-cluster with Tanzu clusters">

  
  <script type="application/ld+json">
  [{
    "@context": "https://schema.org",
    "@type": "Article",
    "articleSection": "Posts",
    "name": "Antrea Multi-cluster - in TKG and vSphere with Tanzu",
    "headline": "Antrea Multi-cluster - in TKG and vSphere with Tanzu",
    "description": "Configuring Antrea Multi-cluster with Tanzu clusters",
    "abstract": "In this post I will go through how to configure and use the Antrea feature gate Multi-cluster in both TKGs and TKG",
    "inLanguage": "en",
    "url" : "https:\/\/blog.andreasm.io\/2023\/09\/25\/antrea-multi-cluster-in-tkg-and-vsphere-with-tanzu\/",
    "author" : {
      "@type": "Person",
      "name": "Andreas Marqvardsen"
    },
    "copyrightYear": "2023",
    "dateCreated": "2023-09-25T10:59:30\u002b02:00",
    "datePublished": "2023-09-25T10:59:30\u002b02:00",
    
    "dateModified": "2023-09-25T10:59:30\u002b02:00",
    
    "keywords": ["kubernetes","tanzu","antrea","cni","multi-cluster"],
    
    "mainEntityOfPage": "true",
    "wordCount": "11466"
  }]
  </script>


  
  
  <meta name="author" content="Andreas Marqvardsen" />
  
  
  
  <link href="mailto:andreas.marqvardsen[AT]gmail.com" rel="me" />
  
  
  <link href="https://blog.andreasm.io/" rel="me" />
  
  
  <link href="https://github.com/andreasm80" rel="me" />
  
  
  <link href="https://linkedin.com/in/andreas-marqvardsen" rel="me" />
  
  
  <link href="https://vmst.io/@andreasm" rel="me" />
  
  
  <link href="https://x.com/NATsoFast" rel="me" />
  
  
  
  

<script src="/lib/jquery/jquery.slim.min.b0dca576e87d7eaa5850ae4e61759c065786cdb6489d68fcc82240539eebd5da522bdb4fda085ffd245808c8fe2acb2516408eb774ef26b5f6015fc6737c0ea8.js" integrity="sha512-sNylduh9fqpYUK5OYXWcBleGzbZInWj8yCJAU57r1dpSK9tP2ghf/SRYCMj&#43;KsslFkCOt3TvJrX2AV/Gc3wOqA=="></script>






















  
  

<script async src="https://www.googletagmanager.com/gtag/js?id=G-TVPYDVE8KR"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-TVPYDVE8KR');
</script>



  
  
  <meta name="theme-color"/>
  
  
</head>
<body
  class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32 scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600">
  <div id="the-top" class="absolute flex self-center">
    <a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600"
      href="#main-content"><span
        class="font-bold text-primary-600 ltr:pr-2 rtl:pl-2 dark:text-primary-400">&darr;</span>Skip to main content</a>
  </div>
  
  
  <div class="min-h-[148px]"></div>
<div class="fixed inset-x-0 pl-[24px] pr-[24px]" style="z-index:100">
  <div id="menu-blur" class="absolute opacity-0 inset-x-0 top-0 h-full single_hero_background nozoom backdrop-blur-2xl shadow-2xl"></div>
  <div class="relative max-w-[64rem] ml-auto mr-auto">
    <div style="padding-left:0;padding-right:0;padding-top:2px;padding-bottom:3px"
    class="main-menu flex items-center justify-between px-4 py-6 sm:px-6 md:justify-start space-x-3">
    
    
    
    <div>
        <a href="/" class="flex">
            <span class="sr-only">blog.andreasm.io</span>

            
            <img src="/ynwa2.png" width="300" height="342"
                class="logo max-h-[5rem] max-w-[5rem] object-scale-down object-left nozoom" alt="blog.andreasm.io" />
            

        </a>
    </div>
    
    <div class="flex flex-1 items-center justify-between">
        <nav class="flex space-x-3">

            
            <a href="/" class="text-base font-medium text-gray-500 hover:text-gray-900">blog.andreasm.io</a>
            

        </nav>
        <nav class="hidden md:flex items-center space-x-5 md:ml-12 h-12">

            
            
            
  <a href="/posts/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
    
    <p class="text-base font-medium" title="">
        Posts
    </p>
</a>



            
            
  <a href="/about/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
    
    <p class="text-base font-medium" title="">
        About
    </p>
</a>



            
            
  <a href="/categories/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
    
    <p class="text-base font-medium" title="">
        Categories
    </p>
</a>



            
            
  <a href="/tags/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
    
    <p class="text-base font-medium" title="">
        Tags
    </p>
</a>



            
            

            


            
            <button id="search-button" aria-label="Search" class="text-base hover:text-primary-600 dark:hover:text-primary-400"
                title="">
                

  <span class="relative block icon">
    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>

  </span>


            </button>
            


            
            
            <div
                class="ltr:mr-14 rtl:ml-14 flex items-center">
                <button id="appearance-switcher" aria-label="Dark mode switcher" type="button" class="text-base hover:text-primary-600 dark:hover:text-primary-400">
                    <div class="flex items-center justify-center dark:hidden">
                        

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M32 256c0-123.8 100.3-224 223.8-224c11.36 0 29.7 1.668 40.9 3.746c9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3c9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480C132.1 480 32 379.6 32 256z"/></svg>

  </span>


                    </div>
                    <div class="items-center justify-center hidden dark:flex">
                        

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02 0-95.1 42.98-95.1 95.1S202.1 351.1 256 351.1s95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347L446.1 255.1l63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7l-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89L164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6L12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256l-63.15 91.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7l19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109l109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69 0-127.1-57.31-127.1-127.1c0-70.69 57.31-127.1 127.1-127.1s127.1 57.3 127.1 127.1C383.1 326.7 326.7 383.1 256 383.1z"/></svg>

  </span>


                    </div>
                </button>
            </div>
            

        </nav>
        <div class="flex md:hidden items-center space-x-5 md:ml-12 h-12">

            <span></span>

            


            
            <button id="search-button-mobile" aria-label="Search" class="text-base hover:text-primary-600 dark:hover:text-primary-400"
                title="">
                

  <span class="relative block icon">
    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>

  </span>


            </button>
            

            
            
            <button id="appearance-switcher-mobile" aria-label="Dark mode switcher" type="button" class="text-base hover:text-primary-600 dark:hover:text-primary-400" style="margin-right:5px">
                <div class="flex items-center justify-center dark:hidden">
                    

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M32 256c0-123.8 100.3-224 223.8-224c11.36 0 29.7 1.668 40.9 3.746c9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3c9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480C132.1 480 32 379.6 32 256z"/></svg>

  </span>


                </div>
                <div class="items-center justify-center hidden dark:flex">
                    

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02 0-95.1 42.98-95.1 95.1S202.1 351.1 256 351.1s95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347L446.1 255.1l63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7l-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89L164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6L12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256l-63.15 91.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7l19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109l109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69 0-127.1-57.31-127.1-127.1c0-70.69 57.31-127.1 127.1-127.1s127.1 57.3 127.1 127.1C383.1 326.7 326.7 383.1 256 383.1z"/></svg>

  </span>


                </div>
            </button>
            

        </div>
    </div>
    <div class="-my-2 -mr-2 md:hidden">

        <label id="menu-button" class="block">
            
            <div class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400">
                

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M0 96C0 78.33 14.33 64 32 64H416C433.7 64 448 78.33 448 96C448 113.7 433.7 128 416 128H32C14.33 128 0 113.7 0 96zM0 256C0 238.3 14.33 224 32 224H416C433.7 224 448 238.3 448 256C448 273.7 433.7 288 416 288H32C14.33 288 0 273.7 0 256zM416 448H32C14.33 448 0 433.7 0 416C0 398.3 14.33 384 32 384H416C433.7 384 448 398.3 448 416C448 433.7 433.7 448 416 448z"/></svg>

  </span>


            </div>
            <div id="menu-wrapper" style="padding-top:5px;"
                class="fixed inset-0 z-30 invisible w-screen h-screen m-0 overflow-auto transition-opacity opacity-0 cursor-default bg-neutral-100/50 backdrop-blur-sm dark:bg-neutral-900/50">
                <ul
                    class="flex space-y-2 mt-3 flex-col items-end w-full px-6 py-6 mx-auto overflow-visible list-none ltr:text-right rtl:text-left max-w-7xl">

                    <li id="menu-close-button">
                        <span
                            class="cursor-pointer inline-block align-text-bottom hover:text-primary-600 dark:hover:text-primary-400">

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75 0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3L54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75 0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75 0-45.25s32.75-12.5 45.25 0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25 0s12.5 32.75 0 45.25l-105.4 105.4L310.6 361.4z"/></svg>

  </span>

</span>
                    </li>

                    

                    
  <li class="mt-1">
    <a href="/posts/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
        
        <p class="text-bg font-bg" title="">
            Posts
        </p>
    </a>
</li>




                    

                    
  <li class="mt-1">
    <a href="/about/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
        
        <p class="text-bg font-bg" title="">
            About
        </p>
    </a>
</li>




                    

                    
  <li class="mt-1">
    <a href="/categories/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
        
        <p class="text-bg font-bg" title="">
            Categories
        </p>
    </a>
</li>




                    

                    
  <li class="mt-1">
    <a href="/tags/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
        
        <p class="text-bg font-bg" title="">
            Tags
        </p>
    </a>
</li>




                    

                </ul>
                
                

            </div>
        </label>
    </div>
</div>




<script>
    (function () {
        var $mainmenu = $('.main-menu');
        var path = window.location.pathname;
        $mainmenu.find('a[href="' + path + '"]').each(function (i, e) {
            $(e).children('p').addClass('active');
        });
    })();
</script>


  </div>
</div>
<script>
  window.addEventListener('scroll', function (e) {
    var scroll = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop || 0;
    var background_blur = document.getElementById('menu-blur');
    background_blur.style.opacity = (scroll / 300);
  });
</script>

  
  <div class="relative flex flex-col grow">
    <main id="main-content" class="grow">
      


<article>
  
  
  
  
  
  


<div id="hero" class="h-[150px] md:h-[200px]"></div>



    
    <div class="fixed inset-x-0 top-0 h-[800px] single_hero_background nozoom"
    style="background-image:url(/2023/09/25/antrea-multi-cluster-in-tkg-and-vsphere-with-tanzu/feature-antrea-1.png);">
    


    <div class="absolute inset-0 bg-gradient-to-t from-neutral dark:from-neutral-800 to-transparent mix-blend-normal">
    </div>
    <div
        class="absolute inset-0 opacity-60 bg-gradient-to-t from-neutral dark:from-neutral-800 to-neutral-100 dark:to-neutral-800 mix-blend-normal">
    </div>
</div>

<div id="background-blur" class="fixed opacity-0 inset-x-0 top-0 h-full single_hero_background nozoom backdrop-blur-2xl"></div>
<script>
    window.addEventListener('scroll', function (e) {
        var scroll = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop || 0;
        var background_blur = document.getElementById('background-blur');
        background_blur.style.opacity = (scroll / 300)
    });
</script>

  
  

  <header id="single_header" class="mt-5 max-w-prose">
    
    <ol class="text-sm text-neutral-500 dark:text-neutral-400 print:hidden">
  
  
    
  
    
  
  <li class="inline hidden">
    <a
      class="hover:underline decoration-neutral-300 dark:underline-neutral-600"
      href="/"
      >blog.andreasm.io</a
    ><span class="px-1 text-primary-500">/</span>
  </li>

  
  <li class="inline ">
    <a
      class="hover:underline decoration-neutral-300 dark:underline-neutral-600"
      href="/posts/"
      >Posts</a
    ><span class="px-1 text-primary-500">/</span>
  </li>

  
  <li class="inline hidden">
    <a
      class="hover:underline decoration-neutral-300 dark:underline-neutral-600"
      href="/2023/09/25/antrea-multi-cluster-in-tkg-and-vsphere-with-tanzu/"
      >Antrea Multi-cluster - in TKG and vSphere with Tanzu</a
    ><span class="px-1 text-primary-500">/</span>
  </li>

</ol>


    
    <h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">
      Antrea Multi-cluster - in TKG and vSphere with Tanzu
    </h1>
    <div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden">
      





  
  







  





  



  













<div class="flex flex-row flex-wrap items-center">
  
  
  <time datetime="2023-09-25T10:59:30&#43;02:00">25 September 2023</time><span class="px-2 text-primary-500">&middot;</span><span>11466 words</span><span class="px-2 text-primary-500">&middot;</span><span title="Reading time">54 mins</span>
  

  
  
</div>


<div class="flex flex-row flex-wrap items-center">
  
  
  
  
  
  
  
  
  
  
  
</div>




<div class="flex flex-row flex-wrap items-center">
  
  
  
  
  
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/kubernetes/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Kubernetes
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/cni/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    CNI
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/antrea/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Antrea
  </span>
</span>
  </span>
  
  
  
  
  
  
  
  
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/kubernetes/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Kubernetes
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/tanzu/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Tanzu
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/antrea/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Antrea
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/cni/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Cni
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/multi-cluster/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Multi-Cluster
  </span>
</span>
  </span>
  
  
  
  
</div>




    </div>

    
    
    
    
    

    

    
      
      
        
        
<div class="flex author">
  
    
    
      
    
    
      
      <img class="!mt-0 !mb-0 h-24 w-24 rounded-full ltr:mr-4 rtl:ml-4" width="96" height="96"
      alt="Andreas Marqvardsen" src="/profile.png" />
    
  
  <div class="place-self-center">
    
    <div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">
      Author
    </div>
    <div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">
      Andreas Marqvardsen
    </div>
    
    
    <div class="text-sm text-neutral-700 dark:text-neutral-400">Always curious, always learning</div>
    
    <div class="text-2xl sm:text-lg">
  <div class="flex flex-wrap text-neutral-400 dark:text-neutral-500">
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="mailto:andreas.marqvardsen[AT]gmail.com"
          target="_blank"
          aria-label="Email"
          rel="me noopener noreferrer"
          ><span class="inline-block align-text-bottom">

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M207.8 20.73c-93.45 18.32-168.7 93.66-187 187.1c-27.64 140.9 68.65 266.2 199.1 285.1c19.01 2.888 36.17-12.26 36.17-31.49l.0001-.6631c0-15.74-11.44-28.88-26.84-31.24c-84.35-12.98-149.2-86.13-149.2-174.2c0-102.9 88.61-185.5 193.4-175.4c91.54 8.869 158.6 91.25 158.6 183.2l0 16.16c0 22.09-17.94 40.05-40 40.05s-40.01-17.96-40.01-40.05v-120.1c0-8.847-7.161-16.02-16.01-16.02l-31.98 .0036c-7.299 0-13.2 4.992-15.12 11.68c-24.85-12.15-54.24-16.38-86.06-5.106c-38.75 13.73-68.12 48.91-73.72 89.64c-9.483 69.01 43.81 128 110.9 128c26.44 0 50.43-9.544 69.59-24.88c24 31.3 65.23 48.69 109.4 37.49C465.2 369.3 496 324.1 495.1 277.2V256.3C495.1 107.1 361.2-9.332 207.8 20.73zM239.1 304.3c-26.47 0-48-21.56-48-48.05s21.53-48.05 48-48.05s48 21.56 48 48.05S266.5 304.3 239.1 304.3z"/></svg>

  </span>

</span></a
        >
      
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="https://blog.andreasm.io/"
          target="_blank"
          aria-label="Link"
          rel="me noopener noreferrer"
          ><span class="inline-block align-text-bottom">

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><path fill="currentColor" d="M172.5 131.1C228.1 75.51 320.5 75.51 376.1 131.1C426.1 181.1 433.5 260.8 392.4 318.3L391.3 319.9C381 334.2 361 337.6 346.7 327.3C332.3 317 328.9 297 339.2 282.7L340.3 281.1C363.2 249 359.6 205.1 331.7 177.2C300.3 145.8 249.2 145.8 217.7 177.2L105.5 289.5C73.99 320.1 73.99 372 105.5 403.5C133.3 431.4 177.3 435 209.3 412.1L210.9 410.1C225.3 400.7 245.3 404 255.5 418.4C265.8 432.8 262.5 452.8 248.1 463.1L246.5 464.2C188.1 505.3 110.2 498.7 60.21 448.8C3.741 392.3 3.741 300.7 60.21 244.3L172.5 131.1zM467.5 380C411 436.5 319.5 436.5 263 380C213 330 206.5 251.2 247.6 193.7L248.7 192.1C258.1 177.8 278.1 174.4 293.3 184.7C307.7 194.1 311.1 214.1 300.8 229.3L299.7 230.9C276.8 262.1 280.4 306.9 308.3 334.8C339.7 366.2 390.8 366.2 422.3 334.8L534.5 222.5C566 191 566 139.1 534.5 108.5C506.7 80.63 462.7 76.99 430.7 99.9L429.1 101C414.7 111.3 394.7 107.1 384.5 93.58C374.2 79.2 377.5 59.21 391.9 48.94L393.5 47.82C451 6.731 529.8 13.25 579.8 63.24C636.3 119.7 636.3 211.3 579.8 267.7L467.5 380z"/></svg>

  </span>

</span></a
        >
      
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="https://github.com/andreasm80"
          target="_blank"
          aria-label="Github"
          rel="me noopener noreferrer"
          ><span class="inline-block align-text-bottom">

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>

  </span>

</span></a
        >
      
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="https://linkedin.com/in/andreas-marqvardsen"
          target="_blank"
          aria-label="Linkedin"
          rel="me noopener noreferrer"
          ><span class="inline-block align-text-bottom">

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg>

  </span>

</span></a
        >
      
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="https://vmst.io/@andreasm"
          target="_blank"
          aria-label="Mastodon"
          rel="me noopener noreferrer"
          ><span class="inline-block align-text-bottom">

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48 0 0 0-63.72 28.5-63.72 125.7 0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54 0 0 1-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"/></svg>

  </span>

</span></a
        >
      
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="https://x.com/NATsoFast"
          target="_blank"
          aria-label="X-Twitter"
          rel="me noopener noreferrer"
          ><span class="inline-block align-text-bottom">

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8L200.7 275.5 26.8 48H172.4L272.9 180.9 389.2 48zM364.4 421.8h39.1L151.1 88h-42L364.4 421.8z"/></svg>
  </span>

</span></a
        >
      
    
  </div>

</div>
  </div>
</div>

      

      

      
      <div class="mb-5"></div>
      

    

  </header>
  
  <section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row">
    
     <div
      class="order-first lg:ml-auto px-0 lg:order-last ltr:lg:pl-8 rtl:lg:pr-8">
      <div class="toc ltr:pl-5 rtl:pr-5 print:hidden lg:sticky lg:top-[140px]">

         <details open id="TOCView"
  class="toc-right mt-0 overflow-y-scroll overscroll-contain scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600 rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 hidden lg:block">
  <summary
    class="block py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">
    Table of Contents
  </summary>
  <div
    class="min-w-[220px] py-2 border-dotted ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#antrea-feature-gates">Antrea Feature Gates</a></li>
    <li><a href="#configuring-antrea-multi-cluster-in-tkg-23-with-antrea-v1111">Configuring Antrea Multi-cluster in TKG 2.3 with Antrea v1.11.1</a></li>
    <li><a href="#tanzu-in-vsphere-and-antrea-multi-cluster">Tanzu in vSphere and Antrea Multi-cluster</a></li>
    <li><a href="#install-and-configure-antrea-multi-cluster">Install and Configure Antrea Multi-cluster</a>
      <ul>
        <li><a href="#install-the-antrea-multi-cluster-controller-in-the-dedicated-leader-cluster">Install the Antrea Multi-cluster controller in the dedicated leader cluster</a></li>
        <li><a href="#install-the-antrea-multi-cluster-controller-in-the-member-clusters">Install the Antrea Multi-cluster controller in the member clusters</a></li>
      </ul>
    </li>
    <li><a href="#create-clusterset">Create ClusterSet</a>
      <ul>
        <li><a href="#on-the-leader-cluster---create-serviceaccounts">On the Leader Cluster - Create ServiceAccounts</a></li>
        <li><a href="#on-the-member-cluster-apply-tokens">On the Member Cluster apply tokens</a></li>
        <li><a href="#on-the-leader-cluster---clusterset-initialization">On the Leader Cluster - ClusterSet Initialization</a></li>
        <li><a href="#on-the-member-clusters---clusterset-initialization">On the Member Clusters - ClusterSet Initialization</a></li>
        <li><a href="#on-the-member-clusters---multi-cluster-gateway-configuration">On the Member Clusters - Multi-cluster Gateway configuration</a></li>
      </ul>
    </li>
    <li><a href="#using-antctl">Using antctl</a></li>
    <li><a href="#multi-cluster-service">Multi-cluster Service</a>
      <ul>
        <li><a href="#recap-of-multi-cluster-service">Recap of Multi-cluster service.</a></li>
        <li><a href="#quick-troubleshooting">Quick troubleshooting</a></li>
        <li><a href="#failure-scenario">Failure scenario</a></li>
      </ul>
    </li>
    <li><a href="#routing-pod-traffic-through-multi-cluster-gateways">Routing pod traffic through Multi-cluster Gateways</a></li>
    <li><a href="#multi-cluster-networkpolicy-anp-and-acnp">Multi-cluster NetworkPolicy (ANP and ACNP)</a></li>
    <li><a href="#multi-cluster-clusternetworkpolicy-replication-acnp">Multi-cluster ClusterNetworkPolicy replication (ACNP)</a></li>
    <li><a href="#bonus-content">Bonus content</a></li>
  </ul>
</nav>
  </div>
</details>
<details class="toc-inside mt-0 overflow-hidden rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 lg:hidden">
  <summary
    class="py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">
    Table of Contents
  </summary>
  <div
    class="py-2 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#antrea-feature-gates">Antrea Feature Gates</a></li>
    <li><a href="#configuring-antrea-multi-cluster-in-tkg-23-with-antrea-v1111">Configuring Antrea Multi-cluster in TKG 2.3 with Antrea v1.11.1</a></li>
    <li><a href="#tanzu-in-vsphere-and-antrea-multi-cluster">Tanzu in vSphere and Antrea Multi-cluster</a></li>
    <li><a href="#install-and-configure-antrea-multi-cluster">Install and Configure Antrea Multi-cluster</a>
      <ul>
        <li><a href="#install-the-antrea-multi-cluster-controller-in-the-dedicated-leader-cluster">Install the Antrea Multi-cluster controller in the dedicated leader cluster</a></li>
        <li><a href="#install-the-antrea-multi-cluster-controller-in-the-member-clusters">Install the Antrea Multi-cluster controller in the member clusters</a></li>
      </ul>
    </li>
    <li><a href="#create-clusterset">Create ClusterSet</a>
      <ul>
        <li><a href="#on-the-leader-cluster---create-serviceaccounts">On the Leader Cluster - Create ServiceAccounts</a></li>
        <li><a href="#on-the-member-cluster-apply-tokens">On the Member Cluster apply tokens</a></li>
        <li><a href="#on-the-leader-cluster---clusterset-initialization">On the Leader Cluster - ClusterSet Initialization</a></li>
        <li><a href="#on-the-member-clusters---clusterset-initialization">On the Member Clusters - ClusterSet Initialization</a></li>
        <li><a href="#on-the-member-clusters---multi-cluster-gateway-configuration">On the Member Clusters - Multi-cluster Gateway configuration</a></li>
      </ul>
    </li>
    <li><a href="#using-antctl">Using antctl</a></li>
    <li><a href="#multi-cluster-service">Multi-cluster Service</a>
      <ul>
        <li><a href="#recap-of-multi-cluster-service">Recap of Multi-cluster service.</a></li>
        <li><a href="#quick-troubleshooting">Quick troubleshooting</a></li>
        <li><a href="#failure-scenario">Failure scenario</a></li>
      </ul>
    </li>
    <li><a href="#routing-pod-traffic-through-multi-cluster-gateways">Routing pod traffic through Multi-cluster Gateways</a></li>
    <li><a href="#multi-cluster-networkpolicy-anp-and-acnp">Multi-cluster NetworkPolicy (ANP and ACNP)</a></li>
    <li><a href="#multi-cluster-clusternetworkpolicy-replication-acnp">Multi-cluster ClusterNetworkPolicy replication (ACNP)</a></li>
    <li><a href="#bonus-content">Bonus content</a></li>
  </ul>
</nav>
  </div>
</details>

<script>

  var margin = 200;
  var marginError = 50;

  (function () {
    var $window = $(window);
    var $toc = $('#TOCView');
    var tocHeight = $toc.height();

    function onResize() {
      var windowAndMarginHeight = $window.height() - margin;
      if(tocHeight >= windowAndMarginHeight) {
        $toc.css("overflow-y", "scroll")
        $toc.css("max-height", (windowAndMarginHeight + marginError) + "px")
      } else {
        $toc.css("overflow-y", "hidden")
        $toc.css("max-height", "9999999px")
      }
    }

    $window.on('resize', onResize);
    $(document).ready(onResize);
  })();



  (function () {
    var $toc = $('#TableOfContents');
    if ($toc.length > 0) {
      var $window = $(window);

      function onScroll() {
        var currentScroll = $window.scrollTop();
        var h = $('.anchor');
        var id = "";
        h.each(function (i, e) {
          e = $(e);
          if (e.offset().top - $(window).height()/3 <= currentScroll) {
            id = decodeURIComponent(e.attr('id'));
          }
        });
        var active = $toc.find('a.active');      
        if (active.length == 1 && active.eq(0).attr('href') == '#' + id) return true;

        active.each(function (i, e) {
          
            $(e).removeClass('active');
          
        });
        $toc.find('a[href="#' + id + '"]').addClass('active')
        $toc.find('a[href="#' + id + '"]').parentsUntil('#TableOfContents').each(function (i, e) {
          $(e).children('a').parents('ul').show();          
        });
      }

      $window.on('scroll', onScroll);
      $(document).ready(function () {
        
        onScroll();
      });
    }
  })();


</script>
   </div>
      </div>
      

      <div class="min-w-0 min-h-0 max-w-fit">
        
        


        <div class="article-content max-w-prose mb-20">
          

<h1 class="relative group">Antrea Multi-cluster 
    <div id="antrea-multi-cluster" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#antrea-multi-cluster" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<p>From the official <a href="">Antrea.io</a> documentation:</p>
<blockquote>
<p>Antrea Multi-cluster implements <a href="https://github.com/kubernetes/enhancements/tree/master/keps/sig-multicluster/1645-multi-cluster-services-api" target="_blank">Multi-cluster Service API</a>, which allows users to create multi-cluster Services that can be accessed cross clusters in a ClusterSet. Antrea Multi-cluster also supports Antrea ClusterNetworkPolicy replication. Multi-cluster admins can define ClusterNetworkPolicies to be replicated across the entire ClusterSet, and enforced in all member clusters.</p>
<p>An Antrea Multi-cluster ClusterSet includes a leader cluster and multiple member clusters. Antrea Multi-cluster Controller needs to be deployed in the leader and all member clusters. A cluster can serve as the leader, and meanwhile also be a member cluster of the ClusterSet.</p>
<p>The diagram below depicts a basic Antrea Multi-cluster topology with one leader cluster and two member clusters.</p>
</blockquote>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/09/25/antrea-multi-cluster-in-tkg-and-vsphere-with-tanzu/images/image-20230925133759404.png"
        alt="antrea-multicluster"
      />
      
    </figure>
</p>
<p>In this post I will go through how to configure Antrea Multi-cluster in TKG 2.3 and Tanzu with vSphere. As of the time I am writing this post (end of September begining of October 2023) Tanzu with vSphere does not have all the feature gates available right now to be able to configure Antrea Multi-cluster, so this will be added later. After the initial configuration and installation of Antrea Multi-cluster I will go through the different possibilities (features) with Antrea Multi-cluster, with configuration and examples in each of their own sections. The first sections involving how to enable Antrea Multi-cluster feature gate is specific for the Kubernetes &ldquo;distribution&rdquo; it is enabled on (TKG, vSphere with Tanzu, upstream Kubernetes etc). After this initial config the rest is generic and can be re-used for all types of Kubernetes platforms. I will go through everything step by step to learn what the different &ldquo;moving&rdquo; parts are doing and how they work. At the end I have a <em>bonus chapter</em> where I have created a menu driven script that automates or simplify the whole process.</p>


<h2 class="relative group">Antrea Feature Gates 
    <div id="antrea-feature-gates" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#antrea-feature-gates" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>Antrea has a set of Feature Gates that can be enabled or disabled on both the Antrea Controller and Antrea Agent, depending on the feature. These are configured using the corresponding <strong>antrea-config</strong> configMap. For a list of available features head over to the <a href="https://antrea.io/docs/v1.13.1/" target="_blank">antrea.io</a> documentation page <a href="https://antrea.io/docs/v1.13.1/docs/feature-gates/" target="_blank">here</a>. Depending on the Kubernetes platform, and when the settings are applied, these features may be enabled in different ways. This post will specifically cover how to enable the Antrea Multi-cluster Feature Gate in Tanzu Kubernetes Grid and vSphere with Tanzu (not available yet).</p>


<h2 class="relative group">Configuring Antrea Multi-cluster in TKG 2.3 with Antrea v1.11.1 
    <div id="configuring-antrea-multi-cluster-in-tkg-23-with-antrea-v1111" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#configuring-antrea-multi-cluster-in-tkg-23-with-antrea-v1111" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<div class="notice info">
<p>The following procedure may not at the time writing this post be officially supported - will get back and confirm this</p>
</div>
<p>Using Tanzu Kubernetes Grid the Antrea Feature Gates can be configured during provisioning of the workload clusters or post cluster provision. I will be enabling the Antrea Multi-cluster feature gate during cluster provisioning. If one need to enable these feature gates post cluster provision one <strong>must</strong> edit the <strong>antreaconfigs</strong> crd at the Management cluster level for the corresponding TKG cluster. See below.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"> k get antreaconfigs.cni.tanzu.vmware.com -n tkg-ns-1
</span></span><span class="line"><span class="cl">NAME            TRAFFICENCAPMODE   DEFAULTMTU   ANTREAPROXY   ANTREAPOLICY   SECRETREF
</span></span><span class="line"><span class="cl">tkg-cluster-1   encap                           <span class="nb">true</span>          <span class="nb">true</span>           tkg-cluster-1-antrea-data-values
</span></span><span class="line"><span class="cl">tkg-cluster-2   encap                           <span class="nb">true</span>          <span class="nb">true</span>           tkg-cluster-2-antrea-data-values
</span></span><span class="line"><span class="cl">tkg-cluster-3   encap                           <span class="nb">true</span>          <span class="nb">true</span>           tkg-cluster-3-antrea-data-values
</span></span></code></pre></div><p>If I take a look at the yaml values for any of these <strong>antreaconfigs</strong>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">cni.tanzu.vmware.com/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">AntreaConfig</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">kubectl.kubernetes.io/last-applied-configuration</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">      {&#34;apiVersion&#34;:&#34;cni.tanzu.vmware.com/v1alpha1&#34;,&#34;kind&#34;:&#34;AntreaConfig&#34;,&#34;metadata&#34;:{&#34;annotations&#34;:{},&#34;name&#34;:&#34;tkg-cluster-1&#34;,&#34;namespace&#34;:&#34;tkg-ns-1&#34;},&#34;spec&#34;:{&#34;antrea&#34;:{&#34;config&#34;:{&#34;antreaProxy&#34;:{&#34;nodePortAddresses&#34;:[],&#34;proxyAll&#34;:false,&#34;proxyLoadBalancerIPs&#34;:true,&#34;skipServices&#34;:[]},&#34;cloudProvider&#34;:{&#34;name&#34;:&#34;&#34;},&#34;disableTXChecksumOffload&#34;:false,&#34;disableUdpTunnelOffload&#34;:false,&#34;dnsServerOverride&#34;:&#34;&#34;,&#34;egress&#34;:{&#34;exceptCIDRs&#34;:[],&#34;maxEgressIPsPerNode&#34;:255},&#34;enableBridgingMode&#34;:null,&#34;enableUsageReporting&#34;:false,&#34;featureGates&#34;:{&#34;AntreaIPAM&#34;:false,&#34;AntreaPolicy&#34;:true,&#34;AntreaProxy&#34;:true,&#34;AntreaTraceflow&#34;:true,&#34;Egress&#34;:true,&#34;EndpointSlice&#34;:true,&#34;FlowExporter&#34;:false,&#34;L7NetworkPolicy&#34;:false,&#34;Multicast&#34;:false,&#34;Multicluster&#34;:true,&#34;NetworkPolicyStats&#34;:false,&#34;NodePortLocal&#34;:true,&#34;SecondaryNetwork&#34;:false,&#34;ServiceExternalIP&#34;:false,&#34;SupportBundleCollection&#34;:false,&#34;TopologyAwareHints&#34;:false,&#34;TrafficControl&#34;:false},&#34;flowExporter&#34;:{&#34;activeFlowTimeout&#34;:&#34;60s&#34;,&#34;idleFlowTimeout&#34;:&#34;15s&#34;,&#34;pollInterval&#34;:&#34;5s&#34;},&#34;kubeAPIServerOverride&#34;:null,&#34;multicast&#34;:{&#34;igmpQueryInterval&#34;:&#34;125s&#34;},&#34;multicastInterfaces&#34;:[],&#34;multicluster&#34;:{&#34;enable&#34;:true,&#34;enablePodToPodConnectivity&#34;:true,&#34;enableStretchedNetworkPolicy&#34;:true,&#34;namespace&#34;:&#34;antrea-multicluster&#34;},&#34;noSNAT&#34;:false,&#34;nodePortLocal&#34;:{&#34;enabled&#34;:true,&#34;portRange&#34;:&#34;61000-62000&#34;},&#34;serviceCIDR&#34;:&#34;10.132.0.0/16&#34;,&#34;trafficEncapMode&#34;:&#34;encap&#34;,&#34;trafficEncryptionMode&#34;:&#34;none&#34;,&#34;transportInterface&#34;:null,&#34;transportInterfaceCIDRs&#34;:[],&#34;tunnelCsum&#34;:false,&#34;tunnelPort&#34;:0,&#34;tunnelType&#34;:&#34;geneve&#34;,&#34;wireGuard&#34;:{&#34;port&#34;:51820}}}}}</span><span class="w">      
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2023-09-28T19:49:11Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">generation</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">tkg.tanzu.vmware.com/cluster-name</span><span class="p">:</span><span class="w"> </span><span class="l">tkg-cluster-1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">tkg.tanzu.vmware.com/package-name</span><span class="p">:</span><span class="w"> </span><span class="l">antrea.tanzu.vmware.com.1.11.1---vmware.4-tkg.1-advanced</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tkg-cluster-1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">tkg-ns-1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ownerReferences</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">cluster.x-k8s.io/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Cluster</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tkg-cluster-1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">uid</span><span class="p">:</span><span class="w"> </span><span class="l">f635b355-e094-471f-bfeb-63e1c10443cf</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">run.tanzu.vmware.com/v1alpha3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">blockOwnerDeletion</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">controller</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterBootstrap</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tkg-cluster-1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">uid</span><span class="p">:</span><span class="w"> </span><span class="l">83b5bdd6-27c3-4c65-a9bc-f665e99c0670</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resourceVersion</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;14988446&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">uid</span><span class="p">:</span><span class="w"> </span><span class="l">7335854b-49ca-44d9-bded-2d4a09aaf5de</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">antrea</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">config</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">antreaProxy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">nodePortAddresses</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">proxyAll</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">proxyLoadBalancerIPs</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">skipServices</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">cloudProvider</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">defaultMTU</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">disableTXChecksumOffload</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">disableUdpTunnelOffload</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">dnsServerOverride</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">egress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">exceptCIDRs</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">maxEgressIPsPerNode</span><span class="p">:</span><span class="w"> </span><span class="m">255</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">enableBridgingMode</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">enableUsageReporting</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">featureGates</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">AntreaIPAM</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">AntreaPolicy</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">AntreaProxy</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">AntreaTraceflow</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">Egress</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">EndpointSlice</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">FlowExporter</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">L7NetworkPolicy</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">Multicast</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">Multicluster</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">NetworkPolicyStats</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">NodePortLocal</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">SecondaryNetwork</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">ServiceExternalIP</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">SupportBundleCollection</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">TopologyAwareHints</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">TrafficControl</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">flowExporter</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">activeFlowTimeout</span><span class="p">:</span><span class="w"> </span><span class="l">60s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">idleFlowTimeout</span><span class="p">:</span><span class="w"> </span><span class="l">15s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">pollInterval</span><span class="p">:</span><span class="w"> </span><span class="l">5s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">multicast</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">igmpQueryInterval</span><span class="p">:</span><span class="w"> </span><span class="l">125s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">multicastInterfaces</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">multicluster</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">enable</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">enablePodToPodConnectivity</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">enableStretchedNetworkPolicy</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">antrea-multicluster</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">noSNAT</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">nodePortLocal</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">portRange</span><span class="p">:</span><span class="w"> </span><span class="m">61000-62000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">serviceCIDR</span><span class="p">:</span><span class="w"> </span><span class="m">10.132.0.0</span><span class="l">/16</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">tlsCipherSuites</span><span class="p">:</span><span class="w"> </span><span class="l">TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,TLS_RSA_WITH_AES_256_GCM_SHA384</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">trafficEncapMode</span><span class="p">:</span><span class="w"> </span><span class="l">encap</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">trafficEncryptionMode</span><span class="p">:</span><span class="w"> </span><span class="l">none</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">transportInterfaceCIDRs</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">tunnelCsum</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">tunnelPort</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">tunnelType</span><span class="p">:</span><span class="w"> </span><span class="l">geneve</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">wireGuard</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">51820</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">status</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">secretRef</span><span class="p">:</span><span class="w"> </span><span class="l">tkg-cluster-1-antrea-data-values</span><span class="w">
</span></span></span></code></pre></div><p>I have all the Antrea Feature Gates avaible for Antrea to use in the current version of TKG. What I dont have is the <strong>antrea-agent.conf</strong> and <strong>antrea-controller.conf</strong> sections. But enabling the Feature Gates here will enable the corresponding setting under the correct section in the native Antrea configMap.</p>
<p>The required settings or Antrea Feature-Gates that needs to be enabled are the following:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">antrea-config</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-system</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">antrea-agent.conf</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">    featureGates:
</span></span></span><span class="line"><span class="cl"><span class="sd">      Multicluster: true
</span></span></span><span class="line"><span class="cl"><span class="sd">    multicluster:
</span></span></span><span class="line"><span class="cl"><span class="sd">      enableGateway: true
</span></span></span><span class="line"><span class="cl"><span class="sd">      namespace: &#34;&#34;</span><span class="w">    
</span></span></span></code></pre></div><p>Then I know which Feature Gates that must be enabled, but in TKG I dont have <strong>antrea-agent.conf</strong> nor <strong>antrea-controller.conf</strong>.</p>
<p>Using a class based yaml for my workload clusters in TKG the Antrea specific section look like this and to enable Antrea Multi-cluster (including two optional features) I need to enable these features (redacted):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">cni.tanzu.vmware.com/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">AntreaConfig</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tkg-cluster-1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">tkg-ns-1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">antrea</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">config</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">antreaProxy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">cloudProvider</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">egress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">featureGates</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">Multicluster</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="c"># set to true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">multicluster</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">enable</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="c"># set to true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">enablePodToPodConnectivity</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="c"># set to true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">enableStretchedNetworkPolicy</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="c"># set to true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;antrea-multicluster&#34;</span><span class="w"> </span><span class="c">#optional</span><span class="w">
</span></span></span></code></pre></div><p>Below is the full workload cluster manifest I use, beginning with the Antrea specific settings (see my inline comments again). This will enable the Multi-cluster feature gate, and the two additional Multi-cluster features <em>PodToPodConnectivity</em> and <em>StretchedNetworkPolicy</em> upon cluster creation.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">cni.tanzu.vmware.com/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">AntreaConfig</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tkg-cluster-1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">tkg-ns-1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">antrea</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">config</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">antreaProxy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">nodePortAddresses</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">proxyAll</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">proxyLoadBalancerIPs</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">skipServices</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">cloudProvider</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">disableTXChecksumOffload</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">disableUdpTunnelOffload</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">dnsServerOverride</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">egress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">exceptCIDRs</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">maxEgressIPsPerNode</span><span class="p">:</span><span class="w"> </span><span class="m">255</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">enableBridgingMode</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">enableUsageReporting</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">featureGates</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">AntreaIPAM</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">AntreaPolicy</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">AntreaProxy</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">AntreaTraceflow</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">Egress</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">EndpointSlice</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">FlowExporter</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">L7NetworkPolicy</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">Multicast</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">Multicluster</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="c"># set to true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">NetworkPolicyStats</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">NodePortLocal</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">SecondaryNetwork</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">ServiceExternalIP</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">SupportBundleCollection</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">TopologyAwareHints</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">TrafficControl</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">flowExporter</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">activeFlowTimeout</span><span class="p">:</span><span class="w"> </span><span class="l">60s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">idleFlowTimeout</span><span class="p">:</span><span class="w"> </span><span class="l">15s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">pollInterval</span><span class="p">:</span><span class="w"> </span><span class="l">5s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">kubeAPIServerOverride</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">multicast</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">igmpQueryInterval</span><span class="p">:</span><span class="w"> </span><span class="l">125s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">multicastInterfaces</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">multicluster</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">enable</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="c"># set to true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">enablePodToPodConnectivity</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="c"># set to true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">enableStretchedNetworkPolicy</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="c"># set to true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;antrea-multicluster&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">noSNAT</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">nodePortLocal</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">portRange</span><span class="p">:</span><span class="w"> </span><span class="m">61000-62000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">serviceCIDR</span><span class="p">:</span><span class="w"> </span><span class="m">10.132.0.0</span><span class="l">/16</span><span class="w"> </span><span class="c"># if you forget to update this CIDR it will be updated according to the services cidr below</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">trafficEncapMode</span><span class="p">:</span><span class="w"> </span><span class="l">encap</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">trafficEncryptionMode</span><span class="p">:</span><span class="w"> </span><span class="l">none</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">transportInterface</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">transportInterfaceCIDRs</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">tunnelCsum</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">tunnelPort</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">tunnelType</span><span class="p">:</span><span class="w"> </span><span class="l">geneve</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">wireGuard</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">51820</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">cpi.tanzu.vmware.com/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">VSphereCPIConfig</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tkg-cluster-1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">tkg-ns-1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">vsphereCPI</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ipFamily</span><span class="p">:</span><span class="w"> </span><span class="l">ipv4</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l">vsphereCPI</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">region</span><span class="p">:</span><span class="w"> </span><span class="l">k8s-region</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">tlsCipherSuites</span><span class="p">:</span><span class="w"> </span><span class="l">TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">zone</span><span class="p">:</span><span class="w"> </span><span class="l">k8s-zone</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">csi.tanzu.vmware.com/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">VSphereCSIConfig</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tkg-cluster-1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">tkg-ns-1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">vsphereCSI</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">config</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">datacenter</span><span class="p">:</span><span class="w"> </span><span class="l">/cPod-NSXAM-WDC</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">httpProxy</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">httpsProxy</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">insecureFlag</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">noProxy</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">region</span><span class="p">:</span><span class="w"> </span><span class="l">k8s-region</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">tlsThumbprint</span><span class="p">:</span><span class="w"> </span><span class="l">&lt;SHA&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">useTopologyCategories</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">zone</span><span class="p">:</span><span class="w"> </span><span class="l">k8s-zone</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l">vsphereCSI</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">run.tanzu.vmware.com/v1alpha3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterBootstrap</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">tkg.tanzu.vmware.com/add-missing-fields-from-tkr</span><span class="p">:</span><span class="w"> </span><span class="l">v1.26.5---vmware.2-tkg.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tkg-cluster-1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">tkg-ns-1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">additionalPackages</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">refName</span><span class="p">:</span><span class="w"> </span><span class="l">metrics-server*</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">refName</span><span class="p">:</span><span class="w"> </span><span class="l">secretgen-controller*</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">refName</span><span class="p">:</span><span class="w"> </span><span class="l">pinniped*</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">cni</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">refName</span><span class="p">:</span><span class="w"> </span><span class="l">antrea*</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">valuesFrom</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">providerRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l">cni.tanzu.vmware.com</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">AntreaConfig</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tkg-cluster-1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">cpi</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">refName</span><span class="p">:</span><span class="w"> </span><span class="l">vsphere-cpi*</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">valuesFrom</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">providerRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l">cpi.tanzu.vmware.com</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">VSphereCPIConfig</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tkg-cluster-1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">csi</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">refName</span><span class="p">:</span><span class="w"> </span><span class="l">vsphere-csi*</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">valuesFrom</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">providerRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l">csi.tanzu.vmware.com</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">VSphereCSIConfig</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tkg-cluster-1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">kapp</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">refName</span><span class="p">:</span><span class="w"> </span><span class="l">kapp-controller*</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Secret</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tkg-cluster-1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">tkg-ns-1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">stringData</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="l">password</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l">andreasm@cpod-nsxam-wdc.domain.net</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">cluster.x-k8s.io/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Cluster</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">osInfo</span><span class="p">:</span><span class="w"> </span><span class="l">ubuntu,20.04,amd64</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">tkg/plan</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">tkg.tanzu.vmware.com/cluster-name</span><span class="p">:</span><span class="w"> </span><span class="l">tkg-cluster-1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tkg-cluster-1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">tkg-ns-1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">clusterNetwork</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">pods</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">cidrBlocks</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="m">10.131.0.0</span><span class="l">/16</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">services</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">cidrBlocks</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="m">10.132.0.0</span><span class="l">/16</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">topology</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">class</span><span class="p">:</span><span class="w"> </span><span class="l">tkg-vsphere-default-v1.1.0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">controlPlane</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">run.tanzu.vmware.com/resolve-os-image</span><span class="p">:</span><span class="w"> </span><span class="l">image-type=ova,os-name=ubuntu</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">variables</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cni</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l">antrea</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">controlPlaneCertificateRotation</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">value</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">activate</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">daysBefore</span><span class="p">:</span><span class="w"> </span><span class="m">90</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">auditLogging</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">value</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">podSecurityStandard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">value</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">audit</span><span class="p">:</span><span class="w"> </span><span class="l">restricted</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">deactivated</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">warn</span><span class="p">:</span><span class="w"> </span><span class="l">restricted</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">apiServerEndpoint</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">aviAPIServerHAProvider</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">vcenter</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">value</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">cloneMode</span><span class="p">:</span><span class="w"> </span><span class="l">fullClone</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">datacenter</span><span class="p">:</span><span class="w"> </span><span class="l">/cPod-NSXAM-WDC</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">datastore</span><span class="p">:</span><span class="w"> </span><span class="l">/cPod-NSXAM-WDC/datastore/vsanDatastore-wdc-01</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">folder</span><span class="p">:</span><span class="w"> </span><span class="l">/cPod-NSXAM-WDC/vm/TKGm</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">network</span><span class="p">:</span><span class="w"> </span><span class="l">/cPod-NSXAM-WDC/network/ls-tkg-mgmt</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">resourcePool</span><span class="p">:</span><span class="w"> </span><span class="l">/cPod-NSXAM-WDC/host/Cluster-1/Resources</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="l">vcsa.cpod-nsxam-wdc.az-wdc.domain.net</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">storagePolicyID</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">tlsThumbprint</span><span class="p">:</span><span class="w"> </span><span class="l">&lt;SHA&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">user</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">value</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">sshAuthorizedKeys</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="l">ssh-rsa 2UEBx235bVRSxQ==</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">controlPlane</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">value</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">machine</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">diskGiB</span><span class="p">:</span><span class="w"> </span><span class="m">20</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">memoryMiB</span><span class="p">:</span><span class="w"> </span><span class="m">4096</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">numCPUs</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">worker</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">value</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">machine</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">diskGiB</span><span class="p">:</span><span class="w"> </span><span class="m">20</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">memoryMiB</span><span class="p">:</span><span class="w"> </span><span class="m">4096</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">numCPUs</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">controlPlaneZoneMatchingLabels</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">value</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">region</span><span class="p">:</span><span class="w"> </span><span class="l">k8s-region</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">tkg-cp</span><span class="p">:</span><span class="w"> </span><span class="l">allowed</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">security</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">value</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">fileIntegrityMonitoring</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">imagePolicy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">pullAlways</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">webhook</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">allowTTL</span><span class="p">:</span><span class="w"> </span><span class="m">50</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">defaultAllow</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">denyTTL</span><span class="p">:</span><span class="w"> </span><span class="m">60</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">retryBackoff</span><span class="p">:</span><span class="w"> </span><span class="m">500</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">kubeletOptions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">eventQPS</span><span class="p">:</span><span class="w"> </span><span class="m">50</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">streamConnectionIdleTimeout</span><span class="p">:</span><span class="w"> </span><span class="l">4h0m0s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">systemCryptoPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l">v1.26.5+vmware.2-tkg.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">workers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">machineDeployments</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">class</span><span class="p">:</span><span class="w"> </span><span class="l">tkg-worker</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">failureDomain</span><span class="p">:</span><span class="w"> </span><span class="l">wdc-zone-2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">run.tanzu.vmware.com/resolve-os-image</span><span class="p">:</span><span class="w"> </span><span class="l">image-type=ova,os-name=ubuntu</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">md-0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">strategy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">RollingUpdate</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">class</span><span class="p">:</span><span class="w"> </span><span class="l">tkg-worker</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">failureDomain</span><span class="p">:</span><span class="w"> </span><span class="l">wdc-zone-3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">run.tanzu.vmware.com/resolve-os-image</span><span class="p">:</span><span class="w"> </span><span class="l">image-type=ova,os-name=ubuntu</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">md-1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">strategy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">RollingUpdate</span><span class="w">
</span></span></span></code></pre></div><p>In addition I am also setting these three additional settings:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="w">        </span><span class="nt">enablePodToPodConnectivity</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="c"># set to true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">enableStretchedNetworkPolicy</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="c"># set to true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;antrea-multicluster&#34;</span><span class="w"> </span><span class="c"># the namespace will be created later, and I am not sure its even required to define anything here. Leave it blank &#34;&#34;</span><span class="w">
</span></span></span></code></pre></div><p>As I will test out the Multi-cluster NetworkPolicy and routing pod traffic through Multi-cluster Gateways, more on that later. In the workload cluster manifest make sure the services and pod CIDR does not overlap between your clusters that will be joined to the same Multi-cluster ClusterSet.</p>
<p>The namespace section is not mandatory.</p>
<div class="notice info">
<p>The services CIDRs can not overlap</p>
<p>The pod CIDR can not overlap if enabling PodToPodConnectivity</p>
</div>
<p>After my TKG workload cluster has been provisioned with the above yaml, this will give me the following AntreaConfig in my workload cluster:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="l">andreasm@tkg-bootstrap:~$ k get configmaps -n kube-system antrea-config -oyaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">antrea-agent.conf</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">    featureGates:
</span></span></span><span class="line"><span class="cl"><span class="sd">      AntreaProxy: true
</span></span></span><span class="line"><span class="cl"><span class="sd">      EndpointSlice: true
</span></span></span><span class="line"><span class="cl"><span class="sd">      TopologyAwareHints: false
</span></span></span><span class="line"><span class="cl"><span class="sd">      Traceflow: true
</span></span></span><span class="line"><span class="cl"><span class="sd">      NodePortLocal: true
</span></span></span><span class="line"><span class="cl"><span class="sd">      AntreaPolicy: true
</span></span></span><span class="line"><span class="cl"><span class="sd">      FlowExporter: false
</span></span></span><span class="line"><span class="cl"><span class="sd">      NetworkPolicyStats: false
</span></span></span><span class="line"><span class="cl"><span class="sd">      Egress: true
</span></span></span><span class="line"><span class="cl"><span class="sd">      AntreaIPAM: false
</span></span></span><span class="line"><span class="cl"><span class="sd">      Multicast: false
</span></span></span><span class="line"><span class="cl"><span class="sd">      Multicluster: true #enabled
</span></span></span><span class="line"><span class="cl"><span class="sd">      SecondaryNetwork: false
</span></span></span><span class="line"><span class="cl"><span class="sd">      ServiceExternalIP: false
</span></span></span><span class="line"><span class="cl"><span class="sd">      TrafficControl: false
</span></span></span><span class="line"><span class="cl"><span class="sd">      SupportBundleCollection: false
</span></span></span><span class="line"><span class="cl"><span class="sd">      L7NetworkPolicy: false
</span></span></span><span class="line"><span class="cl"><span class="sd">    trafficEncapMode: encap
</span></span></span><span class="line"><span class="cl"><span class="sd">    noSNAT: false
</span></span></span><span class="line"><span class="cl"><span class="sd">    tunnelType: geneve
</span></span></span><span class="line"><span class="cl"><span class="sd">    tunnelPort: 0
</span></span></span><span class="line"><span class="cl"><span class="sd">    tunnelCsum: false
</span></span></span><span class="line"><span class="cl"><span class="sd">    trafficEncryptionMode: none
</span></span></span><span class="line"><span class="cl"><span class="sd">    enableBridgingMode: false
</span></span></span><span class="line"><span class="cl"><span class="sd">    disableTXChecksumOffload: false
</span></span></span><span class="line"><span class="cl"><span class="sd">    wireGuard:
</span></span></span><span class="line"><span class="cl"><span class="sd">      port: 51820
</span></span></span><span class="line"><span class="cl"><span class="sd">    egress:
</span></span></span><span class="line"><span class="cl"><span class="sd">      exceptCIDRs: []
</span></span></span><span class="line"><span class="cl"><span class="sd">      maxEgressIPsPerNode: 255
</span></span></span><span class="line"><span class="cl"><span class="sd">    serviceCIDR: 10.132.0.0/16
</span></span></span><span class="line"><span class="cl"><span class="sd">    nodePortLocal:
</span></span></span><span class="line"><span class="cl"><span class="sd">      enable: true
</span></span></span><span class="line"><span class="cl"><span class="sd">      portRange: 61000-62000
</span></span></span><span class="line"><span class="cl"><span class="sd">    tlsCipherSuites: TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,TLS_RSA_WITH_AES_256_GCM_SHA384
</span></span></span><span class="line"><span class="cl"><span class="sd">    multicast: {}
</span></span></span><span class="line"><span class="cl"><span class="sd">    antreaProxy:
</span></span></span><span class="line"><span class="cl"><span class="sd">      proxyAll: false
</span></span></span><span class="line"><span class="cl"><span class="sd">      nodePortAddresses: []
</span></span></span><span class="line"><span class="cl"><span class="sd">      skipServices: []
</span></span></span><span class="line"><span class="cl"><span class="sd">      proxyLoadBalancerIPs: true
</span></span></span><span class="line"><span class="cl"><span class="sd">    multicluster:
</span></span></span><span class="line"><span class="cl"><span class="sd">      enableGateway: true #enabled
</span></span></span><span class="line"><span class="cl"><span class="sd">      namespace: antrea-multicluster
</span></span></span><span class="line"><span class="cl"><span class="sd">      enableStretchedNetworkPolicy: true #enabled
</span></span></span><span class="line"><span class="cl"><span class="sd">      enablePodToPodConnectivity: true #enabled</span><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">antrea-cni.conflist</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">    {
</span></span></span><span class="line"><span class="cl"><span class="sd">        &#34;cniVersion&#34;:&#34;0.3.0&#34;,
</span></span></span><span class="line"><span class="cl"><span class="sd">        &#34;name&#34;: &#34;antrea&#34;,
</span></span></span><span class="line"><span class="cl"><span class="sd">        &#34;plugins&#34;: [
</span></span></span><span class="line"><span class="cl"><span class="sd">            {
</span></span></span><span class="line"><span class="cl"><span class="sd">                &#34;type&#34;: &#34;antrea&#34;,
</span></span></span><span class="line"><span class="cl"><span class="sd">                &#34;ipam&#34;: {
</span></span></span><span class="line"><span class="cl"><span class="sd">                    &#34;type&#34;: &#34;host-local&#34;
</span></span></span><span class="line"><span class="cl"><span class="sd">                }
</span></span></span><span class="line"><span class="cl"><span class="sd">            }
</span></span></span><span class="line"><span class="cl"><span class="sd">            ,
</span></span></span><span class="line"><span class="cl"><span class="sd">            {
</span></span></span><span class="line"><span class="cl"><span class="sd">                &#34;type&#34;: &#34;portmap&#34;,
</span></span></span><span class="line"><span class="cl"><span class="sd">                &#34;capabilities&#34;: {&#34;portMappings&#34;: true}
</span></span></span><span class="line"><span class="cl"><span class="sd">            }
</span></span></span><span class="line"><span class="cl"><span class="sd">            ,
</span></span></span><span class="line"><span class="cl"><span class="sd">            {
</span></span></span><span class="line"><span class="cl"><span class="sd">                &#34;type&#34;: &#34;bandwidth&#34;,
</span></span></span><span class="line"><span class="cl"><span class="sd">                &#34;capabilities&#34;: {&#34;bandwidth&#34;: true}
</span></span></span><span class="line"><span class="cl"><span class="sd">            }
</span></span></span><span class="line"><span class="cl"><span class="sd">        ]
</span></span></span><span class="line"><span class="cl"><span class="sd">    }</span><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">antrea-controller.conf</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">    featureGates:
</span></span></span><span class="line"><span class="cl"><span class="sd">      Traceflow: true
</span></span></span><span class="line"><span class="cl"><span class="sd">      AntreaPolicy: true
</span></span></span><span class="line"><span class="cl"><span class="sd">      NetworkPolicyStats: false
</span></span></span><span class="line"><span class="cl"><span class="sd">      Multicast: false
</span></span></span><span class="line"><span class="cl"><span class="sd">      Egress: true
</span></span></span><span class="line"><span class="cl"><span class="sd">      AntreaIPAM: false
</span></span></span><span class="line"><span class="cl"><span class="sd">      ServiceExternalIP: false
</span></span></span><span class="line"><span class="cl"><span class="sd">      SupportBundleCollection: false
</span></span></span><span class="line"><span class="cl"><span class="sd">      L7NetworkPolicy: false
</span></span></span><span class="line"><span class="cl"><span class="sd">      Multicluster: true
</span></span></span><span class="line"><span class="cl"><span class="sd">    tlsCipherSuites: TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,TLS_RSA_WITH_AES_256_GCM_SHA384
</span></span></span><span class="line"><span class="cl"><span class="sd">    nodeIPAM: null
</span></span></span><span class="line"><span class="cl"><span class="sd">    multicluster:
</span></span></span><span class="line"><span class="cl"><span class="sd">      enableStretchedNetworkPolicy: true
</span></span></span><span class="line"><span class="cl"><span class="sd">    cloudProvider:
</span></span></span><span class="line"><span class="cl"><span class="sd">      name: &#34;&#34;</span><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">kapp.k14s.io/identity</span><span class="p">:</span><span class="w"> </span><span class="l">v1;kube-system//ConfigMap/antrea-config;v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">kapp.k14s.io/original</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;{&#34;apiVersion&#34;:&#34;v1&#34;,&#34;data&#34;:{&#34;antrea-agent.conf&#34;:&#34;featureGates:\n  AntreaProxy:
</span></span></span><span class="line"><span class="cl"><span class="s1">      true\n  EndpointSlice: true\n  TopologyAwareHints: false\n  Traceflow: true\n  NodePortLocal:
</span></span></span><span class="line"><span class="cl"><span class="s1">      true\n  AntreaPolicy: true\n  FlowExporter: false\n  NetworkPolicyStats: false\n  Egress:
</span></span></span><span class="line"><span class="cl"><span class="s1">      true\n  AntreaIPAM: false\n  Multicast: false\n  Multicluster: true\n  SecondaryNetwork:
</span></span></span><span class="line"><span class="cl"><span class="s1">      false\n  ServiceExternalIP: false\n  TrafficControl: false\n  SupportBundleCollection:
</span></span></span><span class="line"><span class="cl"><span class="s1">      false\n  L7NetworkPolicy: false\ntrafficEncapMode: encap\nnoSNAT: false\ntunnelType:
</span></span></span><span class="line"><span class="cl"><span class="s1">      geneve\ntunnelPort: 0\ntunnelCsum: false\ntrafficEncryptionMode: none\nenableBridgingMode:
</span></span></span><span class="line"><span class="cl"><span class="s1">      false\ndisableTXChecksumOffload: false\nwireGuard:\n  port: 51820\negress:\n  exceptCIDRs:
</span></span></span><span class="line"><span class="cl"><span class="s1">      []\n  maxEgressIPsPerNode: 255\nserviceCIDR: 100.20.0.0/16\nnodePortLocal:\n  enable:
</span></span></span><span class="line"><span class="cl"><span class="s1">      true\n  portRange: 61000-62000\ntlsCipherSuites: TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,TLS_RSA_WITH_AES_256_GCM_SHA384\nmulticast:
</span></span></span><span class="line"><span class="cl"><span class="s1">      {}\nantreaProxy:\n  proxyAll: false\n  nodePortAddresses: []\n  skipServices:
</span></span></span><span class="line"><span class="cl"><span class="s1">      []\n  proxyLoadBalancerIPs: true\nmulticluster:\n  enableGateway: true\n  enableStretchedNetworkPolicy:
</span></span></span><span class="line"><span class="cl"><span class="s1">      true\n  enablePodToPodConnectivity: true\n&#34;,&#34;antrea-cni.conflist&#34;:&#34;{\n    \&#34;cniVersion\&#34;:\&#34;0.3.0\&#34;,\n    \&#34;name\&#34;:
</span></span></span><span class="line"><span class="cl"><span class="s1">      \&#34;antrea\&#34;,\n    \&#34;plugins\&#34;: [\n        {\n            \&#34;type\&#34;: \&#34;antrea\&#34;,\n            \&#34;ipam\&#34;:
</span></span></span><span class="line"><span class="cl"><span class="s1">      {\n                \&#34;type\&#34;: \&#34;host-local\&#34;\n            }\n        }\n        ,\n        {\n            \&#34;type\&#34;:
</span></span></span><span class="line"><span class="cl"><span class="s1">      \&#34;portmap\&#34;,\n            \&#34;capabilities\&#34;: {\&#34;portMappings\&#34;: true}\n        }\n        ,\n        {\n            \&#34;type\&#34;:
</span></span></span><span class="line"><span class="cl"><span class="s1">      \&#34;bandwidth\&#34;,\n            \&#34;capabilities\&#34;: {\&#34;bandwidth\&#34;: true}\n        }\n    ]\n}\n&#34;,&#34;antrea-controller.conf&#34;:&#34;featureGates:\n  Traceflow:
</span></span></span><span class="line"><span class="cl"><span class="s1">      true\n  AntreaPolicy: true\n  NetworkPolicyStats: false\n  Multicast: false\n  Egress:
</span></span></span><span class="line"><span class="cl"><span class="s1">      true\n  AntreaIPAM: false\n  ServiceExternalIP: false\n  SupportBundleCollection:
</span></span></span><span class="line"><span class="cl"><span class="s1">      false\n  L7NetworkPolicy: false\n  Multicluster: true\ntlsCipherSuites: TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,TLS_RSA_WITH_AES_256_GCM_SHA384\nnodeIPAM:
</span></span></span><span class="line"><span class="cl"><span class="s1">      null\nmulticluster:\n  enableStretchedNetworkPolicy: true\ncloudProvider:\n  name:
</span></span></span><span class="line"><span class="cl"><span class="s1">      \&#34;\&#34;\n&#34;},&#34;kind&#34;:&#34;ConfigMap&#34;,&#34;metadata&#34;:{&#34;labels&#34;:{&#34;app&#34;:&#34;antrea&#34;,&#34;kapp.k14s.io/app&#34;:&#34;1695711779258641591&#34;,&#34;kapp.k14s.io/association&#34;:&#34;v1.c39c4aca919097e50452c3432329dd40&#34;},&#34;name&#34;:&#34;antrea-config&#34;,&#34;namespace&#34;:&#34;kube-system&#34;}}&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">kapp.k14s.io/original-diff-md5</span><span class="p">:</span><span class="w"> </span><span class="l">c6e94dc94aed3401b5d0f26ed6c0bff3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2023-09-26T07:03:04Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">antrea</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">kapp.k14s.io/app</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;1695711779258641591&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">kapp.k14s.io/association</span><span class="p">:</span><span class="w"> </span><span class="l">v1.c39c4aca919097e50452c3432329dd40</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">antrea-config</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-system</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resourceVersion</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;902&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">uid</span><span class="p">:</span><span class="w"> </span><span class="l">49aea43b-4f8e-4f60-9d54-b299a73bdba8</span><span class="w">
</span></span></span></code></pre></div><p>Notice that the features have been enabled under the corresponding <strong>antrea-agent.conf</strong> and <strong>antrea-controller.conf</strong> sections.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">antrea-agent.conf</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">    featureGates:
</span></span></span><span class="line"><span class="cl"><span class="sd">      Multicluster: true #enabled
</span></span></span><span class="line"><span class="cl"><span class="sd">    multicluster:
</span></span></span><span class="line"><span class="cl"><span class="sd">      enableGateway: true #enabled
</span></span></span><span class="line"><span class="cl"><span class="sd">      namespace: antrea-multicluster
</span></span></span><span class="line"><span class="cl"><span class="sd">      enableStretchedNetworkPolicy: true #enabled
</span></span></span><span class="line"><span class="cl"><span class="sd">      enablePodToPodConnectivity: true #enabled</span><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">antrea-controller.conf</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">    featureGates:
</span></span></span><span class="line"><span class="cl"><span class="sd">      Multicluster: true #enabled
</span></span></span><span class="line"><span class="cl"><span class="sd">    multicluster:
</span></span></span><span class="line"><span class="cl"><span class="sd">      enableStretchedNetworkPolicy: true #enabled</span><span class="w">    
</span></span></span></code></pre></div><p>That&rsquo;s it for enabling Antrea Multi-cluster in TKG workload clusters.</p>


<h2 class="relative group">Tanzu in vSphere and Antrea Multi-cluster 
    <div id="tanzu-in-vsphere-and-antrea-multi-cluster" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#tanzu-in-vsphere-and-antrea-multi-cluster" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>Coming later - stay tuned</p>


<h2 class="relative group">Install and Configure Antrea Multi-cluster 
    <div id="install-and-configure-antrea-multi-cluster" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#install-and-configure-antrea-multi-cluster" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>All the instructions for this exercise has been taken from the offial <a href="https://antrea.io/docs/v1.11.1/docs/multicluster/user-guide/" target="_blank">antrea.io</a> and the Antrea <a href="https://github.com/antrea-io/antrea/blob/release-1.11/docs/multicluster/user-guide.md" target="_blank">Github</a> pages.
My TKG Cluster-1 (Leader cluster) is up and running with the required Antrea Multi-cluster settings (see above) enabled. Now I will follow the user-guide which will involve installing the Antrea Multi-cluster controller in the leader cluster, create ClusterSet, Multi-cluster Gateway configuration. I will start doing all the steps that can be done on the Leader cluster, then take the member clusters next. I will be following the yaml approach. There is also another approach using <strong>antctl</strong> I may add that also or update the post at a later stage to involve these steps.</p>
<div class="notice info">
<p>It is important to follow the documentation according to the version of Antrea being used. This is due to updates in api, and general configuration settings. An example. If I am on Antrea v1.11.1 I would be using the following github or antrea url:
<a href="https://github.com/antrea-io/antrea/blob/release-1.11/docs/multicluster/user-guide.md" target="_blank">https://github.com/antrea-io/antrea/blob/release-1.11/docs/multicluster/user-guide.md</a>
<a href="https://antrea.io/docs/v1.11.1/docs/multicluster/user-guide/" target="_blank">https://antrea.io/docs/v1.11.1/docs/multicluster/user-guide/</a></p>
<p>If using Antrea v1.13.1 I would be using the following url:</p>
<p><a href="https://github.com/antrea-io/antrea/blob/release-1.13/docs/multicluster/user-guide.md" target="_blank">https://github.com/antrea-io/antrea/blob/release-1.13/docs/multicluster/user-guide.md</a>
<a href="https://antrea.io/docs/v1.13.1/docs/multicluster/user-guide/" target="_blank">https://antrea.io/docs/v1.13.1/docs/multicluster/user-guide/</a></p>
</div>
<div class="notice info">
<p>Antrea Multi-cluster can be configured in different topologies</p>
<p>Read more here: <a href="https://github.com/antrea-io/antrea/blob/main/docs/multicluster/user-guide.md#deploy-antrea-multi-cluster-controller" target="_blank">https://github.com/antrea-io/antrea/blob/main/docs/multicluster/user-guide.md#deploy-antrea-multi-cluster-controller</a></p>
</div>


<h3 class="relative group">Install the Antrea Multi-cluster controller in the dedicated leader cluster 
    <div id="install-the-antrea-multi-cluster-controller-in-the-dedicated-leader-cluster" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#install-the-antrea-multi-cluster-controller-in-the-dedicated-leader-cluster" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>I will start by creating an enviroment variable, exporting the Antrea version I am using, for the following yaml manifests commands to use. Just to be certain I will first check the actual Antrea version by issuing the <strong>antctl version</strong> command inside the Antrea controller pod:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">k <span class="nb">exec</span> -it -n kube-system antrea-controller-75b85cf45b-hvhq4 bash
</span></span><span class="line"><span class="cl">kubectl <span class="nb">exec</span> <span class="o">[</span>POD<span class="o">]</span> <span class="o">[</span>COMMAND<span class="o">]</span> is DEPRECATED and will be removed in a future version. Use kubectl <span class="nb">exec</span> <span class="o">[</span>POD<span class="o">]</span> -- <span class="o">[</span>COMMAND<span class="o">]</span> instead.
</span></span><span class="line"><span class="cl">root@tkg-cluster-1-btnn5-vzq5n:/# antctl version
</span></span><span class="line"><span class="cl">antctlVersion: v1.11.1-4776f66
</span></span><span class="line"><span class="cl">controllerVersion: v1.11.1-4776f66
</span></span><span class="line"><span class="cl">root@tkg-cluster-1-btnn5-vzq5n:/#
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@tkg-bootstrap:~$ <span class="nb">export</span> <span class="nv">TAG</span><span class="o">=</span>v1.11.1
</span></span></code></pre></div><p>Install the Multi-cluster controller in the namespace <em>antrea-multicluster</em> issuing the following <strong>two</strong> yamls:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl apply -f https://github.com/antrea-io/antrea/releases/download/<span class="nv">$TAG</span>/antrea-multicluster-leader-global.yml
</span></span><span class="line"><span class="cl">kubectl apply -f https://github.com/antrea-io/antrea/releases/download/<span class="nv">$TAG</span>/antrea-multicluster-leader-namespaced.yml
</span></span></code></pre></div><p>Creating the namespace antrea-multicluster:</p>
<pre tabindex="0"><code>andreasm@tkg-bootstrap:~$ kubectl create ns antrea-multicluster
namespace/antrea-multicluster created
</code></pre><p>Applying the antrea-multicluster-leader-global.yaml:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">## Apply the antrea-multicluster-leader-global.yaml</span>
</span></span><span class="line"><span class="cl">andreasm@tkg-bootstrap:~$ kubectl apply -f https://github.com/antrea-io/antrea/releases/download/<span class="nv">$TAG</span>/antrea-multicluster-leader-global.yml
</span></span><span class="line"><span class="cl"><span class="c1">## applied</span>
</span></span><span class="line"><span class="cl">customresourcedefinition.apiextensions.k8s.io/clusterclaims.multicluster.crd.antrea.io created
</span></span><span class="line"><span class="cl">customresourcedefinition.apiextensions.k8s.io/clustersets.multicluster.crd.antrea.io created
</span></span><span class="line"><span class="cl">customresourcedefinition.apiextensions.k8s.io/memberclusterannounces.multicluster.crd.antrea.io created
</span></span><span class="line"><span class="cl">customresourcedefinition.apiextensions.k8s.io/resourceexports.multicluster.crd.antrea.io created
</span></span><span class="line"><span class="cl">customresourcedefinition.apiextensions.k8s.io/resourceimports.multicluster.crd.antrea.io created
</span></span></code></pre></div><p>Applying the antrea-multicluster-leader-namespaced.yaml:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">## Apply the antrea-multicluster-leader-namespaced.yaml</span>
</span></span><span class="line"><span class="cl">andreasm@tkg-bootstrap:~$ kubectl apply -f https://github.com/antrea-io/antrea/releases/download/<span class="nv">$TAG</span>/antrea-multicluster-leader-namespaced.yml
</span></span><span class="line"><span class="cl"><span class="c1">## applied</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">serviceaccount/antrea-mc-controller created
</span></span><span class="line"><span class="cl">serviceaccount/antrea-mc-member-access-sa created
</span></span><span class="line"><span class="cl">role.rbac.authorization.k8s.io/antrea-mc-controller-role created
</span></span><span class="line"><span class="cl">role.rbac.authorization.k8s.io/antrea-mc-member-cluster-role created
</span></span><span class="line"><span class="cl">clusterrole.rbac.authorization.k8s.io/antrea-multicluster-antrea-mc-controller-webhook-role created
</span></span><span class="line"><span class="cl">rolebinding.rbac.authorization.k8s.io/antrea-mc-controller-rolebinding created
</span></span><span class="line"><span class="cl">rolebinding.rbac.authorization.k8s.io/antrea-mc-member-cluster-rolebinding created
</span></span><span class="line"><span class="cl">clusterrolebinding.rbac.authorization.k8s.io/antrea-multicluster-antrea-mc-controller-webhook-rolebinding created
</span></span><span class="line"><span class="cl">configmap/antrea-mc-controller-config created
</span></span><span class="line"><span class="cl">service/antrea-mc-webhook-service created
</span></span><span class="line"><span class="cl">Warning: would violate PodSecurity <span class="s2">&#34;restricted:v1.24&#34;</span>: host namespaces <span class="o">(</span><span class="nv">hostNetwork</span><span class="o">=</span><span class="nb">true</span><span class="o">)</span>, hostPort <span class="o">(</span>container <span class="s2">&#34;antrea-mc-controller&#34;</span> uses hostPort 9443<span class="o">)</span>, unrestricted capabilities <span class="o">(</span>container <span class="s2">&#34;antrea-mc-controller&#34;</span> must <span class="nb">set</span> securityContext.capabilities.drop<span class="o">=[</span><span class="s2">&#34;ALL&#34;</span><span class="o">])</span>, runAsNonRoot !<span class="o">=</span> <span class="nb">true</span> <span class="o">(</span>pod or container <span class="s2">&#34;antrea-mc-controller&#34;</span> must <span class="nb">set</span> securityContext.runAsNonRoot<span class="o">=</span><span class="nb">true</span><span class="o">)</span>, seccompProfile <span class="o">(</span>pod or container <span class="s2">&#34;antrea-mc-controller&#34;</span> must <span class="nb">set</span> securityContext.seccompProfile.type to <span class="s2">&#34;RuntimeDefault&#34;</span> or <span class="s2">&#34;Localhost&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">deployment.apps/antrea-mc-controller created
</span></span><span class="line"><span class="cl">mutatingwebhookconfiguration.admissionregistration.k8s.io/antrea-multicluster-antrea-mc-mutating-webhook-configuration created
</span></span><span class="line"><span class="cl">validatingwebhookconfiguration.admissionregistration.k8s.io/antrea-multicluster-antrea-mc-validating-webhook-configuration created
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@tkg-bootstrap:~$ k get pods -n antrea-multicluster
</span></span><span class="line"><span class="cl">NAME                                    READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">antrea-mc-controller-7697c8b776-dqtzp   1/1     Running   <span class="m">0</span>          58s
</span></span></code></pre></div><p>And the Antrea CRDs including the additional CRDs from the Multi-cluster installation:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">aandreasm@tkg-bootstrap:~$ k get crd -A
</span></span><span class="line"><span class="cl">NAME                                                     CREATED AT
</span></span><span class="line"><span class="cl">antreaagentinfos.crd.antrea.io                           2023-09-26T07:03:02Z
</span></span><span class="line"><span class="cl">antreacontrollerinfos.crd.antrea.io                      2023-09-26T07:03:02Z
</span></span><span class="line"><span class="cl">clusterclaims.multicluster.crd.antrea.io                 2023-09-27T06:59:07Z
</span></span><span class="line"><span class="cl">clustergroups.crd.antrea.io                              2023-09-26T07:03:04Z
</span></span><span class="line"><span class="cl">clusternetworkpolicies.crd.antrea.io                     2023-09-26T07:03:02Z
</span></span><span class="line"><span class="cl">clustersets.multicluster.crd.antrea.io                   2023-09-27T06:59:07Z
</span></span><span class="line"><span class="cl">egresses.crd.antrea.io                                   2023-09-26T07:03:02Z
</span></span><span class="line"><span class="cl">externalentities.crd.antrea.io                           2023-09-26T07:03:02Z
</span></span><span class="line"><span class="cl">externalippools.crd.antrea.io                            2023-09-26T07:03:02Z
</span></span><span class="line"><span class="cl">externalnodes.crd.antrea.io                              2023-09-26T07:03:02Z
</span></span><span class="line"><span class="cl">groups.crd.antrea.io                                     2023-09-26T07:03:04Z
</span></span><span class="line"><span class="cl">ippools.crd.antrea.io                                    2023-09-26T07:03:02Z
</span></span><span class="line"><span class="cl">memberclusterannounces.multicluster.crd.antrea.io        2023-09-27T06:59:08Z
</span></span><span class="line"><span class="cl">multiclusteringresses.ako.vmware.com                     2023-09-26T07:03:51Z
</span></span><span class="line"><span class="cl">networkpolicies.crd.antrea.io                            2023-09-26T07:03:02Z
</span></span><span class="line"><span class="cl">resourceexports.multicluster.crd.antrea.io               2023-09-27T06:59:12Z
</span></span><span class="line"><span class="cl">resourceimports.multicluster.crd.antrea.io               2023-09-27T06:59:15Z
</span></span><span class="line"><span class="cl">supportbundlecollections.crd.antrea.io                   2023-09-26T07:03:03Z
</span></span><span class="line"><span class="cl">tierentitlementbindings.crd.antrea.tanzu.vmware.com      2023-09-26T07:03:04Z
</span></span><span class="line"><span class="cl">tierentitlements.crd.antrea.tanzu.vmware.com             2023-09-26T07:03:02Z
</span></span><span class="line"><span class="cl">tiers.crd.antrea.io                                      2023-09-26T07:03:03Z
</span></span><span class="line"><span class="cl">traceflows.crd.antrea.io                                 2023-09-26T07:03:03Z
</span></span><span class="line"><span class="cl">trafficcontrols.crd.antrea.io                            2023-09-26T07:03:03Z
</span></span></code></pre></div>

<h3 class="relative group">Install the Antrea Multi-cluster controller in the member clusters 
    <div id="install-the-antrea-multi-cluster-controller-in-the-member-clusters" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#install-the-antrea-multi-cluster-controller-in-the-member-clusters" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>Next up is to deploy the Antrea Multi-cluster in both of my member clusters, tkg-cluster-2 and tkg-cluster-3. They have also been configured to enable the Multi-cluster feature gate. This operation involves applying the antrea-multicluster-member.yaml</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@tkg-bootstrap:~$ k config current-context
</span></span><span class="line"><span class="cl">tkg-cluster-2-admin@tkg-cluster-2
</span></span><span class="line"><span class="cl"><span class="c1"># Show running pods</span>
</span></span><span class="line"><span class="cl">NAMESPACE              NAME                                                     READY   STATUS      RESTARTS      AGE
</span></span><span class="line"><span class="cl">avi-system             ako-0                                                    1/1     Running     <span class="m">0</span>             19h
</span></span><span class="line"><span class="cl">kube-system            antrea-agent-grq68                                       2/2     Running     <span class="m">0</span>             18h
</span></span><span class="line"><span class="cl">kube-system            antrea-agent-kcbc8                                       2/2     Running     <span class="m">0</span>             18h
</span></span><span class="line"><span class="cl">kube-system            antrea-agent-zvgcc                                       2/2     Running     <span class="m">0</span>             18h
</span></span><span class="line"><span class="cl">kube-system            antrea-controller-bc584bbcd-7hw7n                        1/1     Running     <span class="m">0</span>             18h
</span></span><span class="line"><span class="cl">kube-system            coredns-75f565d4dd-48sgb                                 1/1     Running     <span class="m">0</span>             19h
</span></span><span class="line"><span class="cl">kube-system            coredns-75f565d4dd-wr8pl                                 1/1     Running     <span class="m">0</span>             19h
</span></span><span class="line"><span class="cl">kube-system            etcd-tkg-cluster-2-jzmpk-w2thj                           1/1     Running     <span class="m">0</span>             19h
</span></span><span class="line"><span class="cl">kube-system            kube-apiserver-tkg-cluster-2-jzmpk-w2thj                 1/1     Running     <span class="m">0</span>             19h
</span></span><span class="line"><span class="cl">kube-system            kube-controller-manager-tkg-cluster-2-jzmpk-w2thj        1/1     Running     <span class="m">0</span>             19h
</span></span><span class="line"><span class="cl">kube-system            kube-proxy-dmcb5                                         1/1     Running     <span class="m">0</span>             19h
</span></span><span class="line"><span class="cl">kube-system            kube-proxy-kr5hl                                         1/1     Running     <span class="m">0</span>             19h
</span></span><span class="line"><span class="cl">kube-system            kube-proxy-t7qqp                                         1/1     Running     <span class="m">0</span>             19h
</span></span><span class="line"><span class="cl">kube-system            kube-scheduler-tkg-cluster-2-jzmpk-w2thj                 1/1     Running     <span class="m">0</span>             19h
</span></span><span class="line"><span class="cl">kube-system            metrics-server-5666ffccb9-p7qqw                          1/1     Running     <span class="m">0</span>             19h
</span></span><span class="line"><span class="cl">kube-system            vsphere-cloud-controller-manager-6b8v2                   1/1     Running     <span class="m">0</span>             19h
</span></span><span class="line"><span class="cl">secretgen-controller   secretgen-controller-69cbc65949-2x8nv                    1/1     Running     <span class="m">0</span>             19h
</span></span><span class="line"><span class="cl">tkg-system             kapp-controller-5776b48998-7rkzf                         2/2     Running     <span class="m">0</span>             19h
</span></span><span class="line"><span class="cl">tkg-system             tanzu-capabilities-controller-manager-77d8ffcd57-9tgzn   1/1     Running     <span class="m">0</span>             19h
</span></span><span class="line"><span class="cl">vmware-system-antrea   register-placeholder-m5bj8                               0/1     Completed   <span class="m">0</span>             8m41s
</span></span><span class="line"><span class="cl">vmware-system-csi      vsphere-csi-controller-67799db966-qnfv2                  7/7     Running     <span class="m">1</span> <span class="o">(</span>19h ago<span class="o">)</span>   19h
</span></span><span class="line"><span class="cl">vmware-system-csi      vsphere-csi-node-dkcf7                                   3/3     Running     <span class="m">2</span> <span class="o">(</span>19h ago<span class="o">)</span>   19h
</span></span><span class="line"><span class="cl">vmware-system-csi      vsphere-csi-node-w8dqw                                   3/3     Running     <span class="m">3</span> <span class="o">(</span>31m ago<span class="o">)</span>   19h
</span></span><span class="line"><span class="cl">vmware-system-csi      vsphere-csi-node-zxpmz                                   3/3     Running     <span class="m">4</span> <span class="o">(</span>19h ago<span class="o">)</span>   19h
</span></span></code></pre></div><p>Apply the multicluster-member.yaml</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@tkg-bootstrap:~$ kubectl apply -f https://github.com/antrea-io/antrea/releases/download/<span class="nv">$TAG</span>/antrea-multicluster-member.yml
</span></span><span class="line"><span class="cl"><span class="c1">## applied</span>
</span></span><span class="line"><span class="cl">customresourcedefinition.apiextensions.k8s.io/clusterclaims.multicluster.crd.antrea.io created
</span></span><span class="line"><span class="cl">customresourcedefinition.apiextensions.k8s.io/clusterinfoimports.multicluster.crd.antrea.io created
</span></span><span class="line"><span class="cl">customresourcedefinition.apiextensions.k8s.io/clustersets.multicluster.crd.antrea.io created
</span></span><span class="line"><span class="cl">customresourcedefinition.apiextensions.k8s.io/gateways.multicluster.crd.antrea.io created
</span></span><span class="line"><span class="cl">customresourcedefinition.apiextensions.k8s.io/labelidentities.multicluster.crd.antrea.io created
</span></span><span class="line"><span class="cl">customresourcedefinition.apiextensions.k8s.io/serviceexports.multicluster.x-k8s.io created
</span></span><span class="line"><span class="cl">customresourcedefinition.apiextensions.k8s.io/serviceimports.multicluster.x-k8s.io created
</span></span><span class="line"><span class="cl">serviceaccount/antrea-mc-controller created
</span></span><span class="line"><span class="cl">clusterrole.rbac.authorization.k8s.io/antrea-mc-controller-role created
</span></span><span class="line"><span class="cl">clusterrolebinding.rbac.authorization.k8s.io/antrea-mc-controller-rolebinding created
</span></span><span class="line"><span class="cl">configmap/antrea-mc-controller-config created
</span></span><span class="line"><span class="cl">service/antrea-mc-webhook-service created
</span></span><span class="line"><span class="cl">deployment.apps/antrea-mc-controller created
</span></span><span class="line"><span class="cl">mutatingwebhookconfiguration.admissionregistration.k8s.io/antrea-mc-mutating-webhook-configuration created
</span></span><span class="line"><span class="cl">validatingwebhookconfiguration.admissionregistration.k8s.io/antrea-mc-validating-webhook-configuration created
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">NAMESPACE              NAME                                                     READY   STATUS      RESTARTS      AGE
</span></span><span class="line"><span class="cl">kube-system            antrea-mc-controller-5bb945f87f-xk287                    1/1     Running     <span class="m">0</span>             64s
</span></span></code></pre></div><p>The controller is running, and it is running in the kube-system namespace.</p>
<p>Now I will repeat the same operation for my tkg-cluster-3&hellip;</p>


<h2 class="relative group">Create ClusterSet 
    <div id="create-clusterset" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#create-clusterset" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>Creating ClusterSet involves a couple of steps on both Leader cluster and member clusters.</p>


<h3 class="relative group">On the Leader Cluster - Create ServiceAccounts 
    <div id="on-the-leader-cluster---create-serviceaccounts" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#on-the-leader-cluster---create-serviceaccounts" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>First I will configure a ServiceAccount for each member to access the Leader cluster&rsquo;s API.</p>
<p>In my <strong>Leader cluster</strong> I will apply the following yaml:</p>
<p>Member 1, tkg-cluster-2, will be called <strong>member-blue</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c">## This the yaml for creating the Service Account for member-blue</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ServiceAccount</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">member-blue</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">antrea-multicluster</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Secret</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">member-blue-token</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">antrea-multicluster</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">kubernetes.io/service-account.name</span><span class="p">:</span><span class="w"> </span><span class="l">member-blue</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes.io/service-account-token</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">RoleBinding</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">member-blue</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">antrea-multicluster</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">roleRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Role</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">antrea-mc-member-cluster-role</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">subjects</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ServiceAccount</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">member-blue</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">antrea-multicluster</span><span class="w">
</span></span></span></code></pre></div><p>Apply it:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@tkg-bootstrap:~$ k apply -f sa-member-blue.yaml
</span></span><span class="line"><span class="cl"><span class="c1">## applied</span>
</span></span><span class="line"><span class="cl">serviceaccount/member-blue created
</span></span><span class="line"><span class="cl">secret/member-blue-token created
</span></span><span class="line"><span class="cl">rolebinding.rbac.authorization.k8s.io/member-blue created
</span></span></code></pre></div><p>Now create a token yaml file for member blue:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl get secret member-blue-token -n antrea-multicluster -o yaml <span class="p">|</span> grep -w -e <span class="s1">&#39;^apiVersion&#39;</span> -e <span class="s1">&#39;^data&#39;</span> -e <span class="s1">&#39;^metadata&#39;</span> -e <span class="s1">&#39;^ *name:&#39;</span>  -e   <span class="s1">&#39;^kind&#39;</span> -e <span class="s1">&#39;  ca.crt&#39;</span> -e <span class="s1">&#39;  token:&#39;</span> -e <span class="s1">&#39;^type&#39;</span> -e <span class="s1">&#39;  namespace&#39;</span> <span class="p">|</span> sed -e <span class="s1">&#39;s/kubernetes.io\/service-account-token/Opaque/g&#39;</span> -e <span class="s1">&#39;s/antrea-multicluster/kube-system/g&#39;</span> &gt;  member-blue-token.yml
</span></span></code></pre></div><p>This should create the file <strong>member-blue-token.yaml</strong> and the content of the file:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># cat member-blue-token.yml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">cat member-blue-token.yml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">## output</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ca.crt</span><span class="p">:</span><span class="w"> </span><span class="l">LS0tLS1CRUdJ0tCk1JSUM2akNDQWRLZ0F3SUJBZ0lCQURBTkJna3Foa2lHOXcwQkFRc0ZBREFWTVJNd0VRWURWUVFERXdwcmRXSmwKY201bGRHVnpNQjRYRFRJek1Ea3lOakEyTlRReU5Wb1hEVE16TURreU16QTJOVGt5TlZvd0ZURVRNQkVHQTFVRQpBeE1LYTNWaVpYSnVaWFJsY3pDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBTDh2Ck1iWHc0MFM2NERZc2dnMG9qSEVwUHlOOC93MVBkdFE2cGxSSThvbUVuWW1ramc5TThIN3NrTDhqdHR1WXRxQVkKYnorZEFsVmJBcWRrWCtkL3Q5MTZGOWRBYmRveW9Qc3pwREIraVVQdDZ5Nm5YbDhPK0xEV2JWZzdEWTVXQ3lYYQpIeEJBM1I4NUUxRkhvYUxBREZ6OFRsZ2lKR3RZYktROFJYTWlIMk1xczRaNU9Mblp3Qy9rSTNVNEEzMVFlcXl3Cm1VMjd2SDdzZjlwK0tiTE5wZldtMDJoV3hZNzlMS1hCNE1LOStLaXAyVkt4VUlQbHl6bGpXTjQrcngyclN4bVEKbnpmR3NpT0JQTWpOanpQOE44cWJub01hL2Jd1haOHJpazhnenJGN05sQQp6R1BvdC84S2Q5UXZ2Q2doVVlNQ0F3RUFBYU5GTUVNd0RnWURWUjBQQVFIL0JBUURBZ0trTUJJR0ExVWRFd0VCCi93UUlNQVlCQWY4Q0FRQXdIUVlEVlIwT0JCWUVGQk9PWHcrb1o1VGhLQ3I5RnBMWm9ySkZZWW1wTUEwR0NTcUcKU0liM0RRRUJDd1VBQTRJQkFRQ2Rpa2lWYi9pblk1RVNIdVVIcTY2YnBLK1RTQXI5eTFERnN0Qjd2eUt3UGduVAp2bGdEZnZnN1o3UTVOaFhzcFBnV1Y4NEZMMU80UUQ1WmtTYzhLcDVlM1V1ZFFvckRQS3VEOWkzNHVXVVc0TVo5ClR2UUJLNS9sRUlsclBONG5XYmEyazYrOE9tZitmWWREd3JsZTVaa3JUOHh6UnhEbEtXdE5vNVRHMWgrMElUOVgKcVMwL1hzNFpISlU2NGd5dlRsQXlwR2pPdFdxMUc0MEZ5U3dydFJLSE52a3JjTStkeDdvTEM1d003ZTZSTHg1cApnb0Y5dGZZV3ZyUzJWWjl2RUR5QllPN1RheFhEMGlaV2V1VEh0ZFJxTWVLZVAvei9lYnZJMUkvRkWS9NNGdxYjdXbGVqM0JNS051TVc2Q1AwUmFYcXJnUmpnVTAKLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQu=</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">YW50cmVhLW11bHRpY2x1c3Rlcg==</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">token</span><span class="p">:</span><span class="w"> </span><span class="l">WXlKaGJHY2lPaUpTVXpJMCUVRGaWNIUlJTR0Z1VnpkTU1GVjVOalF3VWpKcVNFVXdYMFkzZDFsNmJqWXpUa3hzVUc4aWZRLmV5SnBjM01pT2lKcmRXSmxjbTVsZEdWekwzTmxjblpwWTJWaFkyTnZkVzUwSWl3aWEzVmlaWEp1WlhSbGN5NXBieTl6WlhKMmFXTmxZV05qYjNWdWRDOXVZVzFsYzNCaFkyVWlPaUpoYm5SeVpXRXRiWFZzZEdsamJIVnpkR1Z5SWl3aWEzVmlaWEp1WlhSbGN5NXBieTl6WlhKMmFXTmxZV05qYjNWdWRDOXpaV055WlhRdWJtRnRaU0k2SW0xbGJXSmxjaTFpYkhWbExYUnZhMlZ1SWl3aWEzVmlaWEp1WlhSbGN5NXBieTl6WlhKMmFXTmxZV05qY5RdWJtRnRaU0k2SW0xbGJXSmxjaTFpYkhWbElpd2lhM1ZpWlhKdVpYUmxjeTVwYnk5elpYSjJhV05sWVdOamIzVnVkQzl6WlhKMmFXTmxMV0ZqWTI5MWJuUXVkV2xrSWpvaU1XSTVaVGd4TUdVdE5tTTNaQzAwTjJZekxXRTVaR1F0TldWbU4yTXpPVEE0T0dNNElpd2ljM1ZpSWpvaWMzbHpkR1Z0T25ObGNuWnBZMlZoWTJOdmRXNTBPbUZ1ZEhKbFlTMXRkV3gwYVdOc2RYTjBaWEk2YldWdFltVnlMV0pzZFdVaWZRLmNyU29sN0JzS2JyR2lhUVYyWmJ2OG8tUVl1eVBfWGlnZ1hfcDg2UGs0ZEpVOTBwWk1XYUZTUkFUR1ptQnBCUUJnajI5eVJHbkdvajVHRWN3YVNxWlZaV3FySk9jVTM1QXFlWHhpWm1fUl9LWDB4VUR1Y0wxQTVxNdWhOYTBGUkxmU2FKWUNOME1NTHNKVTBDU3pHUVg1dHlzTXBUN0YwVG0weS1mZFpVOE9IQmJoY0ZDWXkyYk5WdC0weU9pQUlYOHR2TVNrb2NzaHpWUm5ha1A5dmtMaXNVUGh2Vm9xMVROZ2RVRmtjc0lPRjl4ZFo5Ul9PX3NlT1ZLay1hNkhJbjB3THQzZ3FEZHRHU09Ub3BfMUh0djgxeEZQdF9zNlVRNmpldjZpejh3aFAzX1BkSGhwTlNCWFBEc3hZbEhyMlVaUK==</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Secret</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">member-blue-token</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-system</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Opaque</span><span class="w">
</span></span></span></code></pre></div><p><strong>Repeating the steps for my member cluster 2 (tkg-cluster-3)</strong></p>
<p>Member 2, tkg-cluster-3, will be called <strong>member-red</strong> (yes you guessed it right)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c">## This the yaml for creating the Service Account for member-blue</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ServiceAccount</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">member-red</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">antrea-multicluster</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Secret</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">member-red-token</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">antrea-multicluster</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">kubernetes.io/service-account.name</span><span class="p">:</span><span class="w"> </span><span class="l">member-red</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes.io/service-account-token</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">RoleBinding</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">member-red</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">antrea-multicluster</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">roleRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Role</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">antrea-mc-member-cluster-role</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">subjects</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ServiceAccount</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">member-red</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">antrea-multicluster</span><span class="w">
</span></span></span></code></pre></div><p>Apply it:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@tkg-bootstrap:~$ k apply -f sa-member-red.yaml
</span></span><span class="line"><span class="cl"><span class="c1">## applied</span>
</span></span><span class="line"><span class="cl">serviceaccount/member-red created
</span></span><span class="line"><span class="cl">secret/member-red-token created
</span></span><span class="line"><span class="cl">rolebinding.rbac.authorization.k8s.io/member-red created
</span></span></code></pre></div><p>Now create a token yaml file for member red:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl get secret member-red-token -n antrea-multicluster -o yaml <span class="p">|</span> grep -w -e <span class="s1">&#39;^apiVersion&#39;</span> -e <span class="s1">&#39;^data&#39;</span> -e <span class="s1">&#39;^metadata&#39;</span> -e <span class="s1">&#39;^ *name:&#39;</span>  -e   <span class="s1">&#39;^kind&#39;</span> -e <span class="s1">&#39;  ca.crt&#39;</span> -e <span class="s1">&#39;  token:&#39;</span> -e <span class="s1">&#39;^type&#39;</span> -e <span class="s1">&#39;  namespace&#39;</span> <span class="p">|</span> sed -e <span class="s1">&#39;s/kubernetes.io\/service-account-token/Opaque/g&#39;</span> -e <span class="s1">&#39;s/antrea-multicluster/kube-system/g&#39;</span> &gt;  member-blue-token.yml
</span></span></code></pre></div><p>This should create the file <strong>member-red-token.yaml</strong> and the content of the file:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># cat member-red-token.yml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">cat member-red-token.yml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">## output</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ca.crt</span><span class="p">:</span><span class="w"> </span><span class="l">LS0tLS1CRUdJ0tCk1JSUM2akNDQWRLZ0F3SUJBZ0lCQURBTkJna3Foa2lHOXcwQkFRc0ZBREFWTVJNd0VRWURWUVFERXdwcmRXSmwKY201bGRHVnpNQjRYRFRJek1Ea3lOakEyTlRReU5Wb1hEVE16TURreU16QTJOVGt5TlZvd0ZURVRNQkVHQTFVRQpBeE1LYTNWaVpYSnVaWFJsY3pDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBTDh2Ck1iWHc0MFM2NERZc2dnMG9qSEVwUHlOOC93MVBkdFE2cGxSSThvbUVuWW1ramc5TThIN3NrTDhqdHR1WXRxQVkKYnorZEFsVmJBcWRrWCtkL3Q5MTZGOWRBYmRveW9Qc3pwREIraVVQdDZ5Nm5YbDhPK0xEV2JWZzdEWTVXQ3lYYQpIeEJBM1I4NUUxRkhvYUxBREZ6OFRsZ2lKR3RZYktROFJYTWlIMk1xczRaNU9Mblp3Qy9rSTNVNEEzMVFlcXl3Cm1VMjd2SDdzZjlwK0tiTE5wZldtMDJoV3hZNzlMS1hCNE1LOStLaXAyVkt4VUlQbHl6bGpXTjQrcngyclN4bVEKbnpmR3NpT0JQTWpOanpQOE44cWJub01hL2Jd1haOHJpazhnenJGN05sQQp6R1BvdC84S2Q5UXZ2Q2doVVlNQ0F3RUFBYU5GTUVNd0RnWURWUjBQQVFIL0JBUURBZ0trTUJJR0ExVWRFd0VCCi93UUlNQVlCQWY4Q0FRQXdIUVlEVlIwT0JCWUVGQk9PWHcrb1o1VGhLQ3I5RnBMWm9ySkZZWW1wTUEwR0NTcUcKU0liM0RRRUJDd1VBQTRJQkFRQ2Rpa2lWYi9pblk1RVNIdVVIcTY2YnBLK1RTQXI5eTFERnN0Qjd2eUt3UGduVAp2bGdEZnZnN1o3UTVOaFhzcFBnV1Y4NEZMMU80UUQ1WmtTYzhLcDVlM1V1ZFFvckRQS3VEOWkzNHVXVVc0TVo5ClR2UUJLNS9sRUlsclBONG5XYmEyazYrOE9tZitmWWREd3JsZTVaa3JUOHh6UnhEbEtXdE5vNVRHMWgrMElUOVgKcVMwL1hzNFpISlU2NGd5dlRsQXlwR2pPdFdxMUc0MEZ5U3dydFJLSE52a3JjTStkeDdvTEM1d003ZTZSTHg1cApnb0Y5dGZZV3ZyUzJWWjl2RUR5QllPN1RheFhEMGlaV2V1VEh0ZFJxTWVLZVAvei9lYnZJMUkvRkWS9NNGdxYjdXbGVqM0JNS051TVc2Q1AwUmFYcXJnUmpnVTAKLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQu=</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">YW50cmVhLW11bHRpY2x1c3Rlcg==</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">token</span><span class="p">:</span><span class="w"> </span><span class="l">WXlKaGJHY2lPaUpTVXpJMCUVRGaWNIUlJTR0Z1VnpkTU1GVjVOalF3VWpKcVNFVXdYMFkzZDFsNmJqWXpUa3hzVUc4aWZRLmV5SnBjM01pT2lKcmRXSmxjbTVsZEdWekwzTmxjblpwWTJWaFkyTnZkVzUwSWl3aWEzVmlaWEp1WlhSbGN5NXBieTl6WlhKMmFXTmxZV05qYjNWdWRDOXVZVzFsYzNCaFkyVWlPaUpoYm5SeVpXRXRiWFZzZEdsamJIVnpkR1Z5SWl3aWEzVmlaWEp1WlhSbGN5NXBieTl6WlhKMmFXTmxZV05qYjNWdWRDOXpaV055WlhRdWJtRnRaU0k2SW0xbGJXSmxjaTFpYkhWbExYUnZhMlZ1SWl3aWEzVmlaWEp1WlhSbGN5NXBieTl6WlhKMmFXTmxZV05qY5RdWJtRnRaU0k2SW0xbGJXSmxjaTFpYkhWbElpd2lhM1ZpWlhKdVpYUmxjeTVwYnk5elpYSjJhV05sWVdOamIzVnVkQzl6WlhKMmFXTmxMV0ZqWTI5MWJuUXVkV2xrSWpvaU1XSTVaVGd4TUdVdE5tTTNaQzAwTjJZekxXRTVaR1F0TldWbU4yTXpPVEE0T0dNNElpd2ljM1ZpSWpvaWMzbHpkR1Z0T25ObGNuWnBZMlZoWTJOdmRXNTBPbUZ1ZEhKbFlTMXRkV3gwYVdOc2RYTjBaWEk2YldWdFltVnlMV0pzZFdVaWZRLmNyU29sN0JzS2JyR2lhUVYyWmJ2OG8tUVl1eVBfWGlnZ1hfcDg2UGs0ZEpVOTBwWk1XYUZTUkFUR1ptQnBCUUJnajI5eVJHbkdvajVHRWN3YVNxWlZaV3FySk9jVTM1QXFlWHhpWm1fUl9LWDB4VUR1Y0wxQTVxNdWhOYTBGUkxmU2FKWUNOME1NTHNKVTBDU3pHUVg1dHlzTXBUN0YwVG0weS1mZFpVOE9IQmJoY0ZDWXkyYk5WdC0weU9pQUlYOHR2TVNrb2NzaHpWUm5ha1A5dmtMaXNVUGh2Vm9xMVROZ2RVRmtjc0lPRjl4ZFo5Ul9PX3NlT1ZLay1hNkhJbjB3THQzZ3FEZHRHU09Ub3BfMUh0djgxeEZQdF9zNlVRNmpldjZpejh3aFAzX1BkSGhwTlNCWFBEc3hZbEhyMlVaUK==</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Secret</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">member-red-token</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-system</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Opaque</span><span class="w">
</span></span></span></code></pre></div>

<h3 class="relative group">On the Member Cluster apply tokens 
    <div id="on-the-member-cluster-apply-tokens" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#on-the-member-cluster-apply-tokens" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>Now on both members apply the corresponding token yaml, member-1 applies the <strong>member-blue-token.yaml</strong> and member-2 applies the <strong>member-red-token.yaml</strong>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">## tkg-cluster-2</span>
</span></span><span class="line"><span class="cl">andreasm@tkg-bootstrap:~$ k apply -f member-blue-token.yml
</span></span><span class="line"><span class="cl">secret/member-blue-token created
</span></span><span class="line"><span class="cl"><span class="c1">## tkg-cluster-3</span>
</span></span><span class="line"><span class="cl">andreasm@tkg-bootstrap:~$ k apply -f member-red-token.yml
</span></span><span class="line"><span class="cl">secret/member-red-token created
</span></span></code></pre></div>

<h3 class="relative group">On the Leader Cluster - ClusterSet Initialization 
    <div id="on-the-leader-cluster---clusterset-initialization" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#on-the-leader-cluster---clusterset-initialization" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>I am using Antrea version 1.11.1 (that comes with TKG 2.3) so in this step we need to use the v1alpha1 api.</p>
<p>First I need to create a ClusterSet in the Leader cluster by applying the below yaml:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">multicluster.crd.antrea.io/v1alpha2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterClaim</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">id.k8s.io</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">antrea-multicluster</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l">tkg-cluster-leader</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">multicluster.crd.antrea.io/v1alpha2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterClaim</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">clusterset.k8s.io</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">antrea-multicluster</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l">andreasm-clusterset</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">multicluster.crd.antrea.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterSet</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">andreasm-clusterset</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">antrea-multicluster</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">leaders</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">clusterID</span><span class="p">:</span><span class="w"> </span><span class="l">tkg-cluster-leader</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">## apply it</span>
</span></span><span class="line"><span class="cl">andreasm@tkg-bootstrap:~$ k apply -f clusterset-leader.yaml
</span></span><span class="line"><span class="cl"><span class="c1">### applied</span>
</span></span><span class="line"><span class="cl">clusterclaim.multicluster.crd.antrea.io/id.k8s.io created
</span></span><span class="line"><span class="cl">clusterclaim.multicluster.crd.antrea.io/clusterset.k8s.io created
</span></span><span class="line"><span class="cl">clusterset.multicluster.crd.antrea.io/andreasm-clusterset created
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@tkg-bootstrap:~$ k get clustersets.multicluster.crd.antrea.io -A
</span></span><span class="line"><span class="cl">NAMESPACE             NAME                  LEADER CLUSTER NAMESPACE   TOTAL CLUSTERS   READY CLUSTERS   AGE
</span></span><span class="line"><span class="cl">antrea-multicluster   andreasm-clusterset                                                                84s
</span></span><span class="line"><span class="cl">andreasm@tkg-bootstrap:~$ k get clusterclaims.multicluster.crd.antrea.io -A
</span></span><span class="line"><span class="cl">NAMESPACE             NAME                VALUE                 AGE
</span></span><span class="line"><span class="cl">antrea-multicluster   clusterset.k8s.io   andreasm-clusterset   118s
</span></span><span class="line"><span class="cl">antrea-multicluster   id.k8s.io           tkg-cluster-leader    119s
</span></span></code></pre></div>

<h3 class="relative group">On the Member Clusters - ClusterSet Initialization 
    <div id="on-the-member-clusters---clusterset-initialization" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#on-the-member-clusters---clusterset-initialization" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>Next step is to deploy the corresponding yaml on both my member clusters (tkg-cluster-2=member-cluster-blue and tkg-cluster-3=member-cluster-red):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">multicluster.crd.antrea.io/v1alpha2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterClaim</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">id.k8s.io</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-system</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l">member-cluster-blue</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">multicluster.crd.antrea.io/v1alpha2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterClaim</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">clusterset.k8s.io</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-system</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l">andreasm-clusterset</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">multicluster.crd.antrea.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterSet</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">andreasm-clusterset</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-system</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">leaders</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">clusterID</span><span class="p">:</span><span class="w"> </span><span class="l">tkg-cluster-leader</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">secret</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;member-blue-token&#34;</span><span class="w"> </span><span class="c"># secret/token created earlier</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;https://10.101.114.100:6443&#34;</span><span class="w"> </span><span class="c"># reflect the correct endpoint IP for leader cluster</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">antrea-multicluster</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">multicluster.crd.antrea.io/v1alpha2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterClaim</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">id.k8s.io</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-system</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l">member-cluster-red</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">multicluster.crd.antrea.io/v1alpha2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterClaim</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">clusterset.k8s.io</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-system</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l">andreasm-clusterset</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">multicluster.crd.antrea.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterSet</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">andreasm-clusterset</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-system</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">leaders</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">clusterID</span><span class="p">:</span><span class="w"> </span><span class="l">tkg-cluster-leader</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">secret</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;member-red-token&#34;</span><span class="w"> </span><span class="c"># secret/token created earlier</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;https://10.101.114.100:6443&#34;</span><span class="w"> </span><span class="c"># reflect the correct endpoint IP for leader cluster</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">antrea-multicluster</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">## tkg-cluster-2</span>
</span></span><span class="line"><span class="cl">andreasm@tkg-bootstrap:~$ k apply -f clusterclaim-member-blue.yaml
</span></span><span class="line"><span class="cl"><span class="c1">## applied</span>
</span></span><span class="line"><span class="cl">clusterclaim.multicluster.crd.antrea.io/id.k8s.io created
</span></span><span class="line"><span class="cl">clusterclaim.multicluster.crd.antrea.io/clusterset.k8s.io created
</span></span><span class="line"><span class="cl">clusterset.multicluster.crd.antrea.io/andreasm-clusterset created
</span></span><span class="line"><span class="cl"><span class="c1">## tkg-cluster-3</span>
</span></span><span class="line"><span class="cl">andreasm@tkg-bootstrap:~$ k apply -f clusterclaim-member-red.yaml
</span></span><span class="line"><span class="cl"><span class="c1">## applied</span>
</span></span><span class="line"><span class="cl">clusterclaim.multicluster.crd.antrea.io/id.k8s.io created
</span></span><span class="line"><span class="cl">clusterclaim.multicluster.crd.antrea.io/clusterset.k8s.io created
</span></span><span class="line"><span class="cl">clusterset.multicluster.crd.antrea.io/andreasm-clusterset created
</span></span></code></pre></div>

<h3 class="relative group">On the Member Clusters - Multi-cluster Gateway configuration 
    <div id="on-the-member-clusters---multi-cluster-gateway-configuration" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#on-the-member-clusters---multi-cluster-gateway-configuration" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>From the docs:</p>
<blockquote>
<p>Multi-cluster Gateways are required to support multi-cluster Service access across member clusters. Each member cluster should have one Node served as its Multi-cluster Gateway. Multi-cluster Service traffic is routed among clusters through the tunnels between Gateways.</p>
<p>After a member cluster joins a ClusterSet, and the <code>Multicluster</code> feature is enabled on <code>antrea-agent</code>, you can select a Node of the cluster to serve as the Multi-cluster Gateway by adding an annotation: <code>multicluster.antrea.io/gateway=true</code> to the K8s Node.</p>
<p>You can annotate multiple Nodes in a member cluster as the candidates for Multi-cluster Gateway, but only one Node will be selected as the active Gateway. Before Antrea v1.9.0, the Gateway Node is just randomly selected and will never change unless the Node or its <code>gateway</code> annotation is deleted. Starting with Antrea v1.9.0, Antrea Multi-cluster Controller will guarantee a &ldquo;ready&rdquo; Node is selected as the Gateway, and when the current Gateway Node&rsquo;s status changes to not &ldquo;ready&rdquo;, Antrea will try selecting another &ldquo;ready&rdquo; Node from the candidate Nodes to be the Gateway.</p>
</blockquote>
<p>I will annotate both my worker nodes in both my member clusters, blue and red.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@tkg-bootstrap:~/Kubernetes-library/tkgm/antrea-multicluster$ k annotate node tkg-cluster-2-md-0-qhqgb-58df8c59f4xxb5q8-s7w2z multicluster.antrea.io/gateway<span class="o">=</span><span class="nb">true</span>
</span></span><span class="line"><span class="cl">node/tkg-cluster-2-md-0-qhqgb-58df8c59f4xxb5q8-s7w2z annotated
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## Will repeat this for both nodes in both clusters</span>
</span></span></code></pre></div><p>Then check which node that has been decided in both clusters:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">## tkg cluster 2 - member blue</span>
</span></span><span class="line"><span class="cl">andreasm@tkg-bootstrap:~$ k get gateway -n kube-system
</span></span><span class="line"><span class="cl">NAME                                              GATEWAY IP     INTERNAL IP    AGE
</span></span><span class="line"><span class="cl">tkg-cluster-2-md-0-qhqgb-58df8c59f4xxb5q8-s7w2z   10.101.12.24   10.101.12.24   4m18s
</span></span><span class="line"><span class="cl"><span class="c1">## tkg cluster 3 - member red</span>
</span></span><span class="line"><span class="cl">andreasm@tkg-bootstrap:~$ k get gateway -n kube-system
</span></span><span class="line"><span class="cl">NAME                                              GATEWAY IP     INTERNAL IP    AGE
</span></span><span class="line"><span class="cl">tkg-cluster-3-md-0-82gh2-6dcf989cbcxnc8lc-z5c8g   10.101.12.26   10.101.12.26   116s
</span></span></code></pre></div><p>And the logs from the Antrea MC controller after adding the gateway annotation:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">I0928 09:46:01.599697       <span class="m">1</span> clusterset_controller.go:111<span class="o">]</span> <span class="s2">&#34;Received ClusterSet add/update&#34;</span> <span class="nv">clusterset</span><span class="o">=</span><span class="s2">&#34;kube-system/andreasm-clusterset&#34;</span>
</span></span><span class="line"><span class="cl">I0928 09:46:01.599772       <span class="m">1</span> controller_utils.go:40<span class="o">]</span> <span class="s2">&#34;Validating ClusterClaim&#34;</span> <span class="nv">namespace</span><span class="o">=</span><span class="s2">&#34;kube-system&#34;</span>
</span></span><span class="line"><span class="cl">I0928 09:46:01.701456       <span class="m">1</span> controller_utils.go:52<span class="o">]</span> <span class="s2">&#34;Processing ClusterClaim&#34;</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&#34;id.k8s.io&#34;</span> <span class="nv">value</span><span class="o">=</span><span class="s2">&#34;member-cluster-blue&#34;</span>
</span></span><span class="line"><span class="cl">I0928 09:46:01.701484       <span class="m">1</span> controller_utils.go:52<span class="o">]</span> <span class="s2">&#34;Processing ClusterClaim&#34;</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&#34;clusterset.k8s.io&#34;</span> <span class="nv">value</span><span class="o">=</span><span class="s2">&#34;andreasm-clusterset&#34;</span>
</span></span><span class="line"><span class="cl">I0928 09:46:01.701907       <span class="m">1</span> clusterset_controller.go:204<span class="o">]</span> <span class="s2">&#34;Creating RemoteCommonArea&#34;</span> <span class="nv">cluster</span><span class="o">=</span>tkg-cluster-leader
</span></span><span class="line"><span class="cl">I0928 09:46:02.236829       <span class="m">1</span> remote_common_area.go:111<span class="o">]</span> <span class="s2">&#34;Create a RemoteCommonArea&#34;</span> <span class="nv">cluster</span><span class="o">=</span>tkg-cluster-leader
</span></span><span class="line"><span class="cl">I0928 09:46:02.237004       <span class="m">1</span> clusterset_controller.go:251<span class="o">]</span> <span class="s2">&#34;Created RemoteCommonArea&#34;</span> <span class="nv">cluster</span><span class="o">=</span>tkg-cluster-leader
</span></span><span class="line"><span class="cl">I0928 09:46:02.237064       <span class="m">1</span> remote_common_area.go:293<span class="o">]</span> <span class="s2">&#34;Starting MemberAnnounce to RemoteCommonArea&#34;</span> <span class="nv">cluster</span><span class="o">=</span>tkg-cluster-leader
</span></span><span class="line"><span class="cl">I0928 09:46:02.388473       <span class="m">1</span> remote_common_area.go:236<span class="o">]</span> <span class="s2">&#34;Updating RemoteCommonArea status&#34;</span> <span class="nv">cluster</span><span class="o">=</span>tkg-cluster-leader <span class="nv">connected</span><span class="o">=</span><span class="nb">true</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">I0928 09:49:17.663979       <span class="m">1</span> clusterset_controller.go:111<span class="o">]</span> <span class="s2">&#34;Received ClusterSet add/update&#34;</span> <span class="nv">clusterset</span><span class="o">=</span><span class="s2">&#34;kube-system/andreasm-clusterset&#34;</span>
</span></span><span class="line"><span class="cl">I0928 09:49:17.664066       <span class="m">1</span> controller_utils.go:40<span class="o">]</span> <span class="s2">&#34;Validating ClusterClaim&#34;</span> <span class="nv">namespace</span><span class="o">=</span><span class="s2">&#34;kube-system&#34;</span>
</span></span><span class="line"><span class="cl">I0928 09:49:17.764734       <span class="m">1</span> controller_utils.go:52<span class="o">]</span> <span class="s2">&#34;Processing ClusterClaim&#34;</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&#34;id.k8s.io&#34;</span> <span class="nv">value</span><span class="o">=</span><span class="s2">&#34;member-cluster-red&#34;</span>
</span></span><span class="line"><span class="cl">I0928 09:49:17.764778       <span class="m">1</span> controller_utils.go:52<span class="o">]</span> <span class="s2">&#34;Processing ClusterClaim&#34;</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&#34;clusterset.k8s.io&#34;</span> <span class="nv">value</span><span class="o">=</span><span class="s2">&#34;andreasm-clusterset&#34;</span>
</span></span><span class="line"><span class="cl">I0928 09:49:17.764855       <span class="m">1</span> clusterset_controller.go:204<span class="o">]</span> <span class="s2">&#34;Creating RemoteCommonArea&#34;</span> <span class="nv">cluster</span><span class="o">=</span>tkg-cluster-leader
</span></span><span class="line"><span class="cl">I0928 09:49:18.251398       <span class="m">1</span> remote_common_area.go:111<span class="o">]</span> <span class="s2">&#34;Create a RemoteCommonArea&#34;</span> <span class="nv">cluster</span><span class="o">=</span>tkg-cluster-leader
</span></span><span class="line"><span class="cl">I0928 09:49:18.251475       <span class="m">1</span> clusterset_controller.go:251<span class="o">]</span> <span class="s2">&#34;Created RemoteCommonArea&#34;</span> <span class="nv">cluster</span><span class="o">=</span>tkg-cluster-leader
</span></span><span class="line"><span class="cl">I0928 09:49:18.251588       <span class="m">1</span> remote_common_area.go:293<span class="o">]</span> <span class="s2">&#34;Starting MemberAnnounce to RemoteCommonArea&#34;</span> <span class="nv">cluster</span><span class="o">=</span>tkg-cluster-leader
</span></span><span class="line"><span class="cl">I0928 09:49:18.363564       <span class="m">1</span> remote_common_area.go:236<span class="o">]</span> <span class="s2">&#34;Updating RemoteCommonArea status&#34;</span> <span class="nv">cluster</span><span class="o">=</span>tkg-cluster-leader <span class="nv">connected</span><span class="o">=</span><span class="nb">true</span>
</span></span></code></pre></div><p>Now on both member clusters, they should have received and be aware of their fellow member clusters network information. This can be verified with the following command on both member clusters:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">## member-red - tkg-cluster-3</span>
</span></span><span class="line"><span class="cl">andreasm@tkg-bootstrap:~$ k get clusterinfoimports.multicluster.crd.antrea.io -n kube-system
</span></span><span class="line"><span class="cl">NAME                              CLUSTER ID            SERVICE CIDR    AGE
</span></span><span class="line"><span class="cl">member-cluster-blue-clusterinfo   member-cluster-blue   10.134.0.0/16   69s
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">## member-blue - tkg-cluster-2</span>
</span></span><span class="line"><span class="cl">andreasm@tkg-bootstrap:~$ k get clusterinfoimports.multicluster.crd.antrea.io -n kube-system
</span></span><span class="line"><span class="cl">NAME                             CLUSTER ID           SERVICE CIDR    AGE
</span></span><span class="line"><span class="cl">member-cluster-red-clusterinfo   member-cluster-red   10.136.0.0/16   3m10s
</span></span></code></pre></div><p>Now that Antrea Multi-cluster has been configured, its time to head over to the section on what we can use this for.</p>
<p>This his how my environment looks like now:</p>
<img src=images/image-20230929095322735.png style="width:600px" />
<p>Member cluster blue is exchanging information to member cluster red via the leader cluster using their gateway currently active on worker-node-md-0 in both member clusters.</p>


<h2 class="relative group">Using antctl 
    <div id="using-antctl" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#using-antctl" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>For now I will just link to the GitHub docs of Antrea how to use the <strong>antctl</strong> approach.</p>
<p>For how to use the antctl approach, click <a href="https://github.com/antrea-io/antrea/blob/release-1.11/docs/multicluster/quick-start.md#steps-with-antctl" target="_blank">here</a></p>
<p>To use the <strong>antctl</strong> cli tool download the corresponding Antrea version of antctl <a href="https://github.com/antrea-io/antrea/releases/" target="_blank">here</a></p>


<h2 class="relative group">Multi-cluster Service 
    <div id="multi-cluster-service" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#multi-cluster-service" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>Imagine you have an application that consists of a frontend and a backend. The frontend must run on a dedicated cluster or multiple clusters for scalability, easier exposure, and security posture reasons. The backend services should be running in a more controlled &ldquo;inner&rdquo; cluster. Using Antrea Multi-cluster that is possible. Lets go through how to configure this.</p>
<p>First I will deploy an application called Yelb <a href="https://github.com/mreferre/yelb" target="_blank">source</a>. This consists of a frontend service &ldquo;<em>yelb-ui</em>&ldquo;and three backend applications &ldquo;<em>application, redis and PostgreSQL</em>&rdquo;.</p>
<p>This is how the architecture of Yelb looks like:</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/09/25/antrea-multi-cluster-in-tkg-and-vsphere-with-tanzu/images/image-20230929100641589.png"
        alt="yelb"
      />
      
    </figure>
</p>
<p>I want the <em>yelb-ui</em> to only run in the member cluster blue, and I want all the backends to run in the member cluster red. Like this:</p>
<img src=images/image-20230928121935733.png style="width:600px" />
<p>I will start with deploying the backend part of the Yelb application in my member cluster red:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">## Backend pods running in member-red</span>
</span></span><span class="line"><span class="cl">andreasm@tkg-bootstrap:~$ k get pods -n yelb -o wide
</span></span><span class="line"><span class="cl">NAME                              READY   STATUS    RESTARTS   AGE     IP             NODE                                              NOMINATED NODE   READINESS GATES
</span></span><span class="line"><span class="cl">redis-server-56d97cc8c-dzbg7      1/1     Running   <span class="m">0</span>          5m38s   100.10.2.157   tkg-cluster-3-md-0-82gh2-6dcf989cbcxnc8lc-z5c8g   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">yelb-appserver-65855b7ffd-nggg9   1/1     Running   <span class="m">0</span>          5m36s   100.10.2.159   tkg-cluster-3-md-0-82gh2-6dcf989cbcxnc8lc-z5c8g   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">yelb-db-6f78dc6f8f-5dgpv          1/1     Running   <span class="m">0</span>          5m37s   100.10.2.158   tkg-cluster-3-md-0-82gh2-6dcf989cbcxnc8lc-z5c8g   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl"><span class="c1">## Backend services running in member-red</span>
</span></span><span class="line"><span class="cl">andreasm@tkg-bootstrap:~$ k get svc -n yelb
</span></span><span class="line"><span class="cl">NAME             TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>    AGE
</span></span><span class="line"><span class="cl">redis-server     ClusterIP   100.20.176.130   &lt;none&gt;        6379/TCP   2m29s
</span></span><span class="line"><span class="cl">yelb-appserver   ClusterIP   100.20.111.133   &lt;none&gt;        4567/TCP   2m27s
</span></span><span class="line"><span class="cl">yelb-db          ClusterIP   100.20.7.160     &lt;none&gt;        5432/TCP   2m28s
</span></span></code></pre></div><p>Now I will deploy the frontend service in the member cluster blue</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@tkg-bootstrap:~$ k get pods -n yelb
</span></span><span class="line"><span class="cl">NAME                       READY   STATUS             RESTARTS      AGE
</span></span><span class="line"><span class="cl">yelb-ui-5c5b8d8887-wkchd   0/1     CrashLoopBackOff   <span class="m">3</span> <span class="o">(</span>20s ago<span class="o">)</span>   2m49s
</span></span></code></pre></div><p>its deployed, but not running. It cant reach the backend service <strong>yelb-appserver</strong> as this is running on a completely different cluster.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@tkg-bootstrap:~$ k logs -n yelb yelb-ui-7bc645756b-qmtbp
</span></span><span class="line"><span class="cl">2023/09/29 06:16:17 <span class="o">[</span>emerg<span class="o">]</span> 10#10: host not found in upstream <span class="s2">&#34;antrea-mc-yelb-appserver&#34;</span> in /etc/nginx/conf.d/default.conf:5
</span></span><span class="line"><span class="cl">nginx: <span class="o">[</span>emerg<span class="o">]</span> host not found in upstream <span class="s2">&#34;antrea-mc-yelb-appserver&#34;</span> in /etc/nginx/conf.d/default.conf:5
</span></span></code></pre></div><p>Its also red in my NSX-ALB environment.</p>
<img src=images/image-20230928123452397.png style="width:500px" />
<p>Now I will export the <strong>yelb-appserver</strong> service using Antrea Multi-cluster Service, so any pods running in member-blue can also use this service running on member-red. For the Yelb UI to work it needs to talk to the appserver service (yelb-appserver).</p>
<p>From the source, where the yelb-appserver service is defined locally and running, I need to define a ServiceExport which is just using the name of the original service and the namespace where the service is located:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">multicluster.x-k8s.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ServiceExport</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">yelb-appserver</span><span class="w"> </span><span class="c">## name of service you want to export</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">yelb</span><span class="w"> </span><span class="c">## namespace of the service</span><span class="w">
</span></span></span></code></pre></div><p>Apply it</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@tkg-bootstrap:~$ k apply -f yelb-app-service-export.yaml
</span></span><span class="line"><span class="cl">serviceexport.multicluster.x-k8s.io/yelb-appserver created
</span></span></code></pre></div><p>From the leader-cluster I can check all the resourceexports and resourceimports:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@tkg-bootstrap:~$ k get resourceexports.multicluster.crd.antrea.io -n antrea-multicluster
</span></span><span class="line"><span class="cl">NAME                                               CLUSTER ID            KIND          NAMESPACE     NAME                  AGE
</span></span><span class="line"><span class="cl">member-cluster-blue-clusterinfo                    member-cluster-blue   ClusterInfo   kube-system   member-cluster-blue   53m
</span></span><span class="line"><span class="cl">member-cluster-red-clusterinfo                     member-cluster-red    ClusterInfo   kube-system   member-cluster-red    51m
</span></span><span class="line"><span class="cl">member-cluster-red-yelb-yelb-appserver-endpoints   member-cluster-red    Endpoints     yelb          yelb-appserver        2m59s
</span></span><span class="line"><span class="cl">member-cluster-red-yelb-yelb-appserver-service     member-cluster-red    Service       yelb          yelb-appserver        2m59s
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@tkg-bootstrap:~$ k get resourceimports.multicluster.crd.antrea.io -n antrea-multicluster
</span></span><span class="line"><span class="cl">NAME                              KIND            NAMESPACE             NAME                              AGE
</span></span><span class="line"><span class="cl">member-cluster-blue-clusterinfo   ClusterInfo     antrea-multicluster   member-cluster-blue-clusterinfo   55m
</span></span><span class="line"><span class="cl">member-cluster-red-clusterinfo    ClusterInfo     antrea-multicluster   member-cluster-red-clusterinfo    53m
</span></span><span class="line"><span class="cl">yelb-yelb-appserver-endpoints     Endpoints       yelb                  yelb-appserver                    4m41s
</span></span><span class="line"><span class="cl">yelb-yelb-appserver-service       ServiceImport   yelb                  yelb-appserver                    4m41s
</span></span></code></pre></div><p>So my <strong>yelb-appserver</strong> service has been exported.</p>
<p>What happens now in my member cluster blue? For the service to be imported into my member blue cluster it needs to have the namespace <strong>yelb</strong> created, otherwise it will not be imported. I have the ns yelb created as the yelb-ui is already deployed in this namespace. In my member cluster blue I can now see that I have the service <strong>yelb-appserver</strong> imported. Its there. Yay.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@tkg-bootstrap:~$ k get serviceimports.multicluster.x-k8s.io -A
</span></span><span class="line"><span class="cl">NAMESPACE   NAME             TYPE           IP                   AGE
</span></span><span class="line"><span class="cl">yelb        yelb-appserver   ClusterSetIP   <span class="o">[</span><span class="s2">&#34;100.40.224.145&#34;</span><span class="o">]</span>   15m
</span></span><span class="line"><span class="cl">andreasm@tkg-bootstrap:~$ k get serviceimports.multicluster.x-k8s.io -n yelb
</span></span><span class="line"><span class="cl">NAME             TYPE           IP                   AGE
</span></span><span class="line"><span class="cl">yelb-appserver   ClusterSetIP   <span class="o">[</span><span class="s2">&#34;100.40.224.145&#34;</span><span class="o">]</span>   17m
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@tkg-bootstrap:~$ k get svc -n yelb
</span></span><span class="line"><span class="cl">NAME                       TYPE           CLUSTER-IP       EXTERNAL-IP      PORT<span class="o">(</span>S<span class="o">)</span>        AGE
</span></span><span class="line"><span class="cl">antrea-mc-yelb-appserver   ClusterIP      100.40.224.145   &lt;none&gt;           4567/TCP       19m
</span></span><span class="line"><span class="cl">yelb-ui                    LoadBalancer   100.40.136.62    10.101.115.100   80:30425/TCP   26m
</span></span></code></pre></div><p>Will my yelb-ui pod figure this out then?</p>
<p>The yelb-ui pod is running:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">amarqvardsen@amarqvards1MD6T:~/Kubernetes-library/tkgm/antrea-multicluster/yelb$ k get pods -n yelb
</span></span><span class="line"><span class="cl">NAME                       READY   STATUS    RESTARTS       AGE
</span></span><span class="line"><span class="cl">yelb-ui-5c5b8d8887-wkchd   1/1     Running   <span class="m">5</span> <span class="o">(</span>5m5s ago<span class="o">)</span>   8m17s
</span></span></code></pre></div><p>The VS is green:</p>
<img src=images/image-20230928144110457.png style="width:600px" />
<p>And inside the application itself I can also see the app server it is currently using:</p>
<img src=images/image-20230929101557537.png style="width:500px" />
<p>And doing a quick sanity check. Where are my pods running.
The yelb-ui pod is running in member cluster blue:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">NAME                       READY   STATUS    RESTARTS       AGE    IP            NODE                                              NOMINATED NODE   READINESS GATES
</span></span><span class="line"><span class="cl">yelb-ui-7bc645756b-qmtbp   1/1     Running   <span class="m">5</span> <span class="o">(</span>121m ago<span class="o">)</span>   124m   10.133.1.56   tkg-cluster-2-md-1-wmxhd-5998fcf669x64b9h-z7mnw   &lt;none&gt;           &lt;none&gt;
</span></span></code></pre></div><p>And the appserver pod is running:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">NAME                             READY   STATUS    RESTARTS   AGE    IP            NODE                                              NOMINATED NODE   READINESS GATES
</span></span><span class="line"><span class="cl">redis-server-56d97cc8c-wvc4q     1/1     Running   <span class="m">0</span>          126m   10.135.1.53   tkg-cluster-3-md-1-824bx-5bdb559f7bxqgbb8-bqwnr   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">yelb-appserver-d9ddcdd97-z8gt9   1/1     Running   <span class="m">0</span>          126m   10.135.1.55   tkg-cluster-3-md-1-824bx-5bdb559f7bxqgbb8-bqwnr   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">yelb-db-749c784cb8-f6wx8         1/1     Running   <span class="m">0</span>          126m   10.135.1.54   tkg-cluster-3-md-1-824bx-5bdb559f7bxqgbb8-bqwnr   &lt;none&gt;           &lt;none&gt;
</span></span></code></pre></div><p>Notice the name from the ui of the app above on the name of the pod listed. Its the same pod.</p>


<h3 class="relative group">Recap of Multi-cluster service. 
    <div id="recap-of-multi-cluster-service" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#recap-of-multi-cluster-service" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<ul>
<li>In member cluster red I deployed the three backends needed for the Yelb application. These consists of 3 PODs and their corresponding services. As of now they are just local and accessible internally in the same k8s cluster.</li>
</ul>
<img src=images/image-20230929083246372.png style="width:300px" />
<ul>
<li>In member cluster blue I deployed the Yelb UI service, in a CrashLoopBackOff as it cant reach the necessary appserver service.</li>
</ul>
<img src=images/image-20230929102300345.png style="width:300px" />
<ul>
<li>Then I exported the <strong>yelb-appserver</strong> using Antrea Multi-cluster Services</li>
</ul>
<img src=images/image-20230929102744189.png style="width:600px" />
<p>And the Yelb application lived happily ever after &#x1f192;</p>


<h3 class="relative group">Quick troubleshooting 
    <div id="quick-troubleshooting" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#quick-troubleshooting" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>Just to add an easy way to verify the exported services work. I deployed a simple nginx pod in member cluster red. Exported the nginx ClusterIP service, from my member cluster blue I have deployed a Ubuntu pod. From this pod I will do a curl to the exported nginx service to see if I can reach it and if it works.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">## nginx pod running in member cluster red</span>
</span></span><span class="line"><span class="cl">NAME                        READY   STATUS    RESTARTS   AGE    IP            NODE                                              NOMINATED NODE   READINESS GATES
</span></span><span class="line"><span class="cl">nginx-ui-59c956b95b-qhz8n   1/1     Running   <span class="m">0</span>          151m   10.135.1.56   tkg-cluster-3-md-1-824bx-5bdb559f7bxqgbb8-bqwnr   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl"><span class="c1">## nginx local clusterip service</span>
</span></span><span class="line"><span class="cl">NAME              TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>   AGE
</span></span><span class="line"><span class="cl">nginx             ClusterIP   10.136.40.246    &lt;none&gt;        80/TCP    152m
</span></span><span class="line"><span class="cl"><span class="c1">## the exported nginx service in my member cluster blue</span>
</span></span><span class="line"><span class="cl">NAME              TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>   AGE
</span></span><span class="line"><span class="cl">antrea-mc-nginx   ClusterIP   10.134.30.220   &lt;none&gt;        80/TCP    147m
</span></span><span class="line"><span class="cl"><span class="c1">## from my ubuntu pod in member cluster blue</span>
</span></span><span class="line"><span class="cl">root@ubuntu-20-04-cbb58d77-tcrjb:/# nslookup 10.134.30.220
</span></span><span class="line"><span class="cl">220.30.134.10.in-addr.arpa	<span class="nv">name</span> <span class="o">=</span> antrea-mc-nginx.nginx.svc.cluster.local.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## curl the dns name</span>
</span></span><span class="line"><span class="cl">root@ubuntu-20-04-cbb58d77-tcrjb:/# curl http://antrea-mc-nginx.nginx.svc.cluster.local
</span></span><span class="line"><span class="cl">&lt;!DOCTYPE html&gt;
</span></span><span class="line"><span class="cl">&lt;html&gt;
</span></span><span class="line"><span class="cl">&lt;head&gt;
</span></span><span class="line"><span class="cl">&lt;title&gt;Welcome to nginx!&lt;/title&gt;
</span></span><span class="line"><span class="cl">&lt;style&gt;
</span></span><span class="line"><span class="cl">html <span class="o">{</span> color-scheme: light dark<span class="p">;</span> <span class="o">}</span>
</span></span><span class="line"><span class="cl">body <span class="o">{</span> width: 35em<span class="p">;</span> margin: <span class="m">0</span> auto<span class="p">;</span>
</span></span><span class="line"><span class="cl">font-family: Tahoma, Verdana, Arial, sans-serif<span class="p">;</span> <span class="o">}</span>
</span></span><span class="line"><span class="cl">&lt;/style&gt;
</span></span><span class="line"><span class="cl">&lt;/head&gt;
</span></span><span class="line"><span class="cl">&lt;body&gt;
</span></span><span class="line"><span class="cl">&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;
</span></span><span class="line"><span class="cl">&lt;p&gt;If you see this page, the nginx web server is successfully installed and
</span></span><span class="line"><span class="cl">working. Further configuration is required.&lt;/p&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;p&gt;For online documentation and support please refer to
</span></span><span class="line"><span class="cl">&lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&#34;http://nginx.org/&#34;</span>&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;
</span></span><span class="line"><span class="cl">Commercial support is available at
</span></span><span class="line"><span class="cl">&lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&#34;http://nginx.com/&#34;</span>&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;p&gt;&lt;em&gt;Thank you <span class="k">for</span> using nginx.&lt;/em&gt;&lt;/p&gt;
</span></span><span class="line"><span class="cl">&lt;/body&gt;
</span></span><span class="line"><span class="cl">&lt;/html&gt;
</span></span></code></pre></div>

<h3 class="relative group">Failure scenario 
    <div id="failure-scenario" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#failure-scenario" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>What happens if a node which currently holds the active gateway goes down?</p>
<img src=images/image-20230930211539280.png style="width:600px" />
<p>Lets test that. Currently these are my active gateways in member-cluster-blue and red respectively:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">## get the current gateway in member-cluster blue</span>
</span></span><span class="line"><span class="cl">k get gateway -A
</span></span><span class="line"><span class="cl">NAMESPACE     NAME                                             GATEWAY IP     INTERNAL IP    AGE
</span></span><span class="line"><span class="cl">kube-system   tkg-cluster-2-md-0-vrt25-7f44f4798xqbk9h-tc979   10.101.12.14   10.101.12.14   37h
</span></span><span class="line"><span class="cl"><span class="c1">## list all nodes in my member-cluster blue</span>
</span></span><span class="line"><span class="cl">k get nodes -owide
</span></span><span class="line"><span class="cl">NAME                                              STATUS   ROLES           AGE   VERSION            INTERNAL-IP    EXTERNAL-IP    OS-IMAGE             KERNEL-VERSION      CONTAINER-RUNTIME
</span></span><span class="line"><span class="cl">tkg-cluster-2-md-0-vrt25-7f44f4798xqbk9h-tc979    Ready    &lt;none&gt;          46h   v1.26.5+vmware.2   10.101.12.14   10.101.12.14   Ubuntu 20.04.6 LTS   5.4.0-152-generic   containerd://1.6.18-1-gdbc99e5b1
</span></span><span class="line"><span class="cl">tkg-cluster-2-md-1-wmxhd-5998fcf669x64b9h-z7mnw   Ready    &lt;none&gt;          46h   v1.26.5+vmware.2   10.101.12.13   10.101.12.13   Ubuntu 20.04.6 LTS   5.4.0-152-generic   containerd://1.6.18-1-gdbc99e5b1
</span></span><span class="line"><span class="cl">tkg-cluster-2-x2fqj-fxswx                         Ready    control-plane   46h   v1.26.5+vmware.2   10.101.12.33   10.101.12.33   Ubuntu 20.04.6 LTS   5.4.0-152-generic   containerd://1.6.18-1-gdbc99e5b1
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">## get the current gateway in member-cluster red</span>
</span></span><span class="line"><span class="cl">k get gateway -A
</span></span><span class="line"><span class="cl">NAMESPACE     NAME                                             GATEWAY IP     INTERNAL IP    AGE
</span></span><span class="line"><span class="cl">kube-system   tkg-cluster-3-md-0-h5ppw-9db445579xq45bn-nsq98   10.101.12.38   10.101.12.38   37h
</span></span><span class="line"><span class="cl"><span class="c1">## list all nodes in my member-cluster red</span>
</span></span><span class="line"><span class="cl">k get nodes -o wide
</span></span><span class="line"><span class="cl">NAME                                              STATUS   ROLES           AGE   VERSION            INTERNAL-IP    EXTERNAL-IP    OS-IMAGE             KERNEL-VERSION      CONTAINER-RUNTIME
</span></span><span class="line"><span class="cl">tkg-cluster-3-krrwq-p588j                         Ready    control-plane   46h   v1.26.5+vmware.2   10.101.12.28   10.101.12.28   Ubuntu 20.04.6 LTS   5.4.0-152-generic   containerd://1.6.18-1-gdbc99e5b1
</span></span><span class="line"><span class="cl">tkg-cluster-3-md-0-h5ppw-9db445579xq45bn-nsq98    Ready    &lt;none&gt;          46h   v1.26.5+vmware.2   10.101.12.38   10.101.12.38   Ubuntu 20.04.6 LTS   5.4.0-152-generic   containerd://1.6.18-1-gdbc99e5b1
</span></span><span class="line"><span class="cl">tkg-cluster-3-md-1-824bx-5bdb559f7bxqgbb8-bqwnr   Ready    &lt;none&gt;          46h   v1.26.5+vmware.2   10.101.12.17   10.101.12.17   Ubuntu 20.04.6 LTS   5.4.0-152-generic   containerd://1.6.18-1-gdbc99e5b1
</span></span></code></pre></div><p>Now I will shutdown the node that currently is the active gateway in my member-cluster blue. I will from my vCenter just do a &ldquo;Power off&rdquo; operation.</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/09/25/antrea-multi-cluster-in-tkg-and-vsphere-with-tanzu/images/image-20230930212321484.png"
        alt="power-off-gateway-node"
      />
      
    </figure>
</p>
<p>And I will even delete it..</p>
<img src=images/image-20230930213558665.png style="width:600px" />
<p>Remember I annotated my two nodes as potential Gateway candidates?</p>
<p>Well look what happened after my active gateway disappeared. It selects the next available candidate automatically. Gateway up again and all services up.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">k get gateway -A
</span></span><span class="line"><span class="cl">NAMESPACE     NAME                                              GATEWAY IP     INTERNAL IP    AGE
</span></span><span class="line"><span class="cl">kube-system   tkg-cluster-2-md-1-wmxhd-5998fcf669x64b9h-z7mnw   10.101.12.13   10.101.12.13   37s
</span></span></code></pre></div><img src=images/image-20231001090655900.png style="width:600px" />
<p>The deleted node will be taken care of by TKG and recreated.</p>


<h2 class="relative group">Routing pod traffic through Multi-cluster Gateways 
    <div id="routing-pod-traffic-through-multi-cluster-gateways" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#routing-pod-traffic-through-multi-cluster-gateways" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>Next neat feature of Antrea Multi-cluster is the ability to allow pods from the different member clusters to reach each other on their respective pod IP addresses. Say I have POD-A running in member-cluster blue and are depending on connecting to POD-B running in member-cluster red. To achieve this a couple of steps is needed to be configured.</p>
<ul>
<li>The agent.conf Feature Gate <strong>enablePodToPodConnectivity: true</strong> must be set to <strong>true</strong> (This is already done as explained in the initial chapter)</li>
<li>Need to configure the <strong>antrea-mc-controller</strong> configMap</li>
</ul>
<p>There are two ways to edit the <strong>antrea-mc-controller</strong> configmap, edit the yaml antrea-multicluster-member.yml that was used to install the antrea-mc-controller in the member clusters or edit the configMap antrea-mc-controller-config directly in the ns kube-system. I will edit it directly and the only thing that needs to be added is the cluster configured pod CIDR.</p>
<div class="notice info">
<p>If editing directly, one have to restart the pod <strong>antrea-mc-controller</strong> for it to read the new configMap.</p>
<p>The POD CIDRS between the clusters can NOT overlap</p>
</div>
<p>Editing the configMap</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c">## member-cluster-blue (tkg-cluster-2)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">## Get the pod or cluster cidr of the cluster you are editing the configMap</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">k cluster-info dump | grep -m 1 cluster-cidr</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="s2">&#34;--cluster-cidr=10.133.0.0/16&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">## edit the configmap</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">k edit configmaps -n kube-system antrea-mc-controller-config</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">## the configmap</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># Please edit the object below. Lines beginning with a &#39;#&#39; will be ignored,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># and an empty file will abort the edit. If an error occurs while saving this file will be</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># reopened with the relevant failures.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">controller_manager_config.yaml</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">    apiVersion: multicluster.crd.antrea.io/v1alpha1
</span></span></span><span class="line"><span class="cl"><span class="sd">    kind: MultiClusterConfig
</span></span></span><span class="line"><span class="cl"><span class="sd">    health:
</span></span></span><span class="line"><span class="cl"><span class="sd">      healthProbeBindAddress: :8080
</span></span></span><span class="line"><span class="cl"><span class="sd">    metrics:
</span></span></span><span class="line"><span class="cl"><span class="sd">      bindAddress: &#34;0&#34;
</span></span></span><span class="line"><span class="cl"><span class="sd">    webhook:
</span></span></span><span class="line"><span class="cl"><span class="sd">      port: 9443
</span></span></span><span class="line"><span class="cl"><span class="sd">    leaderElection:
</span></span></span><span class="line"><span class="cl"><span class="sd">      leaderElect: false
</span></span></span><span class="line"><span class="cl"><span class="sd">    serviceCIDR: &#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="sd">    podCIDRs:
</span></span></span><span class="line"><span class="cl"><span class="sd">      - &#34;10.133.0.0/16&#34;  ## Add the cidr here from the range above
</span></span></span><span class="line"><span class="cl"><span class="sd">    gatewayIPPrecedence: &#34;private&#34;
</span></span></span><span class="line"><span class="cl"><span class="sd">    endpointIPType: &#34;ClusterIP&#34;
</span></span></span><span class="line"><span class="cl"><span class="sd">    enableStretchedNetworkPolicy: false</span><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">kubectl.kubernetes.io/last-applied-configuration</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">      {&#34;apiVersion&#34;:&#34;v1&#34;,&#34;data&#34;:{&#34;controller_manager_config.yaml&#34;:&#34;apiVersion: multicluster.crd.antrea.io/v1alpha1\nkind: MultiClusterConfig\nhealth:\n  healthProbeBindAddress: :8080\nmetrics:\n  bindAddress: \&#34;0\&#34;\nwebhook:\n  port: 9443\nleaderElection:\n  leaderElect: false\nserviceCIDR: \&#34;\&#34;\npodCIDRs:\n  - \&#34;\&#34;\ngatewayIPPrecedence: \&#34;private\&#34;\nendpointIPType: \&#34;ClusterIP\&#34;\nenableStretchedNetworkPolicy: false\n&#34;},&#34;kind&#34;:&#34;ConfigMap&#34;,&#34;metadata&#34;:{&#34;annotations&#34;:{},&#34;labels&#34;:{&#34;app&#34;:&#34;antrea&#34;},&#34;name&#34;:&#34;antrea-mc-controller-config&#34;,&#34;namespace&#34;:&#34;kube-system&#34;}}</span><span class="w">      
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2023-09-29T05:57:12Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">antrea</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">antrea-mc-controller-config</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-system</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resourceVersion</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;98622&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">uid</span><span class="p">:</span><span class="w"> </span><span class="l">fd760052-a18e-4623-b217-d9b96ae36cac</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c">## :wq</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">configmap/antrea-mc-controller-config edited</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span></code></pre></div><p>Restart antrea-mc-controller pod</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">k delete pod -n kube-system antrea-mc-controller-5bb945f87f-nfd97
</span></span><span class="line"><span class="cl">pod <span class="s2">&#34;antrea-mc-controller-5bb945f87f-nfd97&#34;</span> deleted
</span></span></code></pre></div><p>Repeat on the other clusters</p>
<p>Now testing time</p>
<p>I have a pod running in member-cluster red (tkg-cluster-3) with the following IP:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">NAME                          READY   STATUS    RESTARTS   AGE     IP            NODE                                              NOMINATED NODE   READINESS GATES
</span></span><span class="line"><span class="cl">ubuntu-20-04-cbb58d77-l25zv   1/1     Running   <span class="m">0</span>          5h18m   10.135.1.58   tkg-cluster-3-md-1-824bx-5bdb559f7bxqgbb8-bqwnr   &lt;none&gt;           &lt;none&gt;
</span></span></code></pre></div><p>I also have another POD running in my member-cluster blue with this information:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">NAME                          READY   STATUS    RESTARTS   AGE     IP            NODE                                              NOMINATED NODE   READINESS GATES
</span></span><span class="line"><span class="cl">ubuntu-20-04-cbb58d77-tcrjb   1/1     Running   <span class="m">0</span>          5h24m   10.133.1.57   tkg-cluster-2-md-1-wmxhd-5998fcf669x64b9h-z7mnw   &lt;none&gt;           &lt;none&gt;
</span></span></code></pre></div><p>Now I will execute into the last pod and do a ping to the pod in member-cluster red using the POD IP.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root@ubuntu-20-04-cbb58d77-tcrjb:/# ping 10.135.1.58
</span></span><span class="line"><span class="cl">PING 10.135.1.58 <span class="o">(</span>10.135.1.58<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
</span></span></code></pre></div><p>On the destination pod I have started tcpdump to listen on icmp, and on the screenshot below I have the ping from the source on the left side to the destination on the right. Notice the IP addresses being reported by tcpdump in the destination pod.</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/09/25/antrea-multi-cluster-in-tkg-and-vsphere-with-tanzu/images/image-20230929134237713.png"
        alt="src-dst-ping"
      />
      
    </figure>
</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root@ubuntu-20-04-cbb58d77-l25zv:/# tcpdump -i eth0 icmp
</span></span><span class="line"><span class="cl">tcpdump: verbose output suppressed, use -v or -vv <span class="k">for</span> full protocol decode
</span></span><span class="line"><span class="cl">listening on eth0, link-type EN10MB <span class="o">(</span>Ethernet<span class="o">)</span>, capture size <span class="m">262144</span> bytes
</span></span><span class="line"><span class="cl">11:41:44.577683 IP 10.101.12.14 &gt; ubuntu-20-04-cbb58d77-l25zv: ICMP <span class="nb">echo</span> request, id 4455, seq 1, length <span class="m">64</span>
</span></span><span class="line"><span class="cl">11:41:44.577897 IP ubuntu-20-04-cbb58d77-l25zv &gt; 10.101.12.14: ICMP <span class="nb">echo</span> reply, id 4455, seq 1, length <span class="m">64</span>
</span></span><span class="line"><span class="cl">11:41:45.577012 IP 10.101.12.14 &gt; ubuntu-20-04-cbb58d77-l25zv: ICMP <span class="nb">echo</span> request, id 4455, seq 2, length <span class="m">64</span>
</span></span><span class="line"><span class="cl">11:41:45.577072 IP ubuntu-20-04-cbb58d77-l25zv &gt; 10.101.12.14: ICMP <span class="nb">echo</span> reply, id 4455, seq 2, length <span class="m">64</span>
</span></span><span class="line"><span class="cl">11:41:46.577099 IP 10.101.12.14 &gt; ubuntu-20-04-cbb58d77-l25zv: ICMP <span class="nb">echo</span> request, id 4455, seq 3, length <span class="m">64</span>
</span></span><span class="line"><span class="cl">11:41:46.577144 IP ubuntu-20-04-cbb58d77-l25zv &gt; 10.101.12.14: ICMP <span class="nb">echo</span> reply, id 4455, seq 3, length <span class="m">64</span>
</span></span><span class="line"><span class="cl">11:41:47.579227 IP 10.101.12.14 &gt; ubuntu-20-04-cbb58d77-l25zv: ICMP <span class="nb">echo</span> request, id 4455, seq 4, length <span class="m">64</span>
</span></span><span class="line"><span class="cl">11:41:47.579256 IP ubuntu-20-04-cbb58d77-l25zv &gt; 10.101.12.14: ICMP <span class="nb">echo</span> reply, id 4455, seq 4, length <span class="m">64</span>
</span></span><span class="line"><span class="cl">11:41:48.580607 IP 10.101.12.14 &gt; ubuntu-20-04-cbb58d77-l25zv: ICMP <span class="nb">echo</span> request, id 4455, seq 5, length <span class="m">64</span>
</span></span><span class="line"><span class="cl">11:41:48.580632 IP ubuntu-20-04-cbb58d77-l25zv &gt; 10.101.12.14: ICMP <span class="nb">echo</span> reply, id 4455, seq 5, length <span class="m">64</span>
</span></span><span class="line"><span class="cl">11:41:49.581900 IP 10.101.12.14 &gt; ubuntu-20-04-cbb58d77-l25zv: ICMP <span class="nb">echo</span> request, id 4455, seq 6, length <span class="m">64</span>
</span></span></code></pre></div><p>The source IP address here is the gateway IP from the source member-cluster:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@tkg-bootstrap:~$ k get gateway -A
</span></span><span class="line"><span class="cl">NAMESPACE     NAME                                             GATEWAY IP     INTERNAL IP    AGE
</span></span><span class="line"><span class="cl">kube-system   tkg-cluster-2-md-0-vrt25-7f44f4798xqbk9h-tc979   10.101.12.14   10.101.12.14   5h37m
</span></span></code></pre></div><p>And if I do the same operation just change the direction:</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/09/25/antrea-multi-cluster-in-tkg-and-vsphere-with-tanzu/images/image-20230929134901157.png"
        alt="src-right-dst-left"
      />
      
    </figure>
</p>
<p>The source IP is the gateway IP from the source cluster:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">NAMESPACE     NAME                                             GATEWAY IP     INTERNAL IP    AGE
</span></span><span class="line"><span class="cl">kube-system   tkg-cluster-3-md-0-h5ppw-9db445579xq45bn-nsq98   10.101.12.38   10.101.12.38   5h41m
</span></span></code></pre></div><p>Using antctl traceflow:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@tkg-bootstrap:~$ antctl traceflow -S prod/ubuntu-20-04-cbb58d77-tcrjb -D 10.135.1.58
</span></span><span class="line"><span class="cl">name: prod-ubuntu-20-04-cbb58d77-tcrjb-to-10.135.1.58-5b8l7ms8
</span></span><span class="line"><span class="cl">phase: Running
</span></span><span class="line"><span class="cl">source: prod/ubuntu-20-04-cbb58d77-tcrjb
</span></span><span class="line"><span class="cl">destination: 10.135.1.58
</span></span><span class="line"><span class="cl">results:
</span></span><span class="line"><span class="cl">- node: tkg-cluster-2-md-1-wmxhd-5998fcf669x64b9h-z7mnw
</span></span><span class="line"><span class="cl">  timestamp: <span class="m">1696064979</span>
</span></span><span class="line"><span class="cl">  observations:
</span></span><span class="line"><span class="cl">  - component: SpoofGuard
</span></span><span class="line"><span class="cl">    action: Forwarded
</span></span><span class="line"><span class="cl">  - component: Forwarding
</span></span><span class="line"><span class="cl">    componentInfo: Output
</span></span><span class="line"><span class="cl">    action: Forwarded
</span></span><span class="line"><span class="cl">    tunnelDstIP: 10.101.12.14
</span></span><span class="line"><span class="cl">Error: timeout waiting <span class="k">for</span> Traceflow <span class="k">done</span>
</span></span></code></pre></div><p>I know it is forwarded and delivered as I can see it on the destination pod using tcpdump while doing the traceflow:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root@ubuntu-20-04-cbb58d77-l25zv:/# tcpdump -i eth0 icmp
</span></span><span class="line"><span class="cl">tcpdump: verbose output suppressed, use -v or -vv <span class="k">for</span> full protocol decode
</span></span><span class="line"><span class="cl">listening on eth0, link-type EN10MB <span class="o">(</span>Ethernet<span class="o">)</span>, capture size <span class="m">262144</span> bytes
</span></span><span class="line"><span class="cl">09:09:39.161140 IP 10.101.12.14 &gt; ubuntu-20-04-cbb58d77-l25zv: ICMP <span class="nb">echo</span> request, id 0, seq 0, length <span class="m">8</span>
</span></span><span class="line"><span class="cl">09:09:39.161411 IP ubuntu-20-04-cbb58d77-l25zv &gt; 10.101.12.14: ICMP <span class="nb">echo</span> reply, id 0, seq 0, length <span class="m">8</span>
</span></span></code></pre></div><p>Next up is how Antrea Policies can be used with Antrea Multi-cluster</p>


<h2 class="relative group">Multi-cluster NetworkPolicy (ANP and ACNP) 
    <div id="multi-cluster-networkpolicy-anp-and-acnp" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#multi-cluster-networkpolicy-anp-and-acnp" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>This feature is about the possibility to create policies using ClusterSet objects as selector for ingress or egress, like exported Multi-cluster services or namespaces across the clusters in a ClusterSet. For this to work the <strong>enableStretchedNetworkPolicy</strong> Feature Gate must be set to true on both controller.conf and agent.conf. I already enabled this at cluster provisioning, but to check take a look at the antrea-config configMap:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="l">andreasm@tkg-bootstrap:~$ k get configmaps -n kube-system antrea-config -oyaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">antrea-agent.conf</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">    featureGates:
</span></span></span><span class="line"><span class="cl"><span class="sd">      Multicluster: true
</span></span></span><span class="line"><span class="cl"><span class="sd">    multicluster:
</span></span></span><span class="line"><span class="cl"><span class="sd">      enableGateway: true
</span></span></span><span class="line"><span class="cl"><span class="sd">      enableStretchedNetworkPolicy: true
</span></span></span><span class="line"><span class="cl"><span class="sd">      enablePodToPodConnectivity: true</span><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">antrea-controller.conf</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">    featureGates: 
</span></span></span><span class="line"><span class="cl"><span class="sd">      Multicluster: true
</span></span></span><span class="line"><span class="cl"><span class="sd">    multicluster:
</span></span></span><span class="line"><span class="cl"><span class="sd">      enableStretchedNetworkPolicy: true</span><span class="w">    
</span></span></span></code></pre></div><p>Following the GitHub <a href="https://github.com/antrea-io/antrea/blob/release-1.11/docs/multicluster/user-guide.md#multi-cluster-networkpolicy" target="_blank">docs</a> I will use the examples there to make some policies and demonstrate them.</p>
<p>Starting with the first example, an egress rule to a Multi-cluster service.</p>
<p><strong>Egress rule to Multi-cluster service</strong></p>
<p>Below is an example taken from the official docs creating a policy that will <strong>Drop</strong> traffic to a specific Multi-cluster service from a specific pod using label selector (adjusted to fit my environment):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">crd.antrea.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterNetworkPolicy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">acnp-drop-ubuntu-pod-to-nginx-mc-service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">priority</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">tier</span><span class="p">:</span><span class="w"> </span><span class="l">securityops</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">appliedTo</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">podSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">role</span><span class="p">:</span><span class="w"> </span><span class="kc">no</span>-<span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">egress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Drop</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">toServices</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx  </span><span class="w"> </span><span class="c"># an exported Multi-cluster Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">scope</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterSet</span><span class="w">
</span></span></span></code></pre></div><p>I will now apply it on the member-cluster-blue, where my source test pod Ubuntu is running. I can also apply it on the source cluster where service originates from and it will have the same effect:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">k apply -f egress-nginx-mc.yaml
</span></span><span class="line"><span class="cl">clusternetworkpolicy.crd.antrea.io/acnp-drop-ubuntu-pod-to-nginx-mc-service created
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">k get acnp
</span></span><span class="line"><span class="cl">NAME                                       TIER          PRIORITY   DESIRED NODES   CURRENT NODES   AGE
</span></span><span class="line"><span class="cl">acnp-drop-ubuntu-pod-to-nginx-mc-service   securityops   <span class="m">1</span>          <span class="m">0</span>               <span class="m">0</span>               32s
</span></span></code></pre></div><p>Its applied, but not in effect as I dont have the correct labels applied yet on my test pod.</p>
<p>So from my Ubuntu test pod, I can still reach the service nginx. But I will now label the pod according to the yaml above.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">k label pod -n prod ubuntu-20-04-cbb58d77-tcrjb <span class="nv">role</span><span class="o">=</span>no-nginx
</span></span><span class="line"><span class="cl">pod/ubuntu-20-04-cbb58d77-tcrjb labeled
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">k get acnp
</span></span><span class="line"><span class="cl">NAME                                       TIER          PRIORITY   DESIRED NODES   CURRENT NODES   AGE
</span></span><span class="line"><span class="cl">acnp-drop-ubuntu-pod-to-nginx-mc-service   securityops   <span class="m">1</span>          <span class="m">1</span>               <span class="m">1</span>               39s
</span></span></code></pre></div><p>Something is in effect&hellip; Now from my test Ubuntu pod I will try to curl the nginx service.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root@ubuntu-20-04-cbb58d77-tcrjb:/# nslookup 10.134.30.220
</span></span><span class="line"><span class="cl">220.30.134.10.in-addr.arpa	<span class="nv">name</span> <span class="o">=</span> antrea-mc-nginx.nginx.svc.cluster.local.
</span></span><span class="line"><span class="cl">root@ubuntu-20-04-cbb58d77-tcrjb:/# curl http://antrea-mc-nginx.nginx.svc.cluster.local
</span></span><span class="line"><span class="cl">curl: <span class="o">(</span>28<span class="o">)</span> Failed to connect to antrea-mc-nginx.nginx.svc.cluster.local port 80: Connection timed out
</span></span><span class="line"><span class="cl">root@ubuntu-20-04-cbb58d77-tcrjb:/#
</span></span></code></pre></div><p>Then I can do a Antrea traceflow:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@tkg-bootstrap:~$ antctl traceflow -S prod/ubuntu-20-04-cbb58d77-tcrjb -D nginx/antrea-mc-nginx -f tcp,tcp_dst<span class="o">=</span><span class="m">80</span>
</span></span><span class="line"><span class="cl">name: prod-ubuntu-20-04-cbb58d77-tcrjb-to-nginx-antrea-mc-nginx-l55dnhvf
</span></span><span class="line"><span class="cl">phase: Succeeded
</span></span><span class="line"><span class="cl">source: prod/ubuntu-20-04-cbb58d77-tcrjb
</span></span><span class="line"><span class="cl">destination: nginx/antrea-mc-nginx
</span></span><span class="line"><span class="cl">results:
</span></span><span class="line"><span class="cl">- node: tkg-cluster-2-md-1-wmxhd-5998fcf669x64b9h-z7mnw
</span></span><span class="line"><span class="cl">  timestamp: <span class="m">1696065339</span>
</span></span><span class="line"><span class="cl">  observations:
</span></span><span class="line"><span class="cl">  - component: SpoofGuard
</span></span><span class="line"><span class="cl">    action: Forwarded
</span></span><span class="line"><span class="cl">  - component: LB
</span></span><span class="line"><span class="cl">    action: Forwarded
</span></span><span class="line"><span class="cl">    translatedDstIP: 10.136.40.246
</span></span><span class="line"><span class="cl">  - component: NetworkPolicy
</span></span><span class="line"><span class="cl">    componentInfo: EgressMetric
</span></span><span class="line"><span class="cl">    action: Dropped
</span></span><span class="line"><span class="cl">    networkPolicy: AntreaClusterNetworkPolicy:acnp-drop-ubuntu-pod-to-nginx-mc-service
</span></span></code></pre></div><p>No need to troubleshoot connectivity issues, is being dropped by the above policy. &#x1f6b7;</p>
<img src=images/image-20230930112931789.png style="width:600px" />
<p>This policy will drop all outgoing (egress) from any pods with label <strong>role=no-nginx</strong> to the exported/imported service using Multi-cluster. Pod selection is done regardless of namespace as my selection is done using pod labels and I am using a Antrea ClusterNetworkPolicy.</p>
<p>Such a policy is applied on the &ldquo;source&rdquo; cluster where you want to define strict egress policies. Another way is to define ingress policies on the destination cluster (source cluster of the exported service).</p>
<p><strong>Ingress rule</strong></p>
<div class="notice info">
<p>Before getting started on this chapter we need to enable the **enableStretchedNetworkPolicy&rdquo; feature in the configMap of ALL antrea-mc-controllers in the ClusterSet (including the leader cluster).
It is shown below&hellip;</p>
</div>
<p>I will have to edit the configMap in both member clusters and leader-cluster setting <code>enableStretchedNetworkPolicy:</code> to <em>true</em></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># Please edit the object below. Lines beginning with a &#39;#&#39; will be ignored,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># and an empty file will abort the edit. If an error occurs while saving this file will be</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># reopened with the relevant failures.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">controller_manager_config.yaml</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">    apiVersion: multicluster.crd.antrea.io/v1alpha1
</span></span></span><span class="line"><span class="cl"><span class="sd">    kind: MultiClusterConfig
</span></span></span><span class="line"><span class="cl"><span class="sd">    health:
</span></span></span><span class="line"><span class="cl"><span class="sd">      healthProbeBindAddress: :8080
</span></span></span><span class="line"><span class="cl"><span class="sd">    metrics:
</span></span></span><span class="line"><span class="cl"><span class="sd">      bindAddress: &#34;0&#34;
</span></span></span><span class="line"><span class="cl"><span class="sd">    webhook:
</span></span></span><span class="line"><span class="cl"><span class="sd">      port: 9443
</span></span></span><span class="line"><span class="cl"><span class="sd">    leaderElection:
</span></span></span><span class="line"><span class="cl"><span class="sd">      leaderElect: false
</span></span></span><span class="line"><span class="cl"><span class="sd">    serviceCIDR: &#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="sd">    podCIDRs:
</span></span></span><span class="line"><span class="cl"><span class="sd">      - &#34;10.133.0.0/16&#34;
</span></span></span><span class="line"><span class="cl"><span class="sd">    gatewayIPPrecedence: &#34;private&#34;
</span></span></span><span class="line"><span class="cl"><span class="sd">    endpointIPType: &#34;ClusterIP&#34;
</span></span></span><span class="line"><span class="cl"><span class="sd">    enableStretchedNetworkPolicy: true #set to true</span><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">kubectl.kubernetes.io/last-applied-configuration</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">      {&#34;apiVersion&#34;:&#34;v1&#34;,&#34;data&#34;:{&#34;controller_manager_config.yaml&#34;:&#34;apiVersion: multicluster.crd.antrea.io/v1alpha1\nkind: MultiClusterConfig\nhealth:\n  healthProbeBindAddress: :8080\nmetrics:\n  bindAddress: \&#34;0\&#34;\nwebhook:\n  port: 9443\nleaderElection:\n  leaderElect: false\nserviceCIDR: \&#34;\&#34;\npodCIDRs:\n  - \&#34;\&#34;\ngatewayIPPrecedence: \&#34;private\&#34;\nendpointIPType: \&#34;ClusterIP\&#34;\nenableStretchedNetworkPolicy: false\n&#34;},&#34;kind&#34;:&#34;ConfigMap&#34;,&#34;metadata&#34;:{&#34;annotations&#34;:{},&#34;labels&#34;:{&#34;app&#34;:&#34;antrea&#34;},&#34;name&#34;:&#34;antrea-mc-controller-config&#34;,&#34;namespace&#34;:&#34;kube-system&#34;}}</span><span class="w">      
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2023-09-29T05:57:12Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">antrea</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">antrea-mc-controller-config</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-system</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resourceVersion</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;415934&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">uid</span><span class="p">:</span><span class="w"> </span><span class="l">fd760052-a18e-4623-b217-d9b96ae36cac</span><span class="w">
</span></span></span></code></pre></div><p>Restart the antrea-mc-controller after editing the above configMap.</p>
<p>Again I will be taking the two examples from the Antrea Gitub doc pages, adjust them to suit my environment.
The first policy example will apply to namespaces with the label <em>environment=protected</em> where ingress will be denied/dropped from the selected pods in any namespace with the label <em>environment=untrust</em> where the scope is ClusterSet. This means it should filter on any traffic coming from any of the namespaces having the label <em>environment=untrust</em> in any member cluster in the ClusterSet. So lets see how this works.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">crd.antrea.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterNetworkPolicy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">drop-untrust-access-to-protected-namespace</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">appliedTo</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">namespaceSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">environment</span><span class="p">:</span><span class="w"> </span><span class="l">protected</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">priority</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">tier</span><span class="p">:</span><span class="w"> </span><span class="l">securityops</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ingress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Drop</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># Select all Pods in environment=untrust Namespaces in the ClusterSet</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">scope</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterSet</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">namespaceSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">environment</span><span class="p">:</span><span class="w"> </span><span class="l">untrust</span><span class="w">
</span></span></span></code></pre></div><p>This policy will be applied on the the member clusters where I do have such &ldquo;protected&rdquo; namespaces and want to ensure no incoming (ingress) from any &ldquo;untrust&rdquo; environments.</p>
<img src=images/image-20230930135702592.png style="width:600px" />
<p>Lets start with applying the policy, and check if it has been applied:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@tkg-bootstrap:~$ k apply -f drop-untrust-to-protected.yaml
</span></span><span class="line"><span class="cl">clusternetworkpolicy.crd.antrea.io/drop-untrust-access-to-protected-namespace created
</span></span><span class="line"><span class="cl"><span class="c1">## check it</span>
</span></span><span class="line"><span class="cl">andreasm@tkg-bootstrap:~$ k get acnp
</span></span><span class="line"><span class="cl">NAME                                         TIER          PRIORITY   DESIRED NODES   CURRENT NODES   AGE
</span></span><span class="line"><span class="cl">drop-untrust-access-to-protected-namespace   securityops   <span class="m">1</span>          <span class="m">0</span>               <span class="m">0</span>               54s
</span></span></code></pre></div><p>Nothing enforced yet.</p>
<p>Back to my ubuntu pod again which resided in the namespace prod in member-cluster blue (tkg-cluster-2). I will label til namespace with environment=protected.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@tkg-bootstrap:~$ k label namespaces prod <span class="nv">environment</span><span class="o">=</span>protected
</span></span><span class="line"><span class="cl">namespace/prod labeled
</span></span><span class="line"><span class="cl"><span class="c1">## checking the policy now</span>
</span></span><span class="line"><span class="cl">andreasm@tkg-bootstrap:~$ k get acnp
</span></span><span class="line"><span class="cl">NAME                                         TIER          PRIORITY   DESIRED NODES   CURRENT NODES   AGE
</span></span><span class="line"><span class="cl">drop-untrust-access-to-protected-namespace   securityops   <span class="m">1</span>          <span class="m">1</span>               <span class="m">1</span>               3m10s
</span></span></code></pre></div><p>In my other member cluster, red, I will create a new namespace, spin up another ubuntu pod there, label the namespace environment=untrust.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@tkg-bootstrap:~$ k get pods -n untrust-ns -owide
</span></span><span class="line"><span class="cl">NAME                          READY   STATUS    RESTARTS   AGE   IP             NODE                                              NOMINATED NODE   READINESS GATES
</span></span><span class="line"><span class="cl">ubuntu-20-04-cbb58d77-bl5w5   1/1     Running   <span class="m">0</span>          43s   10.135.1.228   tkg-cluster-3-md-1-824bx-5bdb559f7bxqgbb8-bqwnr   &lt;none&gt;           &lt;none&gt;
</span></span></code></pre></div><p>Is now running in the <em>untrust-ns</em></p>
<p>From the pod I will try to ping the &ldquo;protected&rdquo; pod in the member-cluster-blue before I label the namespace with untrust.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root@ubuntu-20-04-cbb58d77-bl5w5:/# ping 10.133.1.57
</span></span><span class="line"><span class="cl">PING 10.133.1.57 <span class="o">(</span>10.133.1.57<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
</span></span><span class="line"><span class="cl"><span class="m">64</span> bytes from 10.133.1.57: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">60</span> <span class="nv">time</span><span class="o">=</span>7.93 ms
</span></span><span class="line"><span class="cl"><span class="m">64</span> bytes from 10.133.1.57: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">2</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">60</span> <span class="nv">time</span><span class="o">=</span>4.17 ms
</span></span><span class="line"><span class="cl"><span class="m">64</span> bytes from 10.133.1.57: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">3</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">60</span> <span class="nv">time</span><span class="o">=</span>2.99 ms
</span></span></code></pre></div><p>This &ldquo;protected&rdquo; pod is also running an nginx instance, so lets see if I can curl it from my untrust pod:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root@ubuntu-20-04-cbb58d77-bl5w5:/# curl 10.133.1.57
</span></span><span class="line"><span class="cl">&lt;!DOCTYPE html&gt;
</span></span><span class="line"><span class="cl">&lt;html&gt;
</span></span><span class="line"><span class="cl">&lt;head&gt;
</span></span><span class="line"><span class="cl">&lt;title&gt;Welcome to nginx!&lt;/title&gt;
</span></span><span class="line"><span class="cl">&lt;style&gt;
</span></span><span class="line"><span class="cl">    body <span class="o">{</span>
</span></span><span class="line"><span class="cl">        width: 35em<span class="p">;</span>
</span></span><span class="line"><span class="cl">        margin: <span class="m">0</span> auto<span class="p">;</span>
</span></span><span class="line"><span class="cl">        font-family: Tahoma, Verdana, Arial, sans-serif<span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">&lt;/style&gt;
</span></span><span class="line"><span class="cl">&lt;/head&gt;
</span></span><span class="line"><span class="cl">&lt;body&gt;
</span></span><span class="line"><span class="cl">&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;
</span></span><span class="line"><span class="cl">&lt;p&gt;If you see this page, the nginx web server is successfully installed and
</span></span><span class="line"><span class="cl">working. Further configuration is required.&lt;/p&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;p&gt;For online documentation and support please refer to
</span></span><span class="line"><span class="cl">&lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&#34;http://nginx.org/&#34;</span>&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;
</span></span><span class="line"><span class="cl">Commercial support is available at
</span></span><span class="line"><span class="cl">&lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&#34;http://nginx.com/&#34;</span>&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;p&gt;&lt;em&gt;Thank you <span class="k">for</span> using nginx.&lt;/em&gt;&lt;/p&gt;
</span></span><span class="line"><span class="cl">&lt;/body&gt;
</span></span><span class="line"><span class="cl">&lt;/html&gt;
</span></span></code></pre></div><p>This works also. Now I will label the namespace accordingly.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@tkg-bootstrap:~$ k get ns untrust-ns --show-labels
</span></span><span class="line"><span class="cl">NAME         STATUS   AGE    LABELS
</span></span><span class="line"><span class="cl">untrust-ns   Active   9m3s   <span class="nv">environment</span><span class="o">=</span>untrust,kubernetes.io/metadata.name<span class="o">=</span>untrust-ns
</span></span></code></pre></div><p>Can I now both curl and ping the protected pod from the untrust pod?</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root@ubuntu-20-04-cbb58d77-bl5w5:/# ping 10.133.1.57
</span></span><span class="line"><span class="cl">PING 10.133.1.57 <span class="o">(</span>10.133.1.57<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
</span></span><span class="line"><span class="cl">^C
</span></span><span class="line"><span class="cl">--- 10.133.1.57 ping statistics ---
</span></span><span class="line"><span class="cl"><span class="m">96</span> packets transmitted, <span class="m">0</span> received, 100% packet loss, <span class="nb">time</span> 97275ms
</span></span><span class="line"><span class="cl"><span class="c1">## curl</span>
</span></span><span class="line"><span class="cl">root@ubuntu-20-04-cbb58d77-bl5w5:/# curl 10.133.1.57
</span></span><span class="line"><span class="cl">curl: <span class="o">(</span>28<span class="o">)</span> Failed to connect to 10.133.1.57 port 80: Connection timed out
</span></span></code></pre></div><p>Thats a no&hellip;</p>
<p>How about that. Now I would like to see the resourceImport/Exports in the leader cluster:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@tkg-bootstrap:~$ k get resourceimports.multicluster.crd.antrea.io -A
</span></span><span class="line"><span class="cl">NAMESPACE             NAME                              KIND            NAMESPACE             NAME                              AGE
</span></span><span class="line"><span class="cl">antrea-multicluster   07114e55523175d2                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="cl">antrea-multicluster   085dd73c98e1d875                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="cl">antrea-multicluster   0c56bac2726cdc89                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="cl">antrea-multicluster   0f8eaa8d1ed0d024                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="cl">antrea-multicluster   1742a902fef9ecf2                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="cl">antrea-multicluster   1a7d18d61d0c0ee1                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="cl">antrea-multicluster   1f395d26ddf2e628                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="cl">antrea-multicluster   23f00caa60df7444                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="cl">antrea-multicluster   2ae09744db3c2971                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="cl">antrea-multicluster   2de39d651a0361e9                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="cl">antrea-multicluster   2ef5bcdb8443a24c                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="cl">antrea-multicluster   339dbb049e2e9a92                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="cl">antrea-multicluster   430e80a9621c621a                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="cl">antrea-multicluster   4c9c7b4329d0e128                  LabelIdentity                                                           3m55s
</span></span><span class="line"><span class="cl">antrea-multicluster   5629f9c0856c3bab                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="cl">antrea-multicluster   593cb26f6e1ae9e3                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="cl">antrea-multicluster   66b072b8efc1faa7                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="cl">antrea-multicluster   67410707ad7a9908                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="cl">antrea-multicluster   7468af4ac6f5dfa7                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="cl">antrea-multicluster   7c59020a5dcbb1b9                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="cl">antrea-multicluster   7dac813f5932e57e                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="cl">antrea-multicluster   7f43c50b4566cd91                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="cl">antrea-multicluster   8327de14325c06f9                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="cl">antrea-multicluster   9227dd1f8d5eef10                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="cl">antrea-multicluster   9a2e5dbff4effe99                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="cl">antrea-multicluster   9a4b2085e53f890c                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="cl">antrea-multicluster   9b5c3a1ff3c1724f                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="cl">antrea-multicluster   9ba8fb64d35434a6                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="cl">antrea-multicluster   a59e6e24ceaabe76                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="cl">antrea-multicluster   a642d62a95b68860                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="cl">antrea-multicluster   afe73316119e5beb                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="cl">antrea-multicluster   b07efcf6d7df9ecc                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="cl">antrea-multicluster   b0ef5ea4e6654296                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="cl">antrea-multicluster   b4ab02dcfded7a88                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="cl">antrea-multicluster   b9f26e2c922bdfce                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="cl">antrea-multicluster   be152630c03e5d6b                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="cl">antrea-multicluster   c316283f47088c45                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="cl">antrea-multicluster   c7703628c133a9ae                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="cl">antrea-multicluster   db564a4a19f62e39                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="cl">antrea-multicluster   db672f99c9b13343                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="cl">antrea-multicluster   db674d682cb5db88                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="cl">antrea-multicluster   ef097265c27216d2                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="cl">antrea-multicluster   f8e5f6fba3fb9a5c                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="cl">antrea-multicluster   fc0e44265f8dce47                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="cl">antrea-multicluster   fc156481c7b8ebf2                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="cl">antrea-multicluster   member-cluster-blue-clusterinfo   ClusterInfo     antrea-multicluster   member-cluster-blue-clusterinfo   31h
</span></span><span class="line"><span class="cl">antrea-multicluster   member-cluster-red-clusterinfo    ClusterInfo     antrea-multicluster   member-cluster-red-clusterinfo    31h
</span></span><span class="line"><span class="cl">antrea-multicluster   nginx-nginx-endpoints             Endpoints       nginx                 nginx                             31h
</span></span><span class="line"><span class="cl">antrea-multicluster   nginx-nginx-service               ServiceImport   nginx                 nginx                             31h
</span></span><span class="line"><span class="cl">antrea-multicluster   yelb-yelb-appserver-endpoints     Endpoints       yelb                  yelb-appserver                    31h
</span></span><span class="line"><span class="cl">antrea-multicluster   yelb-yelb-appserver-service       ServiceImport   yelb                  yelb-appserver                    31h
</span></span><span class="line"><span class="cl">andreasm@tkg-bootstrap:~$ k get resourceexports.multicluster.crd.antrea.io -A
</span></span><span class="line"><span class="cl">NAMESPACE             NAME                                               CLUSTER ID            KIND            NAMESPACE     NAME                  AGE
</span></span><span class="line"><span class="cl">antrea-multicluster   member-cluster-blue-085dd73c98e1d875               member-cluster-blue   LabelIdentity                                       11m
</span></span><span class="line"><span class="cl">antrea-multicluster   member-cluster-blue-0f8eaa8d1ed0d024               member-cluster-blue   LabelIdentity                                       11m
</span></span><span class="line"><span class="cl">antrea-multicluster   member-cluster-blue-23f00caa60df7444               member-cluster-blue   LabelIdentity                                       11m
</span></span><span class="line"><span class="cl">antrea-multicluster   member-cluster-blue-2ae09744db3c2971               member-cluster-blue   LabelIdentity                                       11m
</span></span><span class="line"><span class="cl">antrea-multicluster   member-cluster-blue-2de39d651a0361e9               member-cluster-blue   LabelIdentity                                       11m
</span></span><span class="line"><span class="cl">antrea-multicluster   member-cluster-blue-2ef5bcdb8443a24c               member-cluster-blue   LabelIdentity                                       11m
</span></span><span class="line"><span class="cl">antrea-multicluster   member-cluster-blue-5629f9c0856c3bab               member-cluster-blue   LabelIdentity                                       11m
</span></span><span class="line"><span class="cl">antrea-multicluster   member-cluster-blue-593cb26f6e1ae9e3               member-cluster-blue   LabelIdentity                                       11m
</span></span><span class="line"><span class="cl">antrea-multicluster   member-cluster-blue-7c59020a5dcbb1b9               member-cluster-blue   LabelIdentity                                       11m
</span></span><span class="line"><span class="cl">antrea-multicluster   member-cluster-blue-9a4b2085e53f890c               member-cluster-blue   LabelIdentity                                       11m
</span></span><span class="line"><span class="cl">antrea-multicluster   member-cluster-blue-9b5c3a1ff3c1724f               member-cluster-blue   LabelIdentity                                       11m
</span></span><span class="line"><span class="cl">antrea-multicluster   member-cluster-blue-a642d62a95b68860               member-cluster-blue   LabelIdentity                                       11m
</span></span><span class="line"><span class="cl">antrea-multicluster   member-cluster-blue-afe73316119e5beb               member-cluster-blue   LabelIdentity                                       11m
</span></span><span class="line"><span class="cl">antrea-multicluster   member-cluster-blue-b07efcf6d7df9ecc               member-cluster-blue   LabelIdentity                                       11m
</span></span><span class="line"><span class="cl">antrea-multicluster   member-cluster-blue-b0ef5ea4e6654296               member-cluster-blue   LabelIdentity                                       11m
</span></span><span class="line"><span class="cl">antrea-multicluster   member-cluster-blue-b4ab02dcfded7a88               member-cluster-blue   LabelIdentity                                       11m
</span></span><span class="line"><span class="cl">antrea-multicluster   member-cluster-blue-b9f26e2c922bdfce               member-cluster-blue   LabelIdentity                                       11m
</span></span><span class="line"><span class="cl">antrea-multicluster   member-cluster-blue-c7703628c133a9ae               member-cluster-blue   LabelIdentity                                       11m
</span></span><span class="line"><span class="cl">antrea-multicluster   member-cluster-blue-clusterinfo                    member-cluster-blue   ClusterInfo     kube-system   member-cluster-blue   31h
</span></span><span class="line"><span class="cl">antrea-multicluster   member-cluster-blue-db672f99c9b13343               member-cluster-blue   LabelIdentity                                       11m
</span></span><span class="line"><span class="cl">antrea-multicluster   member-cluster-blue-fc156481c7b8ebf2               member-cluster-blue   LabelIdentity                                       11m
</span></span><span class="line"><span class="cl">antrea-multicluster   member-cluster-red-07114e55523175d2                member-cluster-red    LabelIdentity                                       11m
</span></span><span class="line"><span class="cl">antrea-multicluster   member-cluster-red-1742a902fef9ecf2                member-cluster-red    LabelIdentity                                       11m
</span></span><span class="line"><span class="cl">antrea-multicluster   member-cluster-red-1a7d18d61d0c0ee1                member-cluster-red    LabelIdentity                                       11m
</span></span><span class="line"><span class="cl">antrea-multicluster   member-cluster-red-1f395d26ddf2e628                member-cluster-red    LabelIdentity                                       11m
</span></span><span class="line"><span class="cl">antrea-multicluster   member-cluster-red-339dbb049e2e9a92                member-cluster-red    LabelIdentity                                       11m
</span></span><span class="line"><span class="cl">antrea-multicluster   member-cluster-red-430e80a9621c621a                member-cluster-red    LabelIdentity                                       11m
</span></span><span class="line"><span class="cl">antrea-multicluster   member-cluster-red-4c9c7b4329d0e128                member-cluster-red    LabelIdentity                                       4m23s
</span></span><span class="line"><span class="cl">antrea-multicluster   member-cluster-red-66b072b8efc1faa7                member-cluster-red    LabelIdentity                                       11m
</span></span><span class="line"><span class="cl">antrea-multicluster   member-cluster-red-67410707ad7a9908                member-cluster-red    LabelIdentity                                       11m
</span></span><span class="line"><span class="cl">antrea-multicluster   member-cluster-red-7468af4ac6f5dfa7                member-cluster-red    LabelIdentity                                       11m
</span></span><span class="line"><span class="cl">antrea-multicluster   member-cluster-red-7dac813f5932e57e                member-cluster-red    LabelIdentity                                       11m
</span></span><span class="line"><span class="cl">antrea-multicluster   member-cluster-red-7f43c50b4566cd91                member-cluster-red    LabelIdentity                                       11m
</span></span><span class="line"><span class="cl">antrea-multicluster   member-cluster-red-8327de14325c06f9                member-cluster-red    LabelIdentity                                       11m
</span></span><span class="line"><span class="cl">antrea-multicluster   member-cluster-red-9227dd1f8d5eef10                member-cluster-red    LabelIdentity                                       11m
</span></span><span class="line"><span class="cl">antrea-multicluster   member-cluster-red-9a2e5dbff4effe99                member-cluster-red    LabelIdentity                                       11m
</span></span><span class="line"><span class="cl">antrea-multicluster   member-cluster-red-9ba8fb64d35434a6                member-cluster-red    LabelIdentity                                       11m
</span></span><span class="line"><span class="cl">antrea-multicluster   member-cluster-red-a59e6e24ceaabe76                member-cluster-red    LabelIdentity                                       11m
</span></span><span class="line"><span class="cl">antrea-multicluster   member-cluster-red-be152630c03e5d6b                member-cluster-red    LabelIdentity                                       11m
</span></span><span class="line"><span class="cl">antrea-multicluster   member-cluster-red-c316283f47088c45                member-cluster-red    LabelIdentity                                       11m
</span></span><span class="line"><span class="cl">antrea-multicluster   member-cluster-red-clusterinfo                     member-cluster-red    ClusterInfo     kube-system   member-cluster-red    31h
</span></span><span class="line"><span class="cl">antrea-multicluster   member-cluster-red-db564a4a19f62e39                member-cluster-red    LabelIdentity                                       11m
</span></span><span class="line"><span class="cl">antrea-multicluster   member-cluster-red-db674d682cb5db88                member-cluster-red    LabelIdentity                                       11m
</span></span><span class="line"><span class="cl">antrea-multicluster   member-cluster-red-ef097265c27216d2                member-cluster-red    LabelIdentity                                       11m
</span></span><span class="line"><span class="cl">antrea-multicluster   member-cluster-red-f8e5f6fba3fb9a5c                member-cluster-red    LabelIdentity                                       11m
</span></span><span class="line"><span class="cl">antrea-multicluster   member-cluster-red-fc0e44265f8dce47                member-cluster-red    LabelIdentity                                       11m
</span></span><span class="line"><span class="cl">antrea-multicluster   member-cluster-red-nginx-nginx-endpoints           member-cluster-red    Endpoints       nginx         nginx                 31h
</span></span><span class="line"><span class="cl">antrea-multicluster   member-cluster-red-nginx-nginx-service             member-cluster-red    Service         nginx         nginx                 31h
</span></span><span class="line"><span class="cl">antrea-multicluster   member-cluster-red-yelb-yelb-appserver-endpoints   member-cluster-red    Endpoints       yelb          yelb-appserver        31h
</span></span><span class="line"><span class="cl">antrea-multicluster   member-cluster-red-yelb-yelb-appserver-service     member-cluster-red    Service         yelb          yelb-appserver        31h
</span></span></code></pre></div><p>And if I describe one of them:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">k describe resourceimports.multicluster.crd.antrea.io -n antrea-multicluster 07114e55523175d2
</span></span><span class="line"><span class="cl">Name:         07114e55523175d2
</span></span><span class="line"><span class="cl">Namespace:    antrea-multicluster
</span></span><span class="line"><span class="cl">Labels:       &lt;none&gt;
</span></span><span class="line"><span class="cl">Annotations:  &lt;none&gt;
</span></span><span class="line"><span class="cl">API Version:  multicluster.crd.antrea.io/v1alpha1
</span></span><span class="line"><span class="cl">Kind:         ResourceImport
</span></span><span class="line"><span class="cl">Metadata:
</span></span><span class="line"><span class="cl">  Creation Timestamp:  2023-09-30T13:33:02Z
</span></span><span class="line"><span class="cl">  Generation:          <span class="m">1</span>
</span></span><span class="line"><span class="cl">  Resource Version:    <span class="m">442986</span>
</span></span><span class="line"><span class="cl">  UID:                 4157d671-6c4d-4653-b97f-554bdfa705d9
</span></span><span class="line"><span class="cl">Spec:
</span></span><span class="line"><span class="cl">  Kind:  LabelIdentity
</span></span><span class="line"><span class="cl">  Label Identity:
</span></span><span class="line"><span class="cl">    Id:     <span class="m">35</span>
</span></span><span class="line"><span class="cl">    Label:  ns:kubernetes.io/metadata.name<span class="o">=</span>nginx<span class="p">&amp;</span>pod:app<span class="o">=</span>nginx-ui,pod-template-hash<span class="o">=</span>59c956b95b,tier<span class="o">=</span>frontend
</span></span><span class="line"><span class="cl">Events:     &lt;none&gt;
</span></span></code></pre></div><p>The leader cluster is now aware of all labels, namespaces and pods, from the other member clusters which will allow us to create this ingress rule with namespace or pod selection from the other clusters. The applyTo field is only relevant for the cluster the policy is applied in.</p>
<p>The second ingress policy example below is using a &ldquo;namespaced&rdquo; policy (Antrea NetworkPolicy). It will be applied to a specific namespace in the &ldquo;destination&rdquo; cluster, using podSelector with labels <em>app=db</em> to select specific pods. The policy will be placed in the Application Tier, it will allow sources coming from any pods in the ClusterSet matching the label <em>app=client</em> to the pods in the specified namesapace with label <em>app=db</em> and dropping everything else.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">crd.antrea.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">AntreaNetworkPolicy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">db-svc-allow-ingress-from-client-only</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">prod-us-west</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">appliedTo</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">podSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">db</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">priority</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">tier</span><span class="p">:</span><span class="w"> </span><span class="l">application</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ingress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Allow</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># Select all Pods in Namespace &#34;prod-us-west&#34; from all clusters in the ClusterSet (if the</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># Namespace exists in that cluster) whose labels match app=client</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">scope</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterSet</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">podSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">client</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Deny</span><span class="w">
</span></span></span></code></pre></div><p>I will not test this, as it will work similarly as the first example, the only difference being is that it is applied on a namespace, not clusterwide (using Antrea ClusterNetworkPolicy).</p>
<p>Next up is creating a ClusterNetworkPolicy that is replicated across all clusters.</p>


<h2 class="relative group">Multi-cluster ClusterNetworkPolicy replication (ACNP) 
    <div id="multi-cluster-clusternetworkpolicy-replication-acnp" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#multi-cluster-clusternetworkpolicy-replication-acnp" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>In this last chapter I will test out the possibility with Multi-cluster to replicate a ClusterNetworkPolicy across each members in my ClusterSet, member-cluster-blue and red.</p>
<p>I will just take the example from the official Antrea Github docs page and use it as it is. Before I apply it I will just quickly check whether I have any policies applied in any of my member clusters:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">## tkg-cluster-2 - member-blue</span>
</span></span><span class="line"><span class="cl">k config current-context
</span></span><span class="line"><span class="cl">tkg-cluster-2-admin@tkg-cluster-2
</span></span><span class="line"><span class="cl"><span class="c1">## Any policies?</span>
</span></span><span class="line"><span class="cl">k get acnp
</span></span><span class="line"><span class="cl">No resources found
</span></span><span class="line"><span class="cl">k get anp -A
</span></span><span class="line"><span class="cl">No resources found
</span></span><span class="line"><span class="cl"><span class="c1">## tkg-cluster-3 - member-red</span>
</span></span><span class="line"><span class="cl">k config current-context
</span></span><span class="line"><span class="cl">tkg-cluster-3-admin@tkg-cluster-3
</span></span><span class="line"><span class="cl"><span class="c1">## Any policies?</span>
</span></span><span class="line"><span class="cl">k get acnp
</span></span><span class="line"><span class="cl">No resources found
</span></span><span class="line"><span class="cl">k get anp -A
</span></span><span class="line"><span class="cl">No resources found
</span></span></code></pre></div><p>No policies.</p>
<p>To replicate a policy to all members I will switch context to the leader-cluster and create a <strong>ResourceExport</strong> and the ClusterNetworkPolicy itself and apply it on the leader-cluster.</p>
<div class="notice info">
<p>The namespace for the Kind: ResourceExport needs to be in the same namespace as where the antrea-mc-controller is running!!</p>
</div>
<p>Below is the example I will be using, taken from the Antrea Github doc page:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">multicluster.crd.antrea.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ResourceExport</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">strict-namespace-isolation-for-test-clusterset</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">antrea-multicluster</span><span class="w"> </span><span class="c"># Namespace that Multi-cluster Controller is deployed</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">AntreaClusterNetworkPolicy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">strict-namespace-isolation</span><span class="w"> </span><span class="c"># In each importing cluster, an ACNP of name antrea-mc-strict-namespace-isolation will be created with the spec below</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">clusterNetworkPolicy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">priority</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">tier</span><span class="p">:</span><span class="w"> </span><span class="l">securityops</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">appliedTo</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">namespaceSelector</span><span class="p">:</span><span class="w"> </span>{}<span class="w"> </span><span class="c"># Selects all Namespaces in the member cluster</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ingress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Pass</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">namespaces</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">match</span><span class="p">:</span><span class="w"> </span><span class="l">Self</span><span class="w"> </span><span class="c"># Skip drop rule for traffic from Pods in the same Namespace</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">podSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l">kube-dns</span><span class="w"> </span><span class="c"># Skip drop rule for traffic from the core-dns components</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Drop</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">namespaceSelector</span><span class="p">:</span><span class="w"> </span>{}<span class="w"> </span><span class="c"># Drop from Pods from all other Namespaces</span><span class="w">
</span></span></span></code></pre></div><p>Now apply it in my leader-cluster:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">## tkg-cluster-1 - leader-cluster</span>
</span></span><span class="line"><span class="cl">k config current-context
</span></span><span class="line"><span class="cl">tkg-cluster-1-admin@tkg-cluster-1
</span></span><span class="line"><span class="cl"><span class="c1">## apply</span>
</span></span><span class="line"><span class="cl">k apply -f acnp-replicated.yaml
</span></span><span class="line"><span class="cl">resourceexport.multicluster.crd.antrea.io/strict-namespace-isolation-for-test-clusterset created
</span></span></code></pre></div><p>Now I will switch over to the contexts of my member clusters and check what has happened there:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">## tkg-cluster-2 - member-blue</span>
</span></span><span class="line"><span class="cl">k get acnp
</span></span><span class="line"><span class="cl">NAME                                   TIER          PRIORITY   DESIRED NODES   CURRENT NODES   AGE
</span></span><span class="line"><span class="cl">antrea-mc-strict-namespace-isolation   securityops   <span class="m">1</span>          <span class="m">3</span>               <span class="m">3</span>               47s
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">## tkg-cluster-3 - member-red</span>
</span></span><span class="line"><span class="cl">k get acnp
</span></span><span class="line"><span class="cl">NAME                                   TIER          PRIORITY   DESIRED NODES   CURRENT NODES   AGE
</span></span><span class="line"><span class="cl">antrea-mc-strict-namespace-isolation   securityops   <span class="m">1</span>          <span class="m">3</span>               <span class="m">3</span>               108s
</span></span></code></pre></div><p>This is really great!! Both my member cluster has gotten the policy applied.</p>
<p>On the leader-cluster?</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">## tkg-cluster-1</span>
</span></span><span class="line"><span class="cl">k get acnp
</span></span><span class="line"><span class="cl">No resources found
</span></span></code></pre></div><p>Nothing.</p>
<p>The only bad thing now is that this policy broke my Yelb application as my Yelb-ui can no longer reach the backends in the other cluster &#x1f604; so will have to add some additional policies to support this application also. Which is perfectly normal, and I have covered a bunch of Antrea policies in this <a href="https://blog.andreasm.io/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/" target="_blank">post</a> and this <a href="https://blog.andreasm.io/2023/06/01/managing-antrea-in-vsphere-with-tanzu/" target="_blank">post</a> that can be re-used for this purpose.</p>
<p>Now I will just do a last thing an check the status of my replicated policy from the leader-cluster if there are any alert on any of the member cluster, why they have not applied the policy etc..</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">k get resourceexports.multicluster.crd.antrea.io -A
</span></span><span class="line"><span class="cl">NAMESPACE             NAME                                               CLUSTER ID            KIND                         NAMESPACE     NAME                         AGE
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">antrea-multicluster   strict-namespace-isolation-for-test-clusterset                           AntreaClusterNetworkPolicy                 strict-namespace-isolation   8m39s
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">k describe resourceexports.multicluster.crd.antrea.io -n antrea-multicluster strict-namespace-isolation-for-test-clusterset
</span></span><span class="line"><span class="cl">Name:         strict-namespace-isolation-for-test-clusterset
</span></span><span class="line"><span class="cl">Namespace:    antrea-multicluster
</span></span><span class="line"><span class="cl">Labels:       <span class="nv">sourceKind</span><span class="o">=</span>AntreaClusterNetworkPolicy
</span></span><span class="line"><span class="cl">              <span class="nv">sourceName</span><span class="o">=</span>strict-namespace-isolation
</span></span><span class="line"><span class="cl">              <span class="nv">sourceNamespace</span><span class="o">=</span>
</span></span><span class="line"><span class="cl">Annotations:  &lt;none&gt;
</span></span><span class="line"><span class="cl">API Version:  multicluster.crd.antrea.io/v1alpha1
</span></span><span class="line"><span class="cl">Kind:         ResourceExport
</span></span><span class="line"><span class="cl">Metadata:
</span></span><span class="line"><span class="cl">  Creation Timestamp:  2023-09-30T14:02:42Z
</span></span><span class="line"><span class="cl">  Finalizers:
</span></span><span class="line"><span class="cl">    resourceexport.finalizers.antrea.io
</span></span><span class="line"><span class="cl">  Generation:        <span class="m">1</span>
</span></span><span class="line"><span class="cl">  Resource Version:  <span class="m">448359</span>
</span></span><span class="line"><span class="cl">  UID:               3d7111dd-eecc-46bb-8307-c95d747474b0
</span></span><span class="line"><span class="cl">Spec:
</span></span><span class="line"><span class="cl">  Cluster Network Policy:
</span></span><span class="line"><span class="cl">    Applied To:
</span></span><span class="line"><span class="cl">      Namespace Selector:
</span></span><span class="line"><span class="cl">    Ingress:
</span></span><span class="line"><span class="cl">      Action:          Pass
</span></span><span class="line"><span class="cl">      Enable Logging:  <span class="nb">false</span>
</span></span><span class="line"><span class="cl">      From:
</span></span><span class="line"><span class="cl">        Namespaces:
</span></span><span class="line"><span class="cl">          Match:  Self
</span></span><span class="line"><span class="cl">        Pod Selector:
</span></span><span class="line"><span class="cl">          Match Labels:
</span></span><span class="line"><span class="cl">            k8s-app:   kube-dns
</span></span><span class="line"><span class="cl">      Action:          Drop
</span></span><span class="line"><span class="cl">      Enable Logging:  <span class="nb">false</span>
</span></span><span class="line"><span class="cl">      From:
</span></span><span class="line"><span class="cl">        Namespace Selector:
</span></span><span class="line"><span class="cl">    Priority:  <span class="m">1</span>
</span></span><span class="line"><span class="cl">    Tier:      securityops
</span></span><span class="line"><span class="cl">  Kind:        AntreaClusterNetworkPolicy
</span></span><span class="line"><span class="cl">  Name:        strict-namespace-isolation
</span></span><span class="line"><span class="cl">Status:
</span></span><span class="line"><span class="cl">  Conditions:
</span></span><span class="line"><span class="cl">    Last Transition Time:  2023-09-30T14:02:42Z
</span></span><span class="line"><span class="cl">    Status:                True
</span></span><span class="line"><span class="cl">    Type:                  Succeeded
</span></span><span class="line"><span class="cl">Events:                    &lt;none&gt;
</span></span></code></pre></div><p>Looks good.</p>


<h2 class="relative group">Bonus content 
    <div id="bonus-content" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#bonus-content" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>With the help from my friend ChatGPT I created a menu driven &ldquo;automated&rdquo; way of deploying all of the above steps.</p>
<p>The pre-requisities for this script is that it expects all your Kubernetes clusters already deployed and the Antrea Multi-cluster feature gates enabled. Then the script should be executed from a machine that has all the kubernetes clusters contexts added. It will prompt for the different contexts in some of the menus and will change to these context to execute specific commands in selected contexts.</p>
<p>I will just quickly go through the script/menus. When script is executed it will bring up this menu:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">Main Menu:
</span></span><span class="line"><span class="cl">1. Select Antrea version
</span></span><span class="line"><span class="cl">2. Install Antrea Multi-cluster on leader cluster
</span></span><span class="line"><span class="cl">3. Install Antrea Multi-cluster on member cluster
</span></span><span class="line"><span class="cl">4. Create member-cluster secrets
</span></span><span class="line"><span class="cl">5. Apply member tokens
</span></span><span class="line"><span class="cl">6. Create ClusterSet on the leader cluster
</span></span><span class="line"><span class="cl">7. Create ClusterClaim on member cluster
</span></span><span class="line"><span class="cl">8. Create Multi-cluster Gateway
</span></span><span class="line"><span class="cl">9. Create a Multi-cluster service
</span></span><span class="line"><span class="cl">10. Exit
</span></span><span class="line"><span class="cl">Enter your choice:
</span></span></code></pre></div><p>Explanation of the different menu selections and what it does:</p>
<ol>
<li>
<p>This will prompt you for the specific Antrea version you are using and use that as a tag for downloading and applying the correct yaml files</p>
</li>
<li>
<p>This will let you select your &ldquo;Leader Cluster&rdquo;, create the namespace antrea-multicluster, deploy the leader yaml manifests and deploy the antrea-mc-controller in the cluster.</p>
</li>
<li>
<p>This will let you select a member cluster to install the member yaml and the antrea-mc-controller. This needs to be done for each of the member cluster you want to install it on.</p>
</li>
<li>
<p>This will create the member-cluster secrets, asking for the leader-cluster contexts for them to be created in. And the export the token.yamls to be applied in next step</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">Enter your choice: <span class="m">4</span>
</span></span><span class="line"><span class="cl">Creating member-cluster secrets...
</span></span><span class="line"><span class="cl">1<span class="o">)</span> 10.13.90.1
</span></span><span class="line"><span class="cl">2<span class="o">)</span> cluster-1
</span></span><span class="line"><span class="cl">3<span class="o">)</span> ns-stc-1
</span></span><span class="line"><span class="cl">4<span class="o">)</span> Back to Main Menu
</span></span><span class="line"><span class="cl">Select a context as the leader cluster: <span class="m">2</span>
</span></span><span class="line"><span class="cl">Switched to context <span class="s2">&#34;cluster-1&#34;</span>.
</span></span><span class="line"><span class="cl">Enter the name <span class="k">for</span> Member Cluster <span class="o">(</span>e.g., member-blue<span class="o">)</span>: member-red
</span></span></code></pre></div></li>
<li>
<p>This will ask you for the context for the respective token.yamls created to be applied in. It will list all the yaml files created in the current folder for you to choose which token to be applied.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">Enter your choice: <span class="m">5</span>
</span></span><span class="line"><span class="cl">Applying member tokens...
</span></span><span class="line"><span class="cl">1<span class="o">)</span> 10.13.90.1
</span></span><span class="line"><span class="cl">2<span class="o">)</span> cluster-1
</span></span><span class="line"><span class="cl">3<span class="o">)</span> ns-stc-1
</span></span><span class="line"><span class="cl">4<span class="o">)</span> Back to Main Menu
</span></span><span class="line"><span class="cl">Select a context to switch to: <span class="m">2</span>
</span></span><span class="line"><span class="cl">Switched to context <span class="s2">&#34;cluster-1&#34;</span>.
</span></span><span class="line"><span class="cl">1<span class="o">)</span> member-blue-token.yaml
</span></span><span class="line"><span class="cl">2<span class="o">)</span> Back to Main Menu
</span></span><span class="line"><span class="cl">Select a YAML file to apply:
</span></span></code></pre></div></li>
<li>
<p>This will create the clusterset prompting for the leader cluster context and ask for the ClusterID and ClusterSet name</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">Enter your choice: <span class="m">6</span>
</span></span><span class="line"><span class="cl">Creating ClusterSet on the leader cluster...
</span></span><span class="line"><span class="cl">1<span class="o">)</span> 10.13.90.1
</span></span><span class="line"><span class="cl">2<span class="o">)</span> cluster-1
</span></span><span class="line"><span class="cl">3<span class="o">)</span> ns-stc-1
</span></span><span class="line"><span class="cl">4<span class="o">)</span> Back to Main Menu
</span></span><span class="line"><span class="cl">Select the leader cluster context: <span class="m">2</span>
</span></span><span class="line"><span class="cl">Switched to context <span class="s2">&#34;cluster-1&#34;</span>.
</span></span><span class="line"><span class="cl">Enter ClusterID <span class="o">(</span>e.g., tkg-cluster-leader<span class="o">)</span>: leader-cluster
</span></span><span class="line"><span class="cl">Enter ClusterSet name <span class="o">(</span>e.g., andreasm-clusterset<span class="o">)</span>: super-clusterset
</span></span></code></pre></div></li>
<li>
<p>This will create the clusterclaim on the member cluster to join the cluster leader/clusterset</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">Enter your choice: <span class="m">7</span>
</span></span><span class="line"><span class="cl">Creating ClusterClaim on member cluster...
</span></span><span class="line"><span class="cl">1<span class="o">)</span> 10.13.90.1
</span></span><span class="line"><span class="cl">2<span class="o">)</span> cluster-1
</span></span><span class="line"><span class="cl">3<span class="o">)</span> ns-stc-1
</span></span><span class="line"><span class="cl">4<span class="o">)</span> Back to Main Menu
</span></span><span class="line"><span class="cl">Select a context to switch to: <span class="m">2</span>
</span></span><span class="line"><span class="cl">Switched to context <span class="s2">&#34;cluster-1&#34;</span>.
</span></span><span class="line"><span class="cl">Enter member-cluster-name <span class="o">(</span>e.g., member-cluster-red<span class="o">)</span>: member-cluster-blue
</span></span><span class="line"><span class="cl">Enter ClusterSet name <span class="o">(</span>e.g., andreasm-clusterset<span class="o">)</span>: super-clusterset
</span></span><span class="line"><span class="cl">Enter Leader ClusterID <span class="o">(</span>e.g., tkg-cluster-leader<span class="o">)</span>: leader-cluster
</span></span><span class="line"><span class="cl">Enter Member Token to use: member-blue-token
</span></span><span class="line"><span class="cl">Enter Leader cluster API endpoint <span class="o">(</span>e.g., https://10.101.114.100:6443<span class="o">)</span>: https://10.101.115.120:6443
</span></span></code></pre></div></li>
<li>
<p>This will create the Multi-cluster Gateway by letting you select the which node in which cluster to annotate</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">Enter your choice: <span class="m">8</span>
</span></span><span class="line"><span class="cl">Creating Multi-cluster Gateway...
</span></span><span class="line"><span class="cl">1<span class="o">)</span> 10.13.90.1
</span></span><span class="line"><span class="cl">2<span class="o">)</span> cluster-1
</span></span><span class="line"><span class="cl">3<span class="o">)</span> ns-stc-1
</span></span><span class="line"><span class="cl">4<span class="o">)</span> Back to Main Menu
</span></span><span class="line"><span class="cl">Select a context to switch to: <span class="m">2</span>
</span></span><span class="line"><span class="cl">Switched to context <span class="s2">&#34;cluster-1&#34;</span>.
</span></span><span class="line"><span class="cl">1<span class="o">)</span> cluster-1-f82lv-fdvw8			  3<span class="o">)</span> cluster-1-node-pool-01-tb4tw-555756bd56-klgcs
</span></span><span class="line"><span class="cl">2<span class="o">)</span> cluster-1-node-pool-01-tb4tw-555756bd56-76qv6  4<span class="o">)</span> Back to Context Menu
</span></span><span class="line"><span class="cl">Select a node to annotate as Multi-cluster Gateway: <span class="m">2</span>
</span></span><span class="line"><span class="cl">node/cluster-1-node-pool-01-tb4tw-555756bd56-76qv6 annotated
</span></span><span class="line"><span class="cl">Annotated cluster-1-node-pool-01-tb4tw-555756bd56-76qv6 as Multi-cluster Gateway.
</span></span><span class="line"><span class="cl">Select a node to annotate as Multi-cluster Gateway: <span class="m">4</span>
</span></span><span class="line"><span class="cl">Do you want to annotate another node? <span class="o">(</span>yes/no<span class="o">)</span>: <span class="c1"># Selecting yes brings up the node list again. Selecting no takes you back to main menu. This needs to be done on all member clusters you need to define a gateway node</span>
</span></span></code></pre></div></li>
<li>
<p>This will let you select a context, list all services defined in this cluster, let you select it from a menu then export is as a Multi-cluster service.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">Enter your choice: <span class="m">9</span>
</span></span><span class="line"><span class="cl">Creating a Multi-cluster service...
</span></span><span class="line"><span class="cl">1<span class="o">)</span> 10.13.90.1
</span></span><span class="line"><span class="cl">2<span class="o">)</span> cluster-1
</span></span><span class="line"><span class="cl">3<span class="o">)</span> ns-stc-1
</span></span><span class="line"><span class="cl">4<span class="o">)</span> Back to Main Menu
</span></span><span class="line"><span class="cl">Select a context to switch to: <span class="m">2</span>
</span></span><span class="line"><span class="cl">Switched to context <span class="s2">&#34;cluster-1&#34;</span>.
</span></span><span class="line"><span class="cl">1<span class="o">)</span> antrea-multicluster		   5<span class="o">)</span> kube-public		     9<span class="o">)</span> vmware-system-antrea	      13<span class="o">)</span> vmware-system-tkg
</span></span><span class="line"><span class="cl">2<span class="o">)</span> default			   6<span class="o">)</span> kube-system		    10<span class="o">)</span> vmware-system-auth	      14<span class="o">)</span> yelb
</span></span><span class="line"><span class="cl">3<span class="o">)</span> fruit			   7<span class="o">)</span> secretgen-controller	    11<span class="o">)</span> vmware-system-cloud-provider  15<span class="o">)</span> Back to Context Menu
</span></span><span class="line"><span class="cl">4<span class="o">)</span> kube-node-lease		   8<span class="o">)</span> tkg-system		    12<span class="o">)</span> vmware-system-csi
</span></span><span class="line"><span class="cl">Select a namespace to list services from: <span class="m">14</span>
</span></span><span class="line"><span class="cl">1<span class="o">)</span> redis-server
</span></span><span class="line"><span class="cl">2<span class="o">)</span> yelb-appserver
</span></span><span class="line"><span class="cl">3<span class="o">)</span> yelb-db
</span></span><span class="line"><span class="cl">4<span class="o">)</span> yelb-ui
</span></span><span class="line"><span class="cl">5<span class="o">)</span> Back to Namespace Menu
</span></span><span class="line"><span class="cl">Select a service to <span class="nb">export</span> as Multi-cluster service: <span class="m">2</span>
</span></span><span class="line"><span class="cl">ServiceExport created <span class="k">for</span> yelb-appserver in namespace yelb.
</span></span><span class="line"><span class="cl">serviceexport.multicluster.x-k8s.io/yelb-appserver unchanged
</span></span><span class="line"><span class="cl">Multi-cluster service applied.
</span></span><span class="line"><span class="cl">Select a service to <span class="nb">export</span> as Multi-cluster service: <span class="c1"># hit enter to bring up menu</span>
</span></span><span class="line"><span class="cl">1<span class="o">)</span> antrea-multicluster		   5<span class="o">)</span> kube-public		     9<span class="o">)</span> vmware-system-antrea	      13<span class="o">)</span> vmware-system-tkg
</span></span><span class="line"><span class="cl">2<span class="o">)</span> default			   6<span class="o">)</span> kube-system		    10<span class="o">)</span> vmware-system-auth	      14<span class="o">)</span> yelb
</span></span><span class="line"><span class="cl">3<span class="o">)</span> fruit			   7<span class="o">)</span> secretgen-controller	    11<span class="o">)</span> vmware-system-cloud-provider  15<span class="o">)</span> Back to Context Menu
</span></span><span class="line"><span class="cl">4<span class="o">)</span> kube-node-lease		   8<span class="o">)</span> tkg-system		    12<span class="o">)</span> vmware-system-csi
</span></span><span class="line"><span class="cl">Select a service to <span class="nb">export</span> as Multi-cluster service: <span class="m">15</span>
</span></span></code></pre></div></li>
</ol>
<p>Here is the script:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="cp">#!/bin/bash
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1"># Function to create member-cluster secrets</span>
</span></span><span class="line"><span class="cl">create_member_cluster_secrets<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;Creating member-cluster secrets...&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># List available contexts and create a menu</span>
</span></span><span class="line"><span class="cl">    <span class="nv">contexts</span><span class="o">=(</span><span class="k">$(</span>kubectl config get-contexts -o<span class="o">=</span>name<span class="k">)</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Display the menu for selecting a context as the leader cluster</span>
</span></span><span class="line"><span class="cl">    <span class="nv">PS3</span><span class="o">=</span><span class="s2">&#34;Select a context as the leader cluster: &#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">select</span> LEADER_CONTEXT in <span class="s2">&#34;</span><span class="si">${</span><span class="nv">contexts</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&#34;</span> <span class="s2">&#34;Back to Main Menu&#34;</span><span class="p">;</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&#34;</span><span class="nv">$LEADER_CONTEXT</span><span class="s2">&#34;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$LEADER_CONTEXT</span><span class="s2">&#34;</span> <span class="o">==</span> <span class="s2">&#34;Back to Main Menu&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">                <span class="nb">break</span>
</span></span><span class="line"><span class="cl">            <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># Set the selected context as the leader cluster context</span>
</span></span><span class="line"><span class="cl">            kubectl config use-context <span class="s2">&#34;</span><span class="nv">$LEADER_CONTEXT</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="nb">read</span> -p <span class="s2">&#34;Enter the name for Member Cluster (e.g., member-blue): &#34;</span> MEMBER_CLUSTER_NAME
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># Create YAML content for the member cluster</span>
</span></span><span class="line"><span class="cl">            cat <span class="s">&lt;&lt;EOF &gt; member-cluster.yml
</span></span></span><span class="line"><span class="cl"><span class="s">apiVersion: v1
</span></span></span><span class="line"><span class="cl"><span class="s">kind: ServiceAccount
</span></span></span><span class="line"><span class="cl"><span class="s">metadata:
</span></span></span><span class="line"><span class="cl"><span class="s">  name: $MEMBER_CLUSTER_NAME
</span></span></span><span class="line"><span class="cl"><span class="s">  namespace: antrea-multicluster
</span></span></span><span class="line"><span class="cl"><span class="s">---
</span></span></span><span class="line"><span class="cl"><span class="s">apiVersion: v1
</span></span></span><span class="line"><span class="cl"><span class="s">kind: Secret
</span></span></span><span class="line"><span class="cl"><span class="s">metadata:
</span></span></span><span class="line"><span class="cl"><span class="s">  name: ${MEMBER_CLUSTER_NAME}-token
</span></span></span><span class="line"><span class="cl"><span class="s">  namespace: antrea-multicluster
</span></span></span><span class="line"><span class="cl"><span class="s">  annotations:
</span></span></span><span class="line"><span class="cl"><span class="s">    kubernetes.io/service-account.name: $MEMBER_CLUSTER_NAME
</span></span></span><span class="line"><span class="cl"><span class="s">type: kubernetes.io/service-account-token
</span></span></span><span class="line"><span class="cl"><span class="s">---
</span></span></span><span class="line"><span class="cl"><span class="s">apiVersion: rbac.authorization.k8s.io/v1
</span></span></span><span class="line"><span class="cl"><span class="s">kind: RoleBinding
</span></span></span><span class="line"><span class="cl"><span class="s">metadata:
</span></span></span><span class="line"><span class="cl"><span class="s">  name: $MEMBER_CLUSTER_NAME
</span></span></span><span class="line"><span class="cl"><span class="s">  namespace: antrea-multicluster
</span></span></span><span class="line"><span class="cl"><span class="s">roleRef:
</span></span></span><span class="line"><span class="cl"><span class="s">  apiGroup: rbac.authorization.k8s.io
</span></span></span><span class="line"><span class="cl"><span class="s">  kind: Role
</span></span></span><span class="line"><span class="cl"><span class="s">  name: antrea-mc-member-cluster-role
</span></span></span><span class="line"><span class="cl"><span class="s">subjects:
</span></span></span><span class="line"><span class="cl"><span class="s">  - kind: ServiceAccount
</span></span></span><span class="line"><span class="cl"><span class="s">    name: $MEMBER_CLUSTER_NAME
</span></span></span><span class="line"><span class="cl"><span class="s">    namespace: antrea-multicluster
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># Apply the YAML content for the member cluster</span>
</span></span><span class="line"><span class="cl">            kubectl apply -f member-cluster.yml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># Create the member cluster secret file</span>
</span></span><span class="line"><span class="cl">            kubectl get secret <span class="si">${</span><span class="nv">MEMBER_CLUSTER_NAME</span><span class="si">}</span>-token -n antrea-multicluster -o yaml <span class="p">|</span> grep -w -e <span class="s1">&#39;^apiVersion&#39;</span> -e <span class="s1">&#39;^data&#39;</span> -e <span class="s1">&#39;^metadata&#39;</span> -e <span class="s1">&#39;^ *name:&#39;</span>  -e   <span class="s1">&#39;^kind&#39;</span> -e <span class="s1">&#39;  ca.crt&#39;</span> -e <span class="s1">&#39;  token:&#39;</span> -e <span class="s1">&#39;^type&#39;</span> -e <span class="s1">&#39;  namespace&#39;</span> <span class="p">|</span> sed -e <span class="s1">&#39;s/kubernetes.io\/service-account-token/Opaque/g&#39;</span> -e <span class="s2">&#34;s/antrea-multicluster/kube-system/g&#34;</span> &gt; <span class="s2">&#34;</span><span class="si">${</span><span class="nv">MEMBER_CLUSTER_NAME</span><span class="si">}</span><span class="s2">-token.yaml&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="nb">echo</span> <span class="s2">&#34;Member cluster secrets created and YAML file generated: </span><span class="si">${</span><span class="nv">MEMBER_CLUSTER_NAME</span><span class="si">}</span><span class="s2">-token.yaml.&#34;</span>
</span></span><span class="line"><span class="cl">            sleep <span class="m">2</span>
</span></span><span class="line"><span class="cl">            <span class="nb">break</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">            <span class="nb">echo</span> <span class="s2">&#34;Invalid selection. Please choose a context or &#39;Back to Main Menu&#39;.&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">fi</span>
</span></span><span class="line"><span class="cl">    <span class="k">done</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Function to apply member tokens</span>
</span></span><span class="line"><span class="cl">apply_member_tokens<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;Applying member tokens...&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># List available contexts and create a menu</span>
</span></span><span class="line"><span class="cl">    <span class="nv">contexts</span><span class="o">=(</span><span class="k">$(</span>kubectl config get-contexts -o<span class="o">=</span>name<span class="k">)</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Display the menu for selecting a context to switch to</span>
</span></span><span class="line"><span class="cl">    <span class="nv">PS3</span><span class="o">=</span><span class="s2">&#34;Select a context to switch to: &#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">select</span> SWITCH_CONTEXT in <span class="s2">&#34;</span><span class="si">${</span><span class="nv">contexts</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&#34;</span> <span class="s2">&#34;Back to Main Menu&#34;</span><span class="p">;</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&#34;</span><span class="nv">$SWITCH_CONTEXT</span><span class="s2">&#34;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$SWITCH_CONTEXT</span><span class="s2">&#34;</span> <span class="o">==</span> <span class="s2">&#34;Back to Main Menu&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">                <span class="nb">break</span>
</span></span><span class="line"><span class="cl">            <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            kubectl config use-context <span class="s2">&#34;</span><span class="nv">$SWITCH_CONTEXT</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># List YAML files in the current folder and create a menu</span>
</span></span><span class="line"><span class="cl">            <span class="nv">yaml_files</span><span class="o">=(</span><span class="k">$(</span>ls *.yaml<span class="k">)</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># Display the menu for selecting a YAML file to apply</span>
</span></span><span class="line"><span class="cl">            <span class="nv">PS3</span><span class="o">=</span><span class="s2">&#34;Select a YAML file to apply: &#34;</span>
</span></span><span class="line"><span class="cl">            <span class="k">select</span> SELECTED_YAML in <span class="s2">&#34;</span><span class="si">${</span><span class="nv">yaml_files</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&#34;</span> <span class="s2">&#34;Back to Main Menu&#34;</span><span class="p">;</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&#34;</span><span class="nv">$SELECTED_YAML</span><span class="s2">&#34;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$SELECTED_YAML</span><span class="s2">&#34;</span> <span class="o">==</span> <span class="s2">&#34;Back to Main Menu&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">                        <span class="nb">break</span>
</span></span><span class="line"><span class="cl">                    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                    kubectl apply -f <span class="s2">&#34;</span><span class="nv">$SELECTED_YAML</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                    <span class="nb">echo</span> <span class="s2">&#34;Applied </span><span class="nv">$SELECTED_YAML</span><span class="s2"> in context </span><span class="nv">$SWITCH_CONTEXT</span><span class="s2">.&#34;</span>
</span></span><span class="line"><span class="cl">                    sleep <span class="m">2</span>
</span></span><span class="line"><span class="cl">                    <span class="nb">break</span>
</span></span><span class="line"><span class="cl">                <span class="k">else</span>
</span></span><span class="line"><span class="cl">                    <span class="nb">echo</span> <span class="s2">&#34;Invalid selection. Please choose a YAML file or &#39;Back to Main Menu&#39;.&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="k">fi</span>
</span></span><span class="line"><span class="cl">            <span class="k">done</span>
</span></span><span class="line"><span class="cl">            <span class="nb">break</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">            <span class="nb">echo</span> <span class="s2">&#34;Invalid selection. Please choose a context or &#39;Back to Main Menu&#39;.&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">fi</span>
</span></span><span class="line"><span class="cl">    <span class="k">done</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Function to create ClusterSet on the leader cluster</span>
</span></span><span class="line"><span class="cl">create_clusterset_on_leader<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;Creating ClusterSet on the leader cluster...&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># List available contexts and create a menu</span>
</span></span><span class="line"><span class="cl">    <span class="nv">contexts</span><span class="o">=(</span><span class="k">$(</span>kubectl config get-contexts -o<span class="o">=</span>name<span class="k">)</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Display the menu for selecting the leader cluster context</span>
</span></span><span class="line"><span class="cl">    <span class="nv">PS3</span><span class="o">=</span><span class="s2">&#34;Select the leader cluster context: &#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">select</span> LEADER_CONTEXT in <span class="s2">&#34;</span><span class="si">${</span><span class="nv">contexts</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&#34;</span> <span class="s2">&#34;Back to Main Menu&#34;</span><span class="p">;</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&#34;</span><span class="nv">$LEADER_CONTEXT</span><span class="s2">&#34;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$LEADER_CONTEXT</span><span class="s2">&#34;</span> <span class="o">==</span> <span class="s2">&#34;Back to Main Menu&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">                <span class="nb">break</span>
</span></span><span class="line"><span class="cl">            <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            kubectl config use-context <span class="s2">&#34;</span><span class="nv">$LEADER_CONTEXT</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># Prompt for ClusterID and ClusterSet name</span>
</span></span><span class="line"><span class="cl">            <span class="nb">read</span> -p <span class="s2">&#34;Enter ClusterID (e.g., tkg-cluster-leader): &#34;</span> CLUSTER_ID
</span></span><span class="line"><span class="cl">            <span class="nb">read</span> -p <span class="s2">&#34;Enter ClusterSet name (e.g., andreasm-clusterset): &#34;</span> CLUSTERSET_NAME
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># Create YAML content for ClusterSet</span>
</span></span><span class="line"><span class="cl">            cat <span class="s">&lt;&lt;EOF &gt; clusterset.yaml
</span></span></span><span class="line"><span class="cl"><span class="s">apiVersion: multicluster.crd.antrea.io/v1alpha2
</span></span></span><span class="line"><span class="cl"><span class="s">kind: ClusterClaim
</span></span></span><span class="line"><span class="cl"><span class="s">metadata:
</span></span></span><span class="line"><span class="cl"><span class="s">  name: id.k8s.io
</span></span></span><span class="line"><span class="cl"><span class="s">  namespace: antrea-multicluster
</span></span></span><span class="line"><span class="cl"><span class="s">value: $CLUSTER_ID
</span></span></span><span class="line"><span class="cl"><span class="s">---
</span></span></span><span class="line"><span class="cl"><span class="s">apiVersion: multicluster.crd.antrea.io/v1alpha2
</span></span></span><span class="line"><span class="cl"><span class="s">kind: ClusterClaim
</span></span></span><span class="line"><span class="cl"><span class="s">metadata:
</span></span></span><span class="line"><span class="cl"><span class="s">  name: clusterset.k8s.io
</span></span></span><span class="line"><span class="cl"><span class="s">  namespace: antrea-multicluster
</span></span></span><span class="line"><span class="cl"><span class="s">value: $CLUSTERSET_NAME
</span></span></span><span class="line"><span class="cl"><span class="s">---
</span></span></span><span class="line"><span class="cl"><span class="s">apiVersion: multicluster.crd.antrea.io/v1alpha1
</span></span></span><span class="line"><span class="cl"><span class="s">kind: ClusterSet
</span></span></span><span class="line"><span class="cl"><span class="s">metadata:
</span></span></span><span class="line"><span class="cl"><span class="s">  name: $CLUSTERSET_NAME
</span></span></span><span class="line"><span class="cl"><span class="s">  namespace: antrea-multicluster
</span></span></span><span class="line"><span class="cl"><span class="s">spec:
</span></span></span><span class="line"><span class="cl"><span class="s">  leaders:
</span></span></span><span class="line"><span class="cl"><span class="s">    - clusterID: $CLUSTER_ID
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># Apply the ClusterSet YAML</span>
</span></span><span class="line"><span class="cl">            kubectl apply -f clusterset.yaml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="nb">echo</span> <span class="s2">&#34;ClusterSet created on the leader cluster.&#34;</span>
</span></span><span class="line"><span class="cl">            sleep <span class="m">2</span>
</span></span><span class="line"><span class="cl">            <span class="nb">break</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">            <span class="nb">echo</span> <span class="s2">&#34;Invalid selection. Please choose a context or &#39;Back to Main Menu&#39;.&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">fi</span>
</span></span><span class="line"><span class="cl">    <span class="k">done</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Function to create ClusterClaim on member cluster</span>
</span></span><span class="line"><span class="cl">create_clusterclaim_on_member<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;Creating ClusterClaim on member cluster...&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># List available contexts and create a menu</span>
</span></span><span class="line"><span class="cl">    <span class="nv">contexts</span><span class="o">=(</span><span class="k">$(</span>kubectl config get-contexts -o<span class="o">=</span>name<span class="k">)</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Display the menu for selecting a context to switch to</span>
</span></span><span class="line"><span class="cl">    <span class="nv">PS3</span><span class="o">=</span><span class="s2">&#34;Select a context to switch to: &#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">select</span> MEMBER_CONTEXT in <span class="s2">&#34;</span><span class="si">${</span><span class="nv">contexts</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&#34;</span> <span class="s2">&#34;Back to Main Menu&#34;</span><span class="p">;</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&#34;</span><span class="nv">$MEMBER_CONTEXT</span><span class="s2">&#34;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$MEMBER_CONTEXT</span><span class="s2">&#34;</span> <span class="o">==</span> <span class="s2">&#34;Back to Main Menu&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">                <span class="nb">break</span>
</span></span><span class="line"><span class="cl">            <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            kubectl config use-context <span class="s2">&#34;</span><span class="nv">$MEMBER_CONTEXT</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># Prompt for ClusterClaim values</span>
</span></span><span class="line"><span class="cl">            <span class="nb">read</span> -p <span class="s2">&#34;Enter member-cluster-name (e.g., member-cluster-red): &#34;</span> MEMBER_CLUSTER_NAME
</span></span><span class="line"><span class="cl">            <span class="nb">read</span> -p <span class="s2">&#34;Enter ClusterSet name (e.g., andreasm-clusterset): &#34;</span> CLUSTERSET_NAME
</span></span><span class="line"><span class="cl">            <span class="nb">read</span> -p <span class="s2">&#34;Enter Leader ClusterID (e.g., tkg-cluster-leader): &#34;</span> LEADER_CLUSTER_ID
</span></span><span class="line"><span class="cl">            <span class="nb">read</span> -p <span class="s2">&#34;Enter Member Token to use: &#34;</span> MEMBER_TOKEN
</span></span><span class="line"><span class="cl">            <span class="nb">read</span> -p <span class="s2">&#34;Enter Leader cluster API endpoint (e.g., https://10.101.114.100:6443): &#34;</span> LEADER_ENDPOINT
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># Create YAML content for ClusterClaim</span>
</span></span><span class="line"><span class="cl">            cat <span class="s">&lt;&lt;EOF &gt; &#34;${MEMBER_CLUSTER_NAME}-clusterclaim.yaml&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">apiVersion: multicluster.crd.antrea.io/v1alpha2
</span></span></span><span class="line"><span class="cl"><span class="s">kind: ClusterClaim
</span></span></span><span class="line"><span class="cl"><span class="s">metadata:
</span></span></span><span class="line"><span class="cl"><span class="s">  name: id.k8s.io
</span></span></span><span class="line"><span class="cl"><span class="s">  namespace: kube-system
</span></span></span><span class="line"><span class="cl"><span class="s">value: $MEMBER_CLUSTER_NAME
</span></span></span><span class="line"><span class="cl"><span class="s">---
</span></span></span><span class="line"><span class="cl"><span class="s">apiVersion: multicluster.crd.antrea.io/v1alpha2
</span></span></span><span class="line"><span class="cl"><span class="s">kind: ClusterClaim
</span></span></span><span class="line"><span class="cl"><span class="s">metadata:
</span></span></span><span class="line"><span class="cl"><span class="s">  name: clusterset.k8s.io
</span></span></span><span class="line"><span class="cl"><span class="s">  namespace: kube-system
</span></span></span><span class="line"><span class="cl"><span class="s">value: $CLUSTERSET_NAME
</span></span></span><span class="line"><span class="cl"><span class="s">---
</span></span></span><span class="line"><span class="cl"><span class="s">apiVersion: multicluster.crd.antrea.io/v1alpha1
</span></span></span><span class="line"><span class="cl"><span class="s">kind: ClusterSet
</span></span></span><span class="line"><span class="cl"><span class="s">metadata:
</span></span></span><span class="line"><span class="cl"><span class="s">  name: $CLUSTERSET_NAME
</span></span></span><span class="line"><span class="cl"><span class="s">  namespace: kube-system
</span></span></span><span class="line"><span class="cl"><span class="s">spec:
</span></span></span><span class="line"><span class="cl"><span class="s">  leaders:
</span></span></span><span class="line"><span class="cl"><span class="s">    - clusterID: $LEADER_CLUSTER_ID
</span></span></span><span class="line"><span class="cl"><span class="s">      secret: &#34;$MEMBER_TOKEN&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">      server: &#34;$LEADER_ENDPOINT&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">  namespace: antrea-multicluster
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># Apply the ClusterClaim YAML</span>
</span></span><span class="line"><span class="cl">            kubectl apply -f <span class="s2">&#34;</span><span class="si">${</span><span class="nv">MEMBER_CLUSTER_NAME</span><span class="si">}</span><span class="s2">-clusterclaim.yaml&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="nb">echo</span> <span class="s2">&#34;ClusterClaim created on member cluster.&#34;</span>
</span></span><span class="line"><span class="cl">            sleep <span class="m">2</span>
</span></span><span class="line"><span class="cl">            <span class="nb">break</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">            <span class="nb">echo</span> <span class="s2">&#34;Invalid selection. Please choose a context or &#39;Back to Main Menu&#39;.&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">fi</span>
</span></span><span class="line"><span class="cl">    <span class="k">done</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Function to create Multi-cluster Gateway</span>
</span></span><span class="line"><span class="cl">create_multi_cluster_gateway<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;Creating Multi-cluster Gateway...&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># List available contexts and create a menu</span>
</span></span><span class="line"><span class="cl">    <span class="nv">contexts</span><span class="o">=(</span><span class="k">$(</span>kubectl config get-contexts -o<span class="o">=</span>name<span class="k">)</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Display the menu for selecting a context to switch to</span>
</span></span><span class="line"><span class="cl">    <span class="nv">PS3</span><span class="o">=</span><span class="s2">&#34;Select a context to switch to: &#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">select</span> GATEWAY_CONTEXT in <span class="s2">&#34;</span><span class="si">${</span><span class="nv">contexts</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&#34;</span> <span class="s2">&#34;Back to Main Menu&#34;</span><span class="p">;</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&#34;</span><span class="nv">$GATEWAY_CONTEXT</span><span class="s2">&#34;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$GATEWAY_CONTEXT</span><span class="s2">&#34;</span> <span class="o">==</span> <span class="s2">&#34;Back to Main Menu&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">                <span class="nb">break</span>
</span></span><span class="line"><span class="cl">            <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            kubectl config use-context <span class="s2">&#34;</span><span class="nv">$GATEWAY_CONTEXT</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">while</span> true<span class="p">;</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># List nodes and create a menu</span>
</span></span><span class="line"><span class="cl">                <span class="nv">nodes</span><span class="o">=(</span><span class="k">$(</span>kubectl get nodes -o custom-columns<span class="o">=</span>NAME:.metadata.name --no-headers<span class="k">)</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="c1"># Display the menu for selecting a node to annotate</span>
</span></span><span class="line"><span class="cl">                <span class="nv">PS3</span><span class="o">=</span><span class="s2">&#34;Select a node to annotate as Multi-cluster Gateway: &#34;</span>
</span></span><span class="line"><span class="cl">                <span class="k">select</span> SELECTED_NODE in <span class="s2">&#34;</span><span class="si">${</span><span class="nv">nodes</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&#34;</span> <span class="s2">&#34;Back to Context Menu&#34;</span><span class="p">;</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&#34;</span><span class="nv">$SELECTED_NODE</span><span class="s2">&#34;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$SELECTED_NODE</span><span class="s2">&#34;</span> <span class="o">==</span> <span class="s2">&#34;Back to Context Menu&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">                            <span class="nb">break</span>
</span></span><span class="line"><span class="cl">                        <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                        <span class="c1"># Annotate the selected node</span>
</span></span><span class="line"><span class="cl">                        kubectl annotate node <span class="s2">&#34;</span><span class="nv">$SELECTED_NODE</span><span class="s2">&#34;</span> multicluster.antrea.io/gateway<span class="o">=</span><span class="nb">true</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                        <span class="nb">echo</span> <span class="s2">&#34;Annotated </span><span class="nv">$SELECTED_NODE</span><span class="s2"> as Multi-cluster Gateway.&#34;</span>
</span></span><span class="line"><span class="cl">                        sleep <span class="m">2</span>
</span></span><span class="line"><span class="cl">                    <span class="k">else</span>
</span></span><span class="line"><span class="cl">                        <span class="nb">echo</span> <span class="s2">&#34;Invalid selection. Please choose a node or &#39;Back to Context Menu&#39;.&#34;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">                <span class="k">done</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="nb">read</span> -p <span class="s2">&#34;Do you want to annotate another node? (yes/no): &#34;</span> ANNOTATE_ANOTHER
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$ANNOTATE_ANOTHER</span><span class="s2">&#34;</span> !<span class="o">=</span> <span class="s2">&#34;yes&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">                    <span class="nb">break</span>
</span></span><span class="line"><span class="cl">                <span class="k">fi</span>
</span></span><span class="line"><span class="cl">            <span class="k">done</span>
</span></span><span class="line"><span class="cl">            <span class="nb">break</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">            <span class="nb">echo</span> <span class="s2">&#34;Invalid selection. Please choose a context or &#39;Back to Main Menu&#39;.&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">fi</span>
</span></span><span class="line"><span class="cl">    <span class="k">done</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Function to create a Multi-cluster service</span>
</span></span><span class="line"><span class="cl">create_multi_cluster_service<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;Creating a Multi-cluster service...&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># List available contexts and create a menu</span>
</span></span><span class="line"><span class="cl">    <span class="nv">contexts</span><span class="o">=(</span><span class="k">$(</span>kubectl config get-contexts -o<span class="o">=</span>name<span class="k">)</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Display the menu for selecting a context to switch to</span>
</span></span><span class="line"><span class="cl">    <span class="nv">PS3</span><span class="o">=</span><span class="s2">&#34;Select a context to switch to: &#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">select</span> SELECT_CONTEXT in <span class="s2">&#34;</span><span class="si">${</span><span class="nv">contexts</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&#34;</span> <span class="s2">&#34;Back to Main Menu&#34;</span><span class="p">;</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&#34;</span><span class="nv">$SELECT_CONTEXT</span><span class="s2">&#34;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$SELECT_CONTEXT</span><span class="s2">&#34;</span> <span class="o">==</span> <span class="s2">&#34;Back to Main Menu&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">                <span class="nb">break</span>
</span></span><span class="line"><span class="cl">            <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            kubectl config use-context <span class="s2">&#34;</span><span class="nv">$SELECT_CONTEXT</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># List namespaces and create a menu</span>
</span></span><span class="line"><span class="cl">            <span class="nv">namespaces</span><span class="o">=(</span><span class="k">$(</span>kubectl get namespaces -o custom-columns<span class="o">=</span>NAME:.metadata.name --no-headers<span class="k">)</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># Display the menu for selecting a namespace</span>
</span></span><span class="line"><span class="cl">            <span class="nv">PS3</span><span class="o">=</span><span class="s2">&#34;Select a namespace to list services from: &#34;</span>
</span></span><span class="line"><span class="cl">            <span class="k">select</span> SELECTED_NAMESPACE in <span class="s2">&#34;</span><span class="si">${</span><span class="nv">namespaces</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&#34;</span> <span class="s2">&#34;Back to Context Menu&#34;</span><span class="p">;</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&#34;</span><span class="nv">$SELECTED_NAMESPACE</span><span class="s2">&#34;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$SELECTED_NAMESPACE</span><span class="s2">&#34;</span> <span class="o">==</span> <span class="s2">&#34;Back to Context Menu&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">                        <span class="nb">break</span>
</span></span><span class="line"><span class="cl">                    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                    <span class="c1"># List services in the selected namespace and create a menu</span>
</span></span><span class="line"><span class="cl">                    <span class="nv">services</span><span class="o">=(</span><span class="k">$(</span>kubectl get services -n <span class="s2">&#34;</span><span class="nv">$SELECTED_NAMESPACE</span><span class="s2">&#34;</span> -o custom-columns<span class="o">=</span>NAME:.metadata.name --no-headers<span class="k">)</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                    <span class="c1"># Display the menu for selecting a service</span>
</span></span><span class="line"><span class="cl">                    <span class="nv">PS3</span><span class="o">=</span><span class="s2">&#34;Select a service to export as Multi-cluster service: &#34;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">select</span> SELECTED_SERVICE in <span class="s2">&#34;</span><span class="si">${</span><span class="nv">services</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&#34;</span> <span class="s2">&#34;Back to Namespace Menu&#34;</span><span class="p">;</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&#34;</span><span class="nv">$SELECTED_SERVICE</span><span class="s2">&#34;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">                            <span class="k">if</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$SELECTED_SERVICE</span><span class="s2">&#34;</span> <span class="o">==</span> <span class="s2">&#34;Back to Namespace Menu&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">                                <span class="nb">break</span>
</span></span><span class="line"><span class="cl">                            <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                            <span class="c1"># Create YAML content for ServiceExport</span>
</span></span><span class="line"><span class="cl">                            cat <span class="s">&lt;&lt;EOF &gt; &#34;${SELECTED_SERVICE}-multi-cluster-service.yaml&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">apiVersion: multicluster.x-k8s.io/v1alpha1
</span></span></span><span class="line"><span class="cl"><span class="s">kind: ServiceExport
</span></span></span><span class="line"><span class="cl"><span class="s">metadata:
</span></span></span><span class="line"><span class="cl"><span class="s">  name: $SELECTED_SERVICE
</span></span></span><span class="line"><span class="cl"><span class="s">  namespace: $SELECTED_NAMESPACE
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                            <span class="nb">echo</span> <span class="s2">&#34;ServiceExport created for </span><span class="nv">$SELECTED_SERVICE</span><span class="s2"> in namespace </span><span class="nv">$SELECTED_NAMESPACE</span><span class="s2">.&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                            <span class="c1"># Apply the Multi-cluster service</span>
</span></span><span class="line"><span class="cl">                            kubectl apply -f <span class="s2">&#34;</span><span class="si">${</span><span class="nv">SELECTED_SERVICE</span><span class="si">}</span><span class="s2">-multi-cluster-service.yaml&#34;</span>
</span></span><span class="line"><span class="cl">                            <span class="nb">echo</span> <span class="s2">&#34;Multi-cluster service applied.&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                            sleep <span class="m">2</span>
</span></span><span class="line"><span class="cl">                            <span class="nb">break</span>
</span></span><span class="line"><span class="cl">                        <span class="k">else</span>
</span></span><span class="line"><span class="cl">                            <span class="nb">echo</span> <span class="s2">&#34;Invalid selection. Please choose a service or &#39;Back to Namespace Menu&#39;.&#34;</span>
</span></span><span class="line"><span class="cl">                        <span class="k">fi</span>
</span></span><span class="line"><span class="cl">                    <span class="k">done</span>
</span></span><span class="line"><span class="cl">                <span class="k">else</span>
</span></span><span class="line"><span class="cl">                    <span class="nb">echo</span> <span class="s2">&#34;Invalid selection. Please choose a namespace or &#39;Back to Context Menu&#39;.&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="k">fi</span>
</span></span><span class="line"><span class="cl">            <span class="k">done</span>
</span></span><span class="line"><span class="cl">            <span class="nb">break</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">            <span class="nb">echo</span> <span class="s2">&#34;Invalid selection. Please choose a context or &#39;Back to Main Menu&#39;.&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">fi</span>
</span></span><span class="line"><span class="cl">    <span class="k">done</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Main menu</span>
</span></span><span class="line"><span class="cl"><span class="k">while</span> true<span class="p">;</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">    clear
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;Main Menu:&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;1. Select Antrea version&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;2. Install Antrea Multi-cluster on leader cluster&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;3. Install Antrea Multi-cluster on member cluster&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;4. Create member-cluster secrets&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;5. Apply member tokens&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;6. Create ClusterSet on the leader cluster&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;7. Create ClusterClaim on member cluster&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;8. Create Multi-cluster Gateway&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;9. Create a Multi-cluster service&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;10. Exit&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">read</span> -p <span class="s2">&#34;Enter your choice: &#34;</span> choice
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nv">$choice</span> in
</span></span><span class="line"><span class="cl">        1<span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="nb">read</span> -p <span class="s2">&#34;Enter Antrea version (e.g., v1.11.1): &#34;</span> TAG
</span></span><span class="line"><span class="cl">            <span class="p">;;</span>
</span></span><span class="line"><span class="cl">        2<span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="nb">echo</span> <span class="s2">&#34;Installing Antrea Multi-cluster on leader cluster...&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># List available contexts and create a menu</span>
</span></span><span class="line"><span class="cl">            <span class="nv">contexts</span><span class="o">=(</span><span class="k">$(</span>kubectl config get-contexts -o<span class="o">=</span>name<span class="k">)</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># Display the menu</span>
</span></span><span class="line"><span class="cl">            <span class="nv">PS3</span><span class="o">=</span><span class="s2">&#34;Select a context to switch to: &#34;</span>
</span></span><span class="line"><span class="cl">            <span class="k">select</span> SWITCH_CONTEXT in <span class="s2">&#34;</span><span class="si">${</span><span class="nv">contexts</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&#34;</span> <span class="s2">&#34;Back to Main Menu&#34;</span><span class="p">;</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&#34;</span><span class="nv">$SWITCH_CONTEXT</span><span class="s2">&#34;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$SWITCH_CONTEXT</span><span class="s2">&#34;</span> <span class="o">==</span> <span class="s2">&#34;Back to Main Menu&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">                        <span class="nb">break</span>
</span></span><span class="line"><span class="cl">                    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                    kubectl config use-context <span class="s2">&#34;</span><span class="nv">$SWITCH_CONTEXT</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                    <span class="c1"># Create namespace if it does not exist</span>
</span></span><span class="line"><span class="cl">                    kubectl create namespace antrea-multicluster --dry-run<span class="o">=</span>client -o yaml <span class="p">|</span> kubectl apply -f -
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                    <span class="c1"># Apply leader cluster YAMLs</span>
</span></span><span class="line"><span class="cl">                    kubectl apply -f <span class="s2">&#34;https://github.com/antrea-io/antrea/releases/download/</span><span class="nv">$TAG</span><span class="s2">/antrea-multicluster-leader-global.yml&#34;</span>
</span></span><span class="line"><span class="cl">                    kubectl apply -f <span class="s2">&#34;https://github.com/antrea-io/antrea/releases/download/</span><span class="nv">$TAG</span><span class="s2">/antrea-multicluster-leader-namespaced.yml&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                    <span class="nb">echo</span> <span class="s2">&#34;Antrea Multi-cluster installed on leader cluster.&#34;</span>
</span></span><span class="line"><span class="cl">                    sleep <span class="m">2</span>
</span></span><span class="line"><span class="cl">                    <span class="nb">break</span>
</span></span><span class="line"><span class="cl">                <span class="k">else</span>
</span></span><span class="line"><span class="cl">                    <span class="nb">echo</span> <span class="s2">&#34;Invalid selection. Please choose a context or &#39;Back to Main Menu&#39;.&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="k">fi</span>
</span></span><span class="line"><span class="cl">            <span class="k">done</span>
</span></span><span class="line"><span class="cl">            <span class="p">;;</span>
</span></span><span class="line"><span class="cl">        3<span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="nb">echo</span> <span class="s2">&#34;Installing Antrea Multi-cluster on member cluster...&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># List available contexts and create a menu</span>
</span></span><span class="line"><span class="cl">            <span class="nv">contexts</span><span class="o">=(</span><span class="k">$(</span>kubectl config get-contexts -o<span class="o">=</span>name<span class="k">)</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># Display the menu</span>
</span></span><span class="line"><span class="cl">            <span class="nv">PS3</span><span class="o">=</span><span class="s2">&#34;Select a context to switch to: &#34;</span>
</span></span><span class="line"><span class="cl">            <span class="k">select</span> SWITCH_CONTEXT in <span class="s2">&#34;</span><span class="si">${</span><span class="nv">contexts</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&#34;</span> <span class="s2">&#34;Back to Main Menu&#34;</span><span class="p">;</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&#34;</span><span class="nv">$SWITCH_CONTEXT</span><span class="s2">&#34;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$SWITCH_CONTEXT</span><span class="s2">&#34;</span> <span class="o">==</span> <span class="s2">&#34;Back to Main Menu&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">                        <span class="nb">break</span>
</span></span><span class="line"><span class="cl">                    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                    kubectl config use-context <span class="s2">&#34;</span><span class="nv">$SWITCH_CONTEXT</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                    <span class="c1"># Apply member cluster YAML</span>
</span></span><span class="line"><span class="cl">                    kubectl apply -f <span class="s2">&#34;https://github.com/antrea-io/antrea/releases/download/</span><span class="nv">$TAG</span><span class="s2">/antrea-multicluster-member.yml&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                    <span class="nb">echo</span> <span class="s2">&#34;Antrea Multi-cluster installed on member cluster.&#34;</span>
</span></span><span class="line"><span class="cl">                    sleep <span class="m">2</span>
</span></span><span class="line"><span class="cl">                    <span class="nb">break</span>
</span></span><span class="line"><span class="cl">                <span class="k">else</span>
</span></span><span class="line"><span class="cl">                    <span class="nb">echo</span> <span class="s2">&#34;Invalid selection. Please choose a context or &#39;Back to Main Menu&#39;.&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="k">fi</span>
</span></span><span class="line"><span class="cl">            <span class="k">done</span>
</span></span><span class="line"><span class="cl">            <span class="p">;;</span>
</span></span><span class="line"><span class="cl">        4<span class="o">)</span>
</span></span><span class="line"><span class="cl">            create_member_cluster_secrets
</span></span><span class="line"><span class="cl">            <span class="p">;;</span>
</span></span><span class="line"><span class="cl">        5<span class="o">)</span>
</span></span><span class="line"><span class="cl">            apply_member_tokens
</span></span><span class="line"><span class="cl">            <span class="p">;;</span>
</span></span><span class="line"><span class="cl">        6<span class="o">)</span>
</span></span><span class="line"><span class="cl">            create_clusterset_on_leader
</span></span><span class="line"><span class="cl">            <span class="p">;;</span>
</span></span><span class="line"><span class="cl">        7<span class="o">)</span>
</span></span><span class="line"><span class="cl">            create_clusterclaim_on_member
</span></span><span class="line"><span class="cl">            <span class="p">;;</span>
</span></span><span class="line"><span class="cl">        8<span class="o">)</span>
</span></span><span class="line"><span class="cl">            create_multi_cluster_gateway
</span></span><span class="line"><span class="cl">            <span class="p">;;</span>
</span></span><span class="line"><span class="cl">        9<span class="o">)</span>
</span></span><span class="line"><span class="cl">            create_multi_cluster_service
</span></span><span class="line"><span class="cl">            <span class="p">;;</span>
</span></span><span class="line"><span class="cl">        10<span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="nb">echo</span> <span class="s2">&#34;Exiting...&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="nb">exit</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">            <span class="p">;;</span>
</span></span><span class="line"><span class="cl">        *<span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="nb">echo</span> <span class="s2">&#34;Invalid choice. Please choose a valid option.&#34;</span>
</span></span><span class="line"><span class="cl">            sleep <span class="m">2</span>
</span></span><span class="line"><span class="cl">            <span class="p">;;</span>
</span></span><span class="line"><span class="cl">    <span class="k">esac</span>
</span></span><span class="line"><span class="cl"><span class="k">done</span>
</span></span></code></pre></div><p>Thats it for this post. Thanks for reading.</p>

          
          
          
        </div>
        
        

        
        
  
  <section class="flex flex-row flex-wrap justify-center pt-4 text-xl">
    
      
      <a
      target="_blank"
      class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800"
      href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://blog.andreasm.io/2023/09/25/antrea-multi-cluster-in-tkg-and-vsphere-with-tanzu/&amp;title=Antrea%20Multi-cluster%20-%20in%20TKG%20and%20vSphere%20with%20Tanzu"
      title="Share on LinkedIn"
      aria-label="Share on LinkedIn"
      >
      

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg>

  </span>


    </a>
      
    
      
      <a
      target="_blank"
      class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800"
      href="https://twitter.com/intent/tweet/?url=https://blog.andreasm.io/2023/09/25/antrea-multi-cluster-in-tkg-and-vsphere-with-tanzu/&amp;text=Antrea%20Multi-cluster%20-%20in%20TKG%20and%20vSphere%20with%20Tanzu"
      title="Tweet on Twitter"
      aria-label="Tweet on Twitter"
      >
      

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8L200.7 275.5 26.8 48H172.4L272.9 180.9 389.2 48zM364.4 421.8h39.1L151.1 88h-42L364.4 421.8z"/></svg>
  </span>


    </a>
      
    
      
      <a
      target="_blank"
      class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800"
      href="https://s2f.kytta.dev/?text=Antrea%20Multi-cluster%20-%20in%20TKG%20and%20vSphere%20with%20Tanzu%20https://blog.andreasm.io/2023/09/25/antrea-multi-cluster-in-tkg-and-vsphere-with-tanzu/"
      title=""
      aria-label=""
      >
      

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48 0 0 0-63.72 28.5-63.72 125.7 0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54 0 0 1-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"/></svg>

  </span>


    </a>
      
    
      
      <a
      target="_blank"
      class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800"
      href="mailto:?body=https://blog.andreasm.io/2023/09/25/antrea-multi-cluster-in-tkg-and-vsphere-with-tanzu/&amp;subject=Antrea%20Multi-cluster%20-%20in%20TKG%20and%20vSphere%20with%20Tanzu"
      title="Send via email"
      aria-label="Send via email"
      >
      

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M207.8 20.73c-93.45 18.32-168.7 93.66-187 187.1c-27.64 140.9 68.65 266.2 199.1 285.1c19.01 2.888 36.17-12.26 36.17-31.49l.0001-.6631c0-15.74-11.44-28.88-26.84-31.24c-84.35-12.98-149.2-86.13-149.2-174.2c0-102.9 88.61-185.5 193.4-175.4c91.54 8.869 158.6 91.25 158.6 183.2l0 16.16c0 22.09-17.94 40.05-40 40.05s-40.01-17.96-40.01-40.05v-120.1c0-8.847-7.161-16.02-16.01-16.02l-31.98 .0036c-7.299 0-13.2 4.992-15.12 11.68c-24.85-12.15-54.24-16.38-86.06-5.106c-38.75 13.73-68.12 48.91-73.72 89.64c-9.483 69.01 43.81 128 110.9 128c26.44 0 50.43-9.544 69.59-24.88c24 31.3 65.23 48.69 109.4 37.49C465.2 369.3 496 324.1 495.1 277.2V256.3C495.1 107.1 361.2-9.332 207.8 20.73zM239.1 304.3c-26.47 0-48-21.56-48-48.05s21.53-48.05 48-48.05s48 21.56 48 48.05S266.5 304.3 239.1 304.3z"/></svg>

  </span>


    </a>
      
    
  </section>


        


<h2 class="mt-8 text-2xl font-extrabold mb-10">Related</h2>
<section class="w-full grid gap-4 sm:grid-cols-2 md:grid-cols-3">
  
  

  <a href="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/" class="min-w-full">
    
    <div class="min-h-full border border-neutral-200 dark:border-neutral-700 border-2 rounded overflow-hidden shadow-2xl relative">
        
        <div class="w-full thumbnail_card_related nozoom" style="background-image:url(/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/feature-antrea-1.png);"></div>
        
      

      <div class="px-6 py-4">

        
        <div class="font-bold text-xl text-neutral-800 decoration-primary-500 hover:underline hover:underline-offset-2 dark:text-neutral"
          href="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/">Securing Kubernetes clusters with Antrea Network Policies</div>
        

        <div class="text-sm text-neutral-500 dark:text-neutral-400">
          











  





  



  













<div class="flex flex-row flex-wrap items-center">
  
  
  <time datetime="2023-06-21T10:01:46&#43;02:00">21 June 2023</time><span class="px-2 text-primary-500">&middot;</span><span>6048 words</span><span class="px-2 text-primary-500">&middot;</span><span title="Reading time">29 mins</span>
  

  
  
</div>


<div class="flex flex-row flex-wrap items-center">
  
  
  
  
  
  
  
  
  
  
  
</div>




<div class="flex flex-row flex-wrap items-center">
  
  
  
  
  
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/kubernetes/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Kubernetes
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/cni/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    CNI
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/antrea/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Antrea
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/security/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Security
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/tmc/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    TMC
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/tanzu-mission-control/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Tanzu Mission Control
  </span>
</span>
  </span>
  
  
  
  
  
  
  
  
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/security/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Security
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/cni/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Cni
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/kubernetes/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Kubernetes
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/antrea/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Antrea
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/tmc/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Tmc
  </span>
</span>
  </span>
  
  
  
  
</div>




        </div>

        
        <div class="py-1 prose dark:prose-invert">
          In this post I will go through how to utilize Antrea Network policies with Tanzu Mission Control and a little bit NSX. So jump in and hopefully get some ideas how what we can do with Antrea Network Policies and how to use them.
        </div>
        
      </div>
      <div class="px-6 pt-4 pb-2">

      </div>
    </div>
  </a>

  
  

  <a href="/2024/04/16/exploring-some-antrea-features/" class="min-w-full">
    
    <div class="min-h-full border border-neutral-200 dark:border-neutral-700 border-2 rounded overflow-hidden shadow-2xl relative">
        
        <div class="w-full thumbnail_card_related nozoom" style="background-image:url(/2024/04/16/exploring-some-antrea-features/feature-antrea-1.png);"></div>
        
      

      <div class="px-6 py-4">

        
        <div class="font-bold text-xl text-neutral-800 decoration-primary-500 hover:underline hover:underline-offset-2 dark:text-neutral"
          href="/2024/04/16/exploring-some-antrea-features/">Exploring some Antrea Features</div>
        

        <div class="text-sm text-neutral-500 dark:text-neutral-400">
          











  





  



  













<div class="flex flex-row flex-wrap items-center">
  
  
  <time datetime="2024-04-16T09:25:28&#43;02:00">16 April 2024</time><span class="px-2 text-primary-500">&middot;</span><span>6097 words</span><span class="px-2 text-primary-500">&middot;</span><span title="Reading time">29 mins</span>
  

  
  
</div>


<div class="flex flex-row flex-wrap items-center">
  
  
  
  
  
  
  
  
  
  
  
</div>




<div class="flex flex-row flex-wrap items-center">
  
  
  
  
  
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/kubernetes/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Kubernetes
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/cni/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    CNI
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/antrea/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Antrea
  </span>
</span>
  </span>
  
  
  
  
  
  
  
  
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/antrea/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Antrea
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/kubernetes/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Kubernetes
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/cni/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Cni
  </span>
</span>
  </span>
  
  
  
  
</div>




        </div>

        
        <div class="py-1 prose dark:prose-invert">
          In this post I will go through a couple of Antrea features I find interesting, some new features and some older features
        </div>
        
      </div>
      <div class="px-6 pt-4 pb-2">

      </div>
    </div>
  </a>

  
  

  <a href="/2023/02/20/antrea-egress/" class="min-w-full">
    
    <div class="min-h-full border border-neutral-200 dark:border-neutral-700 border-2 rounded overflow-hidden shadow-2xl relative">
        
        <div class="w-full thumbnail_card_related nozoom" style="background-image:url(/2023/02/20/antrea-egress/feature-antrea-stacked-color3.webp);"></div>
        
      

      <div class="px-6 py-4">

        
        <div class="font-bold text-xl text-neutral-800 decoration-primary-500 hover:underline hover:underline-offset-2 dark:text-neutral"
          href="/2023/02/20/antrea-egress/">Antrea Egress</div>
        

        <div class="text-sm text-neutral-500 dark:text-neutral-400">
          











  





  



  













<div class="flex flex-row flex-wrap items-center">
  
  
  <time datetime="2023-02-20T15:42:54&#43;01:00">20 February 2023</time><span class="px-2 text-primary-500">&middot;</span><span>3485 words</span><span class="px-2 text-primary-500">&middot;</span><span title="Reading time">17 mins</span>
  

  
  
</div>


<div class="flex flex-row flex-wrap items-center">
  
  
  
  
  
  
  
  
  
  
  
</div>




<div class="flex flex-row flex-wrap items-center">
  
  
  
  
  
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/kubernetes/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Kubernetes
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/networking/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Networking
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/cni/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    CNI
  </span>
</span>
  </span>
  
  
  
  
  
  
  
  
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/antrea/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Antrea
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/kubernetes/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Kubernetes
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/tanzu/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Tanzu
  </span>
</span>
  </span>
  
  
  
  
</div>




        </div>

        
        <div class="py-1 prose dark:prose-invert">
          Antrea Egress: # What is Egress when we talk about Kubernetes?
        </div>
        
      </div>
      <div class="px-6 pt-4 pb-2">

      </div>
    </div>
  </a>

  
</section>

  
      </div>
     
      
      
        
        
          
          
        
      <script>
        var oid = "views_posts\/2023-09-25-vsphere-with-tanzu-antrea-and-multicluster\/index.md"
        var oid_likes = "likes_posts\/2023-09-25-vsphere-with-tanzu-antrea-and-multicluster\/index.md"
      </script>
      
      
      <script type="text/javascript" src="/js/page.min.0860cf4e04fa2d72cc33ddba263083464d48f67de06114529043cb4623319efed4f484fd7f1730df5abea0e2da6f3538855634081d02f2d6e920b956f063e823.js" integrity="sha512-CGDPTgT6LXLMM926JjCDRk1I9n3gYRRSkEPLRiMxnv7U9IT9fxcw31q&#43;oOLabzU4hVY0CB0C8tbpILlW8GPoIw=="></script>
      
  
    </section>
  <footer class="pt-8 max-w-prose print:hidden">

    
  
    
    
    
    <div class="pt-8">
      <hr class="border-dotted border-neutral-300 dark:border-neutral-600" />
      <div class="flex justify-between pt-3">
        <span>
          
            <a class="flex group mr-3" href="/2023/09/23/vsphere-with-tanzu-8-u2-using-nsx-and-nsx-advanced-loadbalancer/">
              <span
                class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400"
                >&larr;</span
              >
              <span
                class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400"
                >&rarr;</span
              >
              <span class="flex flex-col">
                <span
                  class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500"
                  >vSphere with Tanzu 8 U2 using NSX AND NSX Advanced Loadbalancer</span
                >
                <span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400">
                  
                    <time datetime="2023-09-23T21:35:17&#43;02:00">23 September 2023</time>
                  
                </span>
              </span>
            </a>
          
        </span>
        <span>
          
            <a class="flex text-right group ml-3" href="/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/">
              <span class="flex flex-col">
                <span
                  class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500"
                  >TKGi with NSX and NSX Advanced LoadBalancer</span
                >
                <span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400">
                  
                    <time datetime="2023-11-23T08:17:49&#43;01:00">23 November 2023</time>
                  
                </span>
              </span>
              <span
                class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400"
                >&rarr;</span
              >
              <span
                class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400"
                >&larr;</span
              >
            </a>
          
        </span>
      </div>
    </div>
  


    
  </footer>
</article>

      <div id="top-scroller" class="pointer-events-none absolute top-[110vh] bottom-0 w-12 ltr:right-0 rtl:left-0">
  <a href="#the-top"
    class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 mb-16 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400"
    aria-label="Scroll to top" title="Scroll to top">
    &uarr;
  </a>
</div>
    </main><footer id="site-footer" class="py-10 print:hidden">
  
  
    
    <nav class="flex flex-row pb-4 text-base font-medium text-neutral-500 dark:text-neutral-400">
      <ul class="flex flex-col list-none sm:flex-row">
        
        <li class="flex mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0">
          <a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2 flex items-center" href="/tags/"
            title="">
            
            Tags
          </a>
        </li>
        
        <li class="flex mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0">
          <a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2 flex items-center" href="/categories/"
            title="">
            
            Categories
          </a>
        </li>
        
      </ul>
    </nav>
    
  
  <div class="flex items-center justify-between">

    
    
    <p class="text-sm text-neutral-500 dark:text-neutral-400">
      &copy;
      2024
      Andreas Marqvardsen
    </p>
    

    
    
    <p class="text-xs text-neutral-500 dark:text-neutral-400">
      
      
      Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500"
        href="https://gohugo.io/" target="_blank" rel="noopener noreferrer">Hugo</a> &amp; <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500"
        href="https://blowfish.page/" target="_blank" rel="noopener noreferrer">Blowfish</a>
    </p>
    

  </div>
  <script>
    
    mediumZoom(document.querySelectorAll("img:not(.nozoom)"), {
      margin: 24,
      background: 'rgba(0,0,0,0.5)',
      scrollOffset: 0,
    })
    
  </script>
  
  
  <script type="text/javascript" src="/js/process.min.ee03488f19c93c2efb199e2e3014ea5f3cb2ce7d45154adb3399a158cac27ca52831db249ede5bb602700ef87eb02434139de0858af1818ab0fb4182472204a4.js" integrity="sha512-7gNIjxnJPC77GZ4uMBTqXzyyzn1FFUrbM5mhWMrCfKUoMdsknt5btgJwDvh&#43;sCQ0E53ghYrxgYqw&#43;0GCRyIEpA=="></script>
  
  
</footer>
<div
  id="search-wrapper"
  class="invisible fixed inset-0 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh]"
  data-url="https://blog.andreasm.io/"
  style="z-index:500"
>
  <div
    id="search-modal"
    class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"
  >
    <header class="relative z-10 flex items-center justify-between flex-none px-2">
      <form class="flex items-center flex-auto min-w-0">
        <div class="flex items-center justify-center w-8 h-8 text-neutral-400">
          

  <span class="relative block icon">
    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>

  </span>


        </div>
        <input
          type="search"
          id="search-query"
          class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent"
          placeholder="Search"
          tabindex="0"
        />
      </form>
      <button
        id="close-search-button"
        class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400"
        title="Close (Esc)"
      >
        

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75 0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3L54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75 0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75 0-45.25s32.75-12.5 45.25 0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25 0s12.5 32.75 0 45.25l-105.4 105.4L310.6 361.4z"/></svg>

  </span>


      </button>
    </header>
    <section class="flex-auto px-2 overflow-auto">
      <ul id="search-results">
        
      </ul>
    </section>
  </div>
</div>

  </div>
</body>

</html>
