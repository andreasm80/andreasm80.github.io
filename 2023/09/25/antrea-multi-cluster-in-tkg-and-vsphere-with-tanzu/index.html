
<!DOCTYPE html>
<html
  lang="en"
  data-figures=""
  
    class="page"
  
  
  
    data-mode="dim"
  >
  <head>
<title>Antrea Multi-cluster - in TKG and vSphere with Tanzu | From 0.985mhz... to several Ghz</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-TVPYDVE8KR"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-TVPYDVE8KR');
</script>



  
<meta property="og:locale" content="en" />

<meta property="og:type" content="article">
<meta name="description" content="Configuring Antrea Multi-cluster with Tanzu clusters" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:creator" content="">
<meta name="twitter:title" content="Antrea Multi-cluster - in TKG and vSphere with Tanzu" />
<meta name="twitter:image" content="https://blog.andreasm.io/2023/09/25/antrea-multi-cluster-in-tkg-and-vsphere-with-tanzu/images/antrea-stacked-color3.png"/>
<meta property="og:url" content="https://blog.andreasm.io/2023/09/25/antrea-multi-cluster-in-tkg-and-vsphere-with-tanzu/" />
<meta property="og:title" content="Antrea Multi-cluster - in TKG and vSphere with Tanzu" />
<meta property="og:description" content="Configuring Antrea Multi-cluster with Tanzu clusters" />
<meta property="og:image" content="https://blog.andreasm.io/2023/09/25/antrea-multi-cluster-in-tkg-and-vsphere-with-tanzu/images/antrea-stacked-color3.png" />
  <meta name="keywords" content="nsx,vmware,kubernetes" />

<link rel="apple-touch-icon" sizes="180x180" href="https://blog.andreasm.io/icons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://blog.andreasm.io/icons/favicon-32x32.png">
<link rel="manifest" href="https://blog.andreasm.io/icons/site.webmanifest">

<link rel="canonical" href="https://blog.andreasm.io/2023/09/25/antrea-multi-cluster-in-tkg-and-vsphere-with-tanzu/">



<link rel="preload" href="https://blog.andreasm.io/css/styles.6c67fa3a7f5290a2facfb027358dd2bdb5450d04b8de427c8a74d79f524a7fb716b470b14b6ba95f1b7cf3aa9a2219a7294a6adeaf16a1080f432eae45d8c03c.css" integrity = "sha512-bGf6On9SkKL6z7AnNY3SvbVFDQS43kJ8inTXn1JKf7cWtHCxS2upXxt886qaIhmnKUpq3q8WoQgPQy6uRdjAPA==" as="style" crossorigin="anonymous">



<link rel="preload" href="https://blog.andreasm.io/en/js/bundle.5548d358738600c857a1f05f0459418da7143d4426c66a08bf3f15ded1b39dd2136bf104a559247a909fc4dcc45b8e06bad0870ece4c71ee5303d30550def8bd.js" as="script" integrity=
"sha512-VUjTWHOGAMhXofBfBFlBjacUPUQmxmoIvz8V3tGzndITa/EEpVkkepCfxNzEW44GutCHDs5Mce5TA9MFUN74vQ==" crossorigin="anonymous">


<link rel="stylesheet" type="text/css" href="https://blog.andreasm.io/css/styles.6c67fa3a7f5290a2facfb027358dd2bdb5450d04b8de427c8a74d79f524a7fb716b470b14b6ba95f1b7cf3aa9a2219a7294a6adeaf16a1080f432eae45d8c03c.css" integrity="sha512-bGf6On9SkKL6z7AnNY3SvbVFDQS43kJ8inTXn1JKf7cWtHCxS2upXxt886qaIhmnKUpq3q8WoQgPQy6uRdjAPA==" crossorigin="anonymous">


  </head>
  <body
    data-code="7"
    data-lines="false"
    id="documentTop"
    data-lang="en"
  >

<header class="nav_header" >
  <nav class="nav"><a href='https://blog.andreasm.io/' class="nav_brand nav_item" title="From 0.985mhz... to several Ghz">
  <img src="https://blog.andreasm.io/quote3.png" class="logo" alt="From 0.985mhz... to several Ghz">
  <div class="nav_close">
    <div><svg class="icon">
  <title>open-menu</title>
  <use xlink:href="#open-menu"></use>
</svg>
<svg class="icon">
  <title>closeme</title>
  <use xlink:href="#closeme"></use>
</svg>
</div>
  </div>
</a>

    <div class='nav_body nav_body_left'>
      
      
      
        

  <div class="nav_parent">
    <a href="https://blog.andreasm.io/" class="nav_item" title="Home">Home </a>
  </div>
  <div class="nav_parent">
    <a href="https://blog.andreasm.io/about/" class="nav_item" title="About">About </a>
  </div>
      
<div class='follow'>
<div class="color_mode">
  <input type="checkbox" class="color_choice" id="mode">
</div>

</div>

    </div>
  </nav>
</header>

    <main>
  
<div class="grid-inverse wrap content">
  <article class="post_content">
    <h1 class="post_title">Antrea Multi-cluster - in TKG and vSphere with Tanzu</h1>
  <div class="post_meta">
    <span><svg class="icon">
  <title>calendar</title>
  <use xlink:href="#calendar"></use>
</svg>
</span>
    <span class="post_date">
      25-09-2023</span>
    <span class="post_time"> · 60 min read</span><span>&nbsp;· <a href='https://blog.andreasm.io/tags/kubernetes/' title="kubernetes" class="post_tag button button_translucent">kubernetes
        </a><a href='https://blog.andreasm.io/tags/tanzu/' title="tanzu" class="post_tag button button_translucent">tanzu
        </a><a href='https://blog.andreasm.io/tags/antrea/' title="antrea" class="post_tag button button_translucent">antrea
        </a><a href='https://blog.andreasm.io/tags/cni/' title="cni" class="post_tag button button_translucent">cni
        </a><a href='https://blog.andreasm.io/tags/multi-cluster/' title="multi-cluster" class="post_tag button button_translucent">multi-cluster
        </a>
    </span>
  </div>

      <div class="post_toc">
        <h2>Overview</h2>
        <nav id="TableOfContents">
  <ul>
    <li><a href="#antrea-feature-gates">Antrea Feature Gates</a></li>
    <li><a href="#configuring-antrea-multi-cluster-in-tkg-23-with-antrea-v1111">Configuring Antrea Multi-cluster in TKG 2.3 with Antrea v1.11.1</a></li>
    <li><a href="#tanzu-in-vsphere-and-antrea-multi-cluster">Tanzu in vSphere and Antrea Multi-cluster</a></li>
    <li><a href="#install-and-configure-antrea-multi-cluster">Install and Configure Antrea Multi-cluster</a>
      <ul>
        <li><a href="#install-the-antrea-multi-cluster-controller-in-the-dedicated-leader-cluster">Install the Antrea Multi-cluster controller in the dedicated leader cluster</a></li>
        <li><a href="#install-the-antrea-multi-cluster-controller-in-the-member-clusters">Install the Antrea Multi-cluster controller in the member clusters</a></li>
      </ul>
    </li>
    <li><a href="#create-clusterset">Create ClusterSet</a>
      <ul>
        <li><a href="#on-the-leader-cluster---create-serviceaccounts">On the Leader Cluster - Create ServiceAccounts</a></li>
        <li><a href="#on-the-member-cluster-apply-tokens">On the Member Cluster apply tokens</a></li>
        <li><a href="#on-the-leader-cluster---clusterset-initialization">On the Leader Cluster - ClusterSet Initialization</a></li>
        <li><a href="#on-the-member-clusters---clusterset-initialization">On the Member Clusters - ClusterSet Initialization</a></li>
        <li><a href="#on-the-member-clusters---multi-cluster-gateway-configuration">On the Member Clusters - Multi-cluster Gateway configuration</a></li>
      </ul>
    </li>
    <li><a href="#using-antctl">Using antctl</a></li>
    <li><a href="#multi-cluster-service">Multi-cluster Service</a>
      <ul>
        <li><a href="#recap-of-multi-cluster-service">Recap of Multi-cluster service.</a></li>
        <li><a href="#quick-troubleshooting">Quick troubleshooting</a></li>
        <li><a href="#failure-scenario">Failure scenario</a></li>
      </ul>
    </li>
    <li><a href="#routing-pod-traffic-through-multi-cluster-gateways">Routing pod traffic through Multi-cluster Gateways</a></li>
    <li><a href="#multi-cluster-networkpolicy-anp-and-acnp">Multi-cluster NetworkPolicy (ANP and ACNP)</a></li>
    <li><a href="#multi-cluster-clusternetworkpolicy-replication-acnp">Multi-cluster ClusterNetworkPolicy replication (ACNP)</a></li>
    <li><a href="#bonus-content">Bonus content</a></li>
  </ul>
</nav>
      </div>
    
    <div class="post_body"><h1 id="antrea-multi-cluster">Antrea Multi-cluster</h1>
<p>From the official <a href="">Antrea.io</a> documentation:</p>
<blockquote>
<p>Antrea Multi-cluster implements <a href="https://github.com/kubernetes/enhancements/tree/master/keps/sig-multicluster/1645-multi-cluster-services-api">Multi-cluster Service API</a>, which allows users to create multi-cluster Services that can be accessed cross clusters in a ClusterSet. Antrea Multi-cluster also supports Antrea ClusterNetworkPolicy replication. Multi-cluster admins can define ClusterNetworkPolicies to be replicated across the entire ClusterSet, and enforced in all member clusters.</p>
<p>An Antrea Multi-cluster ClusterSet includes a leader cluster and multiple member clusters. Antrea Multi-cluster Controller needs to be deployed in the leader and all member clusters. A cluster can serve as the leader, and meanwhile also be a member cluster of the ClusterSet.</p>
<p>The diagram below depicts a basic Antrea Multi-cluster topology with one leader cluster and two member clusters.</p>
</blockquote>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="antrea-multicluster"
      
        class="image_figure image_internal image_processed"
        width="636"
        height="531"
        src="/2023/09/25/antrea-multi-cluster-in-tkg-and-vsphere-with-tanzu/images/image-20230925133759404.png"
      
      
    />

    </picture>
</figure>
</p>
<p>In this post I will go through how to configure Antrea Multi-cluster in TKG 2.3 and Tanzu with vSphere. As of the time I am writing this post (end of September begining of October 2023) Tanzu with vSphere does not have all the feature gates available right now to be able to configure Antrea Multi-cluster, so this will be added later. After the initial configuration and installation of Antrea Multi-cluster I will go through the different possibilities (features) with Antrea Multi-cluster, with configuration and examples in each of their own sections. The first sections involving how to enable Antrea Multi-cluster feature gate is specific for the Kubernetes &quot;distribution&quot; it is enabled on (TKG, vSphere with Tanzu, upstream Kubernetes etc). After this initial config the rest is generic and can be re-used for all types of Kubernetes platforms. I will go through everything step by step to learn what the different &quot;moving&quot; parts are doing and how they work. At the end I have a <em>bonus chapter</em> where I have created a menu driven script that automates or simplify the whole process.</p>
<h2 id="antrea-feature-gates">Antrea Feature Gates</h2>
<p>Antrea has a set of Feature Gates that can be enabled or disabled on both the Antrea Controller and Antrea Agent, depending on the feature. These are configured using the corresponding <strong>antrea-config</strong> configMap. For a list of available features head over to the <a href="https://antrea.io/docs/v1.13.1/">antrea.io</a> documentation page <a href="https://antrea.io/docs/v1.13.1/docs/feature-gates/">here</a>. Depending on the Kubernetes platform, and when the settings are applied, these features may be enabled in different ways. This post will specifically cover how to enable the Antrea Multi-cluster Feature Gate in Tanzu Kubernetes Grid and vSphere with Tanzu (not available yet).</p>
<h2 id="configuring-antrea-multi-cluster-in-tkg-23-with-antrea-v1111">Configuring Antrea Multi-cluster in TKG 2.3 with Antrea v1.11.1</h2>

<div class="notices info">
    <div class="label">Info</div>
    <p>The following procedure may not at the time writing this post be officially supported - will get back and confirm this</p>

  </div>

<p>Using Tanzu Kubernetes Grid the Antrea Feature Gates can be configured during provisioning of the workload clusters or post cluster provision. I will be enabling the Antrea Multi-cluster feature gate during cluster provisioning. If one need to enable these feature gates post cluster provision one <strong>must</strong> edit the <strong>antreaconfigs</strong> crd at the Management cluster level for the corresponding TKG cluster. See below.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl"> k get antreaconfigs.cni.tanzu.vmware.com -n tkg-ns-1
</span></span><span class="line"><span class="ln">2</span><span class="cl">NAME            TRAFFICENCAPMODE   DEFAULTMTU   ANTREAPROXY   ANTREAPOLICY   SECRETREF
</span></span><span class="line"><span class="ln">3</span><span class="cl">tkg-cluster-1   encap                           <span class="nb">true</span>          <span class="nb">true</span>           tkg-cluster-1-antrea-data-values
</span></span><span class="line"><span class="ln">4</span><span class="cl">tkg-cluster-2   encap                           <span class="nb">true</span>          <span class="nb">true</span>           tkg-cluster-2-antrea-data-values
</span></span><span class="line"><span class="ln">5</span><span class="cl">tkg-cluster-3   encap                           <span class="nb">true</span>          <span class="nb">true</span>           tkg-cluster-3-antrea-data-values
</span></span></code></pre></div><p>If I take a look at the yaml values for any of these <strong>antreaconfigs</strong>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">cni.tanzu.vmware.com/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">AntreaConfig</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="nt">kubectl.kubernetes.io/last-applied-configuration</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="sd">      {&#34;apiVersion&#34;:&#34;cni.tanzu.vmware.com/v1alpha1&#34;,&#34;kind&#34;:&#34;AntreaConfig&#34;,&#34;metadata&#34;:{&#34;annotations&#34;:{},&#34;name&#34;:&#34;tkg-cluster-1&#34;,&#34;namespace&#34;:&#34;tkg-ns-1&#34;},&#34;spec&#34;:{&#34;antrea&#34;:{&#34;config&#34;:{&#34;antreaProxy&#34;:{&#34;nodePortAddresses&#34;:[],&#34;proxyAll&#34;:false,&#34;proxyLoadBalancerIPs&#34;:true,&#34;skipServices&#34;:[]},&#34;cloudProvider&#34;:{&#34;name&#34;:&#34;&#34;},&#34;disableTXChecksumOffload&#34;:false,&#34;disableUdpTunnelOffload&#34;:false,&#34;dnsServerOverride&#34;:&#34;&#34;,&#34;egress&#34;:{&#34;exceptCIDRs&#34;:[],&#34;maxEgressIPsPerNode&#34;:255},&#34;enableBridgingMode&#34;:null,&#34;enableUsageReporting&#34;:false,&#34;featureGates&#34;:{&#34;AntreaIPAM&#34;:false,&#34;AntreaPolicy&#34;:true,&#34;AntreaProxy&#34;:true,&#34;AntreaTraceflow&#34;:true,&#34;Egress&#34;:true,&#34;EndpointSlice&#34;:true,&#34;FlowExporter&#34;:false,&#34;L7NetworkPolicy&#34;:false,&#34;Multicast&#34;:false,&#34;Multicluster&#34;:true,&#34;NetworkPolicyStats&#34;:false,&#34;NodePortLocal&#34;:true,&#34;SecondaryNetwork&#34;:false,&#34;ServiceExternalIP&#34;:false,&#34;SupportBundleCollection&#34;:false,&#34;TopologyAwareHints&#34;:false,&#34;TrafficControl&#34;:false},&#34;flowExporter&#34;:{&#34;activeFlowTimeout&#34;:&#34;60s&#34;,&#34;idleFlowTimeout&#34;:&#34;15s&#34;,&#34;pollInterval&#34;:&#34;5s&#34;},&#34;kubeAPIServerOverride&#34;:null,&#34;multicast&#34;:{&#34;igmpQueryInterval&#34;:&#34;125s&#34;},&#34;multicastInterfaces&#34;:[],&#34;multicluster&#34;:{&#34;enable&#34;:true,&#34;enablePodToPodConnectivity&#34;:true,&#34;enableStretchedNetworkPolicy&#34;:true,&#34;namespace&#34;:&#34;antrea-multicluster&#34;},&#34;noSNAT&#34;:false,&#34;nodePortLocal&#34;:{&#34;enabled&#34;:true,&#34;portRange&#34;:&#34;61000-62000&#34;},&#34;serviceCIDR&#34;:&#34;10.132.0.0/16&#34;,&#34;trafficEncapMode&#34;:&#34;encap&#34;,&#34;trafficEncryptionMode&#34;:&#34;none&#34;,&#34;transportInterface&#34;:null,&#34;transportInterfaceCIDRs&#34;:[],&#34;tunnelCsum&#34;:false,&#34;tunnelPort&#34;:0,&#34;tunnelType&#34;:&#34;geneve&#34;,&#34;wireGuard&#34;:{&#34;port&#34;:51820}}}}}</span><span class="w">      
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">  </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2023-09-28T19:49:11Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">  </span><span class="nt">generation</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="nt">tkg.tanzu.vmware.com/cluster-name</span><span class="p">:</span><span class="w"> </span><span class="l">tkg-cluster-1</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">    </span><span class="nt">tkg.tanzu.vmware.com/package-name</span><span class="p">:</span><span class="w"> </span><span class="l">antrea.tanzu.vmware.com.1.11.1---vmware.4-tkg.1-advanced</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tkg-cluster-1</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">tkg-ns-1</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">  </span><span class="nt">ownerReferences</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">  </span>- <span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">cluster.x-k8s.io/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">    </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Cluster</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tkg-cluster-1</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">    </span><span class="nt">uid</span><span class="p">:</span><span class="w"> </span><span class="l">f635b355-e094-471f-bfeb-63e1c10443cf</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">  </span>- <span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">run.tanzu.vmware.com/v1alpha3</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">    </span><span class="nt">blockOwnerDeletion</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">    </span><span class="nt">controller</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">    </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterBootstrap</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tkg-cluster-1</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">    </span><span class="nt">uid</span><span class="p">:</span><span class="w"> </span><span class="l">83b5bdd6-27c3-4c65-a9bc-f665e99c0670</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">  </span><span class="nt">resourceVersion</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;14988446&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w">  </span><span class="nt">uid</span><span class="p">:</span><span class="w"> </span><span class="l">7335854b-49ca-44d9-bded-2d4a09aaf5de</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w">  </span><span class="nt">antrea</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">    </span><span class="nt">config</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w">      </span><span class="nt">antreaProxy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="w">        </span><span class="nt">nodePortAddresses</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="w">        </span><span class="nt">proxyAll</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="w">        </span><span class="nt">proxyLoadBalancerIPs</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="w">        </span><span class="nt">skipServices</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
</span></span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="w">      </span><span class="nt">cloudProvider</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">36</span><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">37</span><span class="cl"><span class="w">      </span><span class="nt">defaultMTU</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">38</span><span class="cl"><span class="w">      </span><span class="nt">disableTXChecksumOffload</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="ln">39</span><span class="cl"><span class="w">      </span><span class="nt">disableUdpTunnelOffload</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="ln">40</span><span class="cl"><span class="w">      </span><span class="nt">dnsServerOverride</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">41</span><span class="cl"><span class="w">      </span><span class="nt">egress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">42</span><span class="cl"><span class="w">        </span><span class="nt">exceptCIDRs</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
</span></span></span><span class="line"><span class="ln">43</span><span class="cl"><span class="w">        </span><span class="nt">maxEgressIPsPerNode</span><span class="p">:</span><span class="w"> </span><span class="m">255</span><span class="w">
</span></span></span><span class="line"><span class="ln">44</span><span class="cl"><span class="w">      </span><span class="nt">enableBridgingMode</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="ln">45</span><span class="cl"><span class="w">      </span><span class="nt">enableUsageReporting</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="ln">46</span><span class="cl"><span class="w">      </span><span class="nt">featureGates</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">47</span><span class="cl"><span class="w">        </span><span class="nt">AntreaIPAM</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="ln">48</span><span class="cl"><span class="w">        </span><span class="nt">AntreaPolicy</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="ln">49</span><span class="cl"><span class="w">        </span><span class="nt">AntreaProxy</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="ln">50</span><span class="cl"><span class="w">        </span><span class="nt">AntreaTraceflow</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="ln">51</span><span class="cl"><span class="w">        </span><span class="nt">Egress</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="ln">52</span><span class="cl"><span class="w">        </span><span class="nt">EndpointSlice</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="ln">53</span><span class="cl"><span class="w">        </span><span class="nt">FlowExporter</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="ln">54</span><span class="cl"><span class="w">        </span><span class="nt">L7NetworkPolicy</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="ln">55</span><span class="cl"><span class="w">        </span><span class="nt">Multicast</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="ln">56</span><span class="cl"><span class="w">        </span><span class="nt">Multicluster</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="ln">57</span><span class="cl"><span class="w">        </span><span class="nt">NetworkPolicyStats</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="ln">58</span><span class="cl"><span class="w">        </span><span class="nt">NodePortLocal</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="ln">59</span><span class="cl"><span class="w">        </span><span class="nt">SecondaryNetwork</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="ln">60</span><span class="cl"><span class="w">        </span><span class="nt">ServiceExternalIP</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="ln">61</span><span class="cl"><span class="w">        </span><span class="nt">SupportBundleCollection</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="ln">62</span><span class="cl"><span class="w">        </span><span class="nt">TopologyAwareHints</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="ln">63</span><span class="cl"><span class="w">        </span><span class="nt">TrafficControl</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="ln">64</span><span class="cl"><span class="w">      </span><span class="nt">flowExporter</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">65</span><span class="cl"><span class="w">        </span><span class="nt">activeFlowTimeout</span><span class="p">:</span><span class="w"> </span><span class="l">60s</span><span class="w">
</span></span></span><span class="line"><span class="ln">66</span><span class="cl"><span class="w">        </span><span class="nt">idleFlowTimeout</span><span class="p">:</span><span class="w"> </span><span class="l">15s</span><span class="w">
</span></span></span><span class="line"><span class="ln">67</span><span class="cl"><span class="w">        </span><span class="nt">pollInterval</span><span class="p">:</span><span class="w"> </span><span class="l">5s</span><span class="w">
</span></span></span><span class="line"><span class="ln">68</span><span class="cl"><span class="w">      </span><span class="nt">multicast</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">69</span><span class="cl"><span class="w">        </span><span class="nt">igmpQueryInterval</span><span class="p">:</span><span class="w"> </span><span class="l">125s</span><span class="w">
</span></span></span><span class="line"><span class="ln">70</span><span class="cl"><span class="w">      </span><span class="nt">multicastInterfaces</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
</span></span></span><span class="line"><span class="ln">71</span><span class="cl"><span class="w">      </span><span class="nt">multicluster</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">72</span><span class="cl"><span class="w">        </span><span class="nt">enable</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="ln">73</span><span class="cl"><span class="w">        </span><span class="nt">enablePodToPodConnectivity</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="ln">74</span><span class="cl"><span class="w">        </span><span class="nt">enableStretchedNetworkPolicy</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="ln">75</span><span class="cl"><span class="w">        </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">antrea-multicluster</span><span class="w">
</span></span></span><span class="line"><span class="ln">76</span><span class="cl"><span class="w">      </span><span class="nt">noSNAT</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="ln">77</span><span class="cl"><span class="w">      </span><span class="nt">nodePortLocal</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">78</span><span class="cl"><span class="w">        </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="ln">79</span><span class="cl"><span class="w">        </span><span class="nt">portRange</span><span class="p">:</span><span class="w"> </span><span class="m">61000-62000</span><span class="w">
</span></span></span><span class="line"><span class="ln">80</span><span class="cl"><span class="w">      </span><span class="nt">serviceCIDR</span><span class="p">:</span><span class="w"> </span><span class="m">10.132.0.0</span><span class="l">/16</span><span class="w">
</span></span></span><span class="line"><span class="ln">81</span><span class="cl"><span class="w">      </span><span class="nt">tlsCipherSuites</span><span class="p">:</span><span class="w"> </span><span class="l">TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,TLS_RSA_WITH_AES_256_GCM_SHA384</span><span class="w">
</span></span></span><span class="line"><span class="ln">82</span><span class="cl"><span class="w">      </span><span class="nt">trafficEncapMode</span><span class="p">:</span><span class="w"> </span><span class="l">encap</span><span class="w">
</span></span></span><span class="line"><span class="ln">83</span><span class="cl"><span class="w">      </span><span class="nt">trafficEncryptionMode</span><span class="p">:</span><span class="w"> </span><span class="l">none</span><span class="w">
</span></span></span><span class="line"><span class="ln">84</span><span class="cl"><span class="w">      </span><span class="nt">transportInterfaceCIDRs</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
</span></span></span><span class="line"><span class="ln">85</span><span class="cl"><span class="w">      </span><span class="nt">tunnelCsum</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="ln">86</span><span class="cl"><span class="w">      </span><span class="nt">tunnelPort</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">
</span></span></span><span class="line"><span class="ln">87</span><span class="cl"><span class="w">      </span><span class="nt">tunnelType</span><span class="p">:</span><span class="w"> </span><span class="l">geneve</span><span class="w">
</span></span></span><span class="line"><span class="ln">88</span><span class="cl"><span class="w">      </span><span class="nt">wireGuard</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">89</span><span class="cl"><span class="w">        </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">51820</span><span class="w">
</span></span></span><span class="line"><span class="ln">90</span><span class="cl"><span class="w"></span><span class="nt">status</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">91</span><span class="cl"><span class="w">  </span><span class="nt">secretRef</span><span class="p">:</span><span class="w"> </span><span class="l">tkg-cluster-1-antrea-data-values</span><span class="w">
</span></span></span></code></pre></div><p>I have all the Antrea Feature Gates avaible for Antrea to use in the current version of TKG. What I dont have is the <strong>antrea-agent.conf</strong> and <strong>antrea-controller.conf</strong> sections. But enabling the Feature Gates here will enable the corresponding setting under the correct section in the native Antrea configMap.</p>
<p>The required settings or Antrea Feature-Gates that needs to be enabled are the following:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">antrea-config</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-system</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">  </span><span class="nt">antrea-agent.conf</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="sd">    featureGates:
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="sd">      Multicluster: true
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="sd">    multicluster:
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="sd">      enableGateway: true
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="sd">      namespace: &#34;&#34;</span><span class="w">    
</span></span></span></code></pre></div><p>Then I know which Feature Gates that must be enabled, but in TKG I dont have <strong>antrea-agent.conf</strong> nor <strong>antrea-controller.conf</strong>.</p>
<p>Using a class based yaml for my workload clusters in TKG the Antrea specific section look like this and to enable Antrea Multi-cluster (including two optional features) I need to enable these features (redacted):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">cni.tanzu.vmware.com/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">AntreaConfig</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tkg-cluster-1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">tkg-ns-1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">  </span><span class="nt">antrea</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">    </span><span class="nt">config</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">      </span><span class="nt">antreaProxy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">      </span><span class="nt">cloudProvider</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">      </span><span class="nt">egress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">      </span><span class="nt">featureGates</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">        </span><span class="nt">Multicluster</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="c"># set to true</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">      </span><span class="nt">multicluster</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">        </span><span class="nt">enable</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="c"># set to true</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">        </span><span class="nt">enablePodToPodConnectivity</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="c"># set to true</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">        </span><span class="nt">enableStretchedNetworkPolicy</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="c"># set to true</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">        </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;antrea-multicluster&#34;</span><span class="w"> </span><span class="c">#optional</span><span class="w">
</span></span></span></code></pre></div><p>Below is the full workload cluster manifest I use, beginning with the Antrea specific settings (see my inline comments again). This will enable the Multi-cluster feature gate, and the two additional Multi-cluster features <em>PodToPodConnectivity</em> and <em>StretchedNetworkPolicy</em> upon cluster creation.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln">  1</span><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">cni.tanzu.vmware.com/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="ln">  2</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">AntreaConfig</span><span class="w">
</span></span></span><span class="line"><span class="ln">  3</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">  4</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tkg-cluster-1</span><span class="w">
</span></span></span><span class="line"><span class="ln">  5</span><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">tkg-ns-1</span><span class="w">
</span></span></span><span class="line"><span class="ln">  6</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">  7</span><span class="cl"><span class="w">  </span><span class="nt">antrea</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">  8</span><span class="cl"><span class="w">    </span><span class="nt">config</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">  9</span><span class="cl"><span class="w">      </span><span class="nt">antreaProxy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 10</span><span class="cl"><span class="w">        </span><span class="nt">nodePortAddresses</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 11</span><span class="cl"><span class="w">        </span><span class="nt">proxyAll</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 12</span><span class="cl"><span class="w">        </span><span class="nt">proxyLoadBalancerIPs</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 13</span><span class="cl"><span class="w">        </span><span class="nt">skipServices</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 14</span><span class="cl"><span class="w">      </span><span class="nt">cloudProvider</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 15</span><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 16</span><span class="cl"><span class="w">      </span><span class="nt">disableTXChecksumOffload</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 17</span><span class="cl"><span class="w">      </span><span class="nt">disableUdpTunnelOffload</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 18</span><span class="cl"><span class="w">      </span><span class="nt">dnsServerOverride</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 19</span><span class="cl"><span class="w">      </span><span class="nt">egress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 20</span><span class="cl"><span class="w">        </span><span class="nt">exceptCIDRs</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 21</span><span class="cl"><span class="w">        </span><span class="nt">maxEgressIPsPerNode</span><span class="p">:</span><span class="w"> </span><span class="m">255</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 22</span><span class="cl"><span class="w">      </span><span class="nt">enableBridgingMode</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 23</span><span class="cl"><span class="w">      </span><span class="nt">enableUsageReporting</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 24</span><span class="cl"><span class="w">      </span><span class="nt">featureGates</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 25</span><span class="cl"><span class="w">        </span><span class="nt">AntreaIPAM</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 26</span><span class="cl"><span class="w">        </span><span class="nt">AntreaPolicy</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 27</span><span class="cl"><span class="w">        </span><span class="nt">AntreaProxy</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 28</span><span class="cl"><span class="w">        </span><span class="nt">AntreaTraceflow</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 29</span><span class="cl"><span class="w">        </span><span class="nt">Egress</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 30</span><span class="cl"><span class="w">        </span><span class="nt">EndpointSlice</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 31</span><span class="cl"><span class="w">        </span><span class="nt">FlowExporter</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 32</span><span class="cl"><span class="w">        </span><span class="nt">L7NetworkPolicy</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 33</span><span class="cl"><span class="w">        </span><span class="nt">Multicast</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 34</span><span class="cl"><span class="w">        </span><span class="nt">Multicluster</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="c"># set to true</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 35</span><span class="cl"><span class="w">        </span><span class="nt">NetworkPolicyStats</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 36</span><span class="cl"><span class="w">        </span><span class="nt">NodePortLocal</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 37</span><span class="cl"><span class="w">        </span><span class="nt">SecondaryNetwork</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 38</span><span class="cl"><span class="w">        </span><span class="nt">ServiceExternalIP</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 39</span><span class="cl"><span class="w">        </span><span class="nt">SupportBundleCollection</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 40</span><span class="cl"><span class="w">        </span><span class="nt">TopologyAwareHints</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 41</span><span class="cl"><span class="w">        </span><span class="nt">TrafficControl</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 42</span><span class="cl"><span class="w">      </span><span class="nt">flowExporter</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 43</span><span class="cl"><span class="w">        </span><span class="nt">activeFlowTimeout</span><span class="p">:</span><span class="w"> </span><span class="l">60s</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 44</span><span class="cl"><span class="w">        </span><span class="nt">idleFlowTimeout</span><span class="p">:</span><span class="w"> </span><span class="l">15s</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 45</span><span class="cl"><span class="w">        </span><span class="nt">pollInterval</span><span class="p">:</span><span class="w"> </span><span class="l">5s</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 46</span><span class="cl"><span class="w">      </span><span class="nt">kubeAPIServerOverride</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 47</span><span class="cl"><span class="w">      </span><span class="nt">multicast</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 48</span><span class="cl"><span class="w">        </span><span class="nt">igmpQueryInterval</span><span class="p">:</span><span class="w"> </span><span class="l">125s</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 49</span><span class="cl"><span class="w">      </span><span class="nt">multicastInterfaces</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 50</span><span class="cl"><span class="w">      </span><span class="nt">multicluster</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 51</span><span class="cl"><span class="w">        </span><span class="nt">enable</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="c"># set to true</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 52</span><span class="cl"><span class="w">        </span><span class="nt">enablePodToPodConnectivity</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="c"># set to true</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 53</span><span class="cl"><span class="w">        </span><span class="nt">enableStretchedNetworkPolicy</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="c"># set to true</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 54</span><span class="cl"><span class="w">        </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;antrea-multicluster&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 55</span><span class="cl"><span class="w">      </span><span class="nt">noSNAT</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 56</span><span class="cl"><span class="w">      </span><span class="nt">nodePortLocal</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 57</span><span class="cl"><span class="w">        </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 58</span><span class="cl"><span class="w">        </span><span class="nt">portRange</span><span class="p">:</span><span class="w"> </span><span class="m">61000-62000</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 59</span><span class="cl"><span class="w">      </span><span class="nt">serviceCIDR</span><span class="p">:</span><span class="w"> </span><span class="m">10.132.0.0</span><span class="l">/16</span><span class="w"> </span><span class="c"># if you forget to update this CIDR it will be updated according to the services cidr below</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 60</span><span class="cl"><span class="w">      </span><span class="nt">trafficEncapMode</span><span class="p">:</span><span class="w"> </span><span class="l">encap</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 61</span><span class="cl"><span class="w">      </span><span class="nt">trafficEncryptionMode</span><span class="p">:</span><span class="w"> </span><span class="l">none</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 62</span><span class="cl"><span class="w">      </span><span class="nt">transportInterface</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 63</span><span class="cl"><span class="w">      </span><span class="nt">transportInterfaceCIDRs</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 64</span><span class="cl"><span class="w">      </span><span class="nt">tunnelCsum</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 65</span><span class="cl"><span class="w">      </span><span class="nt">tunnelPort</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 66</span><span class="cl"><span class="w">      </span><span class="nt">tunnelType</span><span class="p">:</span><span class="w"> </span><span class="l">geneve</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 67</span><span class="cl"><span class="w">      </span><span class="nt">wireGuard</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 68</span><span class="cl"><span class="w">        </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">51820</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 69</span><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 70</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">cpi.tanzu.vmware.com/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 71</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">VSphereCPIConfig</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 72</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 73</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tkg-cluster-1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 74</span><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">tkg-ns-1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 75</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 76</span><span class="cl"><span class="w">  </span><span class="nt">vsphereCPI</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 77</span><span class="cl"><span class="w">    </span><span class="nt">ipFamily</span><span class="p">:</span><span class="w"> </span><span class="l">ipv4</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 78</span><span class="cl"><span class="w">    </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l">vsphereCPI</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 79</span><span class="cl"><span class="w">    </span><span class="nt">region</span><span class="p">:</span><span class="w"> </span><span class="l">k8s-region</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 80</span><span class="cl"><span class="w">    </span><span class="nt">tlsCipherSuites</span><span class="p">:</span><span class="w"> </span><span class="l">TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 81</span><span class="cl"><span class="w">    </span><span class="nt">zone</span><span class="p">:</span><span class="w"> </span><span class="l">k8s-zone</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 82</span><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 83</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">csi.tanzu.vmware.com/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 84</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">VSphereCSIConfig</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 85</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 86</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tkg-cluster-1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 87</span><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">tkg-ns-1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 88</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 89</span><span class="cl"><span class="w">  </span><span class="nt">vsphereCSI</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 90</span><span class="cl"><span class="w">    </span><span class="nt">config</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 91</span><span class="cl"><span class="w">      </span><span class="nt">datacenter</span><span class="p">:</span><span class="w"> </span><span class="l">/cPod-NSXAM-WDC</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 92</span><span class="cl"><span class="w">      </span><span class="nt">httpProxy</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 93</span><span class="cl"><span class="w">      </span><span class="nt">httpsProxy</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 94</span><span class="cl"><span class="w">      </span><span class="nt">insecureFlag</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 95</span><span class="cl"><span class="w">      </span><span class="nt">noProxy</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 96</span><span class="cl"><span class="w">      </span><span class="nt">region</span><span class="p">:</span><span class="w"> </span><span class="l">k8s-region</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 97</span><span class="cl"><span class="w">      </span><span class="nt">tlsThumbprint</span><span class="p">:</span><span class="w"> </span><span class="l">&lt;SHA&gt;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 98</span><span class="cl"><span class="w">      </span><span class="nt">useTopologyCategories</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 99</span><span class="cl"><span class="w">      </span><span class="nt">zone</span><span class="p">:</span><span class="w"> </span><span class="l">k8s-zone</span><span class="w">
</span></span></span><span class="line"><span class="ln">100</span><span class="cl"><span class="w">    </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l">vsphereCSI</span><span class="w">
</span></span></span><span class="line"><span class="ln">101</span><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="ln">102</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">run.tanzu.vmware.com/v1alpha3</span><span class="w">
</span></span></span><span class="line"><span class="ln">103</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterBootstrap</span><span class="w">
</span></span></span><span class="line"><span class="ln">104</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">105</span><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">106</span><span class="cl"><span class="w">    </span><span class="nt">tkg.tanzu.vmware.com/add-missing-fields-from-tkr</span><span class="p">:</span><span class="w"> </span><span class="l">v1.26.5---vmware.2-tkg.1</span><span class="w">
</span></span></span><span class="line"><span class="ln">107</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tkg-cluster-1</span><span class="w">
</span></span></span><span class="line"><span class="ln">108</span><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">tkg-ns-1</span><span class="w">
</span></span></span><span class="line"><span class="ln">109</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">110</span><span class="cl"><span class="w">  </span><span class="nt">additionalPackages</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">111</span><span class="cl"><span class="w">  </span>- <span class="nt">refName</span><span class="p">:</span><span class="w"> </span><span class="l">metrics-server*</span><span class="w">
</span></span></span><span class="line"><span class="ln">112</span><span class="cl"><span class="w">  </span>- <span class="nt">refName</span><span class="p">:</span><span class="w"> </span><span class="l">secretgen-controller*</span><span class="w">
</span></span></span><span class="line"><span class="ln">113</span><span class="cl"><span class="w">  </span>- <span class="nt">refName</span><span class="p">:</span><span class="w"> </span><span class="l">pinniped*</span><span class="w">
</span></span></span><span class="line"><span class="ln">114</span><span class="cl"><span class="w">  </span><span class="nt">cni</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">115</span><span class="cl"><span class="w">    </span><span class="nt">refName</span><span class="p">:</span><span class="w"> </span><span class="l">antrea*</span><span class="w">
</span></span></span><span class="line"><span class="ln">116</span><span class="cl"><span class="w">    </span><span class="nt">valuesFrom</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">117</span><span class="cl"><span class="w">      </span><span class="nt">providerRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">118</span><span class="cl"><span class="w">        </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l">cni.tanzu.vmware.com</span><span class="w">
</span></span></span><span class="line"><span class="ln">119</span><span class="cl"><span class="w">        </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">AntreaConfig</span><span class="w">
</span></span></span><span class="line"><span class="ln">120</span><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tkg-cluster-1</span><span class="w">
</span></span></span><span class="line"><span class="ln">121</span><span class="cl"><span class="w">  </span><span class="nt">cpi</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">122</span><span class="cl"><span class="w">    </span><span class="nt">refName</span><span class="p">:</span><span class="w"> </span><span class="l">vsphere-cpi*</span><span class="w">
</span></span></span><span class="line"><span class="ln">123</span><span class="cl"><span class="w">    </span><span class="nt">valuesFrom</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">124</span><span class="cl"><span class="w">      </span><span class="nt">providerRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">125</span><span class="cl"><span class="w">        </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l">cpi.tanzu.vmware.com</span><span class="w">
</span></span></span><span class="line"><span class="ln">126</span><span class="cl"><span class="w">        </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">VSphereCPIConfig</span><span class="w">
</span></span></span><span class="line"><span class="ln">127</span><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tkg-cluster-1</span><span class="w">
</span></span></span><span class="line"><span class="ln">128</span><span class="cl"><span class="w">  </span><span class="nt">csi</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">129</span><span class="cl"><span class="w">    </span><span class="nt">refName</span><span class="p">:</span><span class="w"> </span><span class="l">vsphere-csi*</span><span class="w">
</span></span></span><span class="line"><span class="ln">130</span><span class="cl"><span class="w">    </span><span class="nt">valuesFrom</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">131</span><span class="cl"><span class="w">      </span><span class="nt">providerRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">132</span><span class="cl"><span class="w">        </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l">csi.tanzu.vmware.com</span><span class="w">
</span></span></span><span class="line"><span class="ln">133</span><span class="cl"><span class="w">        </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">VSphereCSIConfig</span><span class="w">
</span></span></span><span class="line"><span class="ln">134</span><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tkg-cluster-1</span><span class="w">
</span></span></span><span class="line"><span class="ln">135</span><span class="cl"><span class="w">  </span><span class="nt">kapp</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">136</span><span class="cl"><span class="w">    </span><span class="nt">refName</span><span class="p">:</span><span class="w"> </span><span class="l">kapp-controller*</span><span class="w">
</span></span></span><span class="line"><span class="ln">137</span><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="ln">138</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="ln">139</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Secret</span><span class="w">
</span></span></span><span class="line"><span class="ln">140</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">141</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tkg-cluster-1</span><span class="w">
</span></span></span><span class="line"><span class="ln">142</span><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">tkg-ns-1</span><span class="w">
</span></span></span><span class="line"><span class="ln">143</span><span class="cl"><span class="w"></span><span class="nt">stringData</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">144</span><span class="cl"><span class="w">  </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="l">password</span><span class="w">
</span></span></span><span class="line"><span class="ln">145</span><span class="cl"><span class="w">  </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l">andreasm@cpod-nsxam-wdc.domain.net</span><span class="w">
</span></span></span><span class="line"><span class="ln">146</span><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="ln">147</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">cluster.x-k8s.io/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="ln">148</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Cluster</span><span class="w">
</span></span></span><span class="line"><span class="ln">149</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">150</span><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">151</span><span class="cl"><span class="w">    </span><span class="nt">osInfo</span><span class="p">:</span><span class="w"> </span><span class="l">ubuntu,20.04,amd64</span><span class="w">
</span></span></span><span class="line"><span class="ln">152</span><span class="cl"><span class="w">    </span><span class="nt">tkg/plan</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w">
</span></span></span><span class="line"><span class="ln">153</span><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">154</span><span class="cl"><span class="w">    </span><span class="nt">tkg.tanzu.vmware.com/cluster-name</span><span class="p">:</span><span class="w"> </span><span class="l">tkg-cluster-1</span><span class="w">
</span></span></span><span class="line"><span class="ln">155</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tkg-cluster-1</span><span class="w">
</span></span></span><span class="line"><span class="ln">156</span><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">tkg-ns-1</span><span class="w">
</span></span></span><span class="line"><span class="ln">157</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">158</span><span class="cl"><span class="w">  </span><span class="nt">clusterNetwork</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">159</span><span class="cl"><span class="w">    </span><span class="nt">pods</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">160</span><span class="cl"><span class="w">      </span><span class="nt">cidrBlocks</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">161</span><span class="cl"><span class="w">      </span>- <span class="m">10.131.0.0</span><span class="l">/16</span><span class="w">
</span></span></span><span class="line"><span class="ln">162</span><span class="cl"><span class="w">    </span><span class="nt">services</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">163</span><span class="cl"><span class="w">      </span><span class="nt">cidrBlocks</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">164</span><span class="cl"><span class="w">      </span>- <span class="m">10.132.0.0</span><span class="l">/16</span><span class="w">
</span></span></span><span class="line"><span class="ln">165</span><span class="cl"><span class="w">  </span><span class="nt">topology</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">166</span><span class="cl"><span class="w">    </span><span class="nt">class</span><span class="p">:</span><span class="w"> </span><span class="l">tkg-vsphere-default-v1.1.0</span><span class="w">
</span></span></span><span class="line"><span class="ln">167</span><span class="cl"><span class="w">    </span><span class="nt">controlPlane</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">168</span><span class="cl"><span class="w">      </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">169</span><span class="cl"><span class="w">        </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">170</span><span class="cl"><span class="w">          </span><span class="nt">run.tanzu.vmware.com/resolve-os-image</span><span class="p">:</span><span class="w"> </span><span class="l">image-type=ova,os-name=ubuntu</span><span class="w">
</span></span></span><span class="line"><span class="ln">171</span><span class="cl"><span class="w">      </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="ln">172</span><span class="cl"><span class="w">    </span><span class="nt">variables</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">173</span><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cni</span><span class="w">
</span></span></span><span class="line"><span class="ln">174</span><span class="cl"><span class="w">      </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l">antrea</span><span class="w">
</span></span></span><span class="line"><span class="ln">175</span><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">controlPlaneCertificateRotation</span><span class="w">
</span></span></span><span class="line"><span class="ln">176</span><span class="cl"><span class="w">      </span><span class="nt">value</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">177</span><span class="cl"><span class="w">        </span><span class="nt">activate</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="ln">178</span><span class="cl"><span class="w">        </span><span class="nt">daysBefore</span><span class="p">:</span><span class="w"> </span><span class="m">90</span><span class="w">
</span></span></span><span class="line"><span class="ln">179</span><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">auditLogging</span><span class="w">
</span></span></span><span class="line"><span class="ln">180</span><span class="cl"><span class="w">      </span><span class="nt">value</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">181</span><span class="cl"><span class="w">        </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="ln">182</span><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">podSecurityStandard</span><span class="w">
</span></span></span><span class="line"><span class="ln">183</span><span class="cl"><span class="w">      </span><span class="nt">value</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">184</span><span class="cl"><span class="w">        </span><span class="nt">audit</span><span class="p">:</span><span class="w"> </span><span class="l">restricted</span><span class="w">
</span></span></span><span class="line"><span class="ln">185</span><span class="cl"><span class="w">        </span><span class="nt">deactivated</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="ln">186</span><span class="cl"><span class="w">        </span><span class="nt">warn</span><span class="p">:</span><span class="w"> </span><span class="l">restricted</span><span class="w">
</span></span></span><span class="line"><span class="ln">187</span><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">apiServerEndpoint</span><span class="w">
</span></span></span><span class="line"><span class="ln">188</span><span class="cl"><span class="w">      </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">189</span><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">aviAPIServerHAProvider</span><span class="w">
</span></span></span><span class="line"><span class="ln">190</span><span class="cl"><span class="w">      </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="ln">191</span><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">vcenter</span><span class="w">
</span></span></span><span class="line"><span class="ln">192</span><span class="cl"><span class="w">      </span><span class="nt">value</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">193</span><span class="cl"><span class="w">        </span><span class="nt">cloneMode</span><span class="p">:</span><span class="w"> </span><span class="l">fullClone</span><span class="w">
</span></span></span><span class="line"><span class="ln">194</span><span class="cl"><span class="w">        </span><span class="nt">datacenter</span><span class="p">:</span><span class="w"> </span><span class="l">/cPod-NSXAM-WDC</span><span class="w">
</span></span></span><span class="line"><span class="ln">195</span><span class="cl"><span class="w">        </span><span class="nt">datastore</span><span class="p">:</span><span class="w"> </span><span class="l">/cPod-NSXAM-WDC/datastore/vsanDatastore-wdc-01</span><span class="w">
</span></span></span><span class="line"><span class="ln">196</span><span class="cl"><span class="w">        </span><span class="nt">folder</span><span class="p">:</span><span class="w"> </span><span class="l">/cPod-NSXAM-WDC/vm/TKGm</span><span class="w">
</span></span></span><span class="line"><span class="ln">197</span><span class="cl"><span class="w">        </span><span class="nt">network</span><span class="p">:</span><span class="w"> </span><span class="l">/cPod-NSXAM-WDC/network/ls-tkg-mgmt</span><span class="w">
</span></span></span><span class="line"><span class="ln">198</span><span class="cl"><span class="w">        </span><span class="nt">resourcePool</span><span class="p">:</span><span class="w"> </span><span class="l">/cPod-NSXAM-WDC/host/Cluster-1/Resources</span><span class="w">
</span></span></span><span class="line"><span class="ln">199</span><span class="cl"><span class="w">        </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="l">vcsa.cpod-nsxam-wdc.az-wdc.domain.net</span><span class="w">
</span></span></span><span class="line"><span class="ln">200</span><span class="cl"><span class="w">        </span><span class="nt">storagePolicyID</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">201</span><span class="cl"><span class="w">        </span><span class="nt">tlsThumbprint</span><span class="p">:</span><span class="w"> </span><span class="l">&lt;SHA&gt;</span><span class="w">
</span></span></span><span class="line"><span class="ln">202</span><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">user</span><span class="w">
</span></span></span><span class="line"><span class="ln">203</span><span class="cl"><span class="w">      </span><span class="nt">value</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">204</span><span class="cl"><span class="w">        </span><span class="nt">sshAuthorizedKeys</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">205</span><span class="cl"><span class="w">        </span>- <span class="l">ssh-rsa 2UEBx235bVRSxQ==</span><span class="w">
</span></span></span><span class="line"><span class="ln">206</span><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">controlPlane</span><span class="w">
</span></span></span><span class="line"><span class="ln">207</span><span class="cl"><span class="w">      </span><span class="nt">value</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">208</span><span class="cl"><span class="w">        </span><span class="nt">machine</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">209</span><span class="cl"><span class="w">          </span><span class="nt">diskGiB</span><span class="p">:</span><span class="w"> </span><span class="m">20</span><span class="w">
</span></span></span><span class="line"><span class="ln">210</span><span class="cl"><span class="w">          </span><span class="nt">memoryMiB</span><span class="p">:</span><span class="w"> </span><span class="m">4096</span><span class="w">
</span></span></span><span class="line"><span class="ln">211</span><span class="cl"><span class="w">          </span><span class="nt">numCPUs</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span></span></span><span class="line"><span class="ln">212</span><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">worker</span><span class="w">
</span></span></span><span class="line"><span class="ln">213</span><span class="cl"><span class="w">      </span><span class="nt">value</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">214</span><span class="cl"><span class="w">        </span><span class="nt">machine</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">215</span><span class="cl"><span class="w">          </span><span class="nt">diskGiB</span><span class="p">:</span><span class="w"> </span><span class="m">20</span><span class="w">
</span></span></span><span class="line"><span class="ln">216</span><span class="cl"><span class="w">          </span><span class="nt">memoryMiB</span><span class="p">:</span><span class="w"> </span><span class="m">4096</span><span class="w">
</span></span></span><span class="line"><span class="ln">217</span><span class="cl"><span class="w">          </span><span class="nt">numCPUs</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span></span></span><span class="line"><span class="ln">218</span><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">controlPlaneZoneMatchingLabels</span><span class="w">
</span></span></span><span class="line"><span class="ln">219</span><span class="cl"><span class="w">      </span><span class="nt">value</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">220</span><span class="cl"><span class="w">        </span><span class="nt">region</span><span class="p">:</span><span class="w"> </span><span class="l">k8s-region</span><span class="w">
</span></span></span><span class="line"><span class="ln">221</span><span class="cl"><span class="w">        </span><span class="nt">tkg-cp</span><span class="p">:</span><span class="w"> </span><span class="l">allowed</span><span class="w">
</span></span></span><span class="line"><span class="ln">222</span><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">security</span><span class="w">
</span></span></span><span class="line"><span class="ln">223</span><span class="cl"><span class="w">      </span><span class="nt">value</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">224</span><span class="cl"><span class="w">        </span><span class="nt">fileIntegrityMonitoring</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">225</span><span class="cl"><span class="w">          </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="ln">226</span><span class="cl"><span class="w">        </span><span class="nt">imagePolicy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">227</span><span class="cl"><span class="w">          </span><span class="nt">pullAlways</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="ln">228</span><span class="cl"><span class="w">          </span><span class="nt">webhook</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">229</span><span class="cl"><span class="w">            </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="ln">230</span><span class="cl"><span class="w">            </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">231</span><span class="cl"><span class="w">              </span><span class="nt">allowTTL</span><span class="p">:</span><span class="w"> </span><span class="m">50</span><span class="w">
</span></span></span><span class="line"><span class="ln">232</span><span class="cl"><span class="w">              </span><span class="nt">defaultAllow</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="ln">233</span><span class="cl"><span class="w">              </span><span class="nt">denyTTL</span><span class="p">:</span><span class="w"> </span><span class="m">60</span><span class="w">
</span></span></span><span class="line"><span class="ln">234</span><span class="cl"><span class="w">              </span><span class="nt">retryBackoff</span><span class="p">:</span><span class="w"> </span><span class="m">500</span><span class="w">
</span></span></span><span class="line"><span class="ln">235</span><span class="cl"><span class="w">        </span><span class="nt">kubeletOptions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">236</span><span class="cl"><span class="w">          </span><span class="nt">eventQPS</span><span class="p">:</span><span class="w"> </span><span class="m">50</span><span class="w">
</span></span></span><span class="line"><span class="ln">237</span><span class="cl"><span class="w">          </span><span class="nt">streamConnectionIdleTimeout</span><span class="p">:</span><span class="w"> </span><span class="l">4h0m0s</span><span class="w">
</span></span></span><span class="line"><span class="ln">238</span><span class="cl"><span class="w">        </span><span class="nt">systemCryptoPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="ln">239</span><span class="cl"><span class="w">    </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l">v1.26.5+vmware.2-tkg.1</span><span class="w">
</span></span></span><span class="line"><span class="ln">240</span><span class="cl"><span class="w">    </span><span class="nt">workers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">241</span><span class="cl"><span class="w">      </span><span class="nt">machineDeployments</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">242</span><span class="cl"><span class="w">      </span>- <span class="nt">class</span><span class="p">:</span><span class="w"> </span><span class="l">tkg-worker</span><span class="w">
</span></span></span><span class="line"><span class="ln">243</span><span class="cl"><span class="w">        </span><span class="nt">failureDomain</span><span class="p">:</span><span class="w"> </span><span class="l">wdc-zone-2</span><span class="w">
</span></span></span><span class="line"><span class="ln">244</span><span class="cl"><span class="w">        </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">245</span><span class="cl"><span class="w">          </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">246</span><span class="cl"><span class="w">            </span><span class="nt">run.tanzu.vmware.com/resolve-os-image</span><span class="p">:</span><span class="w"> </span><span class="l">image-type=ova,os-name=ubuntu</span><span class="w">
</span></span></span><span class="line"><span class="ln">247</span><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">md-0</span><span class="w">
</span></span></span><span class="line"><span class="ln">248</span><span class="cl"><span class="w">        </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="ln">249</span><span class="cl"><span class="w">        </span><span class="nt">strategy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">250</span><span class="cl"><span class="w">          </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">RollingUpdate</span><span class="w">
</span></span></span><span class="line"><span class="ln">251</span><span class="cl"><span class="w">      </span>- <span class="nt">class</span><span class="p">:</span><span class="w"> </span><span class="l">tkg-worker</span><span class="w">
</span></span></span><span class="line"><span class="ln">252</span><span class="cl"><span class="w">        </span><span class="nt">failureDomain</span><span class="p">:</span><span class="w"> </span><span class="l">wdc-zone-3</span><span class="w">
</span></span></span><span class="line"><span class="ln">253</span><span class="cl"><span class="w">        </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">254</span><span class="cl"><span class="w">          </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">255</span><span class="cl"><span class="w">            </span><span class="nt">run.tanzu.vmware.com/resolve-os-image</span><span class="p">:</span><span class="w"> </span><span class="l">image-type=ova,os-name=ubuntu</span><span class="w">
</span></span></span><span class="line"><span class="ln">256</span><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">md-1</span><span class="w">
</span></span></span><span class="line"><span class="ln">257</span><span class="cl"><span class="w">        </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="ln">258</span><span class="cl"><span class="w">        </span><span class="nt">strategy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">259</span><span class="cl"><span class="w">          </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">RollingUpdate</span><span class="w">
</span></span></span></code></pre></div><p>In addition I am also setting these three additional settings:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln">1</span><span class="cl"><span class="w">        </span><span class="nt">enablePodToPodConnectivity</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="c"># set to true</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w">        </span><span class="nt">enableStretchedNetworkPolicy</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="c"># set to true</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w">        </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;antrea-multicluster&#34;</span><span class="w"> </span><span class="c"># the namespace will be created later, and I am not sure its even required to define anything here. Leave it blank &#34;&#34;</span><span class="w">
</span></span></span></code></pre></div><p>As I will test out the Multi-cluster NetworkPolicy and routing pod traffic through Multi-cluster Gateways, more on that later. In the workload cluster manifest make sure the services and pod CIDR does not overlap between your clusters that will be joined to the same Multi-cluster ClusterSet.</p>
<p>The namespace section is not mandatory.</p>

<div class="notices info">
    <div class="label">Info</div>
    <p>The services CIDRs can not overlap</p>
<p>The pod CIDR can not overlap if enabling PodToPodConnectivity</p>

  </div>

<p>After my TKG workload cluster has been provisioned with the above yaml, this will give me the following AntreaConfig in my workload cluster:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln">  1</span><span class="cl"><span class="l">andreasm@tkg-bootstrap:~$ k get configmaps -n kube-system antrea-config -oyaml</span><span class="w">
</span></span></span><span class="line"><span class="ln">  2</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="ln">  3</span><span class="cl"><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">  4</span><span class="cl"><span class="w">  </span><span class="nt">antrea-agent.conf</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="ln">  5</span><span class="cl"><span class="sd">    featureGates:
</span></span></span><span class="line"><span class="ln">  6</span><span class="cl"><span class="sd">      AntreaProxy: true
</span></span></span><span class="line"><span class="ln">  7</span><span class="cl"><span class="sd">      EndpointSlice: true
</span></span></span><span class="line"><span class="ln">  8</span><span class="cl"><span class="sd">      TopologyAwareHints: false
</span></span></span><span class="line"><span class="ln">  9</span><span class="cl"><span class="sd">      Traceflow: true
</span></span></span><span class="line"><span class="ln"> 10</span><span class="cl"><span class="sd">      NodePortLocal: true
</span></span></span><span class="line"><span class="ln"> 11</span><span class="cl"><span class="sd">      AntreaPolicy: true
</span></span></span><span class="line"><span class="ln"> 12</span><span class="cl"><span class="sd">      FlowExporter: false
</span></span></span><span class="line"><span class="ln"> 13</span><span class="cl"><span class="sd">      NetworkPolicyStats: false
</span></span></span><span class="line"><span class="ln"> 14</span><span class="cl"><span class="sd">      Egress: true
</span></span></span><span class="line"><span class="ln"> 15</span><span class="cl"><span class="sd">      AntreaIPAM: false
</span></span></span><span class="line"><span class="ln"> 16</span><span class="cl"><span class="sd">      Multicast: false
</span></span></span><span class="line"><span class="ln"> 17</span><span class="cl"><span class="sd">      Multicluster: true #enabled
</span></span></span><span class="line"><span class="ln"> 18</span><span class="cl"><span class="sd">      SecondaryNetwork: false
</span></span></span><span class="line"><span class="ln"> 19</span><span class="cl"><span class="sd">      ServiceExternalIP: false
</span></span></span><span class="line"><span class="ln"> 20</span><span class="cl"><span class="sd">      TrafficControl: false
</span></span></span><span class="line"><span class="ln"> 21</span><span class="cl"><span class="sd">      SupportBundleCollection: false
</span></span></span><span class="line"><span class="ln"> 22</span><span class="cl"><span class="sd">      L7NetworkPolicy: false
</span></span></span><span class="line"><span class="ln"> 23</span><span class="cl"><span class="sd">    trafficEncapMode: encap
</span></span></span><span class="line"><span class="ln"> 24</span><span class="cl"><span class="sd">    noSNAT: false
</span></span></span><span class="line"><span class="ln"> 25</span><span class="cl"><span class="sd">    tunnelType: geneve
</span></span></span><span class="line"><span class="ln"> 26</span><span class="cl"><span class="sd">    tunnelPort: 0
</span></span></span><span class="line"><span class="ln"> 27</span><span class="cl"><span class="sd">    tunnelCsum: false
</span></span></span><span class="line"><span class="ln"> 28</span><span class="cl"><span class="sd">    trafficEncryptionMode: none
</span></span></span><span class="line"><span class="ln"> 29</span><span class="cl"><span class="sd">    enableBridgingMode: false
</span></span></span><span class="line"><span class="ln"> 30</span><span class="cl"><span class="sd">    disableTXChecksumOffload: false
</span></span></span><span class="line"><span class="ln"> 31</span><span class="cl"><span class="sd">    wireGuard:
</span></span></span><span class="line"><span class="ln"> 32</span><span class="cl"><span class="sd">      port: 51820
</span></span></span><span class="line"><span class="ln"> 33</span><span class="cl"><span class="sd">    egress:
</span></span></span><span class="line"><span class="ln"> 34</span><span class="cl"><span class="sd">      exceptCIDRs: []
</span></span></span><span class="line"><span class="ln"> 35</span><span class="cl"><span class="sd">      maxEgressIPsPerNode: 255
</span></span></span><span class="line"><span class="ln"> 36</span><span class="cl"><span class="sd">    serviceCIDR: 10.132.0.0/16
</span></span></span><span class="line"><span class="ln"> 37</span><span class="cl"><span class="sd">    nodePortLocal:
</span></span></span><span class="line"><span class="ln"> 38</span><span class="cl"><span class="sd">      enable: true
</span></span></span><span class="line"><span class="ln"> 39</span><span class="cl"><span class="sd">      portRange: 61000-62000
</span></span></span><span class="line"><span class="ln"> 40</span><span class="cl"><span class="sd">    tlsCipherSuites: TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,TLS_RSA_WITH_AES_256_GCM_SHA384
</span></span></span><span class="line"><span class="ln"> 41</span><span class="cl"><span class="sd">    multicast: {}
</span></span></span><span class="line"><span class="ln"> 42</span><span class="cl"><span class="sd">    antreaProxy:
</span></span></span><span class="line"><span class="ln"> 43</span><span class="cl"><span class="sd">      proxyAll: false
</span></span></span><span class="line"><span class="ln"> 44</span><span class="cl"><span class="sd">      nodePortAddresses: []
</span></span></span><span class="line"><span class="ln"> 45</span><span class="cl"><span class="sd">      skipServices: []
</span></span></span><span class="line"><span class="ln"> 46</span><span class="cl"><span class="sd">      proxyLoadBalancerIPs: true
</span></span></span><span class="line"><span class="ln"> 47</span><span class="cl"><span class="sd">    multicluster:
</span></span></span><span class="line"><span class="ln"> 48</span><span class="cl"><span class="sd">      enableGateway: true #enabled
</span></span></span><span class="line"><span class="ln"> 49</span><span class="cl"><span class="sd">      namespace: antrea-multicluster
</span></span></span><span class="line"><span class="ln"> 50</span><span class="cl"><span class="sd">      enableStretchedNetworkPolicy: true #enabled
</span></span></span><span class="line"><span class="ln"> 51</span><span class="cl"><span class="sd">      enablePodToPodConnectivity: true #enabled</span><span class="w">    
</span></span></span><span class="line"><span class="ln"> 52</span><span class="cl"><span class="w">  </span><span class="nt">antrea-cni.conflist</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="ln"> 53</span><span class="cl"><span class="sd">    {
</span></span></span><span class="line"><span class="ln"> 54</span><span class="cl"><span class="sd">        &#34;cniVersion&#34;:&#34;0.3.0&#34;,
</span></span></span><span class="line"><span class="ln"> 55</span><span class="cl"><span class="sd">        &#34;name&#34;: &#34;antrea&#34;,
</span></span></span><span class="line"><span class="ln"> 56</span><span class="cl"><span class="sd">        &#34;plugins&#34;: [
</span></span></span><span class="line"><span class="ln"> 57</span><span class="cl"><span class="sd">            {
</span></span></span><span class="line"><span class="ln"> 58</span><span class="cl"><span class="sd">                &#34;type&#34;: &#34;antrea&#34;,
</span></span></span><span class="line"><span class="ln"> 59</span><span class="cl"><span class="sd">                &#34;ipam&#34;: {
</span></span></span><span class="line"><span class="ln"> 60</span><span class="cl"><span class="sd">                    &#34;type&#34;: &#34;host-local&#34;
</span></span></span><span class="line"><span class="ln"> 61</span><span class="cl"><span class="sd">                }
</span></span></span><span class="line"><span class="ln"> 62</span><span class="cl"><span class="sd">            }
</span></span></span><span class="line"><span class="ln"> 63</span><span class="cl"><span class="sd">            ,
</span></span></span><span class="line"><span class="ln"> 64</span><span class="cl"><span class="sd">            {
</span></span></span><span class="line"><span class="ln"> 65</span><span class="cl"><span class="sd">                &#34;type&#34;: &#34;portmap&#34;,
</span></span></span><span class="line"><span class="ln"> 66</span><span class="cl"><span class="sd">                &#34;capabilities&#34;: {&#34;portMappings&#34;: true}
</span></span></span><span class="line"><span class="ln"> 67</span><span class="cl"><span class="sd">            }
</span></span></span><span class="line"><span class="ln"> 68</span><span class="cl"><span class="sd">            ,
</span></span></span><span class="line"><span class="ln"> 69</span><span class="cl"><span class="sd">            {
</span></span></span><span class="line"><span class="ln"> 70</span><span class="cl"><span class="sd">                &#34;type&#34;: &#34;bandwidth&#34;,
</span></span></span><span class="line"><span class="ln"> 71</span><span class="cl"><span class="sd">                &#34;capabilities&#34;: {&#34;bandwidth&#34;: true}
</span></span></span><span class="line"><span class="ln"> 72</span><span class="cl"><span class="sd">            }
</span></span></span><span class="line"><span class="ln"> 73</span><span class="cl"><span class="sd">        ]
</span></span></span><span class="line"><span class="ln"> 74</span><span class="cl"><span class="sd">    }</span><span class="w">    
</span></span></span><span class="line"><span class="ln"> 75</span><span class="cl"><span class="w">  </span><span class="nt">antrea-controller.conf</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="ln"> 76</span><span class="cl"><span class="sd">    featureGates:
</span></span></span><span class="line"><span class="ln"> 77</span><span class="cl"><span class="sd">      Traceflow: true
</span></span></span><span class="line"><span class="ln"> 78</span><span class="cl"><span class="sd">      AntreaPolicy: true
</span></span></span><span class="line"><span class="ln"> 79</span><span class="cl"><span class="sd">      NetworkPolicyStats: false
</span></span></span><span class="line"><span class="ln"> 80</span><span class="cl"><span class="sd">      Multicast: false
</span></span></span><span class="line"><span class="ln"> 81</span><span class="cl"><span class="sd">      Egress: true
</span></span></span><span class="line"><span class="ln"> 82</span><span class="cl"><span class="sd">      AntreaIPAM: false
</span></span></span><span class="line"><span class="ln"> 83</span><span class="cl"><span class="sd">      ServiceExternalIP: false
</span></span></span><span class="line"><span class="ln"> 84</span><span class="cl"><span class="sd">      SupportBundleCollection: false
</span></span></span><span class="line"><span class="ln"> 85</span><span class="cl"><span class="sd">      L7NetworkPolicy: false
</span></span></span><span class="line"><span class="ln"> 86</span><span class="cl"><span class="sd">      Multicluster: true
</span></span></span><span class="line"><span class="ln"> 87</span><span class="cl"><span class="sd">    tlsCipherSuites: TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,TLS_RSA_WITH_AES_256_GCM_SHA384
</span></span></span><span class="line"><span class="ln"> 88</span><span class="cl"><span class="sd">    nodeIPAM: null
</span></span></span><span class="line"><span class="ln"> 89</span><span class="cl"><span class="sd">    multicluster:
</span></span></span><span class="line"><span class="ln"> 90</span><span class="cl"><span class="sd">      enableStretchedNetworkPolicy: true
</span></span></span><span class="line"><span class="ln"> 91</span><span class="cl"><span class="sd">    cloudProvider:
</span></span></span><span class="line"><span class="ln"> 92</span><span class="cl"><span class="sd">      name: &#34;&#34;</span><span class="w">    
</span></span></span><span class="line"><span class="ln"> 93</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 94</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 95</span><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 96</span><span class="cl"><span class="w">    </span><span class="nt">kapp.k14s.io/identity</span><span class="p">:</span><span class="w"> </span><span class="l">v1;kube-system//ConfigMap/antrea-config;v1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 97</span><span class="cl"><span class="w">    </span><span class="nt">kapp.k14s.io/original</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;{&#34;apiVersion&#34;:&#34;v1&#34;,&#34;data&#34;:{&#34;antrea-agent.conf&#34;:&#34;featureGates:\n  AntreaProxy:
</span></span></span><span class="line"><span class="ln"> 98</span><span class="cl"><span class="s1">      true\n  EndpointSlice: true\n  TopologyAwareHints: false\n  Traceflow: true\n  NodePortLocal:
</span></span></span><span class="line"><span class="ln"> 99</span><span class="cl"><span class="s1">      true\n  AntreaPolicy: true\n  FlowExporter: false\n  NetworkPolicyStats: false\n  Egress:
</span></span></span><span class="line"><span class="ln">100</span><span class="cl"><span class="s1">      true\n  AntreaIPAM: false\n  Multicast: false\n  Multicluster: true\n  SecondaryNetwork:
</span></span></span><span class="line"><span class="ln">101</span><span class="cl"><span class="s1">      false\n  ServiceExternalIP: false\n  TrafficControl: false\n  SupportBundleCollection:
</span></span></span><span class="line"><span class="ln">102</span><span class="cl"><span class="s1">      false\n  L7NetworkPolicy: false\ntrafficEncapMode: encap\nnoSNAT: false\ntunnelType:
</span></span></span><span class="line"><span class="ln">103</span><span class="cl"><span class="s1">      geneve\ntunnelPort: 0\ntunnelCsum: false\ntrafficEncryptionMode: none\nenableBridgingMode:
</span></span></span><span class="line"><span class="ln">104</span><span class="cl"><span class="s1">      false\ndisableTXChecksumOffload: false\nwireGuard:\n  port: 51820\negress:\n  exceptCIDRs:
</span></span></span><span class="line"><span class="ln">105</span><span class="cl"><span class="s1">      []\n  maxEgressIPsPerNode: 255\nserviceCIDR: 100.20.0.0/16\nnodePortLocal:\n  enable:
</span></span></span><span class="line"><span class="ln">106</span><span class="cl"><span class="s1">      true\n  portRange: 61000-62000\ntlsCipherSuites: TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,TLS_RSA_WITH_AES_256_GCM_SHA384\nmulticast:
</span></span></span><span class="line"><span class="ln">107</span><span class="cl"><span class="s1">      {}\nantreaProxy:\n  proxyAll: false\n  nodePortAddresses: []\n  skipServices:
</span></span></span><span class="line"><span class="ln">108</span><span class="cl"><span class="s1">      []\n  proxyLoadBalancerIPs: true\nmulticluster:\n  enableGateway: true\n  enableStretchedNetworkPolicy:
</span></span></span><span class="line"><span class="ln">109</span><span class="cl"><span class="s1">      true\n  enablePodToPodConnectivity: true\n&#34;,&#34;antrea-cni.conflist&#34;:&#34;{\n    \&#34;cniVersion\&#34;:\&#34;0.3.0\&#34;,\n    \&#34;name\&#34;:
</span></span></span><span class="line"><span class="ln">110</span><span class="cl"><span class="s1">      \&#34;antrea\&#34;,\n    \&#34;plugins\&#34;: [\n        {\n            \&#34;type\&#34;: \&#34;antrea\&#34;,\n            \&#34;ipam\&#34;:
</span></span></span><span class="line"><span class="ln">111</span><span class="cl"><span class="s1">      {\n                \&#34;type\&#34;: \&#34;host-local\&#34;\n            }\n        }\n        ,\n        {\n            \&#34;type\&#34;:
</span></span></span><span class="line"><span class="ln">112</span><span class="cl"><span class="s1">      \&#34;portmap\&#34;,\n            \&#34;capabilities\&#34;: {\&#34;portMappings\&#34;: true}\n        }\n        ,\n        {\n            \&#34;type\&#34;:
</span></span></span><span class="line"><span class="ln">113</span><span class="cl"><span class="s1">      \&#34;bandwidth\&#34;,\n            \&#34;capabilities\&#34;: {\&#34;bandwidth\&#34;: true}\n        }\n    ]\n}\n&#34;,&#34;antrea-controller.conf&#34;:&#34;featureGates:\n  Traceflow:
</span></span></span><span class="line"><span class="ln">114</span><span class="cl"><span class="s1">      true\n  AntreaPolicy: true\n  NetworkPolicyStats: false\n  Multicast: false\n  Egress:
</span></span></span><span class="line"><span class="ln">115</span><span class="cl"><span class="s1">      true\n  AntreaIPAM: false\n  ServiceExternalIP: false\n  SupportBundleCollection:
</span></span></span><span class="line"><span class="ln">116</span><span class="cl"><span class="s1">      false\n  L7NetworkPolicy: false\n  Multicluster: true\ntlsCipherSuites: TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,TLS_RSA_WITH_AES_256_GCM_SHA384\nnodeIPAM:
</span></span></span><span class="line"><span class="ln">117</span><span class="cl"><span class="s1">      null\nmulticluster:\n  enableStretchedNetworkPolicy: true\ncloudProvider:\n  name:
</span></span></span><span class="line"><span class="ln">118</span><span class="cl"><span class="s1">      \&#34;\&#34;\n&#34;},&#34;kind&#34;:&#34;ConfigMap&#34;,&#34;metadata&#34;:{&#34;labels&#34;:{&#34;app&#34;:&#34;antrea&#34;,&#34;kapp.k14s.io/app&#34;:&#34;1695711779258641591&#34;,&#34;kapp.k14s.io/association&#34;:&#34;v1.c39c4aca919097e50452c3432329dd40&#34;},&#34;name&#34;:&#34;antrea-config&#34;,&#34;namespace&#34;:&#34;kube-system&#34;}}&#39;</span><span class="w">
</span></span></span><span class="line"><span class="ln">119</span><span class="cl"><span class="w">    </span><span class="nt">kapp.k14s.io/original-diff-md5</span><span class="p">:</span><span class="w"> </span><span class="l">c6e94dc94aed3401b5d0f26ed6c0bff3</span><span class="w">
</span></span></span><span class="line"><span class="ln">120</span><span class="cl"><span class="w">  </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2023-09-26T07:03:04Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">121</span><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">122</span><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">antrea</span><span class="w">
</span></span></span><span class="line"><span class="ln">123</span><span class="cl"><span class="w">    </span><span class="nt">kapp.k14s.io/app</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;1695711779258641591&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">124</span><span class="cl"><span class="w">    </span><span class="nt">kapp.k14s.io/association</span><span class="p">:</span><span class="w"> </span><span class="l">v1.c39c4aca919097e50452c3432329dd40</span><span class="w">
</span></span></span><span class="line"><span class="ln">125</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">antrea-config</span><span class="w">
</span></span></span><span class="line"><span class="ln">126</span><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-system</span><span class="w">
</span></span></span><span class="line"><span class="ln">127</span><span class="cl"><span class="w">  </span><span class="nt">resourceVersion</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;902&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">128</span><span class="cl"><span class="w">  </span><span class="nt">uid</span><span class="p">:</span><span class="w"> </span><span class="l">49aea43b-4f8e-4f60-9d54-b299a73bdba8</span><span class="w">
</span></span></span></code></pre></div><p>Notice that the features have been enabled under the corresponding <strong>antrea-agent.conf</strong> and <strong>antrea-controller.conf</strong> sections.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">  </span><span class="nt">antrea-agent.conf</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="sd">    featureGates:
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="sd">      Multicluster: true #enabled
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="sd">    multicluster:
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="sd">      enableGateway: true #enabled
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="sd">      namespace: antrea-multicluster
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="sd">      enableStretchedNetworkPolicy: true #enabled
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="sd">      enablePodToPodConnectivity: true #enabled</span><span class="w">    
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">  </span><span class="nt">antrea-controller.conf</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="sd">    featureGates:
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="sd">      Multicluster: true #enabled
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="sd">    multicluster:
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="sd">      enableStretchedNetworkPolicy: true #enabled</span><span class="w">    
</span></span></span></code></pre></div><p>That's it for enabling Antrea Multi-cluster in TKG workload clusters.</p>
<h2 id="tanzu-in-vsphere-and-antrea-multi-cluster">Tanzu in vSphere and Antrea Multi-cluster</h2>
<p>Coming later - stay tuned</p>
<h2 id="install-and-configure-antrea-multi-cluster">Install and Configure Antrea Multi-cluster</h2>
<p>All the instructions for this exercise has been taken from the offial <a href="https://antrea.io/docs/v1.11.1/docs/multicluster/user-guide/">antrea.io</a> and the Antrea <a href="https://github.com/antrea-io/antrea/blob/release-1.11/docs/multicluster/user-guide.md">Github</a> pages.
My TKG Cluster-1 (Leader cluster) is up and running with the required Antrea Multi-cluster settings (see above) enabled. Now I will follow the user-guide which will involve installing the Antrea Multi-cluster controller in the leader cluster, create ClusterSet, Multi-cluster Gateway configuration. I will start doing all the steps that can be done on the Leader cluster, then take the member clusters next. I will be following the yaml approach. There is also another approach using <strong>antctl</strong> I may add that also or update the post at a later stage to involve these steps.</p>

<div class="notices info">
    <div class="label">Info</div>
    <p>It is important to follow the documentation according to the version of Antrea being used. This is due to updates in api, and general configuration settings. An example. If I am on Antrea v1.11.1 I would be using the following github or antrea url:
<a href="https://github.com/antrea-io/antrea/blob/release-1.11/docs/multicluster/user-guide.md">https://github.com/antrea-io/antrea/blob/release-1.11/docs/multicluster/user-guide.md</a>
<a href="https://antrea.io/docs/v1.11.1/docs/multicluster/user-guide/">https://antrea.io/docs/v1.11.1/docs/multicluster/user-guide/</a></p>
<p>If using Antrea v1.13.1 I would be using the following url:</p>
<p><a href="https://github.com/antrea-io/antrea/blob/release-1.13/docs/multicluster/user-guide.md">https://github.com/antrea-io/antrea/blob/release-1.13/docs/multicluster/user-guide.md</a>
<a href="https://antrea.io/docs/v1.13.1/docs/multicluster/user-guide/">https://antrea.io/docs/v1.13.1/docs/multicluster/user-guide/</a></p>

  </div>


<div class="notices info">
    <div class="label">Info</div>
    <p>Antrea Multi-cluster can be configured in different topologies</p>
<p>Read more here: <a href="https://github.com/antrea-io/antrea/blob/main/docs/multicluster/user-guide.md#deploy-antrea-multi-cluster-controller">https://github.com/antrea-io/antrea/blob/main/docs/multicluster/user-guide.md#deploy-antrea-multi-cluster-controller</a></p>

  </div>

<h3 id="install-the-antrea-multi-cluster-controller-in-the-dedicated-leader-cluster">Install the Antrea Multi-cluster controller in the dedicated leader cluster</h3>
<p>I will start by creating an enviroment variable, exporting the Antrea version I am using, for the following yaml manifests commands to use. Just to be certain I will first check the actual Antrea version by issuing the <strong>antctl version</strong> command inside the Antrea controller pod:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">k <span class="nb">exec</span> -it -n kube-system antrea-controller-75b85cf45b-hvhq4 bash
</span></span><span class="line"><span class="ln">2</span><span class="cl">kubectl <span class="nb">exec</span> <span class="o">[</span>POD<span class="o">]</span> <span class="o">[</span>COMMAND<span class="o">]</span> is DEPRECATED and will be removed in a future version. Use kubectl <span class="nb">exec</span> <span class="o">[</span>POD<span class="o">]</span> -- <span class="o">[</span>COMMAND<span class="o">]</span> instead.
</span></span><span class="line"><span class="ln">3</span><span class="cl">root@tkg-cluster-1-btnn5-vzq5n:/# antctl version
</span></span><span class="line"><span class="ln">4</span><span class="cl">antctlVersion: v1.11.1-4776f66
</span></span><span class="line"><span class="ln">5</span><span class="cl">controllerVersion: v1.11.1-4776f66
</span></span><span class="line"><span class="ln">6</span><span class="cl">root@tkg-cluster-1-btnn5-vzq5n:/#
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@tkg-bootstrap:~$ <span class="nb">export</span> <span class="nv">TAG</span><span class="o">=</span>v1.11.1
</span></span></code></pre></div><p>Install the Multi-cluster controller in the namespace <em>antrea-multicluster</em> issuing the following <strong>two</strong> yamls:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">kubectl apply -f https://github.com/antrea-io/antrea/releases/download/<span class="nv">$TAG</span>/antrea-multicluster-leader-global.yml
</span></span><span class="line"><span class="ln">2</span><span class="cl">kubectl apply -f https://github.com/antrea-io/antrea/releases/download/<span class="nv">$TAG</span>/antrea-multicluster-leader-namespaced.yml
</span></span></code></pre></div><p>Creating the namespace antrea-multicluster:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="ln">1</span><span class="cl">andreasm@tkg-bootstrap:~$ kubectl create ns antrea-multicluster
</span></span><span class="line"><span class="ln">2</span><span class="cl">namespace/antrea-multicluster created
</span></span></code></pre></div><p>Applying the antrea-multicluster-leader-global.yaml:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1">## Apply the antrea-multicluster-leader-global.yaml</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">andreasm@tkg-bootstrap:~$ kubectl apply -f https://github.com/antrea-io/antrea/releases/download/<span class="nv">$TAG</span>/antrea-multicluster-leader-global.yml
</span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="c1">## applied</span>
</span></span><span class="line"><span class="ln">4</span><span class="cl">customresourcedefinition.apiextensions.k8s.io/clusterclaims.multicluster.crd.antrea.io created
</span></span><span class="line"><span class="ln">5</span><span class="cl">customresourcedefinition.apiextensions.k8s.io/clustersets.multicluster.crd.antrea.io created
</span></span><span class="line"><span class="ln">6</span><span class="cl">customresourcedefinition.apiextensions.k8s.io/memberclusterannounces.multicluster.crd.antrea.io created
</span></span><span class="line"><span class="ln">7</span><span class="cl">customresourcedefinition.apiextensions.k8s.io/resourceexports.multicluster.crd.antrea.io created
</span></span><span class="line"><span class="ln">8</span><span class="cl">customresourcedefinition.apiextensions.k8s.io/resourceimports.multicluster.crd.antrea.io created
</span></span></code></pre></div><p>Applying the antrea-multicluster-leader-namespaced.yaml:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1">## Apply the antrea-multicluster-leader-namespaced.yaml</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">andreasm@tkg-bootstrap:~$ kubectl apply -f https://github.com/antrea-io/antrea/releases/download/<span class="nv">$TAG</span>/antrea-multicluster-leader-namespaced.yml
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="c1">## applied</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">serviceaccount/antrea-mc-controller created
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">serviceaccount/antrea-mc-member-access-sa created
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">role.rbac.authorization.k8s.io/antrea-mc-controller-role created
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">role.rbac.authorization.k8s.io/antrea-mc-member-cluster-role created
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">clusterrole.rbac.authorization.k8s.io/antrea-multicluster-antrea-mc-controller-webhook-role created
</span></span><span class="line"><span class="ln">10</span><span class="cl">rolebinding.rbac.authorization.k8s.io/antrea-mc-controller-rolebinding created
</span></span><span class="line"><span class="ln">11</span><span class="cl">rolebinding.rbac.authorization.k8s.io/antrea-mc-member-cluster-rolebinding created
</span></span><span class="line"><span class="ln">12</span><span class="cl">clusterrolebinding.rbac.authorization.k8s.io/antrea-multicluster-antrea-mc-controller-webhook-rolebinding created
</span></span><span class="line"><span class="ln">13</span><span class="cl">configmap/antrea-mc-controller-config created
</span></span><span class="line"><span class="ln">14</span><span class="cl">service/antrea-mc-webhook-service created
</span></span><span class="line"><span class="ln">15</span><span class="cl">Warning: would violate PodSecurity <span class="s2">&#34;restricted:v1.24&#34;</span>: host namespaces <span class="o">(</span><span class="nv">hostNetwork</span><span class="o">=</span><span class="nb">true</span><span class="o">)</span>, hostPort <span class="o">(</span>container <span class="s2">&#34;antrea-mc-controller&#34;</span> uses hostPort 9443<span class="o">)</span>, unrestricted capabilities <span class="o">(</span>container <span class="s2">&#34;antrea-mc-controller&#34;</span> must <span class="nb">set</span> securityContext.capabilities.drop<span class="o">=[</span><span class="s2">&#34;ALL&#34;</span><span class="o">])</span>, runAsNonRoot !<span class="o">=</span> <span class="nb">true</span> <span class="o">(</span>pod or container <span class="s2">&#34;antrea-mc-controller&#34;</span> must <span class="nb">set</span> securityContext.runAsNonRoot<span class="o">=</span><span class="nb">true</span><span class="o">)</span>, seccompProfile <span class="o">(</span>pod or container <span class="s2">&#34;antrea-mc-controller&#34;</span> must <span class="nb">set</span> securityContext.seccompProfile.type to <span class="s2">&#34;RuntimeDefault&#34;</span> or <span class="s2">&#34;Localhost&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">deployment.apps/antrea-mc-controller created
</span></span><span class="line"><span class="ln">17</span><span class="cl">mutatingwebhookconfiguration.admissionregistration.k8s.io/antrea-multicluster-antrea-mc-mutating-webhook-configuration created
</span></span><span class="line"><span class="ln">18</span><span class="cl">validatingwebhookconfiguration.admissionregistration.k8s.io/antrea-multicluster-antrea-mc-validating-webhook-configuration created
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@tkg-bootstrap:~$ k get pods -n antrea-multicluster
</span></span><span class="line"><span class="ln">2</span><span class="cl">NAME                                    READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="ln">3</span><span class="cl">antrea-mc-controller-7697c8b776-dqtzp   1/1     Running   <span class="m">0</span>          58s
</span></span></code></pre></div><p>And the Antrea CRDs including the additional CRDs from the Multi-cluster installation:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">aandreasm@tkg-bootstrap:~$ k get crd -A
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">NAME                                                     CREATED AT
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">antreaagentinfos.crd.antrea.io                           2023-09-26T07:03:02Z
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">antreacontrollerinfos.crd.antrea.io                      2023-09-26T07:03:02Z
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">clusterclaims.multicluster.crd.antrea.io                 2023-09-27T06:59:07Z
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">clustergroups.crd.antrea.io                              2023-09-26T07:03:04Z
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">clusternetworkpolicies.crd.antrea.io                     2023-09-26T07:03:02Z
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">clustersets.multicluster.crd.antrea.io                   2023-09-27T06:59:07Z
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">egresses.crd.antrea.io                                   2023-09-26T07:03:02Z
</span></span><span class="line"><span class="ln">10</span><span class="cl">externalentities.crd.antrea.io                           2023-09-26T07:03:02Z
</span></span><span class="line"><span class="ln">11</span><span class="cl">externalippools.crd.antrea.io                            2023-09-26T07:03:02Z
</span></span><span class="line"><span class="ln">12</span><span class="cl">externalnodes.crd.antrea.io                              2023-09-26T07:03:02Z
</span></span><span class="line"><span class="ln">13</span><span class="cl">groups.crd.antrea.io                                     2023-09-26T07:03:04Z
</span></span><span class="line"><span class="ln">14</span><span class="cl">ippools.crd.antrea.io                                    2023-09-26T07:03:02Z
</span></span><span class="line"><span class="ln">15</span><span class="cl">memberclusterannounces.multicluster.crd.antrea.io        2023-09-27T06:59:08Z
</span></span><span class="line"><span class="ln">16</span><span class="cl">multiclusteringresses.ako.vmware.com                     2023-09-26T07:03:51Z
</span></span><span class="line"><span class="ln">17</span><span class="cl">networkpolicies.crd.antrea.io                            2023-09-26T07:03:02Z
</span></span><span class="line"><span class="ln">18</span><span class="cl">resourceexports.multicluster.crd.antrea.io               2023-09-27T06:59:12Z
</span></span><span class="line"><span class="ln">19</span><span class="cl">resourceimports.multicluster.crd.antrea.io               2023-09-27T06:59:15Z
</span></span><span class="line"><span class="ln">20</span><span class="cl">supportbundlecollections.crd.antrea.io                   2023-09-26T07:03:03Z
</span></span><span class="line"><span class="ln">21</span><span class="cl">tierentitlementbindings.crd.antrea.tanzu.vmware.com      2023-09-26T07:03:04Z
</span></span><span class="line"><span class="ln">22</span><span class="cl">tierentitlements.crd.antrea.tanzu.vmware.com             2023-09-26T07:03:02Z
</span></span><span class="line"><span class="ln">23</span><span class="cl">tiers.crd.antrea.io                                      2023-09-26T07:03:03Z
</span></span><span class="line"><span class="ln">24</span><span class="cl">traceflows.crd.antrea.io                                 2023-09-26T07:03:03Z
</span></span><span class="line"><span class="ln">25</span><span class="cl">trafficcontrols.crd.antrea.io                            2023-09-26T07:03:03Z
</span></span></code></pre></div><h3 id="install-the-antrea-multi-cluster-controller-in-the-member-clusters">Install the Antrea Multi-cluster controller in the member clusters</h3>
<p>Next up is to deploy the Antrea Multi-cluster in both of my member clusters, tkg-cluster-2 and tkg-cluster-3. They have also been configured to enable the Multi-cluster feature gate. This operation involves applying the antrea-multicluster-member.yaml</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">andreasm@tkg-bootstrap:~$ k config current-context
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">tkg-cluster-2-admin@tkg-cluster-2
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="c1"># Show running pods</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">NAMESPACE              NAME                                                     READY   STATUS      RESTARTS      AGE
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">avi-system             ako-0                                                    1/1     Running     <span class="m">0</span>             19h
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">kube-system            antrea-agent-grq68                                       2/2     Running     <span class="m">0</span>             18h
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">kube-system            antrea-agent-kcbc8                                       2/2     Running     <span class="m">0</span>             18h
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">kube-system            antrea-agent-zvgcc                                       2/2     Running     <span class="m">0</span>             18h
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">kube-system            antrea-controller-bc584bbcd-7hw7n                        1/1     Running     <span class="m">0</span>             18h
</span></span><span class="line"><span class="ln">10</span><span class="cl">kube-system            coredns-75f565d4dd-48sgb                                 1/1     Running     <span class="m">0</span>             19h
</span></span><span class="line"><span class="ln">11</span><span class="cl">kube-system            coredns-75f565d4dd-wr8pl                                 1/1     Running     <span class="m">0</span>             19h
</span></span><span class="line"><span class="ln">12</span><span class="cl">kube-system            etcd-tkg-cluster-2-jzmpk-w2thj                           1/1     Running     <span class="m">0</span>             19h
</span></span><span class="line"><span class="ln">13</span><span class="cl">kube-system            kube-apiserver-tkg-cluster-2-jzmpk-w2thj                 1/1     Running     <span class="m">0</span>             19h
</span></span><span class="line"><span class="ln">14</span><span class="cl">kube-system            kube-controller-manager-tkg-cluster-2-jzmpk-w2thj        1/1     Running     <span class="m">0</span>             19h
</span></span><span class="line"><span class="ln">15</span><span class="cl">kube-system            kube-proxy-dmcb5                                         1/1     Running     <span class="m">0</span>             19h
</span></span><span class="line"><span class="ln">16</span><span class="cl">kube-system            kube-proxy-kr5hl                                         1/1     Running     <span class="m">0</span>             19h
</span></span><span class="line"><span class="ln">17</span><span class="cl">kube-system            kube-proxy-t7qqp                                         1/1     Running     <span class="m">0</span>             19h
</span></span><span class="line"><span class="ln">18</span><span class="cl">kube-system            kube-scheduler-tkg-cluster-2-jzmpk-w2thj                 1/1     Running     <span class="m">0</span>             19h
</span></span><span class="line"><span class="ln">19</span><span class="cl">kube-system            metrics-server-5666ffccb9-p7qqw                          1/1     Running     <span class="m">0</span>             19h
</span></span><span class="line"><span class="ln">20</span><span class="cl">kube-system            vsphere-cloud-controller-manager-6b8v2                   1/1     Running     <span class="m">0</span>             19h
</span></span><span class="line"><span class="ln">21</span><span class="cl">secretgen-controller   secretgen-controller-69cbc65949-2x8nv                    1/1     Running     <span class="m">0</span>             19h
</span></span><span class="line"><span class="ln">22</span><span class="cl">tkg-system             kapp-controller-5776b48998-7rkzf                         2/2     Running     <span class="m">0</span>             19h
</span></span><span class="line"><span class="ln">23</span><span class="cl">tkg-system             tanzu-capabilities-controller-manager-77d8ffcd57-9tgzn   1/1     Running     <span class="m">0</span>             19h
</span></span><span class="line"><span class="ln">24</span><span class="cl">vmware-system-antrea   register-placeholder-m5bj8                               0/1     Completed   <span class="m">0</span>             8m41s
</span></span><span class="line"><span class="ln">25</span><span class="cl">vmware-system-csi      vsphere-csi-controller-67799db966-qnfv2                  7/7     Running     <span class="m">1</span> <span class="o">(</span>19h ago<span class="o">)</span>   19h
</span></span><span class="line"><span class="ln">26</span><span class="cl">vmware-system-csi      vsphere-csi-node-dkcf7                                   3/3     Running     <span class="m">2</span> <span class="o">(</span>19h ago<span class="o">)</span>   19h
</span></span><span class="line"><span class="ln">27</span><span class="cl">vmware-system-csi      vsphere-csi-node-w8dqw                                   3/3     Running     <span class="m">3</span> <span class="o">(</span>31m ago<span class="o">)</span>   19h
</span></span><span class="line"><span class="ln">28</span><span class="cl">vmware-system-csi      vsphere-csi-node-zxpmz                                   3/3     Running     <span class="m">4</span> <span class="o">(</span>19h ago<span class="o">)</span>   19h
</span></span></code></pre></div><p>Apply the multicluster-member.yaml</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">andreasm@tkg-bootstrap:~$ kubectl apply -f https://github.com/antrea-io/antrea/releases/download/<span class="nv">$TAG</span>/antrea-multicluster-member.yml
</span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="c1">## applied</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">customresourcedefinition.apiextensions.k8s.io/clusterclaims.multicluster.crd.antrea.io created
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">customresourcedefinition.apiextensions.k8s.io/clusterinfoimports.multicluster.crd.antrea.io created
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">customresourcedefinition.apiextensions.k8s.io/clustersets.multicluster.crd.antrea.io created
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">customresourcedefinition.apiextensions.k8s.io/gateways.multicluster.crd.antrea.io created
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">customresourcedefinition.apiextensions.k8s.io/labelidentities.multicluster.crd.antrea.io created
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">customresourcedefinition.apiextensions.k8s.io/serviceexports.multicluster.x-k8s.io created
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">customresourcedefinition.apiextensions.k8s.io/serviceimports.multicluster.x-k8s.io created
</span></span><span class="line"><span class="ln">10</span><span class="cl">serviceaccount/antrea-mc-controller created
</span></span><span class="line"><span class="ln">11</span><span class="cl">clusterrole.rbac.authorization.k8s.io/antrea-mc-controller-role created
</span></span><span class="line"><span class="ln">12</span><span class="cl">clusterrolebinding.rbac.authorization.k8s.io/antrea-mc-controller-rolebinding created
</span></span><span class="line"><span class="ln">13</span><span class="cl">configmap/antrea-mc-controller-config created
</span></span><span class="line"><span class="ln">14</span><span class="cl">service/antrea-mc-webhook-service created
</span></span><span class="line"><span class="ln">15</span><span class="cl">deployment.apps/antrea-mc-controller created
</span></span><span class="line"><span class="ln">16</span><span class="cl">mutatingwebhookconfiguration.admissionregistration.k8s.io/antrea-mc-mutating-webhook-configuration created
</span></span><span class="line"><span class="ln">17</span><span class="cl">validatingwebhookconfiguration.admissionregistration.k8s.io/antrea-mc-validating-webhook-configuration created
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">NAMESPACE              NAME                                                     READY   STATUS      RESTARTS      AGE
</span></span><span class="line"><span class="ln">2</span><span class="cl">kube-system            antrea-mc-controller-5bb945f87f-xk287                    1/1     Running     <span class="m">0</span>             64s
</span></span></code></pre></div><p>The controller is running, and it is running in the kube-system namespace.</p>
<p>Now I will repeat the same operation for my tkg-cluster-3...</p>
<h2 id="create-clusterset">Create ClusterSet</h2>
<p>Creating ClusterSet involves a couple of steps on both Leader cluster and member clusters.</p>
<h3 id="on-the-leader-cluster---create-serviceaccounts">On the Leader Cluster - Create ServiceAccounts</h3>
<p>First I will configure a ServiceAccount for each member to access the Leader cluster's API.</p>
<p>In my <strong>Leader cluster</strong> I will apply the following yaml:</p>
<p>Member 1, tkg-cluster-2, will be called <strong>member-blue</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c">## This the yaml for creating the Service Account for member-blue</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ServiceAccount</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">member-blue</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">antrea-multicluster</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Secret</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">member-blue-token</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">antrea-multicluster</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">    </span><span class="nt">kubernetes.io/service-account.name</span><span class="p">:</span><span class="w"> </span><span class="l">member-blue</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w"></span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes.io/service-account-token</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">RoleBinding</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">member-blue</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">antrea-multicluster</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w"></span><span class="nt">roleRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">  </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">  </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Role</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">antrea-mc-member-cluster-role</span><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w"></span><span class="nt">subjects</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w">  </span>- <span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ServiceAccount</span><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">member-blue</span><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">antrea-multicluster</span><span class="w">
</span></span></span></code></pre></div><p>Apply it:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@tkg-bootstrap:~$ k apply -f sa-member-blue.yaml
</span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="c1">## applied</span>
</span></span><span class="line"><span class="ln">3</span><span class="cl">serviceaccount/member-blue created
</span></span><span class="line"><span class="ln">4</span><span class="cl">secret/member-blue-token created
</span></span><span class="line"><span class="ln">5</span><span class="cl">rolebinding.rbac.authorization.k8s.io/member-blue created
</span></span></code></pre></div><p>Now create a token yaml file for member blue:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">kubectl get secret member-blue-token -n antrea-multicluster -o yaml <span class="p">|</span> grep -w -e <span class="s1">&#39;^apiVersion&#39;</span> -e <span class="s1">&#39;^data&#39;</span> -e <span class="s1">&#39;^metadata&#39;</span> -e <span class="s1">&#39;^ *name:&#39;</span>  -e   <span class="s1">&#39;^kind&#39;</span> -e <span class="s1">&#39;  ca.crt&#39;</span> -e <span class="s1">&#39;  token:&#39;</span> -e <span class="s1">&#39;^type&#39;</span> -e <span class="s1">&#39;  namespace&#39;</span> <span class="p">|</span> sed -e <span class="s1">&#39;s/kubernetes.io\/service-account-token/Opaque/g&#39;</span> -e <span class="s1">&#39;s/antrea-multicluster/kube-system/g&#39;</span> &gt;  member-blue-token.yml
</span></span></code></pre></div><p>This should create the file <strong>member-blue-token.yaml</strong> and the content of the file:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c"># cat member-blue-token.yml</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="l">cat member-blue-token.yml</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="c">## output</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">  </span><span class="nt">ca.crt</span><span class="p">:</span><span class="w"> </span><span class="l">LS0tLS1CRUdJ0tCk1JSUM2akNDQWRLZ0F3SUJBZ0lCQURBTkJna3Foa2lHOXcwQkFRc0ZBREFWTVJNd0VRWURWUVFERXdwcmRXSmwKY201bGRHVnpNQjRYRFRJek1Ea3lOakEyTlRReU5Wb1hEVE16TURreU16QTJOVGt5TlZvd0ZURVRNQkVHQTFVRQpBeE1LYTNWaVpYSnVaWFJsY3pDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBTDh2Ck1iWHc0MFM2NERZc2dnMG9qSEVwUHlOOC93MVBkdFE2cGxSSThvbUVuWW1ramc5TThIN3NrTDhqdHR1WXRxQVkKYnorZEFsVmJBcWRrWCtkL3Q5MTZGOWRBYmRveW9Qc3pwREIraVVQdDZ5Nm5YbDhPK0xEV2JWZzdEWTVXQ3lYYQpIeEJBM1I4NUUxRkhvYUxBREZ6OFRsZ2lKR3RZYktROFJYTWlIMk1xczRaNU9Mblp3Qy9rSTNVNEEzMVFlcXl3Cm1VMjd2SDdzZjlwK0tiTE5wZldtMDJoV3hZNzlMS1hCNE1LOStLaXAyVkt4VUlQbHl6bGpXTjQrcngyclN4bVEKbnpmR3NpT0JQTWpOanpQOE44cWJub01hL2Jd1haOHJpazhnenJGN05sQQp6R1BvdC84S2Q5UXZ2Q2doVVlNQ0F3RUFBYU5GTUVNd0RnWURWUjBQQVFIL0JBUURBZ0trTUJJR0ExVWRFd0VCCi93UUlNQVlCQWY4Q0FRQXdIUVlEVlIwT0JCWUVGQk9PWHcrb1o1VGhLQ3I5RnBMWm9ySkZZWW1wTUEwR0NTcUcKU0liM0RRRUJDd1VBQTRJQkFRQ2Rpa2lWYi9pblk1RVNIdVVIcTY2YnBLK1RTQXI5eTFERnN0Qjd2eUt3UGduVAp2bGdEZnZnN1o3UTVOaFhzcFBnV1Y4NEZMMU80UUQ1WmtTYzhLcDVlM1V1ZFFvckRQS3VEOWkzNHVXVVc0TVo5ClR2UUJLNS9sRUlsclBONG5XYmEyazYrOE9tZitmWWREd3JsZTVaa3JUOHh6UnhEbEtXdE5vNVRHMWgrMElUOVgKcVMwL1hzNFpISlU2NGd5dlRsQXlwR2pPdFdxMUc0MEZ5U3dydFJLSE52a3JjTStkeDdvTEM1d003ZTZSTHg1cApnb0Y5dGZZV3ZyUzJWWjl2RUR5QllPN1RheFhEMGlaV2V1VEh0ZFJxTWVLZVAvei9lYnZJMUkvRkWS9NNGdxYjdXbGVqM0JNS051TVc2Q1AwUmFYcXJnUmpnVTAKLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQu=</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">YW50cmVhLW11bHRpY2x1c3Rlcg==</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">  </span><span class="nt">token</span><span class="p">:</span><span class="w"> </span><span class="l">WXlKaGJHY2lPaUpTVXpJMCUVRGaWNIUlJTR0Z1VnpkTU1GVjVOalF3VWpKcVNFVXdYMFkzZDFsNmJqWXpUa3hzVUc4aWZRLmV5SnBjM01pT2lKcmRXSmxjbTVsZEdWekwzTmxjblpwWTJWaFkyTnZkVzUwSWl3aWEzVmlaWEp1WlhSbGN5NXBieTl6WlhKMmFXTmxZV05qYjNWdWRDOXVZVzFsYzNCaFkyVWlPaUpoYm5SeVpXRXRiWFZzZEdsamJIVnpkR1Z5SWl3aWEzVmlaWEp1WlhSbGN5NXBieTl6WlhKMmFXTmxZV05qYjNWdWRDOXpaV055WlhRdWJtRnRaU0k2SW0xbGJXSmxjaTFpYkhWbExYUnZhMlZ1SWl3aWEzVmlaWEp1WlhSbGN5NXBieTl6WlhKMmFXTmxZV05qY5RdWJtRnRaU0k2SW0xbGJXSmxjaTFpYkhWbElpd2lhM1ZpWlhKdVpYUmxjeTVwYnk5elpYSjJhV05sWVdOamIzVnVkQzl6WlhKMmFXTmxMV0ZqWTI5MWJuUXVkV2xrSWpvaU1XSTVaVGd4TUdVdE5tTTNaQzAwTjJZekxXRTVaR1F0TldWbU4yTXpPVEE0T0dNNElpd2ljM1ZpSWpvaWMzbHpkR1Z0T25ObGNuWnBZMlZoWTJOdmRXNTBPbUZ1ZEhKbFlTMXRkV3gwYVdOc2RYTjBaWEk2YldWdFltVnlMV0pzZFdVaWZRLmNyU29sN0JzS2JyR2lhUVYyWmJ2OG8tUVl1eVBfWGlnZ1hfcDg2UGs0ZEpVOTBwWk1XYUZTUkFUR1ptQnBCUUJnajI5eVJHbkdvajVHRWN3YVNxWlZaV3FySk9jVTM1QXFlWHhpWm1fUl9LWDB4VUR1Y0wxQTVxNdWhOYTBGUkxmU2FKWUNOME1NTHNKVTBDU3pHUVg1dHlzTXBUN0YwVG0weS1mZFpVOE9IQmJoY0ZDWXkyYk5WdC0weU9pQUlYOHR2TVNrb2NzaHpWUm5ha1A5dmtMaXNVUGh2Vm9xMVROZ2RVRmtjc0lPRjl4ZFo5Ul9PX3NlT1ZLay1hNkhJbjB3THQzZ3FEZHRHU09Ub3BfMUh0djgxeEZQdF9zNlVRNmpldjZpejh3aFAzX1BkSGhwTlNCWFBEc3hZbEhyMlVaUK==</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Secret</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">member-blue-token</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-system</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w"></span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Opaque</span><span class="w">
</span></span></span></code></pre></div><p><strong>Repeating the steps for my member cluster 2 (tkg-cluster-3)</strong></p>
<p>Member 2, tkg-cluster-3, will be called <strong>member-red</strong> (yes you guessed it right)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c">## This the yaml for creating the Service Account for member-blue</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ServiceAccount</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">member-red</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">antrea-multicluster</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Secret</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">member-red-token</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">antrea-multicluster</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">    </span><span class="nt">kubernetes.io/service-account.name</span><span class="p">:</span><span class="w"> </span><span class="l">member-red</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w"></span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes.io/service-account-token</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">RoleBinding</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">member-red</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">antrea-multicluster</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w"></span><span class="nt">roleRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">  </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">  </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Role</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">antrea-mc-member-cluster-role</span><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w"></span><span class="nt">subjects</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w">  </span>- <span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ServiceAccount</span><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">member-red</span><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">antrea-multicluster</span><span class="w">
</span></span></span></code></pre></div><p>Apply it:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@tkg-bootstrap:~$ k apply -f sa-member-red.yaml
</span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="c1">## applied</span>
</span></span><span class="line"><span class="ln">3</span><span class="cl">serviceaccount/member-red created
</span></span><span class="line"><span class="ln">4</span><span class="cl">secret/member-red-token created
</span></span><span class="line"><span class="ln">5</span><span class="cl">rolebinding.rbac.authorization.k8s.io/member-red created
</span></span></code></pre></div><p>Now create a token yaml file for member red:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">kubectl get secret member-red-token -n antrea-multicluster -o yaml <span class="p">|</span> grep -w -e <span class="s1">&#39;^apiVersion&#39;</span> -e <span class="s1">&#39;^data&#39;</span> -e <span class="s1">&#39;^metadata&#39;</span> -e <span class="s1">&#39;^ *name:&#39;</span>  -e   <span class="s1">&#39;^kind&#39;</span> -e <span class="s1">&#39;  ca.crt&#39;</span> -e <span class="s1">&#39;  token:&#39;</span> -e <span class="s1">&#39;^type&#39;</span> -e <span class="s1">&#39;  namespace&#39;</span> <span class="p">|</span> sed -e <span class="s1">&#39;s/kubernetes.io\/service-account-token/Opaque/g&#39;</span> -e <span class="s1">&#39;s/antrea-multicluster/kube-system/g&#39;</span> &gt;  member-blue-token.yml
</span></span></code></pre></div><p>This should create the file <strong>member-red-token.yaml</strong> and the content of the file:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c"># cat member-red-token.yml</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="l">cat member-red-token.yml</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="c">## output</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">  </span><span class="nt">ca.crt</span><span class="p">:</span><span class="w"> </span><span class="l">LS0tLS1CRUdJ0tCk1JSUM2akNDQWRLZ0F3SUJBZ0lCQURBTkJna3Foa2lHOXcwQkFRc0ZBREFWTVJNd0VRWURWUVFERXdwcmRXSmwKY201bGRHVnpNQjRYRFRJek1Ea3lOakEyTlRReU5Wb1hEVE16TURreU16QTJOVGt5TlZvd0ZURVRNQkVHQTFVRQpBeE1LYTNWaVpYSnVaWFJsY3pDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBTDh2Ck1iWHc0MFM2NERZc2dnMG9qSEVwUHlOOC93MVBkdFE2cGxSSThvbUVuWW1ramc5TThIN3NrTDhqdHR1WXRxQVkKYnorZEFsVmJBcWRrWCtkL3Q5MTZGOWRBYmRveW9Qc3pwREIraVVQdDZ5Nm5YbDhPK0xEV2JWZzdEWTVXQ3lYYQpIeEJBM1I4NUUxRkhvYUxBREZ6OFRsZ2lKR3RZYktROFJYTWlIMk1xczRaNU9Mblp3Qy9rSTNVNEEzMVFlcXl3Cm1VMjd2SDdzZjlwK0tiTE5wZldtMDJoV3hZNzlMS1hCNE1LOStLaXAyVkt4VUlQbHl6bGpXTjQrcngyclN4bVEKbnpmR3NpT0JQTWpOanpQOE44cWJub01hL2Jd1haOHJpazhnenJGN05sQQp6R1BvdC84S2Q5UXZ2Q2doVVlNQ0F3RUFBYU5GTUVNd0RnWURWUjBQQVFIL0JBUURBZ0trTUJJR0ExVWRFd0VCCi93UUlNQVlCQWY4Q0FRQXdIUVlEVlIwT0JCWUVGQk9PWHcrb1o1VGhLQ3I5RnBMWm9ySkZZWW1wTUEwR0NTcUcKU0liM0RRRUJDd1VBQTRJQkFRQ2Rpa2lWYi9pblk1RVNIdVVIcTY2YnBLK1RTQXI5eTFERnN0Qjd2eUt3UGduVAp2bGdEZnZnN1o3UTVOaFhzcFBnV1Y4NEZMMU80UUQ1WmtTYzhLcDVlM1V1ZFFvckRQS3VEOWkzNHVXVVc0TVo5ClR2UUJLNS9sRUlsclBONG5XYmEyazYrOE9tZitmWWREd3JsZTVaa3JUOHh6UnhEbEtXdE5vNVRHMWgrMElUOVgKcVMwL1hzNFpISlU2NGd5dlRsQXlwR2pPdFdxMUc0MEZ5U3dydFJLSE52a3JjTStkeDdvTEM1d003ZTZSTHg1cApnb0Y5dGZZV3ZyUzJWWjl2RUR5QllPN1RheFhEMGlaV2V1VEh0ZFJxTWVLZVAvei9lYnZJMUkvRkWS9NNGdxYjdXbGVqM0JNS051TVc2Q1AwUmFYcXJnUmpnVTAKLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQu=</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">YW50cmVhLW11bHRpY2x1c3Rlcg==</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">  </span><span class="nt">token</span><span class="p">:</span><span class="w"> </span><span class="l">WXlKaGJHY2lPaUpTVXpJMCUVRGaWNIUlJTR0Z1VnpkTU1GVjVOalF3VWpKcVNFVXdYMFkzZDFsNmJqWXpUa3hzVUc4aWZRLmV5SnBjM01pT2lKcmRXSmxjbTVsZEdWekwzTmxjblpwWTJWaFkyTnZkVzUwSWl3aWEzVmlaWEp1WlhSbGN5NXBieTl6WlhKMmFXTmxZV05qYjNWdWRDOXVZVzFsYzNCaFkyVWlPaUpoYm5SeVpXRXRiWFZzZEdsamJIVnpkR1Z5SWl3aWEzVmlaWEp1WlhSbGN5NXBieTl6WlhKMmFXTmxZV05qYjNWdWRDOXpaV055WlhRdWJtRnRaU0k2SW0xbGJXSmxjaTFpYkhWbExYUnZhMlZ1SWl3aWEzVmlaWEp1WlhSbGN5NXBieTl6WlhKMmFXTmxZV05qY5RdWJtRnRaU0k2SW0xbGJXSmxjaTFpYkhWbElpd2lhM1ZpWlhKdVpYUmxjeTVwYnk5elpYSjJhV05sWVdOamIzVnVkQzl6WlhKMmFXTmxMV0ZqWTI5MWJuUXVkV2xrSWpvaU1XSTVaVGd4TUdVdE5tTTNaQzAwTjJZekxXRTVaR1F0TldWbU4yTXpPVEE0T0dNNElpd2ljM1ZpSWpvaWMzbHpkR1Z0T25ObGNuWnBZMlZoWTJOdmRXNTBPbUZ1ZEhKbFlTMXRkV3gwYVdOc2RYTjBaWEk2YldWdFltVnlMV0pzZFdVaWZRLmNyU29sN0JzS2JyR2lhUVYyWmJ2OG8tUVl1eVBfWGlnZ1hfcDg2UGs0ZEpVOTBwWk1XYUZTUkFUR1ptQnBCUUJnajI5eVJHbkdvajVHRWN3YVNxWlZaV3FySk9jVTM1QXFlWHhpWm1fUl9LWDB4VUR1Y0wxQTVxNdWhOYTBGUkxmU2FKWUNOME1NTHNKVTBDU3pHUVg1dHlzTXBUN0YwVG0weS1mZFpVOE9IQmJoY0ZDWXkyYk5WdC0weU9pQUlYOHR2TVNrb2NzaHpWUm5ha1A5dmtMaXNVUGh2Vm9xMVROZ2RVRmtjc0lPRjl4ZFo5Ul9PX3NlT1ZLay1hNkhJbjB3THQzZ3FEZHRHU09Ub3BfMUh0djgxeEZQdF9zNlVRNmpldjZpejh3aFAzX1BkSGhwTlNCWFBEc3hZbEhyMlVaUK==</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Secret</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">member-red-token</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-system</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w"></span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Opaque</span><span class="w">
</span></span></span></code></pre></div><h3 id="on-the-member-cluster-apply-tokens">On the Member Cluster apply tokens</h3>
<p>Now on both members apply the corresponding token yaml, member-1 applies the <strong>member-blue-token.yaml</strong> and member-2 applies the <strong>member-red-token.yaml</strong>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1">## tkg-cluster-2</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">andreasm@tkg-bootstrap:~$ k apply -f member-blue-token.yml
</span></span><span class="line"><span class="ln">3</span><span class="cl">secret/member-blue-token created
</span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="c1">## tkg-cluster-3</span>
</span></span><span class="line"><span class="ln">5</span><span class="cl">andreasm@tkg-bootstrap:~$ k apply -f member-red-token.yml
</span></span><span class="line"><span class="ln">6</span><span class="cl">secret/member-red-token created
</span></span></code></pre></div><h3 id="on-the-leader-cluster---clusterset-initialization">On the Leader Cluster - ClusterSet Initialization</h3>
<p>I am using Antrea version 1.11.1 (that comes with TKG 2.3) so in this step we need to use the v1alpha1 api.</p>
<p>First I need to create a ClusterSet in the Leader cluster by applying the below yaml:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">multicluster.crd.antrea.io/v1alpha2</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterClaim</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">id.k8s.io</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">antrea-multicluster</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w"></span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l">tkg-cluster-leader</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">multicluster.crd.antrea.io/v1alpha2</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterClaim</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">clusterset.k8s.io</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">antrea-multicluster</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w"></span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l">andreasm-clusterset</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">multicluster.crd.antrea.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterSet</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">andreasm-clusterset</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">antrea-multicluster</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">  </span><span class="nt">leaders</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">    </span>- <span class="nt">clusterID</span><span class="p">:</span><span class="w"> </span><span class="l">tkg-cluster-leader</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1">## apply it</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">andreasm@tkg-bootstrap:~$ k apply -f clusterset-leader.yaml
</span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="c1">### applied</span>
</span></span><span class="line"><span class="ln">4</span><span class="cl">clusterclaim.multicluster.crd.antrea.io/id.k8s.io created
</span></span><span class="line"><span class="ln">5</span><span class="cl">clusterclaim.multicluster.crd.antrea.io/clusterset.k8s.io created
</span></span><span class="line"><span class="ln">6</span><span class="cl">clusterset.multicluster.crd.antrea.io/andreasm-clusterset created
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@tkg-bootstrap:~$ k get clustersets.multicluster.crd.antrea.io -A
</span></span><span class="line"><span class="ln">2</span><span class="cl">NAMESPACE             NAME                  LEADER CLUSTER NAMESPACE   TOTAL CLUSTERS   READY CLUSTERS   AGE
</span></span><span class="line"><span class="ln">3</span><span class="cl">antrea-multicluster   andreasm-clusterset                                                                84s
</span></span><span class="line"><span class="ln">4</span><span class="cl">andreasm@tkg-bootstrap:~$ k get clusterclaims.multicluster.crd.antrea.io -A
</span></span><span class="line"><span class="ln">5</span><span class="cl">NAMESPACE             NAME                VALUE                 AGE
</span></span><span class="line"><span class="ln">6</span><span class="cl">antrea-multicluster   clusterset.k8s.io   andreasm-clusterset   118s
</span></span><span class="line"><span class="ln">7</span><span class="cl">antrea-multicluster   id.k8s.io           tkg-cluster-leader    119s
</span></span></code></pre></div><h3 id="on-the-member-clusters---clusterset-initialization">On the Member Clusters - ClusterSet Initialization</h3>
<p>Next step is to deploy the corresponding yaml on both my member clusters (tkg-cluster-2=member-cluster-blue and tkg-cluster-3=member-cluster-red):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">multicluster.crd.antrea.io/v1alpha2</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterClaim</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">id.k8s.io</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-system</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w"></span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l">member-cluster-blue</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">multicluster.crd.antrea.io/v1alpha2</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterClaim</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">clusterset.k8s.io</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-system</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w"></span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l">andreasm-clusterset</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">multicluster.crd.antrea.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterSet</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">andreasm-clusterset</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-system</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">  </span><span class="nt">leaders</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">    </span>- <span class="nt">clusterID</span><span class="p">:</span><span class="w"> </span><span class="l">tkg-cluster-leader</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">      </span><span class="nt">secret</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;member-blue-token&#34;</span><span class="w"> </span><span class="c"># secret/token created earlier</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">      </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;https://10.101.114.100:6443&#34;</span><span class="w"> </span><span class="c"># reflect the correct endpoint IP for leader cluster</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">antrea-multicluster</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">multicluster.crd.antrea.io/v1alpha2</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterClaim</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">id.k8s.io</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-system</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w"></span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l">member-cluster-red</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">multicluster.crd.antrea.io/v1alpha2</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterClaim</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">clusterset.k8s.io</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-system</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w"></span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l">andreasm-clusterset</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">multicluster.crd.antrea.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterSet</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">andreasm-clusterset</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-system</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">  </span><span class="nt">leaders</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">    </span>- <span class="nt">clusterID</span><span class="p">:</span><span class="w"> </span><span class="l">tkg-cluster-leader</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">      </span><span class="nt">secret</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;member-red-token&#34;</span><span class="w"> </span><span class="c"># secret/token created earlier</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">      </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;https://10.101.114.100:6443&#34;</span><span class="w"> </span><span class="c"># reflect the correct endpoint IP for leader cluster</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">antrea-multicluster</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1">## tkg-cluster-2</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">andreasm@tkg-bootstrap:~$ k apply -f clusterclaim-member-blue.yaml
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="c1">## applied</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">clusterclaim.multicluster.crd.antrea.io/id.k8s.io created
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">clusterclaim.multicluster.crd.antrea.io/clusterset.k8s.io created
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">clusterset.multicluster.crd.antrea.io/andreasm-clusterset created
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="c1">## tkg-cluster-3</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">andreasm@tkg-bootstrap:~$ k apply -f clusterclaim-member-red.yaml
</span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="c1">## applied</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">clusterclaim.multicluster.crd.antrea.io/id.k8s.io created
</span></span><span class="line"><span class="ln">11</span><span class="cl">clusterclaim.multicluster.crd.antrea.io/clusterset.k8s.io created
</span></span><span class="line"><span class="ln">12</span><span class="cl">clusterset.multicluster.crd.antrea.io/andreasm-clusterset created
</span></span></code></pre></div><h3 id="on-the-member-clusters---multi-cluster-gateway-configuration">On the Member Clusters - Multi-cluster Gateway configuration</h3>
<p>From the docs:</p>
<blockquote>
<p>Multi-cluster Gateways are required to support multi-cluster Service access across member clusters. Each member cluster should have one Node served as its Multi-cluster Gateway. Multi-cluster Service traffic is routed among clusters through the tunnels between Gateways.</p>
<p>After a member cluster joins a ClusterSet, and the <code>Multicluster</code> feature is enabled on <code>antrea-agent</code>, you can select a Node of the cluster to serve as the Multi-cluster Gateway by adding an annotation: <code>multicluster.antrea.io/gateway=true</code> to the K8s Node.</p>
<p>You can annotate multiple Nodes in a member cluster as the candidates for Multi-cluster Gateway, but only one Node will be selected as the active Gateway. Before Antrea v1.9.0, the Gateway Node is just randomly selected and will never change unless the Node or its <code>gateway</code> annotation is deleted. Starting with Antrea v1.9.0, Antrea Multi-cluster Controller will guarantee a &quot;ready&quot; Node is selected as the Gateway, and when the current Gateway Node's status changes to not &quot;ready&quot;, Antrea will try selecting another &quot;ready&quot; Node from the candidate Nodes to be the Gateway.</p>
</blockquote>
<p>I will annotate both my worker nodes in both my member clusters, blue and red.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@tkg-bootstrap:~/Kubernetes-library/tkgm/antrea-multicluster$ k annotate node tkg-cluster-2-md-0-qhqgb-58df8c59f4xxb5q8-s7w2z multicluster.antrea.io/gateway<span class="o">=</span><span class="nb">true</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">node/tkg-cluster-2-md-0-qhqgb-58df8c59f4xxb5q8-s7w2z annotated
</span></span><span class="line"><span class="ln">3</span><span class="cl">
</span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="c1">## Will repeat this for both nodes in both clusters</span>
</span></span></code></pre></div><p>Then check which node that has been decided in both clusters:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1">## tkg cluster 2 - member blue</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">andreasm@tkg-bootstrap:~$ k get gateway -n kube-system
</span></span><span class="line"><span class="ln">3</span><span class="cl">NAME                                              GATEWAY IP     INTERNAL IP    AGE
</span></span><span class="line"><span class="ln">4</span><span class="cl">tkg-cluster-2-md-0-qhqgb-58df8c59f4xxb5q8-s7w2z   10.101.12.24   10.101.12.24   4m18s
</span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="c1">## tkg cluster 3 - member red</span>
</span></span><span class="line"><span class="ln">6</span><span class="cl">andreasm@tkg-bootstrap:~$ k get gateway -n kube-system
</span></span><span class="line"><span class="ln">7</span><span class="cl">NAME                                              GATEWAY IP     INTERNAL IP    AGE
</span></span><span class="line"><span class="ln">8</span><span class="cl">tkg-cluster-3-md-0-82gh2-6dcf989cbcxnc8lc-z5c8g   10.101.12.26   10.101.12.26   116s
</span></span></code></pre></div><p>And the logs from the Antrea MC controller after adding the gateway annotation:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">I0928 09:46:01.599697       <span class="m">1</span> clusterset_controller.go:111<span class="o">]</span> <span class="s2">&#34;Received ClusterSet add/update&#34;</span> <span class="nv">clusterset</span><span class="o">=</span><span class="s2">&#34;kube-system/andreasm-clusterset&#34;</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">I0928 09:46:01.599772       <span class="m">1</span> controller_utils.go:40<span class="o">]</span> <span class="s2">&#34;Validating ClusterClaim&#34;</span> <span class="nv">namespace</span><span class="o">=</span><span class="s2">&#34;kube-system&#34;</span>
</span></span><span class="line"><span class="ln">3</span><span class="cl">I0928 09:46:01.701456       <span class="m">1</span> controller_utils.go:52<span class="o">]</span> <span class="s2">&#34;Processing ClusterClaim&#34;</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&#34;id.k8s.io&#34;</span> <span class="nv">value</span><span class="o">=</span><span class="s2">&#34;member-cluster-blue&#34;</span>
</span></span><span class="line"><span class="ln">4</span><span class="cl">I0928 09:46:01.701484       <span class="m">1</span> controller_utils.go:52<span class="o">]</span> <span class="s2">&#34;Processing ClusterClaim&#34;</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&#34;clusterset.k8s.io&#34;</span> <span class="nv">value</span><span class="o">=</span><span class="s2">&#34;andreasm-clusterset&#34;</span>
</span></span><span class="line"><span class="ln">5</span><span class="cl">I0928 09:46:01.701907       <span class="m">1</span> clusterset_controller.go:204<span class="o">]</span> <span class="s2">&#34;Creating RemoteCommonArea&#34;</span> <span class="nv">cluster</span><span class="o">=</span>tkg-cluster-leader
</span></span><span class="line"><span class="ln">6</span><span class="cl">I0928 09:46:02.236829       <span class="m">1</span> remote_common_area.go:111<span class="o">]</span> <span class="s2">&#34;Create a RemoteCommonArea&#34;</span> <span class="nv">cluster</span><span class="o">=</span>tkg-cluster-leader
</span></span><span class="line"><span class="ln">7</span><span class="cl">I0928 09:46:02.237004       <span class="m">1</span> clusterset_controller.go:251<span class="o">]</span> <span class="s2">&#34;Created RemoteCommonArea&#34;</span> <span class="nv">cluster</span><span class="o">=</span>tkg-cluster-leader
</span></span><span class="line"><span class="ln">8</span><span class="cl">I0928 09:46:02.237064       <span class="m">1</span> remote_common_area.go:293<span class="o">]</span> <span class="s2">&#34;Starting MemberAnnounce to RemoteCommonArea&#34;</span> <span class="nv">cluster</span><span class="o">=</span>tkg-cluster-leader
</span></span><span class="line"><span class="ln">9</span><span class="cl">I0928 09:46:02.388473       <span class="m">1</span> remote_common_area.go:236<span class="o">]</span> <span class="s2">&#34;Updating RemoteCommonArea status&#34;</span> <span class="nv">cluster</span><span class="o">=</span>tkg-cluster-leader <span class="nv">connected</span><span class="o">=</span><span class="nb">true</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">I0928 09:49:17.663979       <span class="m">1</span> clusterset_controller.go:111<span class="o">]</span> <span class="s2">&#34;Received ClusterSet add/update&#34;</span> <span class="nv">clusterset</span><span class="o">=</span><span class="s2">&#34;kube-system/andreasm-clusterset&#34;</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">I0928 09:49:17.664066       <span class="m">1</span> controller_utils.go:40<span class="o">]</span> <span class="s2">&#34;Validating ClusterClaim&#34;</span> <span class="nv">namespace</span><span class="o">=</span><span class="s2">&#34;kube-system&#34;</span>
</span></span><span class="line"><span class="ln">3</span><span class="cl">I0928 09:49:17.764734       <span class="m">1</span> controller_utils.go:52<span class="o">]</span> <span class="s2">&#34;Processing ClusterClaim&#34;</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&#34;id.k8s.io&#34;</span> <span class="nv">value</span><span class="o">=</span><span class="s2">&#34;member-cluster-red&#34;</span>
</span></span><span class="line"><span class="ln">4</span><span class="cl">I0928 09:49:17.764778       <span class="m">1</span> controller_utils.go:52<span class="o">]</span> <span class="s2">&#34;Processing ClusterClaim&#34;</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&#34;clusterset.k8s.io&#34;</span> <span class="nv">value</span><span class="o">=</span><span class="s2">&#34;andreasm-clusterset&#34;</span>
</span></span><span class="line"><span class="ln">5</span><span class="cl">I0928 09:49:17.764855       <span class="m">1</span> clusterset_controller.go:204<span class="o">]</span> <span class="s2">&#34;Creating RemoteCommonArea&#34;</span> <span class="nv">cluster</span><span class="o">=</span>tkg-cluster-leader
</span></span><span class="line"><span class="ln">6</span><span class="cl">I0928 09:49:18.251398       <span class="m">1</span> remote_common_area.go:111<span class="o">]</span> <span class="s2">&#34;Create a RemoteCommonArea&#34;</span> <span class="nv">cluster</span><span class="o">=</span>tkg-cluster-leader
</span></span><span class="line"><span class="ln">7</span><span class="cl">I0928 09:49:18.251475       <span class="m">1</span> clusterset_controller.go:251<span class="o">]</span> <span class="s2">&#34;Created RemoteCommonArea&#34;</span> <span class="nv">cluster</span><span class="o">=</span>tkg-cluster-leader
</span></span><span class="line"><span class="ln">8</span><span class="cl">I0928 09:49:18.251588       <span class="m">1</span> remote_common_area.go:293<span class="o">]</span> <span class="s2">&#34;Starting MemberAnnounce to RemoteCommonArea&#34;</span> <span class="nv">cluster</span><span class="o">=</span>tkg-cluster-leader
</span></span><span class="line"><span class="ln">9</span><span class="cl">I0928 09:49:18.363564       <span class="m">1</span> remote_common_area.go:236<span class="o">]</span> <span class="s2">&#34;Updating RemoteCommonArea status&#34;</span> <span class="nv">cluster</span><span class="o">=</span>tkg-cluster-leader <span class="nv">connected</span><span class="o">=</span><span class="nb">true</span>
</span></span></code></pre></div><p>Now on both member clusters, they should have received and be aware of their fellow member clusters network information. This can be verified with the following command on both member clusters:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1">## member-red - tkg-cluster-3</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">andreasm@tkg-bootstrap:~$ k get clusterinfoimports.multicluster.crd.antrea.io -n kube-system
</span></span><span class="line"><span class="ln">3</span><span class="cl">NAME                              CLUSTER ID            SERVICE CIDR    AGE
</span></span><span class="line"><span class="ln">4</span><span class="cl">member-cluster-blue-clusterinfo   member-cluster-blue   10.134.0.0/16   69s
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1">## member-blue - tkg-cluster-2</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">andreasm@tkg-bootstrap:~$ k get clusterinfoimports.multicluster.crd.antrea.io -n kube-system
</span></span><span class="line"><span class="ln">3</span><span class="cl">NAME                             CLUSTER ID           SERVICE CIDR    AGE
</span></span><span class="line"><span class="ln">4</span><span class="cl">member-cluster-red-clusterinfo   member-cluster-red   10.136.0.0/16   3m10s
</span></span></code></pre></div><p>Now that Antrea Multi-cluster has been configured, its time to head over to the section on what we can use this for.</p>
<p>This his how my environment looks like now:</p>
<img src=images/image-20230929095322735.png style="width:600px" />
<p>Member cluster blue is exchanging information to member cluster red via the leader cluster using their gateway currently active on worker-node-md-0 in both member clusters.</p>
<h2 id="using-antctl">Using antctl</h2>
<p>For now I will just link to the GitHub docs of Antrea how to use the <strong>antctl</strong> approach.</p>
<p>For how to use the antctl approach, click <a href="https://github.com/antrea-io/antrea/blob/release-1.11/docs/multicluster/quick-start.md#steps-with-antctl">here</a></p>
<p>To use the <strong>antctl</strong> cli tool download the corresponding Antrea version of antctl <a href="https://github.com/antrea-io/antrea/releases/">here</a></p>
<h2 id="multi-cluster-service">Multi-cluster Service</h2>
<p>Imagine you have an application that consists of a frontend and a backend. The frontend must run on a dedicated cluster or multiple clusters for scalability, easier exposure, and security posture reasons. The backend services should be running in a more controlled &quot;inner&quot; cluster. Using Antrea Multi-cluster that is possible. Lets go through how to configure this.</p>
<p>First I will deploy an application called Yelb <a href="https://github.com/mreferre/yelb">source</a>. This consists of a frontend service &quot;<em>yelb-ui</em>&quot;and three backend applications &quot;<em>application, redis and PostgreSQL</em>&quot;.</p>
<p>This is how the architecture of Yelb looks like:</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="yelb"
      
        class="image_figure image_internal image_processed"
        width="537"
        height="448"
        src="/2023/09/25/antrea-multi-cluster-in-tkg-and-vsphere-with-tanzu/images/image-20230929100641589.png"
      
      
    />

    </picture>
</figure>
</p>
<p>I want the <em>yelb-ui</em> to only run in the member cluster blue, and I want all the backends to run in the member cluster red. Like this:</p>
<img src=images/image-20230928121935733.png style="width:600px" />
<p>I will start with deploying the backend part of the Yelb application in my member cluster red:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1">## Backend pods running in member-red</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">andreasm@tkg-bootstrap:~$ k get pods -n yelb -o wide
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">NAME                              READY   STATUS    RESTARTS   AGE     IP             NODE                                              NOMINATED NODE   READINESS GATES
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">redis-server-56d97cc8c-dzbg7      1/1     Running   <span class="m">0</span>          5m38s   100.10.2.157   tkg-cluster-3-md-0-82gh2-6dcf989cbcxnc8lc-z5c8g   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">yelb-appserver-65855b7ffd-nggg9   1/1     Running   <span class="m">0</span>          5m36s   100.10.2.159   tkg-cluster-3-md-0-82gh2-6dcf989cbcxnc8lc-z5c8g   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">yelb-db-6f78dc6f8f-5dgpv          1/1     Running   <span class="m">0</span>          5m37s   100.10.2.158   tkg-cluster-3-md-0-82gh2-6dcf989cbcxnc8lc-z5c8g   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="c1">## Backend services running in member-red</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">andreasm@tkg-bootstrap:~$ k get svc -n yelb
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">NAME             TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>    AGE
</span></span><span class="line"><span class="ln">10</span><span class="cl">redis-server     ClusterIP   100.20.176.130   &lt;none&gt;        6379/TCP   2m29s
</span></span><span class="line"><span class="ln">11</span><span class="cl">yelb-appserver   ClusterIP   100.20.111.133   &lt;none&gt;        4567/TCP   2m27s
</span></span><span class="line"><span class="ln">12</span><span class="cl">yelb-db          ClusterIP   100.20.7.160     &lt;none&gt;        5432/TCP   2m28s
</span></span></code></pre></div><p>Now I will deploy the frontend service in the member cluster blue</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@tkg-bootstrap:~$ k get pods -n yelb
</span></span><span class="line"><span class="ln">2</span><span class="cl">NAME                       READY   STATUS             RESTARTS      AGE
</span></span><span class="line"><span class="ln">3</span><span class="cl">yelb-ui-5c5b8d8887-wkchd   0/1     CrashLoopBackOff   <span class="m">3</span> <span class="o">(</span>20s ago<span class="o">)</span>   2m49s
</span></span></code></pre></div><p>its deployed, but not running. It cant reach the backend service <strong>yelb-appserver</strong> as this is running on a completely different cluster.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@tkg-bootstrap:~$ k logs -n yelb yelb-ui-7bc645756b-qmtbp
</span></span><span class="line"><span class="ln">2</span><span class="cl">2023/09/29 06:16:17 <span class="o">[</span>emerg<span class="o">]</span> 10#10: host not found in upstream <span class="s2">&#34;antrea-mc-yelb-appserver&#34;</span> in /etc/nginx/conf.d/default.conf:5
</span></span><span class="line"><span class="ln">3</span><span class="cl">nginx: <span class="o">[</span>emerg<span class="o">]</span> host not found in upstream <span class="s2">&#34;antrea-mc-yelb-appserver&#34;</span> in /etc/nginx/conf.d/default.conf:5
</span></span></code></pre></div><p>Its also red in my NSX-ALB environment.</p>
<img src=images/image-20230928123452397.png style="width:500px" />
<p>Now I will export the <strong>yelb-appserver</strong> service using Antrea Multi-cluster Service, so any pods running in member-blue can also use this service running on member-red. For the Yelb UI to work it needs to talk to the appserver service (yelb-appserver).</p>
<p>From the source, where the yelb-appserver service is defined locally and running, I need to define a ServiceExport which is just using the name of the original service and the namespace where the service is located:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln">1</span><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">multicluster.x-k8s.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ServiceExport</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">yelb-appserver</span><span class="w"> </span><span class="c">## name of service you want to export</span><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">yelb</span><span class="w"> </span><span class="c">## namespace of the service</span><span class="w">
</span></span></span></code></pre></div><p>Apply it</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@tkg-bootstrap:~$ k apply -f yelb-app-service-export.yaml
</span></span><span class="line"><span class="ln">2</span><span class="cl">serviceexport.multicluster.x-k8s.io/yelb-appserver created
</span></span></code></pre></div><p>From the leader-cluster I can check all the resourceexports and resourceimports:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@tkg-bootstrap:~$ k get resourceexports.multicluster.crd.antrea.io -n antrea-multicluster
</span></span><span class="line"><span class="ln">2</span><span class="cl">NAME                                               CLUSTER ID            KIND          NAMESPACE     NAME                  AGE
</span></span><span class="line"><span class="ln">3</span><span class="cl">member-cluster-blue-clusterinfo                    member-cluster-blue   ClusterInfo   kube-system   member-cluster-blue   53m
</span></span><span class="line"><span class="ln">4</span><span class="cl">member-cluster-red-clusterinfo                     member-cluster-red    ClusterInfo   kube-system   member-cluster-red    51m
</span></span><span class="line"><span class="ln">5</span><span class="cl">member-cluster-red-yelb-yelb-appserver-endpoints   member-cluster-red    Endpoints     yelb          yelb-appserver        2m59s
</span></span><span class="line"><span class="ln">6</span><span class="cl">member-cluster-red-yelb-yelb-appserver-service     member-cluster-red    Service       yelb          yelb-appserver        2m59s
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@tkg-bootstrap:~$ k get resourceimports.multicluster.crd.antrea.io -n antrea-multicluster
</span></span><span class="line"><span class="ln">2</span><span class="cl">NAME                              KIND            NAMESPACE             NAME                              AGE
</span></span><span class="line"><span class="ln">3</span><span class="cl">member-cluster-blue-clusterinfo   ClusterInfo     antrea-multicluster   member-cluster-blue-clusterinfo   55m
</span></span><span class="line"><span class="ln">4</span><span class="cl">member-cluster-red-clusterinfo    ClusterInfo     antrea-multicluster   member-cluster-red-clusterinfo    53m
</span></span><span class="line"><span class="ln">5</span><span class="cl">yelb-yelb-appserver-endpoints     Endpoints       yelb                  yelb-appserver                    4m41s
</span></span><span class="line"><span class="ln">6</span><span class="cl">yelb-yelb-appserver-service       ServiceImport   yelb                  yelb-appserver                    4m41s
</span></span></code></pre></div><p>So my <strong>yelb-appserver</strong> service has been exported.</p>
<p>What happens now in my member cluster blue? For the service to be imported into my member blue cluster it needs to have the namespace <strong>yelb</strong> created, otherwise it will not be imported. I have the ns yelb created as the yelb-ui is already deployed in this namespace. In my member cluster blue I can now see that I have the service <strong>yelb-appserver</strong> imported. Its there. Yay.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@tkg-bootstrap:~$ k get serviceimports.multicluster.x-k8s.io -A
</span></span><span class="line"><span class="ln">2</span><span class="cl">NAMESPACE   NAME             TYPE           IP                   AGE
</span></span><span class="line"><span class="ln">3</span><span class="cl">yelb        yelb-appserver   ClusterSetIP   <span class="o">[</span><span class="s2">&#34;100.40.224.145&#34;</span><span class="o">]</span>   15m
</span></span><span class="line"><span class="ln">4</span><span class="cl">andreasm@tkg-bootstrap:~$ k get serviceimports.multicluster.x-k8s.io -n yelb
</span></span><span class="line"><span class="ln">5</span><span class="cl">NAME             TYPE           IP                   AGE
</span></span><span class="line"><span class="ln">6</span><span class="cl">yelb-appserver   ClusterSetIP   <span class="o">[</span><span class="s2">&#34;100.40.224.145&#34;</span><span class="o">]</span>   17m
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@tkg-bootstrap:~$ k get svc -n yelb
</span></span><span class="line"><span class="ln">2</span><span class="cl">NAME                       TYPE           CLUSTER-IP       EXTERNAL-IP      PORT<span class="o">(</span>S<span class="o">)</span>        AGE
</span></span><span class="line"><span class="ln">3</span><span class="cl">antrea-mc-yelb-appserver   ClusterIP      100.40.224.145   &lt;none&gt;           4567/TCP       19m
</span></span><span class="line"><span class="ln">4</span><span class="cl">yelb-ui                    LoadBalancer   100.40.136.62    10.101.115.100   80:30425/TCP   26m
</span></span></code></pre></div><p>Will my yelb-ui pod figure this out then?</p>
<p>The yelb-ui pod is running:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">amarqvardsen@amarqvards1MD6T:~/Kubernetes-library/tkgm/antrea-multicluster/yelb$ k get pods -n yelb
</span></span><span class="line"><span class="ln">2</span><span class="cl">NAME                       READY   STATUS    RESTARTS       AGE
</span></span><span class="line"><span class="ln">3</span><span class="cl">yelb-ui-5c5b8d8887-wkchd   1/1     Running   <span class="m">5</span> <span class="o">(</span>5m5s ago<span class="o">)</span>   8m17s
</span></span></code></pre></div><p>The VS is green:</p>
<img src=images/image-20230928144110457.png style="width:600px" />
<p>And inside the application itself I can also see the app server it is currently using:</p>
<img src=images/image-20230929101557537.png style="width:500px" />
<p>And doing a quick sanity check. Where are my pods running.
The yelb-ui pod is running in member cluster blue:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">NAME                       READY   STATUS    RESTARTS       AGE    IP            NODE                                              NOMINATED NODE   READINESS GATES
</span></span><span class="line"><span class="ln">2</span><span class="cl">yelb-ui-7bc645756b-qmtbp   1/1     Running   <span class="m">5</span> <span class="o">(</span>121m ago<span class="o">)</span>   124m   10.133.1.56   tkg-cluster-2-md-1-wmxhd-5998fcf669x64b9h-z7mnw   &lt;none&gt;           &lt;none&gt;
</span></span></code></pre></div><p>And the appserver pod is running:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">NAME                             READY   STATUS    RESTARTS   AGE    IP            NODE                                              NOMINATED NODE   READINESS GATES
</span></span><span class="line"><span class="ln">2</span><span class="cl">redis-server-56d97cc8c-wvc4q     1/1     Running   <span class="m">0</span>          126m   10.135.1.53   tkg-cluster-3-md-1-824bx-5bdb559f7bxqgbb8-bqwnr   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="ln">3</span><span class="cl">yelb-appserver-d9ddcdd97-z8gt9   1/1     Running   <span class="m">0</span>          126m   10.135.1.55   tkg-cluster-3-md-1-824bx-5bdb559f7bxqgbb8-bqwnr   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="ln">4</span><span class="cl">yelb-db-749c784cb8-f6wx8         1/1     Running   <span class="m">0</span>          126m   10.135.1.54   tkg-cluster-3-md-1-824bx-5bdb559f7bxqgbb8-bqwnr   &lt;none&gt;           &lt;none&gt;
</span></span></code></pre></div><p>Notice the name from the ui of the app above on the name of the pod listed. Its the same pod.</p>
<h3 id="recap-of-multi-cluster-service">Recap of Multi-cluster service.</h3>
<ul>
<li>In member cluster red I deployed the three backends needed for the Yelb application. These consists of 3 PODs and their corresponding services. As of now they are just local and accessible internally in the same k8s cluster.</li>
</ul>
<img src=images/image-20230929083246372.png style="width:300px" />
<ul>
<li>In member cluster blue I deployed the Yelb UI service, in a CrashLoopBackOff as it cant reach the necessary appserver service.</li>
</ul>
<img src=images/image-20230929102300345.png style="width:300px" />
<ul>
<li>Then I exported the <strong>yelb-appserver</strong> using Antrea Multi-cluster Services</li>
</ul>
<img src=images/image-20230929102744189.png style="width:600px" />
<p>And the Yelb application lived happily ever after 🆒</p>
<h3 id="quick-troubleshooting">Quick troubleshooting</h3>
<p>Just to add an easy way to verify the exported services work. I deployed a simple nginx pod in member cluster red. Exported the nginx ClusterIP service, from my member cluster blue I have deployed a Ubuntu pod. From this pod I will do a curl to the exported nginx service to see if I can reach it and if it works.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1">## nginx pod running in member cluster red</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">NAME                        READY   STATUS    RESTARTS   AGE    IP            NODE                                              NOMINATED NODE   READINESS GATES
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">nginx-ui-59c956b95b-qhz8n   1/1     Running   <span class="m">0</span>          151m   10.135.1.56   tkg-cluster-3-md-1-824bx-5bdb559f7bxqgbb8-bqwnr   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="c1">## nginx local clusterip service</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">NAME              TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>   AGE
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">nginx             ClusterIP   10.136.40.246    &lt;none&gt;        80/TCP    152m
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="c1">## the exported nginx service in my member cluster blue</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">NAME              TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>   AGE
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">antrea-mc-nginx   ClusterIP   10.134.30.220   &lt;none&gt;        80/TCP    147m
</span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="c1">## from my ubuntu pod in member cluster blue</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">root@ubuntu-20-04-cbb58d77-tcrjb:/# nslookup 10.134.30.220
</span></span><span class="line"><span class="ln">12</span><span class="cl">220.30.134.10.in-addr.arpa	<span class="nv">name</span> <span class="o">=</span> antrea-mc-nginx.nginx.svc.cluster.local.
</span></span><span class="line"><span class="ln">13</span><span class="cl">
</span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="c1">## curl the dns name</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">root@ubuntu-20-04-cbb58d77-tcrjb:/# curl http://antrea-mc-nginx.nginx.svc.cluster.local
</span></span><span class="line"><span class="ln">16</span><span class="cl">&lt;!DOCTYPE html&gt;
</span></span><span class="line"><span class="ln">17</span><span class="cl">&lt;html&gt;
</span></span><span class="line"><span class="ln">18</span><span class="cl">&lt;head&gt;
</span></span><span class="line"><span class="ln">19</span><span class="cl">&lt;title&gt;Welcome to nginx!&lt;/title&gt;
</span></span><span class="line"><span class="ln">20</span><span class="cl">&lt;style&gt;
</span></span><span class="line"><span class="ln">21</span><span class="cl">html <span class="o">{</span> color-scheme: light dark<span class="p">;</span> <span class="o">}</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl">body <span class="o">{</span> width: 35em<span class="p">;</span> margin: <span class="m">0</span> auto<span class="p">;</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl">font-family: Tahoma, Verdana, Arial, sans-serif<span class="p">;</span> <span class="o">}</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl">&lt;/style&gt;
</span></span><span class="line"><span class="ln">25</span><span class="cl">&lt;/head&gt;
</span></span><span class="line"><span class="ln">26</span><span class="cl">&lt;body&gt;
</span></span><span class="line"><span class="ln">27</span><span class="cl">&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;
</span></span><span class="line"><span class="ln">28</span><span class="cl">&lt;p&gt;If you see this page, the nginx web server is successfully installed and
</span></span><span class="line"><span class="ln">29</span><span class="cl">working. Further configuration is required.&lt;/p&gt;
</span></span><span class="line"><span class="ln">30</span><span class="cl">
</span></span><span class="line"><span class="ln">31</span><span class="cl">&lt;p&gt;For online documentation and support please refer to
</span></span><span class="line"><span class="ln">32</span><span class="cl">&lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&#34;http://nginx.org/&#34;</span>&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;
</span></span><span class="line"><span class="ln">33</span><span class="cl">Commercial support is available at
</span></span><span class="line"><span class="ln">34</span><span class="cl">&lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&#34;http://nginx.com/&#34;</span>&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;
</span></span><span class="line"><span class="ln">35</span><span class="cl">
</span></span><span class="line"><span class="ln">36</span><span class="cl">&lt;p&gt;&lt;em&gt;Thank you <span class="k">for</span> using nginx.&lt;/em&gt;&lt;/p&gt;
</span></span><span class="line"><span class="ln">37</span><span class="cl">&lt;/body&gt;
</span></span><span class="line"><span class="ln">38</span><span class="cl">&lt;/html&gt;
</span></span></code></pre></div><h3 id="failure-scenario">Failure scenario</h3>
<p>What happens if a node which currently holds the active gateway goes down?</p>
<img src=images/image-20230930211539280.png style="width:600px" />
<p>Lets test that. Currently these are my active gateways in member-cluster-blue and red respectively:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1">## get the current gateway in member-cluster blue</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">k get gateway -A
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">NAMESPACE     NAME                                             GATEWAY IP     INTERNAL IP    AGE
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">kube-system   tkg-cluster-2-md-0-vrt25-7f44f4798xqbk9h-tc979   10.101.12.14   10.101.12.14   37h
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="c1">## list all nodes in my member-cluster blue</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">k get nodes -owide
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">NAME                                              STATUS   ROLES           AGE   VERSION            INTERNAL-IP    EXTERNAL-IP    OS-IMAGE             KERNEL-VERSION      CONTAINER-RUNTIME
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">tkg-cluster-2-md-0-vrt25-7f44f4798xqbk9h-tc979    Ready    &lt;none&gt;          46h   v1.26.5+vmware.2   10.101.12.14   10.101.12.14   Ubuntu 20.04.6 LTS   5.4.0-152-generic   containerd://1.6.18-1-gdbc99e5b1
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">tkg-cluster-2-md-1-wmxhd-5998fcf669x64b9h-z7mnw   Ready    &lt;none&gt;          46h   v1.26.5+vmware.2   10.101.12.13   10.101.12.13   Ubuntu 20.04.6 LTS   5.4.0-152-generic   containerd://1.6.18-1-gdbc99e5b1
</span></span><span class="line"><span class="ln">10</span><span class="cl">tkg-cluster-2-x2fqj-fxswx                         Ready    control-plane   46h   v1.26.5+vmware.2   10.101.12.33   10.101.12.33   Ubuntu 20.04.6 LTS   5.4.0-152-generic   containerd://1.6.18-1-gdbc99e5b1
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1">## get the current gateway in member-cluster red</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">k get gateway -A
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">NAMESPACE     NAME                                             GATEWAY IP     INTERNAL IP    AGE
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">kube-system   tkg-cluster-3-md-0-h5ppw-9db445579xq45bn-nsq98   10.101.12.38   10.101.12.38   37h
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="c1">## list all nodes in my member-cluster red</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">k get nodes -o wide
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">NAME                                              STATUS   ROLES           AGE   VERSION            INTERNAL-IP    EXTERNAL-IP    OS-IMAGE             KERNEL-VERSION      CONTAINER-RUNTIME
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">tkg-cluster-3-krrwq-p588j                         Ready    control-plane   46h   v1.26.5+vmware.2   10.101.12.28   10.101.12.28   Ubuntu 20.04.6 LTS   5.4.0-152-generic   containerd://1.6.18-1-gdbc99e5b1
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">tkg-cluster-3-md-0-h5ppw-9db445579xq45bn-nsq98    Ready    &lt;none&gt;          46h   v1.26.5+vmware.2   10.101.12.38   10.101.12.38   Ubuntu 20.04.6 LTS   5.4.0-152-generic   containerd://1.6.18-1-gdbc99e5b1
</span></span><span class="line"><span class="ln">10</span><span class="cl">tkg-cluster-3-md-1-824bx-5bdb559f7bxqgbb8-bqwnr   Ready    &lt;none&gt;          46h   v1.26.5+vmware.2   10.101.12.17   10.101.12.17   Ubuntu 20.04.6 LTS   5.4.0-152-generic   containerd://1.6.18-1-gdbc99e5b1
</span></span></code></pre></div><p>Now I will shutdown the node that currently is the active gateway in my member-cluster blue. I will from my vCenter just do a &quot;Power off&quot; operation.</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="power-off-gateway-node"
      
        class="image_figure image_internal image_processed"
        width="2708"
        height="734"
        src="/2023/09/25/antrea-multi-cluster-in-tkg-and-vsphere-with-tanzu/images/image-20230930212321484.png"
      
      
    />

    </picture>
</figure>
</p>
<p>And I will even delete it..</p>
<img src=images/image-20230930213558665.png style="width:600px" />
<p>Remember I annotated my two nodes as potential Gateway candidates?</p>
<p>Well look what happened after my active gateway disappeared. It selects the next available candidate automatically. Gateway up again and all services up.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">k get gateway -A
</span></span><span class="line"><span class="ln">2</span><span class="cl">NAMESPACE     NAME                                              GATEWAY IP     INTERNAL IP    AGE
</span></span><span class="line"><span class="ln">3</span><span class="cl">kube-system   tkg-cluster-2-md-1-wmxhd-5998fcf669x64b9h-z7mnw   10.101.12.13   10.101.12.13   37s
</span></span></code></pre></div><img src=images/image-20231001090655900.png style="width:600px" />
<p>The deleted node will be taken care of by TKG and recreated.</p>
<h2 id="routing-pod-traffic-through-multi-cluster-gateways">Routing pod traffic through Multi-cluster Gateways</h2>
<p>Next neat feature of Antrea Multi-cluster is the ability to allow pods from the different member clusters to reach each other on their respective pod IP addresses. Say I have POD-A running in member-cluster blue and are depending on connecting to POD-B running in member-cluster red. To achieve this a couple of steps is needed to be configured.</p>
<ul>
<li>The agent.conf Feature Gate <strong>enablePodToPodConnectivity: true</strong> must be set to <strong>true</strong> (This is already done as explained in the initial chapter)</li>
<li>Need to configure the <strong>antrea-mc-controller</strong> configMap</li>
</ul>
<p>There are two ways to edit the <strong>antrea-mc-controller</strong> configmap, edit the yaml antrea-multicluster-member.yml that was used to install the antrea-mc-controller in the member clusters or edit the configMap antrea-mc-controller-config directly in the ns kube-system. I will edit it directly and the only thing that needs to be added is the cluster configured pod CIDR.</p>

<div class="notices info">
    <div class="label">Info</div>
    <p>If editing directly, one have to restart the pod <strong>antrea-mc-controller</strong> for it to read the new configMap.</p>
<p>The POD CIDRS between the clusters can NOT overlap</p>

  </div>

<p>Editing the configMap</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c">## member-cluster-blue (tkg-cluster-2)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="c">## Get the pod or cluster cidr of the cluster you are editing the configMap</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="l">k cluster-info dump | grep -m 1 cluster-cidr</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w"></span><span class="s2">&#34;--cluster-cidr=10.133.0.0/16&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w"></span><span class="c">## edit the configmap</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w"></span><span class="l">k edit configmaps -n kube-system antrea-mc-controller-config</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w"></span><span class="c">## the configmap</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w"></span><span class="c"># Please edit the object below. Lines beginning with a &#39;#&#39; will be ignored,</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w"></span><span class="c"># and an empty file will abort the edit. If an error occurs while saving this file will be</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w"></span><span class="c"># reopened with the relevant failures.</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w"></span><span class="c">#</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">  </span><span class="nt">controller_manager_config.yaml</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="sd">    apiVersion: multicluster.crd.antrea.io/v1alpha1
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="sd">    kind: MultiClusterConfig
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="sd">    health:
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="sd">      healthProbeBindAddress: :8080
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="sd">    metrics:
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="sd">      bindAddress: &#34;0&#34;
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="sd">    webhook:
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="sd">      port: 9443
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="sd">    leaderElection:
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="sd">      leaderElect: false
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="sd">    serviceCIDR: &#34;&#34;
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="sd">    podCIDRs:
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="sd">      - &#34;10.133.0.0/16&#34;  ## Add the cidr here from the range above
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="sd">    gatewayIPPrecedence: &#34;private&#34;
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="sd">    endpointIPType: &#34;ClusterIP&#34;
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="sd">    enableStretchedNetworkPolicy: false</span><span class="w">    
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap</span><span class="w">
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="w">    </span><span class="nt">kubectl.kubernetes.io/last-applied-configuration</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="sd">      {&#34;apiVersion&#34;:&#34;v1&#34;,&#34;data&#34;:{&#34;controller_manager_config.yaml&#34;:&#34;apiVersion: multicluster.crd.antrea.io/v1alpha1\nkind: MultiClusterConfig\nhealth:\n  healthProbeBindAddress: :8080\nmetrics:\n  bindAddress: \&#34;0\&#34;\nwebhook:\n  port: 9443\nleaderElection:\n  leaderElect: false\nserviceCIDR: \&#34;\&#34;\npodCIDRs:\n  - \&#34;\&#34;\ngatewayIPPrecedence: \&#34;private\&#34;\nendpointIPType: \&#34;ClusterIP\&#34;\nenableStretchedNetworkPolicy: false\n&#34;},&#34;kind&#34;:&#34;ConfigMap&#34;,&#34;metadata&#34;:{&#34;annotations&#34;:{},&#34;labels&#34;:{&#34;app&#34;:&#34;antrea&#34;},&#34;name&#34;:&#34;antrea-mc-controller-config&#34;,&#34;namespace&#34;:&#34;kube-system&#34;}}</span><span class="w">      
</span></span></span><span class="line"><span class="ln">36</span><span class="cl"><span class="w">  </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2023-09-29T05:57:12Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">37</span><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">38</span><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">antrea</span><span class="w">
</span></span></span><span class="line"><span class="ln">39</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">antrea-mc-controller-config</span><span class="w">
</span></span></span><span class="line"><span class="ln">40</span><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-system</span><span class="w">
</span></span></span><span class="line"><span class="ln">41</span><span class="cl"><span class="w">  </span><span class="nt">resourceVersion</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;98622&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">42</span><span class="cl"><span class="w">  </span><span class="nt">uid</span><span class="p">:</span><span class="w"> </span><span class="l">fd760052-a18e-4623-b217-d9b96ae36cac</span><span class="w">
</span></span></span><span class="line"><span class="ln">43</span><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="ln">44</span><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="ln">45</span><span class="cl"><span class="w">  </span><span class="c">## :wq</span><span class="w">
</span></span></span><span class="line"><span class="ln">46</span><span class="cl"><span class="w">  </span><span class="l">configmap/antrea-mc-controller-config edited</span><span class="w">
</span></span></span><span class="line"><span class="ln">47</span><span class="cl"><span class="w">  
</span></span></span></code></pre></div><p>Restart antrea-mc-controller pod</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">k delete pod -n kube-system antrea-mc-controller-5bb945f87f-nfd97
</span></span><span class="line"><span class="ln">2</span><span class="cl">pod <span class="s2">&#34;antrea-mc-controller-5bb945f87f-nfd97&#34;</span> deleted
</span></span></code></pre></div><p>Repeat on the other clusters</p>
<p>Now testing time</p>
<p>I have a pod running in member-cluster red (tkg-cluster-3) with the following IP:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">NAME                          READY   STATUS    RESTARTS   AGE     IP            NODE                                              NOMINATED NODE   READINESS GATES
</span></span><span class="line"><span class="ln">2</span><span class="cl">ubuntu-20-04-cbb58d77-l25zv   1/1     Running   <span class="m">0</span>          5h18m   10.135.1.58   tkg-cluster-3-md-1-824bx-5bdb559f7bxqgbb8-bqwnr   &lt;none&gt;           &lt;none&gt;
</span></span></code></pre></div><p>I also have another POD running in my member-cluster blue with this information:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">NAME                          READY   STATUS    RESTARTS   AGE     IP            NODE                                              NOMINATED NODE   READINESS GATES
</span></span><span class="line"><span class="ln">2</span><span class="cl">ubuntu-20-04-cbb58d77-tcrjb   1/1     Running   <span class="m">0</span>          5h24m   10.133.1.57   tkg-cluster-2-md-1-wmxhd-5998fcf669x64b9h-z7mnw   &lt;none&gt;           &lt;none&gt;
</span></span></code></pre></div><p>Now I will execute into the last pod and do a ping to the pod in member-cluster red using the POD IP.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">root@ubuntu-20-04-cbb58d77-tcrjb:/# ping 10.135.1.58
</span></span><span class="line"><span class="ln">2</span><span class="cl">PING 10.135.1.58 <span class="o">(</span>10.135.1.58<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
</span></span></code></pre></div><p>On the destination pod I have started tcpdump to listen on icmp, and on the screenshot below I have the ping from the source on the left side to the destination on the right. Notice the IP addresses being reported by tcpdump in the destination pod.</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="src-dst-ping"
      
        class="image_figure image_internal image_processed"
        width="2088"
        height="364"
        src="/2023/09/25/antrea-multi-cluster-in-tkg-and-vsphere-with-tanzu/images/image-20230929134237713.png"
      
      
    />

    </picture>
</figure>
</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">root@ubuntu-20-04-cbb58d77-l25zv:/# tcpdump -i eth0 icmp
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">tcpdump: verbose output suppressed, use -v or -vv <span class="k">for</span> full protocol decode
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">listening on eth0, link-type EN10MB <span class="o">(</span>Ethernet<span class="o">)</span>, capture size <span class="m">262144</span> bytes
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">11:41:44.577683 IP 10.101.12.14 &gt; ubuntu-20-04-cbb58d77-l25zv: ICMP <span class="nb">echo</span> request, id 4455, seq 1, length <span class="m">64</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">11:41:44.577897 IP ubuntu-20-04-cbb58d77-l25zv &gt; 10.101.12.14: ICMP <span class="nb">echo</span> reply, id 4455, seq 1, length <span class="m">64</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">11:41:45.577012 IP 10.101.12.14 &gt; ubuntu-20-04-cbb58d77-l25zv: ICMP <span class="nb">echo</span> request, id 4455, seq 2, length <span class="m">64</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">11:41:45.577072 IP ubuntu-20-04-cbb58d77-l25zv &gt; 10.101.12.14: ICMP <span class="nb">echo</span> reply, id 4455, seq 2, length <span class="m">64</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">11:41:46.577099 IP 10.101.12.14 &gt; ubuntu-20-04-cbb58d77-l25zv: ICMP <span class="nb">echo</span> request, id 4455, seq 3, length <span class="m">64</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">11:41:46.577144 IP ubuntu-20-04-cbb58d77-l25zv &gt; 10.101.12.14: ICMP <span class="nb">echo</span> reply, id 4455, seq 3, length <span class="m">64</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">11:41:47.579227 IP 10.101.12.14 &gt; ubuntu-20-04-cbb58d77-l25zv: ICMP <span class="nb">echo</span> request, id 4455, seq 4, length <span class="m">64</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">11:41:47.579256 IP ubuntu-20-04-cbb58d77-l25zv &gt; 10.101.12.14: ICMP <span class="nb">echo</span> reply, id 4455, seq 4, length <span class="m">64</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">11:41:48.580607 IP 10.101.12.14 &gt; ubuntu-20-04-cbb58d77-l25zv: ICMP <span class="nb">echo</span> request, id 4455, seq 5, length <span class="m">64</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">11:41:48.580632 IP ubuntu-20-04-cbb58d77-l25zv &gt; 10.101.12.14: ICMP <span class="nb">echo</span> reply, id 4455, seq 5, length <span class="m">64</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">11:41:49.581900 IP 10.101.12.14 &gt; ubuntu-20-04-cbb58d77-l25zv: ICMP <span class="nb">echo</span> request, id 4455, seq 6, length <span class="m">64</span>
</span></span></code></pre></div><p>The source IP address here is the gateway IP from the source member-cluster:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@tkg-bootstrap:~$ k get gateway -A
</span></span><span class="line"><span class="ln">2</span><span class="cl">NAMESPACE     NAME                                             GATEWAY IP     INTERNAL IP    AGE
</span></span><span class="line"><span class="ln">3</span><span class="cl">kube-system   tkg-cluster-2-md-0-vrt25-7f44f4798xqbk9h-tc979   10.101.12.14   10.101.12.14   5h37m
</span></span></code></pre></div><p>And if I do the same operation just change the direction:</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="src-right-dst-left"
      
        class="image_figure image_internal image_processed"
        width="1732"
        height="217"
        src="/2023/09/25/antrea-multi-cluster-in-tkg-and-vsphere-with-tanzu/images/image-20230929134901157.png"
      
      
    />

    </picture>
</figure>
</p>
<p>The source IP is the gateway IP from the source cluster:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">NAMESPACE     NAME                                             GATEWAY IP     INTERNAL IP    AGE
</span></span><span class="line"><span class="ln">2</span><span class="cl">kube-system   tkg-cluster-3-md-0-h5ppw-9db445579xq45bn-nsq98   10.101.12.38   10.101.12.38   5h41m
</span></span></code></pre></div><p>Using antctl traceflow:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">andreasm@tkg-bootstrap:~$ antctl traceflow -S prod/ubuntu-20-04-cbb58d77-tcrjb -D 10.135.1.58
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">name: prod-ubuntu-20-04-cbb58d77-tcrjb-to-10.135.1.58-5b8l7ms8
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">phase: Running
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">source: prod/ubuntu-20-04-cbb58d77-tcrjb
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">destination: 10.135.1.58
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">results:
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">- node: tkg-cluster-2-md-1-wmxhd-5998fcf669x64b9h-z7mnw
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">  timestamp: <span class="m">1696064979</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">  observations:
</span></span><span class="line"><span class="ln">10</span><span class="cl">  - component: SpoofGuard
</span></span><span class="line"><span class="ln">11</span><span class="cl">    action: Forwarded
</span></span><span class="line"><span class="ln">12</span><span class="cl">  - component: Forwarding
</span></span><span class="line"><span class="ln">13</span><span class="cl">    componentInfo: Output
</span></span><span class="line"><span class="ln">14</span><span class="cl">    action: Forwarded
</span></span><span class="line"><span class="ln">15</span><span class="cl">    tunnelDstIP: 10.101.12.14
</span></span><span class="line"><span class="ln">16</span><span class="cl">Error: timeout waiting <span class="k">for</span> Traceflow <span class="k">done</span>
</span></span></code></pre></div><p>I know it is forwarded and delivered as I can see it on the destination pod using tcpdump while doing the traceflow:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">root@ubuntu-20-04-cbb58d77-l25zv:/# tcpdump -i eth0 icmp
</span></span><span class="line"><span class="ln">2</span><span class="cl">tcpdump: verbose output suppressed, use -v or -vv <span class="k">for</span> full protocol decode
</span></span><span class="line"><span class="ln">3</span><span class="cl">listening on eth0, link-type EN10MB <span class="o">(</span>Ethernet<span class="o">)</span>, capture size <span class="m">262144</span> bytes
</span></span><span class="line"><span class="ln">4</span><span class="cl">09:09:39.161140 IP 10.101.12.14 &gt; ubuntu-20-04-cbb58d77-l25zv: ICMP <span class="nb">echo</span> request, id 0, seq 0, length <span class="m">8</span>
</span></span><span class="line"><span class="ln">5</span><span class="cl">09:09:39.161411 IP ubuntu-20-04-cbb58d77-l25zv &gt; 10.101.12.14: ICMP <span class="nb">echo</span> reply, id 0, seq 0, length <span class="m">8</span>
</span></span></code></pre></div><p>Next up is how Antrea Policies can be used with Antrea Multi-cluster</p>
<h2 id="multi-cluster-networkpolicy-anp-and-acnp">Multi-cluster NetworkPolicy (ANP and ACNP)</h2>
<p>This feature is about the possibility to create policies using ClusterSet objects as selector for ingress or egress, like exported Multi-cluster services or namespaces across the clusters in a ClusterSet. For this to work the <strong>enableStretchedNetworkPolicy</strong> Feature Gate must be set to true on both controller.conf and agent.conf. I already enabled this at cluster provisioning, but to check take a look at the antrea-config configMap:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="l">andreasm@tkg-bootstrap:~$ k get configmaps -n kube-system antrea-config -oyaml</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">  </span><span class="nt">antrea-agent.conf</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="sd">    featureGates:
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="sd">      Multicluster: true
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="sd">    multicluster:
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="sd">      enableGateway: true
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="sd">      enableStretchedNetworkPolicy: true
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="sd">      enablePodToPodConnectivity: true</span><span class="w">    
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">  </span><span class="l">...</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">  </span><span class="nt">antrea-controller.conf</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="sd">    featureGates: 
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="sd">      Multicluster: true
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="sd">    multicluster:
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="sd">      enableStretchedNetworkPolicy: true</span><span class="w">    
</span></span></span></code></pre></div><p>Following the GitHub <a href="https://github.com/antrea-io/antrea/blob/release-1.11/docs/multicluster/user-guide.md#multi-cluster-networkpolicy">docs</a> I will use the examples there to make some policies and demonstrate them.</p>
<p>Starting with the first example, an egress rule to a Multi-cluster service.</p>
<p><strong>Egress rule to Multi-cluster service</strong></p>
<p>Below is an example taken from the official docs creating a policy that will <strong>Drop</strong> traffic to a specific Multi-cluster service from a specific pod using label selector (adjusted to fit my environment):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">crd.antrea.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterNetworkPolicy</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">acnp-drop-ubuntu-pod-to-nginx-mc-service</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">  </span><span class="nt">priority</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">  </span><span class="nt">tier</span><span class="p">:</span><span class="w"> </span><span class="l">securityops</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">  </span><span class="nt">appliedTo</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    </span>- <span class="nt">podSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">        </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">          </span><span class="nt">role</span><span class="p">:</span><span class="w"> </span><span class="kc">no</span>-<span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">  </span><span class="nt">egress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">    </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Drop</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">      </span><span class="nt">toServices</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx  </span><span class="w"> </span><span class="c"># an exported Multi-cluster Service</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">          </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">          </span><span class="nt">scope</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterSet</span><span class="w">
</span></span></span></code></pre></div><p>I will now apply it on the member-cluster-blue, where my source test pod Ubuntu is running. I can also apply it on the source cluster where service originates from and it will have the same effect:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">k apply -f egress-nginx-mc.yaml
</span></span><span class="line"><span class="ln">2</span><span class="cl">clusternetworkpolicy.crd.antrea.io/acnp-drop-ubuntu-pod-to-nginx-mc-service created
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">k get acnp
</span></span><span class="line"><span class="ln">2</span><span class="cl">NAME                                       TIER          PRIORITY   DESIRED NODES   CURRENT NODES   AGE
</span></span><span class="line"><span class="ln">3</span><span class="cl">acnp-drop-ubuntu-pod-to-nginx-mc-service   securityops   <span class="m">1</span>          <span class="m">0</span>               <span class="m">0</span>               32s
</span></span></code></pre></div><p>Its applied, but not in effect as I dont have the correct labels applied yet on my test pod.</p>
<p>So from my Ubuntu test pod, I can still reach the service nginx. But I will now label the pod according to the yaml above.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">k label pod -n prod ubuntu-20-04-cbb58d77-tcrjb <span class="nv">role</span><span class="o">=</span>no-nginx
</span></span><span class="line"><span class="ln">2</span><span class="cl">pod/ubuntu-20-04-cbb58d77-tcrjb labeled
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">k get acnp
</span></span><span class="line"><span class="ln">2</span><span class="cl">NAME                                       TIER          PRIORITY   DESIRED NODES   CURRENT NODES   AGE
</span></span><span class="line"><span class="ln">3</span><span class="cl">acnp-drop-ubuntu-pod-to-nginx-mc-service   securityops   <span class="m">1</span>          <span class="m">1</span>               <span class="m">1</span>               39s
</span></span></code></pre></div><p>Something is in effect... Now from my test Ubuntu pod I will try to curl the nginx service.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">root@ubuntu-20-04-cbb58d77-tcrjb:/# nslookup 10.134.30.220
</span></span><span class="line"><span class="ln">2</span><span class="cl">220.30.134.10.in-addr.arpa	<span class="nv">name</span> <span class="o">=</span> antrea-mc-nginx.nginx.svc.cluster.local.
</span></span><span class="line"><span class="ln">3</span><span class="cl">root@ubuntu-20-04-cbb58d77-tcrjb:/# curl http://antrea-mc-nginx.nginx.svc.cluster.local
</span></span><span class="line"><span class="ln">4</span><span class="cl">curl: <span class="o">(</span>28<span class="o">)</span> Failed to connect to antrea-mc-nginx.nginx.svc.cluster.local port 80: Connection timed out
</span></span><span class="line"><span class="ln">5</span><span class="cl">root@ubuntu-20-04-cbb58d77-tcrjb:/#
</span></span></code></pre></div><p>Then I can do a Antrea traceflow:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">andreasm@tkg-bootstrap:~$ antctl traceflow -S prod/ubuntu-20-04-cbb58d77-tcrjb -D nginx/antrea-mc-nginx -f tcp,tcp_dst<span class="o">=</span><span class="m">80</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">name: prod-ubuntu-20-04-cbb58d77-tcrjb-to-nginx-antrea-mc-nginx-l55dnhvf
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">phase: Succeeded
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">source: prod/ubuntu-20-04-cbb58d77-tcrjb
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">destination: nginx/antrea-mc-nginx
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">results:
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">- node: tkg-cluster-2-md-1-wmxhd-5998fcf669x64b9h-z7mnw
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">  timestamp: <span class="m">1696065339</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">  observations:
</span></span><span class="line"><span class="ln">10</span><span class="cl">  - component: SpoofGuard
</span></span><span class="line"><span class="ln">11</span><span class="cl">    action: Forwarded
</span></span><span class="line"><span class="ln">12</span><span class="cl">  - component: LB
</span></span><span class="line"><span class="ln">13</span><span class="cl">    action: Forwarded
</span></span><span class="line"><span class="ln">14</span><span class="cl">    translatedDstIP: 10.136.40.246
</span></span><span class="line"><span class="ln">15</span><span class="cl">  - component: NetworkPolicy
</span></span><span class="line"><span class="ln">16</span><span class="cl">    componentInfo: EgressMetric
</span></span><span class="line"><span class="ln">17</span><span class="cl">    action: Dropped
</span></span><span class="line"><span class="ln">18</span><span class="cl">    networkPolicy: AntreaClusterNetworkPolicy:acnp-drop-ubuntu-pod-to-nginx-mc-service
</span></span></code></pre></div><p>No need to troubleshoot connectivity issues, is being dropped by the above policy. 🚷</p>
<img src=images/image-20230930112931789.png style="width:600px" />
<p>This policy will drop all outgoing (egress) from any pods with label <strong>role=no-nginx</strong> to the exported/imported service using Multi-cluster. Pod selection is done regardless of namespace as my selection is done using pod labels and I am using a Antrea ClusterNetworkPolicy.</p>
<p>Such a policy is applied on the &quot;source&quot; cluster where you want to define strict egress policies. Another way is to define ingress policies on the destination cluster (source cluster of the exported service).</p>
<p><strong>Ingress rule</strong></p>

<div class="notices info">
    <div class="label">Info</div>
    <p>Before getting started on this chapter we need to enable the **enableStretchedNetworkPolicy&quot; feature in the configMap of ALL antrea-mc-controllers in the ClusterSet (including the leader cluster).
It is shown below...</p>

  </div>

<p>I will have to edit the configMap in both member clusters and leader-cluster setting <code>enableStretchedNetworkPolicy:</code> to <em>true</em></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c"># Please edit the object below. Lines beginning with a &#39;#&#39; will be ignored,</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="c"># and an empty file will abort the edit. If an error occurs while saving this file will be</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="c"># reopened with the relevant failures.</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w"></span><span class="c">#</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">  </span><span class="nt">controller_manager_config.yaml</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="sd">    apiVersion: multicluster.crd.antrea.io/v1alpha1
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="sd">    kind: MultiClusterConfig
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="sd">    health:
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="sd">      healthProbeBindAddress: :8080
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="sd">    metrics:
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="sd">      bindAddress: &#34;0&#34;
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="sd">    webhook:
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="sd">      port: 9443
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="sd">    leaderElection:
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="sd">      leaderElect: false
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="sd">    serviceCIDR: &#34;&#34;
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="sd">    podCIDRs:
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="sd">      - &#34;10.133.0.0/16&#34;
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="sd">    gatewayIPPrecedence: &#34;private&#34;
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="sd">    endpointIPType: &#34;ClusterIP&#34;
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="sd">    enableStretchedNetworkPolicy: true #set to true</span><span class="w">    
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w">    </span><span class="nt">kubectl.kubernetes.io/last-applied-configuration</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="sd">      {&#34;apiVersion&#34;:&#34;v1&#34;,&#34;data&#34;:{&#34;controller_manager_config.yaml&#34;:&#34;apiVersion: multicluster.crd.antrea.io/v1alpha1\nkind: MultiClusterConfig\nhealth:\n  healthProbeBindAddress: :8080\nmetrics:\n  bindAddress: \&#34;0\&#34;\nwebhook:\n  port: 9443\nleaderElection:\n  leaderElect: false\nserviceCIDR: \&#34;\&#34;\npodCIDRs:\n  - \&#34;\&#34;\ngatewayIPPrecedence: \&#34;private\&#34;\nendpointIPType: \&#34;ClusterIP\&#34;\nenableStretchedNetworkPolicy: false\n&#34;},&#34;kind&#34;:&#34;ConfigMap&#34;,&#34;metadata&#34;:{&#34;annotations&#34;:{},&#34;labels&#34;:{&#34;app&#34;:&#34;antrea&#34;},&#34;name&#34;:&#34;antrea-mc-controller-config&#34;,&#34;namespace&#34;:&#34;kube-system&#34;}}</span><span class="w">      
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">  </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2023-09-29T05:57:12Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">antrea</span><span class="w">
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">antrea-mc-controller-config</span><span class="w">
</span></span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-system</span><span class="w">
</span></span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="w">  </span><span class="nt">resourceVersion</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;415934&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="w">  </span><span class="nt">uid</span><span class="p">:</span><span class="w"> </span><span class="l">fd760052-a18e-4623-b217-d9b96ae36cac</span><span class="w">
</span></span></span></code></pre></div><p>Restart the antrea-mc-controller after editing the above configMap.</p>
<p>Again I will be taking the two examples from the Antrea Gitub doc pages, adjust them to suit my environment.
The first policy example will apply to namespaces with the label <em>environment=protected</em> where ingress will be denied/dropped from the selected pods in any namespace with the label <em>environment=untrust</em> where the scope is ClusterSet. This means it should filter on any traffic coming from any of the namespaces having the label <em>environment=untrust</em> in any member cluster in the ClusterSet. So lets see how this works.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">crd.antrea.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterNetworkPolicy</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">drop-untrust-access-to-protected-namespace</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">  </span><span class="nt">appliedTo</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">  </span>- <span class="nt">namespaceSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">      </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">        </span><span class="nt">environment</span><span class="p">:</span><span class="w"> </span><span class="l">protected</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">  </span><span class="nt">priority</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">  </span><span class="nt">tier</span><span class="p">:</span><span class="w"> </span><span class="l">securityops</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">  </span><span class="nt">ingress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">  </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Drop</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">    </span><span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">    </span><span class="c"># Select all Pods in environment=untrust Namespaces in the ClusterSet</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">    </span>- <span class="nt">scope</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterSet</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">      </span><span class="nt">namespaceSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">        </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">          </span><span class="nt">environment</span><span class="p">:</span><span class="w"> </span><span class="l">untrust</span><span class="w">
</span></span></span></code></pre></div><p>This policy will be applied on the the member clusters where I do have such &quot;protected&quot; namespaces and want to ensure no incoming (ingress) from any &quot;untrust&quot; environments.</p>
<img src=images/image-20230930135702592.png style="width:600px" />
<p>Lets start with applying the policy, and check if it has been applied:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@tkg-bootstrap:~$ k apply -f drop-untrust-to-protected.yaml
</span></span><span class="line"><span class="ln">2</span><span class="cl">clusternetworkpolicy.crd.antrea.io/drop-untrust-access-to-protected-namespace created
</span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="c1">## check it</span>
</span></span><span class="line"><span class="ln">4</span><span class="cl">andreasm@tkg-bootstrap:~$ k get acnp
</span></span><span class="line"><span class="ln">5</span><span class="cl">NAME                                         TIER          PRIORITY   DESIRED NODES   CURRENT NODES   AGE
</span></span><span class="line"><span class="ln">6</span><span class="cl">drop-untrust-access-to-protected-namespace   securityops   <span class="m">1</span>          <span class="m">0</span>               <span class="m">0</span>               54s
</span></span></code></pre></div><p>Nothing enforced yet.</p>
<p>Back to my ubuntu pod again which resided in the namespace prod in member-cluster blue (tkg-cluster-2). I will label til namespace with environment=protected.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@tkg-bootstrap:~$ k label namespaces prod <span class="nv">environment</span><span class="o">=</span>protected
</span></span><span class="line"><span class="ln">2</span><span class="cl">namespace/prod labeled
</span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="c1">## checking the policy now</span>
</span></span><span class="line"><span class="ln">4</span><span class="cl">andreasm@tkg-bootstrap:~$ k get acnp
</span></span><span class="line"><span class="ln">5</span><span class="cl">NAME                                         TIER          PRIORITY   DESIRED NODES   CURRENT NODES   AGE
</span></span><span class="line"><span class="ln">6</span><span class="cl">drop-untrust-access-to-protected-namespace   securityops   <span class="m">1</span>          <span class="m">1</span>               <span class="m">1</span>               3m10s
</span></span></code></pre></div><p>In my other member cluster, red, I will create a new namespace, spin up another ubuntu pod there, label the namespace environment=untrust.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@tkg-bootstrap:~$ k get pods -n untrust-ns -owide
</span></span><span class="line"><span class="ln">2</span><span class="cl">NAME                          READY   STATUS    RESTARTS   AGE   IP             NODE                                              NOMINATED NODE   READINESS GATES
</span></span><span class="line"><span class="ln">3</span><span class="cl">ubuntu-20-04-cbb58d77-bl5w5   1/1     Running   <span class="m">0</span>          43s   10.135.1.228   tkg-cluster-3-md-1-824bx-5bdb559f7bxqgbb8-bqwnr   &lt;none&gt;           &lt;none&gt;
</span></span></code></pre></div><p>Is now running in the <em>untrust-ns</em></p>
<p>From the pod I will try to ping the &quot;protected&quot; pod in the member-cluster-blue before I label the namespace with untrust.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">root@ubuntu-20-04-cbb58d77-bl5w5:/# ping 10.133.1.57
</span></span><span class="line"><span class="ln">2</span><span class="cl">PING 10.133.1.57 <span class="o">(</span>10.133.1.57<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
</span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="m">64</span> bytes from 10.133.1.57: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">60</span> <span class="nv">time</span><span class="o">=</span>7.93 ms
</span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="m">64</span> bytes from 10.133.1.57: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">2</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">60</span> <span class="nv">time</span><span class="o">=</span>4.17 ms
</span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="m">64</span> bytes from 10.133.1.57: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">3</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">60</span> <span class="nv">time</span><span class="o">=</span>2.99 ms
</span></span></code></pre></div><p>This &quot;protected&quot; pod is also running an nginx instance, so lets see if I can curl it from my untrust pod:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">root@ubuntu-20-04-cbb58d77-bl5w5:/# curl 10.133.1.57
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">&lt;!DOCTYPE html&gt;
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">&lt;html&gt;
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">&lt;head&gt;
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">&lt;title&gt;Welcome to nginx!&lt;/title&gt;
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">&lt;style&gt;
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">    body <span class="o">{</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">        width: 35em<span class="p">;</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">        margin: <span class="m">0</span> auto<span class="p">;</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">        font-family: Tahoma, Verdana, Arial, sans-serif<span class="p">;</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">&lt;/style&gt;
</span></span><span class="line"><span class="ln">13</span><span class="cl">&lt;/head&gt;
</span></span><span class="line"><span class="ln">14</span><span class="cl">&lt;body&gt;
</span></span><span class="line"><span class="ln">15</span><span class="cl">&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;
</span></span><span class="line"><span class="ln">16</span><span class="cl">&lt;p&gt;If you see this page, the nginx web server is successfully installed and
</span></span><span class="line"><span class="ln">17</span><span class="cl">working. Further configuration is required.&lt;/p&gt;
</span></span><span class="line"><span class="ln">18</span><span class="cl">
</span></span><span class="line"><span class="ln">19</span><span class="cl">&lt;p&gt;For online documentation and support please refer to
</span></span><span class="line"><span class="ln">20</span><span class="cl">&lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&#34;http://nginx.org/&#34;</span>&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;
</span></span><span class="line"><span class="ln">21</span><span class="cl">Commercial support is available at
</span></span><span class="line"><span class="ln">22</span><span class="cl">&lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&#34;http://nginx.com/&#34;</span>&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;
</span></span><span class="line"><span class="ln">23</span><span class="cl">
</span></span><span class="line"><span class="ln">24</span><span class="cl">&lt;p&gt;&lt;em&gt;Thank you <span class="k">for</span> using nginx.&lt;/em&gt;&lt;/p&gt;
</span></span><span class="line"><span class="ln">25</span><span class="cl">&lt;/body&gt;
</span></span><span class="line"><span class="ln">26</span><span class="cl">&lt;/html&gt;
</span></span></code></pre></div><p>This works also. Now I will label the namespace accordingly.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@tkg-bootstrap:~$ k get ns untrust-ns --show-labels
</span></span><span class="line"><span class="ln">2</span><span class="cl">NAME         STATUS   AGE    LABELS
</span></span><span class="line"><span class="ln">3</span><span class="cl">untrust-ns   Active   9m3s   <span class="nv">environment</span><span class="o">=</span>untrust,kubernetes.io/metadata.name<span class="o">=</span>untrust-ns
</span></span></code></pre></div><p>Can I now both curl and ping the protected pod from the untrust pod?</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">root@ubuntu-20-04-cbb58d77-bl5w5:/# ping 10.133.1.57
</span></span><span class="line"><span class="ln">2</span><span class="cl">PING 10.133.1.57 <span class="o">(</span>10.133.1.57<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
</span></span><span class="line"><span class="ln">3</span><span class="cl">^C
</span></span><span class="line"><span class="ln">4</span><span class="cl">--- 10.133.1.57 ping statistics ---
</span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="m">96</span> packets transmitted, <span class="m">0</span> received, 100% packet loss, <span class="nb">time</span> 97275ms
</span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="c1">## curl</span>
</span></span><span class="line"><span class="ln">7</span><span class="cl">root@ubuntu-20-04-cbb58d77-bl5w5:/# curl 10.133.1.57
</span></span><span class="line"><span class="ln">8</span><span class="cl">curl: <span class="o">(</span>28<span class="o">)</span> Failed to connect to 10.133.1.57 port 80: Connection timed out
</span></span></code></pre></div><p>Thats a no...</p>
<p>How about that. Now I would like to see the resourceImport/Exports in the leader cluster:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">  1</span><span class="cl">andreasm@tkg-bootstrap:~$ k get resourceimports.multicluster.crd.antrea.io -A
</span></span><span class="line"><span class="ln">  2</span><span class="cl">NAMESPACE             NAME                              KIND            NAMESPACE             NAME                              AGE
</span></span><span class="line"><span class="ln">  3</span><span class="cl">antrea-multicluster   07114e55523175d2                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="ln">  4</span><span class="cl">antrea-multicluster   085dd73c98e1d875                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="ln">  5</span><span class="cl">antrea-multicluster   0c56bac2726cdc89                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="ln">  6</span><span class="cl">antrea-multicluster   0f8eaa8d1ed0d024                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="ln">  7</span><span class="cl">antrea-multicluster   1742a902fef9ecf2                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="ln">  8</span><span class="cl">antrea-multicluster   1a7d18d61d0c0ee1                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="ln">  9</span><span class="cl">antrea-multicluster   1f395d26ddf2e628                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="ln"> 10</span><span class="cl">antrea-multicluster   23f00caa60df7444                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="ln"> 11</span><span class="cl">antrea-multicluster   2ae09744db3c2971                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="ln"> 12</span><span class="cl">antrea-multicluster   2de39d651a0361e9                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="ln"> 13</span><span class="cl">antrea-multicluster   2ef5bcdb8443a24c                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="ln"> 14</span><span class="cl">antrea-multicluster   339dbb049e2e9a92                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="ln"> 15</span><span class="cl">antrea-multicluster   430e80a9621c621a                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="ln"> 16</span><span class="cl">antrea-multicluster   4c9c7b4329d0e128                  LabelIdentity                                                           3m55s
</span></span><span class="line"><span class="ln"> 17</span><span class="cl">antrea-multicluster   5629f9c0856c3bab                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="ln"> 18</span><span class="cl">antrea-multicluster   593cb26f6e1ae9e3                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="ln"> 19</span><span class="cl">antrea-multicluster   66b072b8efc1faa7                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="ln"> 20</span><span class="cl">antrea-multicluster   67410707ad7a9908                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="ln"> 21</span><span class="cl">antrea-multicluster   7468af4ac6f5dfa7                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="ln"> 22</span><span class="cl">antrea-multicluster   7c59020a5dcbb1b9                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="ln"> 23</span><span class="cl">antrea-multicluster   7dac813f5932e57e                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="ln"> 24</span><span class="cl">antrea-multicluster   7f43c50b4566cd91                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="ln"> 25</span><span class="cl">antrea-multicluster   8327de14325c06f9                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="ln"> 26</span><span class="cl">antrea-multicluster   9227dd1f8d5eef10                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="ln"> 27</span><span class="cl">antrea-multicluster   9a2e5dbff4effe99                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="ln"> 28</span><span class="cl">antrea-multicluster   9a4b2085e53f890c                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="ln"> 29</span><span class="cl">antrea-multicluster   9b5c3a1ff3c1724f                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="ln"> 30</span><span class="cl">antrea-multicluster   9ba8fb64d35434a6                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="ln"> 31</span><span class="cl">antrea-multicluster   a59e6e24ceaabe76                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="ln"> 32</span><span class="cl">antrea-multicluster   a642d62a95b68860                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="ln"> 33</span><span class="cl">antrea-multicluster   afe73316119e5beb                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="ln"> 34</span><span class="cl">antrea-multicluster   b07efcf6d7df9ecc                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="ln"> 35</span><span class="cl">antrea-multicluster   b0ef5ea4e6654296                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="ln"> 36</span><span class="cl">antrea-multicluster   b4ab02dcfded7a88                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="ln"> 37</span><span class="cl">antrea-multicluster   b9f26e2c922bdfce                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="ln"> 38</span><span class="cl">antrea-multicluster   be152630c03e5d6b                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="ln"> 39</span><span class="cl">antrea-multicluster   c316283f47088c45                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="ln"> 40</span><span class="cl">antrea-multicluster   c7703628c133a9ae                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="ln"> 41</span><span class="cl">antrea-multicluster   db564a4a19f62e39                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="ln"> 42</span><span class="cl">antrea-multicluster   db672f99c9b13343                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="ln"> 43</span><span class="cl">antrea-multicluster   db674d682cb5db88                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="ln"> 44</span><span class="cl">antrea-multicluster   ef097265c27216d2                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="ln"> 45</span><span class="cl">antrea-multicluster   f8e5f6fba3fb9a5c                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="ln"> 46</span><span class="cl">antrea-multicluster   fc0e44265f8dce47                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="ln"> 47</span><span class="cl">antrea-multicluster   fc156481c7b8ebf2                  LabelIdentity                                                           7m4s
</span></span><span class="line"><span class="ln"> 48</span><span class="cl">antrea-multicluster   member-cluster-blue-clusterinfo   ClusterInfo     antrea-multicluster   member-cluster-blue-clusterinfo   31h
</span></span><span class="line"><span class="ln"> 49</span><span class="cl">antrea-multicluster   member-cluster-red-clusterinfo    ClusterInfo     antrea-multicluster   member-cluster-red-clusterinfo    31h
</span></span><span class="line"><span class="ln"> 50</span><span class="cl">antrea-multicluster   nginx-nginx-endpoints             Endpoints       nginx                 nginx                             31h
</span></span><span class="line"><span class="ln"> 51</span><span class="cl">antrea-multicluster   nginx-nginx-service               ServiceImport   nginx                 nginx                             31h
</span></span><span class="line"><span class="ln"> 52</span><span class="cl">antrea-multicluster   yelb-yelb-appserver-endpoints     Endpoints       yelb                  yelb-appserver                    31h
</span></span><span class="line"><span class="ln"> 53</span><span class="cl">antrea-multicluster   yelb-yelb-appserver-service       ServiceImport   yelb                  yelb-appserver                    31h
</span></span><span class="line"><span class="ln"> 54</span><span class="cl">andreasm@tkg-bootstrap:~$ k get resourceexports.multicluster.crd.antrea.io -A
</span></span><span class="line"><span class="ln"> 55</span><span class="cl">NAMESPACE             NAME                                               CLUSTER ID            KIND            NAMESPACE     NAME                  AGE
</span></span><span class="line"><span class="ln"> 56</span><span class="cl">antrea-multicluster   member-cluster-blue-085dd73c98e1d875               member-cluster-blue   LabelIdentity                                       11m
</span></span><span class="line"><span class="ln"> 57</span><span class="cl">antrea-multicluster   member-cluster-blue-0f8eaa8d1ed0d024               member-cluster-blue   LabelIdentity                                       11m
</span></span><span class="line"><span class="ln"> 58</span><span class="cl">antrea-multicluster   member-cluster-blue-23f00caa60df7444               member-cluster-blue   LabelIdentity                                       11m
</span></span><span class="line"><span class="ln"> 59</span><span class="cl">antrea-multicluster   member-cluster-blue-2ae09744db3c2971               member-cluster-blue   LabelIdentity                                       11m
</span></span><span class="line"><span class="ln"> 60</span><span class="cl">antrea-multicluster   member-cluster-blue-2de39d651a0361e9               member-cluster-blue   LabelIdentity                                       11m
</span></span><span class="line"><span class="ln"> 61</span><span class="cl">antrea-multicluster   member-cluster-blue-2ef5bcdb8443a24c               member-cluster-blue   LabelIdentity                                       11m
</span></span><span class="line"><span class="ln"> 62</span><span class="cl">antrea-multicluster   member-cluster-blue-5629f9c0856c3bab               member-cluster-blue   LabelIdentity                                       11m
</span></span><span class="line"><span class="ln"> 63</span><span class="cl">antrea-multicluster   member-cluster-blue-593cb26f6e1ae9e3               member-cluster-blue   LabelIdentity                                       11m
</span></span><span class="line"><span class="ln"> 64</span><span class="cl">antrea-multicluster   member-cluster-blue-7c59020a5dcbb1b9               member-cluster-blue   LabelIdentity                                       11m
</span></span><span class="line"><span class="ln"> 65</span><span class="cl">antrea-multicluster   member-cluster-blue-9a4b2085e53f890c               member-cluster-blue   LabelIdentity                                       11m
</span></span><span class="line"><span class="ln"> 66</span><span class="cl">antrea-multicluster   member-cluster-blue-9b5c3a1ff3c1724f               member-cluster-blue   LabelIdentity                                       11m
</span></span><span class="line"><span class="ln"> 67</span><span class="cl">antrea-multicluster   member-cluster-blue-a642d62a95b68860               member-cluster-blue   LabelIdentity                                       11m
</span></span><span class="line"><span class="ln"> 68</span><span class="cl">antrea-multicluster   member-cluster-blue-afe73316119e5beb               member-cluster-blue   LabelIdentity                                       11m
</span></span><span class="line"><span class="ln"> 69</span><span class="cl">antrea-multicluster   member-cluster-blue-b07efcf6d7df9ecc               member-cluster-blue   LabelIdentity                                       11m
</span></span><span class="line"><span class="ln"> 70</span><span class="cl">antrea-multicluster   member-cluster-blue-b0ef5ea4e6654296               member-cluster-blue   LabelIdentity                                       11m
</span></span><span class="line"><span class="ln"> 71</span><span class="cl">antrea-multicluster   member-cluster-blue-b4ab02dcfded7a88               member-cluster-blue   LabelIdentity                                       11m
</span></span><span class="line"><span class="ln"> 72</span><span class="cl">antrea-multicluster   member-cluster-blue-b9f26e2c922bdfce               member-cluster-blue   LabelIdentity                                       11m
</span></span><span class="line"><span class="ln"> 73</span><span class="cl">antrea-multicluster   member-cluster-blue-c7703628c133a9ae               member-cluster-blue   LabelIdentity                                       11m
</span></span><span class="line"><span class="ln"> 74</span><span class="cl">antrea-multicluster   member-cluster-blue-clusterinfo                    member-cluster-blue   ClusterInfo     kube-system   member-cluster-blue   31h
</span></span><span class="line"><span class="ln"> 75</span><span class="cl">antrea-multicluster   member-cluster-blue-db672f99c9b13343               member-cluster-blue   LabelIdentity                                       11m
</span></span><span class="line"><span class="ln"> 76</span><span class="cl">antrea-multicluster   member-cluster-blue-fc156481c7b8ebf2               member-cluster-blue   LabelIdentity                                       11m
</span></span><span class="line"><span class="ln"> 77</span><span class="cl">antrea-multicluster   member-cluster-red-07114e55523175d2                member-cluster-red    LabelIdentity                                       11m
</span></span><span class="line"><span class="ln"> 78</span><span class="cl">antrea-multicluster   member-cluster-red-1742a902fef9ecf2                member-cluster-red    LabelIdentity                                       11m
</span></span><span class="line"><span class="ln"> 79</span><span class="cl">antrea-multicluster   member-cluster-red-1a7d18d61d0c0ee1                member-cluster-red    LabelIdentity                                       11m
</span></span><span class="line"><span class="ln"> 80</span><span class="cl">antrea-multicluster   member-cluster-red-1f395d26ddf2e628                member-cluster-red    LabelIdentity                                       11m
</span></span><span class="line"><span class="ln"> 81</span><span class="cl">antrea-multicluster   member-cluster-red-339dbb049e2e9a92                member-cluster-red    LabelIdentity                                       11m
</span></span><span class="line"><span class="ln"> 82</span><span class="cl">antrea-multicluster   member-cluster-red-430e80a9621c621a                member-cluster-red    LabelIdentity                                       11m
</span></span><span class="line"><span class="ln"> 83</span><span class="cl">antrea-multicluster   member-cluster-red-4c9c7b4329d0e128                member-cluster-red    LabelIdentity                                       4m23s
</span></span><span class="line"><span class="ln"> 84</span><span class="cl">antrea-multicluster   member-cluster-red-66b072b8efc1faa7                member-cluster-red    LabelIdentity                                       11m
</span></span><span class="line"><span class="ln"> 85</span><span class="cl">antrea-multicluster   member-cluster-red-67410707ad7a9908                member-cluster-red    LabelIdentity                                       11m
</span></span><span class="line"><span class="ln"> 86</span><span class="cl">antrea-multicluster   member-cluster-red-7468af4ac6f5dfa7                member-cluster-red    LabelIdentity                                       11m
</span></span><span class="line"><span class="ln"> 87</span><span class="cl">antrea-multicluster   member-cluster-red-7dac813f5932e57e                member-cluster-red    LabelIdentity                                       11m
</span></span><span class="line"><span class="ln"> 88</span><span class="cl">antrea-multicluster   member-cluster-red-7f43c50b4566cd91                member-cluster-red    LabelIdentity                                       11m
</span></span><span class="line"><span class="ln"> 89</span><span class="cl">antrea-multicluster   member-cluster-red-8327de14325c06f9                member-cluster-red    LabelIdentity                                       11m
</span></span><span class="line"><span class="ln"> 90</span><span class="cl">antrea-multicluster   member-cluster-red-9227dd1f8d5eef10                member-cluster-red    LabelIdentity                                       11m
</span></span><span class="line"><span class="ln"> 91</span><span class="cl">antrea-multicluster   member-cluster-red-9a2e5dbff4effe99                member-cluster-red    LabelIdentity                                       11m
</span></span><span class="line"><span class="ln"> 92</span><span class="cl">antrea-multicluster   member-cluster-red-9ba8fb64d35434a6                member-cluster-red    LabelIdentity                                       11m
</span></span><span class="line"><span class="ln"> 93</span><span class="cl">antrea-multicluster   member-cluster-red-a59e6e24ceaabe76                member-cluster-red    LabelIdentity                                       11m
</span></span><span class="line"><span class="ln"> 94</span><span class="cl">antrea-multicluster   member-cluster-red-be152630c03e5d6b                member-cluster-red    LabelIdentity                                       11m
</span></span><span class="line"><span class="ln"> 95</span><span class="cl">antrea-multicluster   member-cluster-red-c316283f47088c45                member-cluster-red    LabelIdentity                                       11m
</span></span><span class="line"><span class="ln"> 96</span><span class="cl">antrea-multicluster   member-cluster-red-clusterinfo                     member-cluster-red    ClusterInfo     kube-system   member-cluster-red    31h
</span></span><span class="line"><span class="ln"> 97</span><span class="cl">antrea-multicluster   member-cluster-red-db564a4a19f62e39                member-cluster-red    LabelIdentity                                       11m
</span></span><span class="line"><span class="ln"> 98</span><span class="cl">antrea-multicluster   member-cluster-red-db674d682cb5db88                member-cluster-red    LabelIdentity                                       11m
</span></span><span class="line"><span class="ln"> 99</span><span class="cl">antrea-multicluster   member-cluster-red-ef097265c27216d2                member-cluster-red    LabelIdentity                                       11m
</span></span><span class="line"><span class="ln">100</span><span class="cl">antrea-multicluster   member-cluster-red-f8e5f6fba3fb9a5c                member-cluster-red    LabelIdentity                                       11m
</span></span><span class="line"><span class="ln">101</span><span class="cl">antrea-multicluster   member-cluster-red-fc0e44265f8dce47                member-cluster-red    LabelIdentity                                       11m
</span></span><span class="line"><span class="ln">102</span><span class="cl">antrea-multicluster   member-cluster-red-nginx-nginx-endpoints           member-cluster-red    Endpoints       nginx         nginx                 31h
</span></span><span class="line"><span class="ln">103</span><span class="cl">antrea-multicluster   member-cluster-red-nginx-nginx-service             member-cluster-red    Service         nginx         nginx                 31h
</span></span><span class="line"><span class="ln">104</span><span class="cl">antrea-multicluster   member-cluster-red-yelb-yelb-appserver-endpoints   member-cluster-red    Endpoints       yelb          yelb-appserver        31h
</span></span><span class="line"><span class="ln">105</span><span class="cl">antrea-multicluster   member-cluster-red-yelb-yelb-appserver-service     member-cluster-red    Service         yelb          yelb-appserver        31h
</span></span></code></pre></div><p>And if I describe one of them:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">k describe resourceimports.multicluster.crd.antrea.io -n antrea-multicluster 07114e55523175d2
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">Name:         07114e55523175d2
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">Namespace:    antrea-multicluster
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">Labels:       &lt;none&gt;
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">Annotations:  &lt;none&gt;
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">API Version:  multicluster.crd.antrea.io/v1alpha1
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">Kind:         ResourceImport
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">Metadata:
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">  Creation Timestamp:  2023-09-30T13:33:02Z
</span></span><span class="line"><span class="ln">10</span><span class="cl">  Generation:          <span class="m">1</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">  Resource Version:    <span class="m">442986</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">  UID:                 4157d671-6c4d-4653-b97f-554bdfa705d9
</span></span><span class="line"><span class="ln">13</span><span class="cl">Spec:
</span></span><span class="line"><span class="ln">14</span><span class="cl">  Kind:  LabelIdentity
</span></span><span class="line"><span class="ln">15</span><span class="cl">  Label Identity:
</span></span><span class="line"><span class="ln">16</span><span class="cl">    Id:     <span class="m">35</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">    Label:  ns:kubernetes.io/metadata.name<span class="o">=</span>nginx<span class="p">&amp;</span>pod:app<span class="o">=</span>nginx-ui,pod-template-hash<span class="o">=</span>59c956b95b,tier<span class="o">=</span>frontend
</span></span><span class="line"><span class="ln">18</span><span class="cl">Events:     &lt;none&gt;
</span></span></code></pre></div><p>The leader cluster is now aware of all labels, namespaces and pods, from the other member clusters which will allow us to create this ingress rule with namespace or pod selection from the other clusters. The applyTo field is only relevant for the cluster the policy is applied in.</p>
<p>The second ingress policy example below is using a &quot;namespaced&quot; policy (Antrea NetworkPolicy). It will be applied to a specific namespace in the &quot;destination&quot; cluster, using podSelector with labels <em>app=db</em> to select specific pods. The policy will be placed in the Application Tier, it will allow sources coming from any pods in the ClusterSet matching the label <em>app=client</em> to the pods in the specified namesapace with label <em>app=db</em> and dropping everything else.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">crd.antrea.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">AntreaNetworkPolicy</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">db-svc-allow-ingress-from-client-only</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">prod-us-west</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">  </span><span class="nt">appliedTo</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">  </span>- <span class="nt">podSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">      </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">db</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">  </span><span class="nt">priority</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">  </span><span class="nt">tier</span><span class="p">:</span><span class="w"> </span><span class="l">application</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">  </span><span class="nt">ingress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">  </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Allow</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">    </span><span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">    </span><span class="c"># Select all Pods in Namespace &#34;prod-us-west&#34; from all clusters in the ClusterSet (if the</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">    </span><span class="c"># Namespace exists in that cluster) whose labels match app=client</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">    </span>- <span class="nt">scope</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterSet</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">      </span><span class="nt">podSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">        </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">          </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">client</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">  </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Deny</span><span class="w">
</span></span></span></code></pre></div><p>I will not test this, as it will work similarly as the first example, the only difference being is that it is applied on a namespace, not clusterwide (using Antrea ClusterNetworkPolicy).</p>
<p>Next up is creating a ClusterNetworkPolicy that is replicated across all clusters.</p>
<h2 id="multi-cluster-clusternetworkpolicy-replication-acnp">Multi-cluster ClusterNetworkPolicy replication (ACNP)</h2>
<p>In this last chapter I will test out the possibility with Multi-cluster to replicate a ClusterNetworkPolicy across each members in my ClusterSet, member-cluster-blue and red.</p>
<p>I will just take the example from the official Antrea Github docs page and use it as it is. Before I apply it I will just quickly check whether I have any policies applied in any of my member clusters:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1">## tkg-cluster-2 - member-blue</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">k config current-context
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">tkg-cluster-2-admin@tkg-cluster-2
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="c1">## Any policies?</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">k get acnp
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">No resources found
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">k get anp -A
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">No resources found
</span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="c1">## tkg-cluster-3 - member-red</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">k config current-context
</span></span><span class="line"><span class="ln">11</span><span class="cl">tkg-cluster-3-admin@tkg-cluster-3
</span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="c1">## Any policies?</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">k get acnp
</span></span><span class="line"><span class="ln">14</span><span class="cl">No resources found
</span></span><span class="line"><span class="ln">15</span><span class="cl">k get anp -A
</span></span><span class="line"><span class="ln">16</span><span class="cl">No resources found
</span></span></code></pre></div><p>No policies.</p>
<p>To replicate a policy to all members I will switch context to the leader-cluster and create a <strong>ResourceExport</strong> and the ClusterNetworkPolicy itself and apply it on the leader-cluster.</p>

<div class="notices info">
    <div class="label">Info</div>
    <p>The namespace for the Kind: ResourceExport needs to be in the same namespace as where the antrea-mc-controller is running!!</p>

  </div>

<p>Below is the example I will be using, taken from the Antrea Github doc page:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">multicluster.crd.antrea.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ResourceExport</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">strict-namespace-isolation-for-test-clusterset</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">antrea-multicluster</span><span class="w"> </span><span class="c"># Namespace that Multi-cluster Controller is deployed</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">  </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">AntreaClusterNetworkPolicy</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">strict-namespace-isolation</span><span class="w"> </span><span class="c"># In each importing cluster, an ACNP of name antrea-mc-strict-namespace-isolation will be created with the spec below</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">  </span><span class="nt">clusterNetworkPolicy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="nt">priority</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">    </span><span class="nt">tier</span><span class="p">:</span><span class="w"> </span><span class="l">securityops</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">    </span><span class="nt">appliedTo</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">      </span>- <span class="nt">namespaceSelector</span><span class="p">:</span><span class="w"> </span>{}<span class="w"> </span><span class="c"># Selects all Namespaces in the member cluster</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">    </span><span class="nt">ingress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">      </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Pass</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">        </span><span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">          </span>- <span class="nt">namespaces</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">              </span><span class="nt">match</span><span class="p">:</span><span class="w"> </span><span class="l">Self</span><span class="w"> </span><span class="c"># Skip drop rule for traffic from Pods in the same Namespace</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">          </span>- <span class="nt">podSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">              </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">                </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l">kube-dns</span><span class="w"> </span><span class="c"># Skip drop rule for traffic from the core-dns components</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">      </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Drop</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">        </span><span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">          </span>- <span class="nt">namespaceSelector</span><span class="p">:</span><span class="w"> </span>{}<span class="w"> </span><span class="c"># Drop from Pods from all other Namespaces</span><span class="w">
</span></span></span></code></pre></div><p>Now apply it in my leader-cluster:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1">## tkg-cluster-1 - leader-cluster</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">k config current-context
</span></span><span class="line"><span class="ln">3</span><span class="cl">tkg-cluster-1-admin@tkg-cluster-1
</span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="c1">## apply</span>
</span></span><span class="line"><span class="ln">5</span><span class="cl">k apply -f acnp-replicated.yaml
</span></span><span class="line"><span class="ln">6</span><span class="cl">resourceexport.multicluster.crd.antrea.io/strict-namespace-isolation-for-test-clusterset created
</span></span></code></pre></div><p>Now I will switch over to the contexts of my member clusters and check what has happened there:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1">## tkg-cluster-2 - member-blue</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">k get acnp
</span></span><span class="line"><span class="ln">3</span><span class="cl">NAME                                   TIER          PRIORITY   DESIRED NODES   CURRENT NODES   AGE
</span></span><span class="line"><span class="ln">4</span><span class="cl">antrea-mc-strict-namespace-isolation   securityops   <span class="m">1</span>          <span class="m">3</span>               <span class="m">3</span>               47s
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1">## tkg-cluster-3 - member-red</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">k get acnp
</span></span><span class="line"><span class="ln">3</span><span class="cl">NAME                                   TIER          PRIORITY   DESIRED NODES   CURRENT NODES   AGE
</span></span><span class="line"><span class="ln">4</span><span class="cl">antrea-mc-strict-namespace-isolation   securityops   <span class="m">1</span>          <span class="m">3</span>               <span class="m">3</span>               108s
</span></span></code></pre></div><p>This is really great!! Both my member cluster has gotten the policy applied.</p>
<p>On the leader-cluster?</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1">## tkg-cluster-1</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">k get acnp
</span></span><span class="line"><span class="ln">3</span><span class="cl">No resources found
</span></span></code></pre></div><p>Nothing.</p>
<p>The only bad thing now is that this policy broke my Yelb application as my Yelb-ui can no longer reach the backends in the other cluster 😄 so will have to add some additional policies to support this application also. Which is perfectly normal, and I have covered a bunch of Antrea policies in this <a href="https://blog.andreasm.io/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/">post</a> and this <a href="https://blog.andreasm.io/2023/06/01/managing-antrea-in-vsphere-with-tanzu/">post</a> that can be re-used for this purpose.</p>
<p>Now I will just do a last thing an check the status of my replicated policy from the leader-cluster if there are any alert on any of the member cluster, why they have not applied the policy etc..</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">k get resourceexports.multicluster.crd.antrea.io -A
</span></span><span class="line"><span class="ln">2</span><span class="cl">NAMESPACE             NAME                                               CLUSTER ID            KIND                         NAMESPACE     NAME                         AGE
</span></span><span class="line"><span class="ln">3</span><span class="cl">
</span></span><span class="line"><span class="ln">4</span><span class="cl">antrea-multicluster   strict-namespace-isolation-for-test-clusterset                           AntreaClusterNetworkPolicy                 strict-namespace-isolation   8m39s
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">k describe resourceexports.multicluster.crd.antrea.io -n antrea-multicluster strict-namespace-isolation-for-test-clusterset
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">Name:         strict-namespace-isolation-for-test-clusterset
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">Namespace:    antrea-multicluster
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">Labels:       <span class="nv">sourceKind</span><span class="o">=</span>AntreaClusterNetworkPolicy
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">              <span class="nv">sourceName</span><span class="o">=</span>strict-namespace-isolation
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">              <span class="nv">sourceNamespace</span><span class="o">=</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">Annotations:  &lt;none&gt;
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">API Version:  multicluster.crd.antrea.io/v1alpha1
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">Kind:         ResourceExport
</span></span><span class="line"><span class="ln">10</span><span class="cl">Metadata:
</span></span><span class="line"><span class="ln">11</span><span class="cl">  Creation Timestamp:  2023-09-30T14:02:42Z
</span></span><span class="line"><span class="ln">12</span><span class="cl">  Finalizers:
</span></span><span class="line"><span class="ln">13</span><span class="cl">    resourceexport.finalizers.antrea.io
</span></span><span class="line"><span class="ln">14</span><span class="cl">  Generation:        <span class="m">1</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">  Resource Version:  <span class="m">448359</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">  UID:               3d7111dd-eecc-46bb-8307-c95d747474b0
</span></span><span class="line"><span class="ln">17</span><span class="cl">Spec:
</span></span><span class="line"><span class="ln">18</span><span class="cl">  Cluster Network Policy:
</span></span><span class="line"><span class="ln">19</span><span class="cl">    Applied To:
</span></span><span class="line"><span class="ln">20</span><span class="cl">      Namespace Selector:
</span></span><span class="line"><span class="ln">21</span><span class="cl">    Ingress:
</span></span><span class="line"><span class="ln">22</span><span class="cl">      Action:          Pass
</span></span><span class="line"><span class="ln">23</span><span class="cl">      Enable Logging:  <span class="nb">false</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl">      From:
</span></span><span class="line"><span class="ln">25</span><span class="cl">        Namespaces:
</span></span><span class="line"><span class="ln">26</span><span class="cl">          Match:  Self
</span></span><span class="line"><span class="ln">27</span><span class="cl">        Pod Selector:
</span></span><span class="line"><span class="ln">28</span><span class="cl">          Match Labels:
</span></span><span class="line"><span class="ln">29</span><span class="cl">            k8s-app:   kube-dns
</span></span><span class="line"><span class="ln">30</span><span class="cl">      Action:          Drop
</span></span><span class="line"><span class="ln">31</span><span class="cl">      Enable Logging:  <span class="nb">false</span>
</span></span><span class="line"><span class="ln">32</span><span class="cl">      From:
</span></span><span class="line"><span class="ln">33</span><span class="cl">        Namespace Selector:
</span></span><span class="line"><span class="ln">34</span><span class="cl">    Priority:  <span class="m">1</span>
</span></span><span class="line"><span class="ln">35</span><span class="cl">    Tier:      securityops
</span></span><span class="line"><span class="ln">36</span><span class="cl">  Kind:        AntreaClusterNetworkPolicy
</span></span><span class="line"><span class="ln">37</span><span class="cl">  Name:        strict-namespace-isolation
</span></span><span class="line"><span class="ln">38</span><span class="cl">Status:
</span></span><span class="line"><span class="ln">39</span><span class="cl">  Conditions:
</span></span><span class="line"><span class="ln">40</span><span class="cl">    Last Transition Time:  2023-09-30T14:02:42Z
</span></span><span class="line"><span class="ln">41</span><span class="cl">    Status:                True
</span></span><span class="line"><span class="ln">42</span><span class="cl">    Type:                  Succeeded
</span></span><span class="line"><span class="ln">43</span><span class="cl">Events:                    &lt;none&gt;
</span></span></code></pre></div><p>Looks good.</p>
<h2 id="bonus-content">Bonus content</h2>
<p>With the help from my friend ChatGPT I created a menu driven &quot;automated&quot; way of deploying all of the above steps.</p>
<p>The pre-requisities for this script is that it expects all your Kubernetes clusters already deployed and the Antrea Multi-cluster feature gates enabled. Then the script should be executed from a machine that has all the kubernetes clusters contexts added. It will prompt for the different contexts in some of the menus and will change to these context to execute specific commands in selected contexts.</p>
<p>I will just quickly go through the script/menus. When script is executed it will bring up this menu:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">Main Menu:
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">1. Select Antrea version
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">2. Install Antrea Multi-cluster on leader cluster
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">3. Install Antrea Multi-cluster on member cluster
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">4. Create member-cluster secrets
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">5. Apply member tokens
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">6. Create ClusterSet on the leader cluster
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">7. Create ClusterClaim on member cluster
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">8. Create Multi-cluster Gateway
</span></span><span class="line"><span class="ln">10</span><span class="cl">9. Create a Multi-cluster service
</span></span><span class="line"><span class="ln">11</span><span class="cl">10. Exit
</span></span><span class="line"><span class="ln">12</span><span class="cl">Enter your choice:
</span></span></code></pre></div><p>Explanation of the different menu selections and what it does:</p>
<ol>
<li>
<p>This will prompt you for the specific Antrea version you are using and use that as a tag for downloading and applying the correct yaml files</p>
</li>
<li>
<p>This will let you select your &quot;Leader Cluster&quot;, create the namespace antrea-multicluster, deploy the leader yaml manifests and deploy the antrea-mc-controller in the cluster.</p>
</li>
<li>
<p>This will let you select a member cluster to install the member yaml and the antrea-mc-controller. This needs to be done for each of the member cluster you want to install it on.</p>
</li>
<li>
<p>This will create the member-cluster secrets, asking for the leader-cluster contexts for them to be created in. And the export the token.yamls to be applied in next step</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">Enter your choice: <span class="m">4</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">Creating member-cluster secrets...
</span></span><span class="line"><span class="ln">3</span><span class="cl">1<span class="o">)</span> 10.13.90.1
</span></span><span class="line"><span class="ln">4</span><span class="cl">2<span class="o">)</span> cluster-1
</span></span><span class="line"><span class="ln">5</span><span class="cl">3<span class="o">)</span> ns-stc-1
</span></span><span class="line"><span class="ln">6</span><span class="cl">4<span class="o">)</span> Back to Main Menu
</span></span><span class="line"><span class="ln">7</span><span class="cl">Select a context as the leader cluster: <span class="m">2</span>
</span></span><span class="line"><span class="ln">8</span><span class="cl">Switched to context <span class="s2">&#34;cluster-1&#34;</span>.
</span></span><span class="line"><span class="ln">9</span><span class="cl">Enter the name <span class="k">for</span> Member Cluster <span class="o">(</span>e.g., member-blue<span class="o">)</span>: member-red
</span></span></code></pre></div></li>
<li>
<p>This will ask you for the context for the respective token.yamls created to be applied in. It will list all the yaml files created in the current folder for you to choose which token to be applied.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">Enter your choice: <span class="m">5</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">Applying member tokens...
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">1<span class="o">)</span> 10.13.90.1
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">2<span class="o">)</span> cluster-1
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">3<span class="o">)</span> ns-stc-1
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">4<span class="o">)</span> Back to Main Menu
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">Select a context to switch to: <span class="m">2</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">Switched to context <span class="s2">&#34;cluster-1&#34;</span>.
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">1<span class="o">)</span> member-blue-token.yaml
</span></span><span class="line"><span class="ln">10</span><span class="cl">2<span class="o">)</span> Back to Main Menu
</span></span><span class="line"><span class="ln">11</span><span class="cl">Select a YAML file to apply:
</span></span></code></pre></div></li>
<li>
<p>This will create the clusterset prompting for the leader cluster context and ask for the ClusterID and ClusterSet name</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">Enter your choice: <span class="m">6</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">Creating ClusterSet on the leader cluster...
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">1<span class="o">)</span> 10.13.90.1
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">2<span class="o">)</span> cluster-1
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">3<span class="o">)</span> ns-stc-1
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">4<span class="o">)</span> Back to Main Menu
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">Select the leader cluster context: <span class="m">2</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">Switched to context <span class="s2">&#34;cluster-1&#34;</span>.
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">Enter ClusterID <span class="o">(</span>e.g., tkg-cluster-leader<span class="o">)</span>: leader-cluster
</span></span><span class="line"><span class="ln">10</span><span class="cl">Enter ClusterSet name <span class="o">(</span>e.g., andreasm-clusterset<span class="o">)</span>: super-clusterset
</span></span></code></pre></div></li>
<li>
<p>This will create the clusterclaim on the member cluster to join the cluster leader/clusterset</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">Enter your choice: <span class="m">7</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">Creating ClusterClaim on member cluster...
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">1<span class="o">)</span> 10.13.90.1
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">2<span class="o">)</span> cluster-1
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">3<span class="o">)</span> ns-stc-1
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">4<span class="o">)</span> Back to Main Menu
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">Select a context to switch to: <span class="m">2</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">Switched to context <span class="s2">&#34;cluster-1&#34;</span>.
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">Enter member-cluster-name <span class="o">(</span>e.g., member-cluster-red<span class="o">)</span>: member-cluster-blue
</span></span><span class="line"><span class="ln">10</span><span class="cl">Enter ClusterSet name <span class="o">(</span>e.g., andreasm-clusterset<span class="o">)</span>: super-clusterset
</span></span><span class="line"><span class="ln">11</span><span class="cl">Enter Leader ClusterID <span class="o">(</span>e.g., tkg-cluster-leader<span class="o">)</span>: leader-cluster
</span></span><span class="line"><span class="ln">12</span><span class="cl">Enter Member Token to use: member-blue-token
</span></span><span class="line"><span class="ln">13</span><span class="cl">Enter Leader cluster API endpoint <span class="o">(</span>e.g., https://10.101.114.100:6443<span class="o">)</span>: https://10.101.115.120:6443
</span></span></code></pre></div></li>
<li>
<p>This will create the Multi-cluster Gateway by letting you select the which node in which cluster to annotate</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">Enter your choice: <span class="m">8</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">Creating Multi-cluster Gateway...
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">1<span class="o">)</span> 10.13.90.1
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">2<span class="o">)</span> cluster-1
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">3<span class="o">)</span> ns-stc-1
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">4<span class="o">)</span> Back to Main Menu
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">Select a context to switch to: <span class="m">2</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">Switched to context <span class="s2">&#34;cluster-1&#34;</span>.
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">1<span class="o">)</span> cluster-1-f82lv-fdvw8			  3<span class="o">)</span> cluster-1-node-pool-01-tb4tw-555756bd56-klgcs
</span></span><span class="line"><span class="ln">10</span><span class="cl">2<span class="o">)</span> cluster-1-node-pool-01-tb4tw-555756bd56-76qv6  4<span class="o">)</span> Back to Context Menu
</span></span><span class="line"><span class="ln">11</span><span class="cl">Select a node to annotate as Multi-cluster Gateway: <span class="m">2</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">node/cluster-1-node-pool-01-tb4tw-555756bd56-76qv6 annotated
</span></span><span class="line"><span class="ln">13</span><span class="cl">Annotated cluster-1-node-pool-01-tb4tw-555756bd56-76qv6 as Multi-cluster Gateway.
</span></span><span class="line"><span class="ln">14</span><span class="cl">Select a node to annotate as Multi-cluster Gateway: <span class="m">4</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">Do you want to annotate another node? <span class="o">(</span>yes/no<span class="o">)</span>: <span class="c1"># Selecting yes brings up the node list again. Selecting no takes you back to main menu. This needs to be done on all member clusters you need to define a gateway node</span>
</span></span></code></pre></div></li>
<li>
<p>This will let you select a context, list all services defined in this cluster, let you select it from a menu then export is as a Multi-cluster service.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">Enter your choice: <span class="m">9</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">Creating a Multi-cluster service...
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">1<span class="o">)</span> 10.13.90.1
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">2<span class="o">)</span> cluster-1
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">3<span class="o">)</span> ns-stc-1
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">4<span class="o">)</span> Back to Main Menu
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">Select a context to switch to: <span class="m">2</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">Switched to context <span class="s2">&#34;cluster-1&#34;</span>.
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">1<span class="o">)</span> antrea-multicluster		   5<span class="o">)</span> kube-public		     9<span class="o">)</span> vmware-system-antrea	      13<span class="o">)</span> vmware-system-tkg
</span></span><span class="line"><span class="ln">10</span><span class="cl">2<span class="o">)</span> default			   6<span class="o">)</span> kube-system		    10<span class="o">)</span> vmware-system-auth	      14<span class="o">)</span> yelb
</span></span><span class="line"><span class="ln">11</span><span class="cl">3<span class="o">)</span> fruit			   7<span class="o">)</span> secretgen-controller	    11<span class="o">)</span> vmware-system-cloud-provider  15<span class="o">)</span> Back to Context Menu
</span></span><span class="line"><span class="ln">12</span><span class="cl">4<span class="o">)</span> kube-node-lease		   8<span class="o">)</span> tkg-system		    12<span class="o">)</span> vmware-system-csi
</span></span><span class="line"><span class="ln">13</span><span class="cl">Select a namespace to list services from: <span class="m">14</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">1<span class="o">)</span> redis-server
</span></span><span class="line"><span class="ln">15</span><span class="cl">2<span class="o">)</span> yelb-appserver
</span></span><span class="line"><span class="ln">16</span><span class="cl">3<span class="o">)</span> yelb-db
</span></span><span class="line"><span class="ln">17</span><span class="cl">4<span class="o">)</span> yelb-ui
</span></span><span class="line"><span class="ln">18</span><span class="cl">5<span class="o">)</span> Back to Namespace Menu
</span></span><span class="line"><span class="ln">19</span><span class="cl">Select a service to <span class="nb">export</span> as Multi-cluster service: <span class="m">2</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">ServiceExport created <span class="k">for</span> yelb-appserver in namespace yelb.
</span></span><span class="line"><span class="ln">21</span><span class="cl">serviceexport.multicluster.x-k8s.io/yelb-appserver unchanged
</span></span><span class="line"><span class="ln">22</span><span class="cl">Multi-cluster service applied.
</span></span><span class="line"><span class="ln">23</span><span class="cl">Select a service to <span class="nb">export</span> as Multi-cluster service: <span class="c1"># hit enter to bring up menu</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl">1<span class="o">)</span> antrea-multicluster		   5<span class="o">)</span> kube-public		     9<span class="o">)</span> vmware-system-antrea	      13<span class="o">)</span> vmware-system-tkg
</span></span><span class="line"><span class="ln">25</span><span class="cl">2<span class="o">)</span> default			   6<span class="o">)</span> kube-system		    10<span class="o">)</span> vmware-system-auth	      14<span class="o">)</span> yelb
</span></span><span class="line"><span class="ln">26</span><span class="cl">3<span class="o">)</span> fruit			   7<span class="o">)</span> secretgen-controller	    11<span class="o">)</span> vmware-system-cloud-provider  15<span class="o">)</span> Back to Context Menu
</span></span><span class="line"><span class="ln">27</span><span class="cl">4<span class="o">)</span> kube-node-lease		   8<span class="o">)</span> tkg-system		    12<span class="o">)</span> vmware-system-csi
</span></span><span class="line"><span class="ln">28</span><span class="cl">Select a service to <span class="nb">export</span> as Multi-cluster service: <span class="m">15</span>
</span></span></code></pre></div></li>
</ol>
<p>Here is the script:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">  1</span><span class="cl"><span class="cp">#!/bin/bash
</span></span></span><span class="line"><span class="ln">  2</span><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="ln">  3</span><span class="cl"><span class="c1"># Function to create member-cluster secrets</span>
</span></span><span class="line"><span class="ln">  4</span><span class="cl">create_member_cluster_secrets<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="ln">  5</span><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;Creating member-cluster secrets...&#34;</span>
</span></span><span class="line"><span class="ln">  6</span><span class="cl">
</span></span><span class="line"><span class="ln">  7</span><span class="cl">    <span class="c1"># List available contexts and create a menu</span>
</span></span><span class="line"><span class="ln">  8</span><span class="cl">    <span class="nv">contexts</span><span class="o">=(</span><span class="k">$(</span>kubectl config get-contexts -o<span class="o">=</span>name<span class="k">)</span><span class="o">)</span>
</span></span><span class="line"><span class="ln">  9</span><span class="cl">
</span></span><span class="line"><span class="ln"> 10</span><span class="cl">    <span class="c1"># Display the menu for selecting a context as the leader cluster</span>
</span></span><span class="line"><span class="ln"> 11</span><span class="cl">    <span class="nv">PS3</span><span class="o">=</span><span class="s2">&#34;Select a context as the leader cluster: &#34;</span>
</span></span><span class="line"><span class="ln"> 12</span><span class="cl">    <span class="k">select</span> LEADER_CONTEXT in <span class="s2">&#34;</span><span class="si">${</span><span class="nv">contexts</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&#34;</span> <span class="s2">&#34;Back to Main Menu&#34;</span><span class="p">;</span> <span class="k">do</span>
</span></span><span class="line"><span class="ln"> 13</span><span class="cl">        <span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&#34;</span><span class="nv">$LEADER_CONTEXT</span><span class="s2">&#34;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="ln"> 14</span><span class="cl">            <span class="k">if</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$LEADER_CONTEXT</span><span class="s2">&#34;</span> <span class="o">==</span> <span class="s2">&#34;Back to Main Menu&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="ln"> 15</span><span class="cl">                <span class="nb">break</span>
</span></span><span class="line"><span class="ln"> 16</span><span class="cl">            <span class="k">fi</span>
</span></span><span class="line"><span class="ln"> 17</span><span class="cl">
</span></span><span class="line"><span class="ln"> 18</span><span class="cl">            <span class="c1"># Set the selected context as the leader cluster context</span>
</span></span><span class="line"><span class="ln"> 19</span><span class="cl">            kubectl config use-context <span class="s2">&#34;</span><span class="nv">$LEADER_CONTEXT</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="ln"> 20</span><span class="cl">
</span></span><span class="line"><span class="ln"> 21</span><span class="cl">            <span class="nb">read</span> -p <span class="s2">&#34;Enter the name for Member Cluster (e.g., member-blue): &#34;</span> MEMBER_CLUSTER_NAME
</span></span><span class="line"><span class="ln"> 22</span><span class="cl">
</span></span><span class="line"><span class="ln"> 23</span><span class="cl">            <span class="c1"># Create YAML content for the member cluster</span>
</span></span><span class="line"><span class="ln"> 24</span><span class="cl">            cat <span class="s">&lt;&lt;EOF &gt; member-cluster.yml
</span></span></span><span class="line"><span class="ln"> 25</span><span class="cl"><span class="s">apiVersion: v1
</span></span></span><span class="line"><span class="ln"> 26</span><span class="cl"><span class="s">kind: ServiceAccount
</span></span></span><span class="line"><span class="ln"> 27</span><span class="cl"><span class="s">metadata:
</span></span></span><span class="line"><span class="ln"> 28</span><span class="cl"><span class="s">  name: $MEMBER_CLUSTER_NAME
</span></span></span><span class="line"><span class="ln"> 29</span><span class="cl"><span class="s">  namespace: antrea-multicluster
</span></span></span><span class="line"><span class="ln"> 30</span><span class="cl"><span class="s">---
</span></span></span><span class="line"><span class="ln"> 31</span><span class="cl"><span class="s">apiVersion: v1
</span></span></span><span class="line"><span class="ln"> 32</span><span class="cl"><span class="s">kind: Secret
</span></span></span><span class="line"><span class="ln"> 33</span><span class="cl"><span class="s">metadata:
</span></span></span><span class="line"><span class="ln"> 34</span><span class="cl"><span class="s">  name: ${MEMBER_CLUSTER_NAME}-token
</span></span></span><span class="line"><span class="ln"> 35</span><span class="cl"><span class="s">  namespace: antrea-multicluster
</span></span></span><span class="line"><span class="ln"> 36</span><span class="cl"><span class="s">  annotations:
</span></span></span><span class="line"><span class="ln"> 37</span><span class="cl"><span class="s">    kubernetes.io/service-account.name: $MEMBER_CLUSTER_NAME
</span></span></span><span class="line"><span class="ln"> 38</span><span class="cl"><span class="s">type: kubernetes.io/service-account-token
</span></span></span><span class="line"><span class="ln"> 39</span><span class="cl"><span class="s">---
</span></span></span><span class="line"><span class="ln"> 40</span><span class="cl"><span class="s">apiVersion: rbac.authorization.k8s.io/v1
</span></span></span><span class="line"><span class="ln"> 41</span><span class="cl"><span class="s">kind: RoleBinding
</span></span></span><span class="line"><span class="ln"> 42</span><span class="cl"><span class="s">metadata:
</span></span></span><span class="line"><span class="ln"> 43</span><span class="cl"><span class="s">  name: $MEMBER_CLUSTER_NAME
</span></span></span><span class="line"><span class="ln"> 44</span><span class="cl"><span class="s">  namespace: antrea-multicluster
</span></span></span><span class="line"><span class="ln"> 45</span><span class="cl"><span class="s">roleRef:
</span></span></span><span class="line"><span class="ln"> 46</span><span class="cl"><span class="s">  apiGroup: rbac.authorization.k8s.io
</span></span></span><span class="line"><span class="ln"> 47</span><span class="cl"><span class="s">  kind: Role
</span></span></span><span class="line"><span class="ln"> 48</span><span class="cl"><span class="s">  name: antrea-mc-member-cluster-role
</span></span></span><span class="line"><span class="ln"> 49</span><span class="cl"><span class="s">subjects:
</span></span></span><span class="line"><span class="ln"> 50</span><span class="cl"><span class="s">  - kind: ServiceAccount
</span></span></span><span class="line"><span class="ln"> 51</span><span class="cl"><span class="s">    name: $MEMBER_CLUSTER_NAME
</span></span></span><span class="line"><span class="ln"> 52</span><span class="cl"><span class="s">    namespace: antrea-multicluster
</span></span></span><span class="line"><span class="ln"> 53</span><span class="cl"><span class="s">EOF</span>
</span></span><span class="line"><span class="ln"> 54</span><span class="cl">
</span></span><span class="line"><span class="ln"> 55</span><span class="cl">            <span class="c1"># Apply the YAML content for the member cluster</span>
</span></span><span class="line"><span class="ln"> 56</span><span class="cl">            kubectl apply -f member-cluster.yml
</span></span><span class="line"><span class="ln"> 57</span><span class="cl">
</span></span><span class="line"><span class="ln"> 58</span><span class="cl">            <span class="c1"># Create the member cluster secret file</span>
</span></span><span class="line"><span class="ln"> 59</span><span class="cl">            kubectl get secret <span class="si">${</span><span class="nv">MEMBER_CLUSTER_NAME</span><span class="si">}</span>-token -n antrea-multicluster -o yaml <span class="p">|</span> grep -w -e <span class="s1">&#39;^apiVersion&#39;</span> -e <span class="s1">&#39;^data&#39;</span> -e <span class="s1">&#39;^metadata&#39;</span> -e <span class="s1">&#39;^ *name:&#39;</span>  -e   <span class="s1">&#39;^kind&#39;</span> -e <span class="s1">&#39;  ca.crt&#39;</span> -e <span class="s1">&#39;  token:&#39;</span> -e <span class="s1">&#39;^type&#39;</span> -e <span class="s1">&#39;  namespace&#39;</span> <span class="p">|</span> sed -e <span class="s1">&#39;s/kubernetes.io\/service-account-token/Opaque/g&#39;</span> -e <span class="s2">&#34;s/antrea-multicluster/kube-system/g&#34;</span> &gt; <span class="s2">&#34;</span><span class="si">${</span><span class="nv">MEMBER_CLUSTER_NAME</span><span class="si">}</span><span class="s2">-token.yaml&#34;</span>
</span></span><span class="line"><span class="ln"> 60</span><span class="cl">
</span></span><span class="line"><span class="ln"> 61</span><span class="cl">            <span class="nb">echo</span> <span class="s2">&#34;Member cluster secrets created and YAML file generated: </span><span class="si">${</span><span class="nv">MEMBER_CLUSTER_NAME</span><span class="si">}</span><span class="s2">-token.yaml.&#34;</span>
</span></span><span class="line"><span class="ln"> 62</span><span class="cl">            sleep <span class="m">2</span>
</span></span><span class="line"><span class="ln"> 63</span><span class="cl">            <span class="nb">break</span>
</span></span><span class="line"><span class="ln"> 64</span><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="ln"> 65</span><span class="cl">            <span class="nb">echo</span> <span class="s2">&#34;Invalid selection. Please choose a context or &#39;Back to Main Menu&#39;.&#34;</span>
</span></span><span class="line"><span class="ln"> 66</span><span class="cl">        <span class="k">fi</span>
</span></span><span class="line"><span class="ln"> 67</span><span class="cl">    <span class="k">done</span>
</span></span><span class="line"><span class="ln"> 68</span><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="ln"> 69</span><span class="cl">
</span></span><span class="line"><span class="ln"> 70</span><span class="cl"><span class="c1"># Function to apply member tokens</span>
</span></span><span class="line"><span class="ln"> 71</span><span class="cl">apply_member_tokens<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="ln"> 72</span><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;Applying member tokens...&#34;</span>
</span></span><span class="line"><span class="ln"> 73</span><span class="cl">
</span></span><span class="line"><span class="ln"> 74</span><span class="cl">    <span class="c1"># List available contexts and create a menu</span>
</span></span><span class="line"><span class="ln"> 75</span><span class="cl">    <span class="nv">contexts</span><span class="o">=(</span><span class="k">$(</span>kubectl config get-contexts -o<span class="o">=</span>name<span class="k">)</span><span class="o">)</span>
</span></span><span class="line"><span class="ln"> 76</span><span class="cl">
</span></span><span class="line"><span class="ln"> 77</span><span class="cl">    <span class="c1"># Display the menu for selecting a context to switch to</span>
</span></span><span class="line"><span class="ln"> 78</span><span class="cl">    <span class="nv">PS3</span><span class="o">=</span><span class="s2">&#34;Select a context to switch to: &#34;</span>
</span></span><span class="line"><span class="ln"> 79</span><span class="cl">    <span class="k">select</span> SWITCH_CONTEXT in <span class="s2">&#34;</span><span class="si">${</span><span class="nv">contexts</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&#34;</span> <span class="s2">&#34;Back to Main Menu&#34;</span><span class="p">;</span> <span class="k">do</span>
</span></span><span class="line"><span class="ln"> 80</span><span class="cl">        <span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&#34;</span><span class="nv">$SWITCH_CONTEXT</span><span class="s2">&#34;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="ln"> 81</span><span class="cl">            <span class="k">if</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$SWITCH_CONTEXT</span><span class="s2">&#34;</span> <span class="o">==</span> <span class="s2">&#34;Back to Main Menu&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="ln"> 82</span><span class="cl">                <span class="nb">break</span>
</span></span><span class="line"><span class="ln"> 83</span><span class="cl">            <span class="k">fi</span>
</span></span><span class="line"><span class="ln"> 84</span><span class="cl">
</span></span><span class="line"><span class="ln"> 85</span><span class="cl">            kubectl config use-context <span class="s2">&#34;</span><span class="nv">$SWITCH_CONTEXT</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="ln"> 86</span><span class="cl">
</span></span><span class="line"><span class="ln"> 87</span><span class="cl">            <span class="c1"># List YAML files in the current folder and create a menu</span>
</span></span><span class="line"><span class="ln"> 88</span><span class="cl">            <span class="nv">yaml_files</span><span class="o">=(</span><span class="k">$(</span>ls *.yaml<span class="k">)</span><span class="o">)</span>
</span></span><span class="line"><span class="ln"> 89</span><span class="cl">
</span></span><span class="line"><span class="ln"> 90</span><span class="cl">            <span class="c1"># Display the menu for selecting a YAML file to apply</span>
</span></span><span class="line"><span class="ln"> 91</span><span class="cl">            <span class="nv">PS3</span><span class="o">=</span><span class="s2">&#34;Select a YAML file to apply: &#34;</span>
</span></span><span class="line"><span class="ln"> 92</span><span class="cl">            <span class="k">select</span> SELECTED_YAML in <span class="s2">&#34;</span><span class="si">${</span><span class="nv">yaml_files</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&#34;</span> <span class="s2">&#34;Back to Main Menu&#34;</span><span class="p">;</span> <span class="k">do</span>
</span></span><span class="line"><span class="ln"> 93</span><span class="cl">                <span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&#34;</span><span class="nv">$SELECTED_YAML</span><span class="s2">&#34;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="ln"> 94</span><span class="cl">                    <span class="k">if</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$SELECTED_YAML</span><span class="s2">&#34;</span> <span class="o">==</span> <span class="s2">&#34;Back to Main Menu&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="ln"> 95</span><span class="cl">                        <span class="nb">break</span>
</span></span><span class="line"><span class="ln"> 96</span><span class="cl">                    <span class="k">fi</span>
</span></span><span class="line"><span class="ln"> 97</span><span class="cl">
</span></span><span class="line"><span class="ln"> 98</span><span class="cl">                    kubectl apply -f <span class="s2">&#34;</span><span class="nv">$SELECTED_YAML</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="ln"> 99</span><span class="cl">
</span></span><span class="line"><span class="ln">100</span><span class="cl">                    <span class="nb">echo</span> <span class="s2">&#34;Applied </span><span class="nv">$SELECTED_YAML</span><span class="s2"> in context </span><span class="nv">$SWITCH_CONTEXT</span><span class="s2">.&#34;</span>
</span></span><span class="line"><span class="ln">101</span><span class="cl">                    sleep <span class="m">2</span>
</span></span><span class="line"><span class="ln">102</span><span class="cl">                    <span class="nb">break</span>
</span></span><span class="line"><span class="ln">103</span><span class="cl">                <span class="k">else</span>
</span></span><span class="line"><span class="ln">104</span><span class="cl">                    <span class="nb">echo</span> <span class="s2">&#34;Invalid selection. Please choose a YAML file or &#39;Back to Main Menu&#39;.&#34;</span>
</span></span><span class="line"><span class="ln">105</span><span class="cl">                <span class="k">fi</span>
</span></span><span class="line"><span class="ln">106</span><span class="cl">            <span class="k">done</span>
</span></span><span class="line"><span class="ln">107</span><span class="cl">            <span class="nb">break</span>
</span></span><span class="line"><span class="ln">108</span><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="ln">109</span><span class="cl">            <span class="nb">echo</span> <span class="s2">&#34;Invalid selection. Please choose a context or &#39;Back to Main Menu&#39;.&#34;</span>
</span></span><span class="line"><span class="ln">110</span><span class="cl">        <span class="k">fi</span>
</span></span><span class="line"><span class="ln">111</span><span class="cl">    <span class="k">done</span>
</span></span><span class="line"><span class="ln">112</span><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="ln">113</span><span class="cl">
</span></span><span class="line"><span class="ln">114</span><span class="cl"><span class="c1"># Function to create ClusterSet on the leader cluster</span>
</span></span><span class="line"><span class="ln">115</span><span class="cl">create_clusterset_on_leader<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="ln">116</span><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;Creating ClusterSet on the leader cluster...&#34;</span>
</span></span><span class="line"><span class="ln">117</span><span class="cl">
</span></span><span class="line"><span class="ln">118</span><span class="cl">    <span class="c1"># List available contexts and create a menu</span>
</span></span><span class="line"><span class="ln">119</span><span class="cl">    <span class="nv">contexts</span><span class="o">=(</span><span class="k">$(</span>kubectl config get-contexts -o<span class="o">=</span>name<span class="k">)</span><span class="o">)</span>
</span></span><span class="line"><span class="ln">120</span><span class="cl">
</span></span><span class="line"><span class="ln">121</span><span class="cl">    <span class="c1"># Display the menu for selecting the leader cluster context</span>
</span></span><span class="line"><span class="ln">122</span><span class="cl">    <span class="nv">PS3</span><span class="o">=</span><span class="s2">&#34;Select the leader cluster context: &#34;</span>
</span></span><span class="line"><span class="ln">123</span><span class="cl">    <span class="k">select</span> LEADER_CONTEXT in <span class="s2">&#34;</span><span class="si">${</span><span class="nv">contexts</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&#34;</span> <span class="s2">&#34;Back to Main Menu&#34;</span><span class="p">;</span> <span class="k">do</span>
</span></span><span class="line"><span class="ln">124</span><span class="cl">        <span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&#34;</span><span class="nv">$LEADER_CONTEXT</span><span class="s2">&#34;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="ln">125</span><span class="cl">            <span class="k">if</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$LEADER_CONTEXT</span><span class="s2">&#34;</span> <span class="o">==</span> <span class="s2">&#34;Back to Main Menu&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="ln">126</span><span class="cl">                <span class="nb">break</span>
</span></span><span class="line"><span class="ln">127</span><span class="cl">            <span class="k">fi</span>
</span></span><span class="line"><span class="ln">128</span><span class="cl">
</span></span><span class="line"><span class="ln">129</span><span class="cl">            kubectl config use-context <span class="s2">&#34;</span><span class="nv">$LEADER_CONTEXT</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="ln">130</span><span class="cl">
</span></span><span class="line"><span class="ln">131</span><span class="cl">            <span class="c1"># Prompt for ClusterID and ClusterSet name</span>
</span></span><span class="line"><span class="ln">132</span><span class="cl">            <span class="nb">read</span> -p <span class="s2">&#34;Enter ClusterID (e.g., tkg-cluster-leader): &#34;</span> CLUSTER_ID
</span></span><span class="line"><span class="ln">133</span><span class="cl">            <span class="nb">read</span> -p <span class="s2">&#34;Enter ClusterSet name (e.g., andreasm-clusterset): &#34;</span> CLUSTERSET_NAME
</span></span><span class="line"><span class="ln">134</span><span class="cl">
</span></span><span class="line"><span class="ln">135</span><span class="cl">            <span class="c1"># Create YAML content for ClusterSet</span>
</span></span><span class="line"><span class="ln">136</span><span class="cl">            cat <span class="s">&lt;&lt;EOF &gt; clusterset.yaml
</span></span></span><span class="line"><span class="ln">137</span><span class="cl"><span class="s">apiVersion: multicluster.crd.antrea.io/v1alpha2
</span></span></span><span class="line"><span class="ln">138</span><span class="cl"><span class="s">kind: ClusterClaim
</span></span></span><span class="line"><span class="ln">139</span><span class="cl"><span class="s">metadata:
</span></span></span><span class="line"><span class="ln">140</span><span class="cl"><span class="s">  name: id.k8s.io
</span></span></span><span class="line"><span class="ln">141</span><span class="cl"><span class="s">  namespace: antrea-multicluster
</span></span></span><span class="line"><span class="ln">142</span><span class="cl"><span class="s">value: $CLUSTER_ID
</span></span></span><span class="line"><span class="ln">143</span><span class="cl"><span class="s">---
</span></span></span><span class="line"><span class="ln">144</span><span class="cl"><span class="s">apiVersion: multicluster.crd.antrea.io/v1alpha2
</span></span></span><span class="line"><span class="ln">145</span><span class="cl"><span class="s">kind: ClusterClaim
</span></span></span><span class="line"><span class="ln">146</span><span class="cl"><span class="s">metadata:
</span></span></span><span class="line"><span class="ln">147</span><span class="cl"><span class="s">  name: clusterset.k8s.io
</span></span></span><span class="line"><span class="ln">148</span><span class="cl"><span class="s">  namespace: antrea-multicluster
</span></span></span><span class="line"><span class="ln">149</span><span class="cl"><span class="s">value: $CLUSTERSET_NAME
</span></span></span><span class="line"><span class="ln">150</span><span class="cl"><span class="s">---
</span></span></span><span class="line"><span class="ln">151</span><span class="cl"><span class="s">apiVersion: multicluster.crd.antrea.io/v1alpha1
</span></span></span><span class="line"><span class="ln">152</span><span class="cl"><span class="s">kind: ClusterSet
</span></span></span><span class="line"><span class="ln">153</span><span class="cl"><span class="s">metadata:
</span></span></span><span class="line"><span class="ln">154</span><span class="cl"><span class="s">  name: $CLUSTERSET_NAME
</span></span></span><span class="line"><span class="ln">155</span><span class="cl"><span class="s">  namespace: antrea-multicluster
</span></span></span><span class="line"><span class="ln">156</span><span class="cl"><span class="s">spec:
</span></span></span><span class="line"><span class="ln">157</span><span class="cl"><span class="s">  leaders:
</span></span></span><span class="line"><span class="ln">158</span><span class="cl"><span class="s">    - clusterID: $CLUSTER_ID
</span></span></span><span class="line"><span class="ln">159</span><span class="cl"><span class="s">EOF</span>
</span></span><span class="line"><span class="ln">160</span><span class="cl">
</span></span><span class="line"><span class="ln">161</span><span class="cl">            <span class="c1"># Apply the ClusterSet YAML</span>
</span></span><span class="line"><span class="ln">162</span><span class="cl">            kubectl apply -f clusterset.yaml
</span></span><span class="line"><span class="ln">163</span><span class="cl">
</span></span><span class="line"><span class="ln">164</span><span class="cl">            <span class="nb">echo</span> <span class="s2">&#34;ClusterSet created on the leader cluster.&#34;</span>
</span></span><span class="line"><span class="ln">165</span><span class="cl">            sleep <span class="m">2</span>
</span></span><span class="line"><span class="ln">166</span><span class="cl">            <span class="nb">break</span>
</span></span><span class="line"><span class="ln">167</span><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="ln">168</span><span class="cl">            <span class="nb">echo</span> <span class="s2">&#34;Invalid selection. Please choose a context or &#39;Back to Main Menu&#39;.&#34;</span>
</span></span><span class="line"><span class="ln">169</span><span class="cl">        <span class="k">fi</span>
</span></span><span class="line"><span class="ln">170</span><span class="cl">    <span class="k">done</span>
</span></span><span class="line"><span class="ln">171</span><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="ln">172</span><span class="cl">
</span></span><span class="line"><span class="ln">173</span><span class="cl"><span class="c1"># Function to create ClusterClaim on member cluster</span>
</span></span><span class="line"><span class="ln">174</span><span class="cl">create_clusterclaim_on_member<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="ln">175</span><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;Creating ClusterClaim on member cluster...&#34;</span>
</span></span><span class="line"><span class="ln">176</span><span class="cl">
</span></span><span class="line"><span class="ln">177</span><span class="cl">    <span class="c1"># List available contexts and create a menu</span>
</span></span><span class="line"><span class="ln">178</span><span class="cl">    <span class="nv">contexts</span><span class="o">=(</span><span class="k">$(</span>kubectl config get-contexts -o<span class="o">=</span>name<span class="k">)</span><span class="o">)</span>
</span></span><span class="line"><span class="ln">179</span><span class="cl">
</span></span><span class="line"><span class="ln">180</span><span class="cl">    <span class="c1"># Display the menu for selecting a context to switch to</span>
</span></span><span class="line"><span class="ln">181</span><span class="cl">    <span class="nv">PS3</span><span class="o">=</span><span class="s2">&#34;Select a context to switch to: &#34;</span>
</span></span><span class="line"><span class="ln">182</span><span class="cl">    <span class="k">select</span> MEMBER_CONTEXT in <span class="s2">&#34;</span><span class="si">${</span><span class="nv">contexts</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&#34;</span> <span class="s2">&#34;Back to Main Menu&#34;</span><span class="p">;</span> <span class="k">do</span>
</span></span><span class="line"><span class="ln">183</span><span class="cl">        <span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&#34;</span><span class="nv">$MEMBER_CONTEXT</span><span class="s2">&#34;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="ln">184</span><span class="cl">            <span class="k">if</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$MEMBER_CONTEXT</span><span class="s2">&#34;</span> <span class="o">==</span> <span class="s2">&#34;Back to Main Menu&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="ln">185</span><span class="cl">                <span class="nb">break</span>
</span></span><span class="line"><span class="ln">186</span><span class="cl">            <span class="k">fi</span>
</span></span><span class="line"><span class="ln">187</span><span class="cl">
</span></span><span class="line"><span class="ln">188</span><span class="cl">            kubectl config use-context <span class="s2">&#34;</span><span class="nv">$MEMBER_CONTEXT</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="ln">189</span><span class="cl">
</span></span><span class="line"><span class="ln">190</span><span class="cl">            <span class="c1"># Prompt for ClusterClaim values</span>
</span></span><span class="line"><span class="ln">191</span><span class="cl">            <span class="nb">read</span> -p <span class="s2">&#34;Enter member-cluster-name (e.g., member-cluster-red): &#34;</span> MEMBER_CLUSTER_NAME
</span></span><span class="line"><span class="ln">192</span><span class="cl">            <span class="nb">read</span> -p <span class="s2">&#34;Enter ClusterSet name (e.g., andreasm-clusterset): &#34;</span> CLUSTERSET_NAME
</span></span><span class="line"><span class="ln">193</span><span class="cl">            <span class="nb">read</span> -p <span class="s2">&#34;Enter Leader ClusterID (e.g., tkg-cluster-leader): &#34;</span> LEADER_CLUSTER_ID
</span></span><span class="line"><span class="ln">194</span><span class="cl">            <span class="nb">read</span> -p <span class="s2">&#34;Enter Member Token to use: &#34;</span> MEMBER_TOKEN
</span></span><span class="line"><span class="ln">195</span><span class="cl">            <span class="nb">read</span> -p <span class="s2">&#34;Enter Leader cluster API endpoint (e.g., https://10.101.114.100:6443): &#34;</span> LEADER_ENDPOINT
</span></span><span class="line"><span class="ln">196</span><span class="cl">
</span></span><span class="line"><span class="ln">197</span><span class="cl">            <span class="c1"># Create YAML content for ClusterClaim</span>
</span></span><span class="line"><span class="ln">198</span><span class="cl">            cat <span class="s">&lt;&lt;EOF &gt; &#34;${MEMBER_CLUSTER_NAME}-clusterclaim.yaml&#34;
</span></span></span><span class="line"><span class="ln">199</span><span class="cl"><span class="s">apiVersion: multicluster.crd.antrea.io/v1alpha2
</span></span></span><span class="line"><span class="ln">200</span><span class="cl"><span class="s">kind: ClusterClaim
</span></span></span><span class="line"><span class="ln">201</span><span class="cl"><span class="s">metadata:
</span></span></span><span class="line"><span class="ln">202</span><span class="cl"><span class="s">  name: id.k8s.io
</span></span></span><span class="line"><span class="ln">203</span><span class="cl"><span class="s">  namespace: kube-system
</span></span></span><span class="line"><span class="ln">204</span><span class="cl"><span class="s">value: $MEMBER_CLUSTER_NAME
</span></span></span><span class="line"><span class="ln">205</span><span class="cl"><span class="s">---
</span></span></span><span class="line"><span class="ln">206</span><span class="cl"><span class="s">apiVersion: multicluster.crd.antrea.io/v1alpha2
</span></span></span><span class="line"><span class="ln">207</span><span class="cl"><span class="s">kind: ClusterClaim
</span></span></span><span class="line"><span class="ln">208</span><span class="cl"><span class="s">metadata:
</span></span></span><span class="line"><span class="ln">209</span><span class="cl"><span class="s">  name: clusterset.k8s.io
</span></span></span><span class="line"><span class="ln">210</span><span class="cl"><span class="s">  namespace: kube-system
</span></span></span><span class="line"><span class="ln">211</span><span class="cl"><span class="s">value: $CLUSTERSET_NAME
</span></span></span><span class="line"><span class="ln">212</span><span class="cl"><span class="s">---
</span></span></span><span class="line"><span class="ln">213</span><span class="cl"><span class="s">apiVersion: multicluster.crd.antrea.io/v1alpha1
</span></span></span><span class="line"><span class="ln">214</span><span class="cl"><span class="s">kind: ClusterSet
</span></span></span><span class="line"><span class="ln">215</span><span class="cl"><span class="s">metadata:
</span></span></span><span class="line"><span class="ln">216</span><span class="cl"><span class="s">  name: $CLUSTERSET_NAME
</span></span></span><span class="line"><span class="ln">217</span><span class="cl"><span class="s">  namespace: kube-system
</span></span></span><span class="line"><span class="ln">218</span><span class="cl"><span class="s">spec:
</span></span></span><span class="line"><span class="ln">219</span><span class="cl"><span class="s">  leaders:
</span></span></span><span class="line"><span class="ln">220</span><span class="cl"><span class="s">    - clusterID: $LEADER_CLUSTER_ID
</span></span></span><span class="line"><span class="ln">221</span><span class="cl"><span class="s">      secret: &#34;$MEMBER_TOKEN&#34;
</span></span></span><span class="line"><span class="ln">222</span><span class="cl"><span class="s">      server: &#34;$LEADER_ENDPOINT&#34;
</span></span></span><span class="line"><span class="ln">223</span><span class="cl"><span class="s">  namespace: antrea-multicluster
</span></span></span><span class="line"><span class="ln">224</span><span class="cl"><span class="s">EOF</span>
</span></span><span class="line"><span class="ln">225</span><span class="cl">
</span></span><span class="line"><span class="ln">226</span><span class="cl">            <span class="c1"># Apply the ClusterClaim YAML</span>
</span></span><span class="line"><span class="ln">227</span><span class="cl">            kubectl apply -f <span class="s2">&#34;</span><span class="si">${</span><span class="nv">MEMBER_CLUSTER_NAME</span><span class="si">}</span><span class="s2">-clusterclaim.yaml&#34;</span>
</span></span><span class="line"><span class="ln">228</span><span class="cl">
</span></span><span class="line"><span class="ln">229</span><span class="cl">            <span class="nb">echo</span> <span class="s2">&#34;ClusterClaim created on member cluster.&#34;</span>
</span></span><span class="line"><span class="ln">230</span><span class="cl">            sleep <span class="m">2</span>
</span></span><span class="line"><span class="ln">231</span><span class="cl">            <span class="nb">break</span>
</span></span><span class="line"><span class="ln">232</span><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="ln">233</span><span class="cl">            <span class="nb">echo</span> <span class="s2">&#34;Invalid selection. Please choose a context or &#39;Back to Main Menu&#39;.&#34;</span>
</span></span><span class="line"><span class="ln">234</span><span class="cl">        <span class="k">fi</span>
</span></span><span class="line"><span class="ln">235</span><span class="cl">    <span class="k">done</span>
</span></span><span class="line"><span class="ln">236</span><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="ln">237</span><span class="cl">
</span></span><span class="line"><span class="ln">238</span><span class="cl"><span class="c1"># Function to create Multi-cluster Gateway</span>
</span></span><span class="line"><span class="ln">239</span><span class="cl">create_multi_cluster_gateway<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="ln">240</span><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;Creating Multi-cluster Gateway...&#34;</span>
</span></span><span class="line"><span class="ln">241</span><span class="cl">
</span></span><span class="line"><span class="ln">242</span><span class="cl">    <span class="c1"># List available contexts and create a menu</span>
</span></span><span class="line"><span class="ln">243</span><span class="cl">    <span class="nv">contexts</span><span class="o">=(</span><span class="k">$(</span>kubectl config get-contexts -o<span class="o">=</span>name<span class="k">)</span><span class="o">)</span>
</span></span><span class="line"><span class="ln">244</span><span class="cl">
</span></span><span class="line"><span class="ln">245</span><span class="cl">    <span class="c1"># Display the menu for selecting a context to switch to</span>
</span></span><span class="line"><span class="ln">246</span><span class="cl">    <span class="nv">PS3</span><span class="o">=</span><span class="s2">&#34;Select a context to switch to: &#34;</span>
</span></span><span class="line"><span class="ln">247</span><span class="cl">    <span class="k">select</span> GATEWAY_CONTEXT in <span class="s2">&#34;</span><span class="si">${</span><span class="nv">contexts</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&#34;</span> <span class="s2">&#34;Back to Main Menu&#34;</span><span class="p">;</span> <span class="k">do</span>
</span></span><span class="line"><span class="ln">248</span><span class="cl">        <span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&#34;</span><span class="nv">$GATEWAY_CONTEXT</span><span class="s2">&#34;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="ln">249</span><span class="cl">            <span class="k">if</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$GATEWAY_CONTEXT</span><span class="s2">&#34;</span> <span class="o">==</span> <span class="s2">&#34;Back to Main Menu&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="ln">250</span><span class="cl">                <span class="nb">break</span>
</span></span><span class="line"><span class="ln">251</span><span class="cl">            <span class="k">fi</span>
</span></span><span class="line"><span class="ln">252</span><span class="cl">
</span></span><span class="line"><span class="ln">253</span><span class="cl">            kubectl config use-context <span class="s2">&#34;</span><span class="nv">$GATEWAY_CONTEXT</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="ln">254</span><span class="cl">
</span></span><span class="line"><span class="ln">255</span><span class="cl">            <span class="k">while</span> true<span class="p">;</span> <span class="k">do</span>
</span></span><span class="line"><span class="ln">256</span><span class="cl">                <span class="c1"># List nodes and create a menu</span>
</span></span><span class="line"><span class="ln">257</span><span class="cl">                <span class="nv">nodes</span><span class="o">=(</span><span class="k">$(</span>kubectl get nodes -o custom-columns<span class="o">=</span>NAME:.metadata.name --no-headers<span class="k">)</span><span class="o">)</span>
</span></span><span class="line"><span class="ln">258</span><span class="cl">
</span></span><span class="line"><span class="ln">259</span><span class="cl">                <span class="c1"># Display the menu for selecting a node to annotate</span>
</span></span><span class="line"><span class="ln">260</span><span class="cl">                <span class="nv">PS3</span><span class="o">=</span><span class="s2">&#34;Select a node to annotate as Multi-cluster Gateway: &#34;</span>
</span></span><span class="line"><span class="ln">261</span><span class="cl">                <span class="k">select</span> SELECTED_NODE in <span class="s2">&#34;</span><span class="si">${</span><span class="nv">nodes</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&#34;</span> <span class="s2">&#34;Back to Context Menu&#34;</span><span class="p">;</span> <span class="k">do</span>
</span></span><span class="line"><span class="ln">262</span><span class="cl">                    <span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&#34;</span><span class="nv">$SELECTED_NODE</span><span class="s2">&#34;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="ln">263</span><span class="cl">                        <span class="k">if</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$SELECTED_NODE</span><span class="s2">&#34;</span> <span class="o">==</span> <span class="s2">&#34;Back to Context Menu&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="ln">264</span><span class="cl">                            <span class="nb">break</span>
</span></span><span class="line"><span class="ln">265</span><span class="cl">                        <span class="k">fi</span>
</span></span><span class="line"><span class="ln">266</span><span class="cl">
</span></span><span class="line"><span class="ln">267</span><span class="cl">                        <span class="c1"># Annotate the selected node</span>
</span></span><span class="line"><span class="ln">268</span><span class="cl">                        kubectl annotate node <span class="s2">&#34;</span><span class="nv">$SELECTED_NODE</span><span class="s2">&#34;</span> multicluster.antrea.io/gateway<span class="o">=</span><span class="nb">true</span>
</span></span><span class="line"><span class="ln">269</span><span class="cl">
</span></span><span class="line"><span class="ln">270</span><span class="cl">                        <span class="nb">echo</span> <span class="s2">&#34;Annotated </span><span class="nv">$SELECTED_NODE</span><span class="s2"> as Multi-cluster Gateway.&#34;</span>
</span></span><span class="line"><span class="ln">271</span><span class="cl">                        sleep <span class="m">2</span>
</span></span><span class="line"><span class="ln">272</span><span class="cl">                    <span class="k">else</span>
</span></span><span class="line"><span class="ln">273</span><span class="cl">                        <span class="nb">echo</span> <span class="s2">&#34;Invalid selection. Please choose a node or &#39;Back to Context Menu&#39;.&#34;</span>
</span></span><span class="line"><span class="ln">274</span><span class="cl">                    <span class="k">fi</span>
</span></span><span class="line"><span class="ln">275</span><span class="cl">                <span class="k">done</span>
</span></span><span class="line"><span class="ln">276</span><span class="cl">
</span></span><span class="line"><span class="ln">277</span><span class="cl">                <span class="nb">read</span> -p <span class="s2">&#34;Do you want to annotate another node? (yes/no): &#34;</span> ANNOTATE_ANOTHER
</span></span><span class="line"><span class="ln">278</span><span class="cl">                <span class="k">if</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$ANNOTATE_ANOTHER</span><span class="s2">&#34;</span> !<span class="o">=</span> <span class="s2">&#34;yes&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="ln">279</span><span class="cl">                    <span class="nb">break</span>
</span></span><span class="line"><span class="ln">280</span><span class="cl">                <span class="k">fi</span>
</span></span><span class="line"><span class="ln">281</span><span class="cl">            <span class="k">done</span>
</span></span><span class="line"><span class="ln">282</span><span class="cl">            <span class="nb">break</span>
</span></span><span class="line"><span class="ln">283</span><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="ln">284</span><span class="cl">            <span class="nb">echo</span> <span class="s2">&#34;Invalid selection. Please choose a context or &#39;Back to Main Menu&#39;.&#34;</span>
</span></span><span class="line"><span class="ln">285</span><span class="cl">        <span class="k">fi</span>
</span></span><span class="line"><span class="ln">286</span><span class="cl">    <span class="k">done</span>
</span></span><span class="line"><span class="ln">287</span><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="ln">288</span><span class="cl">
</span></span><span class="line"><span class="ln">289</span><span class="cl"><span class="c1"># Function to create a Multi-cluster service</span>
</span></span><span class="line"><span class="ln">290</span><span class="cl">create_multi_cluster_service<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="ln">291</span><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;Creating a Multi-cluster service...&#34;</span>
</span></span><span class="line"><span class="ln">292</span><span class="cl">
</span></span><span class="line"><span class="ln">293</span><span class="cl">    <span class="c1"># List available contexts and create a menu</span>
</span></span><span class="line"><span class="ln">294</span><span class="cl">    <span class="nv">contexts</span><span class="o">=(</span><span class="k">$(</span>kubectl config get-contexts -o<span class="o">=</span>name<span class="k">)</span><span class="o">)</span>
</span></span><span class="line"><span class="ln">295</span><span class="cl">
</span></span><span class="line"><span class="ln">296</span><span class="cl">    <span class="c1"># Display the menu for selecting a context to switch to</span>
</span></span><span class="line"><span class="ln">297</span><span class="cl">    <span class="nv">PS3</span><span class="o">=</span><span class="s2">&#34;Select a context to switch to: &#34;</span>
</span></span><span class="line"><span class="ln">298</span><span class="cl">    <span class="k">select</span> SELECT_CONTEXT in <span class="s2">&#34;</span><span class="si">${</span><span class="nv">contexts</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&#34;</span> <span class="s2">&#34;Back to Main Menu&#34;</span><span class="p">;</span> <span class="k">do</span>
</span></span><span class="line"><span class="ln">299</span><span class="cl">        <span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&#34;</span><span class="nv">$SELECT_CONTEXT</span><span class="s2">&#34;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="ln">300</span><span class="cl">            <span class="k">if</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$SELECT_CONTEXT</span><span class="s2">&#34;</span> <span class="o">==</span> <span class="s2">&#34;Back to Main Menu&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="ln">301</span><span class="cl">                <span class="nb">break</span>
</span></span><span class="line"><span class="ln">302</span><span class="cl">            <span class="k">fi</span>
</span></span><span class="line"><span class="ln">303</span><span class="cl">
</span></span><span class="line"><span class="ln">304</span><span class="cl">            kubectl config use-context <span class="s2">&#34;</span><span class="nv">$SELECT_CONTEXT</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="ln">305</span><span class="cl">
</span></span><span class="line"><span class="ln">306</span><span class="cl">            <span class="c1"># List namespaces and create a menu</span>
</span></span><span class="line"><span class="ln">307</span><span class="cl">            <span class="nv">namespaces</span><span class="o">=(</span><span class="k">$(</span>kubectl get namespaces -o custom-columns<span class="o">=</span>NAME:.metadata.name --no-headers<span class="k">)</span><span class="o">)</span>
</span></span><span class="line"><span class="ln">308</span><span class="cl">
</span></span><span class="line"><span class="ln">309</span><span class="cl">            <span class="c1"># Display the menu for selecting a namespace</span>
</span></span><span class="line"><span class="ln">310</span><span class="cl">            <span class="nv">PS3</span><span class="o">=</span><span class="s2">&#34;Select a namespace to list services from: &#34;</span>
</span></span><span class="line"><span class="ln">311</span><span class="cl">            <span class="k">select</span> SELECTED_NAMESPACE in <span class="s2">&#34;</span><span class="si">${</span><span class="nv">namespaces</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&#34;</span> <span class="s2">&#34;Back to Context Menu&#34;</span><span class="p">;</span> <span class="k">do</span>
</span></span><span class="line"><span class="ln">312</span><span class="cl">                <span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&#34;</span><span class="nv">$SELECTED_NAMESPACE</span><span class="s2">&#34;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="ln">313</span><span class="cl">                    <span class="k">if</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$SELECTED_NAMESPACE</span><span class="s2">&#34;</span> <span class="o">==</span> <span class="s2">&#34;Back to Context Menu&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="ln">314</span><span class="cl">                        <span class="nb">break</span>
</span></span><span class="line"><span class="ln">315</span><span class="cl">                    <span class="k">fi</span>
</span></span><span class="line"><span class="ln">316</span><span class="cl">
</span></span><span class="line"><span class="ln">317</span><span class="cl">                    <span class="c1"># List services in the selected namespace and create a menu</span>
</span></span><span class="line"><span class="ln">318</span><span class="cl">                    <span class="nv">services</span><span class="o">=(</span><span class="k">$(</span>kubectl get services -n <span class="s2">&#34;</span><span class="nv">$SELECTED_NAMESPACE</span><span class="s2">&#34;</span> -o custom-columns<span class="o">=</span>NAME:.metadata.name --no-headers<span class="k">)</span><span class="o">)</span>
</span></span><span class="line"><span class="ln">319</span><span class="cl">
</span></span><span class="line"><span class="ln">320</span><span class="cl">                    <span class="c1"># Display the menu for selecting a service</span>
</span></span><span class="line"><span class="ln">321</span><span class="cl">                    <span class="nv">PS3</span><span class="o">=</span><span class="s2">&#34;Select a service to export as Multi-cluster service: &#34;</span>
</span></span><span class="line"><span class="ln">322</span><span class="cl">                    <span class="k">select</span> SELECTED_SERVICE in <span class="s2">&#34;</span><span class="si">${</span><span class="nv">services</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&#34;</span> <span class="s2">&#34;Back to Namespace Menu&#34;</span><span class="p">;</span> <span class="k">do</span>
</span></span><span class="line"><span class="ln">323</span><span class="cl">                        <span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&#34;</span><span class="nv">$SELECTED_SERVICE</span><span class="s2">&#34;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="ln">324</span><span class="cl">                            <span class="k">if</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$SELECTED_SERVICE</span><span class="s2">&#34;</span> <span class="o">==</span> <span class="s2">&#34;Back to Namespace Menu&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="ln">325</span><span class="cl">                                <span class="nb">break</span>
</span></span><span class="line"><span class="ln">326</span><span class="cl">                            <span class="k">fi</span>
</span></span><span class="line"><span class="ln">327</span><span class="cl">
</span></span><span class="line"><span class="ln">328</span><span class="cl">                            <span class="c1"># Create YAML content for ServiceExport</span>
</span></span><span class="line"><span class="ln">329</span><span class="cl">                            cat <span class="s">&lt;&lt;EOF &gt; &#34;${SELECTED_SERVICE}-multi-cluster-service.yaml&#34;
</span></span></span><span class="line"><span class="ln">330</span><span class="cl"><span class="s">apiVersion: multicluster.x-k8s.io/v1alpha1
</span></span></span><span class="line"><span class="ln">331</span><span class="cl"><span class="s">kind: ServiceExport
</span></span></span><span class="line"><span class="ln">332</span><span class="cl"><span class="s">metadata:
</span></span></span><span class="line"><span class="ln">333</span><span class="cl"><span class="s">  name: $SELECTED_SERVICE
</span></span></span><span class="line"><span class="ln">334</span><span class="cl"><span class="s">  namespace: $SELECTED_NAMESPACE
</span></span></span><span class="line"><span class="ln">335</span><span class="cl"><span class="s">EOF</span>
</span></span><span class="line"><span class="ln">336</span><span class="cl">
</span></span><span class="line"><span class="ln">337</span><span class="cl">                            <span class="nb">echo</span> <span class="s2">&#34;ServiceExport created for </span><span class="nv">$SELECTED_SERVICE</span><span class="s2"> in namespace </span><span class="nv">$SELECTED_NAMESPACE</span><span class="s2">.&#34;</span>
</span></span><span class="line"><span class="ln">338</span><span class="cl">
</span></span><span class="line"><span class="ln">339</span><span class="cl">                            <span class="c1"># Apply the Multi-cluster service</span>
</span></span><span class="line"><span class="ln">340</span><span class="cl">                            kubectl apply -f <span class="s2">&#34;</span><span class="si">${</span><span class="nv">SELECTED_SERVICE</span><span class="si">}</span><span class="s2">-multi-cluster-service.yaml&#34;</span>
</span></span><span class="line"><span class="ln">341</span><span class="cl">                            <span class="nb">echo</span> <span class="s2">&#34;Multi-cluster service applied.&#34;</span>
</span></span><span class="line"><span class="ln">342</span><span class="cl">
</span></span><span class="line"><span class="ln">343</span><span class="cl">                            sleep <span class="m">2</span>
</span></span><span class="line"><span class="ln">344</span><span class="cl">                            <span class="nb">break</span>
</span></span><span class="line"><span class="ln">345</span><span class="cl">                        <span class="k">else</span>
</span></span><span class="line"><span class="ln">346</span><span class="cl">                            <span class="nb">echo</span> <span class="s2">&#34;Invalid selection. Please choose a service or &#39;Back to Namespace Menu&#39;.&#34;</span>
</span></span><span class="line"><span class="ln">347</span><span class="cl">                        <span class="k">fi</span>
</span></span><span class="line"><span class="ln">348</span><span class="cl">                    <span class="k">done</span>
</span></span><span class="line"><span class="ln">349</span><span class="cl">                <span class="k">else</span>
</span></span><span class="line"><span class="ln">350</span><span class="cl">                    <span class="nb">echo</span> <span class="s2">&#34;Invalid selection. Please choose a namespace or &#39;Back to Context Menu&#39;.&#34;</span>
</span></span><span class="line"><span class="ln">351</span><span class="cl">                <span class="k">fi</span>
</span></span><span class="line"><span class="ln">352</span><span class="cl">            <span class="k">done</span>
</span></span><span class="line"><span class="ln">353</span><span class="cl">            <span class="nb">break</span>
</span></span><span class="line"><span class="ln">354</span><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="ln">355</span><span class="cl">            <span class="nb">echo</span> <span class="s2">&#34;Invalid selection. Please choose a context or &#39;Back to Main Menu&#39;.&#34;</span>
</span></span><span class="line"><span class="ln">356</span><span class="cl">        <span class="k">fi</span>
</span></span><span class="line"><span class="ln">357</span><span class="cl">    <span class="k">done</span>
</span></span><span class="line"><span class="ln">358</span><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="ln">359</span><span class="cl">
</span></span><span class="line"><span class="ln">360</span><span class="cl">
</span></span><span class="line"><span class="ln">361</span><span class="cl">
</span></span><span class="line"><span class="ln">362</span><span class="cl"><span class="c1"># Main menu</span>
</span></span><span class="line"><span class="ln">363</span><span class="cl"><span class="k">while</span> true<span class="p">;</span> <span class="k">do</span>
</span></span><span class="line"><span class="ln">364</span><span class="cl">    clear
</span></span><span class="line"><span class="ln">365</span><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;Main Menu:&#34;</span>
</span></span><span class="line"><span class="ln">366</span><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;1. Select Antrea version&#34;</span>
</span></span><span class="line"><span class="ln">367</span><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;2. Install Antrea Multi-cluster on leader cluster&#34;</span>
</span></span><span class="line"><span class="ln">368</span><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;3. Install Antrea Multi-cluster on member cluster&#34;</span>
</span></span><span class="line"><span class="ln">369</span><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;4. Create member-cluster secrets&#34;</span>
</span></span><span class="line"><span class="ln">370</span><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;5. Apply member tokens&#34;</span>
</span></span><span class="line"><span class="ln">371</span><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;6. Create ClusterSet on the leader cluster&#34;</span>
</span></span><span class="line"><span class="ln">372</span><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;7. Create ClusterClaim on member cluster&#34;</span>
</span></span><span class="line"><span class="ln">373</span><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;8. Create Multi-cluster Gateway&#34;</span>
</span></span><span class="line"><span class="ln">374</span><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;9. Create a Multi-cluster service&#34;</span>
</span></span><span class="line"><span class="ln">375</span><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;10. Exit&#34;</span>
</span></span><span class="line"><span class="ln">376</span><span class="cl">
</span></span><span class="line"><span class="ln">377</span><span class="cl">    <span class="nb">read</span> -p <span class="s2">&#34;Enter your choice: &#34;</span> choice
</span></span><span class="line"><span class="ln">378</span><span class="cl">
</span></span><span class="line"><span class="ln">379</span><span class="cl">    <span class="k">case</span> <span class="nv">$choice</span> in
</span></span><span class="line"><span class="ln">380</span><span class="cl">        1<span class="o">)</span>
</span></span><span class="line"><span class="ln">381</span><span class="cl">            <span class="nb">read</span> -p <span class="s2">&#34;Enter Antrea version (e.g., v1.11.1): &#34;</span> TAG
</span></span><span class="line"><span class="ln">382</span><span class="cl">            <span class="p">;;</span>
</span></span><span class="line"><span class="ln">383</span><span class="cl">        2<span class="o">)</span>
</span></span><span class="line"><span class="ln">384</span><span class="cl">            <span class="nb">echo</span> <span class="s2">&#34;Installing Antrea Multi-cluster on leader cluster...&#34;</span>
</span></span><span class="line"><span class="ln">385</span><span class="cl">
</span></span><span class="line"><span class="ln">386</span><span class="cl">            <span class="c1"># List available contexts and create a menu</span>
</span></span><span class="line"><span class="ln">387</span><span class="cl">            <span class="nv">contexts</span><span class="o">=(</span><span class="k">$(</span>kubectl config get-contexts -o<span class="o">=</span>name<span class="k">)</span><span class="o">)</span>
</span></span><span class="line"><span class="ln">388</span><span class="cl">
</span></span><span class="line"><span class="ln">389</span><span class="cl">            <span class="c1"># Display the menu</span>
</span></span><span class="line"><span class="ln">390</span><span class="cl">            <span class="nv">PS3</span><span class="o">=</span><span class="s2">&#34;Select a context to switch to: &#34;</span>
</span></span><span class="line"><span class="ln">391</span><span class="cl">            <span class="k">select</span> SWITCH_CONTEXT in <span class="s2">&#34;</span><span class="si">${</span><span class="nv">contexts</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&#34;</span> <span class="s2">&#34;Back to Main Menu&#34;</span><span class="p">;</span> <span class="k">do</span>
</span></span><span class="line"><span class="ln">392</span><span class="cl">                <span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&#34;</span><span class="nv">$SWITCH_CONTEXT</span><span class="s2">&#34;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="ln">393</span><span class="cl">                    <span class="k">if</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$SWITCH_CONTEXT</span><span class="s2">&#34;</span> <span class="o">==</span> <span class="s2">&#34;Back to Main Menu&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="ln">394</span><span class="cl">                        <span class="nb">break</span>
</span></span><span class="line"><span class="ln">395</span><span class="cl">                    <span class="k">fi</span>
</span></span><span class="line"><span class="ln">396</span><span class="cl">
</span></span><span class="line"><span class="ln">397</span><span class="cl">                    kubectl config use-context <span class="s2">&#34;</span><span class="nv">$SWITCH_CONTEXT</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="ln">398</span><span class="cl">
</span></span><span class="line"><span class="ln">399</span><span class="cl">                    <span class="c1"># Create namespace if it does not exist</span>
</span></span><span class="line"><span class="ln">400</span><span class="cl">                    kubectl create namespace antrea-multicluster --dry-run<span class="o">=</span>client -o yaml <span class="p">|</span> kubectl apply -f -
</span></span><span class="line"><span class="ln">401</span><span class="cl">
</span></span><span class="line"><span class="ln">402</span><span class="cl">                    <span class="c1"># Apply leader cluster YAMLs</span>
</span></span><span class="line"><span class="ln">403</span><span class="cl">                    kubectl apply -f <span class="s2">&#34;https://github.com/antrea-io/antrea/releases/download/</span><span class="nv">$TAG</span><span class="s2">/antrea-multicluster-leader-global.yml&#34;</span>
</span></span><span class="line"><span class="ln">404</span><span class="cl">                    kubectl apply -f <span class="s2">&#34;https://github.com/antrea-io/antrea/releases/download/</span><span class="nv">$TAG</span><span class="s2">/antrea-multicluster-leader-namespaced.yml&#34;</span>
</span></span><span class="line"><span class="ln">405</span><span class="cl">
</span></span><span class="line"><span class="ln">406</span><span class="cl">                    <span class="nb">echo</span> <span class="s2">&#34;Antrea Multi-cluster installed on leader cluster.&#34;</span>
</span></span><span class="line"><span class="ln">407</span><span class="cl">                    sleep <span class="m">2</span>
</span></span><span class="line"><span class="ln">408</span><span class="cl">                    <span class="nb">break</span>
</span></span><span class="line"><span class="ln">409</span><span class="cl">                <span class="k">else</span>
</span></span><span class="line"><span class="ln">410</span><span class="cl">                    <span class="nb">echo</span> <span class="s2">&#34;Invalid selection. Please choose a context or &#39;Back to Main Menu&#39;.&#34;</span>
</span></span><span class="line"><span class="ln">411</span><span class="cl">                <span class="k">fi</span>
</span></span><span class="line"><span class="ln">412</span><span class="cl">            <span class="k">done</span>
</span></span><span class="line"><span class="ln">413</span><span class="cl">            <span class="p">;;</span>
</span></span><span class="line"><span class="ln">414</span><span class="cl">        3<span class="o">)</span>
</span></span><span class="line"><span class="ln">415</span><span class="cl">            <span class="nb">echo</span> <span class="s2">&#34;Installing Antrea Multi-cluster on member cluster...&#34;</span>
</span></span><span class="line"><span class="ln">416</span><span class="cl">
</span></span><span class="line"><span class="ln">417</span><span class="cl">            <span class="c1"># List available contexts and create a menu</span>
</span></span><span class="line"><span class="ln">418</span><span class="cl">            <span class="nv">contexts</span><span class="o">=(</span><span class="k">$(</span>kubectl config get-contexts -o<span class="o">=</span>name<span class="k">)</span><span class="o">)</span>
</span></span><span class="line"><span class="ln">419</span><span class="cl">
</span></span><span class="line"><span class="ln">420</span><span class="cl">            <span class="c1"># Display the menu</span>
</span></span><span class="line"><span class="ln">421</span><span class="cl">            <span class="nv">PS3</span><span class="o">=</span><span class="s2">&#34;Select a context to switch to: &#34;</span>
</span></span><span class="line"><span class="ln">422</span><span class="cl">            <span class="k">select</span> SWITCH_CONTEXT in <span class="s2">&#34;</span><span class="si">${</span><span class="nv">contexts</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&#34;</span> <span class="s2">&#34;Back to Main Menu&#34;</span><span class="p">;</span> <span class="k">do</span>
</span></span><span class="line"><span class="ln">423</span><span class="cl">                <span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&#34;</span><span class="nv">$SWITCH_CONTEXT</span><span class="s2">&#34;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="ln">424</span><span class="cl">                    <span class="k">if</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$SWITCH_CONTEXT</span><span class="s2">&#34;</span> <span class="o">==</span> <span class="s2">&#34;Back to Main Menu&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="ln">425</span><span class="cl">                        <span class="nb">break</span>
</span></span><span class="line"><span class="ln">426</span><span class="cl">                    <span class="k">fi</span>
</span></span><span class="line"><span class="ln">427</span><span class="cl">
</span></span><span class="line"><span class="ln">428</span><span class="cl">                    kubectl config use-context <span class="s2">&#34;</span><span class="nv">$SWITCH_CONTEXT</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="ln">429</span><span class="cl">
</span></span><span class="line"><span class="ln">430</span><span class="cl">                    <span class="c1"># Apply member cluster YAML</span>
</span></span><span class="line"><span class="ln">431</span><span class="cl">                    kubectl apply -f <span class="s2">&#34;https://github.com/antrea-io/antrea/releases/download/</span><span class="nv">$TAG</span><span class="s2">/antrea-multicluster-member.yml&#34;</span>
</span></span><span class="line"><span class="ln">432</span><span class="cl">
</span></span><span class="line"><span class="ln">433</span><span class="cl">                    <span class="nb">echo</span> <span class="s2">&#34;Antrea Multi-cluster installed on member cluster.&#34;</span>
</span></span><span class="line"><span class="ln">434</span><span class="cl">                    sleep <span class="m">2</span>
</span></span><span class="line"><span class="ln">435</span><span class="cl">                    <span class="nb">break</span>
</span></span><span class="line"><span class="ln">436</span><span class="cl">                <span class="k">else</span>
</span></span><span class="line"><span class="ln">437</span><span class="cl">                    <span class="nb">echo</span> <span class="s2">&#34;Invalid selection. Please choose a context or &#39;Back to Main Menu&#39;.&#34;</span>
</span></span><span class="line"><span class="ln">438</span><span class="cl">                <span class="k">fi</span>
</span></span><span class="line"><span class="ln">439</span><span class="cl">            <span class="k">done</span>
</span></span><span class="line"><span class="ln">440</span><span class="cl">            <span class="p">;;</span>
</span></span><span class="line"><span class="ln">441</span><span class="cl">        4<span class="o">)</span>
</span></span><span class="line"><span class="ln">442</span><span class="cl">            create_member_cluster_secrets
</span></span><span class="line"><span class="ln">443</span><span class="cl">            <span class="p">;;</span>
</span></span><span class="line"><span class="ln">444</span><span class="cl">        5<span class="o">)</span>
</span></span><span class="line"><span class="ln">445</span><span class="cl">            apply_member_tokens
</span></span><span class="line"><span class="ln">446</span><span class="cl">            <span class="p">;;</span>
</span></span><span class="line"><span class="ln">447</span><span class="cl">        6<span class="o">)</span>
</span></span><span class="line"><span class="ln">448</span><span class="cl">            create_clusterset_on_leader
</span></span><span class="line"><span class="ln">449</span><span class="cl">            <span class="p">;;</span>
</span></span><span class="line"><span class="ln">450</span><span class="cl">        7<span class="o">)</span>
</span></span><span class="line"><span class="ln">451</span><span class="cl">            create_clusterclaim_on_member
</span></span><span class="line"><span class="ln">452</span><span class="cl">            <span class="p">;;</span>
</span></span><span class="line"><span class="ln">453</span><span class="cl">        8<span class="o">)</span>
</span></span><span class="line"><span class="ln">454</span><span class="cl">            create_multi_cluster_gateway
</span></span><span class="line"><span class="ln">455</span><span class="cl">            <span class="p">;;</span>
</span></span><span class="line"><span class="ln">456</span><span class="cl">        9<span class="o">)</span>
</span></span><span class="line"><span class="ln">457</span><span class="cl">            create_multi_cluster_service
</span></span><span class="line"><span class="ln">458</span><span class="cl">            <span class="p">;;</span>
</span></span><span class="line"><span class="ln">459</span><span class="cl">        10<span class="o">)</span>
</span></span><span class="line"><span class="ln">460</span><span class="cl">            <span class="nb">echo</span> <span class="s2">&#34;Exiting...&#34;</span>
</span></span><span class="line"><span class="ln">461</span><span class="cl">            <span class="nb">exit</span> <span class="m">0</span>
</span></span><span class="line"><span class="ln">462</span><span class="cl">            <span class="p">;;</span>
</span></span><span class="line"><span class="ln">463</span><span class="cl">        *<span class="o">)</span>
</span></span><span class="line"><span class="ln">464</span><span class="cl">            <span class="nb">echo</span> <span class="s2">&#34;Invalid choice. Please choose a valid option.&#34;</span>
</span></span><span class="line"><span class="ln">465</span><span class="cl">            sleep <span class="m">2</span>
</span></span><span class="line"><span class="ln">466</span><span class="cl">            <span class="p">;;</span>
</span></span><span class="line"><span class="ln">467</span><span class="cl">    <span class="k">esac</span>
</span></span><span class="line"><span class="ln">468</span><span class="cl"><span class="k">done</span>
</span></span></code></pre></div><p>Thats it for this post. Thanks for reading.</p>

    </div>




  </article>
<aside class="sidebar">
  <section class="sidebar_inner">
    <br>
    
  
  <div class="search">
    <input type="search" class="search_field form_field" placeholder='Search...' id="find" autocomplete="off" data-scope='post'>
    <label for="find" class="search_label"><svg class="icon">
  <title>search</title>
  <use xlink:href="#search"></use>
</svg>

    </label>
    
    <div class="search_results results"></div>
  </div>

        <h2>Hi there</h2>
      <div class="author_bio">
        This blog is a WIP, sometimes I just throw up some topics for myself to remember to be finished later. Stay tuned...
      </div>
      <a href='https://blog.andreasm.io/about/' class="button mt-1" role="button" title='Read More'>Read More</a>

    
    
    <h2 class="mt-4">Recent Posts</h2>
    <ul class="flex-column">
      <li>
        <a href="https://blog.andreasm.io/2024/02/04/argo-cd-vsphere-with-tanzu/" class="nav-link" title="Argo CD &amp; vSphere with Tanzu">Argo CD &amp; vSphere with Tanzu</a>
      </li>
      <li>
        <a href="https://blog.andreasm.io/2024/01/15/proxmox-with-opentofu-kubespray-and-kubernetes/" class="nav-link" title="Proxmox with OpenTofu Kubespray and Kubernetes">Proxmox with OpenTofu Kubespray and Kubernetes</a>
      </li>
      <li>
        <a href="https://blog.andreasm.io/2023/12/26/traefik-proxy-in-kubernetes/" class="nav-link" title="Traefik Proxy in Kubernetes">Traefik Proxy in Kubernetes</a>
      </li>
      <li>
        <a href="https://blog.andreasm.io/2023/12/18/a-quick-glance-at-cilium-cni/" class="nav-link" title="A Quick Glance at Cilium CNI">A Quick Glance at Cilium CNI</a>
      </li>
      <li>
        <a href="https://blog.andreasm.io/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/" class="nav-link" title="TKGi with NSX and NSX Advanced LoadBalancer">TKGi with NSX and NSX Advanced LoadBalancer</a>
      </li>
      <li>
        <a href="https://blog.andreasm.io/2023/09/25/antrea-multi-cluster-in-tkg-and-vsphere-with-tanzu/" class="nav-link" title="Antrea Multi-cluster - in TKG and vSphere with Tanzu">Antrea Multi-cluster - in TKG and vSphere with Tanzu</a>
      </li>
      <li>
        <a href="https://blog.andreasm.io/2023/09/23/vsphere-with-tanzu-8-u2-using-nsx-and-nsx-advanced-loadbalancer/" class="nav-link" title="vSphere with Tanzu 8 U2 using NSX AND NSX Advanced Loadbalancer">vSphere with Tanzu 8 U2 using NSX AND NSX Advanced Loadbalancer</a>
      </li>
      <li>
        <a href="https://blog.andreasm.io/2023/09/19/vsphere-with-tanzu-and-haproxy/" class="nav-link" title="vSphere with Tanzu and HAproxy">vSphere with Tanzu and HAproxy</a>
      </li>
    </ul>
    <div>
      <h2 class="mt-4 taxonomy" id="categories-section">Categories</h2>
      <nav class="tags_nav">
        <a href='https://blog.andreasm.io/categories/kubernetes/' class="post_tag button button_translucent" title="kubernetes">
          KUBERNETES
          <span class="button_tally">38</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/networking/' class="post_tag button button_translucent" title="networking">
          NETWORKING
          <span class="button_tally">20</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/tanzu/' class="post_tag button button_translucent" title="tanzu">
          TANZU
          <span class="button_tally">12</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/loadbalancing/' class="post_tag button button_translucent" title="loadbalancing">
          LOADBALANCING
          <span class="button_tally">9</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/cni/' class="post_tag button button_translucent" title="cni">
          CNI
          <span class="button_tally">8</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/security/' class="post_tag button button_translucent" title="security">
          SECURITY
          <span class="button_tally">6</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/avi/' class="post_tag button button_translucent" title="avi">
          AVI
          <span class="button_tally">5</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/nsx/' class="post_tag button button_translucent" title="nsx">
          NSX
          <span class="button_tally">4</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/antrea/' class="post_tag button button_translucent" title="antrea">
          ANTREA
          <span class="button_tally">3</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/automation/' class="post_tag button button_translucent" title="automation">
          AUTOMATION
          <span class="button_tally">2</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/blog/' class="post_tag button button_translucent" title="blog">
          BLOG
          <span class="button_tally">2</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/network/' class="post_tag button button_translucent" title="network">
          NETWORK
          <span class="button_tally">2</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/vmware-nsx/' class="post_tag button button_translucent" title="vmware-nsx">
          VMWARE-NSX
          <span class="button_tally">2</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/argocd/' class="post_tag button button_translucent" title="argocd">
          ARGOCD
          <span class="button_tally">1</span>
        </a>
        
        
        <br>
        <div class="post_tags_toggle button">All Categories</div>
        <div class="post_tags">
          <div class="tags_list">
            
            <a href='https://blog.andreasm.io/categories/antrea/' class=" post_tag button button_translucent" data-position=3 title="antrea">ANTREA<span class="button_tally">3</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/argocd/' class=" post_tag button button_translucent" data-position=1 title="argocd">ARGOCD<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/automation/' class=" post_tag button button_translucent" data-position=2 title="automation">AUTOMATION<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/autoscaling/' class=" post_tag button button_translucent" data-position=1 title="autoscaling">AUTOSCALING<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/avi/' class=" post_tag button button_translucent" data-position=5 title="avi">AVI<span class="button_tally">5</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/blog/' class=" post_tag button button_translucent" data-position=2 title="blog">BLOG<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/certificate/' class=" post_tag button button_translucent" data-position=1 title="certificate">CERTIFICATE<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/cni/' class=" post_tag button button_translucent" data-position=8 title="cni">CNI<span class="button_tally">8</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/docker/' class=" post_tag button button_translucent" data-position=1 title="docker">DOCKER<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/ebpf/' class=" post_tag button button_translucent" data-position=1 title="ebpf">EBPF<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/github/' class=" post_tag button button_translucent" data-position=1 title="github">GITHUB<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/gitops/' class=" post_tag button button_translucent" data-position=1 title="gitops">GITOPS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/harbor/' class=" post_tag button button_translucent" data-position=1 title="harbor">HARBOR<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/helm/' class=" post_tag button button_translucent" data-position=1 title="helm">HELM<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/home-automation/' class=" post_tag button button_translucent" data-position=1 title="home-automation">HOME-AUTOMATION<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/hugo/' class=" post_tag button button_translucent" data-position=1 title="hugo">HUGO<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/ingress/' class=" post_tag button button_translucent" data-position=1 title="ingress">INGRESS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/kubernetes/' class=" post_tag button button_translucent" data-position=38 title="kubernetes">KUBERNETES<span class="button_tally">38</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/lcm/' class=" post_tag button button_translucent" data-position=1 title="lcm">LCM<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/lifecycle-management/' class=" post_tag button button_translucent" data-position=1 title="lifecycle-management">LIFECYCLE-MANAGEMENT<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/loadbalancing/' class=" post_tag button button_translucent" data-position=9 title="loadbalancing">LOADBALANCING<span class="button_tally">9</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/management/' class=" post_tag button button_translucent" data-position=1 title="management">MANAGEMENT<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/monitoring/' class=" post_tag button button_translucent" data-position=1 title="monitoring">MONITORING<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/netowkring/' class=" post_tag button button_translucent" data-position=1 title="netowkring">NETOWKRING<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/network/' class=" post_tag button button_translucent" data-position=2 title="network">NETWORK<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/networking/' class=" post_tag button button_translucent" data-position=20 title="networking">NETWORKING<span class="button_tally">20</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/nsx/' class=" post_tag button button_translucent" data-position=4 title="nsx">NSX<span class="button_tally">4</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/nsx-alb/' class=" post_tag button button_translucent" data-position=1 title="nsx-alb">NSX-ALB<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/nsx-t/' class=" post_tag button button_translucent" data-position=1 title="nsx-t">NSX-T<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/pinniped/' class=" post_tag button button_translucent" data-position=1 title="pinniped">PINNIPED<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/rbac/' class=" post_tag button button_translucent" data-position=1 title="rbac">RBAC<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/security/' class=" post_tag button button_translucent" data-position=6 title="security">SECURITY<span class="button_tally">6</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/storage/' class=" post_tag button button_translucent" data-position=1 title="storage">STORAGE<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/tanzu/' class=" post_tag button button_translucent" data-position=12 title="tanzu">TANZU<span class="button_tally">12</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/tanzu-mission-control/' class=" post_tag button button_translucent" data-position=1 title="tanzu-mission-control">TANZU-MISSION-CONTROL<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/tkg/' class=" post_tag button button_translucent" data-position=1 title="tkg">TKG<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/tkgi/' class=" post_tag button button_translucent" data-position=1 title="tkgi">TKGI<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/tmc/' class=" post_tag button button_translucent" data-position=1 title="tmc">TMC<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/troubleshooting/' class=" post_tag button button_translucent" data-position=1 title="troubleshooting">TROUBLESHOOTING<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/virtualization/' class=" post_tag button button_translucent" data-position=1 title="virtualization">VIRTUALIZATION<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/vmare-nsx-intelligence/' class=" post_tag button button_translucent" data-position=1 title="vmare-nsx-intelligence">VMARE-NSX-INTELLIGENCE<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/vmware-cloud/' class=" post_tag button button_translucent" data-position=1 title="vmware-cloud">VMWARE-CLOUD<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/vmware-nsx/' class=" post_tag button button_translucent" data-position=2 title="vmware-nsx">VMWARE-NSX<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/vsphere/' class=" post_tag button button_translucent" data-position=1 title="vsphere">VSPHERE<span class="button_tally">1</span>
            </a>
            
            <div class="tags_sort"><span title="sort alphabetically">[A~Z]</span><span title="sort by count">[0~9]</span>
            </div>
            <span class="tags_hide"><svg class="icon">
            <use xlink:href="#closeme"></use>
          </svg></span>
          </div>
        </div>
      </nav>
    </div>
    <div>
      <h2 class="mt-4 taxonomy" id="tags-section">Tags</h2>
      <nav class="tags_nav">
        <a href='https://blog.andreasm.io/tags/kubernetes/' class="post_tag button button_translucent" title="kubernetes">
          KUBERNETES
          <span class="button_tally">21</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/tanzu/' class="post_tag button button_translucent" title="tanzu">
          TANZU
          <span class="button_tally">14</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/nsx/' class="post_tag button button_translucent" title="nsx">
          NSX
          <span class="button_tally">12</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/antrea/' class="post_tag button button_translucent" title="antrea">
          ANTREA
          <span class="button_tally">11</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/ako/' class="post_tag button button_translucent" title="ako">
          AKO
          <span class="button_tally">8</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/avi/' class="post_tag button button_translucent" title="avi">
          AVI
          <span class="button_tally">6</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/loadbalancing/' class="post_tag button button_translucent" title="loadbalancing">
          LOADBALANCING
          <span class="button_tally">6</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/security/' class="post_tag button button_translucent" title="security">
          SECURITY
          <span class="button_tally">6</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/ingress/' class="post_tag button button_translucent" title="ingress">
          INGRESS
          <span class="button_tally">5</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/availability/' class="post_tag button button_translucent" title="availability">
          AVAILABILITY
          <span class="button_tally">3</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/cert-manager/' class="post_tag button button_translucent" title="cert-manager">
          CERT-MANAGER
          <span class="button_tally">3</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/cni/' class="post_tag button button_translucent" title="cni">
          CNI
          <span class="button_tally">3</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/network/' class="post_tag button button_translucent" title="network">
          NETWORK
          <span class="button_tally">3</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/authentication/' class="post_tag button button_translucent" title="authentication">
          AUTHENTICATION
          <span class="button_tally">2</span>
        </a>
        
        
        <br>
        <div class="post_tags_toggle button">All Tags</div>
        <div class="post_tags">
          <div class="tags_list">
            
            <a href='https://blog.andreasm.io/tags/ako/' class=" post_tag button button_translucent" data-position=8 title="ako">AKO<span class="button_tally">8</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/amko/' class=" post_tag button button_translucent" data-position=1 title="amko">AMKO<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/ansible/' class=" post_tag button button_translucent" data-position=1 title="ansible">ANSIBLE<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/antrea/' class=" post_tag button button_translucent" data-position=11 title="antrea">ANTREA<span class="button_tally">11</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/argocd/' class=" post_tag button button_translucent" data-position=1 title="argocd">ARGOCD<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/authentication/' class=" post_tag button button_translucent" data-position=2 title="authentication">AUTHENTICATION<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/automation/' class=" post_tag button button_translucent" data-position=1 title="automation">AUTOMATION<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/autoscaling/' class=" post_tag button button_translucent" data-position=1 title="autoscaling">AUTOSCALING<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/availability/' class=" post_tag button button_translucent" data-position=3 title="availability">AVAILABILITY<span class="button_tally">3</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/avi/' class=" post_tag button button_translucent" data-position=6 title="avi">AVI<span class="button_tally">6</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/cert-manager/' class=" post_tag button button_translucent" data-position=3 title="cert-manager">CERT-MANAGER<span class="button_tally">3</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/certificate/' class=" post_tag button button_translucent" data-position=1 title="certificate">CERTIFICATE<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/cilium/' class=" post_tag button button_translucent" data-position=1 title="cilium">CILIUM<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/cni/' class=" post_tag button button_translucent" data-position=3 title="cni">CNI<span class="button_tally">3</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/custom-resource-definitions/' class=" post_tag button button_translucent" data-position=1 title="custom-resource-definitions">CUSTOM-RESOURCE-DEFINITIONS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/distributed-firewall/' class=" post_tag button button_translucent" data-position=1 title="distributed-firewall">DISTRIBUTED-FIREWALL<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/dns-service/' class=" post_tag button button_translucent" data-position=1 title="dns-service">DNS-SERVICE<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/docker/' class=" post_tag button button_translucent" data-position=2 title="docker">DOCKER<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/ebpf/' class=" post_tag button button_translucent" data-position=1 title="ebpf">EBPF<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/github/' class=" post_tag button button_translucent" data-position=1 title="github">GITHUB<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/gitops/' class=" post_tag button button_translucent" data-position=1 title="gitops">GITOPS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/gslb/' class=" post_tag button button_translucent" data-position=1 title="gslb">GSLB<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/harbor/' class=" post_tag button button_translucent" data-position=1 title="harbor">HARBOR<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/home-assistant/' class=" post_tag button button_translucent" data-position=1 title="home-assistant">HOME-ASSISTANT<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/hugo/' class=" post_tag button button_translucent" data-position=2 title="hugo">HUGO<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/ids/' class=" post_tag button button_translucent" data-position=1 title="ids">IDS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/informational/' class=" post_tag button button_translucent" data-position=2 title="informational">INFORMATIONAL<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/ingress/' class=" post_tag button button_translucent" data-position=5 title="ingress">INGRESS<span class="button_tally">5</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/ips/' class=" post_tag button button_translucent" data-position=1 title="ips">IPS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/keycloak/' class=" post_tag button button_translucent" data-position=1 title="keycloak">KEYCLOAK<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/kubernetes/' class=" post_tag button button_translucent" data-position=21 title="kubernetes">KUBERNETES<span class="button_tally">21</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/kubernetes-api-endpoint/' class=" post_tag button button_translucent" data-position=1 title="kubernetes-api-endpoint">KUBERNETES-API-ENDPOINT<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/kubespray/' class=" post_tag button button_translucent" data-position=1 title="kubespray">KUBESPRAY<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/lifecycle-management/' class=" post_tag button button_translucent" data-position=1 title="lifecycle-management">LIFECYCLE-MANAGEMENT<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/load-balancing/' class=" post_tag button button_translucent" data-position=1 title="load-balancing">LOAD-BALANCING<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/loadbalancer/' class=" post_tag button button_translucent" data-position=1 title="loadbalancer">LOADBALANCER<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/loadbalancing/' class=" post_tag button button_translucent" data-position=6 title="loadbalancing">LOADBALANCING<span class="button_tally">6</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/lodbalancing/' class=" post_tag button button_translucent" data-position=1 title="lodbalancing">LODBALANCING<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/management/' class=" post_tag button button_translucent" data-position=1 title="management">MANAGEMENT<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/multi-cluster/' class=" post_tag button button_translucent" data-position=1 title="multi-cluster">MULTI-CLUSTER<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/multi-dc/' class=" post_tag button button_translucent" data-position=1 title="multi-dc">MULTI-DC<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/network/' class=" post_tag button button_translucent" data-position=3 title="network">NETWORK<span class="button_tally">3</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/network-policies/' class=" post_tag button button_translucent" data-position=2 title="network-policies">NETWORK-POLICIES<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/networking/' class=" post_tag button button_translucent" data-position=2 title="networking">NETWORKING<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/nfs/' class=" post_tag button button_translucent" data-position=1 title="nfs">NFS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/nsx/' class=" post_tag button button_translucent" data-position=12 title="nsx">NSX<span class="button_tally">12</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/nsx-advanced-loadbalancer/' class=" post_tag button button_translucent" data-position=1 title="nsx-advanced-loadbalancer">NSX-ADVANCED-LOADBALANCER<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/nsx-alb/' class=" post_tag button button_translucent" data-position=1 title="nsx-alb">NSX-ALB<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/nsx-application-platform/' class=" post_tag button button_translucent" data-position=1 title="nsx-application-platform">NSX-APPLICATION-PLATFORM<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/nsx-t/' class=" post_tag button button_translucent" data-position=2 title="nsx-t">NSX-T<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/opentofu/' class=" post_tag button button_translucent" data-position=1 title="opentofu">OPENTOFU<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/persistent-storage/' class=" post_tag button button_translucent" data-position=1 title="persistent-storage">PERSISTENT-STORAGE<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/pinniped/' class=" post_tag button button_translucent" data-position=1 title="pinniped">PINNIPED<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/proxmox/' class=" post_tag button button_translucent" data-position=1 title="proxmox">PROXMOX<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/proxy/' class=" post_tag button button_translucent" data-position=1 title="proxy">PROXY<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/pvc/' class=" post_tag button button_translucent" data-position=1 title="pvc">PVC<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/rbac/' class=" post_tag button button_translucent" data-position=1 title="rbac">RBAC<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/registry/' class=" post_tag button button_translucent" data-position=1 title="registry">REGISTRY<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/security/' class=" post_tag button button_translucent" data-position=6 title="security">SECURITY<span class="button_tally">6</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/static-content-generator/' class=" post_tag button button_translucent" data-position=1 title="static-content-generator">STATIC-CONTENT-GENERATOR<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/static-site-generator/' class=" post_tag button button_translucent" data-position=1 title="static-site-generator">STATIC-SITE-GENERATOR<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/tanzu/' class=" post_tag button button_translucent" data-position=14 title="tanzu">TANZU<span class="button_tally">14</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/tanzu-kubernetes-grid/' class=" post_tag button button_translucent" data-position=1 title="tanzu-kubernetes-grid">TANZU-KUBERNETES-GRID<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/terraform/' class=" post_tag button button_translucent" data-position=1 title="terraform">TERRAFORM<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/tkg/' class=" post_tag button button_translucent" data-position=1 title="tkg">TKG<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/tkg-2.1/' class=" post_tag button button_translucent" data-position=1 title="tkg-2.1">TKG-2.1<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/tkgi/' class=" post_tag button button_translucent" data-position=1 title="tkgi">TKGI<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/tkgs/' class=" post_tag button button_translucent" data-position=1 title="tkgs">TKGS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/tmc/' class=" post_tag button button_translucent" data-position=1 title="tmc">TMC<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/tmc-local/' class=" post_tag button button_translucent" data-position=1 title="tmc-local">TMC-LOCAL<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/tmc-sm/' class=" post_tag button button_translucent" data-position=1 title="tmc-sm">TMC-SM<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/traefik/' class=" post_tag button button_translucent" data-position=1 title="traefik">TRAEFIK<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/troubleshooting/' class=" post_tag button button_translucent" data-position=2 title="troubleshooting">TROUBLESHOOTING<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/unifi/' class=" post_tag button button_translucent" data-position=1 title="unifi">UNIFI<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/vmconaws/' class=" post_tag button button_translucent" data-position=1 title="vmconaws">VMCONAWS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/vsphere/' class=" post_tag button button_translucent" data-position=2 title="vsphere">VSPHERE<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/vsphere-replication/' class=" post_tag button button_translucent" data-position=1 title="vsphere-replication">VSPHERE-REPLICATION<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/vsphere-with-tanzu/' class=" post_tag button button_translucent" data-position=1 title="vsphere-with-tanzu">VSPHERE-WITH-TANZU<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/zwave/' class=" post_tag button button_translucent" data-position=1 title="zwave">ZWAVE<span class="button_tally">1</span>
            </a>
            
            <div class="tags_sort"><span title="sort alphabetically">[A~Z]</span><span title="sort by count">[0~9]</span>
            </div>
            <span class="tags_hide"><svg class="icon">
            <use xlink:href="#closeme"></use>
          </svg></span>
          </div>
        </div>
      </nav>
    </div>
  </section>
</aside>

  
</div>
    </main><svg width="0" height="0" class="hidden">
  <symbol viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" id="facebook">
    <path d="M437 0H75C33.648 0 0 33.648 0 75v362c0 41.352 33.648 75 75 75h151V331h-60v-90h60v-61c0-49.629 40.371-90 90-90h91v90h-91v61h91l-15 90h-76v181h121c41.352 0 75-33.648 75-75V75c0-41.352-33.648-75-75-75zm0 0"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18.001 18.001" id="twitter">
    <path d="M15.891 4.013c.808-.496 1.343-1.173 1.605-2.034a8.68 8.68 0 0 1-2.351.861c-.703-.756-1.593-1.14-2.66-1.14-1.043 0-1.924.366-2.643 1.078a3.56 3.56 0 0 0-1.076 2.605c0 .309.039.585.117.819-3.076-.105-5.622-1.381-7.628-3.837-.34.601-.51 1.213-.51 1.846 0 1.301.549 2.332 1.645 3.089-.625-.053-1.176-.211-1.645-.47 0 .929.273 1.705.82 2.388a3.623 3.623 0 0 0 2.115 1.291c-.312.08-.641.118-.979.118-.312 0-.533-.026-.664-.083.23.757.664 1.371 1.291 1.841a3.652 3.652 0 0 0 2.152.743C4.148 14.173 2.625 14.69.902 14.69c-.422 0-.721-.006-.902-.038 1.697 1.102 3.586 1.649 5.676 1.649 2.139 0 4.029-.542 5.674-1.626 1.645-1.078 2.859-2.408 3.639-3.974a10.77 10.77 0 0 0 1.172-4.892v-.468a7.788 7.788 0 0 0 1.84-1.921 8.142 8.142 0 0 1-2.11.593z"
      ></path>
  </symbol>
  <symbol aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id="mail">
    <path  d="M502.3 190.8c3.9-3.1 9.7-.2 9.7 4.7V400c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V195.6c0-5 5.7-7.8 9.7-4.7 22.4 17.4 52.1 39.5 154.1 113.6 21.1 15.4 56.7 47.8 92.2 47.6 35.7.3 72-32.8 92.3-47.6 102-74.1 131.6-96.3 154-113.7zM256 320c23.2.4 56.6-29.2 73.4-41.4 132.7-96.3 142.8-104.7 173.4-128.7 5.8-4.5 9.2-11.5 9.2-18.9v-19c0-26.5-21.5-48-48-48H48C21.5 64 0 85.5 0 112v19c0 7.4 3.4 14.3 9.2 18.9 30.6 23.9 40.7 32.4 173.4 128.7 16.8 12.2 50.2 41.8 73.4 41.4z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id="calendar">
    <path d="M452 40h-24V0h-40v40H124V0H84v40H60C26.916 40 0 66.916 0 100v352c0 33.084 26.916 60 60 60h392c33.084 0 60-26.916 60-60V100c0-33.084-26.916-60-60-60zm20 412c0 11.028-8.972 20-20 20H60c-11.028 0-20-8.972-20-20V188h432v264zm0-304H40v-48c0-11.028 8.972-20 20-20h24v40h40V80h264v40h40V80h24c11.028 0 20 8.972 20 20v48z"></path>
    <path d="M76 230h40v40H76zm80 0h40v40h-40zm80 0h40v40h-40zm80 0h40v40h-40zm80 0h40v40h-40zM76 310h40v40H76zm80 0h40v40h-40zm80 0h40v40h-40zm80 0h40v40h-40zM76 390h40v40H76zm80 0h40v40h-40zm80 0h40v40h-40zm80 0h40v40h-40zm80-80h40v40h-40z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id="github">
    <path d="M255.968 5.329C114.624 5.329 0 120.401 0 262.353c0 113.536 73.344 209.856 175.104 243.872 12.8 2.368 17.472-5.568 17.472-12.384 0-6.112-.224-22.272-.352-43.712-71.2 15.52-86.24-34.464-86.24-34.464-11.616-29.696-28.416-37.6-28.416-37.6-23.264-15.936 1.728-15.616 1.728-15.616 25.696 1.824 39.2 26.496 39.2 26.496 22.848 39.264 59.936 27.936 74.528 21.344 2.304-16.608 8.928-27.936 16.256-34.368-56.832-6.496-116.608-28.544-116.608-127.008 0-28.064 9.984-51.008 26.368-68.992-2.656-6.496-11.424-32.64 2.496-68 0 0 21.504-6.912 70.4 26.336 20.416-5.696 42.304-8.544 64.096-8.64 21.728.128 43.648 2.944 64.096 8.672 48.864-33.248 70.336-26.336 70.336-26.336 13.952 35.392 5.184 61.504 2.56 68 16.416 17.984 26.304 40.928 26.304 68.992 0 98.72-59.84 120.448-116.864 126.816 9.184 7.936 17.376 23.616 17.376 47.584 0 34.368-.32 62.08-.32 70.496 0 6.88 4.608 14.88 17.6 12.352C438.72 472.145 512 375.857 512 262.353 512 120.401 397.376 5.329 255.968 5.329z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 212 212" id="gitlab">
    <path d="M12.3 74.7h54L43.3 3c-1-3.6-6.4-3.6-7.6 0L12.3 74.8z" />
    <path d="M12.3 74.7L.5 111c-1 3.2 0 6.8 3 8.8l101.6 74-92.5-119z"/>
    <path d="M105 193.7l-38.6-119h-54l92.7 119z"/>
    <path d="M105 193.7l38.7-119H66.4l38.7 119z"/>
    <path d="M105 193.7l38.7-119H198l-93 119z"/>
    <path d="M198 74.7l11.6 36.2c1 3 0 6.6-3 8.6l-101.5 74 93-119z"/>
    <path d="M198 74.7h-54.3L167 3c1.2-3.6 6.4-3.6 7.6 0L198 74.8z"/> 
  </symbol>
  <symbol viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" id="rss">
    <circle cx="3.429" cy="20.571" r="3.429"></circle>
    <path d="M11.429 24h4.57C15.999 15.179 8.821 8.001 0 8v4.572c6.302.001 11.429 5.126 11.429 11.428z"></path>
    <path d="M24 24C24 10.766 13.234 0 0 0v4.571c10.714 0 19.43 8.714 19.43 19.429z"></path>
  </symbol>
  <symbol viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" id="linkedin">
    <path d="M437 0H75C33.648 0 0 33.648 0 75v362c0 41.352 33.648 75 75 75h362c41.352 0 75-33.648 75-75V75c0-41.352-33.648-75-75-75zM181 406h-60V196h60zm0-240h-60v-60h60zm210 240h-60V286c0-16.54-13.46-30-30-30s-30 13.46-30 30v120h-60V196h60v11.309C286.719 202.422 296.93 196 316 196c40.691.043 75 36.547 75 79.688zm0 0"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 612 612" id="to-top">
    <path d="M604.501 440.509L325.398 134.956c-5.331-5.357-12.423-7.627-19.386-7.27-6.989-.357-14.056 1.913-19.387 7.27L7.499 440.509c-9.999 10.024-9.999 26.298 0 36.323s26.223 10.024 36.222 0l262.293-287.164L568.28 476.832c9.999 10.024 26.222 10.024 36.221 0 9.999-10.023 9.999-26.298 0-36.323z"></path>
  </symbol>
  <symbol viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" id="carly">
    <path d="M504.971 239.029L448 182.059V84c0-46.317-37.682-84-84-84h-44c-13.255 0-24 10.745-24 24s10.745 24 24 24h44c19.851 0 36 16.149 36 36v108c0 6.365 2.529 12.47 7.029 16.971L454.059 256l-47.029 47.029A24.002 24.002 0 0 0 400 320v108c0 19.851-16.149 36-36 36h-44c-13.255 0-24 10.745-24 24s10.745 24 24 24h44c46.318 0 84-37.683 84-84v-98.059l56.971-56.971c9.372-9.372 9.372-24.568 0-33.941zM112 192V84c0-19.851 16.149-36 36-36h44c13.255 0 24-10.745 24-24S205.255 0 192 0h-44c-46.318 0-84 37.683-84 84v98.059l-56.971 56.97c-9.373 9.373-9.373 24.568 0 33.941L64 329.941V428c0 46.317 37.682 84 84 84h44c13.255 0 24-10.745 24-24s-10.745-24-24-24h-44c-19.851 0-36-16.149-36-36V320c0-6.365-2.529-12.47-7.029-16.971L57.941 256l47.029-47.029A24.002 24.002 0 0 0 112 192z"></path>
  </symbol>
  <symbol viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" id="copy">
    <path d="M23 2.75A2.75 2.75 0 0 0 20.25 0H8.75A2.75 2.75 0 0 0 6 2.75v13.5A2.75 2.75 0 0 0 8.75 19h11.5A2.75 2.75 0 0 0 23 16.25zM18.25 14.5h-7.5a.75.75 0 0 1 0-1.5h7.5a.75.75 0 0 1 0 1.5zm0-3h-7.5a.75.75 0 0 1 0-1.5h7.5a.75.75 0 0 1 0 1.5zm0-3h-7.5a.75.75 0 0 1 0-1.5h7.5a.75.75 0 0 1 0 1.5z"></path>
    <path d="M8.75 20.5a4.255 4.255 0 0 1-4.25-4.25V2.75c0-.086.02-.166.025-.25H3.75A2.752 2.752 0 0 0 1 5.25v16A2.752 2.752 0 0 0 3.75 24h12a2.752 2.752 0 0 0 2.75-2.75v-.75z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512.001 512.001" id="closeme">
    <path d="M284.286 256.002L506.143 34.144c7.811-7.811 7.811-20.475 0-28.285-7.811-7.81-20.475-7.811-28.285 0L256 227.717 34.143 5.859c-7.811-7.811-20.475-7.811-28.285 0-7.81 7.811-7.811 20.475 0 28.285l221.857 221.857L5.858 477.859c-7.811 7.811-7.811 20.475 0 28.285a19.938 19.938 0 0 0 14.143 5.857 19.94 19.94 0 0 0 14.143-5.857L256 284.287l221.857 221.857c3.905 3.905 9.024 5.857 14.143 5.857s10.237-1.952 14.143-5.857c7.811-7.811 7.811-20.475 0-28.285L284.286 256.002z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id="open-menu">
    <path d="M492 236H20c-11.046 0-20 8.954-20 20s8.954 20 20 20h472c11.046 0 20-8.954 20-20s-8.954-20-20-20zm0-160H20C8.954 76 0 84.954 0 96s8.954 20 20 20h472c11.046 0 20-8.954 20-20s-8.954-20-20-20zm0 320H20c-11.046 0-20 8.954-20 20s8.954 20 20 20h472c11.046 0 20-8.954 20-20s-8.954-20-20-20z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="instagram">
    <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id=youtube>
    <path d="M19.615 3.184c-3.604-.246-11.631-.245-15.23 0-3.897.266-4.356 2.62-4.385 8.816.029 6.185.484 8.549 4.385 8.816 3.6.245 11.626.246 15.23 0 3.897-.266 4.356-2.62 4.385-8.816-.029-6.185-.484-8.549-4.385-8.816zm-10.615 12.816v-8l8 3.993-8 4.007z"/>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="stackoverflow">
    <path d="M21 27v-8h3v11H0V19h3v8h18z"></path><path d="M17.1.2L15 1.8l7.9 10.6 2.1-1.6L17.1.2zm3.7 14.7L10.6 6.4l1.7-2 10.2 8.5-1.7 2zM7.2 12.3l12 5.6 1.1-2.4-12-5.6-1.1 2.4zm-1.8 6.8l13.56 1.96.17-2.38-13.26-2.55-.47 2.97zM19 25H5v-3h14v3z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="xing">
    <path d="M18.188 0c-.517 0-.741.325-.927.66 0 0-7.455 13.224-7.702 13.657.015.024 4.919 9.023 4.919 9.023.17.308.436.66.967.66h3.454c.211 0 .375-.078.463-.22.089-.151.089-.346-.009-.536l-4.879-8.916c-.004-.006-.004-.016 0-.022L22.139.756c.095-.191.097-.387.006-.535C22.056.078 21.894 0 21.686 0h-3.498zM3.648 4.74c-.211 0-.385.074-.473.216-.09.149-.078.339.02.531l2.34 4.05c.004.01.004.016 0 .021L1.86 16.051c-.099.188-.093.381 0 .529.085.142.239.234.45.234h3.461c.518 0 .766-.348.945-.667l3.734-6.609-2.378-4.155c-.172-.315-.434-.659-.962-.659H3.648v.016z"/>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 71 55" id="discord">
    <path d="M60.1045 4.8978C55.5792 2.8214 50.7265 1.2916 45.6527 0.41542C45.5603 0.39851 45.468 0.440769 45.4204 0.525289C44.7963 1.6353 44.105 3.0834 43.6209 4.2216C38.1637 3.4046 32.7345 3.4046 27.3892 4.2216C26.905 3.0581 26.1886 1.6353 25.5617 0.525289C25.5141 0.443589 25.4218 0.40133 25.3294 0.41542C20.2584 1.2888 15.4057 2.8186 10.8776 4.8978C10.8384 4.9147 10.8048 4.9429 10.7825 4.9795C1.57795 18.7309 -0.943561 32.1443 0.293408 45.3914C0.299005 45.4562 0.335386 45.5182 0.385761 45.5576C6.45866 50.0174 12.3413 52.7249 18.1147 54.5195C18.2071 54.5477 18.305 54.5139 18.3638 54.4378C19.7295 52.5728 20.9469 50.6063 21.9907 48.5383C22.0523 48.4172 21.9935 48.2735 21.8676 48.2256C19.9366 47.4931 18.0979 46.6 16.3292 45.5858C16.1893 45.5041 16.1781 45.304 16.3068 45.2082C16.679 44.9293 17.0513 44.6391 17.4067 44.3461C17.471 44.2926 17.5606 44.2813 17.6362 44.3151C29.2558 49.6202 41.8354 49.6202 53.3179 44.3151C53.3935 44.2785 53.4831 44.2898 53.5502 44.3433C53.9057 44.6363 54.2779 44.9293 54.6529 45.2082C54.7816 45.304 54.7732 45.5041 54.6333 45.5858C52.8646 46.6197 51.0259 47.4931 49.0921 48.2228C48.9662 48.2707 48.9102 48.4172 48.9718 48.5383C50.038 50.6034 51.2554 52.5699 52.5959 54.435C52.6519 54.5139 52.7526 54.5477 52.845 54.5195C58.6464 52.7249 64.529 50.0174 70.6019 45.5576C70.6551 45.5182 70.6887 45.459 70.6943 45.3942C72.1747 30.0791 68.2147 16.7757 60.1968 4.9823C60.1772 4.9429 60.1437 4.9147 60.1045 4.8978ZM23.7259 37.3253C20.2276 37.3253 17.3451 34.1136 17.3451 30.1693C17.3451 26.225 20.1717 23.0133 23.7259 23.0133C27.308 23.0133 30.1626 26.2532 30.1066 30.1693C30.1066 34.1136 27.28 37.3253 23.7259 37.3253ZM47.3178 37.3253C43.8196 37.3253 40.9371 34.1136 40.9371 30.1693C40.9371 26.225 43.7636 23.0133 47.3178 23.0133C50.9 23.0133 53.7545 26.2532 53.6986 30.1693C53.6986 34.1136 50.9 37.3253 47.3178 37.3253Z"/>
  </symbol>
</svg>


<footer class="footer">
  <div class="footer_inner wrap pale">
    <img src='https://blog.andreasm.io/icons/apple-touch-icon.png' class="icon icon_2 transparent" alt="From 0.985mhz... to several Ghz">
    <p>Copyright&nbsp;2016-&nbsp;<span class="year"></span>&nbsp;FROM 0.985MHZ... TO SEVERAL GHZ. All Rights Reserved</p><a class="to_top" href="#documentTop">
  <svg class="icon">
  <title>to-top</title>
  <use xlink:href="#to-top"></use>
</svg>

</a>

  </div>
</footer>

<script type="text/javascript" src="https://blog.andreasm.io/en/js/bundle.5548d358738600c857a1f05f0459418da7143d4426c66a08bf3f15ded1b39dd2136bf104a559247a909fc4dcc45b8e06bad0870ece4c71ee5303d30550def8bd.js" integrity="sha512-VUjTWHOGAMhXofBfBFlBjacUPUQmxmoIvz8V3tGzndITa/EEpVkkepCfxNzEW44GutCHDs5Mce5TA9MFUN74vQ==" crossorigin="anonymous"></script>

  <script src="https://blog.andreasm.io/js/search.min.df4d84e4983f0c71dd495e07a09815d920553c3ddf3d0767801c73373573aa17e1b489e4453272dbf4ce2a38a3d01a10b170744e50dd6bec85a598221867ba9a.js"></script>

  </body>
</html>
