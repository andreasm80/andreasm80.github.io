<!DOCTYPE html>
<html lang="en" dir="ltr" class="scroll-smooth" data-default-appearance="dark"
  data-auto-appearance="true"><head>
  <meta charset="utf-8" />
  
  <meta http-equiv="content-language" content="en" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  
  <title>Managing Antrea in vSphere with Tanzu &middot; blog.andreasm.io</title>
  <meta name="title" content="Managing Antrea in vSphere with Tanzu &middot; blog.andreasm.io" />
  
  <meta name="description" content="In this post I will go through how to manage Antrea in a vSphere with Tanzu cluster using the Antrea CRD, and then explore some features and possibilites with Antrea" />
  <meta name="keywords" content="antrea, tanzu, nsx-t, " />
  
  
  <link rel="canonical" href="https://blog.andreasm.io/2023/06/01/managing-antrea-in-vsphere-with-tanzu/" />
  
  
  
  
  
  
  
  
  
  
  
  
  <link type="text/css" rel="stylesheet" href="/css/main.bundle.min.48d290696564c2380c4233780f3fd414aa6e2b0b67ed916e9d918c48c05f5b20b641bf892fadd408e43ec21d2feb2ec1fe6fd1f021df2806a254977fe2f80a64.css"
    integrity="sha512-SNKQaWVkwjgMQjN4Dz/UFKpuKwtn7ZFunZGMSMBfWyC2Qb&#43;JL63UCOQ&#43;wh0v6y7B/m/R8CHfKAaiVJd/4vgKZA==" />
  
  
  <script type="text/javascript" src="/js/appearance.min.a85bd6dc99d1fecae166deb56a1fee6375588c72533c4b8c690e4a9ec5a04174ff780e41e2ac770382a8e67818cb2b89766afa3e23965c9102424a080dafbb0c.js"
    integrity="sha512-qFvW3JnR/srhZt61ah/uY3VYjHJTPEuMaQ5KnsWgQXT/eA5B4qx3A4Ko5ngYyyuJdmr6PiOWXJECQkoIDa&#43;7DA=="></script>
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <script defer type="text/javascript" id="script-bundle" src="/js/main.bundle.min.a2d78d78672e549fbfc972ece871725b5478ba0b65708dda20cb97ab80a865eae6d247e1b05a4aec6ebbf78647ec3233bad8b2609ed98eee53cd58aa17128bc7.js"
    integrity="sha512-oteNeGcuVJ&#43;/yXLs6HFyW1R4ugtlcI3aIMuXq4CoZerm0kfhsFpK7G6794ZH7DIzutiyYJ7Zju5TzViqFxKLxw==" data-copy="" data-copied=""></script>
  
  
  
  <script src="/lib/zoom/zoom.min.37d2094687372da3f7343a221a470f6b8806f7891aa46a5a03966af7f0ebd38b9fe536cb154e6ad28f006d184b294525a7c4054b6bbb4be62d8b453b42db99bd.js" integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S&#43;Yti0U7QtuZvQ=="></script>
  
  
  
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
  <link rel="manifest" href="/site.webmanifest" />
  
  
  
  
  
  
  
  
  <meta property="og:url" content="https://blog.andreasm.io/2023/06/01/managing-antrea-in-vsphere-with-tanzu/">
  <meta property="og:site_name" content="blog.andreasm.io">
  <meta property="og:title" content="Managing Antrea in vSphere with Tanzu">
  <meta property="og:description" content="Manage Antrea in TKG">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2023-06-01T11:14:32+02:00">
    <meta property="article:modified_time" content="2023-06-01T11:14:32+02:00">
    <meta property="article:tag" content="Antrea">
    <meta property="article:tag" content="Tanzu">
    <meta property="article:tag" content="Nsx-T">
    <meta property="og:image" content="https://blog.andreasm.io/2023/06/01/managing-antrea-in-vsphere-with-tanzu/feature-antrea-1.png">

  
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://blog.andreasm.io/2023/06/01/managing-antrea-in-vsphere-with-tanzu/feature-antrea-1.png">
  <meta name="twitter:title" content="Managing Antrea in vSphere with Tanzu">
  <meta name="twitter:description" content="Manage Antrea in TKG">

  
  <script type="application/ld+json">
  [{
    "@context": "https://schema.org",
    "@type": "Article",
    "articleSection": "Posts",
    "name": "Managing Antrea in vSphere with Tanzu",
    "headline": "Managing Antrea in vSphere with Tanzu",
    "description": "Manage Antrea in TKG",
    "abstract": "In this post I will go through how to manage Antrea in a vSphere with Tanzu cluster using the Antrea CRD, and then explore some features and possibilites with Antrea",
    "inLanguage": "en",
    "url" : "https:\/\/blog.andreasm.io\/2023\/06\/01\/managing-antrea-in-vsphere-with-tanzu\/",
    "author" : {
      "@type": "Person",
      "name": "Andreas Marqvardsen"
    },
    "copyrightYear": "2023",
    "dateCreated": "2023-06-01T11:14:32\u002b02:00",
    "datePublished": "2023-06-01T11:14:32\u002b02:00",
    
    "dateModified": "2023-06-01T11:14:32\u002b02:00",
    
    "keywords": ["antrea","tanzu","nsx-t"],
    
    "mainEntityOfPage": "true",
    "wordCount": "11113"
  }]
  </script>


  
  
  <meta name="author" content="Andreas Marqvardsen" />
  
  
  
  <link href="mailto:andreas.marqvardsen[AT]gmail.com" rel="me" />
  
  
  <link href="https://blog.andreasm.io/" rel="me" />
  
  
  <link href="https://github.com/andreasm80" rel="me" />
  
  
  <link href="https://linkedin.com/in/andreas-marqvardsen" rel="me" />
  
  
  <link href="https://vmst.io/@andreasm" rel="me" />
  
  
  <link href="https://x.com/NATsoFast" rel="me" />
  
  
  
  

<script src="/lib/jquery/jquery.slim.min.b0dca576e87d7eaa5850ae4e61759c065786cdb6489d68fcc82240539eebd5da522bdb4fda085ffd245808c8fe2acb2516408eb774ef26b5f6015fc6737c0ea8.js" integrity="sha512-sNylduh9fqpYUK5OYXWcBleGzbZInWj8yCJAU57r1dpSK9tP2ghf/SRYCMj&#43;KsslFkCOt3TvJrX2AV/Gc3wOqA=="></script>






















  
  

<script async src="https://www.googletagmanager.com/gtag/js?id=G-TVPYDVE8KR"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-TVPYDVE8KR');
</script>



  
  
  <meta name="theme-color"/>
  
  
</head>
<body
  class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32 scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600">
  <div id="the-top" class="absolute flex self-center">
    <a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600"
      href="#main-content"><span
        class="font-bold text-primary-600 ltr:pr-2 rtl:pl-2 dark:text-primary-400">&darr;</span>Skip to main content</a>
  </div>
  
  
  <div class="min-h-[148px]"></div>
<div class="fixed inset-x-0 pl-[24px] pr-[24px]" style="z-index:100">
  <div id="menu-blur" class="absolute opacity-0 inset-x-0 top-0 h-full single_hero_background nozoom backdrop-blur-2xl shadow-2xl"></div>
  <div class="relative max-w-[64rem] ml-auto mr-auto">
    <div style="padding-left:0;padding-right:0;padding-top:2px;padding-bottom:3px"
    class="main-menu flex items-center justify-between px-4 py-6 sm:px-6 md:justify-start space-x-3">
    
    
    
    <div>
        <a href="/" class="flex">
            <span class="sr-only">blog.andreasm.io</span>

            
            <img src="/ynwa2.png" width="300" height="342"
                class="logo max-h-[5rem] max-w-[5rem] object-scale-down object-left nozoom" alt="blog.andreasm.io" />
            

        </a>
    </div>
    
    <div class="flex flex-1 items-center justify-between">
        <nav class="flex space-x-3">

            
            <a href="/" class="text-base font-medium text-gray-500 hover:text-gray-900">blog.andreasm.io</a>
            

        </nav>
        <nav class="hidden md:flex items-center space-x-5 md:ml-12 h-12">

            
            
            
  <a href="/posts/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
    
    <p class="text-base font-medium" title="">
        Posts
    </p>
</a>



            
            
  <a href="/about/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
    
    <p class="text-base font-medium" title="">
        About
    </p>
</a>



            
            
  <a href="/categories/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
    
    <p class="text-base font-medium" title="">
        Categories
    </p>
</a>



            
            
  <a href="/tags/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
    
    <p class="text-base font-medium" title="">
        Tags
    </p>
</a>



            
            

            


            
            <button id="search-button" aria-label="Search" class="text-base hover:text-primary-600 dark:hover:text-primary-400"
                title="">
                

  <span class="relative block icon">
    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>

  </span>


            </button>
            


            
            
            <div
                class="ltr:mr-14 rtl:ml-14 flex items-center">
                <button id="appearance-switcher" aria-label="Dark mode switcher" type="button" class="text-base hover:text-primary-600 dark:hover:text-primary-400">
                    <div class="flex items-center justify-center dark:hidden">
                        

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M32 256c0-123.8 100.3-224 223.8-224c11.36 0 29.7 1.668 40.9 3.746c9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3c9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480C132.1 480 32 379.6 32 256z"/></svg>

  </span>


                    </div>
                    <div class="items-center justify-center hidden dark:flex">
                        

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02 0-95.1 42.98-95.1 95.1S202.1 351.1 256 351.1s95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347L446.1 255.1l63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7l-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89L164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6L12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256l-63.15 91.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7l19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109l109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69 0-127.1-57.31-127.1-127.1c0-70.69 57.31-127.1 127.1-127.1s127.1 57.3 127.1 127.1C383.1 326.7 326.7 383.1 256 383.1z"/></svg>

  </span>


                    </div>
                </button>
            </div>
            

        </nav>
        <div class="flex md:hidden items-center space-x-5 md:ml-12 h-12">

            <span></span>

            


            
            <button id="search-button-mobile" aria-label="Search" class="text-base hover:text-primary-600 dark:hover:text-primary-400"
                title="">
                

  <span class="relative block icon">
    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>

  </span>


            </button>
            

            
            
            <button id="appearance-switcher-mobile" aria-label="Dark mode switcher" type="button" class="text-base hover:text-primary-600 dark:hover:text-primary-400" style="margin-right:5px">
                <div class="flex items-center justify-center dark:hidden">
                    

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M32 256c0-123.8 100.3-224 223.8-224c11.36 0 29.7 1.668 40.9 3.746c9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3c9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480C132.1 480 32 379.6 32 256z"/></svg>

  </span>


                </div>
                <div class="items-center justify-center hidden dark:flex">
                    

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02 0-95.1 42.98-95.1 95.1S202.1 351.1 256 351.1s95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347L446.1 255.1l63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7l-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89L164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6L12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256l-63.15 91.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7l19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109l109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69 0-127.1-57.31-127.1-127.1c0-70.69 57.31-127.1 127.1-127.1s127.1 57.3 127.1 127.1C383.1 326.7 326.7 383.1 256 383.1z"/></svg>

  </span>


                </div>
            </button>
            

        </div>
    </div>
    <div class="-my-2 -mr-2 md:hidden">

        <label id="menu-button" class="block">
            
            <div class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400">
                

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M0 96C0 78.33 14.33 64 32 64H416C433.7 64 448 78.33 448 96C448 113.7 433.7 128 416 128H32C14.33 128 0 113.7 0 96zM0 256C0 238.3 14.33 224 32 224H416C433.7 224 448 238.3 448 256C448 273.7 433.7 288 416 288H32C14.33 288 0 273.7 0 256zM416 448H32C14.33 448 0 433.7 0 416C0 398.3 14.33 384 32 384H416C433.7 384 448 398.3 448 416C448 433.7 433.7 448 416 448z"/></svg>

  </span>


            </div>
            <div id="menu-wrapper" style="padding-top:5px;"
                class="fixed inset-0 z-30 invisible w-screen h-screen m-0 overflow-auto transition-opacity opacity-0 cursor-default bg-neutral-100/50 backdrop-blur-sm dark:bg-neutral-900/50">
                <ul
                    class="flex space-y-2 mt-3 flex-col items-end w-full px-6 py-6 mx-auto overflow-visible list-none ltr:text-right rtl:text-left max-w-7xl">

                    <li id="menu-close-button">
                        <span
                            class="cursor-pointer inline-block align-text-bottom hover:text-primary-600 dark:hover:text-primary-400">

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75 0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3L54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75 0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75 0-45.25s32.75-12.5 45.25 0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25 0s12.5 32.75 0 45.25l-105.4 105.4L310.6 361.4z"/></svg>

  </span>

</span>
                    </li>

                    

                    
  <li class="mt-1">
    <a href="/posts/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
        
        <p class="text-bg font-bg" title="">
            Posts
        </p>
    </a>
</li>




                    

                    
  <li class="mt-1">
    <a href="/about/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
        
        <p class="text-bg font-bg" title="">
            About
        </p>
    </a>
</li>




                    

                    
  <li class="mt-1">
    <a href="/categories/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
        
        <p class="text-bg font-bg" title="">
            Categories
        </p>
    </a>
</li>




                    

                    
  <li class="mt-1">
    <a href="/tags/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
        
        <p class="text-bg font-bg" title="">
            Tags
        </p>
    </a>
</li>




                    

                </ul>
                
                

            </div>
        </label>
    </div>
</div>




<script>
    (function () {
        var $mainmenu = $('.main-menu');
        var path = window.location.pathname;
        $mainmenu.find('a[href="' + path + '"]').each(function (i, e) {
            $(e).children('p').addClass('active');
        });
    })();
</script>


  </div>
</div>
<script>
  window.addEventListener('scroll', function (e) {
    var scroll = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop || 0;
    var background_blur = document.getElementById('menu-blur');
    background_blur.style.opacity = (scroll / 300);
  });
</script>

  
  <div class="relative flex flex-col grow">
    <main id="main-content" class="grow">
      


<article>
  
  
  
  
  
  


<div id="hero" class="h-[150px] md:h-[200px]"></div>



    
    <div class="fixed inset-x-0 top-0 h-[800px] single_hero_background nozoom"
    style="background-image:url(/2023/06/01/managing-antrea-in-vsphere-with-tanzu/feature-antrea-1.png);">
    


    <div class="absolute inset-0 bg-gradient-to-t from-neutral dark:from-neutral-800 to-transparent mix-blend-normal">
    </div>
    <div
        class="absolute inset-0 opacity-60 bg-gradient-to-t from-neutral dark:from-neutral-800 to-neutral-100 dark:to-neutral-800 mix-blend-normal">
    </div>
</div>

<div id="background-blur" class="fixed opacity-0 inset-x-0 top-0 h-full single_hero_background nozoom backdrop-blur-2xl"></div>
<script>
    window.addEventListener('scroll', function (e) {
        var scroll = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop || 0;
        var background_blur = document.getElementById('background-blur');
        background_blur.style.opacity = (scroll / 300)
    });
</script>

  
  

  <header id="single_header" class="mt-5 max-w-prose">
    
    <ol class="text-sm text-neutral-500 dark:text-neutral-400 print:hidden">
  
  
    
  
    
  
  <li class="inline hidden">
    <a
      class="hover:underline decoration-neutral-300 dark:underline-neutral-600"
      href="/"
      >blog.andreasm.io</a
    ><span class="px-1 text-primary-500">/</span>
  </li>

  
  <li class="inline ">
    <a
      class="hover:underline decoration-neutral-300 dark:underline-neutral-600"
      href="/posts/"
      >Posts</a
    ><span class="px-1 text-primary-500">/</span>
  </li>

  
  <li class="inline hidden">
    <a
      class="hover:underline decoration-neutral-300 dark:underline-neutral-600"
      href="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/"
      >Managing Antrea in vSphere with Tanzu</a
    ><span class="px-1 text-primary-500">/</span>
  </li>

</ol>


    
    <h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">
      Managing Antrea in vSphere with Tanzu
    </h1>
    <div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden">
      





  
  







  





  



  













<div class="flex flex-row flex-wrap items-center">
  
  
  <time datetime="2023-06-01T11:14:32&#43;02:00">1 June 2023</time><span class="px-2 text-primary-500">&middot;</span><span>11113 words</span><span class="px-2 text-primary-500">&middot;</span><span title="Reading time">53 mins</span>
  

  
  
</div>


<div class="flex flex-row flex-wrap items-center">
  
  
  
  
  
  
  
  
  
  
  
</div>




<div class="flex flex-row flex-wrap items-center">
  
  
  
  
  
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/kubernetes/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Kubernetes
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/cni/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    CNI
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/tanzu/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Tanzu
  </span>
</span>
  </span>
  
  
  
  
  
  
  
  
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/antrea/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Antrea
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/tanzu/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Tanzu
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/nsx-t/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Nsx-T
  </span>
</span>
  </span>
  
  
  
  
</div>




    </div>

    
    
    
    
    

    

    
      
      
        
        
<div class="flex author">
  
    
    
      
    
    
      
      <img class="!mt-0 !mb-0 h-24 w-24 rounded-full ltr:mr-4 rtl:ml-4" width="96" height="96"
      alt="Andreas Marqvardsen" src="/profile.png" />
    
  
  <div class="place-self-center">
    
    <div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">
      Author
    </div>
    <div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">
      Andreas Marqvardsen
    </div>
    
    
    <div class="text-sm text-neutral-700 dark:text-neutral-400">Always curious, always learning</div>
    
    <div class="text-2xl sm:text-lg">
  <div class="flex flex-wrap text-neutral-400 dark:text-neutral-500">
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="mailto:andreas.marqvardsen[AT]gmail.com"
          target="_blank"
          aria-label="Email"
          rel="me noopener noreferrer"
          ><span class="inline-block align-text-bottom">

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M207.8 20.73c-93.45 18.32-168.7 93.66-187 187.1c-27.64 140.9 68.65 266.2 199.1 285.1c19.01 2.888 36.17-12.26 36.17-31.49l.0001-.6631c0-15.74-11.44-28.88-26.84-31.24c-84.35-12.98-149.2-86.13-149.2-174.2c0-102.9 88.61-185.5 193.4-175.4c91.54 8.869 158.6 91.25 158.6 183.2l0 16.16c0 22.09-17.94 40.05-40 40.05s-40.01-17.96-40.01-40.05v-120.1c0-8.847-7.161-16.02-16.01-16.02l-31.98 .0036c-7.299 0-13.2 4.992-15.12 11.68c-24.85-12.15-54.24-16.38-86.06-5.106c-38.75 13.73-68.12 48.91-73.72 89.64c-9.483 69.01 43.81 128 110.9 128c26.44 0 50.43-9.544 69.59-24.88c24 31.3 65.23 48.69 109.4 37.49C465.2 369.3 496 324.1 495.1 277.2V256.3C495.1 107.1 361.2-9.332 207.8 20.73zM239.1 304.3c-26.47 0-48-21.56-48-48.05s21.53-48.05 48-48.05s48 21.56 48 48.05S266.5 304.3 239.1 304.3z"/></svg>

  </span>

</span></a
        >
      
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="https://blog.andreasm.io/"
          target="_blank"
          aria-label="Link"
          rel="me noopener noreferrer"
          ><span class="inline-block align-text-bottom">

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><path fill="currentColor" d="M172.5 131.1C228.1 75.51 320.5 75.51 376.1 131.1C426.1 181.1 433.5 260.8 392.4 318.3L391.3 319.9C381 334.2 361 337.6 346.7 327.3C332.3 317 328.9 297 339.2 282.7L340.3 281.1C363.2 249 359.6 205.1 331.7 177.2C300.3 145.8 249.2 145.8 217.7 177.2L105.5 289.5C73.99 320.1 73.99 372 105.5 403.5C133.3 431.4 177.3 435 209.3 412.1L210.9 410.1C225.3 400.7 245.3 404 255.5 418.4C265.8 432.8 262.5 452.8 248.1 463.1L246.5 464.2C188.1 505.3 110.2 498.7 60.21 448.8C3.741 392.3 3.741 300.7 60.21 244.3L172.5 131.1zM467.5 380C411 436.5 319.5 436.5 263 380C213 330 206.5 251.2 247.6 193.7L248.7 192.1C258.1 177.8 278.1 174.4 293.3 184.7C307.7 194.1 311.1 214.1 300.8 229.3L299.7 230.9C276.8 262.1 280.4 306.9 308.3 334.8C339.7 366.2 390.8 366.2 422.3 334.8L534.5 222.5C566 191 566 139.1 534.5 108.5C506.7 80.63 462.7 76.99 430.7 99.9L429.1 101C414.7 111.3 394.7 107.1 384.5 93.58C374.2 79.2 377.5 59.21 391.9 48.94L393.5 47.82C451 6.731 529.8 13.25 579.8 63.24C636.3 119.7 636.3 211.3 579.8 267.7L467.5 380z"/></svg>

  </span>

</span></a
        >
      
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="https://github.com/andreasm80"
          target="_blank"
          aria-label="Github"
          rel="me noopener noreferrer"
          ><span class="inline-block align-text-bottom">

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>

  </span>

</span></a
        >
      
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="https://linkedin.com/in/andreas-marqvardsen"
          target="_blank"
          aria-label="Linkedin"
          rel="me noopener noreferrer"
          ><span class="inline-block align-text-bottom">

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg>

  </span>

</span></a
        >
      
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="https://vmst.io/@andreasm"
          target="_blank"
          aria-label="Mastodon"
          rel="me noopener noreferrer"
          ><span class="inline-block align-text-bottom">

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48 0 0 0-63.72 28.5-63.72 125.7 0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54 0 0 1-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"/></svg>

  </span>

</span></a
        >
      
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="https://x.com/NATsoFast"
          target="_blank"
          aria-label="X-Twitter"
          rel="me noopener noreferrer"
          ><span class="inline-block align-text-bottom">

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8L200.7 275.5 26.8 48H172.4L272.9 180.9 389.2 48zM364.4 421.8h39.1L151.1 88h-42L364.4 421.8z"/></svg>
  </span>

</span></a
        >
      
    
  </div>

</div>
  </div>
</div>

      

      

      
      <div class="mb-5"></div>
      

    

  </header>
  
  <section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row">
    
     <div
      class="order-first lg:ml-auto px-0 lg:order-last ltr:lg:pl-8 rtl:lg:pr-8">
      <div class="toc ltr:pl-5 rtl:pr-5 print:hidden lg:sticky lg:top-[140px]">

         <details open id="TOCView"
  class="toc-right mt-0 overflow-y-scroll overscroll-contain scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600 rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 hidden lg:block">
  <summary
    class="block py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">
    Table of Contents
  </summary>
  <div
    class="min-w-[220px] py-2 border-dotted ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#managing-antrea-settings-and-feature-gates-in-tkg-2-clusters">Managing Antrea settings and Feature Gates in TKG 2 clusters</a>
      <ul>
        <li><a href="#getting-the-antrea-config-templates-for-a-specific-tkr-version">Getting the Antrea config &ldquo;templates&rdquo; for a specific TKR version</a></li>
      </ul>
    </li>
    <li><a href="#integrating-antrea-with-nsx-t">Integrating Antrea with NSX-T</a></li>
    <li><a href="#antrea-security-policies">Antrea Security Policies</a>
      <ul>
        <li><a href="#tiered-policies">Tiered policies</a></li>
        <li><a href="#antrea-rbac">Antrea RBAC</a></li>
      </ul>
    </li>
    <li><a href="#how-to-manage-the-antrea-native-policies">How to manage the Antrea Native Policies</a>
      <ul>
        <li><a href="#antrea-security-policies-from-the-nsx-manager">Antrea Security policies from the NSX manager</a></li>
        <li><a href="#antrea-cluster-network-policies---applied-from-the-nsx-manager">Antrea Cluster Network Policies - Applied from the NSX manager</a></li>
        <li><a href="#nsx-distributed-firewall---kubernetes-objects-policies">NSX Distributed Firewall - Kubernetes objects Policies</a></li>
        <li><a href="#antrea-security-policies-from-kubernetes-api">Antrea Security policies from kubernetes api</a></li>
      </ul>
    </li>
    <li><a href="#antrea-dashboard">Antrea Dashboard</a></li>
    <li><a href="#antrea-network-monitoring">Antrea Network Monitoring</a>
      <ul>
        <li><a href="#flow-exporter---ipfix">Flow-Exporter - IPFIX</a></li>
        <li><a href="#traceflow">Traceflow</a></li>
        <li><a href="#theia">Theia</a></li>
        <li><a href="#network-policy-recommendation">Network Policy Recommendation</a></li>
        <li><a href="#throughput-anomaly-detection">Throughput Anomaly Detection</a></li>
      </ul>
    </li>
    <li><a href="#antrea-egress">Antrea Egress</a></li>
  </ul>
</nav>
  </div>
</details>
<details class="toc-inside mt-0 overflow-hidden rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 lg:hidden">
  <summary
    class="py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">
    Table of Contents
  </summary>
  <div
    class="py-2 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#managing-antrea-settings-and-feature-gates-in-tkg-2-clusters">Managing Antrea settings and Feature Gates in TKG 2 clusters</a>
      <ul>
        <li><a href="#getting-the-antrea-config-templates-for-a-specific-tkr-version">Getting the Antrea config &ldquo;templates&rdquo; for a specific TKR version</a></li>
      </ul>
    </li>
    <li><a href="#integrating-antrea-with-nsx-t">Integrating Antrea with NSX-T</a></li>
    <li><a href="#antrea-security-policies">Antrea Security Policies</a>
      <ul>
        <li><a href="#tiered-policies">Tiered policies</a></li>
        <li><a href="#antrea-rbac">Antrea RBAC</a></li>
      </ul>
    </li>
    <li><a href="#how-to-manage-the-antrea-native-policies">How to manage the Antrea Native Policies</a>
      <ul>
        <li><a href="#antrea-security-policies-from-the-nsx-manager">Antrea Security policies from the NSX manager</a></li>
        <li><a href="#antrea-cluster-network-policies---applied-from-the-nsx-manager">Antrea Cluster Network Policies - Applied from the NSX manager</a></li>
        <li><a href="#nsx-distributed-firewall---kubernetes-objects-policies">NSX Distributed Firewall - Kubernetes objects Policies</a></li>
        <li><a href="#antrea-security-policies-from-kubernetes-api">Antrea Security policies from kubernetes api</a></li>
      </ul>
    </li>
    <li><a href="#antrea-dashboard">Antrea Dashboard</a></li>
    <li><a href="#antrea-network-monitoring">Antrea Network Monitoring</a>
      <ul>
        <li><a href="#flow-exporter---ipfix">Flow-Exporter - IPFIX</a></li>
        <li><a href="#traceflow">Traceflow</a></li>
        <li><a href="#theia">Theia</a></li>
        <li><a href="#network-policy-recommendation">Network Policy Recommendation</a></li>
        <li><a href="#throughput-anomaly-detection">Throughput Anomaly Detection</a></li>
      </ul>
    </li>
    <li><a href="#antrea-egress">Antrea Egress</a></li>
  </ul>
</nav>
  </div>
</details>

<script>

  var margin = 200;
  var marginError = 50;

  (function () {
    var $window = $(window);
    var $toc = $('#TOCView');
    var tocHeight = $toc.height();

    function onResize() {
      var windowAndMarginHeight = $window.height() - margin;
      if(tocHeight >= windowAndMarginHeight) {
        $toc.css("overflow-y", "scroll")
        $toc.css("max-height", (windowAndMarginHeight + marginError) + "px")
      } else {
        $toc.css("overflow-y", "hidden")
        $toc.css("max-height", "9999999px")
      }
    }

    $window.on('resize', onResize);
    $(document).ready(onResize);
  })();



  (function () {
    var $toc = $('#TableOfContents');
    if ($toc.length > 0) {
      var $window = $(window);

      function onScroll() {
        var currentScroll = $window.scrollTop();
        var h = $('.anchor');
        var id = "";
        h.each(function (i, e) {
          e = $(e);
          if (e.offset().top - $(window).height()/3 <= currentScroll) {
            id = decodeURIComponent(e.attr('id'));
          }
        });
        var active = $toc.find('a.active');      
        if (active.length == 1 && active.eq(0).attr('href') == '#' + id) return true;

        active.each(function (i, e) {
          
            $(e).removeClass('active');
          
        });
        $toc.find('a[href="#' + id + '"]').addClass('active')
        $toc.find('a[href="#' + id + '"]').parentsUntil('#TableOfContents').each(function (i, e) {
          $(e).children('a').parents('ul').show();          
        });
      }

      $window.on('scroll', onScroll);
      $(document).ready(function () {
        
        onScroll();
      });
    }
  })();


</script>
   </div>
      </div>
      

      <div class="min-w-0 min-h-0 max-w-fit">
        
        


        <div class="article-content max-w-prose mb-20">
          

<h1 class="relative group">Antrea in vSphere with Tanzu 
    <div id="antrea-in-vsphere-with-tanzu" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#antrea-in-vsphere-with-tanzu" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<p>Antrea is the default CNI being used in TKG 2.0 clusters. TKG 2.0 clusters are the workload clusters you deploy with the Supervisor deployed in vSphere 8. Antrea comes in to flavours, we have the open source edition of Antrea which can be found <a href="https://github.com/antrea-io/antrea" target="_blank">here</a> and then we have the Antrea Advanced (&ldquo;downstream&rdquo;) version which is being used in vSphere with Tanzu. This version is also needed when we want to integrate Antrea with NSX-T for policy management. The Antrea Advanced can be found in your VMware customer connect portal <a href="https://customerconnect.vmware.com/downloads/info/slug/networking_security/vmware_antrea/1_x" target="_blank">here</a>. Both version of Antrea has a very broad support Kubernetes platforms it can be used in. Antrea can be used for Windows worker nodes, Photon, Ubuntu, ARM, x86, VMware TKG, OpenShift, Rancher, AKS, EKS. the list is long see more info <a href="https://antrea.io/" target="_blank">here</a>. This post will be focusing on the Antrea Advanced edition and its features like (read more <a href="https://antrea.io/docs/v1.12.0/docs/feature-gates/" target="_blank">here</a>):</p>
<ul>
<li>Central management of Antrea Security Policies with NSX</li>
<li>Central troubleshooting with TraceFlow with NSX</li>
<li>FQDN/L7 Security policies</li>
<li>RBAC</li>
<li>Tiered policies</li>
<li>Flow Exporter</li>
<li>Egress (Source NAT IP selection of PODs egressing)</li>
</ul>


<h2 class="relative group">Managing Antrea settings and Feature Gates in TKG 2 clusters 
    <div id="managing-antrea-settings-and-feature-gates-in-tkg-2-clusters" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#managing-antrea-settings-and-feature-gates-in-tkg-2-clusters" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>When you deploy a TKG 2 cluster on vSphere with Tanzu and you dont specify a CNI Antrea will be de default CNI. Depending on the TKG version you are on a set of default Antrea features are enabled or disabled. You can easily check which features are enabled after a cluster has been provisioned by issuing the below command:
If you know already before you deploy a cluster that a specific feature should be enabled or disabled this can also be handled during bring-up of the cluster so it should come with the settings you want. More on that later.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">linux-vm:~/from_ubuntu_vm/tkgs/tkgs-stc-cpod$ k get configmaps -n kube-system antrea-config -oyaml
</span></span><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">data:
</span></span><span class="line"><span class="cl">  antrea-agent.conf: <span class="p">|</span>
</span></span><span class="line"><span class="cl">    featureGates:
</span></span><span class="line"><span class="cl">      AntreaProxy: <span class="nb">true</span>
</span></span><span class="line"><span class="cl">      EndpointSlice: <span class="nb">true</span>
</span></span><span class="line"><span class="cl">      Traceflow: <span class="nb">true</span>
</span></span><span class="line"><span class="cl">      NodePortLocal: <span class="nb">true</span>
</span></span><span class="line"><span class="cl">      AntreaPolicy: <span class="nb">true</span>
</span></span><span class="line"><span class="cl">      FlowExporter: <span class="nb">false</span>
</span></span><span class="line"><span class="cl">      NetworkPolicyStats: <span class="nb">false</span>
</span></span><span class="line"><span class="cl">      Egress: <span class="nb">true</span>
</span></span><span class="line"><span class="cl">      AntreaIPAM: <span class="nb">false</span>
</span></span><span class="line"><span class="cl">      Multicast: <span class="nb">false</span>
</span></span><span class="line"><span class="cl">      Multicluster: <span class="nb">false</span>
</span></span><span class="line"><span class="cl">      SecondaryNetwork: <span class="nb">false</span>
</span></span><span class="line"><span class="cl">      ServiceExternalIP: <span class="nb">false</span>
</span></span><span class="line"><span class="cl">      TrafficControl: <span class="nb">false</span>
</span></span><span class="line"><span class="cl">    trafficEncapMode: encap
</span></span><span class="line"><span class="cl">    noSNAT: <span class="nb">false</span>
</span></span><span class="line"><span class="cl">    tunnelType: geneve
</span></span><span class="line"><span class="cl">    trafficEncryptionMode: none
</span></span><span class="line"><span class="cl">    enableBridgingMode: <span class="nb">false</span>
</span></span><span class="line"><span class="cl">    disableTXChecksumOffload: <span class="nb">false</span>
</span></span><span class="line"><span class="cl">    wireGuard:
</span></span><span class="line"><span class="cl">      port: <span class="m">51820</span>
</span></span><span class="line"><span class="cl">    egress:
</span></span><span class="line"><span class="cl">      exceptCIDRs: <span class="o">[]</span>
</span></span><span class="line"><span class="cl">    serviceCIDR: 20.10.0.0/16
</span></span><span class="line"><span class="cl">    nodePortLocal:
</span></span><span class="line"><span class="cl">      enable: <span class="nb">true</span>
</span></span><span class="line"><span class="cl">      portRange: 61000-62000
</span></span><span class="line"><span class="cl">    tlsCipherSuites: TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,TLS_RSA_WITH_AES_256_GCM_SHA384
</span></span><span class="line"><span class="cl">    multicast: <span class="o">{}</span>
</span></span><span class="line"><span class="cl">    antreaProxy:
</span></span><span class="line"><span class="cl">      proxyAll: <span class="nb">false</span>
</span></span><span class="line"><span class="cl">      nodePortAddresses: <span class="o">[]</span>
</span></span><span class="line"><span class="cl">      skipServices: <span class="o">[]</span>
</span></span><span class="line"><span class="cl">      proxyLoadBalancerIPs: <span class="nb">false</span>
</span></span><span class="line"><span class="cl">    multicluster: <span class="o">{}</span>
</span></span><span class="line"><span class="cl">  antrea-cni.conflist: <span class="p">|</span>
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;cniVersion&#34;</span>:<span class="s2">&#34;0.3.0&#34;</span>,
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;name&#34;</span>: <span class="s2">&#34;antrea&#34;</span>,
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;plugins&#34;</span>: <span class="o">[</span>
</span></span><span class="line"><span class="cl">            <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;type&#34;</span>: <span class="s2">&#34;antrea&#34;</span>,
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;ipam&#34;</span>: <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="s2">&#34;type&#34;</span>: <span class="s2">&#34;host-local&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            ,
</span></span><span class="line"><span class="cl">            <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;type&#34;</span>: <span class="s2">&#34;portmap&#34;</span>,
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;capabilities&#34;</span>: <span class="o">{</span><span class="s2">&#34;portMappings&#34;</span>: true<span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            ,
</span></span><span class="line"><span class="cl">            <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;type&#34;</span>: <span class="s2">&#34;bandwidth&#34;</span>,
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;capabilities&#34;</span>: <span class="o">{</span><span class="s2">&#34;bandwidth&#34;</span>: true<span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">]</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">  antrea-controller.conf: <span class="p">|</span>
</span></span><span class="line"><span class="cl">    featureGates:
</span></span><span class="line"><span class="cl">      Traceflow: <span class="nb">true</span>
</span></span><span class="line"><span class="cl">      AntreaPolicy: <span class="nb">true</span>
</span></span><span class="line"><span class="cl">      NetworkPolicyStats: <span class="nb">false</span>
</span></span><span class="line"><span class="cl">      Multicast: <span class="nb">false</span>
</span></span><span class="line"><span class="cl">      Egress: <span class="nb">true</span>
</span></span><span class="line"><span class="cl">      AntreaIPAM: <span class="nb">false</span>
</span></span><span class="line"><span class="cl">      ServiceExternalIP: <span class="nb">false</span>
</span></span><span class="line"><span class="cl">    tlsCipherSuites: TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,TLS_RSA_WITH_AES_256_GCM_SHA384
</span></span><span class="line"><span class="cl">    nodeIPAM: null
</span></span><span class="line"><span class="cl">kind: ConfigMap
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  annotations:
</span></span><span class="line"><span class="cl">    kapp.k14s.io/identity: v1<span class="p">;</span>kube-system//ConfigMap/antrea-config<span class="p">;</span>v1
</span></span><span class="line"><span class="cl">    kapp.k14s.io/original: <span class="s1">&#39;{&#34;apiVersion&#34;:&#34;v1&#34;,&#34;data&#34;:{&#34;antrea-agent.conf&#34;:&#34;featureGates:\n  AntreaProxy:
</span></span></span><span class="line"><span class="cl"><span class="s1">      true\n  EndpointSlice: true\n  Traceflow: true\n  NodePortLocal: true\n  AntreaPolicy:
</span></span></span><span class="line"><span class="cl"><span class="s1">      true\n  FlowExporter: false\n  NetworkPolicyStats: false\n  Egress: true\n  AntreaIPAM:
</span></span></span><span class="line"><span class="cl"><span class="s1">      false\n  Multicast: false\n  Multicluster: false\n  SecondaryNetwork: false\n  ServiceExternalIP:
</span></span></span><span class="line"><span class="cl"><span class="s1">      false\n  TrafficControl: false\ntrafficEncapMode: encap\nnoSNAT: false\ntunnelType:
</span></span></span><span class="line"><span class="cl"><span class="s1">      geneve\ntrafficEncryptionMode: none\nenableBridgingMode: false\ndisableTXChecksumOffload:
</span></span></span><span class="line"><span class="cl"><span class="s1">      false\nwireGuard:\n  port: 51820\negress:\n  exceptCIDRs: []\nserviceCIDR: 20.10.0.0/16\nnodePortLocal:\n  enable:
</span></span></span><span class="line"><span class="cl"><span class="s1">      true\n  portRange: 61000-62000\ntlsCipherSuites: TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,TLS_RSA_WITH_AES_256_GCM_SHA384\nmulticast:
</span></span></span><span class="line"><span class="cl"><span class="s1">      {}\nantreaProxy:\n  proxyAll: false\n  nodePortAddresses: []\n  skipServices:
</span></span></span><span class="line"><span class="cl"><span class="s1">      []\n  proxyLoadBalancerIPs: false\nmulticluster: {}\n&#34;,&#34;antrea-cni.conflist&#34;:&#34;{\n    \&#34;cniVersion\&#34;:\&#34;0.3.0\&#34;,\n    \&#34;name\&#34;:
</span></span></span><span class="line"><span class="cl"><span class="s1">      \&#34;antrea\&#34;,\n    \&#34;plugins\&#34;: [\n        {\n            \&#34;type\&#34;: \&#34;antrea\&#34;,\n            \&#34;ipam\&#34;:
</span></span></span><span class="line"><span class="cl"><span class="s1">      {\n                \&#34;type\&#34;: \&#34;host-local\&#34;\n            }\n        }\n        ,\n        {\n            \&#34;type\&#34;:
</span></span></span><span class="line"><span class="cl"><span class="s1">      \&#34;portmap\&#34;,\n            \&#34;capabilities\&#34;: {\&#34;portMappings\&#34;: true}\n        }\n        ,\n        {\n            \&#34;type\&#34;:
</span></span></span><span class="line"><span class="cl"><span class="s1">      \&#34;bandwidth\&#34;,\n            \&#34;capabilities\&#34;: {\&#34;bandwidth\&#34;: true}\n        }\n    ]\n}\n&#34;,&#34;antrea-controller.conf&#34;:&#34;featureGates:\n  Traceflow:
</span></span></span><span class="line"><span class="cl"><span class="s1">      true\n  AntreaPolicy: true\n  NetworkPolicyStats: false\n  Multicast: false\n  Egress:
</span></span></span><span class="line"><span class="cl"><span class="s1">      true\n  AntreaIPAM: false\n  ServiceExternalIP: false\ntlsCipherSuites: TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,TLS_RSA_WITH_AES_256_GCM_SHA384\nnodeIPAM:
</span></span></span><span class="line"><span class="cl"><span class="s1">      null\n&#34;},&#34;kind&#34;:&#34;ConfigMap&#34;,&#34;metadata&#34;:{&#34;labels&#34;:{&#34;app&#34;:&#34;antrea&#34;,&#34;kapp.k14s.io/app&#34;:&#34;1685607245932804320&#34;,&#34;kapp.k14s.io/association&#34;:&#34;v1.c39c4aca919097e50452c3432329dd40&#34;},&#34;name&#34;:&#34;antrea-config&#34;,&#34;namespace&#34;:&#34;kube-system&#34;}}&#39;</span>
</span></span><span class="line"><span class="cl">    kapp.k14s.io/original-diff-md5: c6e94dc94aed3401b5d0f26ed6c0bff3
</span></span><span class="line"><span class="cl">  creationTimestamp: <span class="s2">&#34;2023-06-01T08:14:14Z&#34;</span>
</span></span><span class="line"><span class="cl">  labels:
</span></span><span class="line"><span class="cl">    app: antrea
</span></span><span class="line"><span class="cl">    kapp.k14s.io/app: <span class="s2">&#34;1685607245932804320&#34;</span>
</span></span><span class="line"><span class="cl">    kapp.k14s.io/association: v1.c39c4aca919097e50452c3432329dd40
</span></span><span class="line"><span class="cl">  name: antrea-config
</span></span><span class="line"><span class="cl">  namespace: kube-system
</span></span><span class="line"><span class="cl">  resourceVersion: <span class="s2">&#34;948&#34;</span>
</span></span><span class="line"><span class="cl">  uid: fd18fd20-a82b-4df5-bb1a-686463b86f27
</span></span></code></pre></div><p>If you want to enable or disable any of these features its a matter of applying an AntreaConfig using the included AntreaConfig CRD in TKG 2.0.</p>
<p>One can apply this AntreaConfig on an already provisioned TKG 2.0 cluster or apply before the cluster is provisioned so it will get the features enabled or disabled at creation.
Below is an example of AntreaConfig:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">cni.tanzu.vmware.com/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">AntreaConfig</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">three-zone-cluster-2-antrea-package</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">ns-three-zone-1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">antrea</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">config</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">featureGates</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">AntreaProxy</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">EndpointSlice</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">AntreaPolicy</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">FlowExporter</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">Egress</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="c">#This needs to be enabled (an example)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">NodePortLocal</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">AntreaTraceflow</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">NetworkPolicyStats</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span></code></pre></div><p>This example is applied either before or after provisioning of the TKG 2.0 cluster. Just make sure the config has been applied to the correct NS, the same NS as the cluster is deployed in and the name of the config needs to start like this <em>CLUSTER-NAME-antrea-package</em>. In other words the name needs to start with the clustername of the TKG 2.0 cluster and end with <em>-antrea-package</em>.</p>
<p>If it is being done after the cluster has provisioned we need to make sure the already running Antrea pods (agents and controller) are restarted so they can read the new configmap.</p>
<p>If you need to check which version of Antrea is included in your TKR version (and other components for that sake) just run the following command:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">linuxvm01:~/three-zones$ k get tkr v1.24.9---vmware.1-tkg.4 -o yaml
</span></span><span class="line"><span class="cl">apiVersion: run.tanzu.vmware.com/v1alpha3
</span></span><span class="line"><span class="cl">kind: TanzuKubernetesRelease
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  creationTimestamp: <span class="s2">&#34;2023-06-01T07:35:28Z&#34;</span>
</span></span><span class="line"><span class="cl">  finalizers:
</span></span><span class="line"><span class="cl">  - tanzukubernetesrelease.run.tanzu.vmware.com
</span></span><span class="line"><span class="cl">  generation: <span class="m">2</span>
</span></span><span class="line"><span class="cl">  labels:
</span></span><span class="line"><span class="cl">    os-arch: amd64
</span></span><span class="line"><span class="cl">    os-name: photon
</span></span><span class="line"><span class="cl">    os-type: linux
</span></span><span class="line"><span class="cl">    os-version: <span class="s2">&#34;3.0&#34;</span>
</span></span><span class="line"><span class="cl">    v1: <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    v1.24: <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    v1.24.9: <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    v1.24.9---vmware: <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    v1.24.9---vmware.1: <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    v1.24.9---vmware.1-tkg: <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    v1.24.9---vmware.1-tkg.4: <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">  name: v1.24.9---vmware.1-tkg.4
</span></span><span class="line"><span class="cl">  ownerReferences:
</span></span><span class="line"><span class="cl">  - apiVersion: vmoperator.vmware.com/v1alpha1
</span></span><span class="line"><span class="cl">    kind: VirtualMachineImage
</span></span><span class="line"><span class="cl">    name: ob-21552850-ubuntu-2004-amd64-vmi-k8s-v1.24.9---vmware.1-tkg.4
</span></span><span class="line"><span class="cl">    uid: 92d3d6af-53f8-4f9a-b262-f70dd33ad19b
</span></span><span class="line"><span class="cl">  - apiVersion: vmoperator.vmware.com/v1alpha1
</span></span><span class="line"><span class="cl">    kind: VirtualMachineImage
</span></span><span class="line"><span class="cl">    name: ob-21554409-photon-3-amd64-vmi-k8s-v1.24.9---vmware.1-tkg.4
</span></span><span class="line"><span class="cl">    uid: 6a0aa87a-63e3-475d-a52d-e63589f454e9
</span></span><span class="line"><span class="cl">  resourceVersion: <span class="s2">&#34;12111&#34;</span>
</span></span><span class="line"><span class="cl">  uid: 54db049e-fdf0-45a2-b4d1-46fa90a22b44
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  bootstrapPackages:
</span></span><span class="line"><span class="cl">  - name: antrea.tanzu.vmware.com.1.7.2+vmware.1-tkg.1-advanced
</span></span><span class="line"><span class="cl">  - name: vsphere-pv-csi.tanzu.vmware.com.2.6.1+vmware.1-tkg.1
</span></span><span class="line"><span class="cl">  - name: vsphere-cpi.tanzu.vmware.com.1.24.3+vmware.1-tkg.1
</span></span><span class="line"><span class="cl">  - name: kapp-controller.tanzu.vmware.com.0.41.5+vmware.1-tkg.1
</span></span><span class="line"><span class="cl">  - name: guest-cluster-auth-service.tanzu.vmware.com.1.1.0+tkg.1
</span></span><span class="line"><span class="cl">  - name: metrics-server.tanzu.vmware.com.0.6.2+vmware.1-tkg.1
</span></span><span class="line"><span class="cl">  - name: secretgen-controller.tanzu.vmware.com.0.11.2+vmware.1-tkg.1
</span></span><span class="line"><span class="cl">  - name: pinniped.tanzu.vmware.com.0.12.1+vmware.3-tkg.3
</span></span><span class="line"><span class="cl">  - name: capabilities.tanzu.vmware.com.0.28.0+vmware.2
</span></span><span class="line"><span class="cl">  - name: calico.tanzu.vmware.com.3.24.1+vmware.1-tkg.1
</span></span><span class="line"><span class="cl">  kubernetes:
</span></span><span class="line"><span class="cl">    coredns:
</span></span><span class="line"><span class="cl">      imageTag: v1.8.6_vmware.15
</span></span><span class="line"><span class="cl">    etcd:
</span></span><span class="line"><span class="cl">      imageTag: v3.5.6_vmware.3
</span></span><span class="line"><span class="cl">    imageRepository: localhost:5000/vmware.io
</span></span><span class="line"><span class="cl">    pause:
</span></span><span class="line"><span class="cl">      imageTag: <span class="s2">&#34;3.7&#34;</span>
</span></span><span class="line"><span class="cl">    version: v1.24.9+vmware.1
</span></span><span class="line"><span class="cl">  osImages:
</span></span><span class="line"><span class="cl">  - name: ob-21552850-ubuntu-2004-amd64-vmi-k8s-v1.24.9---vmware.1-tkg.4
</span></span><span class="line"><span class="cl">  - name: ob-21554409-photon-3-amd64-vmi-k8s-v1.24.9---vmware.1-tkg.4
</span></span><span class="line"><span class="cl">  version: v1.24.9+vmware.1-tkg.4
</span></span><span class="line"><span class="cl">status:
</span></span><span class="line"><span class="cl">  conditions:
</span></span><span class="line"><span class="cl">  - lastTransitionTime: <span class="s2">&#34;2023-06-01T07:35:28Z&#34;</span>
</span></span><span class="line"><span class="cl">    status: <span class="s2">&#34;True&#34;</span>
</span></span><span class="line"><span class="cl">    type: Ready
</span></span><span class="line"><span class="cl">  - lastTransitionTime: <span class="s2">&#34;2023-06-01T07:35:28Z&#34;</span>
</span></span><span class="line"><span class="cl">    status: <span class="s2">&#34;True&#34;</span>
</span></span><span class="line"><span class="cl">    type: Compatible
</span></span></code></pre></div><p>So enabling and disabling Antrea Feature Gates is quite simple.
To summarize, the feature gates that can be adjusted is these (as of TKR 1.24.9):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">antrea</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">config</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">defaultMTU</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">disableUdpTunnelOffload</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">featureGates</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">AntreaPolicy</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">AntreaProxy</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">AntreaTraceflow</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">Egress</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">EndpointSlice</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">FlowExporter</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">NetworkPolicyStats</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">NodePortLocal</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">noSNAT</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">tlsCipherSuites</span><span class="p">:</span><span class="w"> </span><span class="l">TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,TLS_RSA_WITH_AES_256_GCM_SHA384</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">trafficEncapMode</span><span class="p">:</span><span class="w"> </span><span class="l">encap</span><span class="w">
</span></span></span></code></pre></div>

<h3 class="relative group">Getting the Antrea config &ldquo;templates&rdquo; for a specific TKR version 
    <div id="getting-the-antrea-config-templates-for-a-specific-tkr-version" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#getting-the-antrea-config-templates-for-a-specific-tkr-version" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>Usually with new TKR versions, a new version of Antrea is shipped. And with a new version of Antrea is shipped it most liley containt new and exciting features. So if you want to see which feature gates are being available in your latest and greatest TKR, run these commands from the Supervisor context:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># to get all the Antrea configs </span>
</span></span><span class="line"><span class="cl">andreasm@ubuntu02:~/avi_nsxt_wcp$ k get antreaconfigs.cni.tanzu.vmware.com -A
</span></span><span class="line"><span class="cl">NAMESPACE           NAME                                           TRAFFICENCAPMODE   DEFAULTMTU   ANTREAPROXY   ANTREAPOLICY   SECRETREF
</span></span><span class="line"><span class="cl">ns-stc-1            cluster-1-antrea-package                       encap                           <span class="nb">true</span>          <span class="nb">true</span>           cluster-1-antrea-data-values
</span></span><span class="line"><span class="cl">vmware-system-tkg   v1.23.15---vmware.1-tkg.4                      encap                           <span class="nb">true</span>          <span class="nb">true</span>
</span></span><span class="line"><span class="cl">vmware-system-tkg   v1.23.15---vmware.1-tkg.4-routable             noEncap                         <span class="nb">true</span>          <span class="nb">true</span>
</span></span><span class="line"><span class="cl">vmware-system-tkg   v1.23.8---vmware.2-tkg.2-zshippable            encap                           <span class="nb">true</span>          <span class="nb">true</span>
</span></span><span class="line"><span class="cl">vmware-system-tkg   v1.23.8---vmware.2-tkg.2-zshippable-routable   noEncap                         <span class="nb">true</span>          <span class="nb">true</span>
</span></span><span class="line"><span class="cl">vmware-system-tkg   v1.24.9---vmware.1-tkg.4                       encap                           <span class="nb">true</span>          <span class="nb">true</span>
</span></span><span class="line"><span class="cl">vmware-system-tkg   v1.24.9---vmware.1-tkg.4-routable              noEncap                         <span class="nb">true</span>          <span class="nb">true</span>
</span></span><span class="line"><span class="cl">vmware-system-tkg   v1.25.7---vmware.3-fips.1-tkg.1                encap                           <span class="nb">true</span>          <span class="nb">true</span>
</span></span><span class="line"><span class="cl">vmware-system-tkg   v1.25.7---vmware.3-fips.1-tkg.1-routable       noEncap                         <span class="nb">true</span>          <span class="nb">true</span>
</span></span><span class="line"><span class="cl">vmware-system-tkg   v1.26.5---vmware.2-fips.1-tkg.1                encap                           <span class="nb">true</span>          <span class="nb">true</span>
</span></span><span class="line"><span class="cl">vmware-system-tkg   v1.26.5---vmware.2-fips.1-tkg.1-routable       noEncap                         <span class="nb">true</span>          <span class="nb">true</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Get the content of a specific Antrea config</span>
</span></span><span class="line"><span class="cl">andreasm@ubuntu02:~/avi_nsxt_wcp$ k get antreaconfigs.cni.tanzu.vmware.com -n vmware-system-tkg v1.26.5---vmware.2-fips.1-tkg.1 -oyaml
</span></span><span class="line"><span class="cl">apiVersion: cni.tanzu.vmware.com/v1alpha1
</span></span><span class="line"><span class="cl">kind: AntreaConfig
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  annotations:
</span></span><span class="line"><span class="cl">    tkg.tanzu.vmware.com/template-config: <span class="s2">&#34;true&#34;</span>
</span></span><span class="line"><span class="cl">  creationTimestamp: <span class="s2">&#34;2023-09-24T17:49:37Z&#34;</span>
</span></span><span class="line"><span class="cl">  generation: <span class="m">1</span>
</span></span><span class="line"><span class="cl">  name: v1.26.5---vmware.2-fips.1-tkg.1
</span></span><span class="line"><span class="cl">  namespace: vmware-system-tkg
</span></span><span class="line"><span class="cl">  resourceVersion: <span class="s2">&#34;19483&#34;</span>
</span></span><span class="line"><span class="cl">  uid: 8cdaa6ec-4059-4d35-a0d4-63711831edc8
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  antrea:
</span></span><span class="line"><span class="cl">    config:
</span></span><span class="line"><span class="cl">      antreaProxy:
</span></span><span class="line"><span class="cl">        proxyLoadBalancerIPs: <span class="nb">true</span>
</span></span><span class="line"><span class="cl">      defaultMTU: <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">      disableTXChecksumOffload: <span class="nb">false</span>
</span></span><span class="line"><span class="cl">      disableUdpTunnelOffload: <span class="nb">false</span>
</span></span><span class="line"><span class="cl">      dnsServerOverride: <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">      enableBridgingMode: <span class="nb">false</span>
</span></span><span class="line"><span class="cl">      enableUsageReporting: <span class="nb">false</span>
</span></span><span class="line"><span class="cl">      featureGates:
</span></span><span class="line"><span class="cl">        AntreaIPAM: <span class="nb">false</span>
</span></span><span class="line"><span class="cl">        AntreaPolicy: <span class="nb">true</span>
</span></span><span class="line"><span class="cl">        AntreaProxy: <span class="nb">true</span>
</span></span><span class="line"><span class="cl">        AntreaTraceflow: <span class="nb">true</span>
</span></span><span class="line"><span class="cl">        Egress: <span class="nb">true</span>
</span></span><span class="line"><span class="cl">        EndpointSlice: <span class="nb">true</span>
</span></span><span class="line"><span class="cl">        FlowExporter: <span class="nb">false</span>
</span></span><span class="line"><span class="cl">        Multicast: <span class="nb">false</span>
</span></span><span class="line"><span class="cl">        Multicluster: <span class="nb">false</span>
</span></span><span class="line"><span class="cl">        NetworkPolicyStats: <span class="nb">true</span>
</span></span><span class="line"><span class="cl">        NodePortLocal: <span class="nb">true</span>
</span></span><span class="line"><span class="cl">        SecondaryNetwork: <span class="nb">false</span>
</span></span><span class="line"><span class="cl">        ServiceExternalIP: <span class="nb">false</span>
</span></span><span class="line"><span class="cl">        TopologyAwareHints: <span class="nb">false</span>
</span></span><span class="line"><span class="cl">        TrafficControl: <span class="nb">false</span>
</span></span><span class="line"><span class="cl">      flowExporter:
</span></span><span class="line"><span class="cl">        activeFlowTimeout: 60s
</span></span><span class="line"><span class="cl">        collectorAddress: flow-aggregator/flow-aggregator:4739:tls
</span></span><span class="line"><span class="cl">      noSNAT: <span class="nb">false</span>
</span></span><span class="line"><span class="cl">      tlsCipherSuites: TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,TLS_RSA_WITH_AES_256_GCM_SHA384
</span></span><span class="line"><span class="cl">      trafficEncapMode: encap
</span></span><span class="line"><span class="cl">      tunnelCsum: <span class="nb">false</span>
</span></span><span class="line"><span class="cl">      tunnelPort: <span class="m">0</span>
</span></span></code></pre></div><p>With the above you can always get the latest config coming with the specific TKR release and use it as a template for your TKC cluster.</p>


<h2 class="relative group">Integrating Antrea with NSX-T 
    <div id="integrating-antrea-with-nsx-t" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#integrating-antrea-with-nsx-t" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>To enable the NSX-T Antrea integration there is a couple of steps that needs to be prepared. All the steps can be followed <a href="https://docs.vmware.com/en/VMware-NSX/4.1/administration/GUID-9197EF8A-7998-4D1B-B968-067007C56B5C.html" target="_blank">here</a>. I have decided to create a script that automates all these steps. So if you dont want to go through all these steps manually by following the link above you can use this script instead and just enter the necesarry information as prompted, and have the pre-requisities in place before excecuting. Copy and paste the below script into a .sh file on your Linux jumpiest and make it executable with chmod +x.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="cp">#!/bin/bash
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1"># Echo information</span>
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;This script has some dependencies... make sure they are met before continuing. Otherwise click ctrl+c now
</span></span></span><span class="line"><span class="cl"><span class="s2">1. This script is adjusted for vSphere with Tanzu TKG clusters using Tanzu CLI
</span></span></span><span class="line"><span class="cl"><span class="s2">2. Have downloaded the antrea-interworking*.zip
</span></span></span><span class="line"><span class="cl"><span class="s2">3. This script is located in the root of where you have downloaded the zip file above
</span></span></span><span class="line"><span class="cl"><span class="s2">4. curl is installed
</span></span></span><span class="line"><span class="cl"><span class="s2">5. Need connectivity to the NSX manager
</span></span></span><span class="line"><span class="cl"><span class="s2">6. kubectl is installed
</span></span></span><span class="line"><span class="cl"><span class="s2">7. vsphere with tanzu cli is installed
</span></span></span><span class="line"><span class="cl"><span class="s2">8. That you are in the correct context of the cluster you want to integrate to NSX
</span></span></span><span class="line"><span class="cl"><span class="s2">9. If not in the correct context the script will put you in the correct context anyway
</span></span></span><span class="line"><span class="cl"><span class="s2">10. A big smile and good mood&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Prompt the user to press a key to continue</span>
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;Press any key to continue...&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nb">read</span> -n <span class="m">1</span> -s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Continue with the script</span>
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;Continuing...&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Prompt for name</span>
</span></span><span class="line"><span class="cl"><span class="nb">read</span> -p <span class="s2">&#34;Enter the name of the tkg cluster - will be used for certificates and name in NSX: &#34;</span> name
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Prompt for NSX_MGR</span>
</span></span><span class="line"><span class="cl"><span class="nb">read</span> -p <span class="s2">&#34;Enter NSX Manager ip or FQDN: &#34;</span> nsx_mgr
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Prompt for NSX_ADMIN</span>
</span></span><span class="line"><span class="cl"><span class="nb">read</span> -p <span class="s2">&#34;Enter NSX admin username: &#34;</span> nsx_admin
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Prompt for NSX_PASS</span>
</span></span><span class="line"><span class="cl"><span class="nb">read</span> -p <span class="s2">&#34;Enter NSX Password: &#34;</span> nsx_pass
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Prompt for Supervisor Endpoint IP or FQDN</span>
</span></span><span class="line"><span class="cl"><span class="nb">read</span> -p <span class="s2">&#34;Enter Supervisor API IP or FQDN: &#34;</span> svc_api_ip
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Prompt for vSphere Username</span>
</span></span><span class="line"><span class="cl"><span class="nb">read</span> -p <span class="s2">&#34;Enter vSphere Username: &#34;</span> vsphere_username
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Prompt for Tanzu Kubernetes Cluster Namespace</span>
</span></span><span class="line"><span class="cl"><span class="nb">read</span> -p <span class="s2">&#34;Enter Tanzu Kubernetes Cluster Namespace: &#34;</span> tanzu_cluster_namespace
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Prompt for Tanzu Kubernetes Cluster Name</span>
</span></span><span class="line"><span class="cl"><span class="nb">read</span> -p <span class="s2">&#34;Enter Tanzu Kubernetes Cluster Name: &#34;</span> tanzu_cluster_name
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Login to vSphere using kubectl</span>
</span></span><span class="line"><span class="cl">kubectl vsphere login --server<span class="o">=</span><span class="s2">&#34;</span><span class="nv">$svc_api_ip</span><span class="s2">&#34;</span> --insecure-skip-tls-verify --vsphere-username<span class="o">=</span><span class="s2">&#34;</span><span class="nv">$vsphere_username</span><span class="s2">&#34;</span> --tanzu-kubernetes-cluster-namespace<span class="o">=</span><span class="s2">&#34;</span><span class="nv">$tanzu_cluster_namespace</span><span class="s2">&#34;</span> --tanzu-kubernetes-cluster-name<span class="o">=</span><span class="s2">&#34;</span><span class="nv">$tanzu_cluster_name</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">key_name</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">name</span><span class="si">}</span><span class="s2">-private.key&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">csr_output</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">name</span><span class="si">}</span><span class="s2">.csr&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">crt_output</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">name</span><span class="si">}</span><span class="s2">.crt&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">openssl genrsa -out <span class="s2">&#34;</span><span class="nv">$key_name</span><span class="s2">&#34;</span> <span class="m">2048</span>
</span></span><span class="line"><span class="cl">openssl req -new -key <span class="s2">&#34;</span><span class="nv">$key_name</span><span class="s2">&#34;</span> -out <span class="s2">&#34;</span><span class="nv">$csr_output</span><span class="s2">&#34;</span> -subj <span class="s2">&#34;/C=US/ST=CA/L=Palo Alto/O=VMware/OU=Antrea Cluster/CN=</span><span class="nv">$name</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">openssl x509 -req -days <span class="m">3650</span> -sha256 -in <span class="s2">&#34;</span><span class="nv">$csr_output</span><span class="s2">&#34;</span> -signkey <span class="s2">&#34;</span><span class="nv">$key_name</span><span class="s2">&#34;</span> -out <span class="s2">&#34;</span><span class="nv">$crt_output</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Convert the certificate file to a one-liner with line breaks</span>
</span></span><span class="line"><span class="cl"><span class="nv">crt_contents</span><span class="o">=</span><span class="k">$(</span>awk <span class="s1">&#39;{printf &#34;%s\\n&#34;, $0}&#39;</span> <span class="s2">&#34;</span><span class="nv">$crt_output</span><span class="s2">&#34;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Replace the certificate and name in the curl body</span>
</span></span><span class="line"><span class="cl"><span class="nv">curl_body</span><span class="o">=</span><span class="s1">&#39;{
</span></span></span><span class="line"><span class="cl"><span class="s1">    &#34;name&#34;: &#34;&#39;</span><span class="s2">&#34;</span><span class="nv">$name</span><span class="s2">&#34;</span><span class="s1">&#39;&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s1">    &#34;node_id&#34;: &#34;&#39;</span><span class="s2">&#34;</span><span class="nv">$name</span><span class="s2">&#34;</span><span class="s1">&#39;&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s1">    &#34;roles_for_paths&#34;: [
</span></span></span><span class="line"><span class="cl"><span class="s1">        {
</span></span></span><span class="line"><span class="cl"><span class="s1">            &#34;path&#34;: &#34;/&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s1">            &#34;roles&#34;: [
</span></span></span><span class="line"><span class="cl"><span class="s1">                {
</span></span></span><span class="line"><span class="cl"><span class="s1">                    &#34;role&#34;: &#34;enterprise_admin&#34;
</span></span></span><span class="line"><span class="cl"><span class="s1">                }
</span></span></span><span class="line"><span class="cl"><span class="s1">            ]
</span></span></span><span class="line"><span class="cl"><span class="s1">        }
</span></span></span><span class="line"><span class="cl"><span class="s1">    ],
</span></span></span><span class="line"><span class="cl"><span class="s1">    &#34;role&#34;: &#34;enterprise_admin&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s1">    &#34;is_protected&#34;: &#34;true&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s1">    &#34;certificate_pem&#34; : &#34;&#39;</span><span class="s2">&#34;</span><span class="nv">$crt_contents</span><span class="s2">&#34;</span><span class="s1">&#39;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s1">}&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Make the curl request with the updated body</span>
</span></span><span class="line"><span class="cl"><span class="c1"># curl -X POST -H &#34;Content-Type: application/json&#34; -d &#34;$curl_body&#34; https://example.com/api/endpoint</span>
</span></span><span class="line"><span class="cl">curl -ku <span class="s2">&#34;</span><span class="nv">$nsx_admin</span><span class="s2">&#34;</span>:<span class="s2">&#34;</span><span class="nv">$nsx_pass</span><span class="s2">&#34;</span> -X POST https://<span class="s2">&#34;</span><span class="nv">$nsx_mgr</span><span class="s2">&#34;</span>/api/v1/trust-management/principal-identities/with-certificate -H <span class="s2">&#34;Content-Type: application/json&#34;</span> -d <span class="s2">&#34;</span><span class="nv">$curl_body</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Check if a subfolder starting with &#34;antrea-interworking&#34; exists</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> ls -d antrea-interworking* <span class="p">&amp;</span>&gt;/dev/null<span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;Subfolder starting with &#39;antrea-interworking&#39; exists. Skipping extraction.&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Extract the zip file starting with &#34;antrea-interworking&#34;</span>
</span></span><span class="line"><span class="cl">    unzip <span class="s2">&#34;antrea-interworking&#34;</span>*.zip
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Create a new folder with the name antrea-interworking-&#34;from-name&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">new_folder</span><span class="o">=</span><span class="s2">&#34;antrea-interworking-</span><span class="nv">$name</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">mkdir <span class="s2">&#34;</span><span class="nv">$new_folder</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Copy all YAML files from the antrea-interworking subfolder to the new folder</span>
</span></span><span class="line"><span class="cl">cp antrea-interworking*/<span class="o">{</span>*.yaml,*.yml<span class="o">}</span> <span class="s2">&#34;</span><span class="nv">$new_folder</span><span class="s2">/&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Replace the field after &#34;image: vmware.io/antrea/interworking&#34; with &#34;image: projects.registry.vmware.com/antreainterworking/interworking-debian&#34; in interworking.yaml</span>
</span></span><span class="line"><span class="cl">sed -i <span class="s1">&#39;s|image: vmware.io/antrea/interworking|image: projects.registry.vmware.com/antreainterworking/interworking-debian|&#39;</span> <span class="s2">&#34;</span><span class="nv">$new_folder</span><span class="s2">/interworking.yaml&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Replace the field after &#34;image: vmware.io/antrea/interworking&#34; with &#34;image: projects.registry.vmware.com/antreainterworking/interworking-debian&#34; in deregisterjob.yaml</span>
</span></span><span class="line"><span class="cl">sed -i <span class="s1">&#39;s|image: vmware.io/antrea/interworking|image: projects.registry.vmware.com/antreainterworking/interworking-debian|&#39;</span> <span class="s2">&#34;</span><span class="nv">$new_folder</span><span class="s2">/deregisterjob.yaml&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Edit the bootstrap.yaml file in the new folder</span>
</span></span><span class="line"><span class="cl">sed -i <span class="s1">&#39;s|clusterName:.*|clusterName: &#39;</span><span class="s2">&#34;</span><span class="nv">$name</span><span class="s2">&#34;</span><span class="s1">&#39;|&#39;</span> <span class="s2">&#34;</span><span class="nv">$new_folder</span><span class="s2">/bootstrap-config.yaml&#34;</span>
</span></span><span class="line"><span class="cl">sed -i <span class="s1">&#39;s|NSXManagers:.*|NSXManagers: [&#34;&#39;</span><span class="s2">&#34;</span><span class="nv">$nsx_mgr</span><span class="s2">&#34;</span><span class="s1">&#39;&#34;]|&#39;</span> <span class="s2">&#34;</span><span class="nv">$new_folder</span><span class="s2">/bootstrap-config.yaml&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">tls_crt_base64</span><span class="o">=</span><span class="k">$(</span>base64 -w <span class="m">0</span> <span class="s2">&#34;</span><span class="nv">$crt_output</span><span class="s2">&#34;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">sed -i <span class="s1">&#39;s|tls.crt:.*|tls.crt: &#39;</span><span class="s2">&#34;</span><span class="nv">$tls_crt_base64</span><span class="s2">&#34;</span><span class="s1">&#39;|&#39;</span> <span class="s2">&#34;</span><span class="nv">$new_folder</span><span class="s2">/bootstrap-config.yaml&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">tls_key_base64</span><span class="o">=</span><span class="k">$(</span>base64 -w <span class="m">0</span> <span class="s2">&#34;</span><span class="nv">$key_name</span><span class="s2">&#34;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">sed -i <span class="s1">&#39;s|tls.key:.*|tls.key: &#39;</span><span class="s2">&#34;</span><span class="nv">$tls_key_base64</span><span class="s2">&#34;</span><span class="s1">&#39;|&#39;</span> <span class="s2">&#34;</span><span class="nv">$new_folder</span><span class="s2">/bootstrap-config.yaml&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Interactive prompt to select Kubernetes context</span>
</span></span><span class="line"><span class="cl">kubectl config get-contexts
</span></span><span class="line"><span class="cl"><span class="nb">read</span> -p <span class="s2">&#34;Enter the name of the Kubernetes context: &#34;</span> kubectl_context
</span></span><span class="line"><span class="cl">kubectl config use-context <span class="s2">&#34;</span><span class="nv">$kubectl_context</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Apply the bootstrap-config.yaml and interworking.yaml files from the new folder</span>
</span></span><span class="line"><span class="cl">kubectl apply -f <span class="s2">&#34;</span><span class="nv">$new_folder</span><span class="s2">/bootstrap-config.yaml&#34;</span> -f <span class="s2">&#34;</span><span class="nv">$new_folder</span><span class="s2">/interworking.yaml&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Run the last command to verify that something is happening</span>
</span></span><span class="line"><span class="cl">kubectl get pods -o wide -n vmware-system-antrea
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;As it was written each time we ssh&#39;ed into a Suse Linux back in the good old days - Have a lot of fun&#34;</span>
</span></span></code></pre></div><p>As soon as the script has been processed through it should not take long until you have your TKG cluster in the NSX manager:</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230604131930482.png"
        alt="container-cluster-nsx"
      />
      
    </figure>
</p>
<p>Thats it for the NSX-T integration, as soon as that have been done its time to look into what we can do with this integration in the following chapters</p>


<h2 class="relative group">Antrea Security Policies 
    <div id="antrea-security-policies" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#antrea-security-policies" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>Antrea has two sets of security policies, Antrea Network Policies (ANP) and Antrea Cluster Network Policies (ACNP). The difference between these two is that ANP is applied on a Kubernetes Namespace and ACNP is cluster-wide. Both belongs to Antrea Native Policies. Both ANP and ACNP can work together with Kubernetes Network Policies.</p>
<p>There are many benefits of using Antrea Native Policies in combination or not in combination with Kubernetes Network Policies.</p>
<p>Some of the benefits of using Antrea Native Policies:</p>
<ul>
<li>Can be tiered</li>
<li>Select both ingress and egress</li>
<li>Support the following actions: allow, drop, reject and pass</li>
<li>Support FQDN filtering in egress (to) with actions allow, drop and reject</li>
</ul>


<h3 class="relative group">Tiered policies 
    <div id="tiered-policies" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#tiered-policies" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>The benefit of having tiered policies is very useful when for example we have different parts of the organization are responsible for security at different levels/scopes in the platform. Antrea can have policies placed in different tiers where the tiers are evaluated in a given order. If we want some rules to be very early in the policy evaluation and enforced as soon as possible we can place rule in a tier that is considered first, then within the same tier the rules or policies are also being enforced in the order of a given priority, a number. The rule with the lowest number (higher priority) will be evaluated first and then when all rules in a tier has been processed it will go to the next tier. Antrea comes with a set of static tiers already defined. These tier can be shown by running the command:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">linuxvm01:~$ k get tiers
</span></span><span class="line"><span class="cl">NAME                          PRIORITY   AGE
</span></span><span class="line"><span class="cl">application                   <span class="m">250</span>        3h11m
</span></span><span class="line"><span class="cl">baseline                      <span class="m">253</span>        3h11m
</span></span><span class="line"><span class="cl">emergency                     <span class="m">50</span>         3h11m
</span></span><span class="line"><span class="cl">networkops                    <span class="m">150</span>        3h11m
</span></span><span class="line"><span class="cl">platform                      <span class="m">200</span>        3h11m
</span></span><span class="line"><span class="cl">securityops                   <span class="m">100</span>        3h11m
</span></span></code></pre></div><p>Below will show a diagram of how they look, notice also where the Kubernets network policies will be placed:</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230604145414788.png"
        alt="antrea-tiers"
      />
      
    </figure>
</p>
<p>There is also the option to add custom tiers using the following CRD (taken from the offical Antrea docs <a href="https://antrea.io/docs/v1.12.0/docs/antrea-network-policy/" target="_blank">here</a>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">crd.antrea.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Tier</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">mytier</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">priority</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;my custom tier&#34;</span><span class="w">
</span></span></span></code></pre></div><p>When doing the Antrea NSX integration some additional tiers are added automatically (they start with nsx*):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">linuxvm01:~$ k get tiers
</span></span><span class="line"><span class="cl">NAME                          PRIORITY   AGE
</span></span><span class="line"><span class="cl">application                   <span class="m">250</span>        3h11m
</span></span><span class="line"><span class="cl">baseline                      <span class="m">253</span>        3h11m
</span></span><span class="line"><span class="cl">emergency                     <span class="m">50</span>         3h11m
</span></span><span class="line"><span class="cl">networkops                    <span class="m">150</span>        3h11m
</span></span><span class="line"><span class="cl">nsx-category-application      <span class="m">4</span>          87m
</span></span><span class="line"><span class="cl">nsx-category-emergency        <span class="m">1</span>          87m
</span></span><span class="line"><span class="cl">nsx-category-environment      <span class="m">3</span>          87m
</span></span><span class="line"><span class="cl">nsx-category-ethernet         <span class="m">0</span>          87m
</span></span><span class="line"><span class="cl">nsx-category-infrastructure   <span class="m">2</span>          87m
</span></span><span class="line"><span class="cl">platform                      <span class="m">200</span>        3h11m
</span></span><span class="line"><span class="cl">securityops                   <span class="m">100</span>        3h11m
</span></span></code></pre></div><p>I can quickly show two examples where I create one rule as a &ldquo;security-admin&rdquo;, where this security admin has to follow the company&rsquo;s compliance policy to block access to a certain FQDN. This must be enforced all over. So I need to create this policy in the <em>securityops</em> tier. I could have defined it in the <em>emergency</em> tier also but in this tier it makes more sense to have rules applied that are disabled/not-enforced/idle in case of an emergency and we need a way to quickly enable it and override rules later down the hierarchy. So <em>securityops</em> it is:</p>
<p>Lets apply this one:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">crd.antrea.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterNetworkPolicy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">acnp-drop-yelb</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">priority</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">tier</span><span class="p">:</span><span class="w"> </span><span class="l">securityops</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">appliedTo</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">podSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">ubuntu-20-04</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">egress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Drop</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">fqdn</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;yelb-ui.yelb.carefor.some-dns.net&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Allow </span><span class="w"> </span><span class="c">#Allow the rest</span><span class="w">
</span></span></span></code></pre></div><p>To check if it is applied and in use (notice under desired nodes and current nodes):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">linuxvm01:~/antrea/policies$ k get acnp
</span></span><span class="line"><span class="cl">NAME             TIER          PRIORITY   DESIRED NODES   CURRENT NODES   AGE
</span></span><span class="line"><span class="cl">acnp-drop-yelb   securityops   <span class="m">1</span>          <span class="m">1</span>               <span class="m">1</span>               5m33s
</span></span></code></pre></div><p>Now from a test pod I will try to curl the blocked fqdn and another one not in any block rule:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root@ubuntu-20-04-548545fc87-kkzbh:/# curl yelb-ui.yelb.cloudburst.somecooldomain.net
</span></span><span class="line"><span class="cl">curl: <span class="o">(</span>6<span class="o">)</span> Could not resolve host: yelb-ui.yelb.cloudburst.somecooldomain.net
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Curling a FQDN that is allowed:</span>
</span></span><span class="line"><span class="cl">root@ubuntu-20-04-548545fc87-kkzbh:/# curl allowed-yelb.yelb-2.carefor.some-dns.net
</span></span><span class="line"><span class="cl">&lt;!doctype html&gt;
</span></span><span class="line"><span class="cl">&lt;html&gt;
</span></span><span class="line"><span class="cl">&lt;head&gt;
</span></span><span class="line"><span class="cl">    &lt;meta <span class="nv">charset</span><span class="o">=</span><span class="s2">&#34;utf-8&#34;</span>&gt;
</span></span><span class="line"><span class="cl">    &lt;title&gt;Yelb&lt;/title&gt;
</span></span><span class="line"><span class="cl">    &lt;base <span class="nv">href</span><span class="o">=</span><span class="s2">&#34;/&#34;</span>&gt;
</span></span><span class="line"><span class="cl">    &lt;meta <span class="nv">name</span><span class="o">=</span><span class="s2">&#34;viewport&#34;</span> <span class="nv">content</span><span class="o">=</span><span class="s2">&#34;width=device-width, initial-scale=1&#34;</span>&gt;
</span></span><span class="line"><span class="cl">    &lt;link <span class="nv">rel</span><span class="o">=</span><span class="s2">&#34;icon&#34;</span> <span class="nv">type</span><span class="o">=</span><span class="s2">&#34;image/x-icon&#34;</span> <span class="nv">href</span><span class="o">=</span><span class="s2">&#34;favicon.ico?v=2&#34;</span>&gt;
</span></span><span class="line"><span class="cl">&lt;/head&gt;
</span></span><span class="line"><span class="cl">&lt;body&gt;
</span></span><span class="line"><span class="cl">&lt;yelb&gt;Loading...&lt;/yelb&gt;
</span></span><span class="line"><span class="cl">&lt;script <span class="nv">type</span><span class="o">=</span><span class="s2">&#34;text/javascript&#34;</span> <span class="nv">src</span><span class="o">=</span><span class="s2">&#34;inline.bundle.js&#34;</span>&gt;&lt;/script&gt;&lt;script <span class="nv">type</span><span class="o">=</span><span class="s2">&#34;text/javascript&#34;</span> <span class="nv">src</span><span class="o">=</span><span class="s2">&#34;styles.bundle.js&#34;</span>&gt;&lt;/script&gt;&lt;script <span class="nv">type</span><span class="o">=</span><span class="s2">&#34;text/javascript&#34;</span> <span class="nv">src</span><span class="o">=</span><span class="s2">&#34;scripts.bundle.js&#34;</span>&gt;&lt;/script&gt;&lt;script <span class="nv">type</span><span class="o">=</span><span class="s2">&#34;text/javascript&#34;</span> <span class="nv">src</span><span class="o">=</span><span class="s2">&#34;vendor.bundle.js&#34;</span>&gt;&lt;/script&gt;&lt;script <span class="nv">type</span><span class="o">=</span><span class="s2">&#34;text/javascript&#34;</span> <span class="nv">src</span><span class="o">=</span><span class="s2">&#34;main.bundle.js&#34;</span>&gt;&lt;/script&gt;&lt;/body&gt;
</span></span><span class="line"><span class="cl">&lt;/html&gt;
</span></span></code></pre></div><p>That works as expected. Now what happens then if another use with access to the Kubernetes cluster decide to create a rule later down in the hierarchy, lets go with the application tier, to create an allow rule for this FQDN that is currently being dropped? Lets see what happens</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">crd.antrea.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterNetworkPolicy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">acnp-allow-yelb</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">priority</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">tier</span><span class="p">:</span><span class="w"> </span><span class="l">application</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">appliedTo</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">podSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">ubuntu-20-04</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">egress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Allow</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">fqdn</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;yelb-ui.yelb.carefor.some-dns.net&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Allow </span><span class="w"> </span><span class="c">#Allow the rest</span><span class="w">
</span></span></span></code></pre></div><p>I will apply this above rule and then try to curl the same fqdn which is supposed to be dropped.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">linuxvm01:~/antrea/policies$ k get acnp
</span></span><span class="line"><span class="cl">NAME              TIER          PRIORITY   DESIRED NODES   CURRENT NODES   AGE
</span></span><span class="line"><span class="cl">acnp-allow-yelb   application   <span class="m">1</span>          <span class="m">1</span>               <span class="m">1</span>               4s
</span></span><span class="line"><span class="cl">acnp-drop-yelb    securityops   <span class="m">1</span>          <span class="m">1</span>               <span class="m">1</span>               5h1m
</span></span></code></pre></div><p>From my test pod again:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl <span class="nb">exec</span> <span class="o">[</span>POD<span class="o">]</span> <span class="o">[</span>COMMAND<span class="o">]</span> is DEPRECATED and will be removed in a future version. Use kubectl <span class="nb">exec</span> <span class="o">[</span>POD<span class="o">]</span> -- <span class="o">[</span>COMMAND<span class="o">]</span> instead.
</span></span><span class="line"><span class="cl">root@ubuntu-20-04-548545fc87-kkzbh:/# curl yelb-ui.yelb.cloudburst.somecooldomain.net
</span></span><span class="line"><span class="cl">curl: <span class="o">(</span>6<span class="o">)</span> Could not resolve host: yelb-ui.yelb.cloudburst.somecooldomain.net
</span></span><span class="line"><span class="cl">root@ubuntu-20-04-548545fc87-kkzbh:/# curl allowed-yelb.yelb-2.carefor.some-dns.net
</span></span><span class="line"><span class="cl">&lt;!doctype html&gt;
</span></span><span class="line"><span class="cl">&lt;html&gt;
</span></span><span class="line"><span class="cl">&lt;head&gt;
</span></span><span class="line"><span class="cl">    &lt;meta <span class="nv">charset</span><span class="o">=</span><span class="s2">&#34;utf-8&#34;</span>&gt;
</span></span><span class="line"><span class="cl">    &lt;title&gt;Yelb&lt;/title&gt;
</span></span><span class="line"><span class="cl">    &lt;base <span class="nv">href</span><span class="o">=</span><span class="s2">&#34;/&#34;</span>&gt;
</span></span><span class="line"><span class="cl">    &lt;meta <span class="nv">name</span><span class="o">=</span><span class="s2">&#34;viewport&#34;</span> <span class="nv">content</span><span class="o">=</span><span class="s2">&#34;width=device-width, initial-scale=1&#34;</span>&gt;
</span></span><span class="line"><span class="cl">    &lt;link <span class="nv">rel</span><span class="o">=</span><span class="s2">&#34;icon&#34;</span> <span class="nv">type</span><span class="o">=</span><span class="s2">&#34;image/x-icon&#34;</span> <span class="nv">href</span><span class="o">=</span><span class="s2">&#34;favicon.ico?v=2&#34;</span>&gt;
</span></span><span class="line"><span class="cl">&lt;/head&gt;
</span></span><span class="line"><span class="cl">&lt;body&gt;
</span></span><span class="line"><span class="cl">&lt;yelb&gt;Loading...&lt;/yelb&gt;
</span></span><span class="line"><span class="cl">&lt;script <span class="nv">type</span><span class="o">=</span><span class="s2">&#34;text/javascript&#34;</span> <span class="nv">src</span><span class="o">=</span><span class="s2">&#34;inline.bundle.js&#34;</span>&gt;&lt;/script&gt;&lt;script <span class="nv">type</span><span class="o">=</span><span class="s2">&#34;text/javascript&#34;</span> <span class="nv">src</span><span class="o">=</span><span class="s2">&#34;styles.bundle.js&#34;</span>&gt;&lt;/script&gt;&lt;script <span class="nv">type</span><span class="o">=</span><span class="s2">&#34;text/javascript&#34;</span> <span class="nv">src</span><span class="o">=</span><span class="s2">&#34;scripts.bundle.js&#34;</span>&gt;&lt;/script&gt;&lt;script <span class="nv">type</span><span class="o">=</span><span class="s2">&#34;text/javascript&#34;</span> <span class="nv">src</span><span class="o">=</span><span class="s2">&#34;vendor.bundle.js&#34;</span>&gt;&lt;/script&gt;&lt;script <span class="nv">type</span><span class="o">=</span><span class="s2">&#34;text/javascript&#34;</span> <span class="nv">src</span><span class="o">=</span><span class="s2">&#34;main.bundle.js&#34;</span>&gt;&lt;/script&gt;&lt;/body&gt;
</span></span><span class="line"><span class="cl">&lt;/html&gt;
</span></span></code></pre></div><p>That was expected. It is still being dropped by the first rule placed in the <em>securityops</em> tier. So far so good. But what if this user also has access to the tier where the first rule is applied? Well, then they can override it. That is why I we can now go to the next chapter.</p>


<h3 class="relative group">Antrea RBAC 
    <div id="antrea-rbac" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#antrea-rbac" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>Antrea comes with a couple of CRDs that allow us to configure granular user permissions on the different objects, like the Policy Tiers.
So to restrict &ldquo;normal&rdquo; users from applying and/or delete security polices created in the higher priority Tiers we need to apply some rolebindings, or to be exact ClusterRoleBindings. Let us see how we can achieve that.</p>
<p>In my lab environment I have defined two users, my own admin user (andreasm) that is part of the <code>ClusterRole/cluster-admin</code> and a second user (User1) that is part of the the <code>ClusterRole/view</code>. The ClusterRole View has only read access, not to all objects in the cluster but many. To see what run the following command:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="l">linuxvm01:~/antrea/policies$ k get clusterrole view -oyaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">aggregationRule</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">clusterRoleSelectors</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">rbac.authorization.k8s.io/aggregate-to-view</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRole</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">rbac.authorization.kubernetes.io/autoupdate</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2023-06-04T09:37:44Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">kubernetes.io/bootstrapping</span><span class="p">:</span><span class="w"> </span><span class="l">rbac-defaults</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">rbac.authorization.k8s.io/aggregate-to-edit</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">view</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resourceVersion</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;1052&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">uid</span><span class="p">:</span><span class="w"> </span><span class="l">c4784a81-4451-42af-9134-e141ccf8bc50</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">crd.antrea.io</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">clustergroups</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">verbs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">get</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">list</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">watch</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">crd.antrea.io</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">clusternetworkpolicies</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">networkpolicies</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">verbs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">get</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">list</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">watch</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">crd.antrea.io</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">traceflows</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">verbs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">get</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">list</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">watch</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="s2">&#34;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">configmaps</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">endpoints</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">persistentvolumeclaims</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">persistentvolumeclaims/status</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">pods</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">replicationcontrollers</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">replicationcontrollers/scale</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">serviceaccounts</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">services</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">services/status</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">verbs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">get</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">list</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">watch</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="s2">&#34;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">bindings</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">events</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">limitranges</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">namespaces/status</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">pods/log</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">pods/status</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">replicationcontrollers/status</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">resourcequotas</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">resourcequotas/status</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">verbs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">get</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">list</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">watch</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="s2">&#34;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">namespaces</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">verbs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">get</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">list</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">watch</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">discovery.k8s.io</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">endpointslices</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">verbs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">get</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">list</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">watch</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">apps</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">controllerrevisions</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">daemonsets</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">daemonsets/status</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">deployments</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">deployments/scale</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">deployments/status</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">replicasets</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">replicasets/scale</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">replicasets/status</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">statefulsets</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">statefulsets/scale</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">statefulsets/status</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">verbs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">get</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">list</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">watch</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">autoscaling</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">horizontalpodautoscalers</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">horizontalpodautoscalers/status</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">verbs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">get</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">list</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">watch</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">batch</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">cronjobs</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">cronjobs/status</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">jobs</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">jobs/status</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">verbs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">get</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">list</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">watch</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">extensions</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">daemonsets</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">daemonsets/status</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">deployments</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">deployments/scale</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">deployments/status</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">ingresses</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">ingresses/status</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">networkpolicies</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">replicasets</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">replicasets/scale</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">replicasets/status</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">replicationcontrollers/scale</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">verbs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">get</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">list</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">watch</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">policy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">poddisruptionbudgets</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">poddisruptionbudgets/status</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">verbs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">get</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">list</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">watch</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">networking.k8s.io</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">ingresses</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">ingresses/status</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">networkpolicies</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">verbs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">get</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">list</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">watch</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">metrics.k8s.io</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">pods</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">nodes</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">verbs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">get</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">list</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">watch</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">policy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resourceNames</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">vmware-system-privileged</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">podsecuritypolicies</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">verbs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">use</span><span class="w">
</span></span></span></code></pre></div><p>On the other hand my own admin user has access to everything, get, list, create, patch, update, delete - the whole shabang.
What I would like to demonstrate now is that user1 is a regular user and should only be allowed to create security policies in the Tier <em>application</em> while all other Tiers is restricted to the admins that have the responsibility to create policies there. User1 should also not be allowed to create any custom Tiers.</p>
<p>So the first thing I need to create is an Antrea <em>TierEntitlement</em> and <em>TierEntitlementBinding</em> like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">crd.antrea.tanzu.vmware.com/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">TierEntitlement</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">secops-edit</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">tiers</span><span class="p">:</span><span class="w">       </span><span class="c"># Accept list of Tier names. Tier may or may not exist yet.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">emergency</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">securityops</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">networkops</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">platform</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">baseline</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">permission</span><span class="p">:</span><span class="w"> </span><span class="l">edit</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">crd.antrea.tanzu.vmware.com/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">TierEntitlementBinding</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">secops-bind</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">subjects</span><span class="p">:</span><span class="w">                                       </span><span class="c"># List of users to grant this entitlement to</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="w">  </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">User</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">sso:andreasm@cpod-nsxam-stc.az-stc.cloud-garage.net</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#  -   kind: Group</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#      name: security-admins</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#      apiGroup: rbac.authorization.k8s.io</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#  -   kind: ServiceAccount</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#      name: network-admins</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#      namespace: kube-system</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">tierEntitlement</span><span class="p">:</span><span class="w"> </span><span class="l">secops-edit             </span><span class="w"> </span><span class="c"># Reference to the TierEntitlement</span><span class="w">
</span></span></span></code></pre></div><p>Now, notice that I am listing the Tiers that should only be available for the users, groups, or ServiceAccounts in the TierEntitlementBinding (I am only using Kind: User in this example). This means that all unlisted tiers should be allowed for other users to place security policies in.</p>
<p>Now apply it:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">linuxvm01:~/antrea/policies$ k apply -f tierentitlement.yaml
</span></span><span class="line"><span class="cl">tierentitlement.crd.antrea.tanzu.vmware.com/secops-edit created
</span></span><span class="line"><span class="cl">tierentitlementbinding.crd.antrea.tanzu.vmware.com/secops-bind created
</span></span></code></pre></div><p>Next up is to add my User1 to the Antrea CRD &ldquo;tiers&rdquo; to be allowed to list and get the tiers:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRole</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tier-placement</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;crd.antrea.io&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;tiers&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">verbs</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;get&#34;</span><span class="p">,</span><span class="s2">&#34;list&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRoleBinding</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tier-bind</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">subjects</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">User</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">sso:user1@cpod-nsxam-stc.az-stc.cloud-garage.net</span><span class="w"> </span><span class="c"># Name is case sensitive</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">roleRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRole</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tier-placement</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io</span><span class="w">
</span></span></span></code></pre></div><p>If you want some user to also add/create/delete custom Tiers this can be allowed by adding: <code>&quot;create&quot;,&quot;patch&quot;,&quot;update&quot;,&quot;delete&quot;</code></p>
<p>Now apply the above yaml:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">linuxvm01:~/antrea/policies$ k apply -f antrea-crd-tier-list.yaml
</span></span><span class="line"><span class="cl">clusterrole.rbac.authorization.k8s.io/tier-placement created
</span></span><span class="line"><span class="cl">clusterrolebinding.rbac.authorization.k8s.io/tier-bind created
</span></span></code></pre></div><p>I will now log in with the User1 and try to apply this network policy:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">crd.antrea.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterNetworkPolicy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">override-rule-allow-yelb</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">priority</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">tier</span><span class="p">:</span><span class="w"> </span><span class="l">securityops</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">appliedTo</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">podSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">ubuntu-20-04</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">egress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Allow</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">fqdn</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;yelb-ui.yelb.carefor.some-dns.net&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Allow</span><span class="w">
</span></span></span></code></pre></div><p>As User1:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">linuxvm01:~/antrea/policies$ k apply -f fqdn-rule-secops-tier.test.yaml
</span></span><span class="line"><span class="cl">Error from server <span class="o">(</span>Forbidden<span class="o">)</span>: error when creating <span class="s2">&#34;fqdn-rule-secops-tier.test.yaml&#34;</span>: clusternetworkpolicies.crd.antrea.io is forbidden: User <span class="s2">&#34;sso:user1@cpod-nsxam-stc.az-stc.cloud-garage.net&#34;</span> cannot create resource <span class="s2">&#34;clusternetworkpolicies&#34;</span> in API group <span class="s2">&#34;crd.antrea.io&#34;</span> at the cluster scope
</span></span></code></pre></div><p>First bump in the road.. This user is not allowed to create any security policies at all.</p>
<p>So I need to use my admin user and apply this ClusterRoleBinding:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRole</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">clusternetworkpolicies-edit</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;crd.antrea.io&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;clusternetworkpolicies&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">verbs</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;get&#34;</span><span class="p">,</span><span class="s2">&#34;list&#34;</span><span class="p">,</span><span class="s2">&#34;create&#34;</span><span class="p">,</span><span class="s2">&#34;patch&#34;</span><span class="p">,</span><span class="s2">&#34;update&#34;</span><span class="p">,</span><span class="s2">&#34;delete&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRoleBinding</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">clusternetworkpolicies-bind</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">subjects</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">User</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">sso:user1@cpod-nsxam-stc.az-stc.cloud-garage.net</span><span class="w"> </span><span class="c"># Name is case sensitive</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">roleRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRole</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">clusternetworkpolicies-edit</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io</span><span class="w">
</span></span></span></code></pre></div><p>Now the user1 has access to create policies&hellip; Lets try again:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">linuxvm01:~/antrea/policies$ k apply -f fqdn-rule-secops-tier.test.yaml
</span></span><span class="line"><span class="cl">Error from server: error when creating <span class="s2">&#34;fqdn-rule-secops-tier.test.yaml&#34;</span>: admission webhook <span class="s2">&#34;acnpvalidator.antrea.io&#34;</span> denied the request: user not authorized to access Tier securityops
</span></span></code></pre></div><p>There it is, I am not allowed to place any security policies in the tier <em>securityops</em>. That is what I wanted to achieve, so thats good.
What if user1 tries to apply a policy in the <em>application</em> tier? Lets see:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">crd.antrea.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterNetworkPolicy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">override-attempt-failed-allow-yelb</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">priority</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">tier</span><span class="p">:</span><span class="w"> </span><span class="l">application</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">appliedTo</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">podSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">ubuntu-20-04</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">egress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Allow</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">fqdn</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;yelb-ui.yelb.carefor.some-dns.net&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Allow</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">linuxvm01:~/antrea/policies$ k apply -f fqdn-rule-baseline-tier.test.yaml
</span></span><span class="line"><span class="cl">clusternetworkpolicy.crd.antrea.io/override-attempt-failed-allow-yelb created
</span></span><span class="line"><span class="cl">linuxvm01:~/antrea/policies$ k get acnp
</span></span><span class="line"><span class="cl">NAME                                 TIER          PRIORITY   DESIRED NODES   CURRENT NODES   AGE
</span></span><span class="line"><span class="cl">acnp-allow-yelb                      application   <span class="m">1</span>          <span class="m">1</span>               <span class="m">1</span>               147m
</span></span><span class="line"><span class="cl">acnp-drop-yelb                       securityops   <span class="m">1</span>          <span class="m">1</span>               <span class="m">1</span>               18h
</span></span><span class="line"><span class="cl">override-attempt-failed-allow-yelb   application   <span class="m">1</span>          <span class="m">1</span>               <span class="m">1</span>               11s
</span></span></code></pre></div><p>That worked, even though the above rule is trying to allow access to <em>yelb</em> it will not allow it due to the Drop rule in the <em>securityops</em> Tier. So how much the User1 tries to get this access it will be blocked.</p>
<p>These users&hellip;.</p>
<p>What if user1 tries to apply the same policy without stating any Tier in in the policy? Lets see:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">crd.antrea.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterNetworkPolicy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">override-attempt-failed-allow-yelb</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">priority</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">appliedTo</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">podSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">ubuntu-20-04</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">egress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Allow</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">fqdn</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;yelb-ui.yelb.carefor.some-dns.net&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Allow</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">linuxvm01:~/antrea/policies$ k apply -f fqdn-rule-no-tier.yaml
</span></span><span class="line"><span class="cl">clusternetworkpolicy.crd.antrea.io/override-attempt-failed-allow-yelb created
</span></span><span class="line"><span class="cl">linuxvm01:~/antrea/policies$ k get acnp
</span></span><span class="line"><span class="cl">NAME                                 TIER          PRIORITY   DESIRED NODES   CURRENT NODES   AGE
</span></span><span class="line"><span class="cl">acnp-allow-yelb                      application   <span class="m">1</span>          <span class="m">1</span>               <span class="m">1</span>               151m
</span></span><span class="line"><span class="cl">acnp-drop-yelb                       securityops   <span class="m">1</span>          <span class="m">1</span>               <span class="m">1</span>               18h
</span></span><span class="line"><span class="cl">override-attempt-failed-allow-yelb   application   <span class="m">1</span>          <span class="m">1</span>               <span class="m">1</span>               10s
</span></span></code></pre></div><p>The rule will be placed in the <em>application</em> Tier, even though the user has permission to create clusternetworkpolicies&hellip;</p>
<p>With this the network or security admins have full control of the network policies before and after the <em>application</em> Tier (ref the Tier diagram above).</p>
<p>This example has only shown how to do this on Cluster level, one can also add more granular permission on Namespace level.</p>
<p>So far I have gone over how to manage the Antrea FeatureGates in TKG, how to configure the Antrea-NSX integration, Antrea Policies in general and how to manage RBAC. In the the two next chapters I will cover two different ways how we can apply the Antrea Policies. Lets get into it</p>


<h2 class="relative group">How to manage the Antrea Native Policies 
    <div id="how-to-manage-the-antrea-native-policies" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#how-to-manage-the-antrea-native-policies" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>As mentioned previously Antrea Native Policies can be applied from inside the Kubernetes cluster using yaml manifests, but there is also another way to manage them using the NSX manager. As not mentioned previously this opens up for a whole new way of managing security policies. Centrally managed across multiple clusters wherever located, easier adoption of roles and responsibilities. If NSX is already in place, chances are that NSX security policies are already in place and being managed by the network or security admins. Now they can continue doing that but also take into consideration pod network security across the different TKG/Kubernetes clusters.</p>


<h3 class="relative group">Antrea Security policies from the NSX manager 
    <div id="antrea-security-policies-from-the-nsx-manager" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#antrea-security-policies-from-the-nsx-manager" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>After you have connected your TKG clusters to the NSX manager (as shown earlier in this post) you will see the status of these connections in the NSX manager under System -&gt; Fabric -&gt; Nodes:</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230605132911898.png"
        alt="nsx-container-clusters"
      />
      
    </figure>
</p>
<p>The status indicator is also a benefit of this integration as it will show you the status of Antrea Controller, and the components responsible for the Antrea-NSX integration.</p>
<img src=images/image-20230605133035484.png style="width:500px" />
<p>Under inventory we can get all the relevant info from the TKG clusters:</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230605133420565.png"
        alt="inventory"
      />
      
    </figure>
</p>
<p>Where in the screenshot above stc-tkg-cluster 1 and 2 are my TKG Antrea clusters.
I can get all kinds of information like namespaces, pods, labels, ip addresses, names, services. This informaton is relevant as I can use them in my policy creation, but it also gives me status on whether pods, services are up.</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230605133627830.png"
        alt="pods"
      />
      
    </figure>
</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230605133657993.png"
        alt="labels"
      />
      
    </figure>
</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230605133728801.png"
        alt="services"
      />
      
    </figure>
</p>


<h3 class="relative group">Antrea Cluster Network Policies - Applied from the NSX manager 
    <div id="antrea-cluster-network-policies---applied-from-the-nsx-manager" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#antrea-cluster-network-policies---applied-from-the-nsx-manager" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>With the NSX manager we can create and manage the Antrea Native Policies from the NSX graphical user interface instead of CLI. Using NSX security groups and labels make it also much more fun, but also very easy to maintain know what we do as we can see the policies.</p>
<p>Lets create some policies from the NSX manager microsegmenting my demo application Yelb. This is my demo application, it consists of four pods, and a service called yelb-ui where the webpage is exposed.

    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230605135120736.png"
        alt="yelb"
      />
      
    </figure>
</p>
<p>I know the different parts of the application (e.g pods) are using labels so I will use them. First let us list them from cli and then get them from the NSX manager.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">linuxvm01:~/antrea/policies$ k get pods -n yelb --show-labels
</span></span><span class="line"><span class="cl">NAME                              READY   STATUS    RESTARTS   AGE   LABELS
</span></span><span class="line"><span class="cl">redis-server-69846b4888-5m757     1/1     Running   <span class="m">0</span>          22h   <span class="nv">app</span><span class="o">=</span>redis-server,pod-template-hash<span class="o">=</span>69846b4888,tier<span class="o">=</span>cache
</span></span><span class="line"><span class="cl">yelb-appserver-857c5c76d5-4cgbq   1/1     Running   <span class="m">0</span>          22h   <span class="nv">app</span><span class="o">=</span>yelb-appserver,pod-template-hash<span class="o">=</span>857c5c76d5,tier<span class="o">=</span>middletier
</span></span><span class="line"><span class="cl">yelb-db-6bd4fc5d9b-92rkf          1/1     Running   <span class="m">0</span>          22h   <span class="nv">app</span><span class="o">=</span>yelb-db,pod-template-hash<span class="o">=</span>6bd4fc5d9b,tier<span class="o">=</span>backenddb
</span></span><span class="line"><span class="cl">yelb-ui-6df49457d6-4bktw          1/1     Running   <span class="m">0</span>          20h   <span class="nv">app</span><span class="o">=</span>yelb-ui,pod-template-hash<span class="o">=</span>6df49457d6,tier<span class="o">=</span>frontend
</span></span></code></pre></div><p>Ok, there I have the labels. Fine, just for the sake of it I will find the same labels in the NSX manager also:</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230605140111700.png"
        alt="nsx-pod-labels"
      />
      
    </figure>
</p>
<p>Now I need to create some security groups in NSX using these labels.</p>
<p>First group is called acnp-yelb-frontend-ui and are using these membership criterias:
(I am also adding the namespace criteria, to exclude any other applications using the same labels in other namespaces).</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230605141849979.png"
        alt="membership-criteria"
      />
      
    </figure>
</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230605140549646.png"
        alt="acnp-yelb-ui"
      />
      
    </figure>
</p>
<p>Now hurry back to the security group and check whether there are any members&hellip;. Disappointment. Just empty:</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230605140707135.png"
        alt="membership"
      />
      
    </figure>
</p>
<p>Fear not, let us quickly create a policy with this group:</p>
<p>Create a new policy and set Antrea Container Clusters in the applied to field:</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230605140906815.png"
        alt="policy"
      />
      
    </figure>
</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230605140810327.png"
        alt="applied-to"
      />
      
    </figure>
</p>
<p>The actual rule:</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230605141328730.png"
        alt="rule"
      />
      
    </figure>
</p>
<p>The rule above allows my AVI Service Engines to reach the web-port on my yelb-ui pod on port 80 (http) as they are the loadbalancer for my application.</p>
<p>Any members in the group now?

    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230605141412366.png"
        alt="members&amp;hellip;"
      />
      
    </figure>
</p>
<p>Yes &#x1f603;</p>
<p>Now go ahead and create similar groups and rules (except the ports) for the other pods using their respective label.</p>
<p>End result:</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230605145712176.png"
        alt="microseg-yelb"
      />
      
    </figure>
</p>
<p>Do they work? Let us find that out a bit later as I need something to put in my TraceFlow chapter &#x1f604;</p>
<p>The rules I have added above was just for the application in the namespace Yelb. If I wanted to extend this ruleset to also include the same application from other clusters its just adding the Kubernetes cluster in the Applied field like this:

    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230605173306111.png"
        alt="add-clusters"
      />
      
    </figure>
</p>


<h3 class="relative group">NSX Distributed Firewall - Kubernetes objects Policies 
    <div id="nsx-distributed-firewall---kubernetes-objects-policies" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#nsx-distributed-firewall---kubernetes-objects-policies" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>In additon to managing the Antrea Native Policies from the NSX manager as above, in the recent NSX release additional features have been added to support security policies enforced in the NSX Distributed Firewall to also cover these components:</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230605134554491.png"
        alt="nsx-dfw-kubernetes"
      />
      
    </figure>
</p>
<p>With this we can create security policies in NSX using the distributed firewall to cover the above components using security groups. With this feature its no longer necessary to investigate to get the information about the above components as they are already reported into the NSX manager. Let is do an example of how such a rule can be created and work.</p>
<p>I will create a security policy based on this feature where I will use Kubernetes Service in my example. I will create a security group as above, but this time I will do some different selections. First grab the labels from the service, I will use the yelb-ui service in my example:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">linuxvm01:~/antrea/policies$ k get svc -n yelb --show-labels
</span></span><span class="line"><span class="cl">NAME             TYPE           CLUSTER-IP      EXTERNAL-IP    PORT<span class="o">(</span>S<span class="o">)</span>        AGE   LABELS
</span></span><span class="line"><span class="cl">redis-server     ClusterIP      20.10.102.8     &lt;none&gt;         6379/TCP       23h   <span class="nv">app</span><span class="o">=</span>redis-server,tier<span class="o">=</span>cache
</span></span><span class="line"><span class="cl">yelb-appserver   ClusterIP      20.10.247.130   &lt;none&gt;         4567/TCP       23h   <span class="nv">app</span><span class="o">=</span>yelb-appserver,tier<span class="o">=</span>middletier
</span></span><span class="line"><span class="cl">yelb-db          ClusterIP      20.10.44.17     &lt;none&gt;         5432/TCP       23h   <span class="nv">app</span><span class="o">=</span>yelb-db,tier<span class="o">=</span>backenddb
</span></span><span class="line"><span class="cl">yelb-ui          LoadBalancer   20.10.194.179   10.13.210.10   80:30912/TCP   21h   <span class="nv">app</span><span class="o">=</span>yelb-ui,tier<span class="o">=</span>frontend
</span></span></code></pre></div><p>I can either decide to use <em>app=yelb-ui</em> or <em>tier=frontend</em>. Now that I have my labels I will create my security group like this:</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230605150542079.png"
        alt="group-k8s-service"
      />
      
    </figure>
</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230605151301908.png"
        alt="membership-criteria"
      />
      
    </figure>
</p>
<p>I used the name of the service itself and the name of the namespace. This gives me this member:

    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230605151408864.png"
        alt="members"
      />
      
    </figure>
</p>
<p>Which is right&hellip;</p>
<p>Now create a security policy using this group where source is another group where I have defined a VM running in the same NSX environment. I have also created a any group which contains just 0.0.0.0/0. Remember that this policy is enforced in the DFW, so there must be something that is running in NSX for this to work, which in my environments is not only the the TKG cluster, but also the Avi Service Engines which acts as LoadBalancer and Ingress for my exposed services. This is kind of important to think of, as the Avi Service Engines communicates with the TKG cluster nodes using NodePortLocal in the default portrange 61000-62000 (if not changed in the Antrea configmap).</p>
<p>Lets see if the below rule works then:</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230606123908794.png"
        alt="kubernetes-service-rule"
      />
      
    </figure>
</p>
<p>I will adjust it to Action Drop:</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230606123943449.png"
        alt="drop"
      />
      
    </figure>
</p>
<p>Test Yelb ui access from my linux vm via curl and my physical laptop&rsquo;s browser, and the results are in:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ubuntu02:~$ curl yelb-ui.yelb.carefor.some-dns.net
</span></span><span class="line"><span class="cl">curl: <span class="o">(</span>28<span class="o">)</span> Failed to connect to yelb-ui.yelb.carefor.some-dns.net port 80: Connection timed out
</span></span></code></pre></div><p>From my physical laptop browser:</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230606100050213.png"
        alt="laptop-yelb-ui"
      />
      
    </figure>
</p>
<p>This will be dropped even though I still have these rules in place from earlier (remember):

    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230606100210135.png"
        alt="antrea-policies"
      />
      
    </figure>
</p>
<p>Now, what about the Avi Service Engines?</p>
<p>If we just look at the rules above, the NSX Kubernetes Service rule and the Antrea Policies rules we are doing the firewall enforcing at two different levels. When creating policies with the Antrea Native Policies, like the one just above, we are applying and enforcing inside the Kubernetes cluster, with the NSX Kubernetes Service rule we are applying and enforcing on the DFW layer. So the Avi Service Engines will first need a policy that is allowing them to communicate to the TKG worker nodes on specific ports/protocol, in my exampe above with Yelb it is port 61002 and TCP. We can see that by looking in Avi UI:</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230606115615767.png"
        alt="avi-se-connectivity"
      />
      
    </figure>
</p>
<p>Regardless of the Avi SE&rsquo;s are using the same DFW as the worker nodes, we need to create this policy for the SE to reach the worker nodes to allow this connection. These policies can either be very &ldquo;lazy&rdquo; allowing the SEs on everyting TCP with a range of 61000-62000 to the worker nodes or can be made very granual pr service. The Avi SEs are automatically being grouped in NSX security groups if using Avi with NSX Cloud, explore that.</p>
<p>If we are not allowing the SEs this traffic, we will se this in the Avi UI:</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230606120425746.png"
        alt="avi-se-blocked"
      />
      
    </figure>
</p>
<p>Why is that though, I dont have a default block-all rule in my NSX environment&hellip; Well this is because of a set of default rules being created by NCP from TKG.
Have a look at this rule:</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230606120713778.png"
        alt="ncp-rules"
      />
      
    </figure>
</p>
<p>What is the membership in the group used in this Drop rule?

    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230606120808660.png"
        alt="members"
      />
      
    </figure>
</p>
<p>That is all my TKG nodes including the Supervisor Control Plane nodes (the workload interface).</p>
<p>Now in the Antrea Policies, we need to allow the IP addresses the SEs are using to reach the yelb-ui, as its not the actual client-ip that is being used, it is the SEs dataplane network.</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230606125401326.png"
        alt="traffic-walk"
      />
      
    </figure>
</p>
<p>The above diagram tries to explain the traffic flow and how it will be enforced.
First the user want to access the VIP of the Yelb UI service. This is allowed by the NSX Firewall saying, yes Port 80 on IP 10.13.210.10 is OK to pass. As this VIP is realized by the Avi SEs, and are on NSX this rule will be enforced by the NSX firewall. Then the Avi SEs will forward (loadbalance) the traffic to the worker node(s) using NodePortLocal ranges between 61000-62000(default) where the worker nodes are also on the same NSX DFW, so we need to allow the SEs to forward this traffic. When all above is allowed, we will get &ldquo;into&rdquo; the actual TKG (Kubernetes) cluster and need to negiotiate the Antrea Native Policies that have been applied. These rules remember are allowing the SE dataplane IPs to reach the pod yelb-ui on port 80. And thats it.</p>
<p>Just before we end up this chapter and head over to the next, let us quickly see how the policies created from the NSX manager look like inside the TKG cluster:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">linuxvm01:~/antrea/policies$ k get acnp
</span></span><span class="line"><span class="cl">NAME                                   TIER                          PRIORITY             DESIRED NODES   CURRENT NODES   AGE
</span></span><span class="line"><span class="cl">823fca6f-88ee-4032-8150-ac8cf22f1c93   nsx-category-infrastructure   1.000000017763571    <span class="m">3</span>               <span class="m">3</span>               23h
</span></span><span class="line"><span class="cl">9ae2599a-3bd3-4413-849e-06f53f467559   nsx-category-application      1.0000000532916369   <span class="m">2</span>               <span class="m">2</span>               24h
</span></span></code></pre></div><p>The policies will be placed according to the NSX tiers from the UI:</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230606142208745.png"
        alt="nsx-dfw-categories"
      />
      
    </figure>
</p>
<p>If I describe one of the policies I will get the actual yaml manifest:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="l">linuxvm01:~/antrea/policies$ k get acnp 9ae2599a-3bd3-4413-849e-06f53f467559 -oyaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">crd.antrea.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterNetworkPolicy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ccp-adapter.antrea.tanzu.vmware.com/display-name</span><span class="p">:</span><span class="w"> </span><span class="l">Yelb-Zero-Trust</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2023-06-05T12:12:14Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">generation</span><span class="p">:</span><span class="w"> </span><span class="m">6</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ccp-adapter.antrea.tanzu.vmware.com/managedBy</span><span class="p">:</span><span class="w"> </span><span class="l">ccp-adapter</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">9ae2599a-3bd3-4413-849e-06f53f467559</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resourceVersion</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;404591&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">uid</span><span class="p">:</span><span class="w"> </span><span class="m">6477e785</span>-<span class="l">fde4-46ba-b0a1-5ff5f784db8c</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ingress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Allow</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">appliedTo</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">group</span><span class="p">:</span><span class="w"> </span><span class="l">6f39fadf-04e8-4f49-be77-da0d4005ff37</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">enableLogging</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">ipBlock</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">cidr</span><span class="p">:</span><span class="w"> </span><span class="m">10.13.11.101</span><span class="l">/32</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">ipBlock</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">cidr</span><span class="p">:</span><span class="w"> </span><span class="m">10.13.11.100</span><span class="l">/32</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;4084&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Allow</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">appliedTo</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">group</span><span class="p">:</span><span class="w"> </span><span class="l">31cf5eab-8bcd-4305-b72d-f1a44843fd8e</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">enableLogging</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">group</span><span class="p">:</span><span class="w"> </span><span class="l">6f39fadf-04e8-4f49-be77-da0d4005ff37</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;4085&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">4567</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Allow</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">appliedTo</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">group</span><span class="p">:</span><span class="w"> </span><span class="l">672f4d75-c83b-4fa1-b0ab-ae414c2e8e8c</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">enableLogging</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">group</span><span class="p">:</span><span class="w"> </span><span class="l">31cf5eab-8bcd-4305-b72d-f1a44843fd8e</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;4087&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">5432</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Allow</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">appliedTo</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">group</span><span class="p">:</span><span class="w"> </span><span class="l">52c3548b-4758-427f-bcde-b25d36613de6</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">enableLogging</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">group</span><span class="p">:</span><span class="w"> </span><span class="l">31cf5eab-8bcd-4305-b72d-f1a44843fd8e</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;4088&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">6379</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Drop</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">appliedTo</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">group</span><span class="p">:</span><span class="w"> </span><span class="l">d250b7d7-3041-4f7f-8fdf-c7360eee9615</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">enableLogging</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">group</span><span class="p">:</span><span class="w"> </span><span class="l">d250b7d7-3041-4f7f-8fdf-c7360eee9615</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;4089&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">priority</span><span class="p">:</span><span class="w"> </span><span class="m">1.0000000532916369</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">tier</span><span class="p">:</span><span class="w"> </span><span class="l">nsx-category-application</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">status</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">currentNodesRealized</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">desiredNodesRealized</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">observedGeneration</span><span class="p">:</span><span class="w"> </span><span class="m">6</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">phase</span><span class="p">:</span><span class="w"> </span><span class="l">Realized</span><span class="w">
</span></span></span></code></pre></div>

<h3 class="relative group">Antrea Security policies from kubernetes api 
    <div id="antrea-security-policies-from-kubernetes-api" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#antrea-security-policies-from-kubernetes-api" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>I have already covered this topic in another post <a href="https://blog.andreasm.io/2021/07/10/antrea-network-policies/" target="_blank">here</a>. Head over and have look, also its worth reading the official documentation page from Antrea <a href="https://antrea.io/docs/v1.12.0/docs/antrea-network-policy/" target="_blank">here</a> as it contains examples and is updated on new features.</p>
<p>One thing I would like to use this chapter for though is trying to apply a policy on the NSX added Tiers when doing the integration (explained above). Remember the Tiers?</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">linuxvm01:~/antrea/policies$ k get tiers
</span></span><span class="line"><span class="cl">NAME                          PRIORITY   AGE
</span></span><span class="line"><span class="cl">application                   <span class="m">250</span>        2d2h
</span></span><span class="line"><span class="cl">baseline                      <span class="m">253</span>        2d2h
</span></span><span class="line"><span class="cl">emergency                     <span class="m">50</span>         2d2h
</span></span><span class="line"><span class="cl">networkops                    <span class="m">150</span>        2d2h
</span></span><span class="line"><span class="cl">nsx-category-application      <span class="m">4</span>          2d
</span></span><span class="line"><span class="cl">nsx-category-emergency        <span class="m">1</span>          2d
</span></span><span class="line"><span class="cl">nsx-category-environment      <span class="m">3</span>          2d
</span></span><span class="line"><span class="cl">nsx-category-ethernet         <span class="m">0</span>          2d
</span></span><span class="line"><span class="cl">nsx-category-infrastructure   <span class="m">2</span>          2d
</span></span><span class="line"><span class="cl">platform                      <span class="m">200</span>        2d2h
</span></span><span class="line"><span class="cl">securityops                   <span class="m">100</span>        2d2h
</span></span></code></pre></div><p>These nsx* tiers are coming from the NSX manager, but can I as a cluster-owner/editor place rules in here by default? If you look at the PRIORITY of these, they are pretty low.</p>
<p>Let us apply the same rule as used earlier in this post, by just editing in the tier placement:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">crd.antrea.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterNetworkPolicy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">acnp-nsx-tier-from-kubectl</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">priority</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">tier</span><span class="p">:</span><span class="w"> </span><span class="l">nsx-category-environment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">appliedTo</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">podSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">ubuntu-20-04</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">egress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Allow</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">fqdn</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;yelb-ui.yelb.carefor.some-dns.net&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Allow</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">linuxvm01:~/antrea/policies$ k apply -f fqdn-rule-nsx-tier.yaml
</span></span><span class="line"><span class="cl">Error from server: error when creating <span class="s2">&#34;fqdn-rule-nsx-tier.yaml&#34;</span>: admission webhook <span class="s2">&#34;acnpvalidator.antrea.io&#34;</span> denied the request: user not authorized to access Tier nsx-category-environment
</span></span></code></pre></div><p>Even though I am the cluster-owner/admin/superuser I am not allowed to place any rules in these nsx tiers. So this just gives us further control and mechanisms to support both NSX created Antrea policies and Antrea policies from kubectl. This allows for a good control of security enforcement by roles in the organization.</p>


<h2 class="relative group">Antrea Dashboard 
    <div id="antrea-dashboard" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#antrea-dashboard" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>As the Octant dashboard is no more, Antrea now has its own dashboard. Its very easy to deploy. Let me quickly go through it. Read more about it <a href="https://github.com/antrea-io/antrea-ui/blob/main/docs/getting-started.md" target="_blank">here</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># Add the helm charts</span>
</span></span><span class="line"><span class="cl">helm repo add antrea https://charts.antrea.io
</span></span><span class="line"><span class="cl">helm repo update
</span></span></code></pre></div><p>Install it:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">helm install antrea-ui antrea/antrea-ui --namespace kube-system
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">linuxvm01:~/antrea/policies$ helm repo add antrea https://charts.antrea.io
</span></span><span class="line"><span class="cl"><span class="s2">&#34;antrea&#34;</span> has been added to your repositories
</span></span><span class="line"><span class="cl">linuxvm01:~/antrea/policies$ helm repo update
</span></span><span class="line"><span class="cl">Hang tight <span class="k">while</span> we grab the latest from your chart repositories...
</span></span><span class="line"><span class="cl">...Successfully got an update from the <span class="s2">&#34;ako&#34;</span> chart repository
</span></span><span class="line"><span class="cl">...Successfully got an update from the <span class="s2">&#34;antrea&#34;</span> chart repository
</span></span><span class="line"><span class="cl">...Successfully got an update from the <span class="s2">&#34;bitnami&#34;</span> chart repository
</span></span><span class="line"><span class="cl">Update Complete. Happy Helming!
</span></span><span class="line"><span class="cl">linuxvm01:~/antrea/policies$ helm install antrea-ui antrea/antrea-ui --namespace kube-system
</span></span><span class="line"><span class="cl">NAME: antrea-ui
</span></span><span class="line"><span class="cl">LAST DEPLOYED: Tue Jun  <span class="m">6</span> 12:56:21 <span class="m">2023</span>
</span></span><span class="line"><span class="cl">NAMESPACE: kube-system
</span></span><span class="line"><span class="cl">STATUS: deployed
</span></span><span class="line"><span class="cl">REVISION: <span class="m">1</span>
</span></span><span class="line"><span class="cl">TEST SUITE: None
</span></span><span class="line"><span class="cl">NOTES:
</span></span><span class="line"><span class="cl">The Antrea UI has been successfully installed
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">You are using version 0.1.1
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">To access the UI, forward a <span class="nb">local</span> port to the antrea-ui service, and connect to
</span></span><span class="line"><span class="cl">that port locally with your browser:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  $ kubectl -n kube-system port-forward service/antrea-ui 3000:3000
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">After running the <span class="nb">command</span> above, access <span class="s2">&#34;http://localhost:3000&#34;</span> in your browser.For the Antrea documentation, please visit https://antrea.io
</span></span></code></pre></div><p>This will spin up a new pod, and a clusterip service.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">linuxvm01:~/antrea/policies$ k get pods -n kube-system
</span></span><span class="line"><span class="cl">NAME                                                                    READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">antrea-agent-9rvqc                                                      2/2     Running   <span class="m">0</span>          2d16h
</span></span><span class="line"><span class="cl">antrea-agent-m7rg7                                                      2/2     Running   <span class="m">0</span>          2d16h
</span></span><span class="line"><span class="cl">antrea-agent-wvpp8                                                      2/2     Running   <span class="m">0</span>          2d16h
</span></span><span class="line"><span class="cl">antrea-controller-6d56b6d664-vlmh2                                      1/1     Running   <span class="m">0</span>          2d16h
</span></span><span class="line"><span class="cl">antrea-ui-9c89486f4-msw6m                                               2/2     Running   <span class="m">0</span>          62s
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">linuxvm01:~/antrea/policies$ k get svc -n kube-system
</span></span><span class="line"><span class="cl">NAME             TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>                  AGE
</span></span><span class="line"><span class="cl">antrea           ClusterIP   20.10.96.45     &lt;none&gt;        443/TCP                  2d16h
</span></span><span class="line"><span class="cl">antrea-ui        ClusterIP   20.10.228.144   &lt;none&gt;        3000/TCP                 95s
</span></span></code></pre></div><p>Now instead of exposing the service as nodeport, I am just creating a serviceType loadBalancer for it like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">antrea-dashboard-ui</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">antrea-ui</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-system</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">loadBalancerClass</span><span class="p">:</span><span class="w"> </span><span class="l">ako.vmware.com/avi-lb</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">LoadBalancer</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">3000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">antrea-ui</span><span class="w">
</span></span></span></code></pre></div><p>Apply it:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">linuxvm01:~/antrea$ k apply -f antrea-dashboard-lb-yaml
</span></span><span class="line"><span class="cl">service/antrea-dashboard-ui created
</span></span><span class="line"><span class="cl">linuxvm01:~/antrea$ k get svc -n kube-system
</span></span><span class="line"><span class="cl">NAME                  TYPE           CLUSTER-IP      EXTERNAL-IP    PORT<span class="o">(</span>S<span class="o">)</span>                  AGE
</span></span><span class="line"><span class="cl">antrea                ClusterIP      20.10.96.45     &lt;none&gt;         443/TCP                  2d16h
</span></span><span class="line"><span class="cl">antrea-dashboard-ui   LoadBalancer   20.10.76.243    10.13.210.12   80:31334/TCP             7s
</span></span><span class="line"><span class="cl">antrea-ui             ClusterIP      20.10.228.144   &lt;none&gt;         3000/TCP                 8m47s
</span></span></code></pre></div><p>Now access it through my browser:</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230606150616863.png"
        alt="antrea-dashboard"
      />
      
    </figure>
</p>
<p>Default password is <em>admin</em></p>
<p>Good overview:</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230606150658425.png"
        alt="overview"
      />
      
    </figure>
</p>
<p>The option to do Traceflow:</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230606150830064.png"
        alt="traceflow"
      />
      
    </figure>
</p>
<p>Oops, dropped by a NetworkPolicy&hellip; Where does that come from &#x1f914; &hellip; More on this later.</p>


<h2 class="relative group">Antrea Network Monitoring 
    <div id="antrea-network-monitoring" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#antrea-network-monitoring" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>Being able to know what&rsquo;s going on is crucial when planning security policies, but also to know if the policies are working and being enforced. With that information available we can know if we are compliant with the policies apllied. Without any network flow information we are kind of in the blind. Luckily Antrea is fully capable of report full flow information, and export it.
To be able to export the flow information we need to enable the FeatureGate FlowExporter:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">cni.tanzu.vmware.com/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">AntreaConfig</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">stc-tkg-cluster-1-antrea-package</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">ns-stc-1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">antrea</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">config</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">featureGates</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">AntreaProxy</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">EndpointSlice</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">AntreaPolicy</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">FlowExporter</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="c">#This needs to be enabled</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">Egress</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">NodePortLocal</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">AntreaTraceflow</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">NetworkPolicyStats</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span></code></pre></div>

<h3 class="relative group">Flow-Exporter - IPFIX 
    <div id="flow-exporter---ipfix" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#flow-exporter---ipfix" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>From the offical Antrea documentation:</p>
<blockquote>
<p><a href="https://antrea.io/docs/v1.12.0/docs/design/architecture/" target="_blank">Antrea</a> is a Kubernetes network plugin that provides network connectivity and security features for Pod workloads. Considering the scale and dynamism of Kubernetes workloads in a cluster, Network Flow Visibility helps in the management and configuration of Kubernetes resources such as Network Policy, Services, Pods etc., and thereby provides opportunities to enhance the performance and security aspects of Pod workloads.</p>
<p>For visualizing the network flows, Antrea monitors the flows in Linux conntrack module. These flows are converted to flow records, and then flow records are post-processed before they are sent to the configured external flow collector. High-level design is given below:</p>
</blockquote>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230607151241739.png"
        alt="flow-aggregator"
      />
      
    </figure>
</p>
<p>From the Antrea official documentation again:</p>
<blockquote>
<p><strong>Flow Exporter</strong></p>
<p>In Antrea, the basic building block for the Network Flow Visibility is the <strong>Flow Exporter</strong>. Flow Exporter operates within Antrea Agent; it builds and maintains a connection store by polling and dumping flows from conntrack module periodically. Connections from the connection store are exported to the <a href="https://antrea.io/docs/v1.12.0/docs/network-flow-visibility/#flow-aggregator" target="_blank">Flow Aggregator Service</a> using the IPFIX protocol, and for this purpose we use the IPFIX exporter process from the <a href="https://github.com/vmware/go-ipfix" target="_blank">go-ipfix</a> library.</p>
</blockquote>
<p>Read more Network Flow Visibility in Antrea <a href="https://antrea.io/docs/v1.12.0/docs/network-flow-visibility/" target="_blank">here</a>.</p>


<h3 class="relative group">Traceflow 
    <div id="traceflow" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#traceflow" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>When troubleshooting network issues or even firewall rules (is my traffic being blocked or allowed?) it is very handy to have the option to do Traceflow. Antrea supports Traceflow. To be able to use Traceflow, the AntreaTraceFlow FeatureGate needs to be enabled if not already.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">cni.tanzu.vmware.com/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">AntreaConfig</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">stc-tkg-cluster-1-antrea-package</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">ns-stc-1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">antrea</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">config</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">featureGates</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">AntreaProxy</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">EndpointSlice</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">AntreaPolicy</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">FlowExporter</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">Egress</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">NodePortLocal</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">AntreaTraceflow</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="c">#This needs to be enabled</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">NetworkPolicyStats</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span></code></pre></div><p>Now that it is enabled, how can we perform Traceflow?</p>
<p>We can do Traceflow using kubectl, Antrea UI or even from the NSX manager if using the NSX/Antrea integration.</p>
<p>Traceflow in Antrea supports the following:</p>
<ul>
<li>Source: pod, protocol (TCP/UDP/ICMP) and port numbers</li>
<li>Destination: pod, service, ip, protocol (TCP/UDP/ICMP) and port numbers</li>
<li>One time Traceflow or live</li>
</ul>
<p>Now to get back to my Antrea policies created earlier I want to test if they are actually being in use and enforced. So let me do a Traceflow form my famous Yelb-ui pod and see if it can reach the application pod on its allowed port. Remember that the UI pod needed to communicate with the appserver pod on TCP 4567 and that I created a rule that only allows this, all else is blocked.</p>
<p>If I want to do Traceflow from kubectl, this is an example to test if port 4567 is allowed from ui pod to appserver pod:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">crd.antrea.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Traceflow</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tf-test</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">source</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">yelb</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">pod</span><span class="p">:</span><span class="w"> </span><span class="l">yelb-ui-6df49457d6-m5clv</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">destination</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">yelb</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">pod</span><span class="p">:</span><span class="w"> </span><span class="l">yelb-appserver-857c5c76d5-4cd86</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># destination can also be an IP address (&#39;ip&#39; field) or a Service name (&#39;service&#39; field); the 3 choices are mutually exclusive.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">packet</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ipHeader</span><span class="p">:</span><span class="w"> </span><span class="c"># If ipHeader/ipv6Header is not set, the default value is IPv4+ICMP.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="m">6</span><span class="w"> </span><span class="c"># Protocol here can be 6 (TCP), 17 (UDP) or 1 (ICMP), default value is 1 (ICMP)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">transportHeader</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">tcp</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">srcPort</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="c"># Source port needs to be set when Protocol is TCP/UDP.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">dstPort</span><span class="p">:</span><span class="w"> </span><span class="m">4567</span><span class="w"> </span><span class="c"># Destination port needs to be set when Protocol is TCP/UDP.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">flags: 2 # Construct a SYN packet</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="l">is also the default value when the flags field is omitted.</span><span class="w">
</span></span></span></code></pre></div><p>Now apply it and get the output:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">linuxvm01:~/antrea/policies$ k apply -f traceflow.yaml
</span></span><span class="line"><span class="cl">traceflow.crd.antrea.io/tf-test created
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="l">linuxvm01:~/antrea/policies$ k get traceflows.crd.antrea.io -n yelb tf-test -oyaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">crd.antrea.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Traceflow</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">kubectl.kubernetes.io/last-applied-configuration</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">      {&#34;apiVersion&#34;:&#34;crd.antrea.io/v1alpha1&#34;,&#34;kind&#34;:&#34;Traceflow&#34;,&#34;metadata&#34;:{&#34;annotations&#34;:{},&#34;name&#34;:&#34;tf-test&#34;},&#34;spec&#34;:{&#34;destination&#34;:{&#34;namespace&#34;:&#34;yelb&#34;,&#34;pod&#34;:&#34;yelb-appserver-857c5c76d5-4cd86&#34;},&#34;packet&#34;:{&#34;ipHeader&#34;:{&#34;protocol&#34;:6},&#34;transportHeader&#34;:{&#34;tcp&#34;:{&#34;dstPort&#34;:4567,&#34;flags&#34;:2,&#34;srcPort&#34;:0}}},&#34;source&#34;:{&#34;namespace&#34;:&#34;yelb&#34;,&#34;pod&#34;:&#34;yelb-ui-6df49457d6-m5clv&#34;}}}</span><span class="w">      
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2023-06-07T12:47:14Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">generation</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tf-test</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resourceVersion</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;904386&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">uid</span><span class="p">:</span><span class="w"> </span><span class="l">c550596b-ed43-4bab-a6f1-d23e90d35f84</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">destination</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">yelb</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">pod</span><span class="p">:</span><span class="w"> </span><span class="l">yelb-appserver-857c5c76d5-4cd86</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">packet</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ipHeader</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="m">6</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">transportHeader</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">tcp</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">dstPort</span><span class="p">:</span><span class="w"> </span><span class="m">4567</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">flags</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">srcPort</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">source</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">yelb</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">pod</span><span class="p">:</span><span class="w"> </span><span class="l">yelb-ui-6df49457d6-m5clv</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">status</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">phase</span><span class="p">:</span><span class="w"> </span><span class="l">Succeeded</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">results</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">node</span><span class="p">:</span><span class="w"> </span><span class="l">stc-tkg-cluster-1-node-pool-01-p6nms-84c55d4574-5r8gj</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">observations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Received</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">component</span><span class="p">:</span><span class="w"> </span><span class="l">Forwarding</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Forwarded</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">component</span><span class="p">:</span><span class="w"> </span><span class="l">NetworkPolicy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">componentInfo</span><span class="p">:</span><span class="w"> </span><span class="l">IngressRule</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">networkPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">AntreaClusterNetworkPolicy:9ae2599a-3bd3-4413-849e-06f53f467559</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Delivered</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">component</span><span class="p">:</span><span class="w"> </span><span class="l">Forwarding</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">componentInfo</span><span class="p">:</span><span class="w"> </span><span class="l">Output</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">timestamp</span><span class="p">:</span><span class="w"> </span><span class="m">1686142036</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">node</span><span class="p">:</span><span class="w"> </span><span class="l">stc-tkg-cluster-1-node-pool-01-p6nms-84c55d4574-bpx7s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">observations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Forwarded</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">component</span><span class="p">:</span><span class="w"> </span><span class="l">SpoofGuard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Forwarded</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">component</span><span class="p">:</span><span class="w"> </span><span class="l">Forwarding</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">componentInfo</span><span class="p">:</span><span class="w"> </span><span class="l">Output</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">tunnelDstIP</span><span class="p">:</span><span class="w"> </span><span class="m">10.13.82.39</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">timestamp</span><span class="p">:</span><span class="w"> </span><span class="m">1686142036</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">startTime</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2023-06-07T12:47:14Z&#34;</span><span class="w">
</span></span></span></code></pre></div><p>That was a success. <em>- action: Forwarded</em></p>
<p>Now I want to run it again but with another port. So I change the above yaml to use port 4568 (which should not be allowed):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="l">linuxvm01:~/antrea/policies$ k get traceflows.crd.antrea.io -n yelb tf-test -oyaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">crd.antrea.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Traceflow</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">kubectl.kubernetes.io/last-applied-configuration</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">      {&#34;apiVersion&#34;:&#34;crd.antrea.io/v1alpha1&#34;,&#34;kind&#34;:&#34;Traceflow&#34;,&#34;metadata&#34;:{&#34;annotations&#34;:{},&#34;name&#34;:&#34;tf-test&#34;},&#34;spec&#34;:{&#34;destination&#34;:{&#34;namespace&#34;:&#34;yelb&#34;,&#34;pod&#34;:&#34;yelb-appserver-857c5c76d5-4cd86&#34;},&#34;packet&#34;:{&#34;ipHeader&#34;:{&#34;protocol&#34;:6},&#34;transportHeader&#34;:{&#34;tcp&#34;:{&#34;dstPort&#34;:4568,&#34;flags&#34;:2,&#34;srcPort&#34;:0}}},&#34;source&#34;:{&#34;namespace&#34;:&#34;yelb&#34;,&#34;pod&#34;:&#34;yelb-ui-6df49457d6-m5clv&#34;}}}</span><span class="w">      
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2023-06-07T12:53:59Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">generation</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tf-test</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resourceVersion</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;905571&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">uid</span><span class="p">:</span><span class="w"> </span><span class="l">d76ec419-3272-4595-98a5-72a49adce9d3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">destination</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">yelb</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">pod</span><span class="p">:</span><span class="w"> </span><span class="l">yelb-appserver-857c5c76d5-4cd86</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">packet</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ipHeader</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="m">6</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">transportHeader</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">tcp</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">dstPort</span><span class="p">:</span><span class="w"> </span><span class="m">4568</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">flags</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">srcPort</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">source</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">yelb</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">pod</span><span class="p">:</span><span class="w"> </span><span class="l">yelb-ui-6df49457d6-m5clv</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">status</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">phase</span><span class="p">:</span><span class="w"> </span><span class="l">Succeeded</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">results</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">node</span><span class="p">:</span><span class="w"> </span><span class="l">stc-tkg-cluster-1-node-pool-01-p6nms-84c55d4574-bpx7s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">observations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Forwarded</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">component</span><span class="p">:</span><span class="w"> </span><span class="l">SpoofGuard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Forwarded</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">component</span><span class="p">:</span><span class="w"> </span><span class="l">Forwarding</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">componentInfo</span><span class="p">:</span><span class="w"> </span><span class="l">Output</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">tunnelDstIP</span><span class="p">:</span><span class="w"> </span><span class="m">10.13.82.39</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">timestamp</span><span class="p">:</span><span class="w"> </span><span class="m">1686142441</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">node</span><span class="p">:</span><span class="w"> </span><span class="l">stc-tkg-cluster-1-node-pool-01-p6nms-84c55d4574-5r8gj</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">observations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Received</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">component</span><span class="p">:</span><span class="w"> </span><span class="l">Forwarding</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Dropped</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">component</span><span class="p">:</span><span class="w"> </span><span class="l">NetworkPolicy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">componentInfo</span><span class="p">:</span><span class="w"> </span><span class="l">IngressMetric</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">networkPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">AntreaClusterNetworkPolicy:9ae2599a-3bd3-4413-849e-06f53f467559</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">timestamp</span><span class="p">:</span><span class="w"> </span><span class="m">1686142441</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">startTime</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2023-06-07T12:53:59Z&#34;</span><span class="w">
</span></span></span></code></pre></div><p>That was also a success, as it was dropped by design: <em>- action: Dropped</em></p>
<p>Its great being able to do this from kubectl, if one quickly need to check this before starting to look somewhere else and create a support ticket &#x1f603; or one dont have access to other tools like the Antrea UI or even the NSX manager, speaking of NSX manager. Let us do the exact same trace from the NSX manager gui:</p>
<p>Head over Plan&amp;Troubleshoot -&gt; Traffic Analysis:</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230607145857688.png"
        alt="nsx-analysis"
      />
      
    </figure>
</p>
<p>Results:</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230607145936360.png"
        alt="nsx-result-allowed"
      />
      
    </figure>
</p>
<p>Now I change it to another port again and test it again:</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230607150027405.png"
        alt="nsx-result-dropped"
      />
      
    </figure>
</p>
<p>Dropped again.</p>
<p>The same procedure can also be done from the Antrea UI as shown above, now with a port that is allowed:</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230607150201116.png"
        alt="image-20230607150201116"
      />
      
    </figure>
</p>
<p>To read more on Traceflow in Antrea, head over <a href="https://antrea.io/docs/v1.12.0/docs/traceflow-guide/" target="_blank">here</a>.</p>


<h3 class="relative group">Theia 
    <div id="theia" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#theia" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>Now that we have know it&rsquo;s possible to export all flows using IPFIX, I thought it would be interesting to just showcase how the flow information can be presented with a solution called Theia.
From the official <a href="https://github.com/antrea-io/theia" target="_blank">docs</a>:</p>
<blockquote>
<p>Theia is a network observability and analytics platform for Kubernetes. It is built on top of <a href="https://github.com/antrea-io/antrea" target="_blank">Antrea</a>, and consumes <a href="https://github.com/antrea-io/antrea/blob/main/docs/network-flow-visibility.md" target="_blank">network flows exported by Antrea</a> to provide fine-grained visibility into the communication and NetworkPolicies among Pods and Services in a Kubernetes cluster.</p>
</blockquote>
<p>To install Theia I have followed the instructions from <a href="https://github.com/antrea-io/theia/blob/main/docs/getting-started.md" target="_blank">here</a> which is also a greate place to read more about Theia.</p>
<p>Theia is installed using Helm, start by adding the charts, do an update and deploy:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">linuxvm01:~/antrea$ helm repo add antrea https://charts.antrea.io
</span></span><span class="line"><span class="cl"><span class="s2">&#34;antrea&#34;</span> already exists with the same configuration, skipping
</span></span><span class="line"><span class="cl">linuxvm01:~/antrea$ helm repo update
</span></span><span class="line"><span class="cl">Hang tight <span class="k">while</span> we grab the latest from your chart repositories...
</span></span><span class="line"><span class="cl">...Successfully got an update from the <span class="s2">&#34;antrea&#34;</span> chart repository
</span></span><span class="line"><span class="cl">Update Complete. Happy Helming!
</span></span></code></pre></div><p>Make sure that FlowExporter has been enabled, if not apply an AntreaConfig that enables it:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">cni.tanzu.vmware.com/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">AntreaConfig</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">stc-tkg-cluster-1-antrea-package</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">ns-stc-1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">antrea</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">config</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">featureGates</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">AntreaProxy</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">EndpointSlice</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">AntreaPolicy</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">FlowExporter</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="c">#Enable this!</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">Egress</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">NodePortLocal</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">AntreaTraceflow</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">NetworkPolicyStats</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span></code></pre></div><p>After the config has been enabled, delete the Antrea agents and controller so these will read the new configMap:</p>
<pre tabindex="0"><code>linuxvm01:~/antrea/theia$ k delete pod -n kube-system -l app=antrea
pod &#34;antrea-agent-58nn2&#34; deleted
pod &#34;antrea-agent-cnq9p&#34; deleted
pod &#34;antrea-agent-sx6vr&#34; deleted
pod &#34;antrea-controller-6d56b6d664-km64t&#34; deleted
</code></pre><p>After the Helm charts have been added, I start by installing the Flow Aggregator</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">helm install flow-aggregator antrea/flow-aggregator --set clickHouse.enable<span class="o">=</span>true,recordContents.podLabels<span class="o">=</span><span class="nb">true</span> -n flow-aggregator --create-namespace
</span></span></code></pre></div><p>As usual with Helm charts, if there is any specific settings you would like to change get the helm chart values for your specific charts first and refer to them by using -f values.yaml..</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">linuxvm01:~/antrea/theia$ helm show values antrea/flow-aggregator &gt; flow-agg-values.yaml
</span></span></code></pre></div><p>I dont have any specifics I need to change for this one, so I will just deploy using the defaults:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">linuxvm01:~/antrea/theia$ helm install flow-aggregator antrea/flow-aggregator --set clickHouse.enable<span class="o">=</span>true,recordContents.podLabels<span class="o">=</span><span class="nb">true</span> -n flow-aggregator --create-namespace
</span></span><span class="line"><span class="cl">NAME: flow-aggregator
</span></span><span class="line"><span class="cl">LAST DEPLOYED: Tue Jun  <span class="m">6</span> 21:28:49 <span class="m">2023</span>
</span></span><span class="line"><span class="cl">NAMESPACE: flow-aggregator
</span></span><span class="line"><span class="cl">STATUS: deployed
</span></span><span class="line"><span class="cl">REVISION: <span class="m">1</span>
</span></span><span class="line"><span class="cl">TEST SUITE: None
</span></span><span class="line"><span class="cl">NOTES:
</span></span><span class="line"><span class="cl">The Antrea Flow Aggregator has been successfully installed
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">You are using version 1.12.0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">For the Antrea documentation, please visit https://antrea.io
</span></span></code></pre></div><p>Now what has happened in my TKG cluster:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">linuxvm01:~/antrea/theia$ k get pods -n flow-aggregator
</span></span><span class="line"><span class="cl">NAME                               READY   STATUS    RESTARTS      AGE
</span></span><span class="line"><span class="cl">flow-aggregator-5b4c69885f-mklm5   1/1     Running   <span class="m">1</span> <span class="o">(</span>10s ago<span class="o">)</span>   22s
</span></span><span class="line"><span class="cl">linuxvm01:~/antrea/theia$ k get pods -n flow-aggregator
</span></span><span class="line"><span class="cl">NAME                               READY   STATUS    RESTARTS      AGE
</span></span><span class="line"><span class="cl">flow-aggregator-5b4c69885f-mklm5   1/1     Running   <span class="m">1</span> <span class="o">(</span>13s ago<span class="o">)</span>   25s
</span></span><span class="line"><span class="cl">linuxvm01:~/antrea/theia$ k get pods -n flow-aggregator
</span></span><span class="line"><span class="cl">NAME                               READY   STATUS   RESTARTS      AGE
</span></span><span class="line"><span class="cl">flow-aggregator-5b4c69885f-mklm5   0/1     Error    <span class="m">1</span> <span class="o">(</span>14s ago<span class="o">)</span>   26s
</span></span><span class="line"><span class="cl">linuxvm01:~/antrea/theia$ k get pods -n flow-aggregator
</span></span><span class="line"><span class="cl">NAME                               READY   STATUS   RESTARTS      AGE
</span></span><span class="line"><span class="cl">flow-aggregator-5b4c69885f-mklm5   0/1     CrashLoopBackOff    <span class="m">3</span> <span class="o">(</span>50s ago<span class="o">)</span>   60s
</span></span></code></pre></div><p>Well, that did&rsquo;nt go so well&hellip;</p>
<p>The issue is that Flow Aggregator is looking for a service that is not created yet and will just fail until this is deployed. This is our next step.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">linuxvm01:~/antrea/theia$ helm install theia antrea/theia --set sparkOperator.enable<span class="o">=</span>true,theiaManager.enable<span class="o">=</span><span class="nb">true</span> -n flow-visibility --create-namespace
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">NAME: theia
</span></span><span class="line"><span class="cl">LAST DEPLOYED: Tue Jun  <span class="m">6</span> 22:02:37 <span class="m">2023</span>
</span></span><span class="line"><span class="cl">NAMESPACE: flow-visibility
</span></span><span class="line"><span class="cl">STATUS: deployed
</span></span><span class="line"><span class="cl">REVISION: <span class="m">1</span>
</span></span><span class="line"><span class="cl">TEST SUITE: None
</span></span><span class="line"><span class="cl">NOTES:
</span></span><span class="line"><span class="cl">Theia has been successfully installed
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">You are using version 0.6.0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">For the Antrea documentation, please visit https://antrea.io
</span></span></code></pre></div><p>What has been created now:</p>
<pre tabindex="0"><code>linuxvm01:~/antrea/theia$ k get pods -n flow-visibility
NAME                                    READY   STATUS    RESTARTS   AGE
chi-clickhouse-clickhouse-0-0-0         2/2     Running   0          8m52s
grafana-684d8948b-c6wzn                 1/1     Running   0          8m56s
theia-manager-5d8d6b86b7-cbxrz          1/1     Running   0          8m56s
theia-spark-operator-54d9ddd544-nqhqd   1/1     Running   0          8m56s
zookeeper-0                             1/1     Running   0          8m56s
</code></pre><p>Now flow-aggreator should also be in a runing state, if not just delete the pod and it should get back on its feet.</p>
<pre tabindex="0"><code>linuxvm01:~/antrea/theia$ k get pods -n flow-aggregator
NAME                               READY   STATUS    RESTARTS   AGE
flow-aggregator-5b4c69885f-xhdkx   1/1     Running   0          5m2s
</code></pre><p>So, now its all about getting access to the Grafana dashboard. I will just expose this with serviceType loadBalancer as it &ldquo;out-of-the-box&rdquo; is only exposed with NodePort:</p>
<pre tabindex="0"><code>linuxvm01:~/antrea/theia$ k get svc -n flow-visibility
NAME                            TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                      AGE
chi-clickhouse-clickhouse-0-0   ClusterIP   None            &lt;none&gt;        8123/TCP,9000/TCP,9009/TCP   8m43s
clickhouse-clickhouse           ClusterIP   20.10.136.211   &lt;none&gt;        8123/TCP,9000/TCP            10m
grafana                         NodePort    20.10.172.165   &lt;none&gt;        3000:30096/TCP               10m
theia-manager                   ClusterIP   20.10.156.217   &lt;none&gt;        11347/TCP                    10m
zookeeper                       ClusterIP   20.10.219.137   &lt;none&gt;        2181/TCP,7000/TCP            10m
zookeepers                      ClusterIP   None            &lt;none&gt;        2888/TCP,3888/TCP            10m
</code></pre><p>So let us create a LoadBalancer service for this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">theia-dashboard-ui</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">grafana</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">flow-visibility</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">loadBalancerClass</span><span class="p">:</span><span class="w"> </span><span class="l">ako.vmware.com/avi-lb</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">LoadBalancer</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">3000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">grafana</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">linuxvm01:~/antrea/theia$ k get svc -n flow-visibility
</span></span><span class="line"><span class="cl">NAME                            TYPE           CLUSTER-IP      EXTERNAL-IP    PORT<span class="o">(</span>S<span class="o">)</span>                      grafana                         NodePort       20.10.172.165   &lt;none&gt;         3000:30096/TCP               15m
</span></span><span class="line"><span class="cl">theia-dashboard-ui              LoadBalancer   20.10.24.174    10.13.210.13   80:32075/TCP                 13s
</span></span></code></pre></div><p>Lets try to access it through the browser:</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230607002029280.png"
        alt="grafana"
      />
      
    </figure>
</p>
<p>Great. Theia comes with a couple of predefined dashobards that is interesting to start out with. So let me list some of the screenshots from the predefined dashboards below:</p>
<p>The homepage:</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230607135955671.png"
        alt="homepage"
      />
      
    </figure>
</p>
<p>List of dashboards:</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230607140048040.png"
        alt="list"
      />
      
    </figure>
</p>
<p>Flow_Records_Dashboard:</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230607140130974.png"
        alt="flow-records"
      />
      
    </figure>
</p>
<p>Network_Topology_Dashboard:</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230607010946649.png"
        alt="network-toplogy"
      />
      
    </figure>
</p>


<h3 class="relative group">Network Policy Recommendation 
    <div id="network-policy-recommendation" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#network-policy-recommendation" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>From the official <a href="https://github.com/antrea-io/theia/blob/main/docs/networkpolicy-recommendation.md" target="_blank">docs</a>:</p>
<blockquote>
<p>Theia NetworkPolicy Recommendation recommends the NetworkPolicy configuration to secure Kubernetes network and applications. It analyzes the network flows collected by <a href="https://github.com/antrea-io/theia/blob/main/docs/network-flow-visibility.md#grafana-flow-collector" target="_blank">Grafana Flow Collector</a> to generate <a href="https://kubernetes.io/docs/concepts/services-networking/network-policies/" target="_blank">Kubernetes NetworkPolicies</a> or <a href="https://github.com/antrea-io/antrea/blob/main/docs/antrea-network-policy.md" target="_blank">Antrea NetworkPolicies</a>. This feature assists cluster administrators and app developers in securing their applications according to Zero Trust principles.</p>
</blockquote>
<p>I like the sound of that. Let us try it out.</p>
<p>The first I need to install inst the Theia CLI, this can be found and the instructions from <a href="https://github.com/antrea-io/theia/blob/main/docs/theia-cli.md" target="_blank">here</a></p>
<p><strong>Theia CLI</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">curl -Lo ./theia <span class="s2">&#34;https://github.com/antrea-io/theia/releases/download/v0.6.0/theia-</span><span class="k">$(</span>uname<span class="k">)</span><span class="s2">-x86_64&#34;</span>
</span></span><span class="line"><span class="cl">chmod +x ./theia
</span></span><span class="line"><span class="cl">mv ./theia /usr/local/bin/theia
</span></span><span class="line"><span class="cl">theia <span class="nb">help</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">linuxvm01:~/antrea/theia$ curl -Lo ./theia <span class="s2">&#34;https://github.com/antrea-io/theia/releases/download/v0.6.0/theia-</span><span class="k">$(</span>uname<span class="k">)</span><span class="s2">-x86_64&#34;</span>
</span></span><span class="line"><span class="cl">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
</span></span><span class="line"><span class="cl">                                 Dload  Upload   Total   Spent    Left  Speed
</span></span><span class="line"><span class="cl">  <span class="m">0</span>     <span class="m">0</span>    <span class="m">0</span>     <span class="m">0</span>    <span class="m">0</span>     <span class="m">0</span>      <span class="m">0</span>      <span class="m">0</span> --:--:-- --:--:-- --:--:--     <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="m">100</span> 37.9M  <span class="m">100</span> 37.9M    <span class="m">0</span>     <span class="m">0</span>  11.6M      <span class="m">0</span>  0:00:03  0:00:03 --:--:-- 17.2M
</span></span><span class="line"><span class="cl">linuxvm01:~/antrea/theia$ chmod +x ./theia
</span></span><span class="line"><span class="cl">linuxvm01:~/antrea/theia$ sudo cp theia /usr/local/bin/theia
</span></span><span class="line"><span class="cl">linuxvm01:~/antrea/theia$ theia <span class="nb">help</span>
</span></span><span class="line"><span class="cl">theia is the <span class="nb">command</span> line tool <span class="k">for</span> Theia which provides access
</span></span><span class="line"><span class="cl">to Theia network flow visibility capabilities
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Usage:
</span></span><span class="line"><span class="cl">  theia <span class="o">[</span>command<span class="o">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Available Commands:
</span></span><span class="line"><span class="cl">  clickhouse                   Commands of Theia ClickHouse feature
</span></span><span class="line"><span class="cl">  completion                   Generate the autocompletion script <span class="k">for</span> the specified shell
</span></span><span class="line"><span class="cl">  <span class="nb">help</span>                         Help about any <span class="nb">command</span>
</span></span><span class="line"><span class="cl">  policy-recommendation        Commands of Theia policy recommendation feature
</span></span><span class="line"><span class="cl">  supportbundle                Generate support bundle
</span></span><span class="line"><span class="cl">  throughput-anomaly-detection Commands of Theia throughput anomaly detection feature
</span></span><span class="line"><span class="cl">  version                      Show Theia CLI version
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Flags:
</span></span><span class="line"><span class="cl">  -h, --help                <span class="nb">help</span> <span class="k">for</span> theia
</span></span><span class="line"><span class="cl">  -k, --kubeconfig string   absolute path to the k8s config file, will use <span class="nv">$KUBECONFIG</span> <span class="k">if</span> not specified
</span></span><span class="line"><span class="cl">  -v, --verbose int         <span class="nb">set</span> verbose level
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Use <span class="s2">&#34;theia [command] --help&#34;</span> <span class="k">for</span> more information about a command.
</span></span></code></pre></div><p>These are the following commands when running the policy-recommendation option:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@linuxvm01:~/antrea/theia$ theia policy-recommendation --help
</span></span><span class="line"><span class="cl">Command group of Theia policy recommendation feature.
</span></span><span class="line"><span class="cl">Must specify a subcommand like run, status or retrieve.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Usage:
</span></span><span class="line"><span class="cl">  theia policy-recommendation <span class="o">[</span>flags<span class="o">]</span>
</span></span><span class="line"><span class="cl">  theia policy-recommendation <span class="o">[</span>command<span class="o">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Aliases:
</span></span><span class="line"><span class="cl">  policy-recommendation, pr
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Available Commands:
</span></span><span class="line"><span class="cl">  delete      Delete a policy recommendation job
</span></span><span class="line"><span class="cl">  list        List all policy recommendation <span class="nb">jobs</span>
</span></span><span class="line"><span class="cl">  retrieve    Get the recommendation result of a policy recommendation job
</span></span><span class="line"><span class="cl">  run         Run a new policy recommendation job
</span></span><span class="line"><span class="cl">  status      Check the status of a policy recommendation job
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Use <span class="s2">&#34;theia policy-recommendation [command] --help&#34;</span> <span class="k">for</span> more information about a command.
</span></span></code></pre></div><p>These are the options for the <em>run</em> command:</p>
<pre tabindex="0"><code class="language-bash@" data-lang="bash@">linuxvm01:~/antrea/theia$ theia policy-recommendation run --help
Run a new policy recommendation job.
Must finish the deployment of Theia first

Usage:
  theia policy-recommendation run [flags]

Examples:
Run a policy recommendation job with default configuration
$ theia policy-recommendation run
Run an initial policy recommendation job with policy type anp-deny-applied and limit on last 10k flow records
$ theia policy-recommendation run --type initial --policy-type anp-deny-applied --limit 10000
Run an initial policy recommendation job with policy type anp-deny-applied and limit on flow records from 2022-01-01 00:00:00 to 2022-01-31 23:59:59.
$ theia policy-recommendation run --type initial --policy-type anp-deny-applied --start-time &#39;2022-01-01 00:00:00&#39; --end-time &#39;2022-01-31 23:59:59&#39;
Run a policy recommendation job with default configuration but doesn&#39;t recommend toServices ANPs
$ theia policy-recommendation run --to-services=false


Flags:
      --driver-core-request string     Specify the CPU request for the driver Pod. Values conform to the Kubernetes resource quantity convention.
                                       Example values include 0.1, 500m, 1.5, 5, etc. (default &#34;200m&#34;)
      --driver-memory string           Specify the memory request for the driver Pod. Values conform to the Kubernetes resource quantity convention.
                                       Example values include 512M, 1G, 8G, etc. (default &#34;512M&#34;)
  -e, --end-time string                The end time of the flow records considered for the policy recommendation.
                                       Format is YYYY-MM-DD hh:mm:ss in UTC timezone. No limit of the end time of flow records by default.
      --exclude-labels                 Enable this option will exclude automatically generated Pod labels including &#39;pod-template-hash&#39;,
                                       &#39;controller-revision-hash&#39;, &#39;pod-template-generation&#39; during policy recommendation. (default true)
      --executor-core-request string   Specify the CPU request for the executor Pod. Values conform to the Kubernetes resource quantity convention.
                                       Example values include 0.1, 500m, 1.5, 5, etc. (default &#34;200m&#34;)
      --executor-instances int32       Specify the number of executors for the Spark application. Example values include 1, 2, 8, etc. (default 1)
      --executor-memory string         Specify the memory request for the executor Pod. Values conform to the Kubernetes resource quantity convention.
                                       Example values include 512M, 1G, 8G, etc. (default &#34;512M&#34;)
  -f, --file string                    The file path where you want to save the result. It can only be used when wait is enabled.
  -h, --help                           help for run
  -l, --limit int                      The limit on the number of flow records read from the database. 0 means no limit.
  -n, --ns-allow-list string           List of default allow Namespaces.
                                       If no Namespaces provided, Traffic inside Antrea CNI related Namespaces: [&#39;kube-system&#39;, &#39;flow-aggregator&#39;,
                                       &#39;flow-visibility&#39;] will be allowed by default.
  -p, --policy-type string             Types of generated NetworkPolicy.
                                       Currently we have 3 generated NetworkPolicy types:
                                       anp-deny-applied: Recommending allow ANP/ACNP policies, with default deny rules only on Pods which have an allow rule applied.
                                       anp-deny-all: Recommending allow ANP/ACNP policies, with default deny rules for whole cluster.
                                       k8s-np: Recommending allow K8s NetworkPolicies. (default &#34;anp-deny-applied&#34;)
  -s, --start-time string              The start time of the flow records considered for the policy recommendation.
                                       Format is YYYY-MM-DD hh:mm:ss in UTC timezone. No limit of the start time of flow records by default.
      --to-services                    Use the toServices feature in ANP and recommendation toServices rules for Pod-to-Service flows,
                                       only works when option is anp-deny-applied or anp-deny-all. (default true)
  -t, --type string                    {initial|subsequent} Indicates this recommendation is an initial recommendion or a subsequent recommendation job. (default &#34;initial&#34;)
      --wait                           Enable this option will hold and wait the whole policy recommendation job finishes.

Global Flags:
  -k, --kubeconfig string   absolute path to the k8s config file, will use $KUBECONFIG if not specified
      --use-cluster-ip      Enable this option will use ClusterIP instead of port forwarding when connecting to the Theia
                            Manager Service. It can only be used when running in cluster.
  -v, --verbose int         set verbose level
</code></pre><p>I will just run the following <em>theia policy-recommendation run &ndash;type initial &ndash;policy-type anp-deny-applied &ndash;limit 10000</em> to generate some output.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">linuxvm01:~/antrea/theia$ theia policy-recommendation run --type initial --policy-type anp-deny-applied --limit <span class="m">10000</span>
</span></span><span class="line"><span class="cl">Successfully created policy recommendation job with name pr-e81a42e4-013a-4cf6-be43-b1ee48ea9a18
</span></span></code></pre></div><p>Lets check the status:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># First I will list all the runs to get the name</span>
</span></span><span class="line"><span class="cl">linuxvm01:~/antrea/theia$ theia policy-recommendation list
</span></span><span class="line"><span class="cl">CreationTime        CompletionTime Name                                    Status
</span></span><span class="line"><span class="cl">2023-06-08 07:50:28 N/A            pr-e81a42e4-013a-4cf6-be43-b1ee48ea9a18 SCHEDULED
</span></span><span class="line"><span class="cl"><span class="c1"># Then I will check the status on the specific run</span>
</span></span><span class="line"><span class="cl">linuxvm01:~/antrea/theia$ theia policy-recommendation status pr-e81a42e4-013a-4cf6-be43-b1ee48ea9a18
</span></span><span class="line"><span class="cl">Status of this policy recommendation job is SCHEDULED
</span></span></code></pre></div><p>Seems like I have to wait some, time to grab a coffee.</p>
<p>Just poured my coffee, wanted to check again:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">linuxvm01:~/antrea/theia$ theia policy-recommendation status pr-e81a42e4-013a-4cf6-be43-b1ee48ea9a18
</span></span><span class="line"><span class="cl">Status of this policy recommendation job is RUNNING: 0/1 <span class="o">(</span>0%<span class="o">)</span> stages completed
</span></span></code></pre></div><p>Alright, it is running.</p>
<p>Now time to drink the coffee.</p>
<p>Lets check in on it again:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">linuxvm01:~/antrea/theia$ theia policy-recommendation status pr-e81a42e4-013a-4cf6-be43-b1ee48ea9a18
</span></span><span class="line"><span class="cl">Status of this policy recommendation job is COMPLETED
</span></span></code></pre></div><p>Oh yes, now I am excited which policies it recommends:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="l">linuxvm01:~/antrea/theia$ theia policy-recommendation retrieve pr-e81a42e4-013a-4cf6-be43-b1ee48ea9a18</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">crd.antrea.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterNetworkPolicy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">recommend-reject-acnp-9np4b</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">appliedTo</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">namespaceSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">kubernetes.io/metadata.name</span><span class="p">:</span><span class="w"> </span><span class="l">yelb</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">podSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">traffic-generator</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">egress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Reject</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">podSelector</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ingress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Reject</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">podSelector</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">priority</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">tier</span><span class="p">:</span><span class="w"> </span><span class="l">Baseline</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">crd.antrea.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterNetworkPolicy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">recommend-reject-acnp-ega4b</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">appliedTo</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">namespaceSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">kubernetes.io/metadata.name</span><span class="p">:</span><span class="w"> </span><span class="l">avi-system</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">podSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app.kubernetes.io/instance</span><span class="p">:</span><span class="w"> </span><span class="l">ako-1685884771</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app.kubernetes.io/name</span><span class="p">:</span><span class="w"> </span><span class="l">ako</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">statefulset.kubernetes.io/pod-name</span><span class="p">:</span><span class="w"> </span><span class="l">ako-0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">egress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Reject</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">podSelector</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ingress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Reject</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">podSelector</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">priority</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">tier</span><span class="p">:</span><span class="w"> </span><span class="l">Baseline</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">crd.antrea.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">NetworkPolicy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">recommend-allow-anp-nl6re</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">yelb</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">appliedTo</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">podSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">traffic-generator</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">egress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Allow</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">ipBlock</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">cidr</span><span class="p">:</span><span class="w"> </span><span class="m">10.13.210.10</span><span class="l">/32</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ingress</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">priority</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">tier</span><span class="p">:</span><span class="w"> </span><span class="l">Application</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">crd.antrea.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">NetworkPolicy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">recommend-allow-anp-2ifjo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">avi-system</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">appliedTo</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">podSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app.kubernetes.io/instance</span><span class="p">:</span><span class="w"> </span><span class="l">ako-1685884771</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app.kubernetes.io/name</span><span class="p">:</span><span class="w"> </span><span class="l">ako</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">statefulset.kubernetes.io/pod-name</span><span class="p">:</span><span class="w"> </span><span class="l">ako-0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">egress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Allow</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">443</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">ipBlock</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">cidr</span><span class="p">:</span><span class="w"> </span><span class="m">172.24.3.50</span><span class="l">/32</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ingress</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">priority</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">tier</span><span class="p">:</span><span class="w"> </span><span class="l">Application</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">crd.antrea.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterNetworkPolicy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">recommend-allow-acnp-kube-system-kaoh6</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">appliedTo</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">namespaceSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">kubernetes.io/metadata.name</span><span class="p">:</span><span class="w"> </span><span class="l">kube-system</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">egress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Allow</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">podSelector</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ingress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Allow</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">podSelector</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">priority</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">tier</span><span class="p">:</span><span class="w"> </span><span class="l">Platform</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">crd.antrea.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterNetworkPolicy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">recommend-allow-acnp-flow-aggregator-dnvhc</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">appliedTo</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">namespaceSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">kubernetes.io/metadata.name</span><span class="p">:</span><span class="w"> </span><span class="l">flow-aggregator</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">egress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Allow</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">podSelector</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ingress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Allow</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">podSelector</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">priority</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">tier</span><span class="p">:</span><span class="w"> </span><span class="l">Platform</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">crd.antrea.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterNetworkPolicy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">recommend-allow-acnp-flow-visibility-sqjwf</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">appliedTo</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">namespaceSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">kubernetes.io/metadata.name</span><span class="p">:</span><span class="w"> </span><span class="l">flow-visibility</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">egress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Allow</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">podSelector</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ingress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Allow</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">podSelector</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">priority</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">tier</span><span class="p">:</span><span class="w"> </span><span class="l">Platform</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">crd.antrea.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterNetworkPolicy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">recommend-reject-acnp-hmjt8</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">appliedTo</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">namespaceSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">kubernetes.io/metadata.name</span><span class="p">:</span><span class="w"> </span><span class="l">yelb-2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">podSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">yelb-ui</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">tier</span><span class="p">:</span><span class="w"> </span><span class="l">frontend</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">egress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Reject</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">podSelector</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ingress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Reject</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">podSelector</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">priority</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">tier</span><span class="p">:</span><span class="w"> </span><span class="l">Baseline</span><span class="w">
</span></span></span></code></pre></div><p>Ok, well. I appreciate the output, but I would need to do some modifications to it before I would apply it. As my lab is not generating that much traffic, it does not create all the flows needed to generate a better recommendation. For it to generate better recommendations, the flows also needs to be there. My traffic-generator is not doing a good job to achieve this.
I will need to generate some more activity for the recommendation engine to get enough flows to consider.</p>


<h3 class="relative group">Throughput Anomaly Detection 
    <div id="throughput-anomaly-detection" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#throughput-anomaly-detection" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>From the offical <a href="https://github.com/antrea-io/theia/blob/main/docs/throughput-anomaly-detection.md" target="_blank">docs</a>:</p>
<blockquote>
<p>From Theia v0.5, Theia supports Throughput Anomaly Detection. Throughput Anomaly Detection (TAD) is a technique for understanding and reporting the throughput abnormalities in the network traffic. It analyzes the network flows collected by <a href="https://github.com/antrea-io/theia/blob/main/docs/network-flow-visibility.md#grafana-flow-collector" target="_blank">Grafana Flow Collector</a> to report anomalies in the network. TAD uses three algorithms to find the anomalies in network flows such as ARIMA, EWMA, and DBSCAN. These anomaly analyses help the user to find threats if present.</p>
</blockquote>
<p>Lets try it out. I already have the dependencies and Theia CLI installed.</p>
<p>What is the different commands available:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">linuxvm01:~/antrea/theia$ theia throughput-anomaly-detection --help
</span></span><span class="line"><span class="cl">Command group of Theia throughput anomaly detection feature.
</span></span><span class="line"><span class="cl">	Must specify a subcommand like run, list, delete, status or retrieve
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Usage:
</span></span><span class="line"><span class="cl">  theia throughput-anomaly-detection <span class="o">[</span>flags<span class="o">]</span>
</span></span><span class="line"><span class="cl">  theia throughput-anomaly-detection <span class="o">[</span>command<span class="o">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Aliases:
</span></span><span class="line"><span class="cl">  throughput-anomaly-detection, tad
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Available Commands:
</span></span><span class="line"><span class="cl">  delete      Delete a anomaly detection job
</span></span><span class="line"><span class="cl">  list        List all anomaly detection <span class="nb">jobs</span>
</span></span><span class="line"><span class="cl">  retrieve    Get the result of an anomaly detection job
</span></span><span class="line"><span class="cl">  run         throughput anomaly detection using Algo
</span></span><span class="line"><span class="cl">  status      Check the status of a anomaly detection job
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Flags:
</span></span><span class="line"><span class="cl">  -h, --help             <span class="nb">help</span> <span class="k">for</span> throughput-anomaly-detection
</span></span><span class="line"><span class="cl">      --use-cluster-ip   Enable this option will use ClusterIP instead of port forwarding when connecting to the Theia
</span></span><span class="line"><span class="cl">                         Manager Service. It can only be used when running in cluster.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Global Flags:
</span></span><span class="line"><span class="cl">  -k, --kubeconfig string   absolute path to the k8s config file, will use <span class="nv">$KUBECONFIG</span> <span class="k">if</span> not specified
</span></span><span class="line"><span class="cl">  -v, --verbose int         <span class="nb">set</span> verbose level
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Use <span class="s2">&#34;theia throughput-anomaly-detection [command] --help&#34;</span> <span class="k">for</span> more information about a command.
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">linuxvm01:~/antrea/theia$ theia throughput-anomaly-detection run --help
</span></span><span class="line"><span class="cl">throughput anomaly detection using algorithms, currently supported algorithms are EWMA, ARIMA and DBSCAN
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Usage:
</span></span><span class="line"><span class="cl">  theia throughput-anomaly-detection run <span class="o">[</span>flags<span class="o">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Examples:
</span></span><span class="line"><span class="cl">Run the specific algorithm <span class="k">for</span> throughput anomaly detection
</span></span><span class="line"><span class="cl">	$ theia throughput-anomaly-detection run --algo ARIMA --start-time 2022-01-01T00:00:00 --end-time 2022-01-31T23:59:59
</span></span><span class="line"><span class="cl">	Run throughput anomaly detection algorithm of <span class="nb">type</span> ARIMA and limit on flow records from <span class="s1">&#39;2022-01-01 00:00:00&#39;</span> to <span class="s1">&#39;2022-01-31 23:59:59&#39;</span>
</span></span><span class="line"><span class="cl">	Please note, algo is a mandatory argument<span class="err">&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Flags:
</span></span><span class="line"><span class="cl">  -a, --algo string                    The algorithm used by throughput anomaly detection.
</span></span><span class="line"><span class="cl">                                       		Currently supported Algorithms are EWMA, ARIMA and DBSCAN.
</span></span><span class="line"><span class="cl">      --driver-core-request string     Specify the CPU request <span class="k">for</span> the driver Pod. Values conform to the Kubernetes resource quantity convention.
</span></span><span class="line"><span class="cl">                                       Example values include 0.1, 500m, 1.5, 5, etc. <span class="o">(</span>default <span class="s2">&#34;200m&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">      --driver-memory string           Specify the memory request <span class="k">for</span> the driver Pod. Values conform to the Kubernetes resource quantity convention.
</span></span><span class="line"><span class="cl">                                       Example values include 512M, 1G, 8G, etc. <span class="o">(</span>default <span class="s2">&#34;512M&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">  -e, --end-time string                The end <span class="nb">time</span> of the flow records considered <span class="k">for</span> the anomaly detection.
</span></span><span class="line"><span class="cl">                                       Format is YYYY-MM-DD hh:mm:ss in UTC timezone. No limit of the end <span class="nb">time</span> of flow records by default.
</span></span><span class="line"><span class="cl">      --executor-core-request string   Specify the CPU request <span class="k">for</span> the executor Pod. Values conform to the Kubernetes resource quantity convention.
</span></span><span class="line"><span class="cl">                                       Example values include 0.1, 500m, 1.5, 5, etc. <span class="o">(</span>default <span class="s2">&#34;200m&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">      --executor-instances int32       Specify the number of executors <span class="k">for</span> the Spark application. Example values include 1, 2, 8, etc. <span class="o">(</span>default 1<span class="o">)</span>
</span></span><span class="line"><span class="cl">      --executor-memory string         Specify the memory request <span class="k">for</span> the executor Pod. Values conform to the Kubernetes resource quantity convention.
</span></span><span class="line"><span class="cl">                                       Example values include 512M, 1G, 8G, etc. <span class="o">(</span>default <span class="s2">&#34;512M&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">  -h, --help                           <span class="nb">help</span> <span class="k">for</span> run
</span></span><span class="line"><span class="cl">  -n, --ns-ignore-list string          List of default drop Namespaces. Use this to ignore traffic from selected namespaces
</span></span><span class="line"><span class="cl">                                       If no Namespaces provided, Traffic from all namespaces present in flows table will be allowed by default.
</span></span><span class="line"><span class="cl">  -s, --start-time string              The start <span class="nb">time</span> of the flow records considered <span class="k">for</span> the anomaly detection.
</span></span><span class="line"><span class="cl">                                       Format is YYYY-MM-DD hh:mm:ss in UTC timezone. No limit of the start <span class="nb">time</span> of flow records by default.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Global Flags:
</span></span><span class="line"><span class="cl">  -k, --kubeconfig string   absolute path to the k8s config file, will use <span class="nv">$KUBECONFIG</span> <span class="k">if</span> not specified
</span></span><span class="line"><span class="cl">      --use-cluster-ip      Enable this option will use ClusterIP instead of port forwarding when connecting to the Theia
</span></span><span class="line"><span class="cl">                            Manager Service. It can only be used when running in cluster.
</span></span><span class="line"><span class="cl">  -v, --verbose int         <span class="nb">set</span> verbose level
</span></span></code></pre></div><p>I will use the example above:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">linuxvm01:~/antrea/theia$ theia throughput-anomaly-detection run --algo ARIMA --start-time 2023-06-06T00:00:00 --end-time 2023-06-08T09:00:00
</span></span><span class="line"><span class="cl">Successfully started Throughput Anomaly Detection job with name: tad-2ecb054a-8c0d-4ae1-8444-c3493e7bb6d9
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">linuxvm01:~/antrea/theia$ theia throughput-anomaly-detection list
</span></span><span class="line"><span class="cl">CreationTime        CompletionTime Name                                     Status
</span></span><span class="line"><span class="cl">2023-06-08 08:25:10 N/A            tad-2ecb054a-8c0d-4ae1-8444-c3493e7bb6d9 RUNNING
</span></span><span class="line"><span class="cl">linuxvm01:~/antrea/theia$ theia throughput-anomaly-detection status tad-2ecb054a-8c0d-4ae1-8444-c3493e7bb6d9
</span></span><span class="line"><span class="cl">Status of this anomaly detection job is RUNNING: 0/0 <span class="o">(</span>0%<span class="o">)</span> stages completed
</span></span></code></pre></div><p>Lets wait for it to finish&hellip;</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">linuxvm01:~$ theia throughput-anomaly-detection list
</span></span><span class="line"><span class="cl">CreationTime        CompletionTime      Name                                     Status
</span></span><span class="line"><span class="cl">2023-06-08 08:25:10 2023-06-08 08:40:03 tad-2ecb054a-8c0d-4ae1-8444-c3493e7bb6d9 COMPLETED
</span></span></code></pre></div><p>Now check the output:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># It is a long list so I am piping it to a text file</span>
</span></span><span class="line"><span class="cl">linuxvm01:~$ theia throughput-anomaly-detection retrieve tad-2ecb054a-8c0d-4ae1-8444-c3493e7bb6d9 &gt; anomaly-detection-1.txt
</span></span></code></pre></div><p>A snippet from the output:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">id                                      sourceIP        sourceTransportPort     destinationIP   destinationTransportPort        flowStartSeconds        flowEndSeconds          throughput      algoCalc                anomaly
</span></span><span class="line"><span class="cl">2ecb054a-8c0d-4ae1-8444-c3493e7bb6d9    20.20.3.12      <span class="m">59448</span>                   20.20.0.12      <span class="m">2181</span>                            2023-06-06T22:04:43Z    2023-06-07T21:41:38Z    <span class="m">54204</span>           65355.16485680155       <span class="nb">true</span>
</span></span><span class="line"><span class="cl">2ecb054a-8c0d-4ae1-8444-c3493e7bb6d9    20.20.3.12      <span class="m">59448</span>                   20.20.0.12      <span class="m">2181</span>                            2023-06-06T22:04:43Z    2023-06-08T07:09:32Z    <span class="m">49901</span>           54713.50251767502       <span class="nb">true</span>
</span></span><span class="line"><span class="cl">2ecb054a-8c0d-4ae1-8444-c3493e7bb6d9    20.20.3.12      <span class="m">59448</span>                   20.20.0.12      <span class="m">2181</span>                            2023-06-06T22:04:43Z    2023-06-08T03:33:48Z    <span class="m">50000</span>           53550.532983008845      <span class="nb">true</span>
</span></span><span class="line"><span class="cl">2ecb054a-8c0d-4ae1-8444-c3493e7bb6d9    20.20.3.12      <span class="m">59448</span>                   20.20.0.12      <span class="m">2181</span>                            2023-06-06T22:04:43Z    2023-06-08T00:52:48Z    <span class="m">59725</span>           52206.69079880149       <span class="nb">true</span>
</span></span><span class="line"><span class="cl">2ecb054a-8c0d-4ae1-8444-c3493e7bb6d9    20.20.3.12      <span class="m">59448</span>                   20.20.0.12      <span class="m">2181</span>                            2023-06-06T22:04:43Z    2023-06-07T18:49:03Z    <span class="m">48544</span>           53287.107990749006      <span class="nb">true</span>
</span></span><span class="line"><span class="cl">2ecb054a-8c0d-4ae1-8444-c3493e7bb6d9    20.20.3.12      <span class="m">59448</span>                   20.20.0.12      <span class="m">2181</span>                            2023-06-06T22:04:43Z    2023-06-07T22:06:43Z    <span class="m">61832</span>           53100.99541753638       <span class="nb">true</span>
</span></span><span class="line"><span class="cl">2ecb054a-8c0d-4ae1-8444-c3493e7bb6d9    20.20.3.12      <span class="m">59448</span>                   20.20.0.12      <span class="m">2181</span>                            2023-06-06T22:04:43Z    2023-06-07T20:57:28Z    <span class="m">58295</span>           54168.70924924757       <span class="nb">true</span>
</span></span><span class="line"><span class="cl">2ecb054a-8c0d-4ae1-8444-c3493e7bb6d9    20.20.3.12      <span class="m">59448</span>                   20.20.0.12      <span class="m">2181</span>                            2023-06-06T22:04:43Z    2023-06-08T07:36:38Z    <span class="m">47309</span>           53688.236655529385      <span class="nb">true</span>
</span></span><span class="line"><span class="cl">2ecb054a-8c0d-4ae1-8444-c3493e7bb6d9    20.20.3.12      <span class="m">59448</span>                   20.20.0.12      <span class="m">2181</span>                            2023-06-06T22:04:43Z    2023-06-08T08:05:43Z    <span class="m">59227</span>           52623.71668244673       <span class="nb">true</span>
</span></span><span class="line"><span class="cl">2ecb054a-8c0d-4ae1-8444-c3493e7bb6d9    20.20.3.12      <span class="m">59448</span>                   20.20.0.12      <span class="m">2181</span>                            2023-06-06T22:04:43Z    2023-06-08T05:22:12Z    <span class="m">58217</span>           53709.42205164235       <span class="nb">true</span>
</span></span><span class="line"><span class="cl">2ecb054a-8c0d-4ae1-8444-c3493e7bb6d9    20.20.3.12      <span class="m">59448</span>                   20.20.0.12      <span class="m">2181</span>                            2023-06-06T22:04:43Z    2023-06-08T02:19:03Z    <span class="m">48508</span>           55649.8819138477        <span class="nb">true</span>
</span></span><span class="line"><span class="cl">2ecb054a-8c0d-4ae1-8444-c3493e7bb6d9    20.20.3.12      <span class="m">59448</span>                   20.20.0.12      <span class="m">2181</span>                            2023-06-06T22:04:43Z    2023-06-07T23:27:28Z    <span class="m">53846</span>           48125.33491950862       <span class="nb">true</span>
</span></span><span class="line"><span class="cl">2ecb054a-8c0d-4ae1-8444-c3493e7bb6d9    20.20.3.12      <span class="m">59448</span>                   20.20.0.12      <span class="m">2181</span>                            2023-06-06T22:04:43Z    2023-06-08T00:09:38Z    <span class="m">59562</span>           52143.367660610136      <span class="nb">true</span>
</span></span><span class="line"><span class="cl">2ecb054a-8c0d-4ae1-8444-c3493e7bb6d9    20.20.3.12      <span class="m">59448</span>                   20.20.0.12      <span class="m">2181</span>                            2023-06-06T22:04:43Z    2023-06-08T02:44:08Z    <span class="m">50966</span>           57119.323329628125      <span class="nb">true</span>
</span></span><span class="line"><span class="cl">2ecb054a-8c0d-4ae1-8444-c3493e7bb6d9    20.20.3.12      <span class="m">59448</span>                   20.20.0.12      <span class="m">2181</span>                            2023-06-06T22:04:43Z    2023-06-08T08:24:17Z    <span class="m">55553</span>           50480.7443391562        <span class="nb">true</span>
</span></span><span class="line"><span class="cl">2ecb054a-8c0d-4ae1-8444-c3493e7bb6d9    20.20.3.12      <span class="m">59448</span>                   20.20.0.12      <span class="m">2181</span>                            2023-06-06T22:04:43Z    2023-06-08T00:02:38Z    <span class="m">44172</span>           53694.11880964807       <span class="nb">true</span>
</span></span><span class="line"><span class="cl">2ecb054a-8c0d-4ae1-8444-c3493e7bb6d9    20.20.3.12      <span class="m">59448</span>                   20.20.0.12      <span class="m">2181</span>                            2023-06-06T22:04:43Z    2023-06-08T04:07:57Z    <span class="m">53612</span>           49714.00885995446       <span class="nb">true</span>
</span></span><span class="line"><span class="cl">2ecb054a-8c0d-4ae1-8444-c3493e7bb6d9    20.20.3.12      <span class="m">59448</span>                   20.20.0.12      <span class="m">2181</span>                            2023-06-06T22:04:43Z    2023-06-08T01:54:58Z    <span class="m">59089</span>           51972.42465384903       <span class="nb">true</span>
</span></span></code></pre></div>

<h2 class="relative group">Antrea Egress 
    <div id="antrea-egress" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#antrea-egress" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>This chapter is also covered in another post I have done <a href="https://blog.andreasm.io/2023/02/20/antrea-egress/" target="_blank">here</a> with some tweaks &#x1f603;</p>
<p>From the offical <a href="https://antrea.io/docs/v1.12.0/docs/egress/" target="_blank">docs</a></p>
<blockquote>
<p><code>Egress</code> is a CRD API that manages external access from the Pods in a cluster. It supports specifying which egress (SNAT) IP the traffic from the selected Pods to the external network should use. When a selected Pod accesses the external network, the egress traffic will be tunneled to the Node that hosts the egress IP if its different from the Node that the Pod runs on and will be SNATed to the egress IP when leaving that Node.</p>
<p>You may be interested in using this capability if any of the following apply:</p>
<ul>
<li>A consistent IP address is desired when specific Pods connect to services outside of the cluster, for source tracing in audit logs, or for filtering by source IP in external firewall, etc.</li>
<li>You want to force outgoing external connections to leave the cluster via certain Nodes, for security controls, or due to network topology restrictions.</li>
</ul>
</blockquote>

          
          
          
        </div>
        
        

        
        
  
  <section class="flex flex-row flex-wrap justify-center pt-4 text-xl">
    
      
      <a
      target="_blank"
      class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800"
      href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://blog.andreasm.io/2023/06/01/managing-antrea-in-vsphere-with-tanzu/&amp;title=Managing%20Antrea%20in%20vSphere%20with%20Tanzu"
      title="Share on LinkedIn"
      aria-label="Share on LinkedIn"
      >
      

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg>

  </span>


    </a>
      
    
      
      <a
      target="_blank"
      class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800"
      href="https://twitter.com/intent/tweet/?url=https://blog.andreasm.io/2023/06/01/managing-antrea-in-vsphere-with-tanzu/&amp;text=Managing%20Antrea%20in%20vSphere%20with%20Tanzu"
      title="Tweet on Twitter"
      aria-label="Tweet on Twitter"
      >
      

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8L200.7 275.5 26.8 48H172.4L272.9 180.9 389.2 48zM364.4 421.8h39.1L151.1 88h-42L364.4 421.8z"/></svg>
  </span>


    </a>
      
    
      
      <a
      target="_blank"
      class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800"
      href="https://s2f.kytta.dev/?text=Managing%20Antrea%20in%20vSphere%20with%20Tanzu%20https://blog.andreasm.io/2023/06/01/managing-antrea-in-vsphere-with-tanzu/"
      title=""
      aria-label=""
      >
      

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48 0 0 0-63.72 28.5-63.72 125.7 0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54 0 0 1-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"/></svg>

  </span>


    </a>
      
    
      
      <a
      target="_blank"
      class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800"
      href="mailto:?body=https://blog.andreasm.io/2023/06/01/managing-antrea-in-vsphere-with-tanzu/&amp;subject=Managing%20Antrea%20in%20vSphere%20with%20Tanzu"
      title="Send via email"
      aria-label="Send via email"
      >
      

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M207.8 20.73c-93.45 18.32-168.7 93.66-187 187.1c-27.64 140.9 68.65 266.2 199.1 285.1c19.01 2.888 36.17-12.26 36.17-31.49l.0001-.6631c0-15.74-11.44-28.88-26.84-31.24c-84.35-12.98-149.2-86.13-149.2-174.2c0-102.9 88.61-185.5 193.4-175.4c91.54 8.869 158.6 91.25 158.6 183.2l0 16.16c0 22.09-17.94 40.05-40 40.05s-40.01-17.96-40.01-40.05v-120.1c0-8.847-7.161-16.02-16.01-16.02l-31.98 .0036c-7.299 0-13.2 4.992-15.12 11.68c-24.85-12.15-54.24-16.38-86.06-5.106c-38.75 13.73-68.12 48.91-73.72 89.64c-9.483 69.01 43.81 128 110.9 128c26.44 0 50.43-9.544 69.59-24.88c24 31.3 65.23 48.69 109.4 37.49C465.2 369.3 496 324.1 495.1 277.2V256.3C495.1 107.1 361.2-9.332 207.8 20.73zM239.1 304.3c-26.47 0-48-21.56-48-48.05s21.53-48.05 48-48.05s48 21.56 48 48.05S266.5 304.3 239.1 304.3z"/></svg>

  </span>


    </a>
      
    
  </section>


        


<h2 class="mt-8 text-2xl font-extrabold mb-10">Related</h2>
<section class="w-full grid gap-4 sm:grid-cols-2 md:grid-cols-3">
  
  

  <a href="/2023/02/20/antrea-egress/" class="min-w-full">
    
    <div class="min-h-full border border-neutral-200 dark:border-neutral-700 border-2 rounded overflow-hidden shadow-2xl relative">
        
        <div class="w-full thumbnail_card_related nozoom" style="background-image:url(/2023/02/20/antrea-egress/feature-antrea-1.png);"></div>
        
      

      <div class="px-6 py-4">

        
        <div class="font-bold text-xl text-neutral-800 decoration-primary-500 hover:underline hover:underline-offset-2 dark:text-neutral"
          href="/2023/02/20/antrea-egress/">Antrea Egress</div>
        

        <div class="text-sm text-neutral-500 dark:text-neutral-400">
          











  





  



  













<div class="flex flex-row flex-wrap items-center">
  
  
  <time datetime="2023-02-20T15:42:54&#43;01:00">20 February 2023</time><span class="px-2 text-primary-500">&middot;</span><span>3485 words</span><span class="px-2 text-primary-500">&middot;</span><span title="Reading time">17 mins</span>
  

  
  
</div>


<div class="flex flex-row flex-wrap items-center">
  
  
  
  
  
  
  
  
  
  
  
</div>




<div class="flex flex-row flex-wrap items-center">
  
  
  
  
  
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/kubernetes/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Kubernetes
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/networking/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Networking
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/cni/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    CNI
  </span>
</span>
  </span>
  
  
  
  
  
  
  
  
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/antrea/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Antrea
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/kubernetes/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Kubernetes
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/tanzu/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Tanzu
  </span>
</span>
  </span>
  
  
  
  
</div>




        </div>

        
        <div class="py-1 prose dark:prose-invert">
          Antrea Egress: # What is Egress when we talk about Kubernetes?
        </div>
        
      </div>
      <div class="px-6 pt-4 pb-2">

      </div>
    </div>
  </a>

  
  

  <a href="/2023/09/25/antrea-multi-cluster-in-tkg-and-vsphere-with-tanzu/" class="min-w-full">
    
    <div class="min-h-full border border-neutral-200 dark:border-neutral-700 border-2 rounded overflow-hidden shadow-2xl relative">
        
        <div class="w-full thumbnail_card_related nozoom" style="background-image:url(/2023/09/25/antrea-multi-cluster-in-tkg-and-vsphere-with-tanzu/feature-antrea-1.png);"></div>
        
      

      <div class="px-6 py-4">

        
        <div class="font-bold text-xl text-neutral-800 decoration-primary-500 hover:underline hover:underline-offset-2 dark:text-neutral"
          href="/2023/09/25/antrea-multi-cluster-in-tkg-and-vsphere-with-tanzu/">Antrea Multi-cluster - in TKG and vSphere with Tanzu</div>
        

        <div class="text-sm text-neutral-500 dark:text-neutral-400">
          











  





  



  













<div class="flex flex-row flex-wrap items-center">
  
  
  <time datetime="2023-09-25T10:59:30&#43;02:00">25 September 2023</time><span class="px-2 text-primary-500">&middot;</span><span>11466 words</span><span class="px-2 text-primary-500">&middot;</span><span title="Reading time">54 mins</span>
  

  
  
</div>


<div class="flex flex-row flex-wrap items-center">
  
  
  
  
  
  
  
  
  
  
  
</div>




<div class="flex flex-row flex-wrap items-center">
  
  
  
  
  
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/kubernetes/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Kubernetes
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/cni/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    CNI
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/antrea/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Antrea
  </span>
</span>
  </span>
  
  
  
  
  
  
  
  
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/kubernetes/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Kubernetes
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/tanzu/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Tanzu
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/antrea/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Antrea
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/cni/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Cni
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/multi-cluster/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Multi-Cluster
  </span>
</span>
  </span>
  
  
  
  
</div>




        </div>

        
        <div class="py-1 prose dark:prose-invert">
          In this post I will go through how to configure and use the Antrea feature gate Multi-cluster in both TKGs and TKG
        </div>
        
      </div>
      <div class="px-6 pt-4 pb-2">

      </div>
    </div>
  </a>

  
  

  <a href="/2023/05/30/tanzu-kubernetes-grid-2.2-remote-workload-clusters/" class="min-w-full">
    
    <div class="min-h-full border border-neutral-200 dark:border-neutral-700 border-2 rounded overflow-hidden shadow-2xl relative">
        
        <div class="w-full thumbnail_card_related nozoom" style="background-image:url(/2023/05/30/tanzu-kubernetes-grid-2.2-remote-workload-clusters/feature-vmware_by_broadcom.png);"></div>
        
      

      <div class="px-6 py-4">

        
        <div class="font-bold text-xl text-neutral-800 decoration-primary-500 hover:underline hover:underline-offset-2 dark:text-neutral"
          href="/2023/05/30/tanzu-kubernetes-grid-2.2-remote-workload-clusters/">Tanzu Kubernetes Grid 2.2 & Remote Workload Clusters</div>
        

        <div class="text-sm text-neutral-500 dark:text-neutral-400">
          











  





  



  













<div class="flex flex-row flex-wrap items-center">
  
  
  <time datetime="2023-05-30T14:54:29&#43;02:00">30 May 2023</time><span class="px-2 text-primary-500">&middot;</span><span>4558 words</span><span class="px-2 text-primary-500">&middot;</span><span title="Reading time">22 mins</span>
  

  
  
</div>


<div class="flex flex-row flex-wrap items-center">
  
  
  
  
  
  
  
  
  
  
  
</div>




<div class="flex flex-row flex-wrap items-center">
  
  
  
  
  
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/kubernetes/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Kubernetes
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/tanzu/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Tanzu
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/networking/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Networking
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/loadbalancing/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    LoadBalancing
  </span>
</span>
  </span>
  
  
  
  
  
  
  
  
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/tkg/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Tkg
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/multi-dc/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Multi-Dc
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/nsx-t/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Nsx-T
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/tanzu/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Tanzu
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/nsx-advanced-loadbalancer/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Nsx Advanced Loadbalancer
  </span>
</span>
  </span>
  
  
  
  
</div>




        </div>

        
        <div class="py-1 prose dark:prose-invert">
          In this post I will quickly go through how to use a Tanzu Kubernetes Grid management cluster to deploy and manage workload clusters in edge/remote locations.
        </div>
        
      </div>
      <div class="px-6 pt-4 pb-2">

      </div>
    </div>
  </a>

  
</section>

  
      </div>
     
      
      
        
        
          
          
        
      <script>
        var oid = "views_posts\/2023-06-01-managing-antrea-in-vsphere-with-tanzu\/index.md"
        var oid_likes = "likes_posts\/2023-06-01-managing-antrea-in-vsphere-with-tanzu\/index.md"
      </script>
      
      
      <script type="text/javascript" src="/js/page.min.0860cf4e04fa2d72cc33ddba263083464d48f67de06114529043cb4623319efed4f484fd7f1730df5abea0e2da6f3538855634081d02f2d6e920b956f063e823.js" integrity="sha512-CGDPTgT6LXLMM926JjCDRk1I9n3gYRRSkEPLRiMxnv7U9IT9fxcw31q&#43;oOLabzU4hVY0CB0C8tbpILlW8GPoIw=="></script>
      
  
    </section>
  <footer class="pt-8 max-w-prose print:hidden">

    
  
    
    
    
    <div class="pt-8">
      <hr class="border-dotted border-neutral-300 dark:border-neutral-600" />
      <div class="flex justify-between pt-3">
        <span>
          
            <a class="flex group mr-3" href="/2023/05/30/tanzu-kubernetes-grid-2.2-remote-workload-clusters/">
              <span
                class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400"
                >&larr;</span
              >
              <span
                class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400"
                >&rarr;</span
              >
              <span class="flex flex-col">
                <span
                  class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500"
                  >Tanzu Kubernetes Grid 2.2 & Remote Workload Clusters</span
                >
                <span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400">
                  
                    <time datetime="2023-05-30T14:54:29&#43;02:00">30 May 2023</time>
                  
                </span>
              </span>
            </a>
          
        </span>
        <span>
          
            <a class="flex text-right group ml-3" href="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/">
              <span class="flex flex-col">
                <span
                  class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500"
                  >Securing Kubernetes clusters with Antrea Network Policies</span
                >
                <span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400">
                  
                    <time datetime="2023-06-21T10:01:46&#43;02:00">21 June 2023</time>
                  
                </span>
              </span>
              <span
                class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400"
                >&rarr;</span
              >
              <span
                class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400"
                >&larr;</span
              >
            </a>
          
        </span>
      </div>
    </div>
  


    
  </footer>
</article>

      <div id="top-scroller" class="pointer-events-none absolute top-[110vh] bottom-0 w-12 ltr:right-0 rtl:left-0">
  <a href="#the-top"
    class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 mb-16 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400"
    aria-label="Scroll to top" title="Scroll to top">
    &uarr;
  </a>
</div>
    </main><footer id="site-footer" class="py-10 print:hidden">
  
  
    
    <nav class="flex flex-row pb-4 text-base font-medium text-neutral-500 dark:text-neutral-400">
      <ul class="flex flex-col list-none sm:flex-row">
        
        <li class="flex mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0">
          <a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2 flex items-center" href="/tags/"
            title="">
            
            Tags
          </a>
        </li>
        
        <li class="flex mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0">
          <a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2 flex items-center" href="/categories/"
            title="">
            
            Categories
          </a>
        </li>
        
      </ul>
    </nav>
    
  
  <div class="flex items-center justify-between">

    
    
    <p class="text-sm text-neutral-500 dark:text-neutral-400">
      &copy;
      2026
      Andreas Marqvardsen
    </p>
    

    
    
    <p class="text-xs text-neutral-500 dark:text-neutral-400">
      
      
      Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500"
        href="https://gohugo.io/" target="_blank" rel="noopener noreferrer">Hugo</a> &amp; <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500"
        href="https://blowfish.page/" target="_blank" rel="noopener noreferrer">Blowfish</a>
    </p>
    

  </div>
  <script>
    
    mediumZoom(document.querySelectorAll("img:not(.nozoom)"), {
      margin: 24,
      background: 'rgba(0,0,0,0.5)',
      scrollOffset: 0,
    })
    
  </script>
  
  
  <script type="text/javascript" src="/js/process.min.ee03488f19c93c2efb199e2e3014ea5f3cb2ce7d45154adb3399a158cac27ca52831db249ede5bb602700ef87eb02434139de0858af1818ab0fb4182472204a4.js" integrity="sha512-7gNIjxnJPC77GZ4uMBTqXzyyzn1FFUrbM5mhWMrCfKUoMdsknt5btgJwDvh&#43;sCQ0E53ghYrxgYqw&#43;0GCRyIEpA=="></script>
  
  
</footer>
<div
  id="search-wrapper"
  class="invisible fixed inset-0 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh]"
  data-url="https://blog.andreasm.io/"
  style="z-index:500"
>
  <div
    id="search-modal"
    class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"
  >
    <header class="relative z-10 flex items-center justify-between flex-none px-2">
      <form class="flex items-center flex-auto min-w-0">
        <div class="flex items-center justify-center w-8 h-8 text-neutral-400">
          

  <span class="relative block icon">
    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>

  </span>


        </div>
        <input
          type="search"
          id="search-query"
          class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent"
          placeholder="Search"
          tabindex="0"
        />
      </form>
      <button
        id="close-search-button"
        class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400"
        title="Close (Esc)"
      >
        

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75 0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3L54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75 0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75 0-45.25s32.75-12.5 45.25 0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25 0s12.5 32.75 0 45.25l-105.4 105.4L310.6 361.4z"/></svg>

  </span>


      </button>
    </header>
    <section class="flex-auto px-2 overflow-auto">
      <ul id="search-results">
        
      </ul>
    </section>
  </div>
</div>

  </div>
</body>

</html>
