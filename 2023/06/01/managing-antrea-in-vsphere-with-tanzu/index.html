
<!DOCTYPE html>
<html
  lang="en"
  data-figures=""
  
    class="page"
  
  
  
    data-mode="dim"
  >
  <head>
<title>Managing Antrea in vSphere with Tanzu | From 0.985mhz... to several Ghz</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-TVPYDVE8KR"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-TVPYDVE8KR');
</script>



  
<meta property="og:locale" content="en" />

<meta property="og:type" content="article">
<meta name="description" content="Article description." />
<meta name="twitter:card" content="summary" />
<meta name="twitter:creator" content="">
<meta name="twitter:title" content="Managing Antrea in vSphere with Tanzu" />
<meta name="twitter:image" content="https://blog.andreasm.io/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/antrea-stacked-color3.webp"/>
<meta property="og:url" content="https://blog.andreasm.io/2023/06/01/managing-antrea-in-vsphere-with-tanzu/" />
<meta property="og:title" content="Managing Antrea in vSphere with Tanzu" />
<meta property="og:description" content="Article description." />
<meta property="og:image" content="https://blog.andreasm.io/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/antrea-stacked-color3.webp" />
  <meta name="keywords" content="nsx,vmware,kubernetes" />

<link rel="apple-touch-icon" sizes="180x180" href="https://blog.andreasm.io/icons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://blog.andreasm.io/icons/favicon-32x32.png">
<link rel="manifest" href="https://blog.andreasm.io/icons/site.webmanifest">

<link rel="canonical" href="https://blog.andreasm.io/2023/06/01/managing-antrea-in-vsphere-with-tanzu/">



<link rel="preload" href="https://blog.andreasm.io/css/styles.6c67fa3a7f5290a2facfb027358dd2bdb5450d04b8de427c8a74d79f524a7fb716b470b14b6ba95f1b7cf3aa9a2219a7294a6adeaf16a1080f432eae45d8c03c.css" integrity = "sha512-bGf6On9SkKL6z7AnNY3SvbVFDQS43kJ8inTXn1JKf7cWtHCxS2upXxt886qaIhmnKUpq3q8WoQgPQy6uRdjAPA==" as="style" crossorigin="anonymous">



<link rel="preload" href="https://blog.andreasm.io/en/js/bundle.5548d358738600c857a1f05f0459418da7143d4426c66a08bf3f15ded1b39dd2136bf104a559247a909fc4dcc45b8e06bad0870ece4c71ee5303d30550def8bd.js" as="script" integrity=
"sha512-VUjTWHOGAMhXofBfBFlBjacUPUQmxmoIvz8V3tGzndITa/EEpVkkepCfxNzEW44GutCHDs5Mce5TA9MFUN74vQ==" crossorigin="anonymous">


<link rel="stylesheet" type="text/css" href="https://blog.andreasm.io/css/styles.6c67fa3a7f5290a2facfb027358dd2bdb5450d04b8de427c8a74d79f524a7fb716b470b14b6ba95f1b7cf3aa9a2219a7294a6adeaf16a1080f432eae45d8c03c.css" integrity="sha512-bGf6On9SkKL6z7AnNY3SvbVFDQS43kJ8inTXn1JKf7cWtHCxS2upXxt886qaIhmnKUpq3q8WoQgPQy6uRdjAPA==" crossorigin="anonymous">


  </head>
  <body
    data-code="7"
    data-lines="false"
    id="documentTop"
    data-lang="en"
  >

<header class="nav_header" >
  <nav class="nav"><a href='https://blog.andreasm.io/' class="nav_brand nav_item" title="From 0.985mhz... to several Ghz">
  <img src="https://blog.andreasm.io/quote3.png" class="logo" alt="From 0.985mhz... to several Ghz">
  <div class="nav_close">
    <div><svg class="icon">
  <title>open-menu</title>
  <use xlink:href="#open-menu"></use>
</svg>
<svg class="icon">
  <title>closeme</title>
  <use xlink:href="#closeme"></use>
</svg>
</div>
  </div>
</a>

    <div class='nav_body nav_body_left'>
      
      
      
        

  <div class="nav_parent">
    <a href="https://blog.andreasm.io/" class="nav_item" title="Home">Home </a>
  </div>
  <div class="nav_parent">
    <a href="https://blog.andreasm.io/about/" class="nav_item" title="About">About </a>
  </div>
      
<div class='follow'>
<div class="color_mode">
  <input type="checkbox" class="color_choice" id="mode">
</div>

</div>

    </div>
  </nav>
</header>

    <main>
  
<div class="grid-inverse wrap content">
  <article class="post_content">
    <h1 class="post_title">Managing Antrea in vSphere with Tanzu</h1>
  <div class="post_meta">
    <span><svg class="icon">
  <title>calendar</title>
  <use xlink:href="#calendar"></use>
</svg>
</span>
    <span class="post_date">
      01-06-2023</span>
    <span class="post_time"> · 56 min read</span><span>&nbsp;· <a href='https://blog.andreasm.io/tags/antrea/' title="antrea" class="post_tag button button_translucent">antrea
        </a><a href='https://blog.andreasm.io/tags/tanzu/' title="tanzu" class="post_tag button button_translucent">tanzu
        </a><a href='https://blog.andreasm.io/tags/nsx-t/' title="nsx-t" class="post_tag button button_translucent">nsx-t
        </a>
    </span>
  </div>

      <div class="post_toc">
        <h2>Overview</h2>
        <nav id="TableOfContents">
  <ul>
    <li><a href="#managing-antrea-settings-and-feature-gates-in-tkg-2-clusters">Managing Antrea settings and Feature Gates in TKG 2 clusters</a></li>
    <li><a href="#integrating-antrea-with-nsx-t">Integrating Antrea with NSX-T</a></li>
    <li><a href="#antrea-security-policies">Antrea Security Policies</a>
      <ul>
        <li><a href="#tiered-policies">Tiered policies</a></li>
        <li><a href="#antrea-rbac">Antrea RBAC</a></li>
      </ul>
    </li>
    <li><a href="#how-to-manage-the-antrea-native-policies">How to manage the Antrea Native Policies</a>
      <ul>
        <li><a href="#antrea-security-policies-from-the-nsx-manager">Antrea Security policies from the NSX manager</a></li>
        <li><a href="#antrea-cluster-network-policies---applied-from-the-nsx-manager">Antrea Cluster Network Policies - Applied from the NSX manager</a></li>
        <li><a href="#nsx-distributed-firewall---kubernetes-objects-policies">NSX Distributed Firewall - Kubernetes objects Policies</a></li>
        <li><a href="#antrea-security-policies-from-kubernetes-api">Antrea Security policies from kubernetes api</a></li>
      </ul>
    </li>
    <li><a href="#antrea-dashboard">Antrea Dashboard</a></li>
    <li><a href="#antrea-network-monitoring">Antrea Network Monitoring</a>
      <ul>
        <li><a href="#flow-exporter---ipfix">Flow-Exporter - IPFIX</a></li>
        <li><a href="#traceflow">Traceflow</a></li>
        <li><a href="#theia">Theia</a></li>
        <li><a href="#network-policy-recommendation">Network Policy Recommendation</a></li>
        <li><a href="#throughput-anomaly-detection">Throughput Anomaly Detection</a></li>
      </ul>
    </li>
    <li><a href="#antrea-egress">Antrea Egress</a></li>
  </ul>
</nav>
      </div>
    
    <div class="post_body"><h1 id="antrea-in-vsphere-with-tanzu">Antrea in vSphere with Tanzu</h1>
<p>Antrea is the default CNI being used in TKG 2.0 clusters. TKG 2.0 clusters are the workload clusters you deploy with the Supervisor deployed in vSphere 8. Antrea comes in to flavours, we have the open source edition of Antrea which can be found <a href="https://github.com/antrea-io/antrea">here</a> and then we have the Antrea Advanced (&quot;downstream&quot;) version which is being used in vSphere with Tanzu. This version is also needed when we want to integrate Antrea with NSX-T for policy management. The Antrea Advanced can be found in your VMware customer connect portal <a href="https://customerconnect.vmware.com/downloads/info/slug/networking_security/vmware_antrea/1_x">here</a>. Both version of Antrea has a very broad support Kubernetes platforms it can be used in. Antrea can be used for Windows worker nodes, Photon, Ubuntu, ARM, x86, VMware TKG, OpenShift, Rancher, AKS, EKS. the list is long see more info <a href="https://antrea.io/">here</a>. This post will be focusing on the Antrea Advanced edition and its features like (read more <a href="https://antrea.io/docs/v1.12.0/docs/feature-gates/">here</a>):</p>
<ul>
<li>Central management of Antrea Security Policies with NSX</li>
<li>Central troubleshooting with TraceFlow with NSX</li>
<li>FQDN/L7 Security policies</li>
<li>RBAC</li>
<li>Tiered policies</li>
<li>Flow Exporter</li>
<li>Egress (Source NAT IP selection of PODs egressing)</li>
</ul>
<h2 id="managing-antrea-settings-and-feature-gates-in-tkg-2-clusters">Managing Antrea settings and Feature Gates in TKG 2 clusters</h2>
<p>When you deploy a TKG 2 cluster on vSphere with Tanzu and you dont specify a CNI Antrea will be de default CNI. Depending on the TKG version you are on a set of default Antrea features are enabled or disabled. You can easily check which features are enabled after a cluster has been provisioned by issuing the below command:
If you know already before you deploy a cluster that a specific feature should be enabled or disabled this can also be handled during bring-up of the cluster so it should come with the settings you want. More on that later.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">  1</span><span class="cl">linux-vm:~/from_ubuntu_vm/tkgs/tkgs-stc-cpod$ k get configmaps -n kube-system antrea-config -oyaml
</span></span><span class="line"><span class="ln">  2</span><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="ln">  3</span><span class="cl">data:
</span></span><span class="line"><span class="ln">  4</span><span class="cl">  antrea-agent.conf: <span class="p">|</span>
</span></span><span class="line"><span class="ln">  5</span><span class="cl">    featureGates:
</span></span><span class="line"><span class="ln">  6</span><span class="cl">      AntreaProxy: <span class="nb">true</span>
</span></span><span class="line"><span class="ln">  7</span><span class="cl">      EndpointSlice: <span class="nb">true</span>
</span></span><span class="line"><span class="ln">  8</span><span class="cl">      Traceflow: <span class="nb">true</span>
</span></span><span class="line"><span class="ln">  9</span><span class="cl">      NodePortLocal: <span class="nb">true</span>
</span></span><span class="line"><span class="ln"> 10</span><span class="cl">      AntreaPolicy: <span class="nb">true</span>
</span></span><span class="line"><span class="ln"> 11</span><span class="cl">      FlowExporter: <span class="nb">false</span>
</span></span><span class="line"><span class="ln"> 12</span><span class="cl">      NetworkPolicyStats: <span class="nb">false</span>
</span></span><span class="line"><span class="ln"> 13</span><span class="cl">      Egress: <span class="nb">true</span>
</span></span><span class="line"><span class="ln"> 14</span><span class="cl">      AntreaIPAM: <span class="nb">false</span>
</span></span><span class="line"><span class="ln"> 15</span><span class="cl">      Multicast: <span class="nb">false</span>
</span></span><span class="line"><span class="ln"> 16</span><span class="cl">      Multicluster: <span class="nb">false</span>
</span></span><span class="line"><span class="ln"> 17</span><span class="cl">      SecondaryNetwork: <span class="nb">false</span>
</span></span><span class="line"><span class="ln"> 18</span><span class="cl">      ServiceExternalIP: <span class="nb">false</span>
</span></span><span class="line"><span class="ln"> 19</span><span class="cl">      TrafficControl: <span class="nb">false</span>
</span></span><span class="line"><span class="ln"> 20</span><span class="cl">    trafficEncapMode: encap
</span></span><span class="line"><span class="ln"> 21</span><span class="cl">    noSNAT: <span class="nb">false</span>
</span></span><span class="line"><span class="ln"> 22</span><span class="cl">    tunnelType: geneve
</span></span><span class="line"><span class="ln"> 23</span><span class="cl">    trafficEncryptionMode: none
</span></span><span class="line"><span class="ln"> 24</span><span class="cl">    enableBridgingMode: <span class="nb">false</span>
</span></span><span class="line"><span class="ln"> 25</span><span class="cl">    disableTXChecksumOffload: <span class="nb">false</span>
</span></span><span class="line"><span class="ln"> 26</span><span class="cl">    wireGuard:
</span></span><span class="line"><span class="ln"> 27</span><span class="cl">      port: <span class="m">51820</span>
</span></span><span class="line"><span class="ln"> 28</span><span class="cl">    egress:
</span></span><span class="line"><span class="ln"> 29</span><span class="cl">      exceptCIDRs: <span class="o">[]</span>
</span></span><span class="line"><span class="ln"> 30</span><span class="cl">    serviceCIDR: 20.10.0.0/16
</span></span><span class="line"><span class="ln"> 31</span><span class="cl">    nodePortLocal:
</span></span><span class="line"><span class="ln"> 32</span><span class="cl">      enable: <span class="nb">true</span>
</span></span><span class="line"><span class="ln"> 33</span><span class="cl">      portRange: 61000-62000
</span></span><span class="line"><span class="ln"> 34</span><span class="cl">    tlsCipherSuites: TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,TLS_RSA_WITH_AES_256_GCM_SHA384
</span></span><span class="line"><span class="ln"> 35</span><span class="cl">    multicast: <span class="o">{}</span>
</span></span><span class="line"><span class="ln"> 36</span><span class="cl">    antreaProxy:
</span></span><span class="line"><span class="ln"> 37</span><span class="cl">      proxyAll: <span class="nb">false</span>
</span></span><span class="line"><span class="ln"> 38</span><span class="cl">      nodePortAddresses: <span class="o">[]</span>
</span></span><span class="line"><span class="ln"> 39</span><span class="cl">      skipServices: <span class="o">[]</span>
</span></span><span class="line"><span class="ln"> 40</span><span class="cl">      proxyLoadBalancerIPs: <span class="nb">false</span>
</span></span><span class="line"><span class="ln"> 41</span><span class="cl">    multicluster: <span class="o">{}</span>
</span></span><span class="line"><span class="ln"> 42</span><span class="cl">  antrea-cni.conflist: <span class="p">|</span>
</span></span><span class="line"><span class="ln"> 43</span><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="ln"> 44</span><span class="cl">        <span class="s2">&#34;cniVersion&#34;</span>:<span class="s2">&#34;0.3.0&#34;</span>,
</span></span><span class="line"><span class="ln"> 45</span><span class="cl">        <span class="s2">&#34;name&#34;</span>: <span class="s2">&#34;antrea&#34;</span>,
</span></span><span class="line"><span class="ln"> 46</span><span class="cl">        <span class="s2">&#34;plugins&#34;</span>: <span class="o">[</span>
</span></span><span class="line"><span class="ln"> 47</span><span class="cl">            <span class="o">{</span>
</span></span><span class="line"><span class="ln"> 48</span><span class="cl">                <span class="s2">&#34;type&#34;</span>: <span class="s2">&#34;antrea&#34;</span>,
</span></span><span class="line"><span class="ln"> 49</span><span class="cl">                <span class="s2">&#34;ipam&#34;</span>: <span class="o">{</span>
</span></span><span class="line"><span class="ln"> 50</span><span class="cl">                    <span class="s2">&#34;type&#34;</span>: <span class="s2">&#34;host-local&#34;</span>
</span></span><span class="line"><span class="ln"> 51</span><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="ln"> 52</span><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="ln"> 53</span><span class="cl">            ,
</span></span><span class="line"><span class="ln"> 54</span><span class="cl">            <span class="o">{</span>
</span></span><span class="line"><span class="ln"> 55</span><span class="cl">                <span class="s2">&#34;type&#34;</span>: <span class="s2">&#34;portmap&#34;</span>,
</span></span><span class="line"><span class="ln"> 56</span><span class="cl">                <span class="s2">&#34;capabilities&#34;</span>: <span class="o">{</span><span class="s2">&#34;portMappings&#34;</span>: true<span class="o">}</span>
</span></span><span class="line"><span class="ln"> 57</span><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="ln"> 58</span><span class="cl">            ,
</span></span><span class="line"><span class="ln"> 59</span><span class="cl">            <span class="o">{</span>
</span></span><span class="line"><span class="ln"> 60</span><span class="cl">                <span class="s2">&#34;type&#34;</span>: <span class="s2">&#34;bandwidth&#34;</span>,
</span></span><span class="line"><span class="ln"> 61</span><span class="cl">                <span class="s2">&#34;capabilities&#34;</span>: <span class="o">{</span><span class="s2">&#34;bandwidth&#34;</span>: true<span class="o">}</span>
</span></span><span class="line"><span class="ln"> 62</span><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="ln"> 63</span><span class="cl">        <span class="o">]</span>
</span></span><span class="line"><span class="ln"> 64</span><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="ln"> 65</span><span class="cl">  antrea-controller.conf: <span class="p">|</span>
</span></span><span class="line"><span class="ln"> 66</span><span class="cl">    featureGates:
</span></span><span class="line"><span class="ln"> 67</span><span class="cl">      Traceflow: <span class="nb">true</span>
</span></span><span class="line"><span class="ln"> 68</span><span class="cl">      AntreaPolicy: <span class="nb">true</span>
</span></span><span class="line"><span class="ln"> 69</span><span class="cl">      NetworkPolicyStats: <span class="nb">false</span>
</span></span><span class="line"><span class="ln"> 70</span><span class="cl">      Multicast: <span class="nb">false</span>
</span></span><span class="line"><span class="ln"> 71</span><span class="cl">      Egress: <span class="nb">true</span>
</span></span><span class="line"><span class="ln"> 72</span><span class="cl">      AntreaIPAM: <span class="nb">false</span>
</span></span><span class="line"><span class="ln"> 73</span><span class="cl">      ServiceExternalIP: <span class="nb">false</span>
</span></span><span class="line"><span class="ln"> 74</span><span class="cl">    tlsCipherSuites: TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,TLS_RSA_WITH_AES_256_GCM_SHA384
</span></span><span class="line"><span class="ln"> 75</span><span class="cl">    nodeIPAM: null
</span></span><span class="line"><span class="ln"> 76</span><span class="cl">kind: ConfigMap
</span></span><span class="line"><span class="ln"> 77</span><span class="cl">metadata:
</span></span><span class="line"><span class="ln"> 78</span><span class="cl">  annotations:
</span></span><span class="line"><span class="ln"> 79</span><span class="cl">    kapp.k14s.io/identity: v1<span class="p">;</span>kube-system//ConfigMap/antrea-config<span class="p">;</span>v1
</span></span><span class="line"><span class="ln"> 80</span><span class="cl">    kapp.k14s.io/original: <span class="s1">&#39;{&#34;apiVersion&#34;:&#34;v1&#34;,&#34;data&#34;:{&#34;antrea-agent.conf&#34;:&#34;featureGates:\n  AntreaProxy:
</span></span></span><span class="line"><span class="ln"> 81</span><span class="cl"><span class="s1">      true\n  EndpointSlice: true\n  Traceflow: true\n  NodePortLocal: true\n  AntreaPolicy:
</span></span></span><span class="line"><span class="ln"> 82</span><span class="cl"><span class="s1">      true\n  FlowExporter: false\n  NetworkPolicyStats: false\n  Egress: true\n  AntreaIPAM:
</span></span></span><span class="line"><span class="ln"> 83</span><span class="cl"><span class="s1">      false\n  Multicast: false\n  Multicluster: false\n  SecondaryNetwork: false\n  ServiceExternalIP:
</span></span></span><span class="line"><span class="ln"> 84</span><span class="cl"><span class="s1">      false\n  TrafficControl: false\ntrafficEncapMode: encap\nnoSNAT: false\ntunnelType:
</span></span></span><span class="line"><span class="ln"> 85</span><span class="cl"><span class="s1">      geneve\ntrafficEncryptionMode: none\nenableBridgingMode: false\ndisableTXChecksumOffload:
</span></span></span><span class="line"><span class="ln"> 86</span><span class="cl"><span class="s1">      false\nwireGuard:\n  port: 51820\negress:\n  exceptCIDRs: []\nserviceCIDR: 20.10.0.0/16\nnodePortLocal:\n  enable:
</span></span></span><span class="line"><span class="ln"> 87</span><span class="cl"><span class="s1">      true\n  portRange: 61000-62000\ntlsCipherSuites: TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,TLS_RSA_WITH_AES_256_GCM_SHA384\nmulticast:
</span></span></span><span class="line"><span class="ln"> 88</span><span class="cl"><span class="s1">      {}\nantreaProxy:\n  proxyAll: false\n  nodePortAddresses: []\n  skipServices:
</span></span></span><span class="line"><span class="ln"> 89</span><span class="cl"><span class="s1">      []\n  proxyLoadBalancerIPs: false\nmulticluster: {}\n&#34;,&#34;antrea-cni.conflist&#34;:&#34;{\n    \&#34;cniVersion\&#34;:\&#34;0.3.0\&#34;,\n    \&#34;name\&#34;:
</span></span></span><span class="line"><span class="ln"> 90</span><span class="cl"><span class="s1">      \&#34;antrea\&#34;,\n    \&#34;plugins\&#34;: [\n        {\n            \&#34;type\&#34;: \&#34;antrea\&#34;,\n            \&#34;ipam\&#34;:
</span></span></span><span class="line"><span class="ln"> 91</span><span class="cl"><span class="s1">      {\n                \&#34;type\&#34;: \&#34;host-local\&#34;\n            }\n        }\n        ,\n        {\n            \&#34;type\&#34;:
</span></span></span><span class="line"><span class="ln"> 92</span><span class="cl"><span class="s1">      \&#34;portmap\&#34;,\n            \&#34;capabilities\&#34;: {\&#34;portMappings\&#34;: true}\n        }\n        ,\n        {\n            \&#34;type\&#34;:
</span></span></span><span class="line"><span class="ln"> 93</span><span class="cl"><span class="s1">      \&#34;bandwidth\&#34;,\n            \&#34;capabilities\&#34;: {\&#34;bandwidth\&#34;: true}\n        }\n    ]\n}\n&#34;,&#34;antrea-controller.conf&#34;:&#34;featureGates:\n  Traceflow:
</span></span></span><span class="line"><span class="ln"> 94</span><span class="cl"><span class="s1">      true\n  AntreaPolicy: true\n  NetworkPolicyStats: false\n  Multicast: false\n  Egress:
</span></span></span><span class="line"><span class="ln"> 95</span><span class="cl"><span class="s1">      true\n  AntreaIPAM: false\n  ServiceExternalIP: false\ntlsCipherSuites: TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,TLS_RSA_WITH_AES_256_GCM_SHA384\nnodeIPAM:
</span></span></span><span class="line"><span class="ln"> 96</span><span class="cl"><span class="s1">      null\n&#34;},&#34;kind&#34;:&#34;ConfigMap&#34;,&#34;metadata&#34;:{&#34;labels&#34;:{&#34;app&#34;:&#34;antrea&#34;,&#34;kapp.k14s.io/app&#34;:&#34;1685607245932804320&#34;,&#34;kapp.k14s.io/association&#34;:&#34;v1.c39c4aca919097e50452c3432329dd40&#34;},&#34;name&#34;:&#34;antrea-config&#34;,&#34;namespace&#34;:&#34;kube-system&#34;}}&#39;</span>
</span></span><span class="line"><span class="ln"> 97</span><span class="cl">    kapp.k14s.io/original-diff-md5: c6e94dc94aed3401b5d0f26ed6c0bff3
</span></span><span class="line"><span class="ln"> 98</span><span class="cl">  creationTimestamp: <span class="s2">&#34;2023-06-01T08:14:14Z&#34;</span>
</span></span><span class="line"><span class="ln"> 99</span><span class="cl">  labels:
</span></span><span class="line"><span class="ln">100</span><span class="cl">    app: antrea
</span></span><span class="line"><span class="ln">101</span><span class="cl">    kapp.k14s.io/app: <span class="s2">&#34;1685607245932804320&#34;</span>
</span></span><span class="line"><span class="ln">102</span><span class="cl">    kapp.k14s.io/association: v1.c39c4aca919097e50452c3432329dd40
</span></span><span class="line"><span class="ln">103</span><span class="cl">  name: antrea-config
</span></span><span class="line"><span class="ln">104</span><span class="cl">  namespace: kube-system
</span></span><span class="line"><span class="ln">105</span><span class="cl">  resourceVersion: <span class="s2">&#34;948&#34;</span>
</span></span><span class="line"><span class="ln">106</span><span class="cl">  uid: fd18fd20-a82b-4df5-bb1a-686463b86f27
</span></span></code></pre></div><p>If you want to enable or disable any of these features its a matter of applying an AntreaConfig using the included AntreaConfig CRD in TKG 2.0.</p>
<p>One can apply this AntreaConfig on an already provisioned TKG 2.0 cluster or apply before the cluster is provisioned so it will get the features enabled or disabled at creation.
Below is an example of AntreaConfig:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">cni.tanzu.vmware.com/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">AntreaConfig</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">three-zone-cluster-2-antrea-package</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">ns-three-zone-1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">  </span><span class="nt">antrea</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">    </span><span class="nt">config</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">      </span><span class="nt">featureGates</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">        </span><span class="nt">AntreaProxy</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">        </span><span class="nt">EndpointSlice</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">        </span><span class="nt">AntreaPolicy</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">        </span><span class="nt">FlowExporter</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">        </span><span class="nt">Egress</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="c">#This needs to be enabled (an example)</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">        </span><span class="nt">NodePortLocal</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">        </span><span class="nt">AntreaTraceflow</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">        </span><span class="nt">NetworkPolicyStats</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span></code></pre></div><p>This example is applied either before or after provisioning of the TKG 2.0 cluster. Just make sure the config has been applied to the correct NS, the same NS as the cluster is deployed in and the name of the config needs to start like this <em>CLUSTER-NAME-antrea-package</em>. In other words the name needs to start with the clustername of the TKG 2.0 cluster and end with <em>-antrea-package</em>.</p>
<p>If it is being done after the cluster has provisioned we need to make sure the already running Antrea pods (agents and controller) are restarted so they can read the new configmap.</p>
<p>If you need to check which version of Antrea is included in your TKR version (and other components for that sake) just run the following command:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">linuxvm01:~/three-zones$ k get tkr v1.24.9---vmware.1-tkg.4 -o yaml
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">apiVersion: run.tanzu.vmware.com/v1alpha3
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">kind: TanzuKubernetesRelease
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">metadata:
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">  creationTimestamp: <span class="s2">&#34;2023-06-01T07:35:28Z&#34;</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">  finalizers:
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">  - tanzukubernetesrelease.run.tanzu.vmware.com
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">  generation: <span class="m">2</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">  labels:
</span></span><span class="line"><span class="ln">10</span><span class="cl">    os-arch: amd64
</span></span><span class="line"><span class="ln">11</span><span class="cl">    os-name: photon
</span></span><span class="line"><span class="ln">12</span><span class="cl">    os-type: linux
</span></span><span class="line"><span class="ln">13</span><span class="cl">    os-version: <span class="s2">&#34;3.0&#34;</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">    v1: <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">    v1.24: <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">    v1.24.9: <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">    v1.24.9---vmware: <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">    v1.24.9---vmware.1: <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">    v1.24.9---vmware.1-tkg: <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">    v1.24.9---vmware.1-tkg.4: <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl">  name: v1.24.9---vmware.1-tkg.4
</span></span><span class="line"><span class="ln">22</span><span class="cl">  ownerReferences:
</span></span><span class="line"><span class="ln">23</span><span class="cl">  - apiVersion: vmoperator.vmware.com/v1alpha1
</span></span><span class="line"><span class="ln">24</span><span class="cl">    kind: VirtualMachineImage
</span></span><span class="line"><span class="ln">25</span><span class="cl">    name: ob-21552850-ubuntu-2004-amd64-vmi-k8s-v1.24.9---vmware.1-tkg.4
</span></span><span class="line"><span class="ln">26</span><span class="cl">    uid: 92d3d6af-53f8-4f9a-b262-f70dd33ad19b
</span></span><span class="line"><span class="ln">27</span><span class="cl">  - apiVersion: vmoperator.vmware.com/v1alpha1
</span></span><span class="line"><span class="ln">28</span><span class="cl">    kind: VirtualMachineImage
</span></span><span class="line"><span class="ln">29</span><span class="cl">    name: ob-21554409-photon-3-amd64-vmi-k8s-v1.24.9---vmware.1-tkg.4
</span></span><span class="line"><span class="ln">30</span><span class="cl">    uid: 6a0aa87a-63e3-475d-a52d-e63589f454e9
</span></span><span class="line"><span class="ln">31</span><span class="cl">  resourceVersion: <span class="s2">&#34;12111&#34;</span>
</span></span><span class="line"><span class="ln">32</span><span class="cl">  uid: 54db049e-fdf0-45a2-b4d1-46fa90a22b44
</span></span><span class="line"><span class="ln">33</span><span class="cl">spec:
</span></span><span class="line"><span class="ln">34</span><span class="cl">  bootstrapPackages:
</span></span><span class="line"><span class="ln">35</span><span class="cl">  - name: antrea.tanzu.vmware.com.1.7.2+vmware.1-tkg.1-advanced
</span></span><span class="line"><span class="ln">36</span><span class="cl">  - name: vsphere-pv-csi.tanzu.vmware.com.2.6.1+vmware.1-tkg.1
</span></span><span class="line"><span class="ln">37</span><span class="cl">  - name: vsphere-cpi.tanzu.vmware.com.1.24.3+vmware.1-tkg.1
</span></span><span class="line"><span class="ln">38</span><span class="cl">  - name: kapp-controller.tanzu.vmware.com.0.41.5+vmware.1-tkg.1
</span></span><span class="line"><span class="ln">39</span><span class="cl">  - name: guest-cluster-auth-service.tanzu.vmware.com.1.1.0+tkg.1
</span></span><span class="line"><span class="ln">40</span><span class="cl">  - name: metrics-server.tanzu.vmware.com.0.6.2+vmware.1-tkg.1
</span></span><span class="line"><span class="ln">41</span><span class="cl">  - name: secretgen-controller.tanzu.vmware.com.0.11.2+vmware.1-tkg.1
</span></span><span class="line"><span class="ln">42</span><span class="cl">  - name: pinniped.tanzu.vmware.com.0.12.1+vmware.3-tkg.3
</span></span><span class="line"><span class="ln">43</span><span class="cl">  - name: capabilities.tanzu.vmware.com.0.28.0+vmware.2
</span></span><span class="line"><span class="ln">44</span><span class="cl">  - name: calico.tanzu.vmware.com.3.24.1+vmware.1-tkg.1
</span></span><span class="line"><span class="ln">45</span><span class="cl">  kubernetes:
</span></span><span class="line"><span class="ln">46</span><span class="cl">    coredns:
</span></span><span class="line"><span class="ln">47</span><span class="cl">      imageTag: v1.8.6_vmware.15
</span></span><span class="line"><span class="ln">48</span><span class="cl">    etcd:
</span></span><span class="line"><span class="ln">49</span><span class="cl">      imageTag: v3.5.6_vmware.3
</span></span><span class="line"><span class="ln">50</span><span class="cl">    imageRepository: localhost:5000/vmware.io
</span></span><span class="line"><span class="ln">51</span><span class="cl">    pause:
</span></span><span class="line"><span class="ln">52</span><span class="cl">      imageTag: <span class="s2">&#34;3.7&#34;</span>
</span></span><span class="line"><span class="ln">53</span><span class="cl">    version: v1.24.9+vmware.1
</span></span><span class="line"><span class="ln">54</span><span class="cl">  osImages:
</span></span><span class="line"><span class="ln">55</span><span class="cl">  - name: ob-21552850-ubuntu-2004-amd64-vmi-k8s-v1.24.9---vmware.1-tkg.4
</span></span><span class="line"><span class="ln">56</span><span class="cl">  - name: ob-21554409-photon-3-amd64-vmi-k8s-v1.24.9---vmware.1-tkg.4
</span></span><span class="line"><span class="ln">57</span><span class="cl">  version: v1.24.9+vmware.1-tkg.4
</span></span><span class="line"><span class="ln">58</span><span class="cl">status:
</span></span><span class="line"><span class="ln">59</span><span class="cl">  conditions:
</span></span><span class="line"><span class="ln">60</span><span class="cl">  - lastTransitionTime: <span class="s2">&#34;2023-06-01T07:35:28Z&#34;</span>
</span></span><span class="line"><span class="ln">61</span><span class="cl">    status: <span class="s2">&#34;True&#34;</span>
</span></span><span class="line"><span class="ln">62</span><span class="cl">    type: Ready
</span></span><span class="line"><span class="ln">63</span><span class="cl">  - lastTransitionTime: <span class="s2">&#34;2023-06-01T07:35:28Z&#34;</span>
</span></span><span class="line"><span class="ln">64</span><span class="cl">    status: <span class="s2">&#34;True&#34;</span>
</span></span><span class="line"><span class="ln">65</span><span class="cl">    type: Compatible
</span></span></code></pre></div><p>So enabling and disabling Antrea Feature Gates is quite simple.
To summarize, the feature gates that can be adjusted is these (as of TKR 1.24.9):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">  </span><span class="nt">antrea</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="nt">config</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">      </span><span class="nt">defaultMTU</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">      </span><span class="nt">disableUdpTunnelOffload</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">      </span><span class="nt">featureGates</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">        </span><span class="nt">AntreaPolicy</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">        </span><span class="nt">AntreaProxy</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">        </span><span class="nt">AntreaTraceflow</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">        </span><span class="nt">Egress</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">        </span><span class="nt">EndpointSlice</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">        </span><span class="nt">FlowExporter</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">        </span><span class="nt">NetworkPolicyStats</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">        </span><span class="nt">NodePortLocal</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">      </span><span class="nt">noSNAT</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">      </span><span class="nt">tlsCipherSuites</span><span class="p">:</span><span class="w"> </span><span class="l">TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,TLS_RSA_WITH_AES_256_GCM_SHA384</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">      </span><span class="nt">trafficEncapMode</span><span class="p">:</span><span class="w"> </span><span class="l">encap</span><span class="w">
</span></span></span></code></pre></div><h2 id="integrating-antrea-with-nsx-t">Integrating Antrea with NSX-T</h2>
<p>To enable the NSX-T Antrea integration there is a couple of steps that needs to be prepared. All the steps can be followed <a href="https://docs.vmware.com/en/VMware-NSX/4.1/administration/GUID-9197EF8A-7998-4D1B-B968-067007C56B5C.html">here</a>. I have decided to create a script that automates all these steps. So if you dont want to go through all these steps manually by following the link above you can use this script instead and just enter the necesarry information as prompted, and have the pre-requisities in place before excecuting. Copy and paste the below script into a .sh file on your Linux jumpiest and make it executable with chmod +x.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">  1</span><span class="cl"><span class="cp">#!/bin/bash
</span></span></span><span class="line"><span class="ln">  2</span><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="ln">  3</span><span class="cl"><span class="c1"># Echo information</span>
</span></span><span class="line"><span class="ln">  4</span><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;This script has some dependencies... make sure they are met before continuing. Otherwise click ctrl+c now
</span></span></span><span class="line"><span class="ln">  5</span><span class="cl"><span class="s2">1. This script is adjusted for vSphere with Tanzu TKG clusters using Tanzu CLI
</span></span></span><span class="line"><span class="ln">  6</span><span class="cl"><span class="s2">2. Have downloaded the antrea-interworking*.zip
</span></span></span><span class="line"><span class="ln">  7</span><span class="cl"><span class="s2">3. This script is located in the root of where you have downloaded the zip file above
</span></span></span><span class="line"><span class="ln">  8</span><span class="cl"><span class="s2">4. curl is installed
</span></span></span><span class="line"><span class="ln">  9</span><span class="cl"><span class="s2">5. Need connectivity to the NSX manager
</span></span></span><span class="line"><span class="ln"> 10</span><span class="cl"><span class="s2">6. kubectl is installed
</span></span></span><span class="line"><span class="ln"> 11</span><span class="cl"><span class="s2">7. vsphere with tanzu cli is installed
</span></span></span><span class="line"><span class="ln"> 12</span><span class="cl"><span class="s2">8. That you are in the correct context of the cluster you want to integrate to NSX
</span></span></span><span class="line"><span class="ln"> 13</span><span class="cl"><span class="s2">9. If not in the correct context the script will put you in the correct context anyway
</span></span></span><span class="line"><span class="ln"> 14</span><span class="cl"><span class="s2">10. A big smile and good mood&#34;</span>
</span></span><span class="line"><span class="ln"> 15</span><span class="cl">
</span></span><span class="line"><span class="ln"> 16</span><span class="cl"><span class="c1"># Prompt the user to press a key to continue</span>
</span></span><span class="line"><span class="ln"> 17</span><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;Press any key to continue...&#34;</span>
</span></span><span class="line"><span class="ln"> 18</span><span class="cl"><span class="nb">read</span> -n <span class="m">1</span> -s
</span></span><span class="line"><span class="ln"> 19</span><span class="cl">
</span></span><span class="line"><span class="ln"> 20</span><span class="cl"><span class="c1"># Continue with the script</span>
</span></span><span class="line"><span class="ln"> 21</span><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;Continuing...&#34;</span>
</span></span><span class="line"><span class="ln"> 22</span><span class="cl">
</span></span><span class="line"><span class="ln"> 23</span><span class="cl"><span class="c1"># Prompt for name</span>
</span></span><span class="line"><span class="ln"> 24</span><span class="cl"><span class="nb">read</span> -p <span class="s2">&#34;Enter the name of the tkg cluster - will be used for certificates and name in NSX: &#34;</span> name
</span></span><span class="line"><span class="ln"> 25</span><span class="cl">
</span></span><span class="line"><span class="ln"> 26</span><span class="cl"><span class="c1"># Prompt for NSX_MGR</span>
</span></span><span class="line"><span class="ln"> 27</span><span class="cl"><span class="nb">read</span> -p <span class="s2">&#34;Enter NSX Manager ip or FQDN: &#34;</span> nsx_mgr
</span></span><span class="line"><span class="ln"> 28</span><span class="cl">
</span></span><span class="line"><span class="ln"> 29</span><span class="cl"><span class="c1"># Prompt for NSX_ADMIN</span>
</span></span><span class="line"><span class="ln"> 30</span><span class="cl"><span class="nb">read</span> -p <span class="s2">&#34;Enter NSX admin username: &#34;</span> nsx_admin
</span></span><span class="line"><span class="ln"> 31</span><span class="cl">
</span></span><span class="line"><span class="ln"> 32</span><span class="cl"><span class="c1"># Prompt for NSX_PASS</span>
</span></span><span class="line"><span class="ln"> 33</span><span class="cl"><span class="nb">read</span> -p <span class="s2">&#34;Enter NSX Password: &#34;</span> nsx_pass
</span></span><span class="line"><span class="ln"> 34</span><span class="cl">
</span></span><span class="line"><span class="ln"> 35</span><span class="cl"><span class="c1"># Prompt for Supervisor Endpoint IP or FQDN</span>
</span></span><span class="line"><span class="ln"> 36</span><span class="cl"><span class="nb">read</span> -p <span class="s2">&#34;Enter Supervisor API IP or FQDN: &#34;</span> svc_api_ip
</span></span><span class="line"><span class="ln"> 37</span><span class="cl">
</span></span><span class="line"><span class="ln"> 38</span><span class="cl"><span class="c1"># Prompt for vSphere Username</span>
</span></span><span class="line"><span class="ln"> 39</span><span class="cl"><span class="nb">read</span> -p <span class="s2">&#34;Enter vSphere Username: &#34;</span> vsphere_username
</span></span><span class="line"><span class="ln"> 40</span><span class="cl">
</span></span><span class="line"><span class="ln"> 41</span><span class="cl"><span class="c1"># Prompt for Tanzu Kubernetes Cluster Namespace</span>
</span></span><span class="line"><span class="ln"> 42</span><span class="cl"><span class="nb">read</span> -p <span class="s2">&#34;Enter Tanzu Kubernetes Cluster Namespace: &#34;</span> tanzu_cluster_namespace
</span></span><span class="line"><span class="ln"> 43</span><span class="cl">
</span></span><span class="line"><span class="ln"> 44</span><span class="cl"><span class="c1"># Prompt for Tanzu Kubernetes Cluster Name</span>
</span></span><span class="line"><span class="ln"> 45</span><span class="cl"><span class="nb">read</span> -p <span class="s2">&#34;Enter Tanzu Kubernetes Cluster Name: &#34;</span> tanzu_cluster_name
</span></span><span class="line"><span class="ln"> 46</span><span class="cl">
</span></span><span class="line"><span class="ln"> 47</span><span class="cl"><span class="c1"># Login to vSphere using kubectl</span>
</span></span><span class="line"><span class="ln"> 48</span><span class="cl">kubectl vsphere login --server<span class="o">=</span><span class="s2">&#34;</span><span class="nv">$svc_api_ip</span><span class="s2">&#34;</span> --insecure-skip-tls-verify --vsphere-username<span class="o">=</span><span class="s2">&#34;</span><span class="nv">$vsphere_username</span><span class="s2">&#34;</span> --tanzu-kubernetes-cluster-namespace<span class="o">=</span><span class="s2">&#34;</span><span class="nv">$tanzu_cluster_namespace</span><span class="s2">&#34;</span> --tanzu-kubernetes-cluster-name<span class="o">=</span><span class="s2">&#34;</span><span class="nv">$tanzu_cluster_name</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="ln"> 49</span><span class="cl">
</span></span><span class="line"><span class="ln"> 50</span><span class="cl"><span class="nv">key_name</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">name</span><span class="si">}</span><span class="s2">-private.key&#34;</span>
</span></span><span class="line"><span class="ln"> 51</span><span class="cl"><span class="nv">csr_output</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">name</span><span class="si">}</span><span class="s2">.csr&#34;</span>
</span></span><span class="line"><span class="ln"> 52</span><span class="cl"><span class="nv">crt_output</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">name</span><span class="si">}</span><span class="s2">.crt&#34;</span>
</span></span><span class="line"><span class="ln"> 53</span><span class="cl">
</span></span><span class="line"><span class="ln"> 54</span><span class="cl">openssl genrsa -out <span class="s2">&#34;</span><span class="nv">$key_name</span><span class="s2">&#34;</span> <span class="m">2048</span>
</span></span><span class="line"><span class="ln"> 55</span><span class="cl">openssl req -new -key <span class="s2">&#34;</span><span class="nv">$key_name</span><span class="s2">&#34;</span> -out <span class="s2">&#34;</span><span class="nv">$csr_output</span><span class="s2">&#34;</span> -subj <span class="s2">&#34;/C=US/ST=CA/L=Palo Alto/O=VMware/OU=Antrea Cluster/CN=</span><span class="nv">$name</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="ln"> 56</span><span class="cl">openssl x509 -req -days <span class="m">3650</span> -sha256 -in <span class="s2">&#34;</span><span class="nv">$csr_output</span><span class="s2">&#34;</span> -signkey <span class="s2">&#34;</span><span class="nv">$key_name</span><span class="s2">&#34;</span> -out <span class="s2">&#34;</span><span class="nv">$crt_output</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="ln"> 57</span><span class="cl">
</span></span><span class="line"><span class="ln"> 58</span><span class="cl"><span class="c1"># Convert the certificate file to a one-liner with line breaks</span>
</span></span><span class="line"><span class="ln"> 59</span><span class="cl"><span class="nv">crt_contents</span><span class="o">=</span><span class="k">$(</span>awk <span class="s1">&#39;{printf &#34;%s\\n&#34;, $0}&#39;</span> <span class="s2">&#34;</span><span class="nv">$crt_output</span><span class="s2">&#34;</span><span class="k">)</span>
</span></span><span class="line"><span class="ln"> 60</span><span class="cl">
</span></span><span class="line"><span class="ln"> 61</span><span class="cl"><span class="c1"># Replace the certificate and name in the curl body</span>
</span></span><span class="line"><span class="ln"> 62</span><span class="cl"><span class="nv">curl_body</span><span class="o">=</span><span class="s1">&#39;{
</span></span></span><span class="line"><span class="ln"> 63</span><span class="cl"><span class="s1">    &#34;name&#34;: &#34;&#39;</span><span class="s2">&#34;</span><span class="nv">$name</span><span class="s2">&#34;</span><span class="s1">&#39;&#34;,
</span></span></span><span class="line"><span class="ln"> 64</span><span class="cl"><span class="s1">    &#34;node_id&#34;: &#34;&#39;</span><span class="s2">&#34;</span><span class="nv">$name</span><span class="s2">&#34;</span><span class="s1">&#39;&#34;,
</span></span></span><span class="line"><span class="ln"> 65</span><span class="cl"><span class="s1">    &#34;roles_for_paths&#34;: [
</span></span></span><span class="line"><span class="ln"> 66</span><span class="cl"><span class="s1">        {
</span></span></span><span class="line"><span class="ln"> 67</span><span class="cl"><span class="s1">            &#34;path&#34;: &#34;/&#34;,
</span></span></span><span class="line"><span class="ln"> 68</span><span class="cl"><span class="s1">            &#34;roles&#34;: [
</span></span></span><span class="line"><span class="ln"> 69</span><span class="cl"><span class="s1">                {
</span></span></span><span class="line"><span class="ln"> 70</span><span class="cl"><span class="s1">                    &#34;role&#34;: &#34;enterprise_admin&#34;
</span></span></span><span class="line"><span class="ln"> 71</span><span class="cl"><span class="s1">                }
</span></span></span><span class="line"><span class="ln"> 72</span><span class="cl"><span class="s1">            ]
</span></span></span><span class="line"><span class="ln"> 73</span><span class="cl"><span class="s1">        }
</span></span></span><span class="line"><span class="ln"> 74</span><span class="cl"><span class="s1">    ],
</span></span></span><span class="line"><span class="ln"> 75</span><span class="cl"><span class="s1">    &#34;role&#34;: &#34;enterprise_admin&#34;,
</span></span></span><span class="line"><span class="ln"> 76</span><span class="cl"><span class="s1">    &#34;is_protected&#34;: &#34;true&#34;,
</span></span></span><span class="line"><span class="ln"> 77</span><span class="cl"><span class="s1">    &#34;certificate_pem&#34; : &#34;&#39;</span><span class="s2">&#34;</span><span class="nv">$crt_contents</span><span class="s2">&#34;</span><span class="s1">&#39;&#34;
</span></span></span><span class="line"><span class="ln"> 78</span><span class="cl"><span class="s1">}&#39;</span>
</span></span><span class="line"><span class="ln"> 79</span><span class="cl">
</span></span><span class="line"><span class="ln"> 80</span><span class="cl"><span class="c1"># Make the curl request with the updated body</span>
</span></span><span class="line"><span class="ln"> 81</span><span class="cl"><span class="c1"># curl -X POST -H &#34;Content-Type: application/json&#34; -d &#34;$curl_body&#34; https://example.com/api/endpoint</span>
</span></span><span class="line"><span class="ln"> 82</span><span class="cl">curl -ku <span class="s2">&#34;</span><span class="nv">$nsx_admin</span><span class="s2">&#34;</span>:<span class="s2">&#34;</span><span class="nv">$nsx_pass</span><span class="s2">&#34;</span> -X POST https://<span class="s2">&#34;</span><span class="nv">$nsx_mgr</span><span class="s2">&#34;</span>/api/v1/trust-management/principal-identities/with-certificate -H <span class="s2">&#34;Content-Type: application/json&#34;</span> -d <span class="s2">&#34;</span><span class="nv">$curl_body</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="ln"> 83</span><span class="cl">
</span></span><span class="line"><span class="ln"> 84</span><span class="cl"><span class="c1"># Check if a subfolder starting with &#34;antrea-interworking&#34; exists</span>
</span></span><span class="line"><span class="ln"> 85</span><span class="cl"><span class="k">if</span> ls -d antrea-interworking* <span class="p">&amp;</span>&gt;/dev/null<span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="ln"> 86</span><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;Subfolder starting with &#39;antrea-interworking&#39; exists. Skipping extraction.&#34;</span>
</span></span><span class="line"><span class="ln"> 87</span><span class="cl"><span class="k">else</span>
</span></span><span class="line"><span class="ln"> 88</span><span class="cl">    <span class="c1"># Extract the zip file starting with &#34;antrea-interworking&#34;</span>
</span></span><span class="line"><span class="ln"> 89</span><span class="cl">    unzip <span class="s2">&#34;antrea-interworking&#34;</span>*.zip
</span></span><span class="line"><span class="ln"> 90</span><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="ln"> 91</span><span class="cl">
</span></span><span class="line"><span class="ln"> 92</span><span class="cl"><span class="c1"># Create a new folder with the name antrea-interworking-&#34;from-name&#34;</span>
</span></span><span class="line"><span class="ln"> 93</span><span class="cl"><span class="nv">new_folder</span><span class="o">=</span><span class="s2">&#34;antrea-interworking-</span><span class="nv">$name</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="ln"> 94</span><span class="cl">mkdir <span class="s2">&#34;</span><span class="nv">$new_folder</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="ln"> 95</span><span class="cl">
</span></span><span class="line"><span class="ln"> 96</span><span class="cl"><span class="c1"># Copy all YAML files from the antrea-interworking subfolder to the new folder</span>
</span></span><span class="line"><span class="ln"> 97</span><span class="cl">cp antrea-interworking*/<span class="o">{</span>*.yaml,*.yml<span class="o">}</span> <span class="s2">&#34;</span><span class="nv">$new_folder</span><span class="s2">/&#34;</span>
</span></span><span class="line"><span class="ln"> 98</span><span class="cl">
</span></span><span class="line"><span class="ln"> 99</span><span class="cl"><span class="c1"># Replace the field after &#34;image: vmware.io/antrea/interworking&#34; with &#34;image: projects.registry.vmware.com/antreainterworking/interworking-debian&#34; in interworking.yaml</span>
</span></span><span class="line"><span class="ln">100</span><span class="cl">sed -i <span class="s1">&#39;s|image: vmware.io/antrea/interworking|image: projects.registry.vmware.com/antreainterworking/interworking-debian|&#39;</span> <span class="s2">&#34;</span><span class="nv">$new_folder</span><span class="s2">/interworking.yaml&#34;</span>
</span></span><span class="line"><span class="ln">101</span><span class="cl">
</span></span><span class="line"><span class="ln">102</span><span class="cl"><span class="c1"># Replace the field after &#34;image: vmware.io/antrea/interworking&#34; with &#34;image: projects.registry.vmware.com/antreainterworking/interworking-debian&#34; in deregisterjob.yaml</span>
</span></span><span class="line"><span class="ln">103</span><span class="cl">sed -i <span class="s1">&#39;s|image: vmware.io/antrea/interworking|image: projects.registry.vmware.com/antreainterworking/interworking-debian|&#39;</span> <span class="s2">&#34;</span><span class="nv">$new_folder</span><span class="s2">/deregisterjob.yaml&#34;</span>
</span></span><span class="line"><span class="ln">104</span><span class="cl">
</span></span><span class="line"><span class="ln">105</span><span class="cl"><span class="c1"># Edit the bootstrap.yaml file in the new folder</span>
</span></span><span class="line"><span class="ln">106</span><span class="cl">sed -i <span class="s1">&#39;s|clusterName:.*|clusterName: &#39;</span><span class="s2">&#34;</span><span class="nv">$name</span><span class="s2">&#34;</span><span class="s1">&#39;|&#39;</span> <span class="s2">&#34;</span><span class="nv">$new_folder</span><span class="s2">/bootstrap-config.yaml&#34;</span>
</span></span><span class="line"><span class="ln">107</span><span class="cl">sed -i <span class="s1">&#39;s|NSXManagers:.*|NSXManagers: [&#34;&#39;</span><span class="s2">&#34;</span><span class="nv">$nsx_mgr</span><span class="s2">&#34;</span><span class="s1">&#39;&#34;]|&#39;</span> <span class="s2">&#34;</span><span class="nv">$new_folder</span><span class="s2">/bootstrap-config.yaml&#34;</span>
</span></span><span class="line"><span class="ln">108</span><span class="cl"><span class="nv">tls_crt_base64</span><span class="o">=</span><span class="k">$(</span>base64 -w <span class="m">0</span> <span class="s2">&#34;</span><span class="nv">$crt_output</span><span class="s2">&#34;</span><span class="k">)</span>
</span></span><span class="line"><span class="ln">109</span><span class="cl">sed -i <span class="s1">&#39;s|tls.crt:.*|tls.crt: &#39;</span><span class="s2">&#34;</span><span class="nv">$tls_crt_base64</span><span class="s2">&#34;</span><span class="s1">&#39;|&#39;</span> <span class="s2">&#34;</span><span class="nv">$new_folder</span><span class="s2">/bootstrap-config.yaml&#34;</span>
</span></span><span class="line"><span class="ln">110</span><span class="cl"><span class="nv">tls_key_base64</span><span class="o">=</span><span class="k">$(</span>base64 -w <span class="m">0</span> <span class="s2">&#34;</span><span class="nv">$key_name</span><span class="s2">&#34;</span><span class="k">)</span>
</span></span><span class="line"><span class="ln">111</span><span class="cl">sed -i <span class="s1">&#39;s|tls.key:.*|tls.key: &#39;</span><span class="s2">&#34;</span><span class="nv">$tls_key_base64</span><span class="s2">&#34;</span><span class="s1">&#39;|&#39;</span> <span class="s2">&#34;</span><span class="nv">$new_folder</span><span class="s2">/bootstrap-config.yaml&#34;</span>
</span></span><span class="line"><span class="ln">112</span><span class="cl">
</span></span><span class="line"><span class="ln">113</span><span class="cl"><span class="c1"># Interactive prompt to select Kubernetes context</span>
</span></span><span class="line"><span class="ln">114</span><span class="cl">kubectl config get-contexts
</span></span><span class="line"><span class="ln">115</span><span class="cl"><span class="nb">read</span> -p <span class="s2">&#34;Enter the name of the Kubernetes context: &#34;</span> kubectl_context
</span></span><span class="line"><span class="ln">116</span><span class="cl">kubectl config use-context <span class="s2">&#34;</span><span class="nv">$kubectl_context</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="ln">117</span><span class="cl">
</span></span><span class="line"><span class="ln">118</span><span class="cl"><span class="c1"># Apply the bootstrap-config.yaml and interworking.yaml files from the new folder</span>
</span></span><span class="line"><span class="ln">119</span><span class="cl">kubectl apply -f <span class="s2">&#34;</span><span class="nv">$new_folder</span><span class="s2">/bootstrap-config.yaml&#34;</span> -f <span class="s2">&#34;</span><span class="nv">$new_folder</span><span class="s2">/interworking.yaml&#34;</span>
</span></span><span class="line"><span class="ln">120</span><span class="cl">
</span></span><span class="line"><span class="ln">121</span><span class="cl"><span class="c1"># Run the last command to verify that something is happening</span>
</span></span><span class="line"><span class="ln">122</span><span class="cl">kubectl get pods -o wide -n vmware-system-antrea
</span></span><span class="line"><span class="ln">123</span><span class="cl">
</span></span><span class="line"><span class="ln">124</span><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;As it was written each time we ssh&#39;ed into a Suse Linux back in the good old days - Have a lot of fun&#34;</span>
</span></span></code></pre></div><p>As soon as the script has been processed through it should not take long until you have your TKG cluster in the NSX manager:</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="container-cluster-nsx"
      
        class="image_figure image_internal image_processed"
        width="2522"
        height="554"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230604131930482.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Thats it for the NSX-T integration, as soon as that have been done its time to look into what we can do with this integration in the following chapters</p>
<h2 id="antrea-security-policies">Antrea Security Policies</h2>
<p>Antrea has two sets of security policies, Antrea Network Policies (ANP) and Antrea Cluster Network Policies (ACNP). The difference between these two is that ANP is applied on a Kubernetes Namespace and ACNP is cluster-wide. Both belongs to Antrea Native Policies. Both ANP and ACNP can work together with Kubernetes Network Policies.</p>
<p>There are many benefits of using Antrea Native Policies in combination or not in combination with Kubernetes Network Policies.</p>
<p>Some of the benefits of using Antrea Native Policies:</p>
<ul>
<li>Can be tiered</li>
<li>Select both ingress and egress</li>
<li>Support the following actions: allow, drop, reject and pass</li>
<li>Support FQDN filtering in egress (to) with actions allow, drop and reject</li>
</ul>
<h3 id="tiered-policies">Tiered policies</h3>
<p>The benefit of having tiered policies is very useful when for example we have different parts of the organization are responsible for security at different levels/scopes in the platform. Antrea can have policies placed in different tiers where the tiers are evaluated in a given order. If we want some rules to be very early in the policy evaluation and enforced as soon as possible we can place rule in a tier that is considered first, then within the same tier the rules or policies are also being enforced in the order of a given priority, a number. The rule with the lowest number (higher priority) will be evaluated first and then when all rules in a tier has been processed it will go to the next tier. Antrea comes with a set of static tiers already defined. These tier can be shown by running the command:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">linuxvm01:~$ k get tiers
</span></span><span class="line"><span class="ln">2</span><span class="cl">NAME                          PRIORITY   AGE
</span></span><span class="line"><span class="ln">3</span><span class="cl">application                   <span class="m">250</span>        3h11m
</span></span><span class="line"><span class="ln">4</span><span class="cl">baseline                      <span class="m">253</span>        3h11m
</span></span><span class="line"><span class="ln">5</span><span class="cl">emergency                     <span class="m">50</span>         3h11m
</span></span><span class="line"><span class="ln">6</span><span class="cl">networkops                    <span class="m">150</span>        3h11m
</span></span><span class="line"><span class="ln">7</span><span class="cl">platform                      <span class="m">200</span>        3h11m
</span></span><span class="line"><span class="ln">8</span><span class="cl">securityops                   <span class="m">100</span>        3h11m
</span></span></code></pre></div><p>Below will show a diagram of how they look, notice also where the Kubernets network policies will be placed:</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="antrea-tiers"
      
        class="image_figure image_internal image_processed"
        width="2102"
        height="1016"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230604145414788.png"
      
      
    />

    </picture>
</figure>
</p>
<p>There is also the option to add custom tiers using the following CRD (taken from the offical Antrea docs <a href="https://antrea.io/docs/v1.12.0/docs/antrea-network-policy/">here</a>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln">1</span><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">crd.antrea.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Tier</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">mytier</span><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="w">  </span><span class="nt">priority</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w">
</span></span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="w">  </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;my custom tier&#34;</span><span class="w">
</span></span></span></code></pre></div><p>When doing the Antrea NSX integration some additional tiers are added automatically (they start with nsx*):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">linuxvm01:~$ k get tiers
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">NAME                          PRIORITY   AGE
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">application                   <span class="m">250</span>        3h11m
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">baseline                      <span class="m">253</span>        3h11m
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">emergency                     <span class="m">50</span>         3h11m
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">networkops                    <span class="m">150</span>        3h11m
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">nsx-category-application      <span class="m">4</span>          87m
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">nsx-category-emergency        <span class="m">1</span>          87m
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">nsx-category-environment      <span class="m">3</span>          87m
</span></span><span class="line"><span class="ln">10</span><span class="cl">nsx-category-ethernet         <span class="m">0</span>          87m
</span></span><span class="line"><span class="ln">11</span><span class="cl">nsx-category-infrastructure   <span class="m">2</span>          87m
</span></span><span class="line"><span class="ln">12</span><span class="cl">platform                      <span class="m">200</span>        3h11m
</span></span><span class="line"><span class="ln">13</span><span class="cl">securityops                   <span class="m">100</span>        3h11m
</span></span></code></pre></div><p>I can quickly show two examples where I create one rule as a &quot;security-admin&quot;, where this security admin has to follow the company's compliance policy to block access to a certain FQDN. This must be enforced all over. So I need to create this policy in the <em>securityops</em> tier. I could have defined it in the <em>emergency</em> tier also but in this tier it makes more sense to have rules applied that are disabled/not-enforced/idle in case of an emergency and we need a way to quickly enable it and override rules later down the hierarchy. So <em>securityops</em> it is:</p>
<p>Lets apply this one:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">crd.antrea.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterNetworkPolicy</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">acnp-drop-yelb</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">  </span><span class="nt">priority</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">  </span><span class="nt">tier</span><span class="p">:</span><span class="w"> </span><span class="l">securityops</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">  </span><span class="nt">appliedTo</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">  </span>- <span class="nt">podSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">      </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">ubuntu-20-04</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">  </span><span class="nt">egress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">  </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Drop</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">    </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">      </span>- <span class="nt">fqdn</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;yelb-ui.yelb.carefor.some-dns.net&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">      </span>- <span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">        </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">  </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Allow </span><span class="w"> </span><span class="c">#Allow the rest</span><span class="w">
</span></span></span></code></pre></div><p>To check if it is applied and in use (notice under desired nodes and current nodes):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">linuxvm01:~/antrea/policies$ k get acnp
</span></span><span class="line"><span class="ln">2</span><span class="cl">NAME             TIER          PRIORITY   DESIRED NODES   CURRENT NODES   AGE
</span></span><span class="line"><span class="ln">3</span><span class="cl">acnp-drop-yelb   securityops   <span class="m">1</span>          <span class="m">1</span>               <span class="m">1</span>               5m33s
</span></span></code></pre></div><p>Now from a test pod I will try to curl the blocked fqdn and another one not in any block rule:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">root@ubuntu-20-04-548545fc87-kkzbh:/# curl yelb-ui.yelb.cloudburst.somecooldomain.net
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">curl: <span class="o">(</span>6<span class="o">)</span> Could not resolve host: yelb-ui.yelb.cloudburst.somecooldomain.net
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="c1"># Curling a FQDN that is allowed:</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">root@ubuntu-20-04-548545fc87-kkzbh:/# curl allowed-yelb.yelb-2.carefor.some-dns.net
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">&lt;!doctype html&gt;
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">&lt;html&gt;
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">&lt;head&gt;
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">    &lt;meta <span class="nv">charset</span><span class="o">=</span><span class="s2">&#34;utf-8&#34;</span>&gt;
</span></span><span class="line"><span class="ln">10</span><span class="cl">    &lt;title&gt;Yelb&lt;/title&gt;
</span></span><span class="line"><span class="ln">11</span><span class="cl">    &lt;base <span class="nv">href</span><span class="o">=</span><span class="s2">&#34;/&#34;</span>&gt;
</span></span><span class="line"><span class="ln">12</span><span class="cl">    &lt;meta <span class="nv">name</span><span class="o">=</span><span class="s2">&#34;viewport&#34;</span> <span class="nv">content</span><span class="o">=</span><span class="s2">&#34;width=device-width, initial-scale=1&#34;</span>&gt;
</span></span><span class="line"><span class="ln">13</span><span class="cl">    &lt;link <span class="nv">rel</span><span class="o">=</span><span class="s2">&#34;icon&#34;</span> <span class="nv">type</span><span class="o">=</span><span class="s2">&#34;image/x-icon&#34;</span> <span class="nv">href</span><span class="o">=</span><span class="s2">&#34;favicon.ico?v=2&#34;</span>&gt;
</span></span><span class="line"><span class="ln">14</span><span class="cl">&lt;/head&gt;
</span></span><span class="line"><span class="ln">15</span><span class="cl">&lt;body&gt;
</span></span><span class="line"><span class="ln">16</span><span class="cl">&lt;yelb&gt;Loading...&lt;/yelb&gt;
</span></span><span class="line"><span class="ln">17</span><span class="cl">&lt;script <span class="nv">type</span><span class="o">=</span><span class="s2">&#34;text/javascript&#34;</span> <span class="nv">src</span><span class="o">=</span><span class="s2">&#34;inline.bundle.js&#34;</span>&gt;&lt;/script&gt;&lt;script <span class="nv">type</span><span class="o">=</span><span class="s2">&#34;text/javascript&#34;</span> <span class="nv">src</span><span class="o">=</span><span class="s2">&#34;styles.bundle.js&#34;</span>&gt;&lt;/script&gt;&lt;script <span class="nv">type</span><span class="o">=</span><span class="s2">&#34;text/javascript&#34;</span> <span class="nv">src</span><span class="o">=</span><span class="s2">&#34;scripts.bundle.js&#34;</span>&gt;&lt;/script&gt;&lt;script <span class="nv">type</span><span class="o">=</span><span class="s2">&#34;text/javascript&#34;</span> <span class="nv">src</span><span class="o">=</span><span class="s2">&#34;vendor.bundle.js&#34;</span>&gt;&lt;/script&gt;&lt;script <span class="nv">type</span><span class="o">=</span><span class="s2">&#34;text/javascript&#34;</span> <span class="nv">src</span><span class="o">=</span><span class="s2">&#34;main.bundle.js&#34;</span>&gt;&lt;/script&gt;&lt;/body&gt;
</span></span><span class="line"><span class="ln">18</span><span class="cl">&lt;/html&gt;
</span></span></code></pre></div><p>That works as expected. Now what happens then if another use with access to the Kubernetes cluster decide to create a rule later down in the hierarchy, lets go with the application tier, to create an allow rule for this FQDN that is currently being dropped? Lets see what happens</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">crd.antrea.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterNetworkPolicy</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">acnp-allow-yelb</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">  </span><span class="nt">priority</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">  </span><span class="nt">tier</span><span class="p">:</span><span class="w"> </span><span class="l">application</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">  </span><span class="nt">appliedTo</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">  </span>- <span class="nt">podSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">      </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">ubuntu-20-04</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">  </span><span class="nt">egress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">  </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Allow</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">    </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">      </span>- <span class="nt">fqdn</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;yelb-ui.yelb.carefor.some-dns.net&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">      </span>- <span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">        </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">  </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Allow </span><span class="w"> </span><span class="c">#Allow the rest</span><span class="w">
</span></span></span></code></pre></div><p>I will apply this above rule and then try to curl the same fqdn which is supposed to be dropped.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">linuxvm01:~/antrea/policies$ k get acnp
</span></span><span class="line"><span class="ln">2</span><span class="cl">NAME              TIER          PRIORITY   DESIRED NODES   CURRENT NODES   AGE
</span></span><span class="line"><span class="ln">3</span><span class="cl">acnp-allow-yelb   application   <span class="m">1</span>          <span class="m">1</span>               <span class="m">1</span>               4s
</span></span><span class="line"><span class="ln">4</span><span class="cl">acnp-drop-yelb    securityops   <span class="m">1</span>          <span class="m">1</span>               <span class="m">1</span>               5h1m
</span></span></code></pre></div><p>From my test pod again:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">kubectl <span class="nb">exec</span> <span class="o">[</span>POD<span class="o">]</span> <span class="o">[</span>COMMAND<span class="o">]</span> is DEPRECATED and will be removed in a future version. Use kubectl <span class="nb">exec</span> <span class="o">[</span>POD<span class="o">]</span> -- <span class="o">[</span>COMMAND<span class="o">]</span> instead.
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">root@ubuntu-20-04-548545fc87-kkzbh:/# curl yelb-ui.yelb.cloudburst.somecooldomain.net
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">curl: <span class="o">(</span>6<span class="o">)</span> Could not resolve host: yelb-ui.yelb.cloudburst.somecooldomain.net
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">root@ubuntu-20-04-548545fc87-kkzbh:/# curl allowed-yelb.yelb-2.carefor.some-dns.net
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">&lt;!doctype html&gt;
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">&lt;html&gt;
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">&lt;head&gt;
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">    &lt;meta <span class="nv">charset</span><span class="o">=</span><span class="s2">&#34;utf-8&#34;</span>&gt;
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">    &lt;title&gt;Yelb&lt;/title&gt;
</span></span><span class="line"><span class="ln">10</span><span class="cl">    &lt;base <span class="nv">href</span><span class="o">=</span><span class="s2">&#34;/&#34;</span>&gt;
</span></span><span class="line"><span class="ln">11</span><span class="cl">    &lt;meta <span class="nv">name</span><span class="o">=</span><span class="s2">&#34;viewport&#34;</span> <span class="nv">content</span><span class="o">=</span><span class="s2">&#34;width=device-width, initial-scale=1&#34;</span>&gt;
</span></span><span class="line"><span class="ln">12</span><span class="cl">    &lt;link <span class="nv">rel</span><span class="o">=</span><span class="s2">&#34;icon&#34;</span> <span class="nv">type</span><span class="o">=</span><span class="s2">&#34;image/x-icon&#34;</span> <span class="nv">href</span><span class="o">=</span><span class="s2">&#34;favicon.ico?v=2&#34;</span>&gt;
</span></span><span class="line"><span class="ln">13</span><span class="cl">&lt;/head&gt;
</span></span><span class="line"><span class="ln">14</span><span class="cl">&lt;body&gt;
</span></span><span class="line"><span class="ln">15</span><span class="cl">&lt;yelb&gt;Loading...&lt;/yelb&gt;
</span></span><span class="line"><span class="ln">16</span><span class="cl">&lt;script <span class="nv">type</span><span class="o">=</span><span class="s2">&#34;text/javascript&#34;</span> <span class="nv">src</span><span class="o">=</span><span class="s2">&#34;inline.bundle.js&#34;</span>&gt;&lt;/script&gt;&lt;script <span class="nv">type</span><span class="o">=</span><span class="s2">&#34;text/javascript&#34;</span> <span class="nv">src</span><span class="o">=</span><span class="s2">&#34;styles.bundle.js&#34;</span>&gt;&lt;/script&gt;&lt;script <span class="nv">type</span><span class="o">=</span><span class="s2">&#34;text/javascript&#34;</span> <span class="nv">src</span><span class="o">=</span><span class="s2">&#34;scripts.bundle.js&#34;</span>&gt;&lt;/script&gt;&lt;script <span class="nv">type</span><span class="o">=</span><span class="s2">&#34;text/javascript&#34;</span> <span class="nv">src</span><span class="o">=</span><span class="s2">&#34;vendor.bundle.js&#34;</span>&gt;&lt;/script&gt;&lt;script <span class="nv">type</span><span class="o">=</span><span class="s2">&#34;text/javascript&#34;</span> <span class="nv">src</span><span class="o">=</span><span class="s2">&#34;main.bundle.js&#34;</span>&gt;&lt;/script&gt;&lt;/body&gt;
</span></span><span class="line"><span class="ln">17</span><span class="cl">&lt;/html&gt;
</span></span></code></pre></div><p>That was expected. It is still being dropped by the first rule placed in the <em>securityops</em> tier. So far so good. But what if this user also has access to the tier where the first rule is applied? Well, then they can override it. That is why I we can now go to the next chapter.</p>
<h3 id="antrea-rbac">Antrea RBAC</h3>
<p>Antrea comes with a couple of CRDs that allow us to configure granular user permissions on the different objects, like the Policy Tiers.
So to restrict &quot;normal&quot; users from applying and/or delete security polices created in the higher priority Tiers we need to apply some rolebindings, or to be exact ClusterRoleBindings. Let us see how we can achieve that.</p>
<p>In my lab environment I have defined two users, my own admin user (andreasm) that is part of the <code>ClusterRole/cluster-admin</code> and a second user (User1) that is part of the the <code>ClusterRole/view</code>. The ClusterRole View has only read access, not to all objects in the cluster but many. To see what run the following command:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln">  1</span><span class="cl"><span class="l">linuxvm01:~/antrea/policies$ k get clusterrole view -oyaml</span><span class="w">
</span></span></span><span class="line"><span class="ln">  2</span><span class="cl"><span class="w"></span><span class="nt">aggregationRule</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">  3</span><span class="cl"><span class="w">  </span><span class="nt">clusterRoleSelectors</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">  4</span><span class="cl"><span class="w">  </span>- <span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">  5</span><span class="cl"><span class="w">      </span><span class="nt">rbac.authorization.k8s.io/aggregate-to-view</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">  6</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="ln">  7</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRole</span><span class="w">
</span></span></span><span class="line"><span class="ln">  8</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">  9</span><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 10</span><span class="cl"><span class="w">    </span><span class="nt">rbac.authorization.kubernetes.io/autoupdate</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 11</span><span class="cl"><span class="w">  </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2023-06-04T09:37:44Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 12</span><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 13</span><span class="cl"><span class="w">    </span><span class="nt">kubernetes.io/bootstrapping</span><span class="p">:</span><span class="w"> </span><span class="l">rbac-defaults</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 14</span><span class="cl"><span class="w">    </span><span class="nt">rbac.authorization.k8s.io/aggregate-to-edit</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 15</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">view</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 16</span><span class="cl"><span class="w">  </span><span class="nt">resourceVersion</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;1052&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 17</span><span class="cl"><span class="w">  </span><span class="nt">uid</span><span class="p">:</span><span class="w"> </span><span class="l">c4784a81-4451-42af-9134-e141ccf8bc50</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 18</span><span class="cl"><span class="w"></span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 19</span><span class="cl"><span class="w"></span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 20</span><span class="cl"><span class="w">  </span>- <span class="l">crd.antrea.io</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 21</span><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 22</span><span class="cl"><span class="w">  </span>- <span class="l">clustergroups</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 23</span><span class="cl"><span class="w">  </span><span class="nt">verbs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 24</span><span class="cl"><span class="w">  </span>- <span class="l">get</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 25</span><span class="cl"><span class="w">  </span>- <span class="l">list</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 26</span><span class="cl"><span class="w">  </span>- <span class="l">watch</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 27</span><span class="cl"><span class="w"></span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 28</span><span class="cl"><span class="w">  </span>- <span class="l">crd.antrea.io</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 29</span><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 30</span><span class="cl"><span class="w">  </span>- <span class="l">clusternetworkpolicies</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 31</span><span class="cl"><span class="w">  </span>- <span class="l">networkpolicies</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 32</span><span class="cl"><span class="w">  </span><span class="nt">verbs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 33</span><span class="cl"><span class="w">  </span>- <span class="l">get</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 34</span><span class="cl"><span class="w">  </span>- <span class="l">list</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 35</span><span class="cl"><span class="w">  </span>- <span class="l">watch</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 36</span><span class="cl"><span class="w"></span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 37</span><span class="cl"><span class="w">  </span>- <span class="l">crd.antrea.io</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 38</span><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 39</span><span class="cl"><span class="w">  </span>- <span class="l">traceflows</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 40</span><span class="cl"><span class="w">  </span><span class="nt">verbs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 41</span><span class="cl"><span class="w">  </span>- <span class="l">get</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 42</span><span class="cl"><span class="w">  </span>- <span class="l">list</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 43</span><span class="cl"><span class="w">  </span>- <span class="l">watch</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 44</span><span class="cl"><span class="w"></span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 45</span><span class="cl"><span class="w">  </span>- <span class="s2">&#34;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 46</span><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 47</span><span class="cl"><span class="w">  </span>- <span class="l">configmaps</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 48</span><span class="cl"><span class="w">  </span>- <span class="l">endpoints</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 49</span><span class="cl"><span class="w">  </span>- <span class="l">persistentvolumeclaims</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 50</span><span class="cl"><span class="w">  </span>- <span class="l">persistentvolumeclaims/status</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 51</span><span class="cl"><span class="w">  </span>- <span class="l">pods</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 52</span><span class="cl"><span class="w">  </span>- <span class="l">replicationcontrollers</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 53</span><span class="cl"><span class="w">  </span>- <span class="l">replicationcontrollers/scale</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 54</span><span class="cl"><span class="w">  </span>- <span class="l">serviceaccounts</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 55</span><span class="cl"><span class="w">  </span>- <span class="l">services</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 56</span><span class="cl"><span class="w">  </span>- <span class="l">services/status</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 57</span><span class="cl"><span class="w">  </span><span class="nt">verbs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 58</span><span class="cl"><span class="w">  </span>- <span class="l">get</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 59</span><span class="cl"><span class="w">  </span>- <span class="l">list</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 60</span><span class="cl"><span class="w">  </span>- <span class="l">watch</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 61</span><span class="cl"><span class="w"></span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 62</span><span class="cl"><span class="w">  </span>- <span class="s2">&#34;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 63</span><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 64</span><span class="cl"><span class="w">  </span>- <span class="l">bindings</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 65</span><span class="cl"><span class="w">  </span>- <span class="l">events</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 66</span><span class="cl"><span class="w">  </span>- <span class="l">limitranges</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 67</span><span class="cl"><span class="w">  </span>- <span class="l">namespaces/status</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 68</span><span class="cl"><span class="w">  </span>- <span class="l">pods/log</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 69</span><span class="cl"><span class="w">  </span>- <span class="l">pods/status</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 70</span><span class="cl"><span class="w">  </span>- <span class="l">replicationcontrollers/status</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 71</span><span class="cl"><span class="w">  </span>- <span class="l">resourcequotas</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 72</span><span class="cl"><span class="w">  </span>- <span class="l">resourcequotas/status</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 73</span><span class="cl"><span class="w">  </span><span class="nt">verbs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 74</span><span class="cl"><span class="w">  </span>- <span class="l">get</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 75</span><span class="cl"><span class="w">  </span>- <span class="l">list</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 76</span><span class="cl"><span class="w">  </span>- <span class="l">watch</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 77</span><span class="cl"><span class="w"></span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 78</span><span class="cl"><span class="w">  </span>- <span class="s2">&#34;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 79</span><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 80</span><span class="cl"><span class="w">  </span>- <span class="l">namespaces</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 81</span><span class="cl"><span class="w">  </span><span class="nt">verbs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 82</span><span class="cl"><span class="w">  </span>- <span class="l">get</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 83</span><span class="cl"><span class="w">  </span>- <span class="l">list</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 84</span><span class="cl"><span class="w">  </span>- <span class="l">watch</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 85</span><span class="cl"><span class="w"></span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 86</span><span class="cl"><span class="w">  </span>- <span class="l">discovery.k8s.io</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 87</span><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 88</span><span class="cl"><span class="w">  </span>- <span class="l">endpointslices</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 89</span><span class="cl"><span class="w">  </span><span class="nt">verbs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 90</span><span class="cl"><span class="w">  </span>- <span class="l">get</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 91</span><span class="cl"><span class="w">  </span>- <span class="l">list</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 92</span><span class="cl"><span class="w">  </span>- <span class="l">watch</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 93</span><span class="cl"><span class="w"></span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 94</span><span class="cl"><span class="w">  </span>- <span class="l">apps</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 95</span><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 96</span><span class="cl"><span class="w">  </span>- <span class="l">controllerrevisions</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 97</span><span class="cl"><span class="w">  </span>- <span class="l">daemonsets</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 98</span><span class="cl"><span class="w">  </span>- <span class="l">daemonsets/status</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 99</span><span class="cl"><span class="w">  </span>- <span class="l">deployments</span><span class="w">
</span></span></span><span class="line"><span class="ln">100</span><span class="cl"><span class="w">  </span>- <span class="l">deployments/scale</span><span class="w">
</span></span></span><span class="line"><span class="ln">101</span><span class="cl"><span class="w">  </span>- <span class="l">deployments/status</span><span class="w">
</span></span></span><span class="line"><span class="ln">102</span><span class="cl"><span class="w">  </span>- <span class="l">replicasets</span><span class="w">
</span></span></span><span class="line"><span class="ln">103</span><span class="cl"><span class="w">  </span>- <span class="l">replicasets/scale</span><span class="w">
</span></span></span><span class="line"><span class="ln">104</span><span class="cl"><span class="w">  </span>- <span class="l">replicasets/status</span><span class="w">
</span></span></span><span class="line"><span class="ln">105</span><span class="cl"><span class="w">  </span>- <span class="l">statefulsets</span><span class="w">
</span></span></span><span class="line"><span class="ln">106</span><span class="cl"><span class="w">  </span>- <span class="l">statefulsets/scale</span><span class="w">
</span></span></span><span class="line"><span class="ln">107</span><span class="cl"><span class="w">  </span>- <span class="l">statefulsets/status</span><span class="w">
</span></span></span><span class="line"><span class="ln">108</span><span class="cl"><span class="w">  </span><span class="nt">verbs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">109</span><span class="cl"><span class="w">  </span>- <span class="l">get</span><span class="w">
</span></span></span><span class="line"><span class="ln">110</span><span class="cl"><span class="w">  </span>- <span class="l">list</span><span class="w">
</span></span></span><span class="line"><span class="ln">111</span><span class="cl"><span class="w">  </span>- <span class="l">watch</span><span class="w">
</span></span></span><span class="line"><span class="ln">112</span><span class="cl"><span class="w"></span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">113</span><span class="cl"><span class="w">  </span>- <span class="l">autoscaling</span><span class="w">
</span></span></span><span class="line"><span class="ln">114</span><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">115</span><span class="cl"><span class="w">  </span>- <span class="l">horizontalpodautoscalers</span><span class="w">
</span></span></span><span class="line"><span class="ln">116</span><span class="cl"><span class="w">  </span>- <span class="l">horizontalpodautoscalers/status</span><span class="w">
</span></span></span><span class="line"><span class="ln">117</span><span class="cl"><span class="w">  </span><span class="nt">verbs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">118</span><span class="cl"><span class="w">  </span>- <span class="l">get</span><span class="w">
</span></span></span><span class="line"><span class="ln">119</span><span class="cl"><span class="w">  </span>- <span class="l">list</span><span class="w">
</span></span></span><span class="line"><span class="ln">120</span><span class="cl"><span class="w">  </span>- <span class="l">watch</span><span class="w">
</span></span></span><span class="line"><span class="ln">121</span><span class="cl"><span class="w"></span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">122</span><span class="cl"><span class="w">  </span>- <span class="l">batch</span><span class="w">
</span></span></span><span class="line"><span class="ln">123</span><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">124</span><span class="cl"><span class="w">  </span>- <span class="l">cronjobs</span><span class="w">
</span></span></span><span class="line"><span class="ln">125</span><span class="cl"><span class="w">  </span>- <span class="l">cronjobs/status</span><span class="w">
</span></span></span><span class="line"><span class="ln">126</span><span class="cl"><span class="w">  </span>- <span class="l">jobs</span><span class="w">
</span></span></span><span class="line"><span class="ln">127</span><span class="cl"><span class="w">  </span>- <span class="l">jobs/status</span><span class="w">
</span></span></span><span class="line"><span class="ln">128</span><span class="cl"><span class="w">  </span><span class="nt">verbs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">129</span><span class="cl"><span class="w">  </span>- <span class="l">get</span><span class="w">
</span></span></span><span class="line"><span class="ln">130</span><span class="cl"><span class="w">  </span>- <span class="l">list</span><span class="w">
</span></span></span><span class="line"><span class="ln">131</span><span class="cl"><span class="w">  </span>- <span class="l">watch</span><span class="w">
</span></span></span><span class="line"><span class="ln">132</span><span class="cl"><span class="w"></span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">133</span><span class="cl"><span class="w">  </span>- <span class="l">extensions</span><span class="w">
</span></span></span><span class="line"><span class="ln">134</span><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">135</span><span class="cl"><span class="w">  </span>- <span class="l">daemonsets</span><span class="w">
</span></span></span><span class="line"><span class="ln">136</span><span class="cl"><span class="w">  </span>- <span class="l">daemonsets/status</span><span class="w">
</span></span></span><span class="line"><span class="ln">137</span><span class="cl"><span class="w">  </span>- <span class="l">deployments</span><span class="w">
</span></span></span><span class="line"><span class="ln">138</span><span class="cl"><span class="w">  </span>- <span class="l">deployments/scale</span><span class="w">
</span></span></span><span class="line"><span class="ln">139</span><span class="cl"><span class="w">  </span>- <span class="l">deployments/status</span><span class="w">
</span></span></span><span class="line"><span class="ln">140</span><span class="cl"><span class="w">  </span>- <span class="l">ingresses</span><span class="w">
</span></span></span><span class="line"><span class="ln">141</span><span class="cl"><span class="w">  </span>- <span class="l">ingresses/status</span><span class="w">
</span></span></span><span class="line"><span class="ln">142</span><span class="cl"><span class="w">  </span>- <span class="l">networkpolicies</span><span class="w">
</span></span></span><span class="line"><span class="ln">143</span><span class="cl"><span class="w">  </span>- <span class="l">replicasets</span><span class="w">
</span></span></span><span class="line"><span class="ln">144</span><span class="cl"><span class="w">  </span>- <span class="l">replicasets/scale</span><span class="w">
</span></span></span><span class="line"><span class="ln">145</span><span class="cl"><span class="w">  </span>- <span class="l">replicasets/status</span><span class="w">
</span></span></span><span class="line"><span class="ln">146</span><span class="cl"><span class="w">  </span>- <span class="l">replicationcontrollers/scale</span><span class="w">
</span></span></span><span class="line"><span class="ln">147</span><span class="cl"><span class="w">  </span><span class="nt">verbs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">148</span><span class="cl"><span class="w">  </span>- <span class="l">get</span><span class="w">
</span></span></span><span class="line"><span class="ln">149</span><span class="cl"><span class="w">  </span>- <span class="l">list</span><span class="w">
</span></span></span><span class="line"><span class="ln">150</span><span class="cl"><span class="w">  </span>- <span class="l">watch</span><span class="w">
</span></span></span><span class="line"><span class="ln">151</span><span class="cl"><span class="w"></span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">152</span><span class="cl"><span class="w">  </span>- <span class="l">policy</span><span class="w">
</span></span></span><span class="line"><span class="ln">153</span><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">154</span><span class="cl"><span class="w">  </span>- <span class="l">poddisruptionbudgets</span><span class="w">
</span></span></span><span class="line"><span class="ln">155</span><span class="cl"><span class="w">  </span>- <span class="l">poddisruptionbudgets/status</span><span class="w">
</span></span></span><span class="line"><span class="ln">156</span><span class="cl"><span class="w">  </span><span class="nt">verbs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">157</span><span class="cl"><span class="w">  </span>- <span class="l">get</span><span class="w">
</span></span></span><span class="line"><span class="ln">158</span><span class="cl"><span class="w">  </span>- <span class="l">list</span><span class="w">
</span></span></span><span class="line"><span class="ln">159</span><span class="cl"><span class="w">  </span>- <span class="l">watch</span><span class="w">
</span></span></span><span class="line"><span class="ln">160</span><span class="cl"><span class="w"></span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">161</span><span class="cl"><span class="w">  </span>- <span class="l">networking.k8s.io</span><span class="w">
</span></span></span><span class="line"><span class="ln">162</span><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">163</span><span class="cl"><span class="w">  </span>- <span class="l">ingresses</span><span class="w">
</span></span></span><span class="line"><span class="ln">164</span><span class="cl"><span class="w">  </span>- <span class="l">ingresses/status</span><span class="w">
</span></span></span><span class="line"><span class="ln">165</span><span class="cl"><span class="w">  </span>- <span class="l">networkpolicies</span><span class="w">
</span></span></span><span class="line"><span class="ln">166</span><span class="cl"><span class="w">  </span><span class="nt">verbs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">167</span><span class="cl"><span class="w">  </span>- <span class="l">get</span><span class="w">
</span></span></span><span class="line"><span class="ln">168</span><span class="cl"><span class="w">  </span>- <span class="l">list</span><span class="w">
</span></span></span><span class="line"><span class="ln">169</span><span class="cl"><span class="w">  </span>- <span class="l">watch</span><span class="w">
</span></span></span><span class="line"><span class="ln">170</span><span class="cl"><span class="w"></span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">171</span><span class="cl"><span class="w">  </span>- <span class="l">metrics.k8s.io</span><span class="w">
</span></span></span><span class="line"><span class="ln">172</span><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">173</span><span class="cl"><span class="w">  </span>- <span class="l">pods</span><span class="w">
</span></span></span><span class="line"><span class="ln">174</span><span class="cl"><span class="w">  </span>- <span class="l">nodes</span><span class="w">
</span></span></span><span class="line"><span class="ln">175</span><span class="cl"><span class="w">  </span><span class="nt">verbs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">176</span><span class="cl"><span class="w">  </span>- <span class="l">get</span><span class="w">
</span></span></span><span class="line"><span class="ln">177</span><span class="cl"><span class="w">  </span>- <span class="l">list</span><span class="w">
</span></span></span><span class="line"><span class="ln">178</span><span class="cl"><span class="w">  </span>- <span class="l">watch</span><span class="w">
</span></span></span><span class="line"><span class="ln">179</span><span class="cl"><span class="w"></span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">180</span><span class="cl"><span class="w">  </span>- <span class="l">policy</span><span class="w">
</span></span></span><span class="line"><span class="ln">181</span><span class="cl"><span class="w">  </span><span class="nt">resourceNames</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">182</span><span class="cl"><span class="w">  </span>- <span class="l">vmware-system-privileged</span><span class="w">
</span></span></span><span class="line"><span class="ln">183</span><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">184</span><span class="cl"><span class="w">  </span>- <span class="l">podsecuritypolicies</span><span class="w">
</span></span></span><span class="line"><span class="ln">185</span><span class="cl"><span class="w">  </span><span class="nt">verbs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">186</span><span class="cl"><span class="w">  </span>- <span class="l">use</span><span class="w">
</span></span></span></code></pre></div><p>On the other hand my own admin user has access to everything, get, list, create, patch, update, delete - the whole shabang.
What I would like to demonstrate now is that user1 is a regular user and should only be allowed to create security policies in the Tier <em>application</em> while all other Tiers is restricted to the admins that have the responsibility to create policies there. User1 should also not be allowed to create any custom Tiers.</p>
<p>So the first thing I need to create is an Antrea <em>TierEntitlement</em> and <em>TierEntitlementBinding</em> like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">crd.antrea.tanzu.vmware.com/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">TierEntitlement</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">secops-edit</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="nt">tiers</span><span class="p">:</span><span class="w">       </span><span class="c"># Accept list of Tier names. Tier may or may not exist yet.</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">    </span>- <span class="l">emergency</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">    </span>- <span class="l">securityops</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    </span>- <span class="l">networkops</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span>- <span class="l">platform</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">    </span>- <span class="l">baseline</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">    </span><span class="nt">permission</span><span class="p">:</span><span class="w"> </span><span class="l">edit</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">crd.antrea.tanzu.vmware.com/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">TierEntitlementBinding</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">secops-bind</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">  </span><span class="nt">subjects</span><span class="p">:</span><span class="w">                                       </span><span class="c"># List of users to grant this entitlement to</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">  </span>- <span class="w">  </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">User</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">sso:andreasm@cpod-nsxam-stc.az-stc.cloud-garage.net</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">      </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w"></span><span class="c">#  -   kind: Group</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w"></span><span class="c">#      name: security-admins</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w"></span><span class="c">#      apiGroup: rbac.authorization.k8s.io</span><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w"></span><span class="c">#  -   kind: ServiceAccount</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w"></span><span class="c">#      name: network-admins</span><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w"></span><span class="c">#      namespace: kube-system</span><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">  </span><span class="nt">tierEntitlement</span><span class="p">:</span><span class="w"> </span><span class="l">secops-edit             </span><span class="w"> </span><span class="c"># Reference to the TierEntitlement</span><span class="w">
</span></span></span></code></pre></div><p>Now, notice that I am listing the Tiers that should only be available for the users, groups, or ServiceAccounts in the TierEntitlementBinding (I am only using Kind: User in this example). This means that all unlisted tiers should be allowed for other users to place security policies in.</p>
<p>Now apply it:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">linuxvm01:~/antrea/policies$ k apply -f tierentitlement.yaml
</span></span><span class="line"><span class="ln">2</span><span class="cl">tierentitlement.crd.antrea.tanzu.vmware.com/secops-edit created
</span></span><span class="line"><span class="ln">3</span><span class="cl">tierentitlementbinding.crd.antrea.tanzu.vmware.com/secops-bind created
</span></span></code></pre></div><p>Next up is to add my User1 to the Antrea CRD &quot;tiers&quot; to be allowed to list and get the tiers:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRole</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tier-placement</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w"></span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w"></span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;crd.antrea.io&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;tiers&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">  </span><span class="nt">verbs</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;get&#34;</span><span class="p">,</span><span class="s2">&#34;list&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRoleBinding</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tier-bind</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w"></span><span class="nt">subjects</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w"></span>- <span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">User</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">sso:user1@cpod-nsxam-stc.az-stc.cloud-garage.net</span><span class="w"> </span><span class="c"># Name is case sensitive</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">  </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w"></span><span class="nt">roleRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">  </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRole</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tier-placement</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">  </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io</span><span class="w">
</span></span></span></code></pre></div><p>If you want some user to also add/create/delete custom Tiers this can be allowed by adding: <code>&quot;create&quot;,&quot;patch&quot;,&quot;update&quot;,&quot;delete&quot;</code></p>
<p>Now apply the above yaml:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">linuxvm01:~/antrea/policies$ k apply -f antrea-crd-tier-list.yaml
</span></span><span class="line"><span class="ln">2</span><span class="cl">clusterrole.rbac.authorization.k8s.io/tier-placement created
</span></span><span class="line"><span class="ln">3</span><span class="cl">clusterrolebinding.rbac.authorization.k8s.io/tier-bind created
</span></span></code></pre></div><p>I will now log in with the User1 and try to apply this network policy:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">crd.antrea.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterNetworkPolicy</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">override-rule-allow-yelb</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">  </span><span class="nt">priority</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">  </span><span class="nt">tier</span><span class="p">:</span><span class="w"> </span><span class="l">securityops</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">  </span><span class="nt">appliedTo</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">  </span>- <span class="nt">podSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">      </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">ubuntu-20-04</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">  </span><span class="nt">egress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">  </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Allow</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">    </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">      </span>- <span class="nt">fqdn</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;yelb-ui.yelb.carefor.some-dns.net&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">      </span>- <span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">        </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">  </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Allow</span><span class="w">
</span></span></span></code></pre></div><p>As User1:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">linuxvm01:~/antrea/policies$ k apply -f fqdn-rule-secops-tier.test.yaml
</span></span><span class="line"><span class="ln">2</span><span class="cl">Error from server <span class="o">(</span>Forbidden<span class="o">)</span>: error when creating <span class="s2">&#34;fqdn-rule-secops-tier.test.yaml&#34;</span>: clusternetworkpolicies.crd.antrea.io is forbidden: User <span class="s2">&#34;sso:user1@cpod-nsxam-stc.az-stc.cloud-garage.net&#34;</span> cannot create resource <span class="s2">&#34;clusternetworkpolicies&#34;</span> in API group <span class="s2">&#34;crd.antrea.io&#34;</span> at the cluster scope
</span></span></code></pre></div><p>First bump in the road.. This user is not allowed to create any security policies at all.</p>
<p>So I need to use my admin user and apply this ClusterRoleBinding:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRole</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">clusternetworkpolicies-edit</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w"></span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w"></span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;crd.antrea.io&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;clusternetworkpolicies&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">  </span><span class="nt">verbs</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;get&#34;</span><span class="p">,</span><span class="s2">&#34;list&#34;</span><span class="p">,</span><span class="s2">&#34;create&#34;</span><span class="p">,</span><span class="s2">&#34;patch&#34;</span><span class="p">,</span><span class="s2">&#34;update&#34;</span><span class="p">,</span><span class="s2">&#34;delete&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRoleBinding</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">clusternetworkpolicies-bind</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w"></span><span class="nt">subjects</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w"></span>- <span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">User</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">sso:user1@cpod-nsxam-stc.az-stc.cloud-garage.net</span><span class="w"> </span><span class="c"># Name is case sensitive</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">  </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w"></span><span class="nt">roleRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">  </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRole</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">clusternetworkpolicies-edit</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">  </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io</span><span class="w">
</span></span></span></code></pre></div><p>Now the user1 has access to create policies... Lets try again:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">linuxvm01:~/antrea/policies$ k apply -f fqdn-rule-secops-tier.test.yaml
</span></span><span class="line"><span class="ln">2</span><span class="cl">Error from server: error when creating <span class="s2">&#34;fqdn-rule-secops-tier.test.yaml&#34;</span>: admission webhook <span class="s2">&#34;acnpvalidator.antrea.io&#34;</span> denied the request: user not authorized to access Tier securityops
</span></span></code></pre></div><p>There it is, I am not allowed to place any security policies in the tier <em>securityops</em>. That is what I wanted to achieve, so thats good.
What if user1 tries to apply a policy in the <em>application</em> tier? Lets see:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">crd.antrea.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterNetworkPolicy</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">override-attempt-failed-allow-yelb</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">  </span><span class="nt">priority</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">  </span><span class="nt">tier</span><span class="p">:</span><span class="w"> </span><span class="l">application</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">  </span><span class="nt">appliedTo</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">  </span>- <span class="nt">podSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">      </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">ubuntu-20-04</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">  </span><span class="nt">egress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">  </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Allow</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">    </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">      </span>- <span class="nt">fqdn</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;yelb-ui.yelb.carefor.some-dns.net&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">      </span>- <span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">        </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">  </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Allow</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">linuxvm01:~/antrea/policies$ k apply -f fqdn-rule-baseline-tier.test.yaml
</span></span><span class="line"><span class="ln">2</span><span class="cl">clusternetworkpolicy.crd.antrea.io/override-attempt-failed-allow-yelb created
</span></span><span class="line"><span class="ln">3</span><span class="cl">linuxvm01:~/antrea/policies$ k get acnp
</span></span><span class="line"><span class="ln">4</span><span class="cl">NAME                                 TIER          PRIORITY   DESIRED NODES   CURRENT NODES   AGE
</span></span><span class="line"><span class="ln">5</span><span class="cl">acnp-allow-yelb                      application   <span class="m">1</span>          <span class="m">1</span>               <span class="m">1</span>               147m
</span></span><span class="line"><span class="ln">6</span><span class="cl">acnp-drop-yelb                       securityops   <span class="m">1</span>          <span class="m">1</span>               <span class="m">1</span>               18h
</span></span><span class="line"><span class="ln">7</span><span class="cl">override-attempt-failed-allow-yelb   application   <span class="m">1</span>          <span class="m">1</span>               <span class="m">1</span>               11s
</span></span></code></pre></div><p>That worked, even though the above rule is trying to allow access to <em>yelb</em> it will not allow it due to the Drop rule in the <em>securityops</em> Tier. So how much the User1 tries to get this access it will be blocked.</p>
<p>These users....</p>
<p>What if user1 tries to apply the same policy without stating any Tier in in the policy? Lets see:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">crd.antrea.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterNetworkPolicy</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">override-attempt-failed-allow-yelb</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">  </span><span class="nt">priority</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">  </span><span class="nt">appliedTo</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">  </span>- <span class="nt">podSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">      </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">ubuntu-20-04</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">  </span><span class="nt">egress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">  </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Allow</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">    </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">      </span>- <span class="nt">fqdn</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;yelb-ui.yelb.carefor.some-dns.net&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">      </span>- <span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">        </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">  </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Allow</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">linuxvm01:~/antrea/policies$ k apply -f fqdn-rule-no-tier.yaml
</span></span><span class="line"><span class="ln">2</span><span class="cl">clusternetworkpolicy.crd.antrea.io/override-attempt-failed-allow-yelb created
</span></span><span class="line"><span class="ln">3</span><span class="cl">linuxvm01:~/antrea/policies$ k get acnp
</span></span><span class="line"><span class="ln">4</span><span class="cl">NAME                                 TIER          PRIORITY   DESIRED NODES   CURRENT NODES   AGE
</span></span><span class="line"><span class="ln">5</span><span class="cl">acnp-allow-yelb                      application   <span class="m">1</span>          <span class="m">1</span>               <span class="m">1</span>               151m
</span></span><span class="line"><span class="ln">6</span><span class="cl">acnp-drop-yelb                       securityops   <span class="m">1</span>          <span class="m">1</span>               <span class="m">1</span>               18h
</span></span><span class="line"><span class="ln">7</span><span class="cl">override-attempt-failed-allow-yelb   application   <span class="m">1</span>          <span class="m">1</span>               <span class="m">1</span>               10s
</span></span></code></pre></div><p>The rule will be placed in the <em>application</em> Tier, even though the user has permission to create clusternetworkpolicies...</p>
<p>With this the network or security admins have full control of the network policies before and after the <em>application</em> Tier (ref the Tier diagram above).</p>
<p>This example has only shown how to do this on Cluster level, one can also add more granular permission on Namespace level.</p>
<p>So far I have gone over how to manage the Antrea FeatureGates in TKG, how to configure the Antrea-NSX integration, Antrea Policies in general and how to manage RBAC. In the the two next chapters I will cover two different ways how we can apply the Antrea Policies. Lets get into it</p>
<h2 id="how-to-manage-the-antrea-native-policies">How to manage the Antrea Native Policies</h2>
<p>As mentioned previously Antrea Native Policies can be applied from inside the Kubernetes cluster using yaml manifests, but there is also another way to manage them using the NSX manager. As not mentioned previously this opens up for a whole new way of managing security policies. Centrally managed across multiple clusters wherever located, easier adoption of roles and responsibilities. If NSX is already in place, chances are that NSX security policies are already in place and being managed by the network or security admins. Now they can continue doing that but also take into consideration pod network security across the different TKG/Kubernetes clusters.</p>
<h3 id="antrea-security-policies-from-the-nsx-manager">Antrea Security policies from the NSX manager</h3>
<p>After you have connected your TKG clusters to the NSX manager (as shown earlier in this post) you will see the status of these connections in the NSX manager under System -&gt; Fabric -&gt; Nodes:</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="nsx-container-clusters"
      
        class="image_figure image_internal image_processed"
        width="2580"
        height="694"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230605132911898.png"
      
      
    />

    </picture>
</figure>
</p>
<p>The status indicator is also a benefit of this integration as it will show you the status of Antrea Controller, and the components responsible for the Antrea-NSX integration.</p>
<img src=images/image-20230605133035484.png style="width:500px" />
<p>Under inventory we can get all the relevant info from the TKG clusters:</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="inventory"
      
        class="image_figure image_internal image_processed"
        width="2604"
        height="846"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230605133420565.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Where in the screenshot above stc-tkg-cluster 1 and 2 are my TKG Antrea clusters.
I can get all kinds of information like namespaces, pods, labels, ip addresses, names, services. This informaton is relevant as I can use them in my policy creation, but it also gives me status on whether pods, services are up.</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="pods"
      
        class="image_figure image_internal image_processed"
        width="2242"
        height="1524"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230605133627830.png"
      
      
    />

    </picture>
</figure>
</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="labels"
      
        class="image_figure image_internal image_processed"
        width="1164"
        height="748"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230605133657993.png"
      
      
    />

    </picture>
</figure>
</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="services"
      
        class="image_figure image_internal image_processed"
        width="2252"
        height="1514"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230605133728801.png"
      
      
    />

    </picture>
</figure>
</p>
<h3 id="antrea-cluster-network-policies---applied-from-the-nsx-manager">Antrea Cluster Network Policies - Applied from the NSX manager</h3>
<p>With the NSX manager we can create and manage the Antrea Native Policies from the NSX graphical user interface instead of CLI. Using NSX security groups and labels make it also much more fun, but also very easy to maintain know what we do as we can see the policies.</p>
<p>Lets create some policies from the NSX manager microsegmenting my demo application Yelb. This is my demo application, it consists of four pods, and a service called yelb-ui where the webpage is exposed.

  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="yelb"
      
        class="image_figure image_internal image_processed"
        width="1406"
        height="1104"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230605135120736.png"
      
      
    />

    </picture>
</figure>
</p>
<p>I know the different parts of the application (e.g pods) are using labels so I will use them. First let us list them from cli and then get them from the NSX manager.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">linuxvm01:~/antrea/policies$ k get pods -n yelb --show-labels
</span></span><span class="line"><span class="ln">2</span><span class="cl">NAME                              READY   STATUS    RESTARTS   AGE   LABELS
</span></span><span class="line"><span class="ln">3</span><span class="cl">redis-server-69846b4888-5m757     1/1     Running   <span class="m">0</span>          22h   <span class="nv">app</span><span class="o">=</span>redis-server,pod-template-hash<span class="o">=</span>69846b4888,tier<span class="o">=</span>cache
</span></span><span class="line"><span class="ln">4</span><span class="cl">yelb-appserver-857c5c76d5-4cgbq   1/1     Running   <span class="m">0</span>          22h   <span class="nv">app</span><span class="o">=</span>yelb-appserver,pod-template-hash<span class="o">=</span>857c5c76d5,tier<span class="o">=</span>middletier
</span></span><span class="line"><span class="ln">5</span><span class="cl">yelb-db-6bd4fc5d9b-92rkf          1/1     Running   <span class="m">0</span>          22h   <span class="nv">app</span><span class="o">=</span>yelb-db,pod-template-hash<span class="o">=</span>6bd4fc5d9b,tier<span class="o">=</span>backenddb
</span></span><span class="line"><span class="ln">6</span><span class="cl">yelb-ui-6df49457d6-4bktw          1/1     Running   <span class="m">0</span>          20h   <span class="nv">app</span><span class="o">=</span>yelb-ui,pod-template-hash<span class="o">=</span>6df49457d6,tier<span class="o">=</span>frontend
</span></span></code></pre></div><p>Ok, there I have the labels. Fine, just for the sake of it I will find the same labels in the NSX manager also:</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="nsx-pod-labels"
      
        class="image_figure image_internal image_processed"
        width="1858"
        height="1074"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230605140111700.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Now I need to create some security groups in NSX using these labels.</p>
<p>First group is called acnp-yelb-frontend-ui and are using these membership criterias:
(I am also adding the namespace criteria, to exclude any other applications using the same labels in other namespaces).</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="membership-criteria"
      
        class="image_figure image_internal image_processed"
        width="2230"
        height="898"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230605141849979.png"
      
      
    />

    </picture>
</figure>
</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="acnp-yelb-ui"
      
        class="image_figure image_internal image_processed"
        width="1528"
        height="586"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230605140549646.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Now hurry back to the security group and check whether there are any members.... Disappointment. Just empty:</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="membership"
      
        class="image_figure image_internal image_processed"
        width="1956"
        height="1144"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230605140707135.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Fear not, let us quickly create a policy with this group:</p>
<p>Create a new policy and set Antrea Container Clusters in the applied to field:</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="policy"
      
        class="image_figure image_internal image_processed"
        width="1468"
        height="222"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230605140906815.png"
      
      
    />

    </picture>
</figure>
</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="applied-to"
      
        class="image_figure image_internal image_processed"
        width="2238"
        height="930"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230605140810327.png"
      
      
    />

    </picture>
</figure>
</p>
<p>The actual rule:</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="rule"
      
        class="image_figure image_internal image_processed"
        width="2858"
        height="344"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230605141328730.png"
      
      
    />

    </picture>
</figure>
</p>
<p>The rule above allows my AVI Service Engines to reach the web-port on my yelb-ui pod on port 80 (http) as they are the loadbalancer for my application.</p>
<p>Any members in the group now?

  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="members..."
      
        class="image_figure image_internal image_processed"
        width="1958"
        height="560"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230605141412366.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Yes 😃</p>
<p>Now go ahead and create similar groups and rules (except the ports) for the other pods using their respective label.</p>
<p>End result:</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="microseg-yelb"
      
        class="image_figure image_internal image_processed"
        width="3002"
        height="742"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230605145712176.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Do they work? Let us find that out a bit later as I need something to put in my TraceFlow chapter 😄</p>
<p>The rules I have added above was just for the application in the namespace Yelb. If I wanted to extend this ruleset to also include the same application from other clusters its just adding the Kubernetes cluster in the Applied field like this:

  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="add-clusters"
      
        class="image_figure image_internal image_processed"
        width="1916"
        height="1046"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230605173306111.png"
      
      
    />

    </picture>
</figure>
</p>
<h3 id="nsx-distributed-firewall---kubernetes-objects-policies">NSX Distributed Firewall - Kubernetes objects Policies</h3>
<p>In additon to managing the Antrea Native Policies from the NSX manager as above, in the recent NSX release additional features have been added to support security policies enforced in the NSX Distributed Firewall to also cover these components:</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="nsx-dfw-kubernetes"
      
        class="image_figure image_internal image_processed"
        width="472"
        height="534"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230605134554491.png"
      
      
    />

    </picture>
</figure>
</p>
<p>With this we can create security policies in NSX using the distributed firewall to cover the above components using security groups. With this feature its no longer necessary to investigate to get the information about the above components as they are already reported into the NSX manager. Let is do an example of how such a rule can be created and work.</p>
<p>I will create a security policy based on this feature where I will use Kubernetes Service in my example. I will create a security group as above, but this time I will do some different selections. First grab the labels from the service, I will use the yelb-ui service in my example:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">linuxvm01:~/antrea/policies$ k get svc -n yelb --show-labels
</span></span><span class="line"><span class="ln">2</span><span class="cl">NAME             TYPE           CLUSTER-IP      EXTERNAL-IP    PORT<span class="o">(</span>S<span class="o">)</span>        AGE   LABELS
</span></span><span class="line"><span class="ln">3</span><span class="cl">redis-server     ClusterIP      20.10.102.8     &lt;none&gt;         6379/TCP       23h   <span class="nv">app</span><span class="o">=</span>redis-server,tier<span class="o">=</span>cache
</span></span><span class="line"><span class="ln">4</span><span class="cl">yelb-appserver   ClusterIP      20.10.247.130   &lt;none&gt;         4567/TCP       23h   <span class="nv">app</span><span class="o">=</span>yelb-appserver,tier<span class="o">=</span>middletier
</span></span><span class="line"><span class="ln">5</span><span class="cl">yelb-db          ClusterIP      20.10.44.17     &lt;none&gt;         5432/TCP       23h   <span class="nv">app</span><span class="o">=</span>yelb-db,tier<span class="o">=</span>backenddb
</span></span><span class="line"><span class="ln">6</span><span class="cl">yelb-ui          LoadBalancer   20.10.194.179   10.13.210.10   80:30912/TCP   21h   <span class="nv">app</span><span class="o">=</span>yelb-ui,tier<span class="o">=</span>frontend
</span></span></code></pre></div><p>I can either decide to use <em>app=yelb-ui</em> or <em>tier=frontend</em>. Now that I have my labels I will create my security group like this:</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="group-k8s-service"
      
        class="image_figure image_internal image_processed"
        width="1500"
        height="586"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230605150542079.png"
      
      
    />

    </picture>
</figure>
</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="membership-criteria"
      
        class="image_figure image_internal image_processed"
        width="1552"
        height="888"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230605151301908.png"
      
      
    />

    </picture>
</figure>
</p>
<p>I used the name of the service itself and the name of the namespace. This gives me this member:

  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="members"
      
        class="image_figure image_internal image_processed"
        width="1040"
        height="618"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230605151408864.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Which is right...</p>
<p>Now create a security policy using this group where source is another group where I have defined a VM running in the same NSX environment. I have also created a any group which contains just 0.0.0.0/0. Remember that this policy is enforced in the DFW, so there must be something that is running in NSX for this to work, which in my environments is not only the the TKG cluster, but also the Avi Service Engines which acts as LoadBalancer and Ingress for my exposed services. This is kind of important to think of, as the Avi Service Engines communicates with the TKG cluster nodes using NodePortLocal in the default portrange 61000-62000 (if not changed in the Antrea configmap).</p>
<p>Lets see if the below rule works then:</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="kubernetes-service-rule"
      
        class="image_figure image_internal image_processed"
        width="2988"
        height="216"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230606123908794.png"
      
      
    />

    </picture>
</figure>
</p>
<p>I will adjust it to Action Drop:</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="drop"
      
        class="image_figure image_internal image_processed"
        width="2982"
        height="214"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230606123943449.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Test Yelb ui access from my linux vm via curl and my physical laptop's browser, and the results are in:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">ubuntu02:~$ curl yelb-ui.yelb.carefor.some-dns.net
</span></span><span class="line"><span class="ln">2</span><span class="cl">curl: <span class="o">(</span>28<span class="o">)</span> Failed to connect to yelb-ui.yelb.carefor.some-dns.net port 80: Connection timed out
</span></span></code></pre></div><p>From my physical laptop browser:</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="laptop-yelb-ui"
      
        class="image_figure image_internal image_processed"
        width="2434"
        height="1346"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230606100050213.png"
      
      
    />

    </picture>
</figure>
</p>
<p>This will be dropped even though I still have these rules in place from earlier (remember):

  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="antrea-policies"
      
        class="image_figure image_internal image_processed"
        width="2968"
        height="582"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230606100210135.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Now, what about the Avi Service Engines?</p>
<p>If we just look at the rules above, the NSX Kubernetes Service rule and the Antrea Policies rules we are doing the firewall enforcing at two different levels. When creating policies with the Antrea Native Policies, like the one just above, we are applying and enforcing inside the Kubernetes cluster, with the NSX Kubernetes Service rule we are applying and enforcing on the DFW layer. So the Avi Service Engines will first need a policy that is allowing them to communicate to the TKG worker nodes on specific ports/protocol, in my exampe above with Yelb it is port 61002 and TCP. We can see that by looking in Avi UI:</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="avi-se-connectivity"
      
        class="image_figure image_internal image_processed"
        width="1522"
        height="494"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230606115615767.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Regardless of the Avi SE's are using the same DFW as the worker nodes, we need to create this policy for the SE to reach the worker nodes to allow this connection. These policies can either be very &quot;lazy&quot; allowing the SEs on everyting TCP with a range of 61000-62000 to the worker nodes or can be made very granual pr service. The Avi SEs are automatically being grouped in NSX security groups if using Avi with NSX Cloud, explore that.</p>
<p>If we are not allowing the SEs this traffic, we will se this in the Avi UI:</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="avi-se-blocked"
      
        class="image_figure image_internal image_processed"
        width="1474"
        height="528"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230606120425746.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Why is that though, I dont have a default block-all rule in my NSX environment... Well this is because of a set of default rules being created by NCP from TKG.
Have a look at this rule:</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="ncp-rules"
      
        class="image_figure image_internal image_processed"
        width="2982"
        height="580"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230606120713778.png"
      
      
    />

    </picture>
</figure>
</p>
<p>What is the membership in the group used in this Drop rule?

  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="members"
      
        class="image_figure image_internal image_processed"
        width="1656"
        height="1356"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230606120808660.png"
      
      
    />

    </picture>
</figure>
</p>
<p>That is all my TKG nodes including the Supervisor Control Plane nodes (the workload interface).</p>
<p>Now in the Antrea Policies, we need to allow the IP addresses the SEs are using to reach the yelb-ui, as its not the actual client-ip that is being used, it is the SEs dataplane network.</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="traffic-walk"
      
        class="image_figure image_internal image_processed"
        width="2294"
        height="1818"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230606125401326.png"
      
      
    />

    </picture>
</figure>
</p>
<p>The above diagram tries to explain the traffic flow and how it will be enforced.
First the user want to access the VIP of the Yelb UI service. This is allowed by the NSX Firewall saying, yes Port 80 on IP 10.13.210.10 is OK to pass. As this VIP is realized by the Avi SEs, and are on NSX this rule will be enforced by the NSX firewall. Then the Avi SEs will forward (loadbalance) the traffic to the worker node(s) using NodePortLocal ranges between 61000-62000(default) where the worker nodes are also on the same NSX DFW, so we need to allow the SEs to forward this traffic. When all above is allowed, we will get &quot;into&quot; the actual TKG (Kubernetes) cluster and need to negiotiate the Antrea Native Policies that have been applied. These rules remember are allowing the SE dataplane IPs to reach the pod yelb-ui on port 80. And thats it.</p>
<p>Just before we end up this chapter and head over to the next, let us quickly see how the policies created from the NSX manager look like inside the TKG cluster:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">linuxvm01:~/antrea/policies$ k get acnp
</span></span><span class="line"><span class="ln">2</span><span class="cl">NAME                                   TIER                          PRIORITY             DESIRED NODES   CURRENT NODES   AGE
</span></span><span class="line"><span class="ln">3</span><span class="cl">823fca6f-88ee-4032-8150-ac8cf22f1c93   nsx-category-infrastructure   1.000000017763571    <span class="m">3</span>               <span class="m">3</span>               23h
</span></span><span class="line"><span class="ln">4</span><span class="cl">9ae2599a-3bd3-4413-849e-06f53f467559   nsx-category-application      1.0000000532916369   <span class="m">2</span>               <span class="m">2</span>               24h
</span></span></code></pre></div><p>The policies will be placed according to the NSX tiers from the UI:</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="nsx-dfw-categories"
      
        class="image_figure image_internal image_processed"
        width="2034"
        height="324"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230606142208745.png"
      
      
    />

    </picture>
</figure>
</p>
<p>If I describe one of the policies I will get the actual yaml manifest:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="l">linuxvm01:~/antrea/policies$ k get acnp 9ae2599a-3bd3-4413-849e-06f53f467559 -oyaml</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">crd.antrea.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterNetworkPolicy</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="nt">ccp-adapter.antrea.tanzu.vmware.com/display-name</span><span class="p">:</span><span class="w"> </span><span class="l">Yelb-Zero-Trust</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">  </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2023-06-05T12:12:14Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">  </span><span class="nt">generation</span><span class="p">:</span><span class="w"> </span><span class="m">6</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="nt">ccp-adapter.antrea.tanzu.vmware.com/managedBy</span><span class="p">:</span><span class="w"> </span><span class="l">ccp-adapter</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">9ae2599a-3bd3-4413-849e-06f53f467559</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">  </span><span class="nt">resourceVersion</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;404591&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">  </span><span class="nt">uid</span><span class="p">:</span><span class="w"> </span><span class="m">6477e785</span>-<span class="l">fde4-46ba-b0a1-5ff5f784db8c</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">  </span><span class="nt">ingress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">  </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Allow</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">    </span><span class="nt">appliedTo</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">    </span>- <span class="nt">group</span><span class="p">:</span><span class="w"> </span><span class="l">6f39fadf-04e8-4f49-be77-da0d4005ff37</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">    </span><span class="nt">enableLogging</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">    </span><span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">    </span>- <span class="nt">ipBlock</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">        </span><span class="nt">cidr</span><span class="p">:</span><span class="w"> </span><span class="m">10.13.11.101</span><span class="l">/32</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">    </span>- <span class="nt">ipBlock</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">        </span><span class="nt">cidr</span><span class="p">:</span><span class="w"> </span><span class="m">10.13.11.100</span><span class="l">/32</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;4084&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w">    </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w">      </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">  </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Allow</span><span class="w">
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w">    </span><span class="nt">appliedTo</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="w">    </span>- <span class="nt">group</span><span class="p">:</span><span class="w"> </span><span class="l">31cf5eab-8bcd-4305-b72d-f1a44843fd8e</span><span class="w">
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="w">    </span><span class="nt">enableLogging</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="w">    </span><span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="w">    </span>- <span class="nt">group</span><span class="p">:</span><span class="w"> </span><span class="l">6f39fadf-04e8-4f49-be77-da0d4005ff37</span><span class="w">
</span></span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;4085&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">36</span><span class="cl"><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">37</span><span class="cl"><span class="w">    </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">4567</span><span class="w">
</span></span></span><span class="line"><span class="ln">38</span><span class="cl"><span class="w">      </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="ln">39</span><span class="cl"><span class="w">  </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Allow</span><span class="w">
</span></span></span><span class="line"><span class="ln">40</span><span class="cl"><span class="w">    </span><span class="nt">appliedTo</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">41</span><span class="cl"><span class="w">    </span>- <span class="nt">group</span><span class="p">:</span><span class="w"> </span><span class="l">672f4d75-c83b-4fa1-b0ab-ae414c2e8e8c</span><span class="w">
</span></span></span><span class="line"><span class="ln">42</span><span class="cl"><span class="w">    </span><span class="nt">enableLogging</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="ln">43</span><span class="cl"><span class="w">    </span><span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">44</span><span class="cl"><span class="w">    </span>- <span class="nt">group</span><span class="p">:</span><span class="w"> </span><span class="l">31cf5eab-8bcd-4305-b72d-f1a44843fd8e</span><span class="w">
</span></span></span><span class="line"><span class="ln">45</span><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;4087&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">46</span><span class="cl"><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">47</span><span class="cl"><span class="w">    </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">5432</span><span class="w">
</span></span></span><span class="line"><span class="ln">48</span><span class="cl"><span class="w">      </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="ln">49</span><span class="cl"><span class="w">  </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Allow</span><span class="w">
</span></span></span><span class="line"><span class="ln">50</span><span class="cl"><span class="w">    </span><span class="nt">appliedTo</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">51</span><span class="cl"><span class="w">    </span>- <span class="nt">group</span><span class="p">:</span><span class="w"> </span><span class="l">52c3548b-4758-427f-bcde-b25d36613de6</span><span class="w">
</span></span></span><span class="line"><span class="ln">52</span><span class="cl"><span class="w">    </span><span class="nt">enableLogging</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="ln">53</span><span class="cl"><span class="w">    </span><span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">54</span><span class="cl"><span class="w">    </span>- <span class="nt">group</span><span class="p">:</span><span class="w"> </span><span class="l">31cf5eab-8bcd-4305-b72d-f1a44843fd8e</span><span class="w">
</span></span></span><span class="line"><span class="ln">55</span><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;4088&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">56</span><span class="cl"><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">57</span><span class="cl"><span class="w">    </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">6379</span><span class="w">
</span></span></span><span class="line"><span class="ln">58</span><span class="cl"><span class="w">      </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="ln">59</span><span class="cl"><span class="w">  </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Drop</span><span class="w">
</span></span></span><span class="line"><span class="ln">60</span><span class="cl"><span class="w">    </span><span class="nt">appliedTo</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">61</span><span class="cl"><span class="w">    </span>- <span class="nt">group</span><span class="p">:</span><span class="w"> </span><span class="l">d250b7d7-3041-4f7f-8fdf-c7360eee9615</span><span class="w">
</span></span></span><span class="line"><span class="ln">62</span><span class="cl"><span class="w">    </span><span class="nt">enableLogging</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="ln">63</span><span class="cl"><span class="w">    </span><span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">64</span><span class="cl"><span class="w">    </span>- <span class="nt">group</span><span class="p">:</span><span class="w"> </span><span class="l">d250b7d7-3041-4f7f-8fdf-c7360eee9615</span><span class="w">
</span></span></span><span class="line"><span class="ln">65</span><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;4089&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">66</span><span class="cl"><span class="w">  </span><span class="nt">priority</span><span class="p">:</span><span class="w"> </span><span class="m">1.0000000532916369</span><span class="w">
</span></span></span><span class="line"><span class="ln">67</span><span class="cl"><span class="w">  </span><span class="nt">tier</span><span class="p">:</span><span class="w"> </span><span class="l">nsx-category-application</span><span class="w">
</span></span></span><span class="line"><span class="ln">68</span><span class="cl"><span class="w"></span><span class="nt">status</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">69</span><span class="cl"><span class="w">  </span><span class="nt">currentNodesRealized</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span></span></span><span class="line"><span class="ln">70</span><span class="cl"><span class="w">  </span><span class="nt">desiredNodesRealized</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span></span></span><span class="line"><span class="ln">71</span><span class="cl"><span class="w">  </span><span class="nt">observedGeneration</span><span class="p">:</span><span class="w"> </span><span class="m">6</span><span class="w">
</span></span></span><span class="line"><span class="ln">72</span><span class="cl"><span class="w">  </span><span class="nt">phase</span><span class="p">:</span><span class="w"> </span><span class="l">Realized</span><span class="w">
</span></span></span></code></pre></div><h3 id="antrea-security-policies-from-kubernetes-api">Antrea Security policies from kubernetes api</h3>
<p>I have already covered this topic in another post <a href="https://blog.andreasm.io/2021/07/10/antrea-network-policies/">here</a>. Head over and have look, also its worth reading the official documentation page from Antrea <a href="https://antrea.io/docs/v1.12.0/docs/antrea-network-policy/">here</a> as it contains examples and is updated on new features.</p>
<p>One thing I would like to use this chapter for though is trying to apply a policy on the NSX added Tiers when doing the integration (explained above). Remember the Tiers?</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">linuxvm01:~/antrea/policies$ k get tiers
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">NAME                          PRIORITY   AGE
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">application                   <span class="m">250</span>        2d2h
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">baseline                      <span class="m">253</span>        2d2h
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">emergency                     <span class="m">50</span>         2d2h
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">networkops                    <span class="m">150</span>        2d2h
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">nsx-category-application      <span class="m">4</span>          2d
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">nsx-category-emergency        <span class="m">1</span>          2d
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">nsx-category-environment      <span class="m">3</span>          2d
</span></span><span class="line"><span class="ln">10</span><span class="cl">nsx-category-ethernet         <span class="m">0</span>          2d
</span></span><span class="line"><span class="ln">11</span><span class="cl">nsx-category-infrastructure   <span class="m">2</span>          2d
</span></span><span class="line"><span class="ln">12</span><span class="cl">platform                      <span class="m">200</span>        2d2h
</span></span><span class="line"><span class="ln">13</span><span class="cl">securityops                   <span class="m">100</span>        2d2h
</span></span></code></pre></div><p>These nsx* tiers are coming from the NSX manager, but can I as a cluster-owner/editor place rules in here by default? If you look at the PRIORITY of these, they are pretty low.</p>
<p>Let us apply the same rule as used earlier in this post, by just editing in the tier placement:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">crd.antrea.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterNetworkPolicy</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">acnp-nsx-tier-from-kubectl</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">  </span><span class="nt">priority</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">  </span><span class="nt">tier</span><span class="p">:</span><span class="w"> </span><span class="l">nsx-category-environment</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">  </span><span class="nt">appliedTo</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">  </span>- <span class="nt">podSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">      </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">ubuntu-20-04</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">  </span><span class="nt">egress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">  </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Allow</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">    </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">      </span>- <span class="nt">fqdn</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;yelb-ui.yelb.carefor.some-dns.net&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">      </span>- <span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">        </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">  </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Allow</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">linuxvm01:~/antrea/policies$ k apply -f fqdn-rule-nsx-tier.yaml
</span></span><span class="line"><span class="ln">2</span><span class="cl">Error from server: error when creating <span class="s2">&#34;fqdn-rule-nsx-tier.yaml&#34;</span>: admission webhook <span class="s2">&#34;acnpvalidator.antrea.io&#34;</span> denied the request: user not authorized to access Tier nsx-category-environment
</span></span></code></pre></div><p>Even though I am the cluster-owner/admin/superuser I am not allowed to place any rules in these nsx tiers. So this just gives us further control and mechanisms to support both NSX created Antrea policies and Antrea policies from kubectl. This allows for a good control of security enforcement by roles in the organization.</p>
<h2 id="antrea-dashboard">Antrea Dashboard</h2>
<p>As the Octant dashboard is no more, Antrea now has its own dashboard. Its very easy to deploy. Let me quickly go through it. Read more about it <a href="https://github.com/antrea-io/antrea-ui/blob/main/docs/getting-started.md">here</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1"># Add the helm charts</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">helm repo add antrea https://charts.antrea.io
</span></span><span class="line"><span class="ln">3</span><span class="cl">helm repo update
</span></span></code></pre></div><p>Install it:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">helm install antrea-ui antrea/antrea-ui --namespace kube-system
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">linuxvm01:~/antrea/policies$ helm repo add antrea https://charts.antrea.io
</span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="s2">&#34;antrea&#34;</span> has been added to your repositories
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">linuxvm01:~/antrea/policies$ helm repo update
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">Hang tight <span class="k">while</span> we grab the latest from your chart repositories...
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">...Successfully got an update from the <span class="s2">&#34;ako&#34;</span> chart repository
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">...Successfully got an update from the <span class="s2">&#34;antrea&#34;</span> chart repository
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">...Successfully got an update from the <span class="s2">&#34;bitnami&#34;</span> chart repository
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">Update Complete. ⎈Happy Helming!⎈
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">linuxvm01:~/antrea/policies$ helm install antrea-ui antrea/antrea-ui --namespace kube-system
</span></span><span class="line"><span class="ln">10</span><span class="cl">NAME: antrea-ui
</span></span><span class="line"><span class="ln">11</span><span class="cl">LAST DEPLOYED: Tue Jun  <span class="m">6</span> 12:56:21 <span class="m">2023</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">NAMESPACE: kube-system
</span></span><span class="line"><span class="ln">13</span><span class="cl">STATUS: deployed
</span></span><span class="line"><span class="ln">14</span><span class="cl">REVISION: <span class="m">1</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">TEST SUITE: None
</span></span><span class="line"><span class="ln">16</span><span class="cl">NOTES:
</span></span><span class="line"><span class="ln">17</span><span class="cl">The Antrea UI has been successfully installed
</span></span><span class="line"><span class="ln">18</span><span class="cl">
</span></span><span class="line"><span class="ln">19</span><span class="cl">You are using version 0.1.1
</span></span><span class="line"><span class="ln">20</span><span class="cl">
</span></span><span class="line"><span class="ln">21</span><span class="cl">To access the UI, forward a <span class="nb">local</span> port to the antrea-ui service, and connect to
</span></span><span class="line"><span class="ln">22</span><span class="cl">that port locally with your browser:
</span></span><span class="line"><span class="ln">23</span><span class="cl">
</span></span><span class="line"><span class="ln">24</span><span class="cl">  $ kubectl -n kube-system port-forward service/antrea-ui 3000:3000
</span></span><span class="line"><span class="ln">25</span><span class="cl">
</span></span><span class="line"><span class="ln">26</span><span class="cl">After running the <span class="nb">command</span> above, access <span class="s2">&#34;http://localhost:3000&#34;</span> in your browser.For the Antrea documentation, please visit https://antrea.io
</span></span></code></pre></div><p>This will spin up a new pod, and a clusterip service.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">linuxvm01:~/antrea/policies$ k get pods -n kube-system
</span></span><span class="line"><span class="ln">2</span><span class="cl">NAME                                                                    READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="ln">3</span><span class="cl">antrea-agent-9rvqc                                                      2/2     Running   <span class="m">0</span>          2d16h
</span></span><span class="line"><span class="ln">4</span><span class="cl">antrea-agent-m7rg7                                                      2/2     Running   <span class="m">0</span>          2d16h
</span></span><span class="line"><span class="ln">5</span><span class="cl">antrea-agent-wvpp8                                                      2/2     Running   <span class="m">0</span>          2d16h
</span></span><span class="line"><span class="ln">6</span><span class="cl">antrea-controller-6d56b6d664-vlmh2                                      1/1     Running   <span class="m">0</span>          2d16h
</span></span><span class="line"><span class="ln">7</span><span class="cl">antrea-ui-9c89486f4-msw6m                                               2/2     Running   <span class="m">0</span>          62s
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">linuxvm01:~/antrea/policies$ k get svc -n kube-system
</span></span><span class="line"><span class="ln">2</span><span class="cl">NAME             TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>                  AGE
</span></span><span class="line"><span class="ln">3</span><span class="cl">antrea           ClusterIP   20.10.96.45     &lt;none&gt;        443/TCP                  2d16h
</span></span><span class="line"><span class="ln">4</span><span class="cl">antrea-ui        ClusterIP   20.10.228.144   &lt;none&gt;        3000/TCP                 95s
</span></span></code></pre></div><p>Now instead of exposing the service as nodeport, I am just creating a serviceType loadBalancer for it like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">antrea-dashboard-ui</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">antrea-ui</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-system</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">  </span><span class="nt">loadBalancerClass</span><span class="p">:</span><span class="w"> </span><span class="l">ako.vmware.com/avi-lb</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">LoadBalancer</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">  </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">    </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">    </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">3000</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">antrea-ui</span><span class="w">
</span></span></span></code></pre></div><p>Apply it:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">linuxvm01:~/antrea$ k apply -f antrea-dashboard-lb-yaml
</span></span><span class="line"><span class="ln">2</span><span class="cl">service/antrea-dashboard-ui created
</span></span><span class="line"><span class="ln">3</span><span class="cl">linuxvm01:~/antrea$ k get svc -n kube-system
</span></span><span class="line"><span class="ln">4</span><span class="cl">NAME                  TYPE           CLUSTER-IP      EXTERNAL-IP    PORT<span class="o">(</span>S<span class="o">)</span>                  AGE
</span></span><span class="line"><span class="ln">5</span><span class="cl">antrea                ClusterIP      20.10.96.45     &lt;none&gt;         443/TCP                  2d16h
</span></span><span class="line"><span class="ln">6</span><span class="cl">antrea-dashboard-ui   LoadBalancer   20.10.76.243    10.13.210.12   80:31334/TCP             7s
</span></span><span class="line"><span class="ln">7</span><span class="cl">antrea-ui             ClusterIP      20.10.228.144   &lt;none&gt;         3000/TCP                 8m47s
</span></span></code></pre></div><p>Now access it through my browser:</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="antrea-dashboard"
      
        class="image_figure image_internal image_processed"
        width="1162"
        height="654"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230606150616863.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Default password is <em>admin</em></p>
<p>Good overview:</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="overview"
      
        class="image_figure image_internal image_processed"
        width="3568"
        height="1388"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230606150658425.png"
      
      
    />

    </picture>
</figure>
</p>
<p>The option to do Traceflow:</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="traceflow"
      
        class="image_figure image_internal image_processed"
        width="2796"
        height="1672"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230606150830064.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Oops, dropped by a NetworkPolicy... Where does that come from 🤔 ... More on this later.</p>
<h2 id="antrea-network-monitoring">Antrea Network Monitoring</h2>
<p>Being able to know what's going on is crucial when planning security policies, but also to know if the policies are working and being enforced. With that information available we can know if we are compliant with the policies apllied. Without any network flow information we are kind of in the blind. Luckily Antrea is fully capable of report full flow information, and export it.
To be able to export the flow information we need to enable the FeatureGate FlowExporter:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">cni.tanzu.vmware.com/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">AntreaConfig</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">stc-tkg-cluster-1-antrea-package</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">ns-stc-1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">  </span><span class="nt">antrea</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">    </span><span class="nt">config</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">      </span><span class="nt">featureGates</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">        </span><span class="nt">AntreaProxy</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">        </span><span class="nt">EndpointSlice</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">        </span><span class="nt">AntreaPolicy</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">        </span><span class="nt">FlowExporter</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="c">#This needs to be enabled</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">        </span><span class="nt">Egress</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">        </span><span class="nt">NodePortLocal</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">        </span><span class="nt">AntreaTraceflow</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">        </span><span class="nt">NetworkPolicyStats</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span></code></pre></div><h3 id="flow-exporter---ipfix">Flow-Exporter - IPFIX</h3>
<p>From the offical Antrea documentation:</p>
<blockquote>
<p><a href="https://antrea.io/docs/v1.12.0/docs/design/architecture/">Antrea</a> is a Kubernetes network plugin that provides network connectivity and security features for Pod workloads. Considering the scale and dynamism of Kubernetes workloads in a cluster, Network Flow Visibility helps in the management and configuration of Kubernetes resources such as Network Policy, Services, Pods etc., and thereby provides opportunities to enhance the performance and security aspects of Pod workloads.</p>
<p>For visualizing the network flows, Antrea monitors the flows in Linux conntrack module. These flows are converted to flow records, and then flow records are post-processed before they are sent to the configured external flow collector. High-level design is given below:</p>
</blockquote>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="flow-aggregator"
      
        class="image_figure image_internal image_processed"
        width="1462"
        height="852"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230607151241739.png"
      
      
    />

    </picture>
</figure>
</p>
<p>From the Antrea official documentation again:</p>
<blockquote>
<p><strong>Flow Exporter</strong></p>
<p>In Antrea, the basic building block for the Network Flow Visibility is the <strong>Flow Exporter</strong>. Flow Exporter operates within Antrea Agent; it builds and maintains a connection store by polling and dumping flows from conntrack module periodically. Connections from the connection store are exported to the <a href="https://antrea.io/docs/v1.12.0/docs/network-flow-visibility/#flow-aggregator">Flow Aggregator Service</a> using the IPFIX protocol, and for this purpose we use the IPFIX exporter process from the <a href="https://github.com/vmware/go-ipfix">go-ipfix</a> library.</p>
</blockquote>
<p>Read more Network Flow Visibility in Antrea <a href="https://antrea.io/docs/v1.12.0/docs/network-flow-visibility/">here</a>.</p>
<h3 id="traceflow">Traceflow</h3>
<p>When troubleshooting network issues or even firewall rules (is my traffic being blocked or allowed?) it is very handy to have the option to do Traceflow. Antrea supports Traceflow. To be able to use Traceflow, the AntreaTraceFlow FeatureGate needs to be enabled if not already.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">cni.tanzu.vmware.com/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">AntreaConfig</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">stc-tkg-cluster-1-antrea-package</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">ns-stc-1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">  </span><span class="nt">antrea</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">    </span><span class="nt">config</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">      </span><span class="nt">featureGates</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">        </span><span class="nt">AntreaProxy</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">        </span><span class="nt">EndpointSlice</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">        </span><span class="nt">AntreaPolicy</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">        </span><span class="nt">FlowExporter</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">        </span><span class="nt">Egress</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">        </span><span class="nt">NodePortLocal</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">        </span><span class="nt">AntreaTraceflow</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="c">#This needs to be enabled</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">        </span><span class="nt">NetworkPolicyStats</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span></code></pre></div><p>Now that it is enabled, how can we perform Traceflow?</p>
<p>We can do Traceflow using kubectl, Antrea UI or even from the NSX manager if using the NSX/Antrea integration.</p>
<p>Traceflow in Antrea supports the following:</p>
<ul>
<li>Source: pod, protocol (TCP/UDP/ICMP) and port numbers</li>
<li>Destination: pod, service, ip, protocol (TCP/UDP/ICMP) and port numbers</li>
<li>One time Traceflow or live</li>
</ul>
<p>Now to get back to my Antrea policies created earlier I want to test if they are actually being in use and enforced. So let me do a Traceflow form my famous Yelb-ui pod and see if it can reach the application pod on its allowed port. Remember that the UI pod needed to communicate with the appserver pod on TCP 4567 and that I created a rule that only allows this, all else is blocked.</p>
<p>If I want to do Traceflow from kubectl, this is an example to test if port 4567 is allowed from ui pod to appserver pod:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">crd.antrea.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Traceflow</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tf-test</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">  </span><span class="nt">source</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">yelb</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">    </span><span class="nt">pod</span><span class="p">:</span><span class="w"> </span><span class="l">yelb-ui-6df49457d6-m5clv</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">  </span><span class="nt">destination</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">yelb</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">    </span><span class="nt">pod</span><span class="p">:</span><span class="w"> </span><span class="l">yelb-appserver-857c5c76d5-4cd86</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">    </span><span class="c"># destination can also be an IP address (&#39;ip&#39; field) or a Service name (&#39;service&#39; field); the 3 choices are mutually exclusive.</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">  </span><span class="nt">packet</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">    </span><span class="nt">ipHeader</span><span class="p">:</span><span class="w"> </span><span class="c"># If ipHeader/ipv6Header is not set, the default value is IPv4+ICMP.</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">      </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="m">6</span><span class="w"> </span><span class="c"># Protocol here can be 6 (TCP), 17 (UDP) or 1 (ICMP), default value is 1 (ICMP)</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">    </span><span class="nt">transportHeader</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">      </span><span class="nt">tcp</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">        </span><span class="nt">srcPort</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="c"># Source port needs to be set when Protocol is TCP/UDP.</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">        </span><span class="nt">dstPort</span><span class="p">:</span><span class="w"> </span><span class="m">4567</span><span class="w"> </span><span class="c"># Destination port needs to be set when Protocol is TCP/UDP.</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">        </span><span class="nt">flags: 2 # Construct a SYN packet</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="l">is also the default value when the flags field is omitted.</span><span class="w">
</span></span></span></code></pre></div><p>Now apply it and get the output:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">linuxvm01:~/antrea/policies$ k apply -f traceflow.yaml
</span></span><span class="line"><span class="ln">2</span><span class="cl">traceflow.crd.antrea.io/tf-test created
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="l">linuxvm01:~/antrea/policies$ k get traceflows.crd.antrea.io -n yelb tf-test -oyaml</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">crd.antrea.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Traceflow</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="nt">kubectl.kubernetes.io/last-applied-configuration</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="sd">      {&#34;apiVersion&#34;:&#34;crd.antrea.io/v1alpha1&#34;,&#34;kind&#34;:&#34;Traceflow&#34;,&#34;metadata&#34;:{&#34;annotations&#34;:{},&#34;name&#34;:&#34;tf-test&#34;},&#34;spec&#34;:{&#34;destination&#34;:{&#34;namespace&#34;:&#34;yelb&#34;,&#34;pod&#34;:&#34;yelb-appserver-857c5c76d5-4cd86&#34;},&#34;packet&#34;:{&#34;ipHeader&#34;:{&#34;protocol&#34;:6},&#34;transportHeader&#34;:{&#34;tcp&#34;:{&#34;dstPort&#34;:4567,&#34;flags&#34;:2,&#34;srcPort&#34;:0}}},&#34;source&#34;:{&#34;namespace&#34;:&#34;yelb&#34;,&#34;pod&#34;:&#34;yelb-ui-6df49457d6-m5clv&#34;}}}</span><span class="w">      
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">  </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2023-06-07T12:47:14Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">  </span><span class="nt">generation</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tf-test</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">  </span><span class="nt">resourceVersion</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;904386&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">  </span><span class="nt">uid</span><span class="p">:</span><span class="w"> </span><span class="l">c550596b-ed43-4bab-a6f1-d23e90d35f84</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">  </span><span class="nt">destination</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">yelb</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">    </span><span class="nt">pod</span><span class="p">:</span><span class="w"> </span><span class="l">yelb-appserver-857c5c76d5-4cd86</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">  </span><span class="nt">packet</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">    </span><span class="nt">ipHeader</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">      </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="m">6</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">    </span><span class="nt">transportHeader</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">      </span><span class="nt">tcp</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">        </span><span class="nt">dstPort</span><span class="p">:</span><span class="w"> </span><span class="m">4567</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">        </span><span class="nt">flags</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">        </span><span class="nt">srcPort</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">  </span><span class="nt">source</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">yelb</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w">    </span><span class="nt">pod</span><span class="p">:</span><span class="w"> </span><span class="l">yelb-ui-6df49457d6-m5clv</span><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w"></span><span class="nt">status</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">  </span><span class="nt">phase</span><span class="p">:</span><span class="w"> </span><span class="l">Succeeded</span><span class="w">
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w">  </span><span class="nt">results</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="w">  </span>- <span class="nt">node</span><span class="p">:</span><span class="w"> </span><span class="l">stc-tkg-cluster-1-node-pool-01-p6nms-84c55d4574-5r8gj</span><span class="w">
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="w">    </span><span class="nt">observations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="w">    </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Received</span><span class="w">
</span></span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="w">      </span><span class="nt">component</span><span class="p">:</span><span class="w"> </span><span class="l">Forwarding</span><span class="w">
</span></span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="w">    </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Forwarded</span><span class="w">
</span></span></span><span class="line"><span class="ln">36</span><span class="cl"><span class="w">      </span><span class="nt">component</span><span class="p">:</span><span class="w"> </span><span class="l">NetworkPolicy</span><span class="w">
</span></span></span><span class="line"><span class="ln">37</span><span class="cl"><span class="w">      </span><span class="nt">componentInfo</span><span class="p">:</span><span class="w"> </span><span class="l">IngressRule</span><span class="w">
</span></span></span><span class="line"><span class="ln">38</span><span class="cl"><span class="w">      </span><span class="nt">networkPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">AntreaClusterNetworkPolicy:9ae2599a-3bd3-4413-849e-06f53f467559</span><span class="w">
</span></span></span><span class="line"><span class="ln">39</span><span class="cl"><span class="w">    </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Delivered</span><span class="w">
</span></span></span><span class="line"><span class="ln">40</span><span class="cl"><span class="w">      </span><span class="nt">component</span><span class="p">:</span><span class="w"> </span><span class="l">Forwarding</span><span class="w">
</span></span></span><span class="line"><span class="ln">41</span><span class="cl"><span class="w">      </span><span class="nt">componentInfo</span><span class="p">:</span><span class="w"> </span><span class="l">Output</span><span class="w">
</span></span></span><span class="line"><span class="ln">42</span><span class="cl"><span class="w">    </span><span class="nt">timestamp</span><span class="p">:</span><span class="w"> </span><span class="m">1686142036</span><span class="w">
</span></span></span><span class="line"><span class="ln">43</span><span class="cl"><span class="w">  </span>- <span class="nt">node</span><span class="p">:</span><span class="w"> </span><span class="l">stc-tkg-cluster-1-node-pool-01-p6nms-84c55d4574-bpx7s</span><span class="w">
</span></span></span><span class="line"><span class="ln">44</span><span class="cl"><span class="w">    </span><span class="nt">observations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">45</span><span class="cl"><span class="w">    </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Forwarded</span><span class="w">
</span></span></span><span class="line"><span class="ln">46</span><span class="cl"><span class="w">      </span><span class="nt">component</span><span class="p">:</span><span class="w"> </span><span class="l">SpoofGuard</span><span class="w">
</span></span></span><span class="line"><span class="ln">47</span><span class="cl"><span class="w">    </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Forwarded</span><span class="w">
</span></span></span><span class="line"><span class="ln">48</span><span class="cl"><span class="w">      </span><span class="nt">component</span><span class="p">:</span><span class="w"> </span><span class="l">Forwarding</span><span class="w">
</span></span></span><span class="line"><span class="ln">49</span><span class="cl"><span class="w">      </span><span class="nt">componentInfo</span><span class="p">:</span><span class="w"> </span><span class="l">Output</span><span class="w">
</span></span></span><span class="line"><span class="ln">50</span><span class="cl"><span class="w">      </span><span class="nt">tunnelDstIP</span><span class="p">:</span><span class="w"> </span><span class="m">10.13.82.39</span><span class="w">
</span></span></span><span class="line"><span class="ln">51</span><span class="cl"><span class="w">    </span><span class="nt">timestamp</span><span class="p">:</span><span class="w"> </span><span class="m">1686142036</span><span class="w">
</span></span></span><span class="line"><span class="ln">52</span><span class="cl"><span class="w">  </span><span class="nt">startTime</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2023-06-07T12:47:14Z&#34;</span><span class="w">
</span></span></span></code></pre></div><p>That was a success. <em>- action: Forwarded</em></p>
<p>Now I want to run it again but with another port. So I change the above yaml to use port 4568 (which should not be allowed):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="l">linuxvm01:~/antrea/policies$ k get traceflows.crd.antrea.io -n yelb tf-test -oyaml</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">crd.antrea.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Traceflow</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="nt">kubectl.kubernetes.io/last-applied-configuration</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="sd">      {&#34;apiVersion&#34;:&#34;crd.antrea.io/v1alpha1&#34;,&#34;kind&#34;:&#34;Traceflow&#34;,&#34;metadata&#34;:{&#34;annotations&#34;:{},&#34;name&#34;:&#34;tf-test&#34;},&#34;spec&#34;:{&#34;destination&#34;:{&#34;namespace&#34;:&#34;yelb&#34;,&#34;pod&#34;:&#34;yelb-appserver-857c5c76d5-4cd86&#34;},&#34;packet&#34;:{&#34;ipHeader&#34;:{&#34;protocol&#34;:6},&#34;transportHeader&#34;:{&#34;tcp&#34;:{&#34;dstPort&#34;:4568,&#34;flags&#34;:2,&#34;srcPort&#34;:0}}},&#34;source&#34;:{&#34;namespace&#34;:&#34;yelb&#34;,&#34;pod&#34;:&#34;yelb-ui-6df49457d6-m5clv&#34;}}}</span><span class="w">      
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">  </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2023-06-07T12:53:59Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">  </span><span class="nt">generation</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tf-test</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">  </span><span class="nt">resourceVersion</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;905571&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">  </span><span class="nt">uid</span><span class="p">:</span><span class="w"> </span><span class="l">d76ec419-3272-4595-98a5-72a49adce9d3</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">  </span><span class="nt">destination</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">yelb</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">    </span><span class="nt">pod</span><span class="p">:</span><span class="w"> </span><span class="l">yelb-appserver-857c5c76d5-4cd86</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">  </span><span class="nt">packet</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">    </span><span class="nt">ipHeader</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">      </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="m">6</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">    </span><span class="nt">transportHeader</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">      </span><span class="nt">tcp</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">        </span><span class="nt">dstPort</span><span class="p">:</span><span class="w"> </span><span class="m">4568</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">        </span><span class="nt">flags</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">        </span><span class="nt">srcPort</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">  </span><span class="nt">source</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">yelb</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w">    </span><span class="nt">pod</span><span class="p">:</span><span class="w"> </span><span class="l">yelb-ui-6df49457d6-m5clv</span><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w"></span><span class="nt">status</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">  </span><span class="nt">phase</span><span class="p">:</span><span class="w"> </span><span class="l">Succeeded</span><span class="w">
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w">  </span><span class="nt">results</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="w">  </span>- <span class="nt">node</span><span class="p">:</span><span class="w"> </span><span class="l">stc-tkg-cluster-1-node-pool-01-p6nms-84c55d4574-bpx7s</span><span class="w">
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="w">    </span><span class="nt">observations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="w">    </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Forwarded</span><span class="w">
</span></span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="w">      </span><span class="nt">component</span><span class="p">:</span><span class="w"> </span><span class="l">SpoofGuard</span><span class="w">
</span></span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="w">    </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Forwarded</span><span class="w">
</span></span></span><span class="line"><span class="ln">36</span><span class="cl"><span class="w">      </span><span class="nt">component</span><span class="p">:</span><span class="w"> </span><span class="l">Forwarding</span><span class="w">
</span></span></span><span class="line"><span class="ln">37</span><span class="cl"><span class="w">      </span><span class="nt">componentInfo</span><span class="p">:</span><span class="w"> </span><span class="l">Output</span><span class="w">
</span></span></span><span class="line"><span class="ln">38</span><span class="cl"><span class="w">      </span><span class="nt">tunnelDstIP</span><span class="p">:</span><span class="w"> </span><span class="m">10.13.82.39</span><span class="w">
</span></span></span><span class="line"><span class="ln">39</span><span class="cl"><span class="w">    </span><span class="nt">timestamp</span><span class="p">:</span><span class="w"> </span><span class="m">1686142441</span><span class="w">
</span></span></span><span class="line"><span class="ln">40</span><span class="cl"><span class="w">  </span>- <span class="nt">node</span><span class="p">:</span><span class="w"> </span><span class="l">stc-tkg-cluster-1-node-pool-01-p6nms-84c55d4574-5r8gj</span><span class="w">
</span></span></span><span class="line"><span class="ln">41</span><span class="cl"><span class="w">    </span><span class="nt">observations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">42</span><span class="cl"><span class="w">    </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Received</span><span class="w">
</span></span></span><span class="line"><span class="ln">43</span><span class="cl"><span class="w">      </span><span class="nt">component</span><span class="p">:</span><span class="w"> </span><span class="l">Forwarding</span><span class="w">
</span></span></span><span class="line"><span class="ln">44</span><span class="cl"><span class="w">    </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Dropped</span><span class="w">
</span></span></span><span class="line"><span class="ln">45</span><span class="cl"><span class="w">      </span><span class="nt">component</span><span class="p">:</span><span class="w"> </span><span class="l">NetworkPolicy</span><span class="w">
</span></span></span><span class="line"><span class="ln">46</span><span class="cl"><span class="w">      </span><span class="nt">componentInfo</span><span class="p">:</span><span class="w"> </span><span class="l">IngressMetric</span><span class="w">
</span></span></span><span class="line"><span class="ln">47</span><span class="cl"><span class="w">      </span><span class="nt">networkPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">AntreaClusterNetworkPolicy:9ae2599a-3bd3-4413-849e-06f53f467559</span><span class="w">
</span></span></span><span class="line"><span class="ln">48</span><span class="cl"><span class="w">    </span><span class="nt">timestamp</span><span class="p">:</span><span class="w"> </span><span class="m">1686142441</span><span class="w">
</span></span></span><span class="line"><span class="ln">49</span><span class="cl"><span class="w">  </span><span class="nt">startTime</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2023-06-07T12:53:59Z&#34;</span><span class="w">
</span></span></span></code></pre></div><p>That was also a success, as it was dropped by design: <em>- action: Dropped</em></p>
<p>Its great being able to do this from kubectl, if one quickly need to check this before starting to look somewhere else and create a support ticket 😃 or one dont have access to other tools like the Antrea UI or even the NSX manager, speaking of NSX manager. Let us do the exact same trace from the NSX manager gui:</p>
<p>Head over Plan&amp;Troubleshoot -&gt; Traffic Analysis:</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="nsx-analysis"
      
        class="image_figure image_internal image_processed"
        width="2792"
        height="1588"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230607145857688.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Results:</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="nsx-result-allowed"
      
        class="image_figure image_internal image_processed"
        width="2344"
        height="1184"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230607145936360.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Now I change it to another port again and test it again:</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="nsx-result-dropped"
      
        class="image_figure image_internal image_processed"
        width="2320"
        height="928"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230607150027405.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Dropped again.</p>
<p>The same procedure can also be done from the Antrea UI as shown above, now with a port that is allowed:</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="image-20230607150201116"
      
        class="image_figure image_internal image_processed"
        width="2208"
        height="1876"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230607150201116.png"
      
      
    />

    </picture>
</figure>
</p>
<p>To read more on Traceflow in Antrea, head over <a href="https://antrea.io/docs/v1.12.0/docs/traceflow-guide/">here</a>.</p>
<h3 id="theia">Theia</h3>
<p>Now that we have know it's possible to export all flows using IPFIX, I thought it would be interesting to just showcase how the flow information can be presented with a solution called Theia.
From the official <a href="https://github.com/antrea-io/theia">docs</a>:</p>
<blockquote>
<p>Theia is a network observability and analytics platform for Kubernetes. It is built on top of <a href="https://github.com/antrea-io/antrea">Antrea</a>, and consumes <a href="https://github.com/antrea-io/antrea/blob/main/docs/network-flow-visibility.md">network flows exported by Antrea</a> to provide fine-grained visibility into the communication and NetworkPolicies among Pods and Services in a Kubernetes cluster.</p>
</blockquote>
<p>To install Theia I have followed the instructions from <a href="https://github.com/antrea-io/theia/blob/main/docs/getting-started.md">here</a> which is also a greate place to read more about Theia.</p>
<p>Theia is installed using Helm, start by adding the charts, do an update and deploy:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">linuxvm01:~/antrea$ helm repo add antrea https://charts.antrea.io
</span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="s2">&#34;antrea&#34;</span> already exists with the same configuration, skipping
</span></span><span class="line"><span class="ln">3</span><span class="cl">linuxvm01:~/antrea$ helm repo update
</span></span><span class="line"><span class="ln">4</span><span class="cl">Hang tight <span class="k">while</span> we grab the latest from your chart repositories...
</span></span><span class="line"><span class="ln">5</span><span class="cl">...Successfully got an update from the <span class="s2">&#34;antrea&#34;</span> chart repository
</span></span><span class="line"><span class="ln">6</span><span class="cl">Update Complete. ⎈Happy Helming!⎈
</span></span></code></pre></div><p>Make sure that FlowExporter has been enabled, if not apply an AntreaConfig that enables it:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">cni.tanzu.vmware.com/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">AntreaConfig</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">stc-tkg-cluster-1-antrea-package</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">ns-stc-1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">  </span><span class="nt">antrea</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">    </span><span class="nt">config</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">      </span><span class="nt">featureGates</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">        </span><span class="nt">AntreaProxy</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">        </span><span class="nt">EndpointSlice</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">        </span><span class="nt">AntreaPolicy</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">        </span><span class="nt">FlowExporter</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="c">#Enable this!</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">        </span><span class="nt">Egress</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">        </span><span class="nt">NodePortLocal</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">        </span><span class="nt">AntreaTraceflow</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">        </span><span class="nt">NetworkPolicyStats</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span></code></pre></div><p>After the config has been enabled, delete the Antrea agents and controller so these will read the new configMap:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="ln">1</span><span class="cl">linuxvm01:~/antrea/theia$ k delete pod -n kube-system -l app=antrea
</span></span><span class="line"><span class="ln">2</span><span class="cl">pod &#34;antrea-agent-58nn2&#34; deleted
</span></span><span class="line"><span class="ln">3</span><span class="cl">pod &#34;antrea-agent-cnq9p&#34; deleted
</span></span><span class="line"><span class="ln">4</span><span class="cl">pod &#34;antrea-agent-sx6vr&#34; deleted
</span></span><span class="line"><span class="ln">5</span><span class="cl">pod &#34;antrea-controller-6d56b6d664-km64t&#34; deleted
</span></span></code></pre></div><p>After the Helm charts have been added, I start by installing the Flow Aggregator</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">helm install flow-aggregator antrea/flow-aggregator --set clickHouse.enable<span class="o">=</span>true,recordContents.podLabels<span class="o">=</span><span class="nb">true</span> -n flow-aggregator --create-namespace
</span></span></code></pre></div><p>As usual with Helm charts, if there is any specific settings you would like to change get the helm chart values for your specific charts first and refer to them by using -f values.yaml..</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">linuxvm01:~/antrea/theia$ helm show values antrea/flow-aggregator &gt; flow-agg-values.yaml
</span></span></code></pre></div><p>I dont have any specifics I need to change for this one, so I will just deploy using the defaults:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">linuxvm01:~/antrea/theia$ helm install flow-aggregator antrea/flow-aggregator --set clickHouse.enable<span class="o">=</span>true,recordContents.podLabels<span class="o">=</span><span class="nb">true</span> -n flow-aggregator --create-namespace
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">NAME: flow-aggregator
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">LAST DEPLOYED: Tue Jun  <span class="m">6</span> 21:28:49 <span class="m">2023</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">NAMESPACE: flow-aggregator
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">STATUS: deployed
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">REVISION: <span class="m">1</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">TEST SUITE: None
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">NOTES:
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">The Antrea Flow Aggregator has been successfully installed
</span></span><span class="line"><span class="ln">10</span><span class="cl">
</span></span><span class="line"><span class="ln">11</span><span class="cl">You are using version 1.12.0
</span></span><span class="line"><span class="ln">12</span><span class="cl">
</span></span><span class="line"><span class="ln">13</span><span class="cl">For the Antrea documentation, please visit https://antrea.io
</span></span></code></pre></div><p>Now what has happened in my TKG cluster:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">linuxvm01:~/antrea/theia$ k get pods -n flow-aggregator
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">NAME                               READY   STATUS    RESTARTS      AGE
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">flow-aggregator-5b4c69885f-mklm5   1/1     Running   <span class="m">1</span> <span class="o">(</span>10s ago<span class="o">)</span>   22s
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">linuxvm01:~/antrea/theia$ k get pods -n flow-aggregator
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">NAME                               READY   STATUS    RESTARTS      AGE
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">flow-aggregator-5b4c69885f-mklm5   1/1     Running   <span class="m">1</span> <span class="o">(</span>13s ago<span class="o">)</span>   25s
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">linuxvm01:~/antrea/theia$ k get pods -n flow-aggregator
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">NAME                               READY   STATUS   RESTARTS      AGE
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">flow-aggregator-5b4c69885f-mklm5   0/1     Error    <span class="m">1</span> <span class="o">(</span>14s ago<span class="o">)</span>   26s
</span></span><span class="line"><span class="ln">10</span><span class="cl">linuxvm01:~/antrea/theia$ k get pods -n flow-aggregator
</span></span><span class="line"><span class="ln">11</span><span class="cl">NAME                               READY   STATUS   RESTARTS      AGE
</span></span><span class="line"><span class="ln">12</span><span class="cl">flow-aggregator-5b4c69885f-mklm5   0/1     CrashLoopBackOff    <span class="m">3</span> <span class="o">(</span>50s ago<span class="o">)</span>   60s
</span></span></code></pre></div><p>Well, that did'nt go so well...</p>
<p>The issue is that Flow Aggregator is looking for a service that is not created yet and will just fail until this is deployed. This is our next step.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">linuxvm01:~/antrea/theia$ helm install theia antrea/theia --set sparkOperator.enable<span class="o">=</span>true,theiaManager.enable<span class="o">=</span><span class="nb">true</span> -n flow-visibility --create-namespace
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">NAME: theia
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">LAST DEPLOYED: Tue Jun  <span class="m">6</span> 22:02:37 <span class="m">2023</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">NAMESPACE: flow-visibility
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">STATUS: deployed
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">REVISION: <span class="m">1</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">TEST SUITE: None
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">NOTES:
</span></span><span class="line"><span class="ln">10</span><span class="cl">Theia has been successfully installed
</span></span><span class="line"><span class="ln">11</span><span class="cl">
</span></span><span class="line"><span class="ln">12</span><span class="cl">You are using version 0.6.0
</span></span><span class="line"><span class="ln">13</span><span class="cl">
</span></span><span class="line"><span class="ln">14</span><span class="cl">For the Antrea documentation, please visit https://antrea.io
</span></span></code></pre></div><p>What has been created now:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="ln">1</span><span class="cl">linuxvm01:~/antrea/theia$ k get pods -n flow-visibility
</span></span><span class="line"><span class="ln">2</span><span class="cl">NAME                                    READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="ln">3</span><span class="cl">chi-clickhouse-clickhouse-0-0-0         2/2     Running   0          8m52s
</span></span><span class="line"><span class="ln">4</span><span class="cl">grafana-684d8948b-c6wzn                 1/1     Running   0          8m56s
</span></span><span class="line"><span class="ln">5</span><span class="cl">theia-manager-5d8d6b86b7-cbxrz          1/1     Running   0          8m56s
</span></span><span class="line"><span class="ln">6</span><span class="cl">theia-spark-operator-54d9ddd544-nqhqd   1/1     Running   0          8m56s
</span></span><span class="line"><span class="ln">7</span><span class="cl">zookeeper-0                             1/1     Running   0          8m56s
</span></span></code></pre></div><p>Now flow-aggreator should also be in a runing state, if not just delete the pod and it should get back on its feet.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="ln">1</span><span class="cl">linuxvm01:~/antrea/theia$ k get pods -n flow-aggregator
</span></span><span class="line"><span class="ln">2</span><span class="cl">NAME                               READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="ln">3</span><span class="cl">flow-aggregator-5b4c69885f-xhdkx   1/1     Running   0          5m2s
</span></span></code></pre></div><p>So, now its all about getting access to the Grafana dashboard. I will just expose this with serviceType loadBalancer as it &quot;out-of-the-box&quot; is only exposed with NodePort:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="ln">1</span><span class="cl">linuxvm01:~/antrea/theia$ k get svc -n flow-visibility
</span></span><span class="line"><span class="ln">2</span><span class="cl">NAME                            TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                      AGE
</span></span><span class="line"><span class="ln">3</span><span class="cl">chi-clickhouse-clickhouse-0-0   ClusterIP   None            &lt;none&gt;        8123/TCP,9000/TCP,9009/TCP   8m43s
</span></span><span class="line"><span class="ln">4</span><span class="cl">clickhouse-clickhouse           ClusterIP   20.10.136.211   &lt;none&gt;        8123/TCP,9000/TCP            10m
</span></span><span class="line"><span class="ln">5</span><span class="cl">grafana                         NodePort    20.10.172.165   &lt;none&gt;        3000:30096/TCP               10m
</span></span><span class="line"><span class="ln">6</span><span class="cl">theia-manager                   ClusterIP   20.10.156.217   &lt;none&gt;        11347/TCP                    10m
</span></span><span class="line"><span class="ln">7</span><span class="cl">zookeeper                       ClusterIP   20.10.219.137   &lt;none&gt;        2181/TCP,7000/TCP            10m
</span></span><span class="line"><span class="ln">8</span><span class="cl">zookeepers                      ClusterIP   None            &lt;none&gt;        2888/TCP,3888/TCP            10m
</span></span></code></pre></div><p>So let us create a LoadBalancer service for this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">theia-dashboard-ui</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">grafana</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">flow-visibility</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">  </span><span class="nt">loadBalancerClass</span><span class="p">:</span><span class="w"> </span><span class="l">ako.vmware.com/avi-lb</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">LoadBalancer</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">  </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">    </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">    </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">3000</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">grafana</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">linuxvm01:~/antrea/theia$ k get svc -n flow-visibility
</span></span><span class="line"><span class="ln">2</span><span class="cl">NAME                            TYPE           CLUSTER-IP      EXTERNAL-IP    PORT<span class="o">(</span>S<span class="o">)</span>                      grafana                         NodePort       20.10.172.165   &lt;none&gt;         3000:30096/TCP               15m
</span></span><span class="line"><span class="ln">3</span><span class="cl">theia-dashboard-ui              LoadBalancer   20.10.24.174    10.13.210.13   80:32075/TCP                 13s
</span></span></code></pre></div><p>Lets try to access it through the browser:</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="grafana"
      
        class="image_figure image_internal image_processed"
        width="2056"
        height="1582"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230607002029280.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Great. Theia comes with a couple of predefined dashobards that is interesting to start out with. So let me list some of the screenshots from the predefined dashboards below:</p>
<p>The homepage:</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="homepage"
      
        class="image_figure image_internal image_processed"
        width="2390"
        height="1998"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230607135955671.png"
      
      
    />

    </picture>
</figure>
</p>
<p>List of dashboards:</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="list"
      
        class="image_figure image_internal image_processed"
        width="1382"
        height="1798"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230607140048040.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Flow_Records_Dashboard:</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="flow-records"
      
        class="image_figure image_internal image_processed"
        width="3466"
        height="1352"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230607140130974.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Network_Topology_Dashboard:</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="network-toplogy"
      
        class="image_figure image_internal image_processed"
        width="2324"
        height="1258"
        src="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/images/image-20230607010946649.png"
      
      
    />

    </picture>
</figure>
</p>
<h3 id="network-policy-recommendation">Network Policy Recommendation</h3>
<p>From the official <a href="https://github.com/antrea-io/theia/blob/main/docs/networkpolicy-recommendation.md">docs</a>:</p>
<blockquote>
<p>Theia NetworkPolicy Recommendation recommends the NetworkPolicy configuration to secure Kubernetes network and applications. It analyzes the network flows collected by <a href="https://github.com/antrea-io/theia/blob/main/docs/network-flow-visibility.md#grafana-flow-collector">Grafana Flow Collector</a> to generate <a href="https://kubernetes.io/docs/concepts/services-networking/network-policies/">Kubernetes NetworkPolicies</a> or <a href="https://github.com/antrea-io/antrea/blob/main/docs/antrea-network-policy.md">Antrea NetworkPolicies</a>. This feature assists cluster administrators and app developers in securing their applications according to Zero Trust principles.</p>
</blockquote>
<p>I like the sound of that. Let us try it out.</p>
<p>The first I need to install inst the Theia CLI, this can be found and the instructions from <a href="https://github.com/antrea-io/theia/blob/main/docs/theia-cli.md">here</a></p>
<p><strong>Theia CLI</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">curl -Lo ./theia <span class="s2">&#34;https://github.com/antrea-io/theia/releases/download/v0.6.0/theia-</span><span class="k">$(</span>uname<span class="k">)</span><span class="s2">-x86_64&#34;</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">chmod +x ./theia
</span></span><span class="line"><span class="ln">3</span><span class="cl">mv ./theia /usr/local/bin/theia
</span></span><span class="line"><span class="ln">4</span><span class="cl">theia <span class="nb">help</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">linuxvm01:~/antrea/theia$ curl -Lo ./theia <span class="s2">&#34;https://github.com/antrea-io/theia/releases/download/v0.6.0/theia-</span><span class="k">$(</span>uname<span class="k">)</span><span class="s2">-x86_64&#34;</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">                                 Dload  Upload   Total   Spent    Left  Speed
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">  <span class="m">0</span>     <span class="m">0</span>    <span class="m">0</span>     <span class="m">0</span>    <span class="m">0</span>     <span class="m">0</span>      <span class="m">0</span>      <span class="m">0</span> --:--:-- --:--:-- --:--:--     <span class="m">0</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="m">100</span> 37.9M  <span class="m">100</span> 37.9M    <span class="m">0</span>     <span class="m">0</span>  11.6M      <span class="m">0</span>  0:00:03  0:00:03 --:--:-- 17.2M
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">linuxvm01:~/antrea/theia$ chmod +x ./theia
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">linuxvm01:~/antrea/theia$ sudo cp theia /usr/local/bin/theia
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">linuxvm01:~/antrea/theia$ theia <span class="nb">help</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">theia is the <span class="nb">command</span> line tool <span class="k">for</span> Theia which provides access
</span></span><span class="line"><span class="ln">10</span><span class="cl">to Theia network flow visibility capabilities
</span></span><span class="line"><span class="ln">11</span><span class="cl">
</span></span><span class="line"><span class="ln">12</span><span class="cl">Usage:
</span></span><span class="line"><span class="ln">13</span><span class="cl">  theia <span class="o">[</span>command<span class="o">]</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">
</span></span><span class="line"><span class="ln">15</span><span class="cl">Available Commands:
</span></span><span class="line"><span class="ln">16</span><span class="cl">  clickhouse                   Commands of Theia ClickHouse feature
</span></span><span class="line"><span class="ln">17</span><span class="cl">  completion                   Generate the autocompletion script <span class="k">for</span> the specified shell
</span></span><span class="line"><span class="ln">18</span><span class="cl">  <span class="nb">help</span>                         Help about any <span class="nb">command</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">  policy-recommendation        Commands of Theia policy recommendation feature
</span></span><span class="line"><span class="ln">20</span><span class="cl">  supportbundle                Generate support bundle
</span></span><span class="line"><span class="ln">21</span><span class="cl">  throughput-anomaly-detection Commands of Theia throughput anomaly detection feature
</span></span><span class="line"><span class="ln">22</span><span class="cl">  version                      Show Theia CLI version
</span></span><span class="line"><span class="ln">23</span><span class="cl">
</span></span><span class="line"><span class="ln">24</span><span class="cl">Flags:
</span></span><span class="line"><span class="ln">25</span><span class="cl">  -h, --help                <span class="nb">help</span> <span class="k">for</span> theia
</span></span><span class="line"><span class="ln">26</span><span class="cl">  -k, --kubeconfig string   absolute path to the k8s config file, will use <span class="nv">$KUBECONFIG</span> <span class="k">if</span> not specified
</span></span><span class="line"><span class="ln">27</span><span class="cl">  -v, --verbose int         <span class="nb">set</span> verbose level
</span></span><span class="line"><span class="ln">28</span><span class="cl">
</span></span><span class="line"><span class="ln">29</span><span class="cl">Use <span class="s2">&#34;theia [command] --help&#34;</span> <span class="k">for</span> more information about a command.
</span></span></code></pre></div><p>These are the following commands when running the policy-recommendation option:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">andreasm@linuxvm01:~/antrea/theia$ theia policy-recommendation --help
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">Command group of Theia policy recommendation feature.
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">Must specify a subcommand like run, status or retrieve.
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">Usage:
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">  theia policy-recommendation <span class="o">[</span>flags<span class="o">]</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">  theia policy-recommendation <span class="o">[</span>command<span class="o">]</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">Aliases:
</span></span><span class="line"><span class="ln">10</span><span class="cl">  policy-recommendation, pr
</span></span><span class="line"><span class="ln">11</span><span class="cl">
</span></span><span class="line"><span class="ln">12</span><span class="cl">Available Commands:
</span></span><span class="line"><span class="ln">13</span><span class="cl">  delete      Delete a policy recommendation job
</span></span><span class="line"><span class="ln">14</span><span class="cl">  list        List all policy recommendation <span class="nb">jobs</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">  retrieve    Get the recommendation result of a policy recommendation job
</span></span><span class="line"><span class="ln">16</span><span class="cl">  run         Run a new policy recommendation job
</span></span><span class="line"><span class="ln">17</span><span class="cl">  status      Check the status of a policy recommendation job
</span></span><span class="line"><span class="ln">18</span><span class="cl">
</span></span><span class="line"><span class="ln">19</span><span class="cl">
</span></span><span class="line"><span class="ln">20</span><span class="cl">Use <span class="s2">&#34;theia policy-recommendation [command] --help&#34;</span> <span class="k">for</span> more information about a command.
</span></span></code></pre></div><p>These are the options for the <em>run</em> command:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="ln"> 1</span><span class="cl">linuxvm01:~/antrea/theia$ theia policy-recommendation run --help
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">Run a new policy recommendation job.
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">Must finish the deployment of Theia first
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">Usage:
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">  theia policy-recommendation run [flags]
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">Examples:
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">Run a policy recommendation job with default configuration
</span></span><span class="line"><span class="ln">10</span><span class="cl">$ theia policy-recommendation run
</span></span><span class="line"><span class="ln">11</span><span class="cl">Run an initial policy recommendation job with policy type anp-deny-applied and limit on last 10k flow records
</span></span><span class="line"><span class="ln">12</span><span class="cl">$ theia policy-recommendation run --type initial --policy-type anp-deny-applied --limit 10000
</span></span><span class="line"><span class="ln">13</span><span class="cl">Run an initial policy recommendation job with policy type anp-deny-applied and limit on flow records from 2022-01-01 00:00:00 to 2022-01-31 23:59:59.
</span></span><span class="line"><span class="ln">14</span><span class="cl">$ theia policy-recommendation run --type initial --policy-type anp-deny-applied --start-time &#39;2022-01-01 00:00:00&#39; --end-time &#39;2022-01-31 23:59:59&#39;
</span></span><span class="line"><span class="ln">15</span><span class="cl">Run a policy recommendation job with default configuration but doesn&#39;t recommend toServices ANPs
</span></span><span class="line"><span class="ln">16</span><span class="cl">$ theia policy-recommendation run --to-services=false
</span></span><span class="line"><span class="ln">17</span><span class="cl">
</span></span><span class="line"><span class="ln">18</span><span class="cl">
</span></span><span class="line"><span class="ln">19</span><span class="cl">Flags:
</span></span><span class="line"><span class="ln">20</span><span class="cl">      --driver-core-request string     Specify the CPU request for the driver Pod. Values conform to the Kubernetes resource quantity convention.
</span></span><span class="line"><span class="ln">21</span><span class="cl">                                       Example values include 0.1, 500m, 1.5, 5, etc. (default &#34;200m&#34;)
</span></span><span class="line"><span class="ln">22</span><span class="cl">      --driver-memory string           Specify the memory request for the driver Pod. Values conform to the Kubernetes resource quantity convention.
</span></span><span class="line"><span class="ln">23</span><span class="cl">                                       Example values include 512M, 1G, 8G, etc. (default &#34;512M&#34;)
</span></span><span class="line"><span class="ln">24</span><span class="cl">  -e, --end-time string                The end time of the flow records considered for the policy recommendation.
</span></span><span class="line"><span class="ln">25</span><span class="cl">                                       Format is YYYY-MM-DD hh:mm:ss in UTC timezone. No limit of the end time of flow records by default.
</span></span><span class="line"><span class="ln">26</span><span class="cl">      --exclude-labels                 Enable this option will exclude automatically generated Pod labels including &#39;pod-template-hash&#39;,
</span></span><span class="line"><span class="ln">27</span><span class="cl">                                       &#39;controller-revision-hash&#39;, &#39;pod-template-generation&#39; during policy recommendation. (default true)
</span></span><span class="line"><span class="ln">28</span><span class="cl">      --executor-core-request string   Specify the CPU request for the executor Pod. Values conform to the Kubernetes resource quantity convention.
</span></span><span class="line"><span class="ln">29</span><span class="cl">                                       Example values include 0.1, 500m, 1.5, 5, etc. (default &#34;200m&#34;)
</span></span><span class="line"><span class="ln">30</span><span class="cl">      --executor-instances int32       Specify the number of executors for the Spark application. Example values include 1, 2, 8, etc. (default 1)
</span></span><span class="line"><span class="ln">31</span><span class="cl">      --executor-memory string         Specify the memory request for the executor Pod. Values conform to the Kubernetes resource quantity convention.
</span></span><span class="line"><span class="ln">32</span><span class="cl">                                       Example values include 512M, 1G, 8G, etc. (default &#34;512M&#34;)
</span></span><span class="line"><span class="ln">33</span><span class="cl">  -f, --file string                    The file path where you want to save the result. It can only be used when wait is enabled.
</span></span><span class="line"><span class="ln">34</span><span class="cl">  -h, --help                           help for run
</span></span><span class="line"><span class="ln">35</span><span class="cl">  -l, --limit int                      The limit on the number of flow records read from the database. 0 means no limit.
</span></span><span class="line"><span class="ln">36</span><span class="cl">  -n, --ns-allow-list string           List of default allow Namespaces.
</span></span><span class="line"><span class="ln">37</span><span class="cl">                                       If no Namespaces provided, Traffic inside Antrea CNI related Namespaces: [&#39;kube-system&#39;, &#39;flow-aggregator&#39;,
</span></span><span class="line"><span class="ln">38</span><span class="cl">                                       &#39;flow-visibility&#39;] will be allowed by default.
</span></span><span class="line"><span class="ln">39</span><span class="cl">  -p, --policy-type string             Types of generated NetworkPolicy.
</span></span><span class="line"><span class="ln">40</span><span class="cl">                                       Currently we have 3 generated NetworkPolicy types:
</span></span><span class="line"><span class="ln">41</span><span class="cl">                                       anp-deny-applied: Recommending allow ANP/ACNP policies, with default deny rules only on Pods which have an allow rule applied.
</span></span><span class="line"><span class="ln">42</span><span class="cl">                                       anp-deny-all: Recommending allow ANP/ACNP policies, with default deny rules for whole cluster.
</span></span><span class="line"><span class="ln">43</span><span class="cl">                                       k8s-np: Recommending allow K8s NetworkPolicies. (default &#34;anp-deny-applied&#34;)
</span></span><span class="line"><span class="ln">44</span><span class="cl">  -s, --start-time string              The start time of the flow records considered for the policy recommendation.
</span></span><span class="line"><span class="ln">45</span><span class="cl">                                       Format is YYYY-MM-DD hh:mm:ss in UTC timezone. No limit of the start time of flow records by default.
</span></span><span class="line"><span class="ln">46</span><span class="cl">      --to-services                    Use the toServices feature in ANP and recommendation toServices rules for Pod-to-Service flows,
</span></span><span class="line"><span class="ln">47</span><span class="cl">                                       only works when option is anp-deny-applied or anp-deny-all. (default true)
</span></span><span class="line"><span class="ln">48</span><span class="cl">  -t, --type string                    {initial|subsequent} Indicates this recommendation is an initial recommendion or a subsequent recommendation job. (default &#34;initial&#34;)
</span></span><span class="line"><span class="ln">49</span><span class="cl">      --wait                           Enable this option will hold and wait the whole policy recommendation job finishes.
</span></span><span class="line"><span class="ln">50</span><span class="cl">
</span></span><span class="line"><span class="ln">51</span><span class="cl">Global Flags:
</span></span><span class="line"><span class="ln">52</span><span class="cl">  -k, --kubeconfig string   absolute path to the k8s config file, will use $KUBECONFIG if not specified
</span></span><span class="line"><span class="ln">53</span><span class="cl">      --use-cluster-ip      Enable this option will use ClusterIP instead of port forwarding when connecting to the Theia
</span></span><span class="line"><span class="ln">54</span><span class="cl">                            Manager Service. It can only be used when running in cluster.
</span></span><span class="line"><span class="ln">55</span><span class="cl">  -v, --verbose int         set verbose level
</span></span></code></pre></div><p>I will just run the following <em>theia policy-recommendation run --type initial --policy-type anp-deny-applied --limit 10000</em> to generate some output.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">linuxvm01:~/antrea/theia$ theia policy-recommendation run --type initial --policy-type anp-deny-applied --limit <span class="m">10000</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">Successfully created policy recommendation job with name pr-e81a42e4-013a-4cf6-be43-b1ee48ea9a18
</span></span></code></pre></div><p>Lets check the status:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1"># First I will list all the runs to get the name</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">linuxvm01:~/antrea/theia$ theia policy-recommendation list
</span></span><span class="line"><span class="ln">3</span><span class="cl">CreationTime        CompletionTime Name                                    Status
</span></span><span class="line"><span class="ln">4</span><span class="cl">2023-06-08 07:50:28 N/A            pr-e81a42e4-013a-4cf6-be43-b1ee48ea9a18 SCHEDULED
</span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="c1"># Then I will check the status on the specific run</span>
</span></span><span class="line"><span class="ln">6</span><span class="cl">linuxvm01:~/antrea/theia$ theia policy-recommendation status pr-e81a42e4-013a-4cf6-be43-b1ee48ea9a18
</span></span><span class="line"><span class="ln">7</span><span class="cl">Status of this policy recommendation job is SCHEDULED
</span></span></code></pre></div><p>Seems like I have to wait some, time to grab a coffee.</p>
<p>Just poured my coffee, wanted to check again:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">linuxvm01:~/antrea/theia$ theia policy-recommendation status pr-e81a42e4-013a-4cf6-be43-b1ee48ea9a18
</span></span><span class="line"><span class="ln">2</span><span class="cl">Status of this policy recommendation job is RUNNING: 0/1 <span class="o">(</span>0%<span class="o">)</span> stages completed
</span></span></code></pre></div><p>Alright, it is running.</p>
<p>Now time to drink the coffee.</p>
<p>Lets check in on it again:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">linuxvm01:~/antrea/theia$ theia policy-recommendation status pr-e81a42e4-013a-4cf6-be43-b1ee48ea9a18
</span></span><span class="line"><span class="ln">2</span><span class="cl">Status of this policy recommendation job is COMPLETED
</span></span></code></pre></div><p>Oh yes, now I am excited which policies it recommends:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln">  1</span><span class="cl"><span class="l">linuxvm01:~/antrea/theia$ theia policy-recommendation retrieve pr-e81a42e4-013a-4cf6-be43-b1ee48ea9a18</span><span class="w">
</span></span></span><span class="line"><span class="ln">  2</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">crd.antrea.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="ln">  3</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterNetworkPolicy</span><span class="w">
</span></span></span><span class="line"><span class="ln">  4</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">  5</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">recommend-reject-acnp-9np4b</span><span class="w">
</span></span></span><span class="line"><span class="ln">  6</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">  7</span><span class="cl"><span class="w">  </span><span class="nt">appliedTo</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">  8</span><span class="cl"><span class="w">  </span>- <span class="nt">namespaceSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">  9</span><span class="cl"><span class="w">      </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 10</span><span class="cl"><span class="w">        </span><span class="nt">kubernetes.io/metadata.name</span><span class="p">:</span><span class="w"> </span><span class="l">yelb</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 11</span><span class="cl"><span class="w">    </span><span class="nt">podSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 12</span><span class="cl"><span class="w">      </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 13</span><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">traffic-generator</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 14</span><span class="cl"><span class="w">  </span><span class="nt">egress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 15</span><span class="cl"><span class="w">  </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Reject</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 16</span><span class="cl"><span class="w">    </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 17</span><span class="cl"><span class="w">    </span>- <span class="nt">podSelector</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="ln"> 18</span><span class="cl"><span class="w">  </span><span class="nt">ingress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 19</span><span class="cl"><span class="w">  </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Reject</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 20</span><span class="cl"><span class="w">    </span><span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 21</span><span class="cl"><span class="w">    </span>- <span class="nt">podSelector</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="ln"> 22</span><span class="cl"><span class="w">  </span><span class="nt">priority</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 23</span><span class="cl"><span class="w">  </span><span class="nt">tier</span><span class="p">:</span><span class="w"> </span><span class="l">Baseline</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 24</span><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 25</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">crd.antrea.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 26</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterNetworkPolicy</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 27</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 28</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">recommend-reject-acnp-ega4b</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 29</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 30</span><span class="cl"><span class="w">  </span><span class="nt">appliedTo</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 31</span><span class="cl"><span class="w">  </span>- <span class="nt">namespaceSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 32</span><span class="cl"><span class="w">      </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 33</span><span class="cl"><span class="w">        </span><span class="nt">kubernetes.io/metadata.name</span><span class="p">:</span><span class="w"> </span><span class="l">avi-system</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 34</span><span class="cl"><span class="w">    </span><span class="nt">podSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 35</span><span class="cl"><span class="w">      </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 36</span><span class="cl"><span class="w">        </span><span class="nt">app.kubernetes.io/instance</span><span class="p">:</span><span class="w"> </span><span class="l">ako-1685884771</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 37</span><span class="cl"><span class="w">        </span><span class="nt">app.kubernetes.io/name</span><span class="p">:</span><span class="w"> </span><span class="l">ako</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 38</span><span class="cl"><span class="w">        </span><span class="nt">statefulset.kubernetes.io/pod-name</span><span class="p">:</span><span class="w"> </span><span class="l">ako-0</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 39</span><span class="cl"><span class="w">  </span><span class="nt">egress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 40</span><span class="cl"><span class="w">  </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Reject</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 41</span><span class="cl"><span class="w">    </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 42</span><span class="cl"><span class="w">    </span>- <span class="nt">podSelector</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="ln"> 43</span><span class="cl"><span class="w">  </span><span class="nt">ingress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 44</span><span class="cl"><span class="w">  </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Reject</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 45</span><span class="cl"><span class="w">    </span><span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 46</span><span class="cl"><span class="w">    </span>- <span class="nt">podSelector</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="ln"> 47</span><span class="cl"><span class="w">  </span><span class="nt">priority</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 48</span><span class="cl"><span class="w">  </span><span class="nt">tier</span><span class="p">:</span><span class="w"> </span><span class="l">Baseline</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 49</span><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 50</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">crd.antrea.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 51</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">NetworkPolicy</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 52</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 53</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">recommend-allow-anp-nl6re</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 54</span><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">yelb</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 55</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 56</span><span class="cl"><span class="w">  </span><span class="nt">appliedTo</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 57</span><span class="cl"><span class="w">  </span>- <span class="nt">podSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 58</span><span class="cl"><span class="w">      </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 59</span><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">traffic-generator</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 60</span><span class="cl"><span class="w">  </span><span class="nt">egress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 61</span><span class="cl"><span class="w">  </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Allow</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 62</span><span class="cl"><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 63</span><span class="cl"><span class="w">    </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 64</span><span class="cl"><span class="w">      </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 65</span><span class="cl"><span class="w">    </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 66</span><span class="cl"><span class="w">    </span>- <span class="nt">ipBlock</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 67</span><span class="cl"><span class="w">        </span><span class="nt">cidr</span><span class="p">:</span><span class="w"> </span><span class="m">10.13.210.10</span><span class="l">/32</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 68</span><span class="cl"><span class="w">  </span><span class="nt">ingress</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 69</span><span class="cl"><span class="w">  </span><span class="nt">priority</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 70</span><span class="cl"><span class="w">  </span><span class="nt">tier</span><span class="p">:</span><span class="w"> </span><span class="l">Application</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 71</span><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 72</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">crd.antrea.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 73</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">NetworkPolicy</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 74</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 75</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">recommend-allow-anp-2ifjo</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 76</span><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">avi-system</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 77</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 78</span><span class="cl"><span class="w">  </span><span class="nt">appliedTo</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 79</span><span class="cl"><span class="w">  </span>- <span class="nt">podSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 80</span><span class="cl"><span class="w">      </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 81</span><span class="cl"><span class="w">        </span><span class="nt">app.kubernetes.io/instance</span><span class="p">:</span><span class="w"> </span><span class="l">ako-1685884771</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 82</span><span class="cl"><span class="w">        </span><span class="nt">app.kubernetes.io/name</span><span class="p">:</span><span class="w"> </span><span class="l">ako</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 83</span><span class="cl"><span class="w">        </span><span class="nt">statefulset.kubernetes.io/pod-name</span><span class="p">:</span><span class="w"> </span><span class="l">ako-0</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 84</span><span class="cl"><span class="w">  </span><span class="nt">egress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 85</span><span class="cl"><span class="w">  </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Allow</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 86</span><span class="cl"><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 87</span><span class="cl"><span class="w">    </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">443</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 88</span><span class="cl"><span class="w">      </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 89</span><span class="cl"><span class="w">    </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 90</span><span class="cl"><span class="w">    </span>- <span class="nt">ipBlock</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 91</span><span class="cl"><span class="w">        </span><span class="nt">cidr</span><span class="p">:</span><span class="w"> </span><span class="m">172.24.3.50</span><span class="l">/32</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 92</span><span class="cl"><span class="w">  </span><span class="nt">ingress</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 93</span><span class="cl"><span class="w">  </span><span class="nt">priority</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 94</span><span class="cl"><span class="w">  </span><span class="nt">tier</span><span class="p">:</span><span class="w"> </span><span class="l">Application</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 95</span><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 96</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">crd.antrea.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 97</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterNetworkPolicy</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 98</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 99</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">recommend-allow-acnp-kube-system-kaoh6</span><span class="w">
</span></span></span><span class="line"><span class="ln">100</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">101</span><span class="cl"><span class="w">  </span><span class="nt">appliedTo</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">102</span><span class="cl"><span class="w">  </span>- <span class="nt">namespaceSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">103</span><span class="cl"><span class="w">      </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">104</span><span class="cl"><span class="w">        </span><span class="nt">kubernetes.io/metadata.name</span><span class="p">:</span><span class="w"> </span><span class="l">kube-system</span><span class="w">
</span></span></span><span class="line"><span class="ln">105</span><span class="cl"><span class="w">  </span><span class="nt">egress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">106</span><span class="cl"><span class="w">  </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Allow</span><span class="w">
</span></span></span><span class="line"><span class="ln">107</span><span class="cl"><span class="w">    </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">108</span><span class="cl"><span class="w">    </span>- <span class="nt">podSelector</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="ln">109</span><span class="cl"><span class="w">  </span><span class="nt">ingress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">110</span><span class="cl"><span class="w">  </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Allow</span><span class="w">
</span></span></span><span class="line"><span class="ln">111</span><span class="cl"><span class="w">    </span><span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">112</span><span class="cl"><span class="w">    </span>- <span class="nt">podSelector</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="ln">113</span><span class="cl"><span class="w">  </span><span class="nt">priority</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span></span></span><span class="line"><span class="ln">114</span><span class="cl"><span class="w">  </span><span class="nt">tier</span><span class="p">:</span><span class="w"> </span><span class="l">Platform</span><span class="w">
</span></span></span><span class="line"><span class="ln">115</span><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="ln">116</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">crd.antrea.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="ln">117</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterNetworkPolicy</span><span class="w">
</span></span></span><span class="line"><span class="ln">118</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">119</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">recommend-allow-acnp-flow-aggregator-dnvhc</span><span class="w">
</span></span></span><span class="line"><span class="ln">120</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">121</span><span class="cl"><span class="w">  </span><span class="nt">appliedTo</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">122</span><span class="cl"><span class="w">  </span>- <span class="nt">namespaceSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">123</span><span class="cl"><span class="w">      </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">124</span><span class="cl"><span class="w">        </span><span class="nt">kubernetes.io/metadata.name</span><span class="p">:</span><span class="w"> </span><span class="l">flow-aggregator</span><span class="w">
</span></span></span><span class="line"><span class="ln">125</span><span class="cl"><span class="w">  </span><span class="nt">egress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">126</span><span class="cl"><span class="w">  </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Allow</span><span class="w">
</span></span></span><span class="line"><span class="ln">127</span><span class="cl"><span class="w">    </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">128</span><span class="cl"><span class="w">    </span>- <span class="nt">podSelector</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="ln">129</span><span class="cl"><span class="w">  </span><span class="nt">ingress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">130</span><span class="cl"><span class="w">  </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Allow</span><span class="w">
</span></span></span><span class="line"><span class="ln">131</span><span class="cl"><span class="w">    </span><span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">132</span><span class="cl"><span class="w">    </span>- <span class="nt">podSelector</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="ln">133</span><span class="cl"><span class="w">  </span><span class="nt">priority</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span></span></span><span class="line"><span class="ln">134</span><span class="cl"><span class="w">  </span><span class="nt">tier</span><span class="p">:</span><span class="w"> </span><span class="l">Platform</span><span class="w">
</span></span></span><span class="line"><span class="ln">135</span><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="ln">136</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">crd.antrea.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="ln">137</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterNetworkPolicy</span><span class="w">
</span></span></span><span class="line"><span class="ln">138</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">139</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">recommend-allow-acnp-flow-visibility-sqjwf</span><span class="w">
</span></span></span><span class="line"><span class="ln">140</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">141</span><span class="cl"><span class="w">  </span><span class="nt">appliedTo</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">142</span><span class="cl"><span class="w">  </span>- <span class="nt">namespaceSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">143</span><span class="cl"><span class="w">      </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">144</span><span class="cl"><span class="w">        </span><span class="nt">kubernetes.io/metadata.name</span><span class="p">:</span><span class="w"> </span><span class="l">flow-visibility</span><span class="w">
</span></span></span><span class="line"><span class="ln">145</span><span class="cl"><span class="w">  </span><span class="nt">egress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">146</span><span class="cl"><span class="w">  </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Allow</span><span class="w">
</span></span></span><span class="line"><span class="ln">147</span><span class="cl"><span class="w">    </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">148</span><span class="cl"><span class="w">    </span>- <span class="nt">podSelector</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="ln">149</span><span class="cl"><span class="w">  </span><span class="nt">ingress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">150</span><span class="cl"><span class="w">  </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Allow</span><span class="w">
</span></span></span><span class="line"><span class="ln">151</span><span class="cl"><span class="w">    </span><span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">152</span><span class="cl"><span class="w">    </span>- <span class="nt">podSelector</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="ln">153</span><span class="cl"><span class="w">  </span><span class="nt">priority</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span></span></span><span class="line"><span class="ln">154</span><span class="cl"><span class="w">  </span><span class="nt">tier</span><span class="p">:</span><span class="w"> </span><span class="l">Platform</span><span class="w">
</span></span></span><span class="line"><span class="ln">155</span><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="ln">156</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">crd.antrea.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="ln">157</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterNetworkPolicy</span><span class="w">
</span></span></span><span class="line"><span class="ln">158</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">159</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">recommend-reject-acnp-hmjt8</span><span class="w">
</span></span></span><span class="line"><span class="ln">160</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">161</span><span class="cl"><span class="w">  </span><span class="nt">appliedTo</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">162</span><span class="cl"><span class="w">  </span>- <span class="nt">namespaceSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">163</span><span class="cl"><span class="w">      </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">164</span><span class="cl"><span class="w">        </span><span class="nt">kubernetes.io/metadata.name</span><span class="p">:</span><span class="w"> </span><span class="l">yelb-2</span><span class="w">
</span></span></span><span class="line"><span class="ln">165</span><span class="cl"><span class="w">    </span><span class="nt">podSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">166</span><span class="cl"><span class="w">      </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">167</span><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">yelb-ui</span><span class="w">
</span></span></span><span class="line"><span class="ln">168</span><span class="cl"><span class="w">        </span><span class="nt">tier</span><span class="p">:</span><span class="w"> </span><span class="l">frontend</span><span class="w">
</span></span></span><span class="line"><span class="ln">169</span><span class="cl"><span class="w">  </span><span class="nt">egress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">170</span><span class="cl"><span class="w">  </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Reject</span><span class="w">
</span></span></span><span class="line"><span class="ln">171</span><span class="cl"><span class="w">    </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">172</span><span class="cl"><span class="w">    </span>- <span class="nt">podSelector</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="ln">173</span><span class="cl"><span class="w">  </span><span class="nt">ingress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">174</span><span class="cl"><span class="w">  </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Reject</span><span class="w">
</span></span></span><span class="line"><span class="ln">175</span><span class="cl"><span class="w">    </span><span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">176</span><span class="cl"><span class="w">    </span>- <span class="nt">podSelector</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="ln">177</span><span class="cl"><span class="w">  </span><span class="nt">priority</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span></span></span><span class="line"><span class="ln">178</span><span class="cl"><span class="w">  </span><span class="nt">tier</span><span class="p">:</span><span class="w"> </span><span class="l">Baseline</span><span class="w">
</span></span></span></code></pre></div><p>Ok, well. I appreciate the output, but I would need to do some modifications to it before I would apply it. As my lab is not generating that much traffic, it does not create all the flows needed to generate a better recommendation. For it to generate better recommendations, the flows also needs to be there. My traffic-generator is not doing a good job to achieve this.
I will need to generate some more activity for the recommendation engine to get enough flows to consider.</p>
<h3 id="throughput-anomaly-detection">Throughput Anomaly Detection</h3>
<p>From the offical <a href="https://github.com/antrea-io/theia/blob/main/docs/throughput-anomaly-detection.md">docs</a>:</p>
<blockquote>
<p>From Theia v0.5, Theia supports Throughput Anomaly Detection. Throughput Anomaly Detection (TAD) is a technique for understanding and reporting the throughput abnormalities in the network traffic. It analyzes the network flows collected by <a href="https://github.com/antrea-io/theia/blob/main/docs/network-flow-visibility.md#grafana-flow-collector">Grafana Flow Collector</a> to report anomalies in the network. TAD uses three algorithms to find the anomalies in network flows such as ARIMA, EWMA, and DBSCAN. These anomaly analyses help the user to find threats if present.</p>
</blockquote>
<p>Lets try it out. I already have the dependencies and Theia CLI installed.</p>
<p>What is the different commands available:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">linuxvm01:~/antrea/theia$ theia throughput-anomaly-detection --help
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">Command group of Theia throughput anomaly detection feature.
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">	Must specify a subcommand like run, list, delete, status or retrieve
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">Usage:
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">  theia throughput-anomaly-detection <span class="o">[</span>flags<span class="o">]</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">  theia throughput-anomaly-detection <span class="o">[</span>command<span class="o">]</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">Aliases:
</span></span><span class="line"><span class="ln">10</span><span class="cl">  throughput-anomaly-detection, tad
</span></span><span class="line"><span class="ln">11</span><span class="cl">
</span></span><span class="line"><span class="ln">12</span><span class="cl">Available Commands:
</span></span><span class="line"><span class="ln">13</span><span class="cl">  delete      Delete a anomaly detection job
</span></span><span class="line"><span class="ln">14</span><span class="cl">  list        List all anomaly detection <span class="nb">jobs</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">  retrieve    Get the result of an anomaly detection job
</span></span><span class="line"><span class="ln">16</span><span class="cl">  run         throughput anomaly detection using Algo
</span></span><span class="line"><span class="ln">17</span><span class="cl">  status      Check the status of a anomaly detection job
</span></span><span class="line"><span class="ln">18</span><span class="cl">
</span></span><span class="line"><span class="ln">19</span><span class="cl">Flags:
</span></span><span class="line"><span class="ln">20</span><span class="cl">  -h, --help             <span class="nb">help</span> <span class="k">for</span> throughput-anomaly-detection
</span></span><span class="line"><span class="ln">21</span><span class="cl">      --use-cluster-ip   Enable this option will use ClusterIP instead of port forwarding when connecting to the Theia
</span></span><span class="line"><span class="ln">22</span><span class="cl">                         Manager Service. It can only be used when running in cluster.
</span></span><span class="line"><span class="ln">23</span><span class="cl">
</span></span><span class="line"><span class="ln">24</span><span class="cl">Global Flags:
</span></span><span class="line"><span class="ln">25</span><span class="cl">  -k, --kubeconfig string   absolute path to the k8s config file, will use <span class="nv">$KUBECONFIG</span> <span class="k">if</span> not specified
</span></span><span class="line"><span class="ln">26</span><span class="cl">  -v, --verbose int         <span class="nb">set</span> verbose level
</span></span><span class="line"><span class="ln">27</span><span class="cl">
</span></span><span class="line"><span class="ln">28</span><span class="cl">Use <span class="s2">&#34;theia throughput-anomaly-detection [command] --help&#34;</span> <span class="k">for</span> more information about a command.
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">linuxvm01:~/antrea/theia$ theia throughput-anomaly-detection run --help
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">throughput anomaly detection using algorithms, currently supported algorithms are EWMA, ARIMA and DBSCAN
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">Usage:
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">  theia throughput-anomaly-detection run <span class="o">[</span>flags<span class="o">]</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">Examples:
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">Run the specific algorithm <span class="k">for</span> throughput anomaly detection
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">	$ theia throughput-anomaly-detection run --algo ARIMA --start-time 2022-01-01T00:00:00 --end-time 2022-01-31T23:59:59
</span></span><span class="line"><span class="ln">10</span><span class="cl">	Run throughput anomaly detection algorithm of <span class="nb">type</span> ARIMA and limit on flow records from <span class="s1">&#39;2022-01-01 00:00:00&#39;</span> to <span class="s1">&#39;2022-01-31 23:59:59&#39;</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">	Please note, algo is a mandatory argument<span class="err">&#39;</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">
</span></span><span class="line"><span class="ln">13</span><span class="cl">Flags:
</span></span><span class="line"><span class="ln">14</span><span class="cl">  -a, --algo string                    The algorithm used by throughput anomaly detection.
</span></span><span class="line"><span class="ln">15</span><span class="cl">                                       		Currently supported Algorithms are EWMA, ARIMA and DBSCAN.
</span></span><span class="line"><span class="ln">16</span><span class="cl">      --driver-core-request string     Specify the CPU request <span class="k">for</span> the driver Pod. Values conform to the Kubernetes resource quantity convention.
</span></span><span class="line"><span class="ln">17</span><span class="cl">                                       Example values include 0.1, 500m, 1.5, 5, etc. <span class="o">(</span>default <span class="s2">&#34;200m&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">      --driver-memory string           Specify the memory request <span class="k">for</span> the driver Pod. Values conform to the Kubernetes resource quantity convention.
</span></span><span class="line"><span class="ln">19</span><span class="cl">                                       Example values include 512M, 1G, 8G, etc. <span class="o">(</span>default <span class="s2">&#34;512M&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">  -e, --end-time string                The end <span class="nb">time</span> of the flow records considered <span class="k">for</span> the anomaly detection.
</span></span><span class="line"><span class="ln">21</span><span class="cl">                                       Format is YYYY-MM-DD hh:mm:ss in UTC timezone. No limit of the end <span class="nb">time</span> of flow records by default.
</span></span><span class="line"><span class="ln">22</span><span class="cl">      --executor-core-request string   Specify the CPU request <span class="k">for</span> the executor Pod. Values conform to the Kubernetes resource quantity convention.
</span></span><span class="line"><span class="ln">23</span><span class="cl">                                       Example values include 0.1, 500m, 1.5, 5, etc. <span class="o">(</span>default <span class="s2">&#34;200m&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl">      --executor-instances int32       Specify the number of executors <span class="k">for</span> the Spark application. Example values include 1, 2, 8, etc. <span class="o">(</span>default 1<span class="o">)</span>
</span></span><span class="line"><span class="ln">25</span><span class="cl">      --executor-memory string         Specify the memory request <span class="k">for</span> the executor Pod. Values conform to the Kubernetes resource quantity convention.
</span></span><span class="line"><span class="ln">26</span><span class="cl">                                       Example values include 512M, 1G, 8G, etc. <span class="o">(</span>default <span class="s2">&#34;512M&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="ln">27</span><span class="cl">  -h, --help                           <span class="nb">help</span> <span class="k">for</span> run
</span></span><span class="line"><span class="ln">28</span><span class="cl">  -n, --ns-ignore-list string          List of default drop Namespaces. Use this to ignore traffic from selected namespaces
</span></span><span class="line"><span class="ln">29</span><span class="cl">                                       If no Namespaces provided, Traffic from all namespaces present in flows table will be allowed by default.
</span></span><span class="line"><span class="ln">30</span><span class="cl">  -s, --start-time string              The start <span class="nb">time</span> of the flow records considered <span class="k">for</span> the anomaly detection.
</span></span><span class="line"><span class="ln">31</span><span class="cl">                                       Format is YYYY-MM-DD hh:mm:ss in UTC timezone. No limit of the start <span class="nb">time</span> of flow records by default.
</span></span><span class="line"><span class="ln">32</span><span class="cl">
</span></span><span class="line"><span class="ln">33</span><span class="cl">Global Flags:
</span></span><span class="line"><span class="ln">34</span><span class="cl">  -k, --kubeconfig string   absolute path to the k8s config file, will use <span class="nv">$KUBECONFIG</span> <span class="k">if</span> not specified
</span></span><span class="line"><span class="ln">35</span><span class="cl">      --use-cluster-ip      Enable this option will use ClusterIP instead of port forwarding when connecting to the Theia
</span></span><span class="line"><span class="ln">36</span><span class="cl">                            Manager Service. It can only be used when running in cluster.
</span></span><span class="line"><span class="ln">37</span><span class="cl">  -v, --verbose int         <span class="nb">set</span> verbose level
</span></span></code></pre></div><p>I will use the example above:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">linuxvm01:~/antrea/theia$ theia throughput-anomaly-detection run --algo ARIMA --start-time 2023-06-06T00:00:00 --end-time 2023-06-08T09:00:00
</span></span><span class="line"><span class="ln">2</span><span class="cl">Successfully started Throughput Anomaly Detection job with name: tad-2ecb054a-8c0d-4ae1-8444-c3493e7bb6d9
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">linuxvm01:~/antrea/theia$ theia throughput-anomaly-detection list
</span></span><span class="line"><span class="ln">2</span><span class="cl">CreationTime        CompletionTime Name                                     Status
</span></span><span class="line"><span class="ln">3</span><span class="cl">2023-06-08 08:25:10 N/A            tad-2ecb054a-8c0d-4ae1-8444-c3493e7bb6d9 RUNNING
</span></span><span class="line"><span class="ln">4</span><span class="cl">linuxvm01:~/antrea/theia$ theia throughput-anomaly-detection status tad-2ecb054a-8c0d-4ae1-8444-c3493e7bb6d9
</span></span><span class="line"><span class="ln">5</span><span class="cl">Status of this anomaly detection job is RUNNING: 0/0 <span class="o">(</span>0%<span class="o">)</span> stages completed
</span></span></code></pre></div><p>Lets wait for it to finish...</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">linuxvm01:~$ theia throughput-anomaly-detection list
</span></span><span class="line"><span class="ln">2</span><span class="cl">CreationTime        CompletionTime      Name                                     Status
</span></span><span class="line"><span class="ln">3</span><span class="cl">2023-06-08 08:25:10 2023-06-08 08:40:03 tad-2ecb054a-8c0d-4ae1-8444-c3493e7bb6d9 COMPLETED
</span></span></code></pre></div><p>Now check the output:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1"># It is a long list so I am piping it to a text file</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">linuxvm01:~$ theia throughput-anomaly-detection retrieve tad-2ecb054a-8c0d-4ae1-8444-c3493e7bb6d9 &gt; anomaly-detection-1.txt
</span></span></code></pre></div><p>A snippet from the output:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">id                                      sourceIP        sourceTransportPort     destinationIP   destinationTransportPort        flowStartSeconds        flowEndSeconds          throughput      algoCalc                anomaly
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">2ecb054a-8c0d-4ae1-8444-c3493e7bb6d9    20.20.3.12      <span class="m">59448</span>                   20.20.0.12      <span class="m">2181</span>                            2023-06-06T22:04:43Z    2023-06-07T21:41:38Z    <span class="m">54204</span>           65355.16485680155       <span class="nb">true</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">2ecb054a-8c0d-4ae1-8444-c3493e7bb6d9    20.20.3.12      <span class="m">59448</span>                   20.20.0.12      <span class="m">2181</span>                            2023-06-06T22:04:43Z    2023-06-08T07:09:32Z    <span class="m">49901</span>           54713.50251767502       <span class="nb">true</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">2ecb054a-8c0d-4ae1-8444-c3493e7bb6d9    20.20.3.12      <span class="m">59448</span>                   20.20.0.12      <span class="m">2181</span>                            2023-06-06T22:04:43Z    2023-06-08T03:33:48Z    <span class="m">50000</span>           53550.532983008845      <span class="nb">true</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">2ecb054a-8c0d-4ae1-8444-c3493e7bb6d9    20.20.3.12      <span class="m">59448</span>                   20.20.0.12      <span class="m">2181</span>                            2023-06-06T22:04:43Z    2023-06-08T00:52:48Z    <span class="m">59725</span>           52206.69079880149       <span class="nb">true</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">2ecb054a-8c0d-4ae1-8444-c3493e7bb6d9    20.20.3.12      <span class="m">59448</span>                   20.20.0.12      <span class="m">2181</span>                            2023-06-06T22:04:43Z    2023-06-07T18:49:03Z    <span class="m">48544</span>           53287.107990749006      <span class="nb">true</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">2ecb054a-8c0d-4ae1-8444-c3493e7bb6d9    20.20.3.12      <span class="m">59448</span>                   20.20.0.12      <span class="m">2181</span>                            2023-06-06T22:04:43Z    2023-06-07T22:06:43Z    <span class="m">61832</span>           53100.99541753638       <span class="nb">true</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">2ecb054a-8c0d-4ae1-8444-c3493e7bb6d9    20.20.3.12      <span class="m">59448</span>                   20.20.0.12      <span class="m">2181</span>                            2023-06-06T22:04:43Z    2023-06-07T20:57:28Z    <span class="m">58295</span>           54168.70924924757       <span class="nb">true</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">2ecb054a-8c0d-4ae1-8444-c3493e7bb6d9    20.20.3.12      <span class="m">59448</span>                   20.20.0.12      <span class="m">2181</span>                            2023-06-06T22:04:43Z    2023-06-08T07:36:38Z    <span class="m">47309</span>           53688.236655529385      <span class="nb">true</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">2ecb054a-8c0d-4ae1-8444-c3493e7bb6d9    20.20.3.12      <span class="m">59448</span>                   20.20.0.12      <span class="m">2181</span>                            2023-06-06T22:04:43Z    2023-06-08T08:05:43Z    <span class="m">59227</span>           52623.71668244673       <span class="nb">true</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">2ecb054a-8c0d-4ae1-8444-c3493e7bb6d9    20.20.3.12      <span class="m">59448</span>                   20.20.0.12      <span class="m">2181</span>                            2023-06-06T22:04:43Z    2023-06-08T05:22:12Z    <span class="m">58217</span>           53709.42205164235       <span class="nb">true</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">2ecb054a-8c0d-4ae1-8444-c3493e7bb6d9    20.20.3.12      <span class="m">59448</span>                   20.20.0.12      <span class="m">2181</span>                            2023-06-06T22:04:43Z    2023-06-08T02:19:03Z    <span class="m">48508</span>           55649.8819138477        <span class="nb">true</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">2ecb054a-8c0d-4ae1-8444-c3493e7bb6d9    20.20.3.12      <span class="m">59448</span>                   20.20.0.12      <span class="m">2181</span>                            2023-06-06T22:04:43Z    2023-06-07T23:27:28Z    <span class="m">53846</span>           48125.33491950862       <span class="nb">true</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">2ecb054a-8c0d-4ae1-8444-c3493e7bb6d9    20.20.3.12      <span class="m">59448</span>                   20.20.0.12      <span class="m">2181</span>                            2023-06-06T22:04:43Z    2023-06-08T00:09:38Z    <span class="m">59562</span>           52143.367660610136      <span class="nb">true</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">2ecb054a-8c0d-4ae1-8444-c3493e7bb6d9    20.20.3.12      <span class="m">59448</span>                   20.20.0.12      <span class="m">2181</span>                            2023-06-06T22:04:43Z    2023-06-08T02:44:08Z    <span class="m">50966</span>           57119.323329628125      <span class="nb">true</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">2ecb054a-8c0d-4ae1-8444-c3493e7bb6d9    20.20.3.12      <span class="m">59448</span>                   20.20.0.12      <span class="m">2181</span>                            2023-06-06T22:04:43Z    2023-06-08T08:24:17Z    <span class="m">55553</span>           50480.7443391562        <span class="nb">true</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">2ecb054a-8c0d-4ae1-8444-c3493e7bb6d9    20.20.3.12      <span class="m">59448</span>                   20.20.0.12      <span class="m">2181</span>                            2023-06-06T22:04:43Z    2023-06-08T00:02:38Z    <span class="m">44172</span>           53694.11880964807       <span class="nb">true</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">2ecb054a-8c0d-4ae1-8444-c3493e7bb6d9    20.20.3.12      <span class="m">59448</span>                   20.20.0.12      <span class="m">2181</span>                            2023-06-06T22:04:43Z    2023-06-08T04:07:57Z    <span class="m">53612</span>           49714.00885995446       <span class="nb">true</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">2ecb054a-8c0d-4ae1-8444-c3493e7bb6d9    20.20.3.12      <span class="m">59448</span>                   20.20.0.12      <span class="m">2181</span>                            2023-06-06T22:04:43Z    2023-06-08T01:54:58Z    <span class="m">59089</span>           51972.42465384903       <span class="nb">true</span>
</span></span></code></pre></div><h2 id="antrea-egress">Antrea Egress</h2>
<p>This chapter is also covered in another post I have done <a href="https://blog.andreasm.io/2023/02/20/antrea-egress/">here</a> with some tweaks 😃</p>
<p>From the offical <a href="https://antrea.io/docs/v1.12.0/docs/egress/">docs</a></p>
<blockquote>
<p><code>Egress</code> is a CRD API that manages external access from the Pods in a cluster. It supports specifying which egress (SNAT) IP the traffic from the selected Pods to the external network should use. When a selected Pod accesses the external network, the egress traffic will be tunneled to the Node that hosts the egress IP if it’s different from the Node that the Pod runs on and will be SNATed to the egress IP when leaving that Node.</p>
<p>You may be interested in using this capability if any of the following apply:</p>
<ul>
<li>A consistent IP address is desired when specific Pods connect to services outside of the cluster, for source tracing in audit logs, or for filtering by source IP in external firewall, etc.</li>
<li>You want to force outgoing external connections to leave the cluster via certain Nodes, for security controls, or due to network topology restrictions.</li>
</ul>
</blockquote>

    </div>




  </article>
<aside class="sidebar">
  <section class="sidebar_inner">
    <br>
    
  
  <div class="search">
    <input type="search" class="search_field form_field" placeholder='Search...' id="find" autocomplete="off" data-scope='post'>
    <label for="find" class="search_label"><svg class="icon">
  <title>search</title>
  <use xlink:href="#search"></use>
</svg>

    </label>
    
    <div class="search_results results"></div>
  </div>

        <h2>Hi there</h2>
      <div class="author_bio">
        This blog is a WIP, sometimes I just throw up some topics for myself to remember to be finished later. Stay tuned...
      </div>
      <a href='https://blog.andreasm.io/about/' class="button mt-1" role="button" title='Read More'>Read More</a>

    
    
    <h2 class="mt-4">Recent Posts</h2>
    <ul class="flex-column">
      <li>
        <a href="https://blog.andreasm.io/2023/08/29/tkg-2.3-deployment-in-multiple-availability-zones/" class="nav-link" title="TKG 2.3 deployment in multiple availability zones">TKG 2.3 deployment in multiple availability zones</a>
      </li>
      <li>
        <a href="https://blog.andreasm.io/2023/07/12/installing-tmc-local-on-vsphere-8-with-tanzu-using-keycloak-as-oidc-provider/" class="nav-link" title="Installing TMC local on vSphere 8 with Tanzu using Keycloak as OIDC provider">Installing TMC local on vSphere 8 with Tanzu using Keycloak as OIDC provider</a>
      </li>
      <li>
        <a href="https://blog.andreasm.io/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/" class="nav-link" title="Securing Kubernetes clusters with Antrea Network Policies">Securing Kubernetes clusters with Antrea Network Policies</a>
      </li>
      <li>
        <a href="https://blog.andreasm.io/2023/06/01/managing-antrea-in-vsphere-with-tanzu/" class="nav-link" title="Managing Antrea in vSphere with Tanzu">Managing Antrea in vSphere with Tanzu</a>
      </li>
      <li>
        <a href="https://blog.andreasm.io/2023/05/30/tanzu-kubernetes-grid-2.2-remote-workload-clusters/" class="nav-link" title="Tanzu Kubernetes Grid 2.2 &amp; Remote Workload Clusters">Tanzu Kubernetes Grid 2.2 &amp; Remote Workload Clusters</a>
      </li>
      <li>
        <a href="https://blog.andreasm.io/2023/05/03/vsphere-with-tanzu-and-multi-zones-part2/" class="nav-link" title="vSphere with Tanzu and Multi Zones part2">vSphere with Tanzu and Multi Zones part2</a>
      </li>
      <li>
        <a href="https://blog.andreasm.io/2023/05/03/vsphere-with-tanzu-multi-three-zones-and-nsx/" class="nav-link" title="vSphere with Tanzu, Multi (three) Zones and NSX">vSphere with Tanzu, Multi (three) Zones and NSX</a>
      </li>
      <li>
        <a href="https://blog.andreasm.io/2023/04/14/tanzu-with-vsphere-and-different-tier-0s/" class="nav-link" title="Tanzu with vSphere and different Tier-0s">Tanzu with vSphere and different Tier-0s</a>
      </li>
    </ul>
    <div>
      <h2 class="mt-4 taxonomy" id="categories-section">Categories</h2>
      <nav class="tags_nav">
        <a href='https://blog.andreasm.io/categories/kubernetes/' class="post_tag button button_translucent" title="kubernetes">
          KUBERNETES
          <span class="button_tally">29</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/networking/' class="post_tag button button_translucent" title="networking">
          NETWORKING
          <span class="button_tally">18</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/tanzu/' class="post_tag button button_translucent" title="tanzu">
          TANZU
          <span class="button_tally">9</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/loadbalancing/' class="post_tag button button_translucent" title="loadbalancing">
          LOADBALANCING
          <span class="button_tally">7</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/cni/' class="post_tag button button_translucent" title="cni">
          CNI
          <span class="button_tally">6</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/security/' class="post_tag button button_translucent" title="security">
          SECURITY
          <span class="button_tally">5</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/avi/' class="post_tag button button_translucent" title="avi">
          AVI
          <span class="button_tally">4</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/nsx/' class="post_tag button button_translucent" title="nsx">
          NSX
          <span class="button_tally">3</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/blog/' class="post_tag button button_translucent" title="blog">
          BLOG
          <span class="button_tally">2</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/vmware-nsx/' class="post_tag button button_translucent" title="vmware-nsx">
          VMWARE-NSX
          <span class="button_tally">2</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/antrea/' class="post_tag button button_translucent" title="antrea">
          ANTREA
          <span class="button_tally">1</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/certificate/' class="post_tag button button_translucent" title="certificate">
          CERTIFICATE
          <span class="button_tally">1</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/docker/' class="post_tag button button_translucent" title="docker">
          DOCKER
          <span class="button_tally">1</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/github/' class="post_tag button button_translucent" title="github">
          GITHUB
          <span class="button_tally">1</span>
        </a>
        
        
        <br>
        <div class="post_tags_toggle button">All Categories</div>
        <div class="post_tags">
          <div class="tags_list">
            
            <a href='https://blog.andreasm.io/categories/antrea/' class=" post_tag button button_translucent" data-position=1 title="antrea">ANTREA<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/avi/' class=" post_tag button button_translucent" data-position=4 title="avi">AVI<span class="button_tally">4</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/blog/' class=" post_tag button button_translucent" data-position=2 title="blog">BLOG<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/certificate/' class=" post_tag button button_translucent" data-position=1 title="certificate">CERTIFICATE<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/cni/' class=" post_tag button button_translucent" data-position=6 title="cni">CNI<span class="button_tally">6</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/docker/' class=" post_tag button button_translucent" data-position=1 title="docker">DOCKER<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/github/' class=" post_tag button button_translucent" data-position=1 title="github">GITHUB<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/harbor/' class=" post_tag button button_translucent" data-position=1 title="harbor">HARBOR<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/helm/' class=" post_tag button button_translucent" data-position=1 title="helm">HELM<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/home-automation/' class=" post_tag button button_translucent" data-position=1 title="home-automation">HOME-AUTOMATION<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/hugo/' class=" post_tag button button_translucent" data-position=1 title="hugo">HUGO<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/kubernetes/' class=" post_tag button button_translucent" data-position=29 title="kubernetes">KUBERNETES<span class="button_tally">29</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/lcm/' class=" post_tag button button_translucent" data-position=1 title="lcm">LCM<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/loadbalancing/' class=" post_tag button button_translucent" data-position=7 title="loadbalancing">LOADBALANCING<span class="button_tally">7</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/logging/' class=" post_tag button button_translucent" data-position=1 title="logging">LOGGING<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/monitoring/' class=" post_tag button button_translucent" data-position=1 title="monitoring">MONITORING<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/netowkring/' class=" post_tag button button_translucent" data-position=1 title="netowkring">NETOWKRING<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/networking/' class=" post_tag button button_translucent" data-position=18 title="networking">NETWORKING<span class="button_tally">18</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/nsx/' class=" post_tag button button_translucent" data-position=3 title="nsx">NSX<span class="button_tally">3</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/nsx-t/' class=" post_tag button button_translucent" data-position=1 title="nsx-t">NSX-T<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/pinniped/' class=" post_tag button button_translucent" data-position=1 title="pinniped">PINNIPED<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/rbac/' class=" post_tag button button_translucent" data-position=1 title="rbac">RBAC<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/security/' class=" post_tag button button_translucent" data-position=5 title="security">SECURITY<span class="button_tally">5</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/storage/' class=" post_tag button button_translucent" data-position=1 title="storage">STORAGE<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/tanzu/' class=" post_tag button button_translucent" data-position=9 title="tanzu">TANZU<span class="button_tally">9</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/tanzu-mission-control/' class=" post_tag button button_translucent" data-position=1 title="tanzu-mission-control">TANZU-MISSION-CONTROL<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/tkg/' class=" post_tag button button_translucent" data-position=1 title="tkg">TKG<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/tmc/' class=" post_tag button button_translucent" data-position=1 title="tmc">TMC<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/troubleshooting/' class=" post_tag button button_translucent" data-position=1 title="troubleshooting">TROUBLESHOOTING<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/virtualization/' class=" post_tag button button_translucent" data-position=1 title="virtualization">VIRTUALIZATION<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/vmare-nsx-intelligence/' class=" post_tag button button_translucent" data-position=1 title="vmare-nsx-intelligence">VMARE-NSX-INTELLIGENCE<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/vmware-cloud/' class=" post_tag button button_translucent" data-position=1 title="vmware-cloud">VMWARE-CLOUD<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/vmware-nsx/' class=" post_tag button button_translucent" data-position=2 title="vmware-nsx">VMWARE-NSX<span class="button_tally">2</span>
            </a>
            
            <div class="tags_sort"><span title="sort alphabetically">[A~Z]</span><span title="sort by count">[0~9]</span>
            </div>
            <span class="tags_hide"><svg class="icon">
            <use xlink:href="#closeme"></use>
          </svg></span>
          </div>
        </div>
      </nav>
    </div>
    <div>
      <h2 class="mt-4 taxonomy" id="tags-section">Tags</h2>
      <nav class="tags_nav">
        <a href='https://blog.andreasm.io/tags/kubernetes/' class="post_tag button button_translucent" title="kubernetes">
          KUBERNETES
          <span class="button_tally">14</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/nsx/' class="post_tag button button_translucent" title="nsx">
          NSX
          <span class="button_tally">10</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/tanzu/' class="post_tag button button_translucent" title="tanzu">
          TANZU
          <span class="button_tally">9</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/antrea/' class="post_tag button button_translucent" title="antrea">
          ANTREA
          <span class="button_tally">8</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/ako/' class="post_tag button button_translucent" title="ako">
          AKO
          <span class="button_tally">7</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/security/' class="post_tag button button_translucent" title="security">
          SECURITY
          <span class="button_tally">6</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/avi/' class="post_tag button button_translucent" title="avi">
          AVI
          <span class="button_tally">4</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/ingress/' class="post_tag button button_translucent" title="ingress">
          INGRESS
          <span class="button_tally">4</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/availability/' class="post_tag button button_translucent" title="availability">
          AVAILABILITY
          <span class="button_tally">3</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/loadbalancing/' class="post_tag button button_translucent" title="loadbalancing">
          LOADBALANCING
          <span class="button_tally">3</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/authentication/' class="post_tag button button_translucent" title="authentication">
          AUTHENTICATION
          <span class="button_tally">2</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/cert-manager/' class="post_tag button button_translucent" title="cert-manager">
          CERT-MANAGER
          <span class="button_tally">2</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/docker/' class="post_tag button button_translucent" title="docker">
          DOCKER
          <span class="button_tally">2</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/hugo/' class="post_tag button button_translucent" title="hugo">
          HUGO
          <span class="button_tally">2</span>
        </a>
        
        
        <br>
        <div class="post_tags_toggle button">All Tags</div>
        <div class="post_tags">
          <div class="tags_list">
            
            <a href='https://blog.andreasm.io/tags/ako/' class=" post_tag button button_translucent" data-position=7 title="ako">AKO<span class="button_tally">7</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/amko/' class=" post_tag button button_translucent" data-position=1 title="amko">AMKO<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/antrea/' class=" post_tag button button_translucent" data-position=8 title="antrea">ANTREA<span class="button_tally">8</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/authentication/' class=" post_tag button button_translucent" data-position=2 title="authentication">AUTHENTICATION<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/automation/' class=" post_tag button button_translucent" data-position=1 title="automation">AUTOMATION<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/availability/' class=" post_tag button button_translucent" data-position=3 title="availability">AVAILABILITY<span class="button_tally">3</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/avi/' class=" post_tag button button_translucent" data-position=4 title="avi">AVI<span class="button_tally">4</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/cert-manager/' class=" post_tag button button_translucent" data-position=2 title="cert-manager">CERT-MANAGER<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/certificate/' class=" post_tag button button_translucent" data-position=1 title="certificate">CERTIFICATE<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/cni/' class=" post_tag button button_translucent" data-position=1 title="cni">CNI<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/custom-resource-definitions/' class=" post_tag button button_translucent" data-position=1 title="custom-resource-definitions">CUSTOM-RESOURCE-DEFINITIONS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/distributed-firewall/' class=" post_tag button button_translucent" data-position=1 title="distributed-firewall">DISTRIBUTED-FIREWALL<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/dns-service/' class=" post_tag button button_translucent" data-position=1 title="dns-service">DNS-SERVICE<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/docker/' class=" post_tag button button_translucent" data-position=2 title="docker">DOCKER<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/github/' class=" post_tag button button_translucent" data-position=1 title="github">GITHUB<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/grafana/' class=" post_tag button button_translucent" data-position=1 title="grafana">GRAFANA<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/gslb/' class=" post_tag button button_translucent" data-position=1 title="gslb">GSLB<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/harbor/' class=" post_tag button button_translucent" data-position=1 title="harbor">HARBOR<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/home-assistant/' class=" post_tag button button_translucent" data-position=1 title="home-assistant">HOME-ASSISTANT<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/hugo/' class=" post_tag button button_translucent" data-position=2 title="hugo">HUGO<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/ids/' class=" post_tag button button_translucent" data-position=1 title="ids">IDS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/informational/' class=" post_tag button button_translucent" data-position=2 title="informational">INFORMATIONAL<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/ingress/' class=" post_tag button button_translucent" data-position=4 title="ingress">INGRESS<span class="button_tally">4</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/ips/' class=" post_tag button button_translucent" data-position=1 title="ips">IPS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/keycloak/' class=" post_tag button button_translucent" data-position=1 title="keycloak">KEYCLOAK<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/kubernetes/' class=" post_tag button button_translucent" data-position=14 title="kubernetes">KUBERNETES<span class="button_tally">14</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/loadbalancer/' class=" post_tag button button_translucent" data-position=1 title="loadbalancer">LOADBALANCER<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/loadbalancing/' class=" post_tag button button_translucent" data-position=3 title="loadbalancing">LOADBALANCING<span class="button_tally">3</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/lodbalancing/' class=" post_tag button button_translucent" data-position=1 title="lodbalancing">LODBALANCING<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/loki/' class=" post_tag button button_translucent" data-position=1 title="loki">LOKI<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/multi-dc/' class=" post_tag button button_translucent" data-position=1 title="multi-dc">MULTI-DC<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/network/' class=" post_tag button button_translucent" data-position=2 title="network">NETWORK<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/network-policies/' class=" post_tag button button_translucent" data-position=2 title="network-policies">NETWORK-POLICIES<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/nfs/' class=" post_tag button button_translucent" data-position=1 title="nfs">NFS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/nsx/' class=" post_tag button button_translucent" data-position=10 title="nsx">NSX<span class="button_tally">10</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/nsx-advanced-loadbalancer/' class=" post_tag button button_translucent" data-position=1 title="nsx-advanced-loadbalancer">NSX-ADVANCED-LOADBALANCER<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/nsx-application-platform/' class=" post_tag button button_translucent" data-position=1 title="nsx-application-platform">NSX-APPLICATION-PLATFORM<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/nsx-t/' class=" post_tag button button_translucent" data-position=2 title="nsx-t">NSX-T<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/persistent-storage/' class=" post_tag button button_translucent" data-position=1 title="persistent-storage">PERSISTENT-STORAGE<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/pinniped/' class=" post_tag button button_translucent" data-position=1 title="pinniped">PINNIPED<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/prometheus/' class=" post_tag button button_translucent" data-position=1 title="prometheus">PROMETHEUS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/promtail/' class=" post_tag button button_translucent" data-position=1 title="promtail">PROMTAIL<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/pvc/' class=" post_tag button button_translucent" data-position=1 title="pvc">PVC<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/rbac/' class=" post_tag button button_translucent" data-position=1 title="rbac">RBAC<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/registry/' class=" post_tag button button_translucent" data-position=1 title="registry">REGISTRY<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/security/' class=" post_tag button button_translucent" data-position=6 title="security">SECURITY<span class="button_tally">6</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/static-content-generator/' class=" post_tag button button_translucent" data-position=1 title="static-content-generator">STATIC-CONTENT-GENERATOR<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/static-site-generator/' class=" post_tag button button_translucent" data-position=1 title="static-site-generator">STATIC-SITE-GENERATOR<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/tanzu/' class=" post_tag button button_translucent" data-position=9 title="tanzu">TANZU<span class="button_tally">9</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/tanzu-kubernetes-grid/' class=" post_tag button button_translucent" data-position=1 title="tanzu-kubernetes-grid">TANZU-KUBERNETES-GRID<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/tkg/' class=" post_tag button button_translucent" data-position=1 title="tkg">TKG<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/tkg-2.1/' class=" post_tag button button_translucent" data-position=1 title="tkg-2.1">TKG-2.1<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/tmc/' class=" post_tag button button_translucent" data-position=1 title="tmc">TMC<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/tmc-local/' class=" post_tag button button_translucent" data-position=1 title="tmc-local">TMC-LOCAL<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/tmc-sm/' class=" post_tag button button_translucent" data-position=1 title="tmc-sm">TMC-SM<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/troubleshooting/' class=" post_tag button button_translucent" data-position=2 title="troubleshooting">TROUBLESHOOTING<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/unifi/' class=" post_tag button button_translucent" data-position=1 title="unifi">UNIFI<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/vmconaws/' class=" post_tag button button_translucent" data-position=1 title="vmconaws">VMCONAWS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/vsphere/' class=" post_tag button button_translucent" data-position=1 title="vsphere">VSPHERE<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/vsphere-replication/' class=" post_tag button button_translucent" data-position=1 title="vsphere-replication">VSPHERE-REPLICATION<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/zwave/' class=" post_tag button button_translucent" data-position=1 title="zwave">ZWAVE<span class="button_tally">1</span>
            </a>
            
            <div class="tags_sort"><span title="sort alphabetically">[A~Z]</span><span title="sort by count">[0~9]</span>
            </div>
            <span class="tags_hide"><svg class="icon">
            <use xlink:href="#closeme"></use>
          </svg></span>
          </div>
        </div>
      </nav>
    </div>
  </section>
</aside>

  
</div>
    </main><svg width="0" height="0" class="hidden">
  <symbol viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" id="facebook">
    <path d="M437 0H75C33.648 0 0 33.648 0 75v362c0 41.352 33.648 75 75 75h151V331h-60v-90h60v-61c0-49.629 40.371-90 90-90h91v90h-91v61h91l-15 90h-76v181h121c41.352 0 75-33.648 75-75V75c0-41.352-33.648-75-75-75zm0 0"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18.001 18.001" id="twitter">
    <path d="M15.891 4.013c.808-.496 1.343-1.173 1.605-2.034a8.68 8.68 0 0 1-2.351.861c-.703-.756-1.593-1.14-2.66-1.14-1.043 0-1.924.366-2.643 1.078a3.56 3.56 0 0 0-1.076 2.605c0 .309.039.585.117.819-3.076-.105-5.622-1.381-7.628-3.837-.34.601-.51 1.213-.51 1.846 0 1.301.549 2.332 1.645 3.089-.625-.053-1.176-.211-1.645-.47 0 .929.273 1.705.82 2.388a3.623 3.623 0 0 0 2.115 1.291c-.312.08-.641.118-.979.118-.312 0-.533-.026-.664-.083.23.757.664 1.371 1.291 1.841a3.652 3.652 0 0 0 2.152.743C4.148 14.173 2.625 14.69.902 14.69c-.422 0-.721-.006-.902-.038 1.697 1.102 3.586 1.649 5.676 1.649 2.139 0 4.029-.542 5.674-1.626 1.645-1.078 2.859-2.408 3.639-3.974a10.77 10.77 0 0 0 1.172-4.892v-.468a7.788 7.788 0 0 0 1.84-1.921 8.142 8.142 0 0 1-2.11.593z"
      ></path>
  </symbol>
  <symbol aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id="mail">
    <path  d="M502.3 190.8c3.9-3.1 9.7-.2 9.7 4.7V400c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V195.6c0-5 5.7-7.8 9.7-4.7 22.4 17.4 52.1 39.5 154.1 113.6 21.1 15.4 56.7 47.8 92.2 47.6 35.7.3 72-32.8 92.3-47.6 102-74.1 131.6-96.3 154-113.7zM256 320c23.2.4 56.6-29.2 73.4-41.4 132.7-96.3 142.8-104.7 173.4-128.7 5.8-4.5 9.2-11.5 9.2-18.9v-19c0-26.5-21.5-48-48-48H48C21.5 64 0 85.5 0 112v19c0 7.4 3.4 14.3 9.2 18.9 30.6 23.9 40.7 32.4 173.4 128.7 16.8 12.2 50.2 41.8 73.4 41.4z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id="calendar">
    <path d="M452 40h-24V0h-40v40H124V0H84v40H60C26.916 40 0 66.916 0 100v352c0 33.084 26.916 60 60 60h392c33.084 0 60-26.916 60-60V100c0-33.084-26.916-60-60-60zm20 412c0 11.028-8.972 20-20 20H60c-11.028 0-20-8.972-20-20V188h432v264zm0-304H40v-48c0-11.028 8.972-20 20-20h24v40h40V80h264v40h40V80h24c11.028 0 20 8.972 20 20v48z"></path>
    <path d="M76 230h40v40H76zm80 0h40v40h-40zm80 0h40v40h-40zm80 0h40v40h-40zm80 0h40v40h-40zM76 310h40v40H76zm80 0h40v40h-40zm80 0h40v40h-40zm80 0h40v40h-40zM76 390h40v40H76zm80 0h40v40h-40zm80 0h40v40h-40zm80 0h40v40h-40zm80-80h40v40h-40z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id="github">
    <path d="M255.968 5.329C114.624 5.329 0 120.401 0 262.353c0 113.536 73.344 209.856 175.104 243.872 12.8 2.368 17.472-5.568 17.472-12.384 0-6.112-.224-22.272-.352-43.712-71.2 15.52-86.24-34.464-86.24-34.464-11.616-29.696-28.416-37.6-28.416-37.6-23.264-15.936 1.728-15.616 1.728-15.616 25.696 1.824 39.2 26.496 39.2 26.496 22.848 39.264 59.936 27.936 74.528 21.344 2.304-16.608 8.928-27.936 16.256-34.368-56.832-6.496-116.608-28.544-116.608-127.008 0-28.064 9.984-51.008 26.368-68.992-2.656-6.496-11.424-32.64 2.496-68 0 0 21.504-6.912 70.4 26.336 20.416-5.696 42.304-8.544 64.096-8.64 21.728.128 43.648 2.944 64.096 8.672 48.864-33.248 70.336-26.336 70.336-26.336 13.952 35.392 5.184 61.504 2.56 68 16.416 17.984 26.304 40.928 26.304 68.992 0 98.72-59.84 120.448-116.864 126.816 9.184 7.936 17.376 23.616 17.376 47.584 0 34.368-.32 62.08-.32 70.496 0 6.88 4.608 14.88 17.6 12.352C438.72 472.145 512 375.857 512 262.353 512 120.401 397.376 5.329 255.968 5.329z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 212 212" id="gitlab">
    <path d="M12.3 74.7h54L43.3 3c-1-3.6-6.4-3.6-7.6 0L12.3 74.8z" />
    <path d="M12.3 74.7L.5 111c-1 3.2 0 6.8 3 8.8l101.6 74-92.5-119z"/>
    <path d="M105 193.7l-38.6-119h-54l92.7 119z"/>
    <path d="M105 193.7l38.7-119H66.4l38.7 119z"/>
    <path d="M105 193.7l38.7-119H198l-93 119z"/>
    <path d="M198 74.7l11.6 36.2c1 3 0 6.6-3 8.6l-101.5 74 93-119z"/>
    <path d="M198 74.7h-54.3L167 3c1.2-3.6 6.4-3.6 7.6 0L198 74.8z"/> 
  </symbol>
  <symbol viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" id="rss">
    <circle cx="3.429" cy="20.571" r="3.429"></circle>
    <path d="M11.429 24h4.57C15.999 15.179 8.821 8.001 0 8v4.572c6.302.001 11.429 5.126 11.429 11.428z"></path>
    <path d="M24 24C24 10.766 13.234 0 0 0v4.571c10.714 0 19.43 8.714 19.43 19.429z"></path>
  </symbol>
  <symbol viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" id="linkedin">
    <path d="M437 0H75C33.648 0 0 33.648 0 75v362c0 41.352 33.648 75 75 75h362c41.352 0 75-33.648 75-75V75c0-41.352-33.648-75-75-75zM181 406h-60V196h60zm0-240h-60v-60h60zm210 240h-60V286c0-16.54-13.46-30-30-30s-30 13.46-30 30v120h-60V196h60v11.309C286.719 202.422 296.93 196 316 196c40.691.043 75 36.547 75 79.688zm0 0"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 612 612" id="to-top">
    <path d="M604.501 440.509L325.398 134.956c-5.331-5.357-12.423-7.627-19.386-7.27-6.989-.357-14.056 1.913-19.387 7.27L7.499 440.509c-9.999 10.024-9.999 26.298 0 36.323s26.223 10.024 36.222 0l262.293-287.164L568.28 476.832c9.999 10.024 26.222 10.024 36.221 0 9.999-10.023 9.999-26.298 0-36.323z"></path>
  </symbol>
  <symbol viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" id="carly">
    <path d="M504.971 239.029L448 182.059V84c0-46.317-37.682-84-84-84h-44c-13.255 0-24 10.745-24 24s10.745 24 24 24h44c19.851 0 36 16.149 36 36v108c0 6.365 2.529 12.47 7.029 16.971L454.059 256l-47.029 47.029A24.002 24.002 0 0 0 400 320v108c0 19.851-16.149 36-36 36h-44c-13.255 0-24 10.745-24 24s10.745 24 24 24h44c46.318 0 84-37.683 84-84v-98.059l56.971-56.971c9.372-9.372 9.372-24.568 0-33.941zM112 192V84c0-19.851 16.149-36 36-36h44c13.255 0 24-10.745 24-24S205.255 0 192 0h-44c-46.318 0-84 37.683-84 84v98.059l-56.971 56.97c-9.373 9.373-9.373 24.568 0 33.941L64 329.941V428c0 46.317 37.682 84 84 84h44c13.255 0 24-10.745 24-24s-10.745-24-24-24h-44c-19.851 0-36-16.149-36-36V320c0-6.365-2.529-12.47-7.029-16.971L57.941 256l47.029-47.029A24.002 24.002 0 0 0 112 192z"></path>
  </symbol>
  <symbol viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" id="copy">
    <path d="M23 2.75A2.75 2.75 0 0 0 20.25 0H8.75A2.75 2.75 0 0 0 6 2.75v13.5A2.75 2.75 0 0 0 8.75 19h11.5A2.75 2.75 0 0 0 23 16.25zM18.25 14.5h-7.5a.75.75 0 0 1 0-1.5h7.5a.75.75 0 0 1 0 1.5zm0-3h-7.5a.75.75 0 0 1 0-1.5h7.5a.75.75 0 0 1 0 1.5zm0-3h-7.5a.75.75 0 0 1 0-1.5h7.5a.75.75 0 0 1 0 1.5z"></path>
    <path d="M8.75 20.5a4.255 4.255 0 0 1-4.25-4.25V2.75c0-.086.02-.166.025-.25H3.75A2.752 2.752 0 0 0 1 5.25v16A2.752 2.752 0 0 0 3.75 24h12a2.752 2.752 0 0 0 2.75-2.75v-.75z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512.001 512.001" id="closeme">
    <path d="M284.286 256.002L506.143 34.144c7.811-7.811 7.811-20.475 0-28.285-7.811-7.81-20.475-7.811-28.285 0L256 227.717 34.143 5.859c-7.811-7.811-20.475-7.811-28.285 0-7.81 7.811-7.811 20.475 0 28.285l221.857 221.857L5.858 477.859c-7.811 7.811-7.811 20.475 0 28.285a19.938 19.938 0 0 0 14.143 5.857 19.94 19.94 0 0 0 14.143-5.857L256 284.287l221.857 221.857c3.905 3.905 9.024 5.857 14.143 5.857s10.237-1.952 14.143-5.857c7.811-7.811 7.811-20.475 0-28.285L284.286 256.002z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id="open-menu">
    <path d="M492 236H20c-11.046 0-20 8.954-20 20s8.954 20 20 20h472c11.046 0 20-8.954 20-20s-8.954-20-20-20zm0-160H20C8.954 76 0 84.954 0 96s8.954 20 20 20h472c11.046 0 20-8.954 20-20s-8.954-20-20-20zm0 320H20c-11.046 0-20 8.954-20 20s8.954 20 20 20h472c11.046 0 20-8.954 20-20s-8.954-20-20-20z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="instagram">
    <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id=youtube>
    <path d="M19.615 3.184c-3.604-.246-11.631-.245-15.23 0-3.897.266-4.356 2.62-4.385 8.816.029 6.185.484 8.549 4.385 8.816 3.6.245 11.626.246 15.23 0 3.897-.266 4.356-2.62 4.385-8.816-.029-6.185-.484-8.549-4.385-8.816zm-10.615 12.816v-8l8 3.993-8 4.007z"/>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="stackoverflow">
    <path d="M21 27v-8h3v11H0V19h3v8h18z"></path><path d="M17.1.2L15 1.8l7.9 10.6 2.1-1.6L17.1.2zm3.7 14.7L10.6 6.4l1.7-2 10.2 8.5-1.7 2zM7.2 12.3l12 5.6 1.1-2.4-12-5.6-1.1 2.4zm-1.8 6.8l13.56 1.96.17-2.38-13.26-2.55-.47 2.97zM19 25H5v-3h14v3z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="xing">
    <path d="M18.188 0c-.517 0-.741.325-.927.66 0 0-7.455 13.224-7.702 13.657.015.024 4.919 9.023 4.919 9.023.17.308.436.66.967.66h3.454c.211 0 .375-.078.463-.22.089-.151.089-.346-.009-.536l-4.879-8.916c-.004-.006-.004-.016 0-.022L22.139.756c.095-.191.097-.387.006-.535C22.056.078 21.894 0 21.686 0h-3.498zM3.648 4.74c-.211 0-.385.074-.473.216-.09.149-.078.339.02.531l2.34 4.05c.004.01.004.016 0 .021L1.86 16.051c-.099.188-.093.381 0 .529.085.142.239.234.45.234h3.461c.518 0 .766-.348.945-.667l3.734-6.609-2.378-4.155c-.172-.315-.434-.659-.962-.659H3.648v.016z"/>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 71 55" id="discord">
    <path d="M60.1045 4.8978C55.5792 2.8214 50.7265 1.2916 45.6527 0.41542C45.5603 0.39851 45.468 0.440769 45.4204 0.525289C44.7963 1.6353 44.105 3.0834 43.6209 4.2216C38.1637 3.4046 32.7345 3.4046 27.3892 4.2216C26.905 3.0581 26.1886 1.6353 25.5617 0.525289C25.5141 0.443589 25.4218 0.40133 25.3294 0.41542C20.2584 1.2888 15.4057 2.8186 10.8776 4.8978C10.8384 4.9147 10.8048 4.9429 10.7825 4.9795C1.57795 18.7309 -0.943561 32.1443 0.293408 45.3914C0.299005 45.4562 0.335386 45.5182 0.385761 45.5576C6.45866 50.0174 12.3413 52.7249 18.1147 54.5195C18.2071 54.5477 18.305 54.5139 18.3638 54.4378C19.7295 52.5728 20.9469 50.6063 21.9907 48.5383C22.0523 48.4172 21.9935 48.2735 21.8676 48.2256C19.9366 47.4931 18.0979 46.6 16.3292 45.5858C16.1893 45.5041 16.1781 45.304 16.3068 45.2082C16.679 44.9293 17.0513 44.6391 17.4067 44.3461C17.471 44.2926 17.5606 44.2813 17.6362 44.3151C29.2558 49.6202 41.8354 49.6202 53.3179 44.3151C53.3935 44.2785 53.4831 44.2898 53.5502 44.3433C53.9057 44.6363 54.2779 44.9293 54.6529 45.2082C54.7816 45.304 54.7732 45.5041 54.6333 45.5858C52.8646 46.6197 51.0259 47.4931 49.0921 48.2228C48.9662 48.2707 48.9102 48.4172 48.9718 48.5383C50.038 50.6034 51.2554 52.5699 52.5959 54.435C52.6519 54.5139 52.7526 54.5477 52.845 54.5195C58.6464 52.7249 64.529 50.0174 70.6019 45.5576C70.6551 45.5182 70.6887 45.459 70.6943 45.3942C72.1747 30.0791 68.2147 16.7757 60.1968 4.9823C60.1772 4.9429 60.1437 4.9147 60.1045 4.8978ZM23.7259 37.3253C20.2276 37.3253 17.3451 34.1136 17.3451 30.1693C17.3451 26.225 20.1717 23.0133 23.7259 23.0133C27.308 23.0133 30.1626 26.2532 30.1066 30.1693C30.1066 34.1136 27.28 37.3253 23.7259 37.3253ZM47.3178 37.3253C43.8196 37.3253 40.9371 34.1136 40.9371 30.1693C40.9371 26.225 43.7636 23.0133 47.3178 23.0133C50.9 23.0133 53.7545 26.2532 53.6986 30.1693C53.6986 34.1136 50.9 37.3253 47.3178 37.3253Z"/>
  </symbol>
</svg>


<footer class="footer">
  <div class="footer_inner wrap pale">
    <img src='https://blog.andreasm.io/icons/apple-touch-icon.png' class="icon icon_2 transparent" alt="From 0.985mhz... to several Ghz">
    <p>Copyright&nbsp;2016-&nbsp;<span class="year"></span>&nbsp;FROM 0.985MHZ... TO SEVERAL GHZ. All Rights Reserved</p><a class="to_top" href="#documentTop">
  <svg class="icon">
  <title>to-top</title>
  <use xlink:href="#to-top"></use>
</svg>

</a>

  </div>
</footer>

<script type="text/javascript" src="https://blog.andreasm.io/en/js/bundle.5548d358738600c857a1f05f0459418da7143d4426c66a08bf3f15ded1b39dd2136bf104a559247a909fc4dcc45b8e06bad0870ece4c71ee5303d30550def8bd.js" integrity="sha512-VUjTWHOGAMhXofBfBFlBjacUPUQmxmoIvz8V3tGzndITa/EEpVkkepCfxNzEW44GutCHDs5Mce5TA9MFUN74vQ==" crossorigin="anonymous"></script>

  <script src="https://blog.andreasm.io/js/search.min.df4d84e4983f0c71dd495e07a09815d920553c3ddf3d0767801c73373573aa17e1b489e4453272dbf4ce2a38a3d01a10b170744e50dd6bec85a598221867ba9a.js"></script>

  </body>
</html>
