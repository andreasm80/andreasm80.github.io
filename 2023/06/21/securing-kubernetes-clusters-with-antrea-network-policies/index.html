
<!DOCTYPE html>
<html
  lang="en"
  data-figures=""
  
    class="page"
  
  
  
    data-mode="dim"
  >
  <head>
<title>Securing Kubernetes clusters with Antrea Network Policies | From 0.985mhz... to several Ghz</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-TVPYDVE8KR"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-TVPYDVE8KR');
</script>



  
<meta property="og:locale" content="en" />

<meta property="og:type" content="article">
<meta name="description" content="Antrea Network Policies" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:creator" content="">
<meta name="twitter:title" content="Securing Kubernetes clusters with Antrea Network Policies" />
<meta name="twitter:image" content="https://blog.andreasm.io/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/antrea-stacked-color3.webp"/>
<meta property="og:url" content="https://blog.andreasm.io/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/" />
<meta property="og:title" content="Securing Kubernetes clusters with Antrea Network Policies" />
<meta property="og:description" content="Antrea Network Policies" />
<meta property="og:image" content="https://blog.andreasm.io/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/antrea-stacked-color3.webp" />
  <meta name="keywords" content="nsx,vmware,networking,infrastucture,lodbalancing,tanzu,security,cni,antrea,cilium,kubernetes" />

<link rel="apple-touch-icon" sizes="180x180" href="https://blog.andreasm.io/icons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://blog.andreasm.io/icons/favicon-32x32.png">
<link rel="manifest" href="https://blog.andreasm.io/icons/site.webmanifest">

<link rel="canonical" href="https://blog.andreasm.io/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/">



<link rel="preload" href="https://blog.andreasm.io/css/styles.6c67fa3a7f5290a2facfb027358dd2bdb5450d04b8de427c8a74d79f524a7fb716b470b14b6ba95f1b7cf3aa9a2219a7294a6adeaf16a1080f432eae45d8c03c.css" integrity = "sha512-bGf6On9SkKL6z7AnNY3SvbVFDQS43kJ8inTXn1JKf7cWtHCxS2upXxt886qaIhmnKUpq3q8WoQgPQy6uRdjAPA==" as="style" crossorigin="anonymous">



<link rel="preload" href="https://blog.andreasm.io/en/js/bundle.5548d358738600c857a1f05f0459418da7143d4426c66a08bf3f15ded1b39dd2136bf104a559247a909fc4dcc45b8e06bad0870ece4c71ee5303d30550def8bd.js" as="script" integrity=
"sha512-VUjTWHOGAMhXofBfBFlBjacUPUQmxmoIvz8V3tGzndITa/EEpVkkepCfxNzEW44GutCHDs5Mce5TA9MFUN74vQ==" crossorigin="anonymous">


<link rel="stylesheet" type="text/css" href="https://blog.andreasm.io/css/styles.6c67fa3a7f5290a2facfb027358dd2bdb5450d04b8de427c8a74d79f524a7fb716b470b14b6ba95f1b7cf3aa9a2219a7294a6adeaf16a1080f432eae45d8c03c.css" integrity="sha512-bGf6On9SkKL6z7AnNY3SvbVFDQS43kJ8inTXn1JKf7cWtHCxS2upXxt886qaIhmnKUpq3q8WoQgPQy6uRdjAPA==" crossorigin="anonymous">


  </head>
  <body
    data-code="7"
    data-lines="false"
    id="documentTop"
    data-lang="en"
  >

<header class="nav_header" >
  <nav class="nav"><a href='https://blog.andreasm.io/' class="nav_brand nav_item" title="From 0.985mhz... to several Ghz">
  <img src="https://blog.andreasm.io/quote3.png" class="logo" alt="From 0.985mhz... to several Ghz">
  <div class="nav_close">
    <div><svg class="icon">
  <title>open-menu</title>
  <use xlink:href="#open-menu"></use>
</svg>
<svg class="icon">
  <title>closeme</title>
  <use xlink:href="#closeme"></use>
</svg>
</div>
  </div>
</a>

    <div class='nav_body nav_body_left'>
      
      
      
        

  <div class="nav_parent">
    <a href="https://blog.andreasm.io/" class="nav_item" title="Home">Home </a>
  </div>
  <div class="nav_parent">
    <a href="https://blog.andreasm.io/about/" class="nav_item" title="About">About </a>
  </div>
      
<div class='follow'>
<div class="color_mode">
  <input type="checkbox" class="color_choice" id="mode">
</div>

</div>

    </div>
  </nav>
</header>

    <main>
  
<div class="grid-inverse wrap content">
  <article class="post_content">
    <h1 class="post_title">Securing Kubernetes clusters with Antrea Network Policies</h1>
  <div class="post_meta">
    <span><svg class="icon">
  <title>calendar</title>
  <use xlink:href="#calendar"></use>
</svg>
</span>
    <span class="post_date">
      21-06-2023</span>
    <span class="post_time"> · 30 min read</span><span>&nbsp;· <a href='https://blog.andreasm.io/tags/security/' title="security" class="post_tag button button_translucent">security
        </a><a href='https://blog.andreasm.io/tags/cni/' title="cni" class="post_tag button button_translucent">cni
        </a><a href='https://blog.andreasm.io/tags/kubernetes/' title="kubernetes" class="post_tag button button_translucent">kubernetes
        </a><a href='https://blog.andreasm.io/tags/antrea/' title="antrea" class="post_tag button button_translucent">antrea
        </a><a href='https://blog.andreasm.io/tags/tmc/' title="tmc" class="post_tag button button_translucent">tmc
        </a>
    </span>
    <span class="page_only">&nbsp;·
  <div class="post_share">
    Share on:
    <a href="https://twitter.com/intent/tweet?text=Securing%20Kubernetes%20clusters%20with%20Antrea%20Network%20Policies&url=https%3a%2f%2fblog.andreasm.io%2f2023%2f06%2f21%2fsecuring-kubernetes-clusters-with-antrea-network-policies%2f&tw_p=tweetbutton" class="twitter" title="Share on Twitter" target="_blank" rel="nofollow">
      <svg class="icon">
  <title>twitter</title>
  <use xlink:href="#twitter"></use>
</svg>

    </a>
    <a href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fblog.andreasm.io%2f2023%2f06%2f21%2fsecuring-kubernetes-clusters-with-antrea-network-policies%2f&t=Securing%20Kubernetes%20clusters%20with%20Antrea%20Network%20Policies" class="facebook" title="Share on Facebook" target="_blank" rel="nofollow">
      <svg class="icon">
  <title>facebook</title>
  <use xlink:href="#facebook"></use>
</svg>

    </a>
    <a href="#linkedinshare" id = "linkedinshare" class="linkedin" title="Share on LinkedIn" rel="nofollow">
      <svg class="icon">
  <title>linkedin</title>
  <use xlink:href="#linkedin"></use>
</svg>

    </a>
    <a href="https://blog.andreasm.io/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/" title="Copy Link" class="link link_yank">
      <svg class="icon">
  <title>copy</title>
  <use xlink:href="#copy"></use>
</svg>

    </a>
  </div>
  </span>
  </div>

      <div class="post_toc">
        <h2>Overview</h2>
        <nav id="TableOfContents">
  <ul>
    <li><a href="#different-layers-of-security-different-personas-different-enforcement-points">Different layers of security, different personas, different enforcement points</a></li>
    <li><a href="#managing-and-making-sure-the-required-antrea-policies-are-applied">Managing and making sure the required Antrea Policies are applied</a></li>
    <li><a href="#applying-antrea-policies-with-kubectl">Applying Antrea policies with kubectl</a></li>
    <li><a href="#applying-antrea-policies-using-tmc---tanzu-mission-control">Applying Antrea policies using TMC - Tanzu Mission Control</a>
      <ul>
        <li><a href="#preparing-tmc">Preparing TMC</a></li>
        <li><a href="#git-repository">Git repository</a></li>
        <li><a href="#tmc-kustomization">TMC Kustomization</a></li>
        <li><a href="#deploy-tkc-cluster-from-tmc---auto-apply-security-policies">Deploy TKC cluster from TMC - auto apply security policies</a></li>
      </ul>
    </li>
    <li><a href="#applying-antrea-policies-with-nsx">Applying Antrea policies with NSX</a>
      <ul>
        <li><a href="#applying-antrea-native-policies-from-the-nsx-manager">Applying Antrea native policies from the NSX manager</a></li>
        <li><a href="#applying-kubernetes-related-policies-using-inventory-information-from-antrea">Applying Kubernetes related policies using inventory information from Antrea</a></li>
      </ul>
    </li>
    <li><a href="#rbac---making-sure-no-one-can-overwriteoverride-existing-rules">RBAC - making sure no one can overwrite/override existing rules.</a></li>
    <li><a href="#outro">Outro...</a></li>
  </ul>
</nav>
      </div>
    
    <div class="post_body"><h1 id="some-context">Some context...</h1>
<p>I have written a couple of post previously on the topic Antrea Policies, this time I will try to put it more into a context, how we can use and create Antrea Policies in different scenarios and with some &quot;frameworks&quot; from different perspectives in the organization.</p>
<p>What if, and how, can we deliver a already secured Kubernetes cluster, like an out of the box experience, with policies applied that meets certain guidelines for what is allowed and not allowed in the organization for certain Kubernetes clusters. Whether they are manually provisioned, or provisined on demand. So in this post a will try to be a bit specific on how to achieve this, with a simulated requirement as context, will get back to this context a further down. The following products will be used in this post: vSphere with Tanzu and TKG workload clusters, Antrea as the CNI, Tanzu Mission Control and VMware NSX.</p>
<p>As usual, for more details on the above mentioned product head over to the below links</p>
<ul>
<li><a href="https://antrea.io/">Antrea</a> for detailed and updated documentation.</li>
<li><a href="https://docs.vmware.com/en/VMware-vSphere/index.html">vSphere with Tanzu</a> for detailed and updated documentation.</li>
<li><a href="https://docs.vmware.com/en/VMware-Tanzu-Mission-Control/index.html">Tanzu Mission Control</a> for detailed and updated documentation.</li>
<li><a href="https://docs.vmware.com/en/VMware-NSX/index.html">VMware NSX</a> for detailed and updated documentation.</li>
</ul>
<h2 id="different-layers-of-security-different-personas-different-enforcement-points">Different layers of security, different personas, different enforcement points</h2>
<p>This post will mostly be focusing in on the Kubernetes perspective, using specifically Antrea Network policies to restrict traffic inside the Kubernetes cluster. A Kubernetes cluster is just one infrastructure component in the organization, but contains many moving parts with applications and services inside. Even inside a Kubernetes cluster there can be different classifications for what should be allowed and not. Therefore a Kubernetes cluster is also in need to be to be secured with a set of tools and policies to satisfy the security policy guidelines in the organization. A Kubernetes cluster is another layer in the infrastructure that needs to be controlled. In a typical datacenter we have several security mechanisms in place like AV agents, physical firewall, virtual firewall, NSX distributed firewall. All these play an important role in the different layers of the datacenter/organization. Assuming the Kubernetes worker nodes are running as virtual machines on VMware vSphere the below illustration describes two layers of security using NSX distributed firewall securing the VM workers, and Antrea Network Policies securing pods, services inside the Kubernetes cluster.</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="two-layers"
      
        class="image_figure image_internal image_processed"
        width="2562"
        height="1240"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230628155554248.png"
      
      
    />

    </picture>
</figure>
</p>
<p>With the illustration above in mind it is fully possible to create a very strict environment with no unwanted lateral movement. Meaning only the strict necessary firewall openings inside the kubernetes cluster between pods, namespaces and services, but also between workers in same subnet and across several several Kubernetes clusters. But the above two layers, VMs in vSphere protected by the NSX distributed firewall and apps running Kubernetes clusters and protected by Antrea Network policies, are often managed by different personas in the organization. We have the vSphere admins, Network admins, Security Admins, App Operators and App Developers. Security is crucial in a modern datacenter, so, again, the correct tools needs to be in place for the organization's security-framework to be implemented all the way down the &quot;stack&quot; to be compliant. Very often there is a decided theoretical security framework/design in place, but that plan is not always so straightforward to implement.</p>
<p>Going back to Kubernetes again and Antrea Network policies. Antrea feature several static (and optional custom) <a href="https://antrea.io/docs/v1.12.0/docs/antrea-network-policy/#tier">Tiers</a> where different types of network policies can be applied. As all the Antrea Network policies are evaluated &quot;top-down&quot; it is very handy to be able to place some strict rules very early in the &quot;chain&quot; of firewall policies to ensure the organization's security compliance is met. Being able to place these rules at the top prohibits the creation of rules further down that contradicts these top rules, they will not be evaluated. Then there is room to create a framework that gives some sense of &quot;flexibility&quot; to support the environment's workload according to the type of classification (prod, dev, test, dmz, trust, untrust). Other policies can be applied to further restrict movement before hitting a default block rule that takes care of anything that is not specified earlier in the &quot;chain&quot; of policies. The illustration below is an example of whom and where these personas can take charge and apply their needed policies.</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="personas"
      
        class="image_figure image_internal image_processed"
        width="2322"
        height="1060"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230628151139497.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Then the next illustration is the default Static Tiers that comes with Antrea. These Tiers makes it easier to categorize the different policies in a Kubernetes cluster, but also provides a great way to delegate responsibility/permissions by using RBAC to control access to the Tiers. This means we can have some admins to apply policies in specific Tiers, and no one else can overwrite these.</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="tiers"
      
        class="image_figure image_internal image_processed"
        width="2220"
        height="1058"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230628150747847.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Now, how can the different personas make sure their policies are applied? This is what I will go through next.</p>
<h2 id="managing-and-making-sure-the-required-antrea-policies-are-applied">Managing and making sure the required Antrea Policies are applied</h2>
<p>Lets start out by bringing some light on the simulated requirement I mentioned above. Customer Andreas have some strict security guidelines they need to follow to ensure compliance before anyone can do anything in the Kubernetes platforms.
To be compliant according to the strict security guidelines the following must be in place:</p>
<ul>
<li>All Kubernetes workload clusters are considered isolated and not allowed to reach nothing more than themselves, including pods and services (all nodes in the same cluster)</li>
<li>Only necessary backend functions such as DNS/NTP are allowed.</li>
<li>Certain management tools need access to the clusters</li>
<li>All non-system namespaces should be considered &quot;untrusted&quot; and isolated by default.</li>
<li>RBAC needs to be in place to ensure no tampering on applied security policies.</li>
</ul>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="lock-down"
      
        class="image_figure image_internal image_processed"
        width="3584"
        height="1678"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230629094638744.png"
      
      
    />

    </picture>
</figure>
</p>
<p>The above diagram is what customer Andreas needs to have in place. Lets go ahead and apply them. In the next sub-chapters I will show how to apply and manage the policies in three different ways to acheive this. I assume the NSX personas has done their part and applied the correct distributed firewall rules isolating the worker nodes.</p>
<h2 id="applying-antrea-policies-with-kubectl">Applying Antrea policies with kubectl</h2>
<p>This process involves logging into a newly provisioned Kubernetes cluster (TKG cluster in my environment) that someone has provisioned, could be the vSphere admin persona, or via a self-service. Then the security admin will be using <em>kubectl</em> to log in and apply some yaml definitions to acheive the above requirements. This operation will typically be the security admin responsibilities. The definitions the security admin is applying will all be configured in the static Tier &quot;<em>securityops</em>&quot; with different priorities.
Here is the demo-environment I will be using in the following chapters:

  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="demo-environment"
      
        class="image_figure image_internal image_processed"
        width="3140"
        height="1220"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230630091314220.png"
      
      
    />

    </picture>
</figure>
</p>
<p>The first requirement is a &quot;no-trust&quot; in any non-system namespaces, where I want to achieve full isolation between namespace. No communication from one namespace to another. In the Antrea <a href="https://antrea.io/docs/v1.12.0/docs/antrea-network-policy/">homepage</a> there are several examples, and I will use one of the examples that suits my need perfectly. It looks like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">crd.antrea.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterNetworkPolicy</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">strict-ns-isolation-except-system-ns</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">  </span><span class="nt">priority</span><span class="p">:</span><span class="w"> </span><span class="m">9</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">  </span><span class="nt">tier</span><span class="p">:</span><span class="w"> </span><span class="l">securityops</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">  </span><span class="nt">appliedTo</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    </span>- <span class="nt">namespaceSelector</span><span class="p">:</span><span class="w">          </span><span class="c"># Selects all non-system Namespaces in the cluster</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">        </span><span class="nt">matchExpressions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">          </span>- {<span class="nt">key:  kubernetes.io/metadata.name, operator: NotIn, values</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="l">avi-system,default,kube-node-lease,kube-public,kube-system,secretgen-controller,tanzu-continuousdelivery-resources,tanzu-fluxcd-packageinstalls,tanzu-kustomize-controller,tanzu-source-controller,tkg-system,vmware-system-auth,vmware-system-cloud-provider,vmware-system-csi,vmware-system-tkg,vmware-system-tmc]}</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">  </span><span class="nt">ingress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">    </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Pass</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">      </span><span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">        </span>- <span class="nt">namespaces</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">            </span><span class="nt">match</span><span class="p">:</span><span class="w"> </span><span class="l">Self          </span><span class="w"> </span><span class="c"># Skip ACNP evaluation for traffic from Pods in the same Namespace</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">PassFromSameNS</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">    </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Drop</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">      </span><span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">        </span>- <span class="nt">namespaceSelector</span><span class="p">:</span><span class="w"> </span>{}<span class="w">   </span><span class="c"># Drop from Pods from all other Namespaces</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">DropFromAllOtherNS</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">  </span><span class="nt">egress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">    </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Pass</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">      </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">        </span>- <span class="nt">namespaces</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w">            </span><span class="nt">match</span><span class="p">:</span><span class="w"> </span><span class="l">Self          </span><span class="w"> </span><span class="c"># Skip ACNP evaluation for traffic to Pods in the same Namespace</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">PassToSameNS</span><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w">    </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Drop</span><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">      </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w">        </span>- <span class="nt">namespaceSelector</span><span class="p">:</span><span class="w"> </span>{}<span class="w">   </span><span class="c"># Drop to Pods from all other Namespaces</span><span class="w">
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">DropToAllOtherNS</span><span class="w">
</span></span></span></code></pre></div><p>The only modifications I have done is adding all my system-namespaces.
Then I will apply it.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1"># Verifying no policies in place:</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">andreasm@linuxvm01:~/antrea/policies/groups$ k get acnp
</span></span><span class="line"><span class="ln">3</span><span class="cl">No resources found
</span></span><span class="line"><span class="ln">4</span><span class="cl">andreasm@linuxvm01:~/antrea/policies/groups$ k apply -f acnp-ns-isolation-except-system-ns.yaml
</span></span><span class="line"><span class="ln">5</span><span class="cl">clusternetworkpolicy.crd.antrea.io/strict-ns-isolation-except-system-ns created
</span></span><span class="line"><span class="ln">6</span><span class="cl">andreasm@linuxvm01:~/antrea/policies/groups$ k get acnp
</span></span><span class="line"><span class="ln">7</span><span class="cl">NAME                                   TIER          PRIORITY   DESIRED NODES   CURRENT NODES   AGE
</span></span><span class="line"><span class="ln">8</span><span class="cl">strict-ns-isolation-except-system-ns   securityops   <span class="m">9</span>          <span class="m">0</span>               <span class="m">0</span>               15s
</span></span></code></pre></div><p>Notice the 0 under <em>Desired Nodes</em> and <em>Current Nodes</em>. The reason is that this cluster is completely new, and there is no workload in any non-system namespaces yet. Here are the current namespaces:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">andreasm@linuxvm01:~/antrea/policies/groups$ k get ns
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">NAME                                 STATUS   AGE
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">default                              Active   28d
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">kube-node-lease                      Active   28d
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">kube-public                          Active   28d
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">kube-system                          Active   28d
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">secretgen-controller                 Active   28d
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">tkg-system                           Active   28d
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">vmware-system-auth                   Active   28d
</span></span><span class="line"><span class="ln">10</span><span class="cl">vmware-system-cloud-provider         Active   28d
</span></span><span class="line"><span class="ln">11</span><span class="cl">vmware-system-csi                    Active   28d
</span></span><span class="line"><span class="ln">12</span><span class="cl">vmware-system-tkg                    Active   28d
</span></span></code></pre></div><p>Now if I apply a couple of namespaces and deploy some workload in them:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@linuxvm01:~/antrea/policies/groups$ k apply -f dev-app.yaml -f dev-app2.yaml
</span></span><span class="line"><span class="ln">2</span><span class="cl">namespace/dev-app created
</span></span><span class="line"><span class="ln">3</span><span class="cl">deployment.apps/ubuntu-20-04 created
</span></span><span class="line"><span class="ln">4</span><span class="cl">namespace/dev-app2 created
</span></span><span class="line"><span class="ln">5</span><span class="cl">deployment.apps/ubuntu-dev-app2 created
</span></span></code></pre></div><p>How does the policy look like now?</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">andreasm@linuxvm01:~/antrea/policies/groups$ k get acnp
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">NAME                                   TIER          PRIORITY   DESIRED NODES   CURRENT NODES   AGE
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">strict-ns-isolation-except-system-ns   securityops   <span class="m">9</span>          <span class="m">1</span>               <span class="m">1</span>               6s
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="c1"># Why only one</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">andreasm@linuxvm01:~/antrea/policies/groups$ k get pods -n dev-app -owide
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">NAME                            READY   STATUS    RESTARTS   AGE   IP            NODE                                                      NOMINATED NODE   READINESS GATES
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">ubuntu-20-04-548545fc87-t2lg2   1/1     Running   <span class="m">0</span>          82s   20.20.3.216   three-zone-cluster-1-node-pool-3-6r8c2-6c8d48656c-wntwc   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">andreasm@linuxvm01:~/antrea/policies/groups$ k get pods -n dev-app2 -owide
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">NAME                               READY   STATUS    RESTARTS   AGE   IP            NODE                                                      NOMINATED NODE   READINESS GATES
</span></span><span class="line"><span class="ln">10</span><span class="cl">ubuntu-dev-app2-564f46785c-g8vb6   1/1     Running   <span class="m">0</span>          86s   20.20.3.215   three-zone-cluster-1-node-pool-3-6r8c2-6c8d48656c-wntwc   &lt;none&gt;           &lt;none&gt;
</span></span></code></pre></div><p>Both workloads ended up on same node...</p>
<p>So far so good. Now I need to verify if it is actually enforcing anything. From one of the dev-app pods I will execute into bash and try ping another pod in one for the system-namespaces, a pod in the the other dev-app namespace and try to a dns lookup.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@linuxvm01:~/antrea/policies/groups$ k <span class="nb">exec</span> -it -n dev-app ubuntu-20-04-548545fc87-t2lg2 bash
</span></span><span class="line"><span class="ln">2</span><span class="cl">kubectl <span class="nb">exec</span> <span class="o">[</span>POD<span class="o">]</span> <span class="o">[</span>COMMAND<span class="o">]</span> is DEPRECATED and will be removed in a future version. Use kubectl <span class="nb">exec</span> <span class="o">[</span>POD<span class="o">]</span> -- <span class="o">[</span>COMMAND<span class="o">]</span> instead.
</span></span><span class="line"><span class="ln">3</span><span class="cl">root@ubuntu-20-04-548545fc87-t2lg2:/# ping 20.20.1.7
</span></span><span class="line"><span class="ln">4</span><span class="cl">PING 20.20.1.7 <span class="o">(</span>20.20.1.7<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
</span></span><span class="line"><span class="ln">5</span><span class="cl">^C
</span></span><span class="line"><span class="ln">6</span><span class="cl">--- 20.20.1.7 ping statistics ---
</span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="m">170</span> packets transmitted, <span class="m">0</span> received, 100% packet loss, <span class="nb">time</span> 173033ms
</span></span></code></pre></div><p>The ping above was from my dev-app pod to the <em>coredns</em> pod in kube-system.
Ping to the other dev-app pod in the other dev-app namespace.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">root@ubuntu-20-04-548545fc87-t2lg2:/# ping 20.20.3.215
</span></span><span class="line"><span class="ln">2</span><span class="cl">PING 20.20.3.215 <span class="o">(</span>20.20.3.215<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
</span></span><span class="line"><span class="ln">3</span><span class="cl">^C
</span></span><span class="line"><span class="ln">4</span><span class="cl">--- 20.20.3.215 ping statistics ---
</span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="m">9</span> packets transmitted, <span class="m">0</span> received, 100% packet loss, <span class="nb">time</span> 8181ms
</span></span></code></pre></div><p>Is also blocked.</p>
<p>Now DNS lookup:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">root@ubuntu-20-04-548545fc87-t2lg2:/# ping google.com
</span></span><span class="line"><span class="ln">2</span><span class="cl">ping: google.com: Temporary failure in name resolution
</span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="c1">#So much empty</span>
</span></span></code></pre></div><p>DNS was also one of the requirements, so I will have to fix this also. I mean, the security admin will have to fix this otherwise going to lunch will not be such a great place to be...</p>
<p>As the security admin have applied the above policy in the securityops tier with a priority of 9 he need to open up for DNS with policies in a higher tier or within same tier with a lower priority number (lower equals higher priority).</p>
<p>This is the policy he needs to apply:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">crd.antrea.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterNetworkPolicy</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">allow-all-egress-dns-service</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">  </span><span class="nt">priority</span><span class="p">:</span><span class="w"> </span><span class="m">8</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">  </span><span class="nt">tier</span><span class="p">:</span><span class="w"> </span><span class="l">securityops</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">  </span><span class="nt">appliedTo</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    </span>- <span class="nt">namespaceSelector</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w"></span><span class="c">#        matchLabels:</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w"></span><span class="c">#          k8s-app: kube-dns</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">  </span><span class="nt">egress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">    </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Allow</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">      </span><span class="nt">toServices</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">kube-dns</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">          </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-system</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;allowdnsegress-service&#34;</span><span class="w">
</span></span></span></code></pre></div><p>A simple one, and the requirement is satisfied. Company Andreas allowed necessay functions such as DNS.. This policy will allow any namespace to reach the <em>kube-dns</em> service.</p>
<p>The rule applied:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@linuxvm01:~/antrea/policies/groups$ k get acnp
</span></span><span class="line"><span class="ln">2</span><span class="cl">NAME                                   TIER          PRIORITY   DESIRED NODES   CURRENT NODES   AGE
</span></span><span class="line"><span class="ln">3</span><span class="cl">allow-all-egress-dns-service           securityops   <span class="m">8</span>          <span class="m">4</span>               <span class="m">4</span>               2m24s
</span></span><span class="line"><span class="ln">4</span><span class="cl">strict-ns-isolation-except-system-ns   securityops   <span class="m">9</span>          <span class="m">1</span>               <span class="m">1</span>               24m
</span></span></code></pre></div><p>What about DNS lookup now:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">root@ubuntu-20-04-548545fc87-t2lg2:/# ping google.com
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">PING google.com <span class="o">(</span>172.217.12.110<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="m">64</span> bytes from 172.217.12.110 <span class="o">(</span>172.217.12.110<span class="o">)</span>: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">105</span> <span class="nv">time</span><span class="o">=</span>33.0 ms
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="m">64</span> bytes from 172.217.12.110 <span class="o">(</span>172.217.12.110<span class="o">)</span>: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">2</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">104</span> <span class="nv">time</span><span class="o">=</span>29.8 ms
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="m">64</span> bytes from 172.217.12.110 <span class="o">(</span>172.217.12.110<span class="o">)</span>: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">3</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">105</span> <span class="nv">time</span><span class="o">=</span>30.2 ms
</span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="m">64</span> bytes from 172.217.12.110 <span class="o">(</span>172.217.12.110<span class="o">)</span>: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">4</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">104</span> <span class="nv">time</span><span class="o">=</span>30.3 ms
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="m">64</span> bytes from 172.217.12.110 <span class="o">(</span>172.217.12.110<span class="o">)</span>: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">5</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">105</span> <span class="nv">time</span><span class="o">=</span>30.4 ms
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">^C
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">--- google.com ping statistics ---
</span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="m">5</span> packets transmitted, <span class="m">5</span> received, 0% packet loss, <span class="nb">time</span> 4003ms
</span></span><span class="line"><span class="ln">11</span><span class="cl">rtt min/avg/max/mdev <span class="o">=</span> 29.763/30.733/32.966/1.138 ms
</span></span></code></pre></div><p>Works.</p>
<p>Thats one more requirement met. Now one of the requirements was also to restrict access to services in other kubernetes clusters. Even though we trust that the NSX admins have created these isolation rules for us we need to make sure we are not allowed from the current kubernetes cluster also.</p>
<p>So to acheive this the security admin needs to create <em>ClusterGroup</em> containing the CIDR for its own worker nodes. Then apply a policy using the ClusterGroup.
Here is the ClusterGroup definition (containing the cidr for the worker nodes):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln">1</span><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">crd.antrea.io/v1alpha3</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterGroup</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tz-cluster-1-node-cidr</span><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="w">  </span><span class="c"># ipBlocks cannot be set along with podSelector, namespaceSelector or serviceReference.</span><span class="w">
</span></span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="w">  </span><span class="nt">ipBlocks</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">8</span><span class="cl"><span class="w">    </span>- <span class="nt">cidr</span><span class="p">:</span><span class="w"> </span><span class="m">10.101.82.32</span><span class="l">/27</span><span class="w">
</span></span></span></code></pre></div><p>And I also need to define another ClusterGroup for all the RFC1918 subnets I need to block (this will include the cidr above):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">crd.antrea.io/v1alpha3</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterGroup</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tz-cluster-1-drop-cidr</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">  </span><span class="c"># ipBlocks cannot be set along with podSelector, namespaceSelector or serviceReference.</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">  </span><span class="nt">ipBlocks</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">    </span>- <span class="nt">cidr</span><span class="p">:</span><span class="w"> </span><span class="m">10.0.0.0</span><span class="l">/8</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    </span>- <span class="nt">cidr</span><span class="p">:</span><span class="w"> </span><span class="m">172.16.0.0</span><span class="l">/12</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span>- <span class="nt">cidr</span><span class="p">:</span><span class="w"> </span><span class="m">192.168.0.0</span><span class="l">/16</span><span class="w">
</span></span></span></code></pre></div><p>Apply them:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@linuxvm01:~/antrea/policies/groups$ k apply -f tz-cluster-1-group-node-cidr.yaml
</span></span><span class="line"><span class="ln">2</span><span class="cl">clustergroup.crd.antrea.io/tz-cluster-1-node-cidr created
</span></span><span class="line"><span class="ln">3</span><span class="cl">andreasm@linuxvm01:~/antrea/policies/groups$ k apply -f tz-cluster-1-drop-cidr.yaml
</span></span><span class="line"><span class="ln">4</span><span class="cl">clustergroup.crd.antrea.io/tz-cluster-1-drop-cidr created
</span></span><span class="line"><span class="ln">5</span><span class="cl">andreasm@linuxvm01:~/antrea/policies/groups$ k get clustergroup
</span></span><span class="line"><span class="ln">6</span><span class="cl">NAME                     AGE
</span></span><span class="line"><span class="ln">7</span><span class="cl">tz-cluster-1-drop-cidr   6s
</span></span><span class="line"><span class="ln">8</span><span class="cl">tz-cluster-1-node-cidr   5s
</span></span></code></pre></div><p>And the policy to deny anything except the own kubernetes worker nodes:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">crd.antrea.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterNetworkPolicy</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">acnp-drop-except-own-cluster-node-cidr</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">  </span><span class="nt">priority</span><span class="p">:</span><span class="w"> </span><span class="m">8</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">  </span><span class="nt">tier</span><span class="p">:</span><span class="w"> </span><span class="l">securityops</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">  </span><span class="nt">appliedTo</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    </span>- <span class="nt">namespaceSelector</span><span class="p">:</span><span class="w">          </span><span class="c"># Selects all non-system Namespaces in the cluster</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">        </span><span class="nt">matchExpressions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">          </span>- {<span class="nt">key:  kubernetes.io/metadata.name, operator: NotIn, values</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="l">avi-system,default,kube-node-lease,kube-public,kube-system,secretgen-controller,tanzu-continuousdelivery-resources,tanzu-fluxcd-packageinstalls,tanzu-kustomize-controller,tanzu-source-controller,tkg-system,vmware-system-auth,vmware-system-cloud-provider,vmware-system-csi,vmware-system-tkg,vmware-system-tmc]}</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">  </span><span class="nt">egress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">    </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Allow</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">      </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">        </span>- <span class="nt">group</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;tz-cluster-1-node-cidr&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">    </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Drop</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">      </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">        </span>- <span class="nt">group</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;tz-cluster-1-drop-cidr&#34;</span><span class="w">
</span></span></span></code></pre></div><p>Applied:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@linuxvm01:~/antrea/policies/groups$ k apply -f tz-cluster-1-drop-anything-but-own-nodes.yaml
</span></span><span class="line"><span class="ln">2</span><span class="cl">clusternetworkpolicy.crd.antrea.io/acnp-drop-except-own-cluster-node-cidr created
</span></span><span class="line"><span class="ln">3</span><span class="cl">andreasm@linuxvm01:~/antrea/policies/groups$ k get acnp
</span></span><span class="line"><span class="ln">4</span><span class="cl">NAME                                     TIER          PRIORITY   DESIRED NODES   CURRENT NODES   AGE
</span></span><span class="line"><span class="ln">5</span><span class="cl">acnp-drop-except-own-cluster-node-cidr   securityops   <span class="m">8</span>          <span class="m">1</span>               <span class="m">1</span>               3m39s
</span></span><span class="line"><span class="ln">6</span><span class="cl">allow-all-egress-dns-service             securityops   <span class="m">8</span>          <span class="m">4</span>               <span class="m">4</span>               28m
</span></span><span class="line"><span class="ln">7</span><span class="cl">strict-ns-isolation-except-system-ns     securityops   <span class="m">9</span>          <span class="m">1</span>               <span class="m">1</span>               50m
</span></span></code></pre></div><p>From the dev-app pod again I will verify if I am allowed to SSH to a worker node in &quot;own&quot; Kubernetes cluster, and another Linux machine not in the ClusterGroup cidr I have applied.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">root@ubuntu-20-04-548545fc87-t2lg2:/# ssh vmware-system-user@10.101.82.34 <span class="c1">#A worker node in the current k8s cluster</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">vmware-system-user@10.101.82.34<span class="err">&#39;</span>s password:
</span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="c1">#This is allowed</span>
</span></span><span class="line"><span class="ln">4</span><span class="cl">What about other machines outside the cidr:
</span></span><span class="line"><span class="ln">5</span><span class="cl">root@ubuntu-20-04-548545fc87-t2lg2:/# ssh 10.101.10.99
</span></span><span class="line"><span class="ln">6</span><span class="cl">ssh: connect to host 10.101.10.99 port 22: Connection timed out
</span></span></code></pre></div><p>That is very close to achieving this requirement also, but I should be allowed to reach pods inside same namespace regardless of which node they reside on.
Here are my dev-app namespace with pods on all three nodes:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@linuxvm01:~/antrea/policies/groups$ k get pods -n dev-app -o wide
</span></span><span class="line"><span class="ln">2</span><span class="cl">NAME                            READY   STATUS    RESTARTS   AGE    IP            NODE                                                      NOMINATED NODE   READINESS GATES
</span></span><span class="line"><span class="ln">3</span><span class="cl">ubuntu-20-04-548545fc87-75nsm   1/1     Running   <span class="m">0</span>          116s   20.20.2.35    three-zone-cluster-1-node-pool-2-kbzvq-6846d5cc5b-6hdmj   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="ln">4</span><span class="cl">ubuntu-20-04-548545fc87-hhnv2   1/1     Running   <span class="m">0</span>          116s   20.20.1.14    three-zone-cluster-1-node-pool-1-dgcpq-656c75f4f4-nsr2r   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="ln">5</span><span class="cl">ubuntu-20-04-548545fc87-t2lg2   1/1     Running   <span class="m">0</span>          66m    20.20.3.216   three-zone-cluster-1-node-pool-3-6r8c2-6c8d48656c-wntwc   &lt;none&gt;           &lt;none&gt;
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">root@ubuntu-20-04-548545fc87-t2lg2:/# ping 20.20.1.14
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">PING 20.20.1.14 <span class="o">(</span>20.20.1.14<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="m">64</span> bytes from 20.20.1.14: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">62</span> <span class="nv">time</span><span class="o">=</span>20.6 ms
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="m">64</span> bytes from 20.20.1.14: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">2</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">62</span> <span class="nv">time</span><span class="o">=</span>2.87 ms
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">^C
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">--- 20.20.1.14 ping statistics ---
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="m">2</span> packets transmitted, <span class="m">2</span> received, 0% packet loss, <span class="nb">time</span> 1002ms
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">rtt min/avg/max/mdev <span class="o">=</span> 2.869/11.735/20.601/8.866 ms
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">root@ubuntu-20-04-548545fc87-t2lg2:/# ping 20.20.2.35
</span></span><span class="line"><span class="ln">10</span><span class="cl">PING 20.20.2.35 <span class="o">(</span>20.20.2.35<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
</span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="m">64</span> bytes from 20.20.2.35: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">62</span> <span class="nv">time</span><span class="o">=</span>3.49 ms
</span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="m">64</span> bytes from 20.20.2.35: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">2</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">62</span> <span class="nv">time</span><span class="o">=</span>2.09 ms
</span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="m">64</span> bytes from 20.20.2.35: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">3</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">62</span> <span class="nv">time</span><span class="o">=</span>1.00 ms
</span></span><span class="line"><span class="ln">14</span><span class="cl">^C
</span></span><span class="line"><span class="ln">15</span><span class="cl">--- 20.20.2.35 ping statistics ---
</span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="m">3</span> packets transmitted, <span class="m">3</span> received, 0% packet loss, <span class="nb">time</span> 2003ms
</span></span><span class="line"><span class="ln">17</span><span class="cl">rtt min/avg/max/mdev <span class="o">=</span> 1.000/2.194/3.494/1.020 ms
</span></span></code></pre></div><p>From the Antrea UI, lets do some tests there also:</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="pod2pod-same-ns"
      
        class="image_figure image_internal image_processed"
        width="1864"
        height="1964"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230629140255350.png"
      
      
    />

    </picture>
</figure>
</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="dev-app-to-mgmt-host"
      
        class="image_figure image_internal image_processed"
        width="1930"
        height="1296"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230629140345377.png"
      
      
    />

    </picture>
</figure>
</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="dev-app-to-own-node"
      
        class="image_figure image_internal image_processed"
        width="1934"
        height="1278"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230629140433183.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Note that I have not created any default-block-all-else-rule. There is always room for improvement, and this was just an excercise to show what is possible, not an final answer on how things should be done. Some of the policies can be even more granular like specifying only ports/protocol/FQDN etc..</p>
<p>So just to summarize what I have done:</p>
<p>These are the applied rules:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">NAME                                     TIER          PRIORITY   DESIRED NODES   CURRENT NODES   AGE
</span></span><span class="line"><span class="ln">2</span><span class="cl">acnp-drop-except-own-cluster-node-cidr   securityops   <span class="m">8</span>          <span class="m">3</span>               <span class="m">3</span>               23h
</span></span><span class="line"><span class="ln">3</span><span class="cl">allow-all-egress-dns-service             securityops   <span class="m">8</span>          <span class="m">4</span>               <span class="m">4</span>               23h
</span></span><span class="line"><span class="ln">4</span><span class="cl">strict-ns-isolation-except-system-ns     securityops   <span class="m">9</span>          <span class="m">3</span>               <span class="m">3</span>               23h
</span></span></code></pre></div><p>The first rule is allowing only traffic to the nodes in its own cluster - matches this requirement &quot;<em>All Kubernetes workload clusters are considered isolated and not allowed to reach nothing more than themselves, including pods and services (all nodes in the same cluster)</em>&quot;</p>
<p>The second rule is allowing all namespaces to access the <em>kube-dns</em> service in the <em>kube-system</em> namespace - matches this requirement &quot;<em>Only necessary backend functions such as DNS/NTP are allowed</em>&quot;</p>
<p>The third rule is dropping all traffic between namespaces, except the &quot;system&quot;-namespaces I have defined. But it allows intra communication inside each namespace - matches this requirement &quot;<em>All non-system namespaces should be considered &quot;untrusted&quot; and isolated by default</em>&quot;</p>
<p>Then I have not done anything with RBAC yet, will come later in this post. And the requirement: &quot;<em>Certain management tools need access to the clusters</em>&quot; I can assume the NSX admins have covered, as I am not blocking any ingress traffic to the &quot;system&quot;-namespaces, same is true for egress from the system-namespaces. But it could be, if adjusted to allow the necessary traffic from these namespaces to the certain management tools.</p>
<h2 id="applying-antrea-policies-using-tmc---tanzu-mission-control">Applying Antrea policies using TMC - Tanzu Mission Control</h2>
<p>This section will not create any new scenario, it will re-use all the policies created and applied in the above section. The biggest difference is how the policies are being applied.</p>
<p>Not that I dont think any security admin dont want to log in to a Kubernetes cluster and apply these security policies, but it can be a bit tedious each time a new cluster is applied. What wouldnt be better then if we can auto-deploy them each time a new cluster is being deployed? Like an out-of-the-box experience? Yes, excactly. If we already have defined a policy scope for the different Kubernetes cluster in our environment, we could just apply the correct policies to each cluster respectively each time they are provisioned. This saves a lot of time. We can be sure each time a new cluster is provisioned, it is being applied with the correct set of policies. With the abiltiy to auto apply these required policies on creation or directly after creation will make provisioning out-of-the-box compliant clusters a joy.</p>
<p>Now this sounds interesting, how can I do that?</p>
<p>....<em>Into the door comes TMC</em>.... Hello Tanzu Mission Control,  short TMC.
With TMC we can administer Tanzu with vSphere in addition to a lot of other Kubernetes platforms.
From the TMC official <a href="https://docs.vmware.com/en/VMware-Tanzu-Mission-Control/index.html">docs</a> :</p>
<blockquote>
<p>VMware Tanzu Mission Control™ is a centralized management platform for consistently operating and securing your Kubernetes infrastructure and modern applications across multiple teams and clouds.</p>
<p>Available through VMware Cloud™ services, Tanzu Mission Control provides operators with a single control point to give developers the independence they need to drive business forward, while ensuring consistent management and operations across environments for increased security and governance.</p>
<p>Tanzu Mission Control provides instances of the service in regions around the world, including Australia, Canada, India, Ireland, Japan, and USA. For a list of the regions in which the Tanzu Mission Control is hosted, go to the Cloud Management Services Availability page at <a href="https://www.vmware.com/global-infrastructure.html">https://www.vmware.com/global-infrastructure.html</a> and select <strong>VMware Tanzu Mission Control</strong>.</p>
<p>Use Tanzu Mission Control to manage your entire Kubernetes footprint, regardless of where your clusters reside.</p>
</blockquote>
<p>Lets cut to the chase and make my cluster compliant with the above rules.</p>
<h3 id="preparing-tmc">Preparing TMC</h3>
<p>In my TMC dashboard I need two thing in place:</p>
<ul>
<li>A Git repository where I host my yamls, specifically my Antrea policy yamls.</li>
<li>A configured Kustomization using the above Git repo</li>
</ul>
<h3 id="git-repository">Git repository</h3>
<p>I will create a dedicated Git repo called tmc-cd-repo, and a folder structure. Here is my Github repo for this purpose:

  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="github-repo"
      
        class="image_figure image_internal image_processed"
        width="1812"
        height="552"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230630124944270.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Now push the yamls to this repo's subfolder antrea-baseline-policies:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">andreasm:~/github_repos/tmc-cd-repo <span class="o">(</span>main<span class="o">)</span>$ git add .
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">andreasm:~/github_repos/tmc-cd-repo <span class="o">(</span>main<span class="o">)</span>$ git commit -s -m <span class="s2">&#34;ready-to-lockdown&#34;</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="o">[</span>main 4ab93a7<span class="o">]</span> ready-to-lockdown
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"> <span class="m">4</span> files changed, <span class="m">53</span> insertions<span class="o">(</span>+<span class="o">)</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"> create mode <span class="m">100644</span> antrea/antrea-baseline-policies/acnp-allow-egress-all-coredns-service.yaml
</span></span><span class="line"><span class="ln"> 6</span><span class="cl"> create mode <span class="m">100644</span> antrea/antrea-baseline-policies/tz-cluster-1-drop-anything-but-own-nodes.yaml
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"> create mode <span class="m">100644</span> antrea/antrea-baseline-policies/tz-cluster-1-drop-cidr.yaml
</span></span><span class="line"><span class="ln"> 8</span><span class="cl"> create mode <span class="m">100644</span> antrea/antrea-baseline-policies/tz-cluster-1-group-node-cidr.yaml
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">andreasm:~/github_repos/tmc-cd-repo <span class="o">(</span>main<span class="o">)</span>$ git push
</span></span><span class="line"><span class="ln">10</span><span class="cl">Enumerating objects: 11, <span class="k">done</span>.
</span></span><span class="line"><span class="ln">11</span><span class="cl">Counting objects: 100% <span class="o">(</span>11/11<span class="o">)</span>, <span class="k">done</span>.
</span></span><span class="line"><span class="ln">12</span><span class="cl">Delta compression using up to <span class="m">16</span> threads
</span></span><span class="line"><span class="ln">13</span><span class="cl">Compressing objects: 100% <span class="o">(</span>7/7<span class="o">)</span>, <span class="k">done</span>.
</span></span><span class="line"><span class="ln">14</span><span class="cl">Writing objects: 100% <span class="o">(</span>8/8<span class="o">)</span>, 1.43 KiB <span class="p">|</span> 733.00 KiB/s, <span class="k">done</span>.
</span></span><span class="line"><span class="ln">15</span><span class="cl">Total <span class="m">8</span> <span class="o">(</span>delta 1<span class="o">)</span>, reused <span class="m">0</span> <span class="o">(</span>delta 0<span class="o">)</span>, pack-reused <span class="m">0</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">remote: Resolving deltas: 100% <span class="o">(</span>1/1<span class="o">)</span>, <span class="k">done</span>.
</span></span><span class="line"><span class="ln">17</span><span class="cl">To github.com:andreasm80/tmc-cd-repo.git
</span></span><span class="line"><span class="ln">18</span><span class="cl">   5c9ba04..4ab93a7  main -&gt; main
</span></span><span class="line"><span class="ln">19</span><span class="cl">andreasm:~/github_repos/tmc-cd-repo <span class="o">(</span>main<span class="o">)</span>$
</span></span></code></pre></div><p>And here they are:</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="repo-updated"
      
        class="image_figure image_internal image_processed"
        width="1634"
        height="964"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230630125806028.png"
      
      
    />

    </picture>
</figure>
</p>
<h3 id="tmc-kustomization">TMC Kustomization</h3>
<p>Now in my TMC dashboard configure Git repo:</p>
<p>I can choose to add the Git repo per cluster that is managed by TMC or in a cluster group. I will go with adding the Git repo on my cluster called <em>three-zone-cluster-1</em> for the moment. The benefit with adding it at the group is that it can be shared across multiple clusters.
In TMC click Clusters and find your already managed and added cluster then click on it to &quot;enter it&quot;.</p>
<p>In your cluster group click on the tab Add-ons

  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="cluster-add-on"
      
        class="image_figure image_internal image_processed"
        width="1360"
        height="388"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230630132329611.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Then find Git repositories and Add Git Repository

  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="add-git-repo"
      
        class="image_figure image_internal image_processed"
        width="966"
        height="830"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230630132404595.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Fill in the needed fields. Make sure to expand advanced settings to update the branch to your branch or main branch. Can also adjust the sync intervall to higher or smaller. Default is 5, I have sat mine to 1. The repository url points to the actual repository, no subfolders. This is because in the Kustomization later we can have multiple pointing to the respective subfolder which can then be unique pr cluster etc. Make sure you also choose &quot;no credentials needed&quot; under Repository Credentials if using a public Git repo as I am.

  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="add-git-repo"
      
        class="image_figure image_internal image_processed"
        width="1004"
        height="1786"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230630132058076.png"
      
      
    />

    </picture>
</figure>
</p>
<p>After save you should see a green status:

  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="git-status"
      
        class="image_figure image_internal image_processed"
        width="2720"
        height="182"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230630132255751.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Now, we need to add a Kustomization. This can also be done in either a group or pr cluster. I will start with adding it directly to my specific cluster.
In TMC click Cluster and select your cluster.

  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="kustomization-cluster"
      
        class="image_figure image_internal image_processed"
        width="1784"
        height="1126"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230630131251487.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Click Add-ons, Under Continuous Delivery click Installed Kustomizations. Add Kustomization.</p>
<p>Before I add my Kustomization, I have made sure I have deleted all the policies and groups in my test-cluster three-zone-cluster-1:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@linuxvm01:~/antrea/policies/groups$ k get acnp
</span></span><span class="line"><span class="ln">2</span><span class="cl">No resources found
</span></span><span class="line"><span class="ln">3</span><span class="cl">andreasm@linuxvm01:~/antrea/policies/groups$ k get clustergroups
</span></span><span class="line"><span class="ln">4</span><span class="cl">No resources found
</span></span></code></pre></div><p>Then I will continue and add the Kustomization:</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="add-kustomization"
      
        class="image_figure image_internal image_processed"
        width="946"
        height="1162"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230630132652814.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Make sure to point to the correct subfolder in the Git repo. I have enabled the Prune option so I everything deployed via Kustomization will be deleted in my cluster if I decide to remove the Kustomization.</p>
<p>Click add.</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="added-kustomization"
      
        class="image_figure image_internal image_processed"
        width="2794"
        height="1144"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230630132840113.png"
      
      
    />

    </picture>
</figure>
</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="Succeeded"
      
        class="image_figure image_internal image_processed"
        width="2718"
        height="468"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230630132901517.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Click refresh in the top right corner, and it should be green. Lets check the policies and groups in the cluster itself..</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@linuxvm01:~/antrea/policies/groups$ k get acnp
</span></span><span class="line"><span class="ln">2</span><span class="cl">NAME                                     TIER          PRIORITY   DESIRED NODES   CURRENT NODES   AGE
</span></span><span class="line"><span class="ln">3</span><span class="cl">acnp-drop-except-own-cluster-node-cidr   securityops   <span class="m">8</span>          <span class="m">3</span>               <span class="m">3</span>               70s
</span></span><span class="line"><span class="ln">4</span><span class="cl">allow-all-egress-dns-service             securityops   <span class="m">8</span>          <span class="m">4</span>               <span class="m">4</span>               70s
</span></span><span class="line"><span class="ln">5</span><span class="cl">strict-ns-isolation-except-system-ns     securityops   <span class="m">9</span>          <span class="m">3</span>               <span class="m">3</span>               70s
</span></span><span class="line"><span class="ln">6</span><span class="cl">andreasm@linuxvm01:~/antrea/policies/groups$ k get clustergroups
</span></span><span class="line"><span class="ln">7</span><span class="cl">NAME                     AGE
</span></span><span class="line"><span class="ln">8</span><span class="cl">tz-cluster-1-drop-cidr   73s
</span></span><span class="line"><span class="ln">9</span><span class="cl">tz-cluster-1-node-cidr   73s
</span></span></code></pre></div><p>The Antrea Policies have been applied.</p>
<h3 id="deploy-tkc-cluster-from-tmc---auto-apply-security-policies">Deploy TKC cluster from TMC - auto apply security policies</h3>
<p>The above section enabled Kustomization on a already managed TKC cluster in TMC. In this section I will apply a TKC cluster from TMC and let the Antrea policies be automatically be applied.</p>
<p>In TMC I will create two Cluster Groups, one called <em>andreas-dev-clusters</em> and one called <em>andreas-prod-clusters</em>.

  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="cluster-groups"
      
        class="image_figure image_internal image_processed"
        width="928"
        height="588"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230703081050116.png"
      
      
    />

    </picture>
</figure>
</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="create-cluster-group"
      
        class="image_figure image_internal image_processed"
        width="1224"
        height="718"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230703081118640.png"
      
      
    />

    </picture>
</figure>
</p>
<p>After I have added the two cluster groups I will configure <em>Add-ons</em>. Same as in previous section, adding the the Git reop but this time I will point to the different subfolders I created in my Git repo. I have created two different sub-folders in my Git repo called: <em>tmc-cd-repo/antrea/antrea-baseline-policies/<strong>dev-clusters</strong></em>  and <em>tmc-cd-repo/antrea/antrea-baseline-policies/<strong>prod-clusters</strong></em>. The reason I have done that is because I want the option to apply different Antrea policies for certain clusters, different environments different needs.</p>
<p>Before adding the Git repo on the two new Cluster groups in TMC I need to enable continuous delivere by clicking on this blue button.

  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="enable-cd"
      
        class="image_figure image_internal image_processed"
        width="1138"
        height="892"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230703082018478.png"
      
      
    />

    </picture>
</figure>
</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="git-repo"
      
        class="image_figure image_internal image_processed"
        width="1748"
        height="1136"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230703081902496.png"
      
      
    />

    </picture>
</figure>
</p>
<p>The Git repo has been added two both my new cluster groups. Now I just need to add the Kustomization pointing to my new Git repo subfolders <strong>dev-clusters</strong> and <strong>prod-clusters</strong>.</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="prod-clusters-kustomization"
      
        class="image_figure image_internal image_processed"
        width="2160"
        height="1176"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230703114616638.png"
      
      
    />

    </picture>
</figure>
</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="dev-cluster-kustomization"
      
        class="image_figure image_internal image_processed"
        width="2110"
        height="1146"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230703114702832.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Now the preparations have been done in TMC, it is time to deploy the two TKC clusters from TMC and see if my policies are automatically applied. One &quot;prod-cluster&quot; and one &quot;dev-cluster&quot;.</p>
<p>Lets start with the &quot;prod-cluster&quot;

  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="create-prod-cluster"
      
        class="image_figure image_internal image_processed"
        width="1466"
        height="1100"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230703093235129.png"
      
      
    />

    </picture>
</figure>
</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="in-creation"
      
        class="image_figure image_internal image_processed"
        width="2860"
        height="1132"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230703093439699.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Creating the dev-cluster

  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="create-dev-cluster-2"
      
        class="image_figure image_internal image_processed"
        width="1486"
        height="1118"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230703094140344.png"
      
      
    />

    </picture>
</figure>
</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="dev-cluster-in-progress"
      
        class="image_figure image_internal image_processed"
        width="2848"
        height="450"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230703094734549.png"
      
      
    />

    </picture>
</figure>
</p>
<p>The clusters are ready:

  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="prod-cluster-2"
      
        class="image_figure image_internal image_processed"
        width="2474"
        height="66"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230703095237684.png"
      
      
    />

    </picture>
</figure>
</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="dev-cluster-2-status"
      
        class="image_figure image_internal image_processed"
        width="2464"
        height="62"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230703100106845.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Let us check the sync status of my Kustomizations.
Prod-Cluster Group:

  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="prod-group-applied"
      
        class="image_figure image_internal image_processed"
        width="2096"
        height="1164"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230703114938574.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Dev-Cluster Group:

  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="dev-group-applied"
      
        class="image_figure image_internal image_processed"
        width="2070"
        height="1150"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230703115015970.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Still applied.</p>
<p>Lets have a look inside the two TKC cluster using kubectl.
Prod-Cluster-2:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@linuxvm01:~/antrea/policies/groups$ k config current-context
</span></span><span class="line"><span class="ln">2</span><span class="cl">prod-cluster-2
</span></span><span class="line"><span class="ln">3</span><span class="cl">andreasm@linuxvm01:~/antrea/policies/groups$ k get acnp
</span></span><span class="line"><span class="ln">4</span><span class="cl">NAME                                                   TIER          PRIORITY   DESIRED NODES   CURRENT NODES   AGE
</span></span><span class="line"><span class="ln">5</span><span class="cl">allow-all-egress-dns-service                           securityops   <span class="m">8</span>          <span class="m">2</span>               <span class="m">2</span>               35m
</span></span><span class="line"><span class="ln">6</span><span class="cl">prod-clusters-acnp-drop-except-own-cluster-node-cidr   securityops   <span class="m">8</span>          <span class="m">0</span>               <span class="m">0</span>               35m
</span></span><span class="line"><span class="ln">7</span><span class="cl">prod-clusters-strict-ns-isolation-except-system-ns     securityops   <span class="m">9</span>          <span class="m">0</span>               <span class="m">0</span>               35m
</span></span></code></pre></div><p>Dev-Cluster-2:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@linuxvm01:~/antrea/policies/groups$ k config current-context
</span></span><span class="line"><span class="ln">2</span><span class="cl">dev-cluster-2
</span></span><span class="line"><span class="ln">3</span><span class="cl">andreasm@linuxvm01:~/antrea/policies/groups$ k get acnp
</span></span><span class="line"><span class="ln">4</span><span class="cl">NAME                                                  TIER          PRIORITY   DESIRED NODES   CURRENT NODES   AGE
</span></span><span class="line"><span class="ln">5</span><span class="cl">dev-clusters-strict-ns-isolation-except-system-ns     securityops   <span class="m">9</span>          <span class="m">0</span>               <span class="m">0</span>               45s
</span></span><span class="line"><span class="ln">6</span><span class="cl">dev-clusters-acnp-drop-except-own-cluster-node-cidr   securityops   <span class="m">8</span>          <span class="m">0</span>               <span class="m">0</span>               45s
</span></span><span class="line"><span class="ln">7</span><span class="cl">dev-clusters-allow-all-egress-dns-service             securityops   <span class="m">8</span>          <span class="m">2</span>               <span class="m">2</span>               45s
</span></span></code></pre></div><p>Thats it then, if I need to change the policies I can just edit policies, git add, commit and push and they will be applied to all clusters in the group.
By enabling this feature in TMC its just all about adding or attaching your clusters in the respective group in TMC and they will automatically get all the needed yamls applied.

  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="add-cluster-tmc"
      
        class="image_figure image_internal image_processed"
        width="1096"
        height="716"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230703120643394.png"
      
      
    />

    </picture>
</figure>
</p>
<h2 id="applying-antrea-policies-with-nsx">Applying Antrea policies with NSX</h2>
<p>With NSX one can also manage the native Antrea policies inside each TKC cluster (or any other Kubernetes cluster Antrea supports for that matter). I have written about this <a href="https://blog.andreasm.io/2023/06/01/managing-antrea-in-vsphere-with-tanzu/#integrating-antrea-with-nsx-t">here</a>. NSX can also create security policies &quot;outside&quot; the TKC cluster by using the inventory information it gets from Antrea and enforce them in the NSX Distributed firewall, a short section on this below.</p>
<h3 id="applying-antrea-native-policies-from-the-nsx-manager">Applying Antrea native policies from the NSX manager</h3>
<p>So in this section I will quickly go through using the same &quot;framework&quot; as above using NSX as the &quot;management-plane&quot;.
Just a reminder, we have these three policies:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">NAME                                     TIER          PRIORITY   DESIRED NODES   CURRENT NODES   AGE
</span></span><span class="line"><span class="ln">2</span><span class="cl">acnp-drop-except-own-cluster-node-cidr   securityops   <span class="m">8</span>          <span class="m">3</span>               <span class="m">3</span>               23h
</span></span><span class="line"><span class="ln">3</span><span class="cl">allow-all-egress-dns-service             securityops   <span class="m">8</span>          <span class="m">4</span>               <span class="m">4</span>               23h
</span></span><span class="line"><span class="ln">4</span><span class="cl">strict-ns-isolation-except-system-ns     securityops   <span class="m">9</span>          <span class="m">3</span>               <span class="m">3</span>               23h
</span></span></code></pre></div><p>The first rule is allowing only traffic to the nodes in its own cluster - matches this requirement &quot;<em>All Kubernetes workload clusters are considered isolated and not allowed to reach nothing more than themselves, including pods and services (all nodes in the same cluster)</em>&quot;</p>
<p>The second rule is allowing all namespaces to access the <em>kube-dns</em> service in the <em>kube-system</em> namespace - matches this requirement &quot;<em>Only necessary backend functions such as DNS/NTP are allowed</em>&quot;</p>
<p>The third rule is dropping all traffic between namespaces, except the &quot;system&quot;-namespaces I have defined. But it allows intra communication inside each namespace - matches this requirement &quot;<em>All non-system namespaces should be considered &quot;untrusted&quot; and isolated by default</em>&quot;</p>
<p>In NSX I will need to create some Security Groups, then use these groups in a Security Policy. So I will start by creating the Security Group for the concerning kube-dns service:</p>
<p>One can either define the service kube-dns:</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="sg-kube-dns"
      
        class="image_figure image_internal image_processed"
        width="2230"
        height="846"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230703124322874.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Or the pods that is responsible for the DNS service (CoreDNS:</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="dns-pods"
      
        class="image_figure image_internal image_processed"
        width="2230"
        height="982"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230703140557678.png"
      
      
    />

    </picture>
</figure>
</p>
<p>This depends on how we define the policy in NSX. I have gone with the pod selection group.</p>
<p>AS the requirement supports all services to access DNS, I dont have to create a security group for the source. Then the policy will look like this in NSX:</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="dns-policy-all"
      
        class="image_figure image_internal image_processed"
        width="3004"
        height="746"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230703140707117.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Notice also that I have placed the policy in the <em>Infrastructrue</em> Tier in NSX.</p>
<p>This is how it looks like in the Kubernetes clusters:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="l">andreasm@linuxvm01:~/antrea/policies/groups$ k get acnp 933e463e-c061-4e80-80b3-eff3402e41a9 -oyaml</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">crd.antrea.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterNetworkPolicy</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="nt">ccp-adapter.antrea.tanzu.vmware.com/display-name</span><span class="p">:</span><span class="w"> </span><span class="l">k8s-core-dns</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">  </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2023-06-27T11:15:30Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">  </span><span class="nt">generation</span><span class="p">:</span><span class="w"> </span><span class="m">11</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="nt">ccp-adapter.antrea.tanzu.vmware.com/managedBy</span><span class="p">:</span><span class="w"> </span><span class="l">ccp-adapter</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">933e463e-c061-4e80-80b3-eff3402e41a9</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">  </span><span class="nt">resourceVersion</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2248486&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">  </span><span class="nt">uid</span><span class="p">:</span><span class="w"> </span><span class="l">a5d7378d-ede0-4f8c-848b-413c10ce5602</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">  </span><span class="nt">egress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">  </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Allow</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">    </span><span class="nt">appliedTo</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">    </span>- <span class="nt">podSelector</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">    </span><span class="nt">enableLogging</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2025&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">    </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">53</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">      </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">    </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">53</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">      </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">UDP</span><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w">    </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w">    </span>- <span class="nt">group</span><span class="p">:</span><span class="w"> </span><span class="l">c7e96b35-1961-4659-8a62-688a0e98fe63</span><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w">  </span><span class="nt">priority</span><span class="p">:</span><span class="w"> </span><span class="m">1.0000000177635693</span><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">  </span><span class="nt">tier</span><span class="p">:</span><span class="w"> </span><span class="l">nsx-category-infrastructure</span><span class="w">
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w"></span><span class="nt">status</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="w">  </span><span class="nt">currentNodesRealized</span><span class="p">:</span><span class="w"> </span><span class="m">4</span><span class="w">
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="w">  </span><span class="nt">desiredNodesRealized</span><span class="p">:</span><span class="w"> </span><span class="m">4</span><span class="w">
</span></span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="w">  </span><span class="nt">observedGeneration</span><span class="p">:</span><span class="w"> </span><span class="m">11</span><span class="w">
</span></span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="w">  </span><span class="nt">phase</span><span class="p">:</span><span class="w"> </span><span class="l">Realized</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">andreasm@linuxvm01:~/antrea/policies/groups$ k get tiers
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">NAME                          PRIORITY   AGE
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">application                   <span class="m">250</span>        6d1h
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">baseline                      <span class="m">253</span>        6d1h
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">emergency                     <span class="m">50</span>         6d1h
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">networkops                    <span class="m">150</span>        6d1h
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">nsx-category-application      <span class="m">4</span>          6d
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">nsx-category-emergency        <span class="m">1</span>          6d
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">nsx-category-environment      <span class="m">3</span>          6d
</span></span><span class="line"><span class="ln">10</span><span class="cl">nsx-category-ethernet         <span class="m">0</span>          6d
</span></span><span class="line"><span class="ln">11</span><span class="cl">nsx-category-infrastructure   <span class="m">2</span>          6d
</span></span><span class="line"><span class="ln">12</span><span class="cl">platform                      <span class="m">200</span>        6d1h
</span></span><span class="line"><span class="ln">13</span><span class="cl">securityops                   <span class="m">100</span>        6d1h
</span></span></code></pre></div><p>For the next policy, allowing only node in same cluster, I will need to create two groups with &quot;ip-blocks&quot; containing all RFC1918 in one group and the actual node range in the second:

  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="all-rfc1918"
      
        class="image_figure image_internal image_processed"
        width="2228"
        height="950"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230703141115420.png"
      
      
    />

    </picture>
</figure>
</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="dev-cluster-1-cidr"
      
        class="image_figure image_internal image_processed"
        width="2206"
        height="676"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230703141312909.png"
      
      
    />

    </picture>
</figure>
</p>
<p>The policy in NSX will then look like this:

  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="own-cidr-allow"
      
        class="image_figure image_internal image_processed"
        width="2988"
        height="270"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230703145201241.png"
      
      
    />

    </picture>
</figure>
</p>
<p>This is how it looks like in the Kubernetes clusters:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">crd.antrea.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterNetworkPolicy</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="nt">ccp-adapter.antrea.tanzu.vmware.com/display-name</span><span class="p">:</span><span class="w"> </span><span class="l">dev-cluster-1-intra</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">  </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2023-07-03T12:27:13Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">  </span><span class="nt">generation</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    </span><span class="nt">ccp-adapter.antrea.tanzu.vmware.com/managedBy</span><span class="p">:</span><span class="w"> </span><span class="l">ccp-adapter</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">17dbadce-06cf-4d1e-9747-3e888f0f58e0</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">  </span><span class="nt">resourceVersion</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2257468&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">  </span><span class="nt">uid</span><span class="p">:</span><span class="w"> </span><span class="l">73814a58-2da8-44c2-ba85-2522865430d1</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">  </span><span class="nt">egress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">  </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Allow</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">    </span><span class="nt">appliedTo</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">    </span>- <span class="nt">podSelector</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">    </span><span class="nt">enableLogging</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2027&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">    </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">    </span>- <span class="nt">group</span><span class="p">:</span><span class="w"> </span><span class="l">2051f64c-8c65-46a2-8397-61c926c8c4ce</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">  </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Drop</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">    </span><span class="nt">appliedTo</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">    </span>- <span class="nt">podSelector</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">    </span><span class="nt">enableLogging</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2028&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w">    </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w">    </span>- <span class="nt">group</span><span class="p">:</span><span class="w"> </span><span class="l">5bfc16b1-08f3-48bd-91f9-fee3d66762b1</span><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">  </span><span class="nt">priority</span><span class="p">:</span><span class="w"> </span><span class="m">1.000000017763571</span><span class="w">
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w">  </span><span class="nt">tier</span><span class="p">:</span><span class="w"> </span><span class="l">nsx-category-infrastructure</span><span class="w">
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="w"></span><span class="nt">status</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="w">  </span><span class="nt">currentNodesRealized</span><span class="p">:</span><span class="w"> </span><span class="m">4</span><span class="w">
</span></span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="w">  </span><span class="nt">desiredNodesRealized</span><span class="p">:</span><span class="w"> </span><span class="m">4</span><span class="w">
</span></span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="w">  </span><span class="nt">observedGeneration</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span></span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="w">  </span><span class="nt">phase</span><span class="p">:</span><span class="w"> </span><span class="l">Realized</span><span class="w">
</span></span></span></code></pre></div><p>Where the groups contain this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">crd.antrea.io/v1alpha3</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterGroup</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="nt">ccp-adapter.antrea.tanzu.vmware.com/createdFrom</span><span class="p">:</span><span class="w"> </span><span class="l">nestdbGroupMsg</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="nt">ccp-adapter.antrea.tanzu.vmware.com/display-name</span><span class="p">:</span><span class="w"> </span><span class="l">2051f64c-8c65-46a2-8397-61c926c8c4ce</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">  </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2023-07-03T12:27:13Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">  </span><span class="nt">generation</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="nt">ccp-adapter.antrea.tanzu.vmware.com/managedBy</span><span class="p">:</span><span class="w"> </span><span class="l">ccp-adapter</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">2051f64c-8c65-46a2-8397-61c926c8c4ce</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">  </span><span class="nt">resourceVersion</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2257281&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">  </span><span class="nt">uid</span><span class="p">:</span><span class="w"> </span><span class="l">18009c1b-c44f-4c75-a9f2-8a30e2415859</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">  </span><span class="nt">childGroups</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">  </span>- <span class="l">2051f64c-8c65-46a2-8397-61c926c8c4ce-0</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w"></span><span class="nt">status</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">  </span><span class="nt">conditions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">  </span>- <span class="nt">lastTransitionTime</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2023-07-03T12:27:13Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">    </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;True&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">GroupMembersComputed</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w"></span><span class="l">andreasm@linuxvm01:~/nsx-antrea-integration$ k get clustergroup 2051f64c-8c65-46a2-8397-61c926c8c4ce-0 -oyaml</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">crd.antrea.io/v1alpha3</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterGroup</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w">    </span><span class="nt">ccp-adapter.antrea.tanzu.vmware.com/createdFrom</span><span class="p">:</span><span class="w"> </span><span class="l">nestdbGroupMsg</span><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w">    </span><span class="nt">ccp-adapter.antrea.tanzu.vmware.com/display-name</span><span class="p">:</span><span class="w"> </span><span class="l">2051f64c-8c65-46a2-8397-61c926c8c4ce-0</span><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">    </span><span class="nt">ccp-adapter.antrea.tanzu.vmware.com/parent</span><span class="p">:</span><span class="w"> </span><span class="l">2051f64c-8c65-46a2-8397-61c926c8c4ce</span><span class="w">
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w">  </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2023-07-03T12:27:13Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="w">  </span><span class="nt">generation</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="w">    </span><span class="nt">ccp-adapter.antrea.tanzu.vmware.com/managedBy</span><span class="p">:</span><span class="w"> </span><span class="l">ccp-adapter</span><span class="w">
</span></span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">2051f64c-8c65-46a2-8397-61c926c8c4ce-0</span><span class="w">
</span></span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="w">  </span><span class="nt">resourceVersion</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2257278&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">36</span><span class="cl"><span class="w">  </span><span class="nt">uid</span><span class="p">:</span><span class="w"> </span><span class="l">b1d4a59b-0557-4f6c-a08c-7b76af6bca8c</span><span class="w">
</span></span></span><span class="line"><span class="ln">37</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">38</span><span class="cl"><span class="w">  </span><span class="nt">ipBlocks</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">39</span><span class="cl"><span class="w">  </span>- <span class="nt">cidr</span><span class="p">:</span><span class="w"> </span><span class="m">10.101.84.32</span><span class="l">/27</span><span class="w">
</span></span></span><span class="line"><span class="ln">40</span><span class="cl"><span class="w"></span><span class="nt">status</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">41</span><span class="cl"><span class="w">  </span><span class="nt">conditions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">42</span><span class="cl"><span class="w">  </span>- <span class="nt">lastTransitionTime</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2023-07-03T12:27:13Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">43</span><span class="cl"><span class="w">    </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;True&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">44</span><span class="cl"><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">GroupMembersComputed</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="l">andreasm@linuxvm01:~/nsx-antrea-integration$ k get clustergroup 5bfc16b1-08f3-48bd-91f9-fee3d66762b1 -oyaml</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">crd.antrea.io/v1alpha3</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterGroup</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="nt">ccp-adapter.antrea.tanzu.vmware.com/createdFrom</span><span class="p">:</span><span class="w"> </span><span class="l">nestdbGroupMsg</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">    </span><span class="nt">ccp-adapter.antrea.tanzu.vmware.com/display-name</span><span class="p">:</span><span class="w"> </span><span class="l">5bfc16b1-08f3-48bd-91f9-fee3d66762b1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">  </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2023-07-03T12:27:13Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">  </span><span class="nt">generation</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">    </span><span class="nt">ccp-adapter.antrea.tanzu.vmware.com/managedBy</span><span class="p">:</span><span class="w"> </span><span class="l">ccp-adapter</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">5bfc16b1-08f3-48bd-91f9-fee3d66762b1</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">  </span><span class="nt">resourceVersion</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2257282&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">  </span><span class="nt">uid</span><span class="p">:</span><span class="w"> </span><span class="m">6782589e-8488</span>-<span class="l">47df-a750-04432c3c2f18</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">  </span><span class="nt">childGroups</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">  </span>- <span class="l">5bfc16b1-08f3-48bd-91f9-fee3d66762b1-0</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w"></span><span class="nt">status</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">  </span><span class="nt">conditions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">  </span>- <span class="nt">lastTransitionTime</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2023-07-03T12:27:13Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">    </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;True&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">GroupMembersComputed</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w"></span><span class="l">andreasm@linuxvm01:~/nsx-antrea-integration$ k get clustergroup 5bfc16b1-08f3-48bd-91f9-fee3d66762b1-0 -oyaml</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">crd.antrea.io/v1alpha3</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterGroup</span><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w">    </span><span class="nt">ccp-adapter.antrea.tanzu.vmware.com/createdFrom</span><span class="p">:</span><span class="w"> </span><span class="l">nestdbGroupMsg</span><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">    </span><span class="nt">ccp-adapter.antrea.tanzu.vmware.com/display-name</span><span class="p">:</span><span class="w"> </span><span class="l">5bfc16b1-08f3-48bd-91f9-fee3d66762b1-0</span><span class="w">
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w">    </span><span class="nt">ccp-adapter.antrea.tanzu.vmware.com/parent</span><span class="p">:</span><span class="w"> </span><span class="l">5bfc16b1-08f3-48bd-91f9-fee3d66762b1</span><span class="w">
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="w">  </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2023-07-03T12:27:13Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="w">  </span><span class="nt">generation</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="w">    </span><span class="nt">ccp-adapter.antrea.tanzu.vmware.com/managedBy</span><span class="p">:</span><span class="w"> </span><span class="l">ccp-adapter</span><span class="w">
</span></span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">5bfc16b1-08f3-48bd-91f9-fee3d66762b1-0</span><span class="w">
</span></span></span><span class="line"><span class="ln">36</span><span class="cl"><span class="w">  </span><span class="nt">resourceVersion</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2257277&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">37</span><span class="cl"><span class="w">  </span><span class="nt">uid</span><span class="p">:</span><span class="w"> </span><span class="l">fd2a1c32-1cf8-4ca8-8dad-f5420f57e55c</span><span class="w">
</span></span></span><span class="line"><span class="ln">38</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">39</span><span class="cl"><span class="w">  </span><span class="nt">ipBlocks</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">40</span><span class="cl"><span class="w">  </span>- <span class="nt">cidr</span><span class="p">:</span><span class="w"> </span><span class="m">192.168.0.0</span><span class="l">/16</span><span class="w">
</span></span></span><span class="line"><span class="ln">41</span><span class="cl"><span class="w">  </span>- <span class="nt">cidr</span><span class="p">:</span><span class="w"> </span><span class="m">10.0.0.0</span><span class="l">/8</span><span class="w">
</span></span></span><span class="line"><span class="ln">42</span><span class="cl"><span class="w">  </span>- <span class="nt">cidr</span><span class="p">:</span><span class="w"> </span><span class="m">172.16.0.0</span><span class="l">/12</span><span class="w">
</span></span></span><span class="line"><span class="ln">43</span><span class="cl"><span class="w"></span><span class="nt">status</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">44</span><span class="cl"><span class="w">  </span><span class="nt">conditions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">45</span><span class="cl"><span class="w">  </span>- <span class="nt">lastTransitionTime</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2023-07-03T12:27:13Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">46</span><span class="cl"><span class="w">    </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;True&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">47</span><span class="cl"><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">GroupMembersComputed</span><span class="w">
</span></span></span></code></pre></div><p>Now the last rule is blocking all non-system namespaces to any other namespace than themselves.</p>
<p>First I need to create a Security Group with the namespace as sole member, then a Security Group with the criteria not-equals.
Group for the namespace:

  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="ns-dev-app"
      
        class="image_figure image_internal image_processed"
        width="2216"
        height="822"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230703152404669.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Negated Security Group, selecting all pods which does not have the same label as any pods in the namespace &quot;dev-app&quot;.

  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="negated"
      
        class="image_figure image_internal image_processed"
        width="2238"
        height="904"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230703152546054.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Then the Security Policy looks like this:

  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="policy-strict-ns"
      
        class="image_figure image_internal image_processed"
        width="3006"
        height="788"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230703152659459.png"
      
      
    />

    </picture>
</figure>
</p>
<p>This is how it looks like in the Kubernetes clusters:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">crd.antrea.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterNetworkPolicy</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="nt">ccp-adapter.antrea.tanzu.vmware.com/display-name</span><span class="p">:</span><span class="w"> </span><span class="l">dev-cluster-strict-ns-islolation</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">  </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2023-07-03T13:00:40Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">  </span><span class="nt">generation</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    </span><span class="nt">ccp-adapter.antrea.tanzu.vmware.com/managedBy</span><span class="p">:</span><span class="w"> </span><span class="l">ccp-adapter</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cfbe3754-c365-4697-b124-5fbaddd87b57</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">  </span><span class="nt">resourceVersion</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2267847&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">  </span><span class="nt">uid</span><span class="p">:</span><span class="w"> </span><span class="m">47949441</span>-<span class="l">a69b-47e5-ae9b-1d5760d5c195</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">  </span><span class="nt">egress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">  </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Allow</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">    </span><span class="nt">appliedTo</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">    </span>- <span class="nt">group</span><span class="p">:</span><span class="w"> </span><span class="l">beed7011-4fc7-49e6-b7ed-d521095eb293</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">    </span><span class="nt">enableLogging</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2029&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">    </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">    </span>- <span class="nt">group</span><span class="p">:</span><span class="w"> </span><span class="l">beed7011-4fc7-49e6-b7ed-d521095eb293</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">  </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Drop</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">    </span><span class="nt">appliedTo</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">    </span>- <span class="nt">group</span><span class="p">:</span><span class="w"> </span><span class="l">beed7011-4fc7-49e6-b7ed-d521095eb293</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">    </span><span class="nt">enableLogging</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2030&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w">    </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w">    </span>- <span class="nt">group</span><span class="p">:</span><span class="w"> </span><span class="l">f240efd5-3a95-49d3-9252-058cc80bc0c0</span><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">  </span><span class="nt">priority</span><span class="p">:</span><span class="w"> </span><span class="m">1.0000000177635728</span><span class="w">
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w">  </span><span class="nt">tier</span><span class="p">:</span><span class="w"> </span><span class="l">nsx-category-infrastructure</span><span class="w">
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="w"></span><span class="nt">status</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="w">  </span><span class="nt">currentNodesRealized</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span></span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="w">  </span><span class="nt">desiredNodesRealized</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span></span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="w">  </span><span class="nt">observedGeneration</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span></span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="w">  </span><span class="nt">phase</span><span class="p">:</span><span class="w"> </span><span class="l">Realized</span><span class="w">
</span></span></span></code></pre></div><p>Where the cluster groups look like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="l">andreasm@linuxvm01:~/nsx-antrea-integration$ k get clustergroup beed7011-4fc7-49e6-b7ed-d521095eb293 -oyaml</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">crd.antrea.io/v1alpha3</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterGroup</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="nt">ccp-adapter.antrea.tanzu.vmware.com/createdFrom</span><span class="p">:</span><span class="w"> </span><span class="l">nestdbGroupMsg</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">    </span><span class="nt">ccp-adapter.antrea.tanzu.vmware.com/display-name</span><span class="p">:</span><span class="w"> </span><span class="l">beed7011-4fc7-49e6-b7ed-d521095eb293</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">  </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2023-07-03T13:00:40Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">  </span><span class="nt">generation</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">    </span><span class="nt">ccp-adapter.antrea.tanzu.vmware.com/managedBy</span><span class="p">:</span><span class="w"> </span><span class="l">ccp-adapter</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">beed7011-4fc7-49e6-b7ed-d521095eb293</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">  </span><span class="nt">resourceVersion</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2266125&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">  </span><span class="nt">uid</span><span class="p">:</span><span class="w"> </span><span class="l">7bf8d0f4-d719-47d5-98a9-5fba3b5da7b9</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">  </span><span class="nt">childGroups</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">  </span>- <span class="l">beed7011-4fc7-49e6-b7ed-d521095eb293-0</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w"></span><span class="nt">status</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">  </span><span class="nt">conditions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">  </span>- <span class="nt">lastTransitionTime</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2023-07-03T13:00:41Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">    </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;True&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">GroupMembersComputed</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w"></span><span class="l">andreasm@linuxvm01:~/nsx-antrea-integration$ k get clustergroup beed7011-4fc7-49e6-b7ed-d521095eb293-0 -oyaml</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">crd.antrea.io/v1alpha3</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterGroup</span><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w">    </span><span class="nt">ccp-adapter.antrea.tanzu.vmware.com/createdFrom</span><span class="p">:</span><span class="w"> </span><span class="l">nestdbGroupMsg</span><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">    </span><span class="nt">ccp-adapter.antrea.tanzu.vmware.com/display-name</span><span class="p">:</span><span class="w"> </span><span class="l">beed7011-4fc7-49e6-b7ed-d521095eb293-0</span><span class="w">
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w">    </span><span class="nt">ccp-adapter.antrea.tanzu.vmware.com/parent</span><span class="p">:</span><span class="w"> </span><span class="l">beed7011-4fc7-49e6-b7ed-d521095eb293</span><span class="w">
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="w">  </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2023-07-03T13:00:40Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="w">  </span><span class="nt">generation</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="w">    </span><span class="nt">ccp-adapter.antrea.tanzu.vmware.com/managedBy</span><span class="p">:</span><span class="w"> </span><span class="l">ccp-adapter</span><span class="w">
</span></span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">beed7011-4fc7-49e6-b7ed-d521095eb293-0</span><span class="w">
</span></span></span><span class="line"><span class="ln">36</span><span class="cl"><span class="w">  </span><span class="nt">resourceVersion</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2266123&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">37</span><span class="cl"><span class="w">  </span><span class="nt">uid</span><span class="p">:</span><span class="w"> </span><span class="l">4b393674-981a-488c-a2e2-d794f0b0a312</span><span class="w">
</span></span></span><span class="line"><span class="ln">38</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">39</span><span class="cl"><span class="w">  </span><span class="nt">namespaceSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">40</span><span class="cl"><span class="w">    </span><span class="nt">matchExpressions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">41</span><span class="cl"><span class="w">    </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes.io/metadata.name</span><span class="w">
</span></span></span><span class="line"><span class="ln">42</span><span class="cl"><span class="w">      </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l">In</span><span class="w">
</span></span></span><span class="line"><span class="ln">43</span><span class="cl"><span class="w">      </span><span class="nt">values</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">44</span><span class="cl"><span class="w">      </span>- <span class="l">dev-app</span><span class="w">
</span></span></span><span class="line"><span class="ln">45</span><span class="cl"><span class="w"></span><span class="nt">status</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">46</span><span class="cl"><span class="w">  </span><span class="nt">conditions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">47</span><span class="cl"><span class="w">  </span>- <span class="nt">lastTransitionTime</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2023-07-03T13:00:41Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">48</span><span class="cl"><span class="w">    </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;True&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">49</span><span class="cl"><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">GroupMembersComputed</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="l">andreasm@linuxvm01:~/nsx-antrea-integration$ k get clustergroup f240efd5-3a95-49d3-9252-058cc80bc0c0 -oyaml</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">crd.antrea.io/v1alpha3</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterGroup</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="nt">ccp-adapter.antrea.tanzu.vmware.com/createdFrom</span><span class="p">:</span><span class="w"> </span><span class="l">nestdbGroupMsg</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">    </span><span class="nt">ccp-adapter.antrea.tanzu.vmware.com/display-name</span><span class="p">:</span><span class="w"> </span><span class="l">f240efd5-3a95-49d3-9252-058cc80bc0c0</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">  </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2023-07-03T13:06:59Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">  </span><span class="nt">generation</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">    </span><span class="nt">ccp-adapter.antrea.tanzu.vmware.com/managedBy</span><span class="p">:</span><span class="w"> </span><span class="l">ccp-adapter</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">f240efd5-3a95-49d3-9252-058cc80bc0c0</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">  </span><span class="nt">resourceVersion</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2267842&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">  </span><span class="nt">uid</span><span class="p">:</span><span class="w"> </span><span class="l">cacd1386-a434-4c42-8739-6813dd1d475b</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">  </span><span class="nt">childGroups</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">  </span>- <span class="l">f240efd5-3a95-49d3-9252-058cc80bc0c0-0</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w"></span><span class="nt">status</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">  </span><span class="nt">conditions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">  </span>- <span class="nt">lastTransitionTime</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2023-07-03T13:07:00Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">    </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;True&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">GroupMembersComputed</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w"></span><span class="l">andreasm@linuxvm01:~/nsx-antrea-integration$ k get clustergroup f240efd5-3a95-49d3-9252-058cc80bc0c0-0 -oyaml</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">crd.antrea.io/v1alpha3</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterGroup</span><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w">    </span><span class="nt">ccp-adapter.antrea.tanzu.vmware.com/createdFrom</span><span class="p">:</span><span class="w"> </span><span class="l">nestdbGroupMsg</span><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">    </span><span class="nt">ccp-adapter.antrea.tanzu.vmware.com/display-name</span><span class="p">:</span><span class="w"> </span><span class="l">f240efd5-3a95-49d3-9252-058cc80bc0c0-0</span><span class="w">
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w">    </span><span class="nt">ccp-adapter.antrea.tanzu.vmware.com/parent</span><span class="p">:</span><span class="w"> </span><span class="l">f240efd5-3a95-49d3-9252-058cc80bc0c0</span><span class="w">
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="w">  </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2023-07-03T13:06:59Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="w">  </span><span class="nt">generation</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span></span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="w">    </span><span class="nt">ccp-adapter.antrea.tanzu.vmware.com/managedBy</span><span class="p">:</span><span class="w"> </span><span class="l">ccp-adapter</span><span class="w">
</span></span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">f240efd5-3a95-49d3-9252-058cc80bc0c0-0</span><span class="w">
</span></span></span><span class="line"><span class="ln">36</span><span class="cl"><span class="w">  </span><span class="nt">resourceVersion</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2269597&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">37</span><span class="cl"><span class="w">  </span><span class="nt">uid</span><span class="p">:</span><span class="w"> </span><span class="l">bd7f4526-2be9-4a4e-860e-0bb85ea30516</span><span class="w">
</span></span></span><span class="line"><span class="ln">38</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">39</span><span class="cl"><span class="w">  </span><span class="nt">podSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">40</span><span class="cl"><span class="w">    </span><span class="nt">matchExpressions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">41</span><span class="cl"><span class="w">    </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">app</span><span class="w">
</span></span></span><span class="line"><span class="ln">42</span><span class="cl"><span class="w">      </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l">NotIn</span><span class="w">
</span></span></span><span class="line"><span class="ln">43</span><span class="cl"><span class="w">      </span><span class="nt">values</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">44</span><span class="cl"><span class="w">      </span>- <span class="l">ubuntu-20-04</span><span class="w">
</span></span></span><span class="line"><span class="ln">45</span><span class="cl"><span class="w"></span><span class="nt">status</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">46</span><span class="cl"><span class="w">  </span><span class="nt">conditions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">47</span><span class="cl"><span class="w">  </span>- <span class="nt">lastTransitionTime</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2023-07-03T13:07:00Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">48</span><span class="cl"><span class="w">    </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;True&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">49</span><span class="cl"><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">GroupMembersComputed</span><span class="w">
</span></span></span></code></pre></div><p>With all three policies applied, they look like this in the TKC cluster:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@linuxvm01:~/antrea/policies/groups$ k get acnp
</span></span><span class="line"><span class="ln">2</span><span class="cl">NAME                                   TIER                          PRIORITY             DESIRED NODES   CURRENT NODES   AGE
</span></span><span class="line"><span class="ln">3</span><span class="cl">17dbadce-06cf-4d1e-9747-3e888f0f58e0   nsx-category-infrastructure   1.000000017763571    <span class="m">4</span>               <span class="m">4</span>               18h
</span></span><span class="line"><span class="ln">4</span><span class="cl">933e463e-c061-4e80-80b3-eff3402e41a9   nsx-category-infrastructure   1.0000000177635702   <span class="m">4</span>               <span class="m">4</span>               18h
</span></span><span class="line"><span class="ln">5</span><span class="cl">cfbe3754-c365-4697-b124-5fbaddd87b57   nsx-category-infrastructure   1.0000000177635728   <span class="m">3</span>               <span class="m">3</span>               17h
</span></span></code></pre></div><p>By using NSX managing the Antrea policies there is also a very easy way to verify if the policies are working or not by using the Traffic Analysis tool in NSX:

  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="nsx-traffic-analysis"
      
        class="image_figure image_internal image_processed"
        width="3052"
        height="1426"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230703153342301.png"
      
      
    />

    </picture>
</figure>
</p>
<p>This tools will also inform you of any policies applied by using kubectl inside the cluster, in other words it can also show you policies not created or applied from the NSX manager.</p>
<p>I have applied a Antrea Policy directly in the TKC cluster using kubectl called <em>block-ns-app3-app4</em>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">andreasm@linuxvm01:~/antrea/policies/groups$ k get acnp
</span></span><span class="line"><span class="ln">2</span><span class="cl">NAME                                   TIER                          PRIORITY             DESIRED NODES   CURRENT NODES   AGE
</span></span><span class="line"><span class="ln">3</span><span class="cl">17dbadce-06cf-4d1e-9747-3e888f0f58e0   nsx-category-infrastructure   1.000000017763571    <span class="m">4</span>               <span class="m">4</span>               20h
</span></span><span class="line"><span class="ln">4</span><span class="cl">933e463e-c061-4e80-80b3-eff3402e41a9   nsx-category-infrastructure   1.0000000177635702   <span class="m">4</span>               <span class="m">4</span>               20h
</span></span><span class="line"><span class="ln">5</span><span class="cl">block-ns-app3-app4   <span class="c1">#this             securityops                   4                    1               1               3s</span>
</span></span><span class="line"><span class="ln">6</span><span class="cl">cfbe3754-c365-4697-b124-5fbaddd87b57   nsx-category-infrastructure   1.0000000177635728   <span class="m">3</span>               <span class="m">3</span>               20h
</span></span></code></pre></div><p>If I do a traceroute from within NSX from a pod in ns Dev-App3 to a pod in ns Dev-App4 and hit this rule, the NSX manager will show me this:

  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="traceflow"
      
        class="image_figure image_internal image_processed"
        width="2112"
        height="684"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230704110828663.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Its clearly doing its job and blocking the traffic, but which rule is it?
Click on EgressMetric, copy the rule id and paste it in the search field in NSX:

  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="policy-id"
      
        class="image_figure image_internal image_processed"
        width="2620"
        height="924"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230704110937455.png"
      
      
    />

    </picture>
</figure>
</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="search"
      
        class="image_figure image_internal image_processed"
        width="1820"
        height="830"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230704111008480.png"
      
      
    />

    </picture>
</figure>
</p>
<h3 id="applying-kubernetes-related-policies-using-inventory-information-from-antrea">Applying Kubernetes related policies using inventory information from Antrea</h3>
<p>As mentioned above, NSX can also utilize the information from TKC cluster (or any Kubernetes cluster that uses Antrea) to enforce them in the Distributed firewall. The information NSX is currently:</p>
<ul>
<li>Kubernetes Cluster - Used to create security group containing Kubernetes clusters by name, not used alone but in combination with the below -&gt;</li>
<li>Kubernetes Namespace - Used to create security group containing Kubernetes clusters namespace by name or tag, not used alone but in combination from a Kubernetes cluster defined above.</li>
<li>Kubernetes Service - Used to create security group containing Kubernetes Services  by name or tag, not used alone but in combination with any of the above -&gt;</li>
<li>Kubernetes Ingress - Used to create security group containing Kubernetes Ingresses by name or tag, not used alone but in combination with any of the above Kubernetes Cluster or Kubernetes Namespace.</li>
<li>Antrea Egress - Used to create security group containing Antrea Egress IP in use by name or tag, not used alone but in combination with only Kubernetes Cluster.</li>
<li>Antrea IP Pool - Used to create security group containing Antrea Egress IP Pool by name or tag, not used alone but in combination with only Kubernetes Cluster.</li>
<li>Kubernetes Node - Used to create security group containing Kubernetes Node IPs or POD CIDRs by node IP address or POD CIDR, not used alone but in combination with only Kubernetes Cluster.</li>
<li>Kubernetes Gateway - Used to create security group containing Kubernetes Gateways by name or tag, not used alone but in combination with only Kubernetes Cluster.</li>
</ul>
<p>An example of a Security group in NSX using the contexts above, Kubernetes Cluster with name <em>dev-cluster</em> and Kubernetes Node IP address:

  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="kubernetes-cluster-nodes"
      
        class="image_figure image_internal image_processed"
        width="1678"
        height="824"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230704114000685.png"
      
      
    />

    </picture>
</figure>
</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="kubernets-nodes-dev-cluster-1"
      
        class="image_figure image_internal image_processed"
        width="2240"
        height="1472"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230704114033192.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Now, if I want to create a NSX firewall policy isolating two Kubernetes clusters from each other using the constructs above:</p>
<p>I will simply create two security groups like the one above, selection the two different cluster in each group. Then the policy will be like this:</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="policy-blocking-dev1-to-dev2"
      
        class="image_figure image_internal image_processed"
        width="2990"
        height="184"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230704115441922.png"
      
      
    />

    </picture>
</figure>
</p>
<p>Now if I do a traceflow from any node in dev-cluster-1 to any node in dev-cluster-2 it will dropped.</p>
<p>
  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="traceflow-dev-1-dev-2"
      
        class="image_figure image_internal image_processed"
        width="3012"
        height="1646"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230704115342329.png"
      
      
    />

    </picture>
</figure>
</p>
<p>The Firewall Rule ID is:

  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="drop-rule"
      
        class="image_figure image_internal image_processed"
        width="3038"
        height="860"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230704115625261.png"
      
      
    />

    </picture>
</figure>
</p>
<p>With this approach, its very easy to isolate complete clusters from each other with some really simple rules. We could even create a negated rule, saying you are allowed to reach any workers from same cluster but nothing else with one blocking rule (using a negated selection where source is dev-cluster-1 and destination is also dev-cluster-1:

  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="destination-same-source"
      
        class="image_figure image_internal image_processed"
        width="2250"
        height="792"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230704120342084.png"
      
      
    />

    </picture>
</figure>
</p>
<p>The policy:

  <figure>
  <picture>

    
      
        
        
        
        
        
        
    <img
      loading="lazy"
      decoding="async"
      alt="negated"
      
        class="image_figure image_internal image_processed"
        width="2986"
        height="174"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230704120437282.png"
      
      
    />

    </picture>
</figure>
</p>
<p>This is just one rule blocing everything except its own Kubernetes nodes.</p>
<h2 id="rbac---making-sure-no-one-can-overwriteoverride-existing-rules">RBAC - making sure no one can overwrite/override existing rules.</h2>
<p>How to manage RBAC, or Tier Entitlement with Antrea I have already covered <a href="https://blog.andreasm.io/2023/06/01/managing-antrea-in-vsphere-with-tanzu/#antrea-rbac">here</a></p>
<h2 id="outro">Outro...</h2>
<p>I have in this post shown three different ways to manage and apply Antrea Network policies. Three different approaches, the first approach was all manual, the second automatic but the policies still needs to be defined. The last one with the NSX manager a bit different approach as not all the Antrea Network policy features are available and some policies have to be defined different. But, the NSX manager can also be used to automate some of the policies by just adding the clusters to existing policies. Then they will be applied at once.</p>
<p>The Antrea policies used and how they are defined in this post is by all means not the final answer or best practice. They were just used as simple examples to have something to &quot;work with&quot; during this post. As I have mentioned, one could utilise the different tiers to delegate administration of the policies to the right set of responsibilities (security admins, vSphere operators, Dev-ops etc). If the target is zero-trust also inside your TKC clusters, this can be achieved by utilizing the tiers and place a drop-all-else rule dead last in the Antrea policy chain (baseline tier e.g).</p>

    </div>




  </article>
<aside class="sidebar">
  <section class="sidebar_inner">
    <br>
    
  
  <div class="search">
    <input type="search" class="search_field form_field" placeholder='Search...' id="find" autocomplete="off" data-scope='post'>
    <label for="find" class="search_label"><svg class="icon">
  <title>search</title>
  <use xlink:href="#search"></use>
</svg>

    </label>
    
    <div class="search_results results"></div>
  </div>

        <h2>Hi there</h2>
      <div class="author_bio">
        This is Andreas Marqvardsen's blog, a Lead Solution Engineer at VMware by Broadcom. This blog focuses on Kubernetes, Kubernetes infrastructure such as networking and security and stuff he finds interesting.
      </div>
      <a href='https://blog.andreasm.io/about/' class="button mt-1" role="button" title='Read More'>Read More</a>

    
    
    <h2 class="mt-4">Recent Posts</h2>
    <ul class="flex-column">
      <li>
        <a href="https://blog.andreasm.io/2024/04/08/vsphere-with-tanzu-avi-and-multiple-supervisors/" class="nav-link" title="vSphere with Tanzu - Avi and Multiple Supervisors">vSphere with Tanzu - Avi and Multiple Supervisors</a>
      </li>
      <li>
        <a href="https://blog.andreasm.io/2024/02/04/argo-cd-vsphere-with-tanzu/" class="nav-link" title="Argo CD &amp; vSphere with Tanzu">Argo CD &amp; vSphere with Tanzu</a>
      </li>
      <li>
        <a href="https://blog.andreasm.io/2024/01/15/proxmox-with-opentofu-kubespray-and-kubernetes/" class="nav-link" title="Proxmox with OpenTofu Kubespray and Kubernetes">Proxmox with OpenTofu Kubespray and Kubernetes</a>
      </li>
      <li>
        <a href="https://blog.andreasm.io/2023/12/26/traefik-proxy-in-kubernetes/" class="nav-link" title="Traefik Proxy in Kubernetes">Traefik Proxy in Kubernetes</a>
      </li>
      <li>
        <a href="https://blog.andreasm.io/2023/12/18/a-quick-glance-at-cilium-cni/" class="nav-link" title="A Quick Glance at Cilium CNI">A Quick Glance at Cilium CNI</a>
      </li>
      <li>
        <a href="https://blog.andreasm.io/2023/11/23/tkgi-with-nsx-and-nsx-advanced-loadbalancer/" class="nav-link" title="TKGi with NSX and NSX Advanced LoadBalancer">TKGi with NSX and NSX Advanced LoadBalancer</a>
      </li>
      <li>
        <a href="https://blog.andreasm.io/2023/09/25/antrea-multi-cluster-in-tkg-and-vsphere-with-tanzu/" class="nav-link" title="Antrea Multi-cluster - in TKG and vSphere with Tanzu">Antrea Multi-cluster - in TKG and vSphere with Tanzu</a>
      </li>
      <li>
        <a href="https://blog.andreasm.io/2023/09/23/vsphere-with-tanzu-8-u2-using-nsx-and-nsx-advanced-loadbalancer/" class="nav-link" title="vSphere with Tanzu 8 U2 using NSX AND NSX Advanced Loadbalancer">vSphere with Tanzu 8 U2 using NSX AND NSX Advanced Loadbalancer</a>
      </li>
    </ul>
    <div>
      <h2 class="mt-4 taxonomy" id="categories-section">Categories</h2>
      <nav class="tags_nav">
        <a href='https://blog.andreasm.io/categories/kubernetes/' class="post_tag button button_translucent" title="kubernetes">
          KUBERNETES
          <span class="button_tally">39</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/networking/' class="post_tag button button_translucent" title="networking">
          NETWORKING
          <span class="button_tally">20</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/tanzu/' class="post_tag button button_translucent" title="tanzu">
          TANZU
          <span class="button_tally">13</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/loadbalancing/' class="post_tag button button_translucent" title="loadbalancing">
          LOADBALANCING
          <span class="button_tally">9</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/cni/' class="post_tag button button_translucent" title="cni">
          CNI
          <span class="button_tally">8</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/avi/' class="post_tag button button_translucent" title="avi">
          AVI
          <span class="button_tally">6</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/security/' class="post_tag button button_translucent" title="security">
          SECURITY
          <span class="button_tally">6</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/nsx/' class="post_tag button button_translucent" title="nsx">
          NSX
          <span class="button_tally">5</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/antrea/' class="post_tag button button_translucent" title="antrea">
          ANTREA
          <span class="button_tally">3</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/automation/' class="post_tag button button_translucent" title="automation">
          AUTOMATION
          <span class="button_tally">2</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/blog/' class="post_tag button button_translucent" title="blog">
          BLOG
          <span class="button_tally">2</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/network/' class="post_tag button button_translucent" title="network">
          NETWORK
          <span class="button_tally">2</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/vmware-nsx/' class="post_tag button button_translucent" title="vmware-nsx">
          VMWARE-NSX
          <span class="button_tally">2</span>
        </a>
        
        <a href='https://blog.andreasm.io/categories/argocd/' class="post_tag button button_translucent" title="argocd">
          ARGOCD
          <span class="button_tally">1</span>
        </a>
        
        
        <br>
        <div class="post_tags_toggle button">All Categories</div>
        <div class="post_tags">
          <div class="tags_list">
            
            <a href='https://blog.andreasm.io/categories/antrea/' class=" post_tag button button_translucent" data-position=3 title="antrea">ANTREA<span class="button_tally">3</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/argocd/' class=" post_tag button button_translucent" data-position=1 title="argocd">ARGOCD<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/automation/' class=" post_tag button button_translucent" data-position=2 title="automation">AUTOMATION<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/autoscaling/' class=" post_tag button button_translucent" data-position=1 title="autoscaling">AUTOSCALING<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/avi/' class=" post_tag button button_translucent" data-position=6 title="avi">AVI<span class="button_tally">6</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/blog/' class=" post_tag button button_translucent" data-position=2 title="blog">BLOG<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/certificate/' class=" post_tag button button_translucent" data-position=1 title="certificate">CERTIFICATE<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/cni/' class=" post_tag button button_translucent" data-position=8 title="cni">CNI<span class="button_tally">8</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/docker/' class=" post_tag button button_translucent" data-position=1 title="docker">DOCKER<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/ebpf/' class=" post_tag button button_translucent" data-position=1 title="ebpf">EBPF<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/github/' class=" post_tag button button_translucent" data-position=1 title="github">GITHUB<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/gitops/' class=" post_tag button button_translucent" data-position=1 title="gitops">GITOPS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/harbor/' class=" post_tag button button_translucent" data-position=1 title="harbor">HARBOR<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/helm/' class=" post_tag button button_translucent" data-position=1 title="helm">HELM<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/home-automation/' class=" post_tag button button_translucent" data-position=1 title="home-automation">HOME-AUTOMATION<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/hugo/' class=" post_tag button button_translucent" data-position=1 title="hugo">HUGO<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/ingress/' class=" post_tag button button_translucent" data-position=1 title="ingress">INGRESS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/kubernetes/' class=" post_tag button button_translucent" data-position=39 title="kubernetes">KUBERNETES<span class="button_tally">39</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/lcm/' class=" post_tag button button_translucent" data-position=1 title="lcm">LCM<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/lifecycle-management/' class=" post_tag button button_translucent" data-position=1 title="lifecycle-management">LIFECYCLE-MANAGEMENT<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/loadbalancing/' class=" post_tag button button_translucent" data-position=9 title="loadbalancing">LOADBALANCING<span class="button_tally">9</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/management/' class=" post_tag button button_translucent" data-position=1 title="management">MANAGEMENT<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/monitoring/' class=" post_tag button button_translucent" data-position=1 title="monitoring">MONITORING<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/netowkring/' class=" post_tag button button_translucent" data-position=1 title="netowkring">NETOWKRING<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/network/' class=" post_tag button button_translucent" data-position=2 title="network">NETWORK<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/networking/' class=" post_tag button button_translucent" data-position=20 title="networking">NETWORKING<span class="button_tally">20</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/nsx/' class=" post_tag button button_translucent" data-position=5 title="nsx">NSX<span class="button_tally">5</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/nsx-alb/' class=" post_tag button button_translucent" data-position=1 title="nsx-alb">NSX-ALB<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/nsx-t/' class=" post_tag button button_translucent" data-position=1 title="nsx-t">NSX-T<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/pinniped/' class=" post_tag button button_translucent" data-position=1 title="pinniped">PINNIPED<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/rbac/' class=" post_tag button button_translucent" data-position=1 title="rbac">RBAC<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/security/' class=" post_tag button button_translucent" data-position=6 title="security">SECURITY<span class="button_tally">6</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/storage/' class=" post_tag button button_translucent" data-position=1 title="storage">STORAGE<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/tanzu/' class=" post_tag button button_translucent" data-position=13 title="tanzu">TANZU<span class="button_tally">13</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/tanzu-mission-control/' class=" post_tag button button_translucent" data-position=1 title="tanzu-mission-control">TANZU-MISSION-CONTROL<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/tkg/' class=" post_tag button button_translucent" data-position=1 title="tkg">TKG<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/tkgi/' class=" post_tag button button_translucent" data-position=1 title="tkgi">TKGI<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/tmc/' class=" post_tag button button_translucent" data-position=1 title="tmc">TMC<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/troubleshooting/' class=" post_tag button button_translucent" data-position=1 title="troubleshooting">TROUBLESHOOTING<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/virtualization/' class=" post_tag button button_translucent" data-position=1 title="virtualization">VIRTUALIZATION<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/vmare-nsx-intelligence/' class=" post_tag button button_translucent" data-position=1 title="vmare-nsx-intelligence">VMARE-NSX-INTELLIGENCE<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/vmware-cloud/' class=" post_tag button button_translucent" data-position=1 title="vmware-cloud">VMWARE-CLOUD<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/vmware-nsx/' class=" post_tag button button_translucent" data-position=2 title="vmware-nsx">VMWARE-NSX<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/categories/vsphere/' class=" post_tag button button_translucent" data-position=1 title="vsphere">VSPHERE<span class="button_tally">1</span>
            </a>
            
            <div class="tags_sort"><span title="sort alphabetically">[A~Z]</span><span title="sort by count">[0~9]</span>
            </div>
            <span class="tags_hide"><svg class="icon">
            <use xlink:href="#closeme"></use>
          </svg></span>
          </div>
        </div>
      </nav>
    </div>
    <div>
      <h2 class="mt-4 taxonomy" id="tags-section">Tags</h2>
      <nav class="tags_nav">
        <a href='https://blog.andreasm.io/tags/kubernetes/' class="post_tag button button_translucent" title="kubernetes">
          KUBERNETES
          <span class="button_tally">22</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/tanzu/' class="post_tag button button_translucent" title="tanzu">
          TANZU
          <span class="button_tally">14</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/nsx/' class="post_tag button button_translucent" title="nsx">
          NSX
          <span class="button_tally">13</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/antrea/' class="post_tag button button_translucent" title="antrea">
          ANTREA
          <span class="button_tally">11</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/ako/' class="post_tag button button_translucent" title="ako">
          AKO
          <span class="button_tally">8</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/avi/' class="post_tag button button_translucent" title="avi">
          AVI
          <span class="button_tally">7</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/loadbalancing/' class="post_tag button button_translucent" title="loadbalancing">
          LOADBALANCING
          <span class="button_tally">7</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/security/' class="post_tag button button_translucent" title="security">
          SECURITY
          <span class="button_tally">6</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/ingress/' class="post_tag button button_translucent" title="ingress">
          INGRESS
          <span class="button_tally">5</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/availability/' class="post_tag button button_translucent" title="availability">
          AVAILABILITY
          <span class="button_tally">3</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/cert-manager/' class="post_tag button button_translucent" title="cert-manager">
          CERT-MANAGER
          <span class="button_tally">3</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/cni/' class="post_tag button button_translucent" title="cni">
          CNI
          <span class="button_tally">3</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/network/' class="post_tag button button_translucent" title="network">
          NETWORK
          <span class="button_tally">3</span>
        </a>
        
        <a href='https://blog.andreasm.io/tags/networking/' class="post_tag button button_translucent" title="networking">
          NETWORKING
          <span class="button_tally">3</span>
        </a>
        
        
        <br>
        <div class="post_tags_toggle button">All Tags</div>
        <div class="post_tags">
          <div class="tags_list">
            
            <a href='https://blog.andreasm.io/tags/ako/' class=" post_tag button button_translucent" data-position=8 title="ako">AKO<span class="button_tally">8</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/amko/' class=" post_tag button button_translucent" data-position=1 title="amko">AMKO<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/ansible/' class=" post_tag button button_translucent" data-position=1 title="ansible">ANSIBLE<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/antrea/' class=" post_tag button button_translucent" data-position=11 title="antrea">ANTREA<span class="button_tally">11</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/argocd/' class=" post_tag button button_translucent" data-position=1 title="argocd">ARGOCD<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/authentication/' class=" post_tag button button_translucent" data-position=2 title="authentication">AUTHENTICATION<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/automation/' class=" post_tag button button_translucent" data-position=1 title="automation">AUTOMATION<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/autoscaling/' class=" post_tag button button_translucent" data-position=1 title="autoscaling">AUTOSCALING<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/availability/' class=" post_tag button button_translucent" data-position=3 title="availability">AVAILABILITY<span class="button_tally">3</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/avi/' class=" post_tag button button_translucent" data-position=7 title="avi">AVI<span class="button_tally">7</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/cert-manager/' class=" post_tag button button_translucent" data-position=3 title="cert-manager">CERT-MANAGER<span class="button_tally">3</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/certificate/' class=" post_tag button button_translucent" data-position=1 title="certificate">CERTIFICATE<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/cilium/' class=" post_tag button button_translucent" data-position=1 title="cilium">CILIUM<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/cni/' class=" post_tag button button_translucent" data-position=3 title="cni">CNI<span class="button_tally">3</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/custom-resource-definitions/' class=" post_tag button button_translucent" data-position=1 title="custom-resource-definitions">CUSTOM-RESOURCE-DEFINITIONS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/distributed-firewall/' class=" post_tag button button_translucent" data-position=1 title="distributed-firewall">DISTRIBUTED-FIREWALL<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/dns-service/' class=" post_tag button button_translucent" data-position=1 title="dns-service">DNS-SERVICE<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/docker/' class=" post_tag button button_translucent" data-position=2 title="docker">DOCKER<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/ebpf/' class=" post_tag button button_translucent" data-position=1 title="ebpf">EBPF<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/github/' class=" post_tag button button_translucent" data-position=1 title="github">GITHUB<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/gitops/' class=" post_tag button button_translucent" data-position=1 title="gitops">GITOPS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/gslb/' class=" post_tag button button_translucent" data-position=1 title="gslb">GSLB<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/harbor/' class=" post_tag button button_translucent" data-position=1 title="harbor">HARBOR<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/home-assistant/' class=" post_tag button button_translucent" data-position=1 title="home-assistant">HOME-ASSISTANT<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/hugo/' class=" post_tag button button_translucent" data-position=2 title="hugo">HUGO<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/ids/' class=" post_tag button button_translucent" data-position=1 title="ids">IDS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/informational/' class=" post_tag button button_translucent" data-position=2 title="informational">INFORMATIONAL<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/ingress/' class=" post_tag button button_translucent" data-position=5 title="ingress">INGRESS<span class="button_tally">5</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/ips/' class=" post_tag button button_translucent" data-position=1 title="ips">IPS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/keycloak/' class=" post_tag button button_translucent" data-position=1 title="keycloak">KEYCLOAK<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/kubernetes/' class=" post_tag button button_translucent" data-position=22 title="kubernetes">KUBERNETES<span class="button_tally">22</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/kubernetes-api-endpoint/' class=" post_tag button button_translucent" data-position=1 title="kubernetes-api-endpoint">KUBERNETES-API-ENDPOINT<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/kubespray/' class=" post_tag button button_translucent" data-position=1 title="kubespray">KUBESPRAY<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/lifecycle-management/' class=" post_tag button button_translucent" data-position=1 title="lifecycle-management">LIFECYCLE-MANAGEMENT<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/load-balancing/' class=" post_tag button button_translucent" data-position=1 title="load-balancing">LOAD-BALANCING<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/loadbalancer/' class=" post_tag button button_translucent" data-position=1 title="loadbalancer">LOADBALANCER<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/loadbalancing/' class=" post_tag button button_translucent" data-position=7 title="loadbalancing">LOADBALANCING<span class="button_tally">7</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/lodbalancing/' class=" post_tag button button_translucent" data-position=1 title="lodbalancing">LODBALANCING<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/management/' class=" post_tag button button_translucent" data-position=1 title="management">MANAGEMENT<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/multi-cluster/' class=" post_tag button button_translucent" data-position=1 title="multi-cluster">MULTI-CLUSTER<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/multi-dc/' class=" post_tag button button_translucent" data-position=1 title="multi-dc">MULTI-DC<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/multi-tenancy/' class=" post_tag button button_translucent" data-position=1 title="multi-tenancy">MULTI-TENANCY<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/network/' class=" post_tag button button_translucent" data-position=3 title="network">NETWORK<span class="button_tally">3</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/network-policies/' class=" post_tag button button_translucent" data-position=2 title="network-policies">NETWORK-POLICIES<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/networking/' class=" post_tag button button_translucent" data-position=3 title="networking">NETWORKING<span class="button_tally">3</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/nfs/' class=" post_tag button button_translucent" data-position=1 title="nfs">NFS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/nsx/' class=" post_tag button button_translucent" data-position=13 title="nsx">NSX<span class="button_tally">13</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/nsx-advanced-loadbalancer/' class=" post_tag button button_translucent" data-position=1 title="nsx-advanced-loadbalancer">NSX-ADVANCED-LOADBALANCER<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/nsx-alb/' class=" post_tag button button_translucent" data-position=1 title="nsx-alb">NSX-ALB<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/nsx-application-platform/' class=" post_tag button button_translucent" data-position=1 title="nsx-application-platform">NSX-APPLICATION-PLATFORM<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/nsx-t/' class=" post_tag button button_translucent" data-position=2 title="nsx-t">NSX-T<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/opentofu/' class=" post_tag button button_translucent" data-position=1 title="opentofu">OPENTOFU<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/persistent-storage/' class=" post_tag button button_translucent" data-position=1 title="persistent-storage">PERSISTENT-STORAGE<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/pinniped/' class=" post_tag button button_translucent" data-position=1 title="pinniped">PINNIPED<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/proxmox/' class=" post_tag button button_translucent" data-position=1 title="proxmox">PROXMOX<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/proxy/' class=" post_tag button button_translucent" data-position=1 title="proxy">PROXY<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/pvc/' class=" post_tag button button_translucent" data-position=1 title="pvc">PVC<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/rbac/' class=" post_tag button button_translucent" data-position=1 title="rbac">RBAC<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/registry/' class=" post_tag button button_translucent" data-position=1 title="registry">REGISTRY<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/security/' class=" post_tag button button_translucent" data-position=6 title="security">SECURITY<span class="button_tally">6</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/static-content-generator/' class=" post_tag button button_translucent" data-position=1 title="static-content-generator">STATIC-CONTENT-GENERATOR<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/static-site-generator/' class=" post_tag button button_translucent" data-position=1 title="static-site-generator">STATIC-SITE-GENERATOR<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/tanzu/' class=" post_tag button button_translucent" data-position=14 title="tanzu">TANZU<span class="button_tally">14</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/tanzu-kubernetes-grid/' class=" post_tag button button_translucent" data-position=1 title="tanzu-kubernetes-grid">TANZU-KUBERNETES-GRID<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/terraform/' class=" post_tag button button_translucent" data-position=1 title="terraform">TERRAFORM<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/tkg/' class=" post_tag button button_translucent" data-position=1 title="tkg">TKG<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/tkg-2.1/' class=" post_tag button button_translucent" data-position=1 title="tkg-2.1">TKG-2.1<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/tkgi/' class=" post_tag button button_translucent" data-position=1 title="tkgi">TKGI<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/tkgs/' class=" post_tag button button_translucent" data-position=1 title="tkgs">TKGS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/tmc/' class=" post_tag button button_translucent" data-position=1 title="tmc">TMC<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/tmc-local/' class=" post_tag button button_translucent" data-position=1 title="tmc-local">TMC-LOCAL<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/tmc-sm/' class=" post_tag button button_translucent" data-position=1 title="tmc-sm">TMC-SM<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/traefik/' class=" post_tag button button_translucent" data-position=1 title="traefik">TRAEFIK<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/troubleshooting/' class=" post_tag button button_translucent" data-position=2 title="troubleshooting">TROUBLESHOOTING<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/unifi/' class=" post_tag button button_translucent" data-position=1 title="unifi">UNIFI<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/vmconaws/' class=" post_tag button button_translucent" data-position=1 title="vmconaws">VMCONAWS<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/vsphere/' class=" post_tag button button_translucent" data-position=2 title="vsphere">VSPHERE<span class="button_tally">2</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/vsphere-replication/' class=" post_tag button button_translucent" data-position=1 title="vsphere-replication">VSPHERE-REPLICATION<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/vsphere-with-tanzu/' class=" post_tag button button_translucent" data-position=1 title="vsphere-with-tanzu">VSPHERE-WITH-TANZU<span class="button_tally">1</span>
            </a>
            
            
            <a href='https://blog.andreasm.io/tags/zwave/' class=" post_tag button button_translucent" data-position=1 title="zwave">ZWAVE<span class="button_tally">1</span>
            </a>
            
            <div class="tags_sort"><span title="sort alphabetically">[A~Z]</span><span title="sort by count">[0~9]</span>
            </div>
            <span class="tags_hide"><svg class="icon">
            <use xlink:href="#closeme"></use>
          </svg></span>
          </div>
        </div>
      </nav>
    </div>
  </section>
</aside>

  
</div>
    </main><svg width="0" height="0" class="hidden">
  <symbol viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" id="facebook">
    <path d="M437 0H75C33.648 0 0 33.648 0 75v362c0 41.352 33.648 75 75 75h151V331h-60v-90h60v-61c0-49.629 40.371-90 90-90h91v90h-91v61h91l-15 90h-76v181h121c41.352 0 75-33.648 75-75V75c0-41.352-33.648-75-75-75zm0 0"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18.001 18.001" id="twitter">
    <path d="M15.891 4.013c.808-.496 1.343-1.173 1.605-2.034a8.68 8.68 0 0 1-2.351.861c-.703-.756-1.593-1.14-2.66-1.14-1.043 0-1.924.366-2.643 1.078a3.56 3.56 0 0 0-1.076 2.605c0 .309.039.585.117.819-3.076-.105-5.622-1.381-7.628-3.837-.34.601-.51 1.213-.51 1.846 0 1.301.549 2.332 1.645 3.089-.625-.053-1.176-.211-1.645-.47 0 .929.273 1.705.82 2.388a3.623 3.623 0 0 0 2.115 1.291c-.312.08-.641.118-.979.118-.312 0-.533-.026-.664-.083.23.757.664 1.371 1.291 1.841a3.652 3.652 0 0 0 2.152.743C4.148 14.173 2.625 14.69.902 14.69c-.422 0-.721-.006-.902-.038 1.697 1.102 3.586 1.649 5.676 1.649 2.139 0 4.029-.542 5.674-1.626 1.645-1.078 2.859-2.408 3.639-3.974a10.77 10.77 0 0 0 1.172-4.892v-.468a7.788 7.788 0 0 0 1.84-1.921 8.142 8.142 0 0 1-2.11.593z"
      ></path>
  </symbol>
  <symbol aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id="mail">
    <path  d="M502.3 190.8c3.9-3.1 9.7-.2 9.7 4.7V400c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V195.6c0-5 5.7-7.8 9.7-4.7 22.4 17.4 52.1 39.5 154.1 113.6 21.1 15.4 56.7 47.8 92.2 47.6 35.7.3 72-32.8 92.3-47.6 102-74.1 131.6-96.3 154-113.7zM256 320c23.2.4 56.6-29.2 73.4-41.4 132.7-96.3 142.8-104.7 173.4-128.7 5.8-4.5 9.2-11.5 9.2-18.9v-19c0-26.5-21.5-48-48-48H48C21.5 64 0 85.5 0 112v19c0 7.4 3.4 14.3 9.2 18.9 30.6 23.9 40.7 32.4 173.4 128.7 16.8 12.2 50.2 41.8 73.4 41.4z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id="calendar">
    <path d="M452 40h-24V0h-40v40H124V0H84v40H60C26.916 40 0 66.916 0 100v352c0 33.084 26.916 60 60 60h392c33.084 0 60-26.916 60-60V100c0-33.084-26.916-60-60-60zm20 412c0 11.028-8.972 20-20 20H60c-11.028 0-20-8.972-20-20V188h432v264zm0-304H40v-48c0-11.028 8.972-20 20-20h24v40h40V80h264v40h40V80h24c11.028 0 20 8.972 20 20v48z"></path>
    <path d="M76 230h40v40H76zm80 0h40v40h-40zm80 0h40v40h-40zm80 0h40v40h-40zm80 0h40v40h-40zM76 310h40v40H76zm80 0h40v40h-40zm80 0h40v40h-40zm80 0h40v40h-40zM76 390h40v40H76zm80 0h40v40h-40zm80 0h40v40h-40zm80 0h40v40h-40zm80-80h40v40h-40z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id="github">
    <path d="M255.968 5.329C114.624 5.329 0 120.401 0 262.353c0 113.536 73.344 209.856 175.104 243.872 12.8 2.368 17.472-5.568 17.472-12.384 0-6.112-.224-22.272-.352-43.712-71.2 15.52-86.24-34.464-86.24-34.464-11.616-29.696-28.416-37.6-28.416-37.6-23.264-15.936 1.728-15.616 1.728-15.616 25.696 1.824 39.2 26.496 39.2 26.496 22.848 39.264 59.936 27.936 74.528 21.344 2.304-16.608 8.928-27.936 16.256-34.368-56.832-6.496-116.608-28.544-116.608-127.008 0-28.064 9.984-51.008 26.368-68.992-2.656-6.496-11.424-32.64 2.496-68 0 0 21.504-6.912 70.4 26.336 20.416-5.696 42.304-8.544 64.096-8.64 21.728.128 43.648 2.944 64.096 8.672 48.864-33.248 70.336-26.336 70.336-26.336 13.952 35.392 5.184 61.504 2.56 68 16.416 17.984 26.304 40.928 26.304 68.992 0 98.72-59.84 120.448-116.864 126.816 9.184 7.936 17.376 23.616 17.376 47.584 0 34.368-.32 62.08-.32 70.496 0 6.88 4.608 14.88 17.6 12.352C438.72 472.145 512 375.857 512 262.353 512 120.401 397.376 5.329 255.968 5.329z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 212 212" id="gitlab">
    <path d="M12.3 74.7h54L43.3 3c-1-3.6-6.4-3.6-7.6 0L12.3 74.8z" />
    <path d="M12.3 74.7L.5 111c-1 3.2 0 6.8 3 8.8l101.6 74-92.5-119z"/>
    <path d="M105 193.7l-38.6-119h-54l92.7 119z"/>
    <path d="M105 193.7l38.7-119H66.4l38.7 119z"/>
    <path d="M105 193.7l38.7-119H198l-93 119z"/>
    <path d="M198 74.7l11.6 36.2c1 3 0 6.6-3 8.6l-101.5 74 93-119z"/>
    <path d="M198 74.7h-54.3L167 3c1.2-3.6 6.4-3.6 7.6 0L198 74.8z"/> 
  </symbol>
  <symbol viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" id="rss">
    <circle cx="3.429" cy="20.571" r="3.429"></circle>
    <path d="M11.429 24h4.57C15.999 15.179 8.821 8.001 0 8v4.572c6.302.001 11.429 5.126 11.429 11.428z"></path>
    <path d="M24 24C24 10.766 13.234 0 0 0v4.571c10.714 0 19.43 8.714 19.43 19.429z"></path>
  </symbol>
  <symbol viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" id="linkedin">
    <path d="M437 0H75C33.648 0 0 33.648 0 75v362c0 41.352 33.648 75 75 75h362c41.352 0 75-33.648 75-75V75c0-41.352-33.648-75-75-75zM181 406h-60V196h60zm0-240h-60v-60h60zm210 240h-60V286c0-16.54-13.46-30-30-30s-30 13.46-30 30v120h-60V196h60v11.309C286.719 202.422 296.93 196 316 196c40.691.043 75 36.547 75 79.688zm0 0"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 612 612" id="to-top">
    <path d="M604.501 440.509L325.398 134.956c-5.331-5.357-12.423-7.627-19.386-7.27-6.989-.357-14.056 1.913-19.387 7.27L7.499 440.509c-9.999 10.024-9.999 26.298 0 36.323s26.223 10.024 36.222 0l262.293-287.164L568.28 476.832c9.999 10.024 26.222 10.024 36.221 0 9.999-10.023 9.999-26.298 0-36.323z"></path>
  </symbol>
  <symbol viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" id="carly">
    <path d="M504.971 239.029L448 182.059V84c0-46.317-37.682-84-84-84h-44c-13.255 0-24 10.745-24 24s10.745 24 24 24h44c19.851 0 36 16.149 36 36v108c0 6.365 2.529 12.47 7.029 16.971L454.059 256l-47.029 47.029A24.002 24.002 0 0 0 400 320v108c0 19.851-16.149 36-36 36h-44c-13.255 0-24 10.745-24 24s10.745 24 24 24h44c46.318 0 84-37.683 84-84v-98.059l56.971-56.971c9.372-9.372 9.372-24.568 0-33.941zM112 192V84c0-19.851 16.149-36 36-36h44c13.255 0 24-10.745 24-24S205.255 0 192 0h-44c-46.318 0-84 37.683-84 84v98.059l-56.971 56.97c-9.373 9.373-9.373 24.568 0 33.941L64 329.941V428c0 46.317 37.682 84 84 84h44c13.255 0 24-10.745 24-24s-10.745-24-24-24h-44c-19.851 0-36-16.149-36-36V320c0-6.365-2.529-12.47-7.029-16.971L57.941 256l47.029-47.029A24.002 24.002 0 0 0 112 192z"></path>
  </symbol>
  <symbol viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" id="copy">
    <path d="M23 2.75A2.75 2.75 0 0 0 20.25 0H8.75A2.75 2.75 0 0 0 6 2.75v13.5A2.75 2.75 0 0 0 8.75 19h11.5A2.75 2.75 0 0 0 23 16.25zM18.25 14.5h-7.5a.75.75 0 0 1 0-1.5h7.5a.75.75 0 0 1 0 1.5zm0-3h-7.5a.75.75 0 0 1 0-1.5h7.5a.75.75 0 0 1 0 1.5zm0-3h-7.5a.75.75 0 0 1 0-1.5h7.5a.75.75 0 0 1 0 1.5z"></path>
    <path d="M8.75 20.5a4.255 4.255 0 0 1-4.25-4.25V2.75c0-.086.02-.166.025-.25H3.75A2.752 2.752 0 0 0 1 5.25v16A2.752 2.752 0 0 0 3.75 24h12a2.752 2.752 0 0 0 2.75-2.75v-.75z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512.001 512.001" id="closeme">
    <path d="M284.286 256.002L506.143 34.144c7.811-7.811 7.811-20.475 0-28.285-7.811-7.81-20.475-7.811-28.285 0L256 227.717 34.143 5.859c-7.811-7.811-20.475-7.811-28.285 0-7.81 7.811-7.811 20.475 0 28.285l221.857 221.857L5.858 477.859c-7.811 7.811-7.811 20.475 0 28.285a19.938 19.938 0 0 0 14.143 5.857 19.94 19.94 0 0 0 14.143-5.857L256 284.287l221.857 221.857c3.905 3.905 9.024 5.857 14.143 5.857s10.237-1.952 14.143-5.857c7.811-7.811 7.811-20.475 0-28.285L284.286 256.002z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id="open-menu">
    <path d="M492 236H20c-11.046 0-20 8.954-20 20s8.954 20 20 20h472c11.046 0 20-8.954 20-20s-8.954-20-20-20zm0-160H20C8.954 76 0 84.954 0 96s8.954 20 20 20h472c11.046 0 20-8.954 20-20s-8.954-20-20-20zm0 320H20c-11.046 0-20 8.954-20 20s8.954 20 20 20h472c11.046 0 20-8.954 20-20s-8.954-20-20-20z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="instagram">
    <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id=youtube>
    <path d="M19.615 3.184c-3.604-.246-11.631-.245-15.23 0-3.897.266-4.356 2.62-4.385 8.816.029 6.185.484 8.549 4.385 8.816 3.6.245 11.626.246 15.23 0 3.897-.266 4.356-2.62 4.385-8.816-.029-6.185-.484-8.549-4.385-8.816zm-10.615 12.816v-8l8 3.993-8 4.007z"/>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="stackoverflow">
    <path d="M21 27v-8h3v11H0V19h3v8h18z"></path><path d="M17.1.2L15 1.8l7.9 10.6 2.1-1.6L17.1.2zm3.7 14.7L10.6 6.4l1.7-2 10.2 8.5-1.7 2zM7.2 12.3l12 5.6 1.1-2.4-12-5.6-1.1 2.4zm-1.8 6.8l13.56 1.96.17-2.38-13.26-2.55-.47 2.97zM19 25H5v-3h14v3z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="xing">
    <path d="M18.188 0c-.517 0-.741.325-.927.66 0 0-7.455 13.224-7.702 13.657.015.024 4.919 9.023 4.919 9.023.17.308.436.66.967.66h3.454c.211 0 .375-.078.463-.22.089-.151.089-.346-.009-.536l-4.879-8.916c-.004-.006-.004-.016 0-.022L22.139.756c.095-.191.097-.387.006-.535C22.056.078 21.894 0 21.686 0h-3.498zM3.648 4.74c-.211 0-.385.074-.473.216-.09.149-.078.339.02.531l2.34 4.05c.004.01.004.016 0 .021L1.86 16.051c-.099.188-.093.381 0 .529.085.142.239.234.45.234h3.461c.518 0 .766-.348.945-.667l3.734-6.609-2.378-4.155c-.172-.315-.434-.659-.962-.659H3.648v.016z"/>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 71 55" id="discord">
    <path d="M60.1045 4.8978C55.5792 2.8214 50.7265 1.2916 45.6527 0.41542C45.5603 0.39851 45.468 0.440769 45.4204 0.525289C44.7963 1.6353 44.105 3.0834 43.6209 4.2216C38.1637 3.4046 32.7345 3.4046 27.3892 4.2216C26.905 3.0581 26.1886 1.6353 25.5617 0.525289C25.5141 0.443589 25.4218 0.40133 25.3294 0.41542C20.2584 1.2888 15.4057 2.8186 10.8776 4.8978C10.8384 4.9147 10.8048 4.9429 10.7825 4.9795C1.57795 18.7309 -0.943561 32.1443 0.293408 45.3914C0.299005 45.4562 0.335386 45.5182 0.385761 45.5576C6.45866 50.0174 12.3413 52.7249 18.1147 54.5195C18.2071 54.5477 18.305 54.5139 18.3638 54.4378C19.7295 52.5728 20.9469 50.6063 21.9907 48.5383C22.0523 48.4172 21.9935 48.2735 21.8676 48.2256C19.9366 47.4931 18.0979 46.6 16.3292 45.5858C16.1893 45.5041 16.1781 45.304 16.3068 45.2082C16.679 44.9293 17.0513 44.6391 17.4067 44.3461C17.471 44.2926 17.5606 44.2813 17.6362 44.3151C29.2558 49.6202 41.8354 49.6202 53.3179 44.3151C53.3935 44.2785 53.4831 44.2898 53.5502 44.3433C53.9057 44.6363 54.2779 44.9293 54.6529 45.2082C54.7816 45.304 54.7732 45.5041 54.6333 45.5858C52.8646 46.6197 51.0259 47.4931 49.0921 48.2228C48.9662 48.2707 48.9102 48.4172 48.9718 48.5383C50.038 50.6034 51.2554 52.5699 52.5959 54.435C52.6519 54.5139 52.7526 54.5477 52.845 54.5195C58.6464 52.7249 64.529 50.0174 70.6019 45.5576C70.6551 45.5182 70.6887 45.459 70.6943 45.3942C72.1747 30.0791 68.2147 16.7757 60.1968 4.9823C60.1772 4.9429 60.1437 4.9147 60.1045 4.8978ZM23.7259 37.3253C20.2276 37.3253 17.3451 34.1136 17.3451 30.1693C17.3451 26.225 20.1717 23.0133 23.7259 23.0133C27.308 23.0133 30.1626 26.2532 30.1066 30.1693C30.1066 34.1136 27.28 37.3253 23.7259 37.3253ZM47.3178 37.3253C43.8196 37.3253 40.9371 34.1136 40.9371 30.1693C40.9371 26.225 43.7636 23.0133 47.3178 23.0133C50.9 23.0133 53.7545 26.2532 53.6986 30.1693C53.6986 34.1136 50.9 37.3253 47.3178 37.3253Z"/>
  </symbol>
</svg>


<footer class="footer">
  <div class="footer_inner wrap pale">
    <img src='https://blog.andreasm.io/icons/apple-touch-icon.png' class="icon icon_2 transparent" alt="From 0.985mhz... to several Ghz">
    <p>Copyright&nbsp;2016-&nbsp;<span class="year"></span>&nbsp;FROM 0.985MHZ... TO SEVERAL GHZ. All Rights Reserved</p><a class="to_top" href="#documentTop">
  <svg class="icon">
  <title>to-top</title>
  <use xlink:href="#to-top"></use>
</svg>

</a>

  </div>
</footer>

<script type="text/javascript" src="https://blog.andreasm.io/en/js/bundle.5548d358738600c857a1f05f0459418da7143d4426c66a08bf3f15ded1b39dd2136bf104a559247a909fc4dcc45b8e06bad0870ece4c71ee5303d30550def8bd.js" integrity="sha512-VUjTWHOGAMhXofBfBFlBjacUPUQmxmoIvz8V3tGzndITa/EEpVkkepCfxNzEW44GutCHDs5Mce5TA9MFUN74vQ==" crossorigin="anonymous"></script>

  <script src="https://blog.andreasm.io/js/search.min.df4d84e4983f0c71dd495e07a09815d920553c3ddf3d0767801c73373573aa17e1b489e4453272dbf4ce2a38a3d01a10b170744e50dd6bec85a598221867ba9a.js"></script>

  </body>
</html>
