<!DOCTYPE html>
<html lang="en" dir="ltr" class="scroll-smooth" data-default-appearance="dark"
  data-auto-appearance="true"><head>
  <meta charset="utf-8" />
  
  <meta http-equiv="content-language" content="en" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  
  <title>Securing Kubernetes clusters with Antrea Network Policies &middot; blog.andreasm.io</title>
  <meta name="title" content="Securing Kubernetes clusters with Antrea Network Policies &middot; blog.andreasm.io" />
  
  <meta name="description" content="In this post I will go through how to utilize Antrea Network policies with Tanzu Mission Control and a little bit NSX. So jump in and hopefully get some ideas how what we can do with Antrea Network Policies and how to use them." />
  <meta name="keywords" content="security, cni, kubernetes, antrea, tmc, " />
  
  
  <link rel="canonical" href="https://blog.andreasm.io/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/" />
  
  
  
  
  
  
  
  
  
  
  
  
  <link type="text/css" rel="stylesheet" href="/css/main.bundle.min.48d290696564c2380c4233780f3fd414aa6e2b0b67ed916e9d918c48c05f5b20b641bf892fadd408e43ec21d2feb2ec1fe6fd1f021df2806a254977fe2f80a64.css"
    integrity="sha512-SNKQaWVkwjgMQjN4Dz/UFKpuKwtn7ZFunZGMSMBfWyC2Qb&#43;JL63UCOQ&#43;wh0v6y7B/m/R8CHfKAaiVJd/4vgKZA==" />
  
  
  <script type="text/javascript" src="/js/appearance.min.a85bd6dc99d1fecae166deb56a1fee6375588c72533c4b8c690e4a9ec5a04174ff780e41e2ac770382a8e67818cb2b89766afa3e23965c9102424a080dafbb0c.js"
    integrity="sha512-qFvW3JnR/srhZt61ah/uY3VYjHJTPEuMaQ5KnsWgQXT/eA5B4qx3A4Ko5ngYyyuJdmr6PiOWXJECQkoIDa&#43;7DA=="></script>
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <script defer type="text/javascript" id="script-bundle" src="/js/main.bundle.min.a2d78d78672e549fbfc972ece871725b5478ba0b65708dda20cb97ab80a865eae6d247e1b05a4aec6ebbf78647ec3233bad8b2609ed98eee53cd58aa17128bc7.js"
    integrity="sha512-oteNeGcuVJ&#43;/yXLs6HFyW1R4ugtlcI3aIMuXq4CoZerm0kfhsFpK7G6794ZH7DIzutiyYJ7Zju5TzViqFxKLxw==" data-copy="" data-copied=""></script>
  
  
  
  <script src="/lib/zoom/zoom.min.37d2094687372da3f7343a221a470f6b8806f7891aa46a5a03966af7f0ebd38b9fe536cb154e6ad28f006d184b294525a7c4054b6bbb4be62d8b453b42db99bd.js" integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S&#43;Yti0U7QtuZvQ=="></script>
  
  
  
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
  <link rel="manifest" href="/site.webmanifest" />
  
  
  
  
  
  
  
  
  <meta property="og:url" content="https://blog.andreasm.io/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/">
  <meta property="og:site_name" content="blog.andreasm.io">
  <meta property="og:title" content="Securing Kubernetes clusters with Antrea Network Policies">
  <meta property="og:description" content="Antrea Network Policies">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2023-06-21T10:01:46+02:00">
    <meta property="article:modified_time" content="2023-06-21T10:01:46+02:00">
    <meta property="article:tag" content="Security">
    <meta property="article:tag" content="Cni">
    <meta property="article:tag" content="Kubernetes">
    <meta property="article:tag" content="Antrea">
    <meta property="article:tag" content="Tmc">
    <meta property="og:image" content="https://blog.andreasm.io/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/feature-antrea-1.png">

  
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://blog.andreasm.io/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/feature-antrea-1.png">
  <meta name="twitter:title" content="Securing Kubernetes clusters with Antrea Network Policies">
  <meta name="twitter:description" content="Antrea Network Policies">

  
  <script type="application/ld+json">
  [{
    "@context": "https://schema.org",
    "@type": "Article",
    "articleSection": "Posts",
    "name": "Securing Kubernetes clusters with Antrea Network Policies",
    "headline": "Securing Kubernetes clusters with Antrea Network Policies",
    "description": "Antrea Network Policies",
    "abstract": "In this post I will go through how to utilize Antrea Network policies with Tanzu Mission Control and a little bit NSX. So jump in and hopefully get some ideas how what we can do with Antrea Network Policies and how to use them.",
    "inLanguage": "en",
    "url" : "https:\/\/blog.andreasm.io\/2023\/06\/21\/securing-kubernetes-clusters-with-antrea-network-policies\/",
    "author" : {
      "@type": "Person",
      "name": "Andreas Marqvardsen"
    },
    "copyrightYear": "2023",
    "dateCreated": "2023-06-21T10:01:46\u002b02:00",
    "datePublished": "2023-06-21T10:01:46\u002b02:00",
    
    "dateModified": "2023-06-21T10:01:46\u002b02:00",
    
    "keywords": ["security","cni","kubernetes","antrea","tmc"],
    
    "mainEntityOfPage": "true",
    "wordCount": "6048"
  }]
  </script>


  
  
  <meta name="author" content="Andreas Marqvardsen" />
  
  
  
  <link href="mailto:andreas.marqvardsen[AT]gmail.com" rel="me" />
  
  
  <link href="https://blog.andreasm.io/" rel="me" />
  
  
  <link href="https://github.com/andreasm80" rel="me" />
  
  
  <link href="https://linkedin.com/in/andreas-marqvardsen" rel="me" />
  
  
  <link href="https://vmst.io/@andreasm" rel="me" />
  
  
  <link href="https://x.com/NATsoFast" rel="me" />
  
  
  
  

<script src="/lib/jquery/jquery.slim.min.b0dca576e87d7eaa5850ae4e61759c065786cdb6489d68fcc82240539eebd5da522bdb4fda085ffd245808c8fe2acb2516408eb774ef26b5f6015fc6737c0ea8.js" integrity="sha512-sNylduh9fqpYUK5OYXWcBleGzbZInWj8yCJAU57r1dpSK9tP2ghf/SRYCMj&#43;KsslFkCOt3TvJrX2AV/Gc3wOqA=="></script>






















  
  

<script async src="https://www.googletagmanager.com/gtag/js?id=G-TVPYDVE8KR"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-TVPYDVE8KR');
</script>



  
  
  <meta name="theme-color"/>
  
  
</head>
<body
  class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32 scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600">
  <div id="the-top" class="absolute flex self-center">
    <a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600"
      href="#main-content"><span
        class="font-bold text-primary-600 ltr:pr-2 rtl:pl-2 dark:text-primary-400">&darr;</span>Skip to main content</a>
  </div>
  
  
  <div class="min-h-[148px]"></div>
<div class="fixed inset-x-0 pl-[24px] pr-[24px]" style="z-index:100">
  <div id="menu-blur" class="absolute opacity-0 inset-x-0 top-0 h-full single_hero_background nozoom backdrop-blur-2xl shadow-2xl"></div>
  <div class="relative max-w-[64rem] ml-auto mr-auto">
    <div style="padding-left:0;padding-right:0;padding-top:2px;padding-bottom:3px"
    class="main-menu flex items-center justify-between px-4 py-6 sm:px-6 md:justify-start space-x-3">
    
    
    
    <div>
        <a href="/" class="flex">
            <span class="sr-only">blog.andreasm.io</span>

            
            <img src="/ynwa2.png" width="300" height="342"
                class="logo max-h-[5rem] max-w-[5rem] object-scale-down object-left nozoom" alt="blog.andreasm.io" />
            

        </a>
    </div>
    
    <div class="flex flex-1 items-center justify-between">
        <nav class="flex space-x-3">

            
            <a href="/" class="text-base font-medium text-gray-500 hover:text-gray-900">blog.andreasm.io</a>
            

        </nav>
        <nav class="hidden md:flex items-center space-x-5 md:ml-12 h-12">

            
            
            
  <a href="/posts/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
    
    <p class="text-base font-medium" title="">
        Posts
    </p>
</a>



            
            
  <a href="/about/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
    
    <p class="text-base font-medium" title="">
        About
    </p>
</a>



            
            
  <a href="/categories/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
    
    <p class="text-base font-medium" title="">
        Categories
    </p>
</a>



            
            
  <a href="/tags/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
    
    <p class="text-base font-medium" title="">
        Tags
    </p>
</a>



            
            

            


            
            <button id="search-button" aria-label="Search" class="text-base hover:text-primary-600 dark:hover:text-primary-400"
                title="">
                

  <span class="relative block icon">
    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>

  </span>


            </button>
            


            
            
            <div
                class="ltr:mr-14 rtl:ml-14 flex items-center">
                <button id="appearance-switcher" aria-label="Dark mode switcher" type="button" class="text-base hover:text-primary-600 dark:hover:text-primary-400">
                    <div class="flex items-center justify-center dark:hidden">
                        

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M32 256c0-123.8 100.3-224 223.8-224c11.36 0 29.7 1.668 40.9 3.746c9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3c9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480C132.1 480 32 379.6 32 256z"/></svg>

  </span>


                    </div>
                    <div class="items-center justify-center hidden dark:flex">
                        

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02 0-95.1 42.98-95.1 95.1S202.1 351.1 256 351.1s95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347L446.1 255.1l63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7l-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89L164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6L12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256l-63.15 91.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7l19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109l109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69 0-127.1-57.31-127.1-127.1c0-70.69 57.31-127.1 127.1-127.1s127.1 57.3 127.1 127.1C383.1 326.7 326.7 383.1 256 383.1z"/></svg>

  </span>


                    </div>
                </button>
            </div>
            

        </nav>
        <div class="flex md:hidden items-center space-x-5 md:ml-12 h-12">

            <span></span>

            


            
            <button id="search-button-mobile" aria-label="Search" class="text-base hover:text-primary-600 dark:hover:text-primary-400"
                title="">
                

  <span class="relative block icon">
    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>

  </span>


            </button>
            

            
            
            <button id="appearance-switcher-mobile" aria-label="Dark mode switcher" type="button" class="text-base hover:text-primary-600 dark:hover:text-primary-400" style="margin-right:5px">
                <div class="flex items-center justify-center dark:hidden">
                    

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M32 256c0-123.8 100.3-224 223.8-224c11.36 0 29.7 1.668 40.9 3.746c9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3c9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480C132.1 480 32 379.6 32 256z"/></svg>

  </span>


                </div>
                <div class="items-center justify-center hidden dark:flex">
                    

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02 0-95.1 42.98-95.1 95.1S202.1 351.1 256 351.1s95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347L446.1 255.1l63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7l-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89L164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6L12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256l-63.15 91.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7l19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109l109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69 0-127.1-57.31-127.1-127.1c0-70.69 57.31-127.1 127.1-127.1s127.1 57.3 127.1 127.1C383.1 326.7 326.7 383.1 256 383.1z"/></svg>

  </span>


                </div>
            </button>
            

        </div>
    </div>
    <div class="-my-2 -mr-2 md:hidden">

        <label id="menu-button" class="block">
            
            <div class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400">
                

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M0 96C0 78.33 14.33 64 32 64H416C433.7 64 448 78.33 448 96C448 113.7 433.7 128 416 128H32C14.33 128 0 113.7 0 96zM0 256C0 238.3 14.33 224 32 224H416C433.7 224 448 238.3 448 256C448 273.7 433.7 288 416 288H32C14.33 288 0 273.7 0 256zM416 448H32C14.33 448 0 433.7 0 416C0 398.3 14.33 384 32 384H416C433.7 384 448 398.3 448 416C448 433.7 433.7 448 416 448z"/></svg>

  </span>


            </div>
            <div id="menu-wrapper" style="padding-top:5px;"
                class="fixed inset-0 z-30 invisible w-screen h-screen m-0 overflow-auto transition-opacity opacity-0 cursor-default bg-neutral-100/50 backdrop-blur-sm dark:bg-neutral-900/50">
                <ul
                    class="flex space-y-2 mt-3 flex-col items-end w-full px-6 py-6 mx-auto overflow-visible list-none ltr:text-right rtl:text-left max-w-7xl">

                    <li id="menu-close-button">
                        <span
                            class="cursor-pointer inline-block align-text-bottom hover:text-primary-600 dark:hover:text-primary-400">

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75 0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3L54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75 0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75 0-45.25s32.75-12.5 45.25 0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25 0s12.5 32.75 0 45.25l-105.4 105.4L310.6 361.4z"/></svg>

  </span>

</span>
                    </li>

                    

                    
  <li class="mt-1">
    <a href="/posts/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
        
        <p class="text-bg font-bg" title="">
            Posts
        </p>
    </a>
</li>




                    

                    
  <li class="mt-1">
    <a href="/about/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
        
        <p class="text-bg font-bg" title="">
            About
        </p>
    </a>
</li>




                    

                    
  <li class="mt-1">
    <a href="/categories/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
        
        <p class="text-bg font-bg" title="">
            Categories
        </p>
    </a>
</li>




                    

                    
  <li class="mt-1">
    <a href="/tags/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
        
        <p class="text-bg font-bg" title="">
            Tags
        </p>
    </a>
</li>




                    

                </ul>
                
                

            </div>
        </label>
    </div>
</div>




<script>
    (function () {
        var $mainmenu = $('.main-menu');
        var path = window.location.pathname;
        $mainmenu.find('a[href="' + path + '"]').each(function (i, e) {
            $(e).children('p').addClass('active');
        });
    })();
</script>


  </div>
</div>
<script>
  window.addEventListener('scroll', function (e) {
    var scroll = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop || 0;
    var background_blur = document.getElementById('menu-blur');
    background_blur.style.opacity = (scroll / 300);
  });
</script>

  
  <div class="relative flex flex-col grow">
    <main id="main-content" class="grow">
      


<article>
  
  
  
  
  
  


<div id="hero" class="h-[150px] md:h-[200px]"></div>



    
    <div class="fixed inset-x-0 top-0 h-[800px] single_hero_background nozoom"
    style="background-image:url(/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/feature-antrea-1.png);">
    


    <div class="absolute inset-0 bg-gradient-to-t from-neutral dark:from-neutral-800 to-transparent mix-blend-normal">
    </div>
    <div
        class="absolute inset-0 opacity-60 bg-gradient-to-t from-neutral dark:from-neutral-800 to-neutral-100 dark:to-neutral-800 mix-blend-normal">
    </div>
</div>

<div id="background-blur" class="fixed opacity-0 inset-x-0 top-0 h-full single_hero_background nozoom backdrop-blur-2xl"></div>
<script>
    window.addEventListener('scroll', function (e) {
        var scroll = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop || 0;
        var background_blur = document.getElementById('background-blur');
        background_blur.style.opacity = (scroll / 300)
    });
</script>

  
  

  <header id="single_header" class="mt-5 max-w-prose">
    
    <ol class="text-sm text-neutral-500 dark:text-neutral-400 print:hidden">
  
  
    
  
    
  
  <li class="inline hidden">
    <a
      class="hover:underline decoration-neutral-300 dark:underline-neutral-600"
      href="/"
      >blog.andreasm.io</a
    ><span class="px-1 text-primary-500">/</span>
  </li>

  
  <li class="inline ">
    <a
      class="hover:underline decoration-neutral-300 dark:underline-neutral-600"
      href="/posts/"
      >Posts</a
    ><span class="px-1 text-primary-500">/</span>
  </li>

  
  <li class="inline hidden">
    <a
      class="hover:underline decoration-neutral-300 dark:underline-neutral-600"
      href="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/"
      >Securing Kubernetes clusters with Antrea Network Policies</a
    ><span class="px-1 text-primary-500">/</span>
  </li>

</ol>


    
    <h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">
      Securing Kubernetes clusters with Antrea Network Policies
    </h1>
    <div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden">
      





  
  







  





  



  













<div class="flex flex-row flex-wrap items-center">
  
  
  <time datetime="2023-06-21T10:01:46&#43;02:00">21 June 2023</time><span class="px-2 text-primary-500">&middot;</span><span>6048 words</span><span class="px-2 text-primary-500">&middot;</span><span title="Reading time">29 mins</span>
  

  
  
</div>


<div class="flex flex-row flex-wrap items-center">
  
  
  
  
  
  
  
  
  
  
  
</div>




<div class="flex flex-row flex-wrap items-center">
  
  
  
  
  
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/kubernetes/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Kubernetes
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/cni/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    CNI
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/antrea/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Antrea
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/security/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Security
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/tmc/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    TMC
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/tanzu-mission-control/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Tanzu Mission Control
  </span>
</span>
  </span>
  
  
  
  
  
  
  
  
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/security/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Security
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/cni/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Cni
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/kubernetes/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Kubernetes
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/antrea/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Antrea
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/tmc/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Tmc
  </span>
</span>
  </span>
  
  
  
  
</div>




    </div>

    
    
    
    
    

    

    
      
      
        
        
<div class="flex author">
  
    
    
      
    
    
      
      <img class="!mt-0 !mb-0 h-24 w-24 rounded-full ltr:mr-4 rtl:ml-4" width="96" height="96"
      alt="Andreas Marqvardsen" src="/profile.png" />
    
  
  <div class="place-self-center">
    
    <div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">
      Author
    </div>
    <div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">
      Andreas Marqvardsen
    </div>
    
    
    <div class="text-sm text-neutral-700 dark:text-neutral-400">Always curious, always learning</div>
    
    <div class="text-2xl sm:text-lg">
  <div class="flex flex-wrap text-neutral-400 dark:text-neutral-500">
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="mailto:andreas.marqvardsen[AT]gmail.com"
          target="_blank"
          aria-label="Email"
          rel="me noopener noreferrer"
          ><span class="inline-block align-text-bottom">

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M207.8 20.73c-93.45 18.32-168.7 93.66-187 187.1c-27.64 140.9 68.65 266.2 199.1 285.1c19.01 2.888 36.17-12.26 36.17-31.49l.0001-.6631c0-15.74-11.44-28.88-26.84-31.24c-84.35-12.98-149.2-86.13-149.2-174.2c0-102.9 88.61-185.5 193.4-175.4c91.54 8.869 158.6 91.25 158.6 183.2l0 16.16c0 22.09-17.94 40.05-40 40.05s-40.01-17.96-40.01-40.05v-120.1c0-8.847-7.161-16.02-16.01-16.02l-31.98 .0036c-7.299 0-13.2 4.992-15.12 11.68c-24.85-12.15-54.24-16.38-86.06-5.106c-38.75 13.73-68.12 48.91-73.72 89.64c-9.483 69.01 43.81 128 110.9 128c26.44 0 50.43-9.544 69.59-24.88c24 31.3 65.23 48.69 109.4 37.49C465.2 369.3 496 324.1 495.1 277.2V256.3C495.1 107.1 361.2-9.332 207.8 20.73zM239.1 304.3c-26.47 0-48-21.56-48-48.05s21.53-48.05 48-48.05s48 21.56 48 48.05S266.5 304.3 239.1 304.3z"/></svg>

  </span>

</span></a
        >
      
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="https://blog.andreasm.io/"
          target="_blank"
          aria-label="Link"
          rel="me noopener noreferrer"
          ><span class="inline-block align-text-bottom">

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><path fill="currentColor" d="M172.5 131.1C228.1 75.51 320.5 75.51 376.1 131.1C426.1 181.1 433.5 260.8 392.4 318.3L391.3 319.9C381 334.2 361 337.6 346.7 327.3C332.3 317 328.9 297 339.2 282.7L340.3 281.1C363.2 249 359.6 205.1 331.7 177.2C300.3 145.8 249.2 145.8 217.7 177.2L105.5 289.5C73.99 320.1 73.99 372 105.5 403.5C133.3 431.4 177.3 435 209.3 412.1L210.9 410.1C225.3 400.7 245.3 404 255.5 418.4C265.8 432.8 262.5 452.8 248.1 463.1L246.5 464.2C188.1 505.3 110.2 498.7 60.21 448.8C3.741 392.3 3.741 300.7 60.21 244.3L172.5 131.1zM467.5 380C411 436.5 319.5 436.5 263 380C213 330 206.5 251.2 247.6 193.7L248.7 192.1C258.1 177.8 278.1 174.4 293.3 184.7C307.7 194.1 311.1 214.1 300.8 229.3L299.7 230.9C276.8 262.1 280.4 306.9 308.3 334.8C339.7 366.2 390.8 366.2 422.3 334.8L534.5 222.5C566 191 566 139.1 534.5 108.5C506.7 80.63 462.7 76.99 430.7 99.9L429.1 101C414.7 111.3 394.7 107.1 384.5 93.58C374.2 79.2 377.5 59.21 391.9 48.94L393.5 47.82C451 6.731 529.8 13.25 579.8 63.24C636.3 119.7 636.3 211.3 579.8 267.7L467.5 380z"/></svg>

  </span>

</span></a
        >
      
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="https://github.com/andreasm80"
          target="_blank"
          aria-label="Github"
          rel="me noopener noreferrer"
          ><span class="inline-block align-text-bottom">

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>

  </span>

</span></a
        >
      
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="https://linkedin.com/in/andreas-marqvardsen"
          target="_blank"
          aria-label="Linkedin"
          rel="me noopener noreferrer"
          ><span class="inline-block align-text-bottom">

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg>

  </span>

</span></a
        >
      
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="https://vmst.io/@andreasm"
          target="_blank"
          aria-label="Mastodon"
          rel="me noopener noreferrer"
          ><span class="inline-block align-text-bottom">

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48 0 0 0-63.72 28.5-63.72 125.7 0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54 0 0 1-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"/></svg>

  </span>

</span></a
        >
      
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="https://x.com/NATsoFast"
          target="_blank"
          aria-label="X-Twitter"
          rel="me noopener noreferrer"
          ><span class="inline-block align-text-bottom">

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8L200.7 275.5 26.8 48H172.4L272.9 180.9 389.2 48zM364.4 421.8h39.1L151.1 88h-42L364.4 421.8z"/></svg>
  </span>

</span></a
        >
      
    
  </div>

</div>
  </div>
</div>

      

      

      
      <div class="mb-5"></div>
      

    

  </header>
  
  <section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row">
    
     <div
      class="order-first lg:ml-auto px-0 lg:order-last ltr:lg:pl-8 rtl:lg:pr-8">
      <div class="toc ltr:pl-5 rtl:pr-5 print:hidden lg:sticky lg:top-[140px]">

         <details open id="TOCView"
  class="toc-right mt-0 overflow-y-scroll overscroll-contain scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600 rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 hidden lg:block">
  <summary
    class="block py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">
    Table of Contents
  </summary>
  <div
    class="min-w-[220px] py-2 border-dotted ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#different-layers-of-security-different-personas-different-enforcement-points">Different layers of security, different personas, different enforcement points</a></li>
    <li><a href="#managing-and-making-sure-the-required-antrea-policies-are-applied">Managing and making sure the required Antrea Policies are applied</a></li>
    <li><a href="#applying-antrea-policies-with-kubectl">Applying Antrea policies with kubectl</a></li>
    <li><a href="#applying-antrea-policies-using-tmc---tanzu-mission-control">Applying Antrea policies using TMC - Tanzu Mission Control</a>
      <ul>
        <li><a href="#preparing-tmc">Preparing TMC</a></li>
        <li><a href="#git-repository">Git repository</a></li>
        <li><a href="#tmc-kustomization">TMC Kustomization</a></li>
        <li><a href="#deploy-tkc-cluster-from-tmc---auto-apply-security-policies">Deploy TKC cluster from TMC - auto apply security policies</a></li>
      </ul>
    </li>
    <li><a href="#applying-antrea-policies-with-nsx">Applying Antrea policies with NSX</a>
      <ul>
        <li><a href="#applying-antrea-native-policies-from-the-nsx-manager">Applying Antrea native policies from the NSX manager</a></li>
        <li><a href="#applying-kubernetes-related-policies-using-inventory-information-from-antrea">Applying Kubernetes related policies using inventory information from Antrea</a></li>
      </ul>
    </li>
    <li><a href="#rbac---making-sure-no-one-can-overwriteoverride-existing-rules">RBAC - making sure no one can overwrite/override existing rules.</a></li>
    <li><a href="#outro">Outro&hellip;</a></li>
  </ul>
</nav>
  </div>
</details>
<details class="toc-inside mt-0 overflow-hidden rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 lg:hidden">
  <summary
    class="py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">
    Table of Contents
  </summary>
  <div
    class="py-2 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#different-layers-of-security-different-personas-different-enforcement-points">Different layers of security, different personas, different enforcement points</a></li>
    <li><a href="#managing-and-making-sure-the-required-antrea-policies-are-applied">Managing and making sure the required Antrea Policies are applied</a></li>
    <li><a href="#applying-antrea-policies-with-kubectl">Applying Antrea policies with kubectl</a></li>
    <li><a href="#applying-antrea-policies-using-tmc---tanzu-mission-control">Applying Antrea policies using TMC - Tanzu Mission Control</a>
      <ul>
        <li><a href="#preparing-tmc">Preparing TMC</a></li>
        <li><a href="#git-repository">Git repository</a></li>
        <li><a href="#tmc-kustomization">TMC Kustomization</a></li>
        <li><a href="#deploy-tkc-cluster-from-tmc---auto-apply-security-policies">Deploy TKC cluster from TMC - auto apply security policies</a></li>
      </ul>
    </li>
    <li><a href="#applying-antrea-policies-with-nsx">Applying Antrea policies with NSX</a>
      <ul>
        <li><a href="#applying-antrea-native-policies-from-the-nsx-manager">Applying Antrea native policies from the NSX manager</a></li>
        <li><a href="#applying-kubernetes-related-policies-using-inventory-information-from-antrea">Applying Kubernetes related policies using inventory information from Antrea</a></li>
      </ul>
    </li>
    <li><a href="#rbac---making-sure-no-one-can-overwriteoverride-existing-rules">RBAC - making sure no one can overwrite/override existing rules.</a></li>
    <li><a href="#outro">Outro&hellip;</a></li>
  </ul>
</nav>
  </div>
</details>

<script>

  var margin = 200;
  var marginError = 50;

  (function () {
    var $window = $(window);
    var $toc = $('#TOCView');
    var tocHeight = $toc.height();

    function onResize() {
      var windowAndMarginHeight = $window.height() - margin;
      if(tocHeight >= windowAndMarginHeight) {
        $toc.css("overflow-y", "scroll")
        $toc.css("max-height", (windowAndMarginHeight + marginError) + "px")
      } else {
        $toc.css("overflow-y", "hidden")
        $toc.css("max-height", "9999999px")
      }
    }

    $window.on('resize', onResize);
    $(document).ready(onResize);
  })();



  (function () {
    var $toc = $('#TableOfContents');
    if ($toc.length > 0) {
      var $window = $(window);

      function onScroll() {
        var currentScroll = $window.scrollTop();
        var h = $('.anchor');
        var id = "";
        h.each(function (i, e) {
          e = $(e);
          if (e.offset().top - $(window).height()/3 <= currentScroll) {
            id = decodeURIComponent(e.attr('id'));
          }
        });
        var active = $toc.find('a.active');      
        if (active.length == 1 && active.eq(0).attr('href') == '#' + id) return true;

        active.each(function (i, e) {
          
            $(e).removeClass('active');
          
        });
        $toc.find('a[href="#' + id + '"]').addClass('active')
        $toc.find('a[href="#' + id + '"]').parentsUntil('#TableOfContents').each(function (i, e) {
          $(e).children('a').parents('ul').show();          
        });
      }

      $window.on('scroll', onScroll);
      $(document).ready(function () {
        
        onScroll();
      });
    }
  })();


</script>
   </div>
      </div>
      

      <div class="min-w-0 min-h-0 max-w-fit">
        
        


        <div class="article-content max-w-prose mb-20">
          

<h1 class="relative group">Some context&hellip; 
    <div id="some-context" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#some-context" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<p>I have written a couple of post previously on the topic Antrea Policies, this time I will try to put it more into a context, how we can use and create Antrea Policies in different scenarios and with some &ldquo;frameworks&rdquo; from different perspectives in the organization.</p>
<p>What if, and how, can we deliver a already secured Kubernetes cluster, like an out of the box experience, with policies applied that meets certain guidelines for what is allowed and not allowed in the organization for certain Kubernetes clusters. Whether they are manually provisioned, or provisined on demand. So in this post a will try to be a bit specific on how to achieve this, with a simulated requirement as context, will get back to this context a further down. The following products will be used in this post: vSphere with Tanzu and TKG workload clusters, Antrea as the CNI, Tanzu Mission Control and VMware NSX.</p>
<p>As usual, for more details on the above mentioned product head over to the below links</p>
<ul>
<li><a href="https://antrea.io/" target="_blank">Antrea</a> for detailed and updated documentation.</li>
<li><a href="https://docs.vmware.com/en/VMware-vSphere/index.html" target="_blank">vSphere with Tanzu</a> for detailed and updated documentation.</li>
<li><a href="https://docs.vmware.com/en/VMware-Tanzu-Mission-Control/index.html" target="_blank">Tanzu Mission Control</a> for detailed and updated documentation.</li>
<li><a href="https://docs.vmware.com/en/VMware-NSX/index.html" target="_blank">VMware NSX</a> for detailed and updated documentation.</li>
</ul>


<h2 class="relative group">Different layers of security, different personas, different enforcement points 
    <div id="different-layers-of-security-different-personas-different-enforcement-points" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#different-layers-of-security-different-personas-different-enforcement-points" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>This post will mostly be focusing in on the Kubernetes perspective, using specifically Antrea Network policies to restrict traffic inside the Kubernetes cluster. A Kubernetes cluster is just one infrastructure component in the organization, but contains many moving parts with applications and services inside. Even inside a Kubernetes cluster there can be different classifications for what should be allowed and not. Therefore a Kubernetes cluster is also in need to be to be secured with a set of tools and policies to satisfy the security policy guidelines in the organization. A Kubernetes cluster is another layer in the infrastructure that needs to be controlled. In a typical datacenter we have several security mechanisms in place like AV agents, physical firewall, virtual firewall, NSX distributed firewall. All these play an important role in the different layers of the datacenter/organization. Assuming the Kubernetes worker nodes are running as virtual machines on VMware vSphere the below illustration describes two layers of security using NSX distributed firewall securing the VM workers, and Antrea Network Policies securing pods, services inside the Kubernetes cluster.</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230628155554248.png"
        alt="two-layers"
      />
      
    </figure>
</p>
<p>With the illustration above in mind it is fully possible to create a very strict environment with no unwanted lateral movement. Meaning only the strict necessary firewall openings inside the kubernetes cluster between pods, namespaces and services, but also between workers in same subnet and across several several Kubernetes clusters. But the above two layers, VMs in vSphere protected by the NSX distributed firewall and apps running Kubernetes clusters and protected by Antrea Network policies, are often managed by different personas in the organization. We have the vSphere admins, Network admins, Security Admins, App Operators and App Developers. Security is crucial in a modern datacenter, so, again, the correct tools needs to be in place for the organization&rsquo;s security-framework to be implemented all the way down the &ldquo;stack&rdquo; to be compliant. Very often there is a decided theoretical security framework/design in place, but that plan is not always so straightforward to implement.</p>
<p>Going back to Kubernetes again and Antrea Network policies. Antrea feature several static (and optional custom) <a href="https://antrea.io/docs/v1.12.0/docs/antrea-network-policy/#tier" target="_blank">Tiers</a> where different types of network policies can be applied. As all the Antrea Network policies are evaluated &ldquo;top-down&rdquo; it is very handy to be able to place some strict rules very early in the &ldquo;chain&rdquo; of firewall policies to ensure the organization&rsquo;s security compliance is met. Being able to place these rules at the top prohibits the creation of rules further down that contradicts these top rules, they will not be evaluated. Then there is room to create a framework that gives some sense of &ldquo;flexibility&rdquo; to support the environment&rsquo;s workload according to the type of classification (prod, dev, test, dmz, trust, untrust). Other policies can be applied to further restrict movement before hitting a default block rule that takes care of anything that is not specified earlier in the &ldquo;chain&rdquo; of policies. The illustration below is an example of whom and where these personas can take charge and apply their needed policies.</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230628151139497.png"
        alt="personas"
      />
      
    </figure>
</p>
<p>Then the next illustration is the default Static Tiers that comes with Antrea. These Tiers makes it easier to categorize the different policies in a Kubernetes cluster, but also provides a great way to delegate responsibility/permissions by using RBAC to control access to the Tiers. This means we can have some admins to apply policies in specific Tiers, and no one else can overwrite these.</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230628150747847.png"
        alt="tiers"
      />
      
    </figure>
</p>
<p>Now, how can the different personas make sure their policies are applied? This is what I will go through next.</p>


<h2 class="relative group">Managing and making sure the required Antrea Policies are applied 
    <div id="managing-and-making-sure-the-required-antrea-policies-are-applied" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#managing-and-making-sure-the-required-antrea-policies-are-applied" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>Lets start out by bringing some light on the simulated requirement I mentioned above. Customer Andreas have some strict security guidelines they need to follow to ensure compliance before anyone can do anything in the Kubernetes platforms.
To be compliant according to the strict security guidelines the following must be in place:</p>
<ul>
<li>All Kubernetes workload clusters are considered isolated and not allowed to reach nothing more than themselves, including pods and services (all nodes in the same cluster)</li>
<li>Only necessary backend functions such as DNS/NTP are allowed.</li>
<li>Certain management tools need access to the clusters</li>
<li>All non-system namespaces should be considered &ldquo;untrusted&rdquo; and isolated by default.</li>
<li>RBAC needs to be in place to ensure no tampering on applied security policies.</li>
</ul>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230629094638744.png"
        alt="lock-down"
      />
      
    </figure>
</p>
<p>The above diagram is what customer Andreas needs to have in place. Lets go ahead and apply them. In the next sub-chapters I will show how to apply and manage the policies in three different ways to acheive this. I assume the NSX personas has done their part and applied the correct distributed firewall rules isolating the worker nodes.</p>


<h2 class="relative group">Applying Antrea policies with kubectl 
    <div id="applying-antrea-policies-with-kubectl" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#applying-antrea-policies-with-kubectl" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>This process involves logging into a newly provisioned Kubernetes cluster (TKG cluster in my environment) that someone has provisioned, could be the vSphere admin persona, or via a self-service. Then the security admin will be using <em>kubectl</em> to log in and apply some yaml definitions to acheive the above requirements. This operation will typically be the security admin responsibilities. The definitions the security admin is applying will all be configured in the static Tier &ldquo;<em>securityops</em>&rdquo; with different priorities.
Here is the demo-environment I will be using in the following chapters:

    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230630091314220.png"
        alt="demo-environment"
      />
      
    </figure>
</p>
<p>The first requirement is a &ldquo;no-trust&rdquo; in any non-system namespaces, where I want to achieve full isolation between namespace. No communication from one namespace to another. In the Antrea <a href="https://antrea.io/docs/v1.12.0/docs/antrea-network-policy/" target="_blank">homepage</a> there are several examples, and I will use one of the examples that suits my need perfectly. It looks like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">crd.antrea.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterNetworkPolicy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">strict-ns-isolation-except-system-ns</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">priority</span><span class="p">:</span><span class="w"> </span><span class="m">9</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">tier</span><span class="p">:</span><span class="w"> </span><span class="l">securityops</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">appliedTo</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">namespaceSelector</span><span class="p">:</span><span class="w">          </span><span class="c"># Selects all non-system Namespaces in the cluster</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">matchExpressions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- {<span class="nt">key:  kubernetes.io/metadata.name, operator: NotIn, values</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="l">avi-system,default,kube-node-lease,kube-public,kube-system,secretgen-controller,tanzu-continuousdelivery-resources,tanzu-fluxcd-packageinstalls,tanzu-kustomize-controller,tanzu-source-controller,tkg-system,vmware-system-auth,vmware-system-cloud-provider,vmware-system-csi,vmware-system-tkg,vmware-system-tmc]}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ingress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Pass</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">namespaces</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">match</span><span class="p">:</span><span class="w"> </span><span class="l">Self          </span><span class="w"> </span><span class="c"># Skip ACNP evaluation for traffic from Pods in the same Namespace</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">PassFromSameNS</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Drop</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">namespaceSelector</span><span class="p">:</span><span class="w"> </span>{}<span class="w">   </span><span class="c"># Drop from Pods from all other Namespaces</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">DropFromAllOtherNS</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">egress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Pass</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">namespaces</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">match</span><span class="p">:</span><span class="w"> </span><span class="l">Self          </span><span class="w"> </span><span class="c"># Skip ACNP evaluation for traffic to Pods in the same Namespace</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">PassToSameNS</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Drop</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">namespaceSelector</span><span class="p">:</span><span class="w"> </span>{}<span class="w">   </span><span class="c"># Drop to Pods from all other Namespaces</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">DropToAllOtherNS</span><span class="w">
</span></span></span></code></pre></div><p>The only modifications I have done is adding all my system-namespaces.
Then I will apply it.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># Verifying no policies in place:</span>
</span></span><span class="line"><span class="cl">andreasm@linuxvm01:~/antrea/policies/groups$ k get acnp
</span></span><span class="line"><span class="cl">No resources found
</span></span><span class="line"><span class="cl">andreasm@linuxvm01:~/antrea/policies/groups$ k apply -f acnp-ns-isolation-except-system-ns.yaml
</span></span><span class="line"><span class="cl">clusternetworkpolicy.crd.antrea.io/strict-ns-isolation-except-system-ns created
</span></span><span class="line"><span class="cl">andreasm@linuxvm01:~/antrea/policies/groups$ k get acnp
</span></span><span class="line"><span class="cl">NAME                                   TIER          PRIORITY   DESIRED NODES   CURRENT NODES   AGE
</span></span><span class="line"><span class="cl">strict-ns-isolation-except-system-ns   securityops   <span class="m">9</span>          <span class="m">0</span>               <span class="m">0</span>               15s
</span></span></code></pre></div><p>Notice the 0 under <em>Desired Nodes</em> and <em>Current Nodes</em>. The reason is that this cluster is completely new, and there is no workload in any non-system namespaces yet. Here are the current namespaces:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@linuxvm01:~/antrea/policies/groups$ k get ns
</span></span><span class="line"><span class="cl">NAME                                 STATUS   AGE
</span></span><span class="line"><span class="cl">default                              Active   28d
</span></span><span class="line"><span class="cl">kube-node-lease                      Active   28d
</span></span><span class="line"><span class="cl">kube-public                          Active   28d
</span></span><span class="line"><span class="cl">kube-system                          Active   28d
</span></span><span class="line"><span class="cl">secretgen-controller                 Active   28d
</span></span><span class="line"><span class="cl">tkg-system                           Active   28d
</span></span><span class="line"><span class="cl">vmware-system-auth                   Active   28d
</span></span><span class="line"><span class="cl">vmware-system-cloud-provider         Active   28d
</span></span><span class="line"><span class="cl">vmware-system-csi                    Active   28d
</span></span><span class="line"><span class="cl">vmware-system-tkg                    Active   28d
</span></span></code></pre></div><p>Now if I apply a couple of namespaces and deploy some workload in them:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@linuxvm01:~/antrea/policies/groups$ k apply -f dev-app.yaml -f dev-app2.yaml
</span></span><span class="line"><span class="cl">namespace/dev-app created
</span></span><span class="line"><span class="cl">deployment.apps/ubuntu-20-04 created
</span></span><span class="line"><span class="cl">namespace/dev-app2 created
</span></span><span class="line"><span class="cl">deployment.apps/ubuntu-dev-app2 created
</span></span></code></pre></div><p>How does the policy look like now?</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@linuxvm01:~/antrea/policies/groups$ k get acnp
</span></span><span class="line"><span class="cl">NAME                                   TIER          PRIORITY   DESIRED NODES   CURRENT NODES   AGE
</span></span><span class="line"><span class="cl">strict-ns-isolation-except-system-ns   securityops   <span class="m">9</span>          <span class="m">1</span>               <span class="m">1</span>               6s
</span></span><span class="line"><span class="cl"><span class="c1"># Why only one</span>
</span></span><span class="line"><span class="cl">andreasm@linuxvm01:~/antrea/policies/groups$ k get pods -n dev-app -owide
</span></span><span class="line"><span class="cl">NAME                            READY   STATUS    RESTARTS   AGE   IP            NODE                                                      NOMINATED NODE   READINESS GATES
</span></span><span class="line"><span class="cl">ubuntu-20-04-548545fc87-t2lg2   1/1     Running   <span class="m">0</span>          82s   20.20.3.216   three-zone-cluster-1-node-pool-3-6r8c2-6c8d48656c-wntwc   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">andreasm@linuxvm01:~/antrea/policies/groups$ k get pods -n dev-app2 -owide
</span></span><span class="line"><span class="cl">NAME                               READY   STATUS    RESTARTS   AGE   IP            NODE                                                      NOMINATED NODE   READINESS GATES
</span></span><span class="line"><span class="cl">ubuntu-dev-app2-564f46785c-g8vb6   1/1     Running   <span class="m">0</span>          86s   20.20.3.215   three-zone-cluster-1-node-pool-3-6r8c2-6c8d48656c-wntwc   &lt;none&gt;           &lt;none&gt;
</span></span></code></pre></div><p>Both workloads ended up on same node&hellip;</p>
<p>So far so good. Now I need to verify if it is actually enforcing anything. From one of the dev-app pods I will execute into bash and try ping another pod in one for the system-namespaces, a pod in the the other dev-app namespace and try to a dns lookup.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@linuxvm01:~/antrea/policies/groups$ k <span class="nb">exec</span> -it -n dev-app ubuntu-20-04-548545fc87-t2lg2 bash
</span></span><span class="line"><span class="cl">kubectl <span class="nb">exec</span> <span class="o">[</span>POD<span class="o">]</span> <span class="o">[</span>COMMAND<span class="o">]</span> is DEPRECATED and will be removed in a future version. Use kubectl <span class="nb">exec</span> <span class="o">[</span>POD<span class="o">]</span> -- <span class="o">[</span>COMMAND<span class="o">]</span> instead.
</span></span><span class="line"><span class="cl">root@ubuntu-20-04-548545fc87-t2lg2:/# ping 20.20.1.7
</span></span><span class="line"><span class="cl">PING 20.20.1.7 <span class="o">(</span>20.20.1.7<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
</span></span><span class="line"><span class="cl">^C
</span></span><span class="line"><span class="cl">--- 20.20.1.7 ping statistics ---
</span></span><span class="line"><span class="cl"><span class="m">170</span> packets transmitted, <span class="m">0</span> received, 100% packet loss, <span class="nb">time</span> 173033ms
</span></span></code></pre></div><p>The ping above was from my dev-app pod to the <em>coredns</em> pod in kube-system.
Ping to the other dev-app pod in the other dev-app namespace.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root@ubuntu-20-04-548545fc87-t2lg2:/# ping 20.20.3.215
</span></span><span class="line"><span class="cl">PING 20.20.3.215 <span class="o">(</span>20.20.3.215<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
</span></span><span class="line"><span class="cl">^C
</span></span><span class="line"><span class="cl">--- 20.20.3.215 ping statistics ---
</span></span><span class="line"><span class="cl"><span class="m">9</span> packets transmitted, <span class="m">0</span> received, 100% packet loss, <span class="nb">time</span> 8181ms
</span></span></code></pre></div><p>Is also blocked.</p>
<p>Now DNS lookup:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root@ubuntu-20-04-548545fc87-t2lg2:/# ping google.com
</span></span><span class="line"><span class="cl">ping: google.com: Temporary failure in name resolution
</span></span><span class="line"><span class="cl"><span class="c1">#So much empty</span>
</span></span></code></pre></div><p>DNS was also one of the requirements, so I will have to fix this also. I mean, the security admin will have to fix this otherwise going to lunch will not be such a great place to be&hellip;</p>
<p>As the security admin have applied the above policy in the securityops tier with a priority of 9 he need to open up for DNS with policies in a higher tier or within same tier with a lower priority number (lower equals higher priority).</p>
<p>This is the policy he needs to apply:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">crd.antrea.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterNetworkPolicy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">allow-all-egress-dns-service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">priority</span><span class="p">:</span><span class="w"> </span><span class="m">8</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">tier</span><span class="p">:</span><span class="w"> </span><span class="l">securityops</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">appliedTo</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">namespaceSelector</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#        matchLabels:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#          k8s-app: kube-dns</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">egress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Allow</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">toServices</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">kube-dns</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-system</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;allowdnsegress-service&#34;</span><span class="w">
</span></span></span></code></pre></div><p>A simple one, and the requirement is satisfied. Company Andreas allowed necessay functions such as DNS.. This policy will allow any namespace to reach the <em>kube-dns</em> service.</p>
<p>The rule applied:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@linuxvm01:~/antrea/policies/groups$ k get acnp
</span></span><span class="line"><span class="cl">NAME                                   TIER          PRIORITY   DESIRED NODES   CURRENT NODES   AGE
</span></span><span class="line"><span class="cl">allow-all-egress-dns-service           securityops   <span class="m">8</span>          <span class="m">4</span>               <span class="m">4</span>               2m24s
</span></span><span class="line"><span class="cl">strict-ns-isolation-except-system-ns   securityops   <span class="m">9</span>          <span class="m">1</span>               <span class="m">1</span>               24m
</span></span></code></pre></div><p>What about DNS lookup now:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root@ubuntu-20-04-548545fc87-t2lg2:/# ping google.com
</span></span><span class="line"><span class="cl">PING google.com <span class="o">(</span>172.217.12.110<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
</span></span><span class="line"><span class="cl"><span class="m">64</span> bytes from 172.217.12.110 <span class="o">(</span>172.217.12.110<span class="o">)</span>: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">105</span> <span class="nv">time</span><span class="o">=</span>33.0 ms
</span></span><span class="line"><span class="cl"><span class="m">64</span> bytes from 172.217.12.110 <span class="o">(</span>172.217.12.110<span class="o">)</span>: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">2</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">104</span> <span class="nv">time</span><span class="o">=</span>29.8 ms
</span></span><span class="line"><span class="cl"><span class="m">64</span> bytes from 172.217.12.110 <span class="o">(</span>172.217.12.110<span class="o">)</span>: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">3</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">105</span> <span class="nv">time</span><span class="o">=</span>30.2 ms
</span></span><span class="line"><span class="cl"><span class="m">64</span> bytes from 172.217.12.110 <span class="o">(</span>172.217.12.110<span class="o">)</span>: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">4</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">104</span> <span class="nv">time</span><span class="o">=</span>30.3 ms
</span></span><span class="line"><span class="cl"><span class="m">64</span> bytes from 172.217.12.110 <span class="o">(</span>172.217.12.110<span class="o">)</span>: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">5</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">105</span> <span class="nv">time</span><span class="o">=</span>30.4 ms
</span></span><span class="line"><span class="cl">^C
</span></span><span class="line"><span class="cl">--- google.com ping statistics ---
</span></span><span class="line"><span class="cl"><span class="m">5</span> packets transmitted, <span class="m">5</span> received, 0% packet loss, <span class="nb">time</span> 4003ms
</span></span><span class="line"><span class="cl">rtt min/avg/max/mdev <span class="o">=</span> 29.763/30.733/32.966/1.138 ms
</span></span></code></pre></div><p>Works.</p>
<p>Thats one more requirement met. Now one of the requirements was also to restrict access to services in other kubernetes clusters. Even though we trust that the NSX admins have created these isolation rules for us we need to make sure we are not allowed from the current kubernetes cluster also.</p>
<p>So to acheive this the security admin needs to create <em>ClusterGroup</em> containing the CIDR for its own worker nodes. Then apply a policy using the ClusterGroup.
Here is the ClusterGroup definition (containing the cidr for the worker nodes):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">crd.antrea.io/v1alpha3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterGroup</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tz-cluster-1-node-cidr</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># ipBlocks cannot be set along with podSelector, namespaceSelector or serviceReference.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ipBlocks</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">cidr</span><span class="p">:</span><span class="w"> </span><span class="m">10.101.82.32</span><span class="l">/27</span><span class="w">
</span></span></span></code></pre></div><p>And I also need to define another ClusterGroup for all the RFC1918 subnets I need to block (this will include the cidr above):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">crd.antrea.io/v1alpha3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterGroup</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tz-cluster-1-drop-cidr</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># ipBlocks cannot be set along with podSelector, namespaceSelector or serviceReference.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ipBlocks</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">cidr</span><span class="p">:</span><span class="w"> </span><span class="m">10.0.0.0</span><span class="l">/8</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">cidr</span><span class="p">:</span><span class="w"> </span><span class="m">172.16.0.0</span><span class="l">/12</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">cidr</span><span class="p">:</span><span class="w"> </span><span class="m">192.168.0.0</span><span class="l">/16</span><span class="w">
</span></span></span></code></pre></div><p>Apply them:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@linuxvm01:~/antrea/policies/groups$ k apply -f tz-cluster-1-group-node-cidr.yaml
</span></span><span class="line"><span class="cl">clustergroup.crd.antrea.io/tz-cluster-1-node-cidr created
</span></span><span class="line"><span class="cl">andreasm@linuxvm01:~/antrea/policies/groups$ k apply -f tz-cluster-1-drop-cidr.yaml
</span></span><span class="line"><span class="cl">clustergroup.crd.antrea.io/tz-cluster-1-drop-cidr created
</span></span><span class="line"><span class="cl">andreasm@linuxvm01:~/antrea/policies/groups$ k get clustergroup
</span></span><span class="line"><span class="cl">NAME                     AGE
</span></span><span class="line"><span class="cl">tz-cluster-1-drop-cidr   6s
</span></span><span class="line"><span class="cl">tz-cluster-1-node-cidr   5s
</span></span></code></pre></div><p>And the policy to deny anything except the own kubernetes worker nodes:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">crd.antrea.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterNetworkPolicy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">acnp-drop-except-own-cluster-node-cidr</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">priority</span><span class="p">:</span><span class="w"> </span><span class="m">8</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">tier</span><span class="p">:</span><span class="w"> </span><span class="l">securityops</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">appliedTo</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">namespaceSelector</span><span class="p">:</span><span class="w">          </span><span class="c"># Selects all non-system Namespaces in the cluster</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">matchExpressions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- {<span class="nt">key:  kubernetes.io/metadata.name, operator: NotIn, values</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="l">avi-system,default,kube-node-lease,kube-public,kube-system,secretgen-controller,tanzu-continuousdelivery-resources,tanzu-fluxcd-packageinstalls,tanzu-kustomize-controller,tanzu-source-controller,tkg-system,vmware-system-auth,vmware-system-cloud-provider,vmware-system-csi,vmware-system-tkg,vmware-system-tmc]}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">egress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Allow</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">group</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;tz-cluster-1-node-cidr&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Drop</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">group</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;tz-cluster-1-drop-cidr&#34;</span><span class="w">
</span></span></span></code></pre></div><p>Applied:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@linuxvm01:~/antrea/policies/groups$ k apply -f tz-cluster-1-drop-anything-but-own-nodes.yaml
</span></span><span class="line"><span class="cl">clusternetworkpolicy.crd.antrea.io/acnp-drop-except-own-cluster-node-cidr created
</span></span><span class="line"><span class="cl">andreasm@linuxvm01:~/antrea/policies/groups$ k get acnp
</span></span><span class="line"><span class="cl">NAME                                     TIER          PRIORITY   DESIRED NODES   CURRENT NODES   AGE
</span></span><span class="line"><span class="cl">acnp-drop-except-own-cluster-node-cidr   securityops   <span class="m">8</span>          <span class="m">1</span>               <span class="m">1</span>               3m39s
</span></span><span class="line"><span class="cl">allow-all-egress-dns-service             securityops   <span class="m">8</span>          <span class="m">4</span>               <span class="m">4</span>               28m
</span></span><span class="line"><span class="cl">strict-ns-isolation-except-system-ns     securityops   <span class="m">9</span>          <span class="m">1</span>               <span class="m">1</span>               50m
</span></span></code></pre></div><p>From the dev-app pod again I will verify if I am allowed to SSH to a worker node in &ldquo;own&rdquo; Kubernetes cluster, and another Linux machine not in the ClusterGroup cidr I have applied.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root@ubuntu-20-04-548545fc87-t2lg2:/# ssh vmware-system-user@10.101.82.34 <span class="c1">#A worker node in the current k8s cluster</span>
</span></span><span class="line"><span class="cl">vmware-system-user@10.101.82.34<span class="err">&#39;</span>s password:
</span></span><span class="line"><span class="cl"><span class="c1">#This is allowed</span>
</span></span><span class="line"><span class="cl">What about other machines outside the cidr:
</span></span><span class="line"><span class="cl">root@ubuntu-20-04-548545fc87-t2lg2:/# ssh 10.101.10.99
</span></span><span class="line"><span class="cl">ssh: connect to host 10.101.10.99 port 22: Connection timed out
</span></span></code></pre></div><p>That is very close to achieving this requirement also, but I should be allowed to reach pods inside same namespace regardless of which node they reside on.
Here are my dev-app namespace with pods on all three nodes:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@linuxvm01:~/antrea/policies/groups$ k get pods -n dev-app -o wide
</span></span><span class="line"><span class="cl">NAME                            READY   STATUS    RESTARTS   AGE    IP            NODE                                                      NOMINATED NODE   READINESS GATES
</span></span><span class="line"><span class="cl">ubuntu-20-04-548545fc87-75nsm   1/1     Running   <span class="m">0</span>          116s   20.20.2.35    three-zone-cluster-1-node-pool-2-kbzvq-6846d5cc5b-6hdmj   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">ubuntu-20-04-548545fc87-hhnv2   1/1     Running   <span class="m">0</span>          116s   20.20.1.14    three-zone-cluster-1-node-pool-1-dgcpq-656c75f4f4-nsr2r   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">ubuntu-20-04-548545fc87-t2lg2   1/1     Running   <span class="m">0</span>          66m    20.20.3.216   three-zone-cluster-1-node-pool-3-6r8c2-6c8d48656c-wntwc   &lt;none&gt;           &lt;none&gt;
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root@ubuntu-20-04-548545fc87-t2lg2:/# ping 20.20.1.14
</span></span><span class="line"><span class="cl">PING 20.20.1.14 <span class="o">(</span>20.20.1.14<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
</span></span><span class="line"><span class="cl"><span class="m">64</span> bytes from 20.20.1.14: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">62</span> <span class="nv">time</span><span class="o">=</span>20.6 ms
</span></span><span class="line"><span class="cl"><span class="m">64</span> bytes from 20.20.1.14: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">2</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">62</span> <span class="nv">time</span><span class="o">=</span>2.87 ms
</span></span><span class="line"><span class="cl">^C
</span></span><span class="line"><span class="cl">--- 20.20.1.14 ping statistics ---
</span></span><span class="line"><span class="cl"><span class="m">2</span> packets transmitted, <span class="m">2</span> received, 0% packet loss, <span class="nb">time</span> 1002ms
</span></span><span class="line"><span class="cl">rtt min/avg/max/mdev <span class="o">=</span> 2.869/11.735/20.601/8.866 ms
</span></span><span class="line"><span class="cl">root@ubuntu-20-04-548545fc87-t2lg2:/# ping 20.20.2.35
</span></span><span class="line"><span class="cl">PING 20.20.2.35 <span class="o">(</span>20.20.2.35<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
</span></span><span class="line"><span class="cl"><span class="m">64</span> bytes from 20.20.2.35: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">62</span> <span class="nv">time</span><span class="o">=</span>3.49 ms
</span></span><span class="line"><span class="cl"><span class="m">64</span> bytes from 20.20.2.35: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">2</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">62</span> <span class="nv">time</span><span class="o">=</span>2.09 ms
</span></span><span class="line"><span class="cl"><span class="m">64</span> bytes from 20.20.2.35: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">3</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">62</span> <span class="nv">time</span><span class="o">=</span>1.00 ms
</span></span><span class="line"><span class="cl">^C
</span></span><span class="line"><span class="cl">--- 20.20.2.35 ping statistics ---
</span></span><span class="line"><span class="cl"><span class="m">3</span> packets transmitted, <span class="m">3</span> received, 0% packet loss, <span class="nb">time</span> 2003ms
</span></span><span class="line"><span class="cl">rtt min/avg/max/mdev <span class="o">=</span> 1.000/2.194/3.494/1.020 ms
</span></span></code></pre></div><p>From the Antrea UI, lets do some tests there also:</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230629140255350.png"
        alt="pod2pod-same-ns"
      />
      
    </figure>
</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230629140345377.png"
        alt="dev-app-to-mgmt-host"
      />
      
    </figure>
</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230629140433183.png"
        alt="dev-app-to-own-node"
      />
      
    </figure>
</p>
<p>Note that I have not created any default-block-all-else-rule. There is always room for improvement, and this was just an excercise to show what is possible, not an final answer on how things should be done. Some of the policies can be even more granular like specifying only ports/protocol/FQDN etc..</p>
<p>So just to summarize what I have done:</p>
<p>These are the applied rules:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">NAME                                     TIER          PRIORITY   DESIRED NODES   CURRENT NODES   AGE
</span></span><span class="line"><span class="cl">acnp-drop-except-own-cluster-node-cidr   securityops   <span class="m">8</span>          <span class="m">3</span>               <span class="m">3</span>               23h
</span></span><span class="line"><span class="cl">allow-all-egress-dns-service             securityops   <span class="m">8</span>          <span class="m">4</span>               <span class="m">4</span>               23h
</span></span><span class="line"><span class="cl">strict-ns-isolation-except-system-ns     securityops   <span class="m">9</span>          <span class="m">3</span>               <span class="m">3</span>               23h
</span></span></code></pre></div><p>The first rule is allowing only traffic to the nodes in its own cluster - matches this requirement &ldquo;<em>All Kubernetes workload clusters are considered isolated and not allowed to reach nothing more than themselves, including pods and services (all nodes in the same cluster)</em>&rdquo;</p>
<p>The second rule is allowing all namespaces to access the <em>kube-dns</em> service in the <em>kube-system</em> namespace - matches this requirement &ldquo;<em>Only necessary backend functions such as DNS/NTP are allowed</em>&rdquo;</p>
<p>The third rule is dropping all traffic between namespaces, except the &ldquo;system&rdquo;-namespaces I have defined. But it allows intra communication inside each namespace - matches this requirement &ldquo;<em>All non-system namespaces should be considered &ldquo;untrusted&rdquo; and isolated by default</em>&rdquo;</p>
<p>Then I have not done anything with RBAC yet, will come later in this post. And the requirement: &ldquo;<em>Certain management tools need access to the clusters</em>&rdquo; I can assume the NSX admins have covered, as I am not blocking any ingress traffic to the &ldquo;system&rdquo;-namespaces, same is true for egress from the system-namespaces. But it could be, if adjusted to allow the necessary traffic from these namespaces to the certain management tools.</p>


<h2 class="relative group">Applying Antrea policies using TMC - Tanzu Mission Control 
    <div id="applying-antrea-policies-using-tmc---tanzu-mission-control" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#applying-antrea-policies-using-tmc---tanzu-mission-control" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>This section will not create any new scenario, it will re-use all the policies created and applied in the above section. The biggest difference is how the policies are being applied.</p>
<p>Not that I dont think any security admin dont want to log in to a Kubernetes cluster and apply these security policies, but it can be a bit tedious each time a new cluster is applied. What wouldnt be better then if we can auto-deploy them each time a new cluster is being deployed? Like an out-of-the-box experience? Yes, excactly. If we already have defined a policy scope for the different Kubernetes cluster in our environment, we could just apply the correct policies to each cluster respectively each time they are provisioned. This saves a lot of time. We can be sure each time a new cluster is provisioned, it is being applied with the correct set of policies. With the abiltiy to auto apply these required policies on creation or directly after creation will make provisioning out-of-the-box compliant clusters a joy.</p>
<p>Now this sounds interesting, how can I do that?</p>
<p>&hellip;.<em>Into the door comes TMC</em>&hellip;. Hello Tanzu Mission Control,  short TMC.
With TMC we can administer Tanzu with vSphere in addition to a lot of other Kubernetes platforms.
From the TMC official <a href="https://docs.vmware.com/en/VMware-Tanzu-Mission-Control/index.html" target="_blank">docs</a> :</p>
<blockquote>
<p>VMware Tanzu Mission Control™ is a centralized management platform for consistently operating and securing your Kubernetes infrastructure and modern applications across multiple teams and clouds.</p>
<p>Available through VMware Cloud™ services, Tanzu Mission Control provides operators with a single control point to give developers the independence they need to drive business forward, while ensuring consistent management and operations across environments for increased security and governance.</p>
<p>Tanzu Mission Control provides instances of the service in regions around the world, including Australia, Canada, India, Ireland, Japan, and USA. For a list of the regions in which the Tanzu Mission Control is hosted, go to the Cloud Management Services Availability page at <a href="https://www.vmware.com/global-infrastructure.html" target="_blank">https://www.vmware.com/global-infrastructure.html</a> and select <strong>VMware Tanzu Mission Control</strong>.</p>
<p>Use Tanzu Mission Control to manage your entire Kubernetes footprint, regardless of where your clusters reside.</p>
</blockquote>
<p>Lets cut to the chase and make my cluster compliant with the above rules.</p>


<h3 class="relative group">Preparing TMC 
    <div id="preparing-tmc" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#preparing-tmc" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>In my TMC dashboard I need two thing in place:</p>
<ul>
<li>A Git repository where I host my yamls, specifically my Antrea policy yamls.</li>
<li>A configured Kustomization using the above Git repo</li>
</ul>


<h3 class="relative group">Git repository 
    <div id="git-repository" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#git-repository" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>I will create a dedicated Git repo called tmc-cd-repo, and a folder structure. Here is my Github repo for this purpose:

    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230630124944270.png"
        alt="github-repo"
      />
      
    </figure>
</p>
<p>Now push the yamls to this repo&rsquo;s subfolder antrea-baseline-policies:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm:~/github_repos/tmc-cd-repo <span class="o">(</span>main<span class="o">)</span>$ git add .
</span></span><span class="line"><span class="cl">andreasm:~/github_repos/tmc-cd-repo <span class="o">(</span>main<span class="o">)</span>$ git commit -s -m <span class="s2">&#34;ready-to-lockdown&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>main 4ab93a7<span class="o">]</span> ready-to-lockdown
</span></span><span class="line"><span class="cl"> <span class="m">4</span> files changed, <span class="m">53</span> insertions<span class="o">(</span>+<span class="o">)</span>
</span></span><span class="line"><span class="cl"> create mode <span class="m">100644</span> antrea/antrea-baseline-policies/acnp-allow-egress-all-coredns-service.yaml
</span></span><span class="line"><span class="cl"> create mode <span class="m">100644</span> antrea/antrea-baseline-policies/tz-cluster-1-drop-anything-but-own-nodes.yaml
</span></span><span class="line"><span class="cl"> create mode <span class="m">100644</span> antrea/antrea-baseline-policies/tz-cluster-1-drop-cidr.yaml
</span></span><span class="line"><span class="cl"> create mode <span class="m">100644</span> antrea/antrea-baseline-policies/tz-cluster-1-group-node-cidr.yaml
</span></span><span class="line"><span class="cl">andreasm:~/github_repos/tmc-cd-repo <span class="o">(</span>main<span class="o">)</span>$ git push
</span></span><span class="line"><span class="cl">Enumerating objects: 11, <span class="k">done</span>.
</span></span><span class="line"><span class="cl">Counting objects: 100% <span class="o">(</span>11/11<span class="o">)</span>, <span class="k">done</span>.
</span></span><span class="line"><span class="cl">Delta compression using up to <span class="m">16</span> threads
</span></span><span class="line"><span class="cl">Compressing objects: 100% <span class="o">(</span>7/7<span class="o">)</span>, <span class="k">done</span>.
</span></span><span class="line"><span class="cl">Writing objects: 100% <span class="o">(</span>8/8<span class="o">)</span>, 1.43 KiB <span class="p">|</span> 733.00 KiB/s, <span class="k">done</span>.
</span></span><span class="line"><span class="cl">Total <span class="m">8</span> <span class="o">(</span>delta 1<span class="o">)</span>, reused <span class="m">0</span> <span class="o">(</span>delta 0<span class="o">)</span>, pack-reused <span class="m">0</span>
</span></span><span class="line"><span class="cl">remote: Resolving deltas: 100% <span class="o">(</span>1/1<span class="o">)</span>, <span class="k">done</span>.
</span></span><span class="line"><span class="cl">To github.com:andreasm80/tmc-cd-repo.git
</span></span><span class="line"><span class="cl">   5c9ba04..4ab93a7  main -&gt; main
</span></span><span class="line"><span class="cl">andreasm:~/github_repos/tmc-cd-repo <span class="o">(</span>main<span class="o">)</span>$
</span></span></code></pre></div><p>And here they are:</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230630125806028.png"
        alt="repo-updated"
      />
      
    </figure>
</p>


<h3 class="relative group">TMC Kustomization 
    <div id="tmc-kustomization" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#tmc-kustomization" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>Now in my TMC dashboard configure Git repo:</p>
<p>I can choose to add the Git repo per cluster that is managed by TMC or in a cluster group. I will go with adding the Git repo on my cluster called <em>three-zone-cluster-1</em> for the moment. The benefit with adding it at the group is that it can be shared across multiple clusters.
In TMC click Clusters and find your already managed and added cluster then click on it to &ldquo;enter it&rdquo;.</p>
<p>In your cluster group click on the tab Add-ons

    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230630132329611.png"
        alt="cluster-add-on"
      />
      
    </figure>
</p>
<p>Then find Git repositories and Add Git Repository

    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230630132404595.png"
        alt="add-git-repo"
      />
      
    </figure>
</p>
<p>Fill in the needed fields. Make sure to expand advanced settings to update the branch to your branch or main branch. Can also adjust the sync intervall to higher or smaller. Default is 5, I have sat mine to 1. The repository url points to the actual repository, no subfolders. This is because in the Kustomization later we can have multiple pointing to the respective subfolder which can then be unique pr cluster etc. Make sure you also choose &ldquo;no credentials needed&rdquo; under Repository Credentials if using a public Git repo as I am.

    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230630132058076.png"
        alt="add-git-repo"
      />
      
    </figure>
</p>
<p>After save you should see a green status:

    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230630132255751.png"
        alt="git-status"
      />
      
    </figure>
</p>
<p>Now, we need to add a Kustomization. This can also be done in either a group or pr cluster. I will start with adding it directly to my specific cluster.
In TMC click Cluster and select your cluster.

    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230630131251487.png"
        alt="kustomization-cluster"
      />
      
    </figure>
</p>
<p>Click Add-ons, Under Continuous Delivery click Installed Kustomizations. Add Kustomization.</p>
<p>Before I add my Kustomization, I have made sure I have deleted all the policies and groups in my test-cluster three-zone-cluster-1:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@linuxvm01:~/antrea/policies/groups$ k get acnp
</span></span><span class="line"><span class="cl">No resources found
</span></span><span class="line"><span class="cl">andreasm@linuxvm01:~/antrea/policies/groups$ k get clustergroups
</span></span><span class="line"><span class="cl">No resources found
</span></span></code></pre></div><p>Then I will continue and add the Kustomization:</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230630132652814.png"
        alt="add-kustomization"
      />
      
    </figure>
</p>
<p>Make sure to point to the correct subfolder in the Git repo. I have enabled the Prune option so I everything deployed via Kustomization will be deleted in my cluster if I decide to remove the Kustomization.</p>
<p>Click add.</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230630132840113.png"
        alt="added-kustomization"
      />
      
    </figure>
</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230630132901517.png"
        alt="Succeeded"
      />
      
    </figure>
</p>
<p>Click refresh in the top right corner, and it should be green. Lets check the policies and groups in the cluster itself..</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@linuxvm01:~/antrea/policies/groups$ k get acnp
</span></span><span class="line"><span class="cl">NAME                                     TIER          PRIORITY   DESIRED NODES   CURRENT NODES   AGE
</span></span><span class="line"><span class="cl">acnp-drop-except-own-cluster-node-cidr   securityops   <span class="m">8</span>          <span class="m">3</span>               <span class="m">3</span>               70s
</span></span><span class="line"><span class="cl">allow-all-egress-dns-service             securityops   <span class="m">8</span>          <span class="m">4</span>               <span class="m">4</span>               70s
</span></span><span class="line"><span class="cl">strict-ns-isolation-except-system-ns     securityops   <span class="m">9</span>          <span class="m">3</span>               <span class="m">3</span>               70s
</span></span><span class="line"><span class="cl">andreasm@linuxvm01:~/antrea/policies/groups$ k get clustergroups
</span></span><span class="line"><span class="cl">NAME                     AGE
</span></span><span class="line"><span class="cl">tz-cluster-1-drop-cidr   73s
</span></span><span class="line"><span class="cl">tz-cluster-1-node-cidr   73s
</span></span></code></pre></div><p>The Antrea Policies have been applied.</p>


<h3 class="relative group">Deploy TKC cluster from TMC - auto apply security policies 
    <div id="deploy-tkc-cluster-from-tmc---auto-apply-security-policies" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#deploy-tkc-cluster-from-tmc---auto-apply-security-policies" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>The above section enabled Kustomization on a already managed TKC cluster in TMC. In this section I will apply a TKC cluster from TMC and let the Antrea policies be automatically be applied.</p>
<p>In TMC I will create two Cluster Groups, one called <em>andreas-dev-clusters</em> and one called <em>andreas-prod-clusters</em>.

    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230703081050116.png"
        alt="cluster-groups"
      />
      
    </figure>
</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230703081118640.png"
        alt="create-cluster-group"
      />
      
    </figure>
</p>
<p>After I have added the two cluster groups I will configure <em>Add-ons</em>. Same as in previous section, adding the the Git reop but this time I will point to the different subfolders I created in my Git repo. I have created two different sub-folders in my Git repo called: <em>tmc-cd-repo/antrea/antrea-baseline-policies/<strong>dev-clusters</strong></em>  and <em>tmc-cd-repo/antrea/antrea-baseline-policies/<strong>prod-clusters</strong></em>. The reason I have done that is because I want the option to apply different Antrea policies for certain clusters, different environments different needs.</p>
<p>Before adding the Git repo on the two new Cluster groups in TMC I need to enable continuous delivere by clicking on this blue button.

    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230703082018478.png"
        alt="enable-cd"
      />
      
    </figure>
</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230703081902496.png"
        alt="git-repo"
      />
      
    </figure>
</p>
<p>The Git repo has been added two both my new cluster groups. Now I just need to add the Kustomization pointing to my new Git repo subfolders <strong>dev-clusters</strong> and <strong>prod-clusters</strong>.</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230703114616638.png"
        alt="prod-clusters-kustomization"
      />
      
    </figure>
</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230703114702832.png"
        alt="dev-cluster-kustomization"
      />
      
    </figure>
</p>
<p>Now the preparations have been done in TMC, it is time to deploy the two TKC clusters from TMC and see if my policies are automatically applied. One &ldquo;prod-cluster&rdquo; and one &ldquo;dev-cluster&rdquo;.</p>
<p>Lets start with the &ldquo;prod-cluster&rdquo;

    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230703093235129.png"
        alt="create-prod-cluster"
      />
      
    </figure>
</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230703093439699.png"
        alt="in-creation"
      />
      
    </figure>
</p>
<p>Creating the dev-cluster

    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230703094140344.png"
        alt="create-dev-cluster-2"
      />
      
    </figure>
</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230703094734549.png"
        alt="dev-cluster-in-progress"
      />
      
    </figure>
</p>
<p>The clusters are ready:

    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230703095237684.png"
        alt="prod-cluster-2"
      />
      
    </figure>
</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230703100106845.png"
        alt="dev-cluster-2-status"
      />
      
    </figure>
</p>
<p>Let us check the sync status of my Kustomizations.
Prod-Cluster Group:

    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230703114938574.png"
        alt="prod-group-applied"
      />
      
    </figure>
</p>
<p>Dev-Cluster Group:

    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230703115015970.png"
        alt="dev-group-applied"
      />
      
    </figure>
</p>
<p>Still applied.</p>
<p>Lets have a look inside the two TKC cluster using kubectl.
Prod-Cluster-2:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@linuxvm01:~/antrea/policies/groups$ k config current-context
</span></span><span class="line"><span class="cl">prod-cluster-2
</span></span><span class="line"><span class="cl">andreasm@linuxvm01:~/antrea/policies/groups$ k get acnp
</span></span><span class="line"><span class="cl">NAME                                                   TIER          PRIORITY   DESIRED NODES   CURRENT NODES   AGE
</span></span><span class="line"><span class="cl">allow-all-egress-dns-service                           securityops   <span class="m">8</span>          <span class="m">2</span>               <span class="m">2</span>               35m
</span></span><span class="line"><span class="cl">prod-clusters-acnp-drop-except-own-cluster-node-cidr   securityops   <span class="m">8</span>          <span class="m">0</span>               <span class="m">0</span>               35m
</span></span><span class="line"><span class="cl">prod-clusters-strict-ns-isolation-except-system-ns     securityops   <span class="m">9</span>          <span class="m">0</span>               <span class="m">0</span>               35m
</span></span></code></pre></div><p>Dev-Cluster-2:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@linuxvm01:~/antrea/policies/groups$ k config current-context
</span></span><span class="line"><span class="cl">dev-cluster-2
</span></span><span class="line"><span class="cl">andreasm@linuxvm01:~/antrea/policies/groups$ k get acnp
</span></span><span class="line"><span class="cl">NAME                                                  TIER          PRIORITY   DESIRED NODES   CURRENT NODES   AGE
</span></span><span class="line"><span class="cl">dev-clusters-strict-ns-isolation-except-system-ns     securityops   <span class="m">9</span>          <span class="m">0</span>               <span class="m">0</span>               45s
</span></span><span class="line"><span class="cl">dev-clusters-acnp-drop-except-own-cluster-node-cidr   securityops   <span class="m">8</span>          <span class="m">0</span>               <span class="m">0</span>               45s
</span></span><span class="line"><span class="cl">dev-clusters-allow-all-egress-dns-service             securityops   <span class="m">8</span>          <span class="m">2</span>               <span class="m">2</span>               45s
</span></span></code></pre></div><p>Thats it then, if I need to change the policies I can just edit policies, git add, commit and push and they will be applied to all clusters in the group.
By enabling this feature in TMC its just all about adding or attaching your clusters in the respective group in TMC and they will automatically get all the needed yamls applied.

    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230703120643394.png"
        alt="add-cluster-tmc"
      />
      
    </figure>
</p>


<h2 class="relative group">Applying Antrea policies with NSX 
    <div id="applying-antrea-policies-with-nsx" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#applying-antrea-policies-with-nsx" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>With NSX one can also manage the native Antrea policies inside each TKC cluster (or any other Kubernetes cluster Antrea supports for that matter). I have written about this <a href="https://blog.andreasm.io/2023/06/01/managing-antrea-in-vsphere-with-tanzu/#integrating-antrea-with-nsx-t" target="_blank">here</a>. NSX can also create security policies &ldquo;outside&rdquo; the TKC cluster by using the inventory information it gets from Antrea and enforce them in the NSX Distributed firewall, a short section on this below.</p>


<h3 class="relative group">Applying Antrea native policies from the NSX manager 
    <div id="applying-antrea-native-policies-from-the-nsx-manager" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#applying-antrea-native-policies-from-the-nsx-manager" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>So in this section I will quickly go through using the same &ldquo;framework&rdquo; as above using NSX as the &ldquo;management-plane&rdquo;.
Just a reminder, we have these three policies:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">NAME                                     TIER          PRIORITY   DESIRED NODES   CURRENT NODES   AGE
</span></span><span class="line"><span class="cl">acnp-drop-except-own-cluster-node-cidr   securityops   <span class="m">8</span>          <span class="m">3</span>               <span class="m">3</span>               23h
</span></span><span class="line"><span class="cl">allow-all-egress-dns-service             securityops   <span class="m">8</span>          <span class="m">4</span>               <span class="m">4</span>               23h
</span></span><span class="line"><span class="cl">strict-ns-isolation-except-system-ns     securityops   <span class="m">9</span>          <span class="m">3</span>               <span class="m">3</span>               23h
</span></span></code></pre></div><p>The first rule is allowing only traffic to the nodes in its own cluster - matches this requirement &ldquo;<em>All Kubernetes workload clusters are considered isolated and not allowed to reach nothing more than themselves, including pods and services (all nodes in the same cluster)</em>&rdquo;</p>
<p>The second rule is allowing all namespaces to access the <em>kube-dns</em> service in the <em>kube-system</em> namespace - matches this requirement &ldquo;<em>Only necessary backend functions such as DNS/NTP are allowed</em>&rdquo;</p>
<p>The third rule is dropping all traffic between namespaces, except the &ldquo;system&rdquo;-namespaces I have defined. But it allows intra communication inside each namespace - matches this requirement &ldquo;<em>All non-system namespaces should be considered &ldquo;untrusted&rdquo; and isolated by default</em>&rdquo;</p>
<p>In NSX I will need to create some Security Groups, then use these groups in a Security Policy. So I will start by creating the Security Group for the concerning kube-dns service:</p>
<p>One can either define the service kube-dns:</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230703124322874.png"
        alt="sg-kube-dns"
      />
      
    </figure>
</p>
<p>Or the pods that is responsible for the DNS service (CoreDNS:</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230703140557678.png"
        alt="dns-pods"
      />
      
    </figure>
</p>
<p>This depends on how we define the policy in NSX. I have gone with the pod selection group.</p>
<p>AS the requirement supports all services to access DNS, I dont have to create a security group for the source. Then the policy will look like this in NSX:</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230703140707117.png"
        alt="dns-policy-all"
      />
      
    </figure>
</p>
<p>Notice also that I have placed the policy in the <em>Infrastructrue</em> Tier in NSX.</p>
<p>This is how it looks like in the Kubernetes clusters:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="l">andreasm@linuxvm01:~/antrea/policies/groups$ k get acnp 933e463e-c061-4e80-80b3-eff3402e41a9 -oyaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">crd.antrea.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterNetworkPolicy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ccp-adapter.antrea.tanzu.vmware.com/display-name</span><span class="p">:</span><span class="w"> </span><span class="l">k8s-core-dns</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2023-06-27T11:15:30Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">generation</span><span class="p">:</span><span class="w"> </span><span class="m">11</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ccp-adapter.antrea.tanzu.vmware.com/managedBy</span><span class="p">:</span><span class="w"> </span><span class="l">ccp-adapter</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">933e463e-c061-4e80-80b3-eff3402e41a9</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resourceVersion</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2248486&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">uid</span><span class="p">:</span><span class="w"> </span><span class="l">a5d7378d-ede0-4f8c-848b-413c10ce5602</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">egress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Allow</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">appliedTo</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">podSelector</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">enableLogging</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2025&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">53</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">53</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">UDP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">group</span><span class="p">:</span><span class="w"> </span><span class="l">c7e96b35-1961-4659-8a62-688a0e98fe63</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">priority</span><span class="p">:</span><span class="w"> </span><span class="m">1.0000000177635693</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">tier</span><span class="p">:</span><span class="w"> </span><span class="l">nsx-category-infrastructure</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">status</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">currentNodesRealized</span><span class="p">:</span><span class="w"> </span><span class="m">4</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">desiredNodesRealized</span><span class="p">:</span><span class="w"> </span><span class="m">4</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">observedGeneration</span><span class="p">:</span><span class="w"> </span><span class="m">11</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">phase</span><span class="p">:</span><span class="w"> </span><span class="l">Realized</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@linuxvm01:~/antrea/policies/groups$ k get tiers
</span></span><span class="line"><span class="cl">NAME                          PRIORITY   AGE
</span></span><span class="line"><span class="cl">application                   <span class="m">250</span>        6d1h
</span></span><span class="line"><span class="cl">baseline                      <span class="m">253</span>        6d1h
</span></span><span class="line"><span class="cl">emergency                     <span class="m">50</span>         6d1h
</span></span><span class="line"><span class="cl">networkops                    <span class="m">150</span>        6d1h
</span></span><span class="line"><span class="cl">nsx-category-application      <span class="m">4</span>          6d
</span></span><span class="line"><span class="cl">nsx-category-emergency        <span class="m">1</span>          6d
</span></span><span class="line"><span class="cl">nsx-category-environment      <span class="m">3</span>          6d
</span></span><span class="line"><span class="cl">nsx-category-ethernet         <span class="m">0</span>          6d
</span></span><span class="line"><span class="cl">nsx-category-infrastructure   <span class="m">2</span>          6d
</span></span><span class="line"><span class="cl">platform                      <span class="m">200</span>        6d1h
</span></span><span class="line"><span class="cl">securityops                   <span class="m">100</span>        6d1h
</span></span></code></pre></div><p>For the next policy, allowing only node in same cluster, I will need to create two groups with &ldquo;ip-blocks&rdquo; containing all RFC1918 in one group and the actual node range in the second:

    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230703141115420.png"
        alt="all-rfc1918"
      />
      
    </figure>
</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230703141312909.png"
        alt="dev-cluster-1-cidr"
      />
      
    </figure>
</p>
<p>The policy in NSX will then look like this:

    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230703145201241.png"
        alt="own-cidr-allow"
      />
      
    </figure>
</p>
<p>This is how it looks like in the Kubernetes clusters:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">crd.antrea.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterNetworkPolicy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ccp-adapter.antrea.tanzu.vmware.com/display-name</span><span class="p">:</span><span class="w"> </span><span class="l">dev-cluster-1-intra</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2023-07-03T12:27:13Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">generation</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ccp-adapter.antrea.tanzu.vmware.com/managedBy</span><span class="p">:</span><span class="w"> </span><span class="l">ccp-adapter</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">17dbadce-06cf-4d1e-9747-3e888f0f58e0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resourceVersion</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2257468&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">uid</span><span class="p">:</span><span class="w"> </span><span class="l">73814a58-2da8-44c2-ba85-2522865430d1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">egress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Allow</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">appliedTo</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">podSelector</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">enableLogging</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2027&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">group</span><span class="p">:</span><span class="w"> </span><span class="l">2051f64c-8c65-46a2-8397-61c926c8c4ce</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Drop</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">appliedTo</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">podSelector</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">enableLogging</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2028&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">group</span><span class="p">:</span><span class="w"> </span><span class="l">5bfc16b1-08f3-48bd-91f9-fee3d66762b1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">priority</span><span class="p">:</span><span class="w"> </span><span class="m">1.000000017763571</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">tier</span><span class="p">:</span><span class="w"> </span><span class="l">nsx-category-infrastructure</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">status</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">currentNodesRealized</span><span class="p">:</span><span class="w"> </span><span class="m">4</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">desiredNodesRealized</span><span class="p">:</span><span class="w"> </span><span class="m">4</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">observedGeneration</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">phase</span><span class="p">:</span><span class="w"> </span><span class="l">Realized</span><span class="w">
</span></span></span></code></pre></div><p>Where the groups contain this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">crd.antrea.io/v1alpha3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterGroup</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ccp-adapter.antrea.tanzu.vmware.com/createdFrom</span><span class="p">:</span><span class="w"> </span><span class="l">nestdbGroupMsg</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ccp-adapter.antrea.tanzu.vmware.com/display-name</span><span class="p">:</span><span class="w"> </span><span class="l">2051f64c-8c65-46a2-8397-61c926c8c4ce</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2023-07-03T12:27:13Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">generation</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ccp-adapter.antrea.tanzu.vmware.com/managedBy</span><span class="p">:</span><span class="w"> </span><span class="l">ccp-adapter</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">2051f64c-8c65-46a2-8397-61c926c8c4ce</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resourceVersion</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2257281&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">uid</span><span class="p">:</span><span class="w"> </span><span class="l">18009c1b-c44f-4c75-a9f2-8a30e2415859</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">childGroups</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">2051f64c-8c65-46a2-8397-61c926c8c4ce-0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">status</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">conditions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">lastTransitionTime</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2023-07-03T12:27:13Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;True&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">GroupMembersComputed</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">andreasm@linuxvm01:~/nsx-antrea-integration$ k get clustergroup 2051f64c-8c65-46a2-8397-61c926c8c4ce-0 -oyaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">crd.antrea.io/v1alpha3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterGroup</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ccp-adapter.antrea.tanzu.vmware.com/createdFrom</span><span class="p">:</span><span class="w"> </span><span class="l">nestdbGroupMsg</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ccp-adapter.antrea.tanzu.vmware.com/display-name</span><span class="p">:</span><span class="w"> </span><span class="l">2051f64c-8c65-46a2-8397-61c926c8c4ce-0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ccp-adapter.antrea.tanzu.vmware.com/parent</span><span class="p">:</span><span class="w"> </span><span class="l">2051f64c-8c65-46a2-8397-61c926c8c4ce</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2023-07-03T12:27:13Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">generation</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ccp-adapter.antrea.tanzu.vmware.com/managedBy</span><span class="p">:</span><span class="w"> </span><span class="l">ccp-adapter</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">2051f64c-8c65-46a2-8397-61c926c8c4ce-0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resourceVersion</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2257278&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">uid</span><span class="p">:</span><span class="w"> </span><span class="l">b1d4a59b-0557-4f6c-a08c-7b76af6bca8c</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ipBlocks</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">cidr</span><span class="p">:</span><span class="w"> </span><span class="m">10.101.84.32</span><span class="l">/27</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">status</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">conditions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">lastTransitionTime</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2023-07-03T12:27:13Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;True&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">GroupMembersComputed</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="l">andreasm@linuxvm01:~/nsx-antrea-integration$ k get clustergroup 5bfc16b1-08f3-48bd-91f9-fee3d66762b1 -oyaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">crd.antrea.io/v1alpha3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterGroup</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ccp-adapter.antrea.tanzu.vmware.com/createdFrom</span><span class="p">:</span><span class="w"> </span><span class="l">nestdbGroupMsg</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ccp-adapter.antrea.tanzu.vmware.com/display-name</span><span class="p">:</span><span class="w"> </span><span class="l">5bfc16b1-08f3-48bd-91f9-fee3d66762b1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2023-07-03T12:27:13Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">generation</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ccp-adapter.antrea.tanzu.vmware.com/managedBy</span><span class="p">:</span><span class="w"> </span><span class="l">ccp-adapter</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">5bfc16b1-08f3-48bd-91f9-fee3d66762b1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resourceVersion</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2257282&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">uid</span><span class="p">:</span><span class="w"> </span><span class="m">6782589e-8488</span>-<span class="l">47df-a750-04432c3c2f18</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">childGroups</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">5bfc16b1-08f3-48bd-91f9-fee3d66762b1-0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">status</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">conditions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">lastTransitionTime</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2023-07-03T12:27:13Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;True&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">GroupMembersComputed</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">andreasm@linuxvm01:~/nsx-antrea-integration$ k get clustergroup 5bfc16b1-08f3-48bd-91f9-fee3d66762b1-0 -oyaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">crd.antrea.io/v1alpha3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterGroup</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ccp-adapter.antrea.tanzu.vmware.com/createdFrom</span><span class="p">:</span><span class="w"> </span><span class="l">nestdbGroupMsg</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ccp-adapter.antrea.tanzu.vmware.com/display-name</span><span class="p">:</span><span class="w"> </span><span class="l">5bfc16b1-08f3-48bd-91f9-fee3d66762b1-0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ccp-adapter.antrea.tanzu.vmware.com/parent</span><span class="p">:</span><span class="w"> </span><span class="l">5bfc16b1-08f3-48bd-91f9-fee3d66762b1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2023-07-03T12:27:13Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">generation</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ccp-adapter.antrea.tanzu.vmware.com/managedBy</span><span class="p">:</span><span class="w"> </span><span class="l">ccp-adapter</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">5bfc16b1-08f3-48bd-91f9-fee3d66762b1-0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resourceVersion</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2257277&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">uid</span><span class="p">:</span><span class="w"> </span><span class="l">fd2a1c32-1cf8-4ca8-8dad-f5420f57e55c</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ipBlocks</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">cidr</span><span class="p">:</span><span class="w"> </span><span class="m">192.168.0.0</span><span class="l">/16</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">cidr</span><span class="p">:</span><span class="w"> </span><span class="m">10.0.0.0</span><span class="l">/8</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">cidr</span><span class="p">:</span><span class="w"> </span><span class="m">172.16.0.0</span><span class="l">/12</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">status</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">conditions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">lastTransitionTime</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2023-07-03T12:27:13Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;True&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">GroupMembersComputed</span><span class="w">
</span></span></span></code></pre></div><p>Now the last rule is blocking all non-system namespaces to any other namespace than themselves.</p>
<p>First I need to create a Security Group with the namespace as sole member, then a Security Group with the criteria not-equals.
Group for the namespace:

    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230703152404669.png"
        alt="ns-dev-app"
      />
      
    </figure>
</p>
<p>Negated Security Group, selecting all pods which does not have the same label as any pods in the namespace &ldquo;dev-app&rdquo;.

    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230703152546054.png"
        alt="negated"
      />
      
    </figure>
</p>
<p>Then the Security Policy looks like this:

    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230703152659459.png"
        alt="policy-strict-ns"
      />
      
    </figure>
</p>
<p>This is how it looks like in the Kubernetes clusters:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">crd.antrea.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterNetworkPolicy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ccp-adapter.antrea.tanzu.vmware.com/display-name</span><span class="p">:</span><span class="w"> </span><span class="l">dev-cluster-strict-ns-islolation</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2023-07-03T13:00:40Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">generation</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ccp-adapter.antrea.tanzu.vmware.com/managedBy</span><span class="p">:</span><span class="w"> </span><span class="l">ccp-adapter</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cfbe3754-c365-4697-b124-5fbaddd87b57</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resourceVersion</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2267847&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">uid</span><span class="p">:</span><span class="w"> </span><span class="m">47949441</span>-<span class="l">a69b-47e5-ae9b-1d5760d5c195</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">egress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Allow</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">appliedTo</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">group</span><span class="p">:</span><span class="w"> </span><span class="l">beed7011-4fc7-49e6-b7ed-d521095eb293</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">enableLogging</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2029&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">group</span><span class="p">:</span><span class="w"> </span><span class="l">beed7011-4fc7-49e6-b7ed-d521095eb293</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">Drop</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">appliedTo</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">group</span><span class="p">:</span><span class="w"> </span><span class="l">beed7011-4fc7-49e6-b7ed-d521095eb293</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">enableLogging</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2030&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">group</span><span class="p">:</span><span class="w"> </span><span class="l">f240efd5-3a95-49d3-9252-058cc80bc0c0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">priority</span><span class="p">:</span><span class="w"> </span><span class="m">1.0000000177635728</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">tier</span><span class="p">:</span><span class="w"> </span><span class="l">nsx-category-infrastructure</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">status</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">currentNodesRealized</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">desiredNodesRealized</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">observedGeneration</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">phase</span><span class="p">:</span><span class="w"> </span><span class="l">Realized</span><span class="w">
</span></span></span></code></pre></div><p>Where the cluster groups look like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="l">andreasm@linuxvm01:~/nsx-antrea-integration$ k get clustergroup beed7011-4fc7-49e6-b7ed-d521095eb293 -oyaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">crd.antrea.io/v1alpha3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterGroup</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ccp-adapter.antrea.tanzu.vmware.com/createdFrom</span><span class="p">:</span><span class="w"> </span><span class="l">nestdbGroupMsg</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ccp-adapter.antrea.tanzu.vmware.com/display-name</span><span class="p">:</span><span class="w"> </span><span class="l">beed7011-4fc7-49e6-b7ed-d521095eb293</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2023-07-03T13:00:40Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">generation</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ccp-adapter.antrea.tanzu.vmware.com/managedBy</span><span class="p">:</span><span class="w"> </span><span class="l">ccp-adapter</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">beed7011-4fc7-49e6-b7ed-d521095eb293</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resourceVersion</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2266125&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">uid</span><span class="p">:</span><span class="w"> </span><span class="l">7bf8d0f4-d719-47d5-98a9-5fba3b5da7b9</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">childGroups</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">beed7011-4fc7-49e6-b7ed-d521095eb293-0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">status</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">conditions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">lastTransitionTime</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2023-07-03T13:00:41Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;True&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">GroupMembersComputed</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">andreasm@linuxvm01:~/nsx-antrea-integration$ k get clustergroup beed7011-4fc7-49e6-b7ed-d521095eb293-0 -oyaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">crd.antrea.io/v1alpha3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterGroup</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ccp-adapter.antrea.tanzu.vmware.com/createdFrom</span><span class="p">:</span><span class="w"> </span><span class="l">nestdbGroupMsg</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ccp-adapter.antrea.tanzu.vmware.com/display-name</span><span class="p">:</span><span class="w"> </span><span class="l">beed7011-4fc7-49e6-b7ed-d521095eb293-0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ccp-adapter.antrea.tanzu.vmware.com/parent</span><span class="p">:</span><span class="w"> </span><span class="l">beed7011-4fc7-49e6-b7ed-d521095eb293</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2023-07-03T13:00:40Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">generation</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ccp-adapter.antrea.tanzu.vmware.com/managedBy</span><span class="p">:</span><span class="w"> </span><span class="l">ccp-adapter</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">beed7011-4fc7-49e6-b7ed-d521095eb293-0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resourceVersion</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2266123&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">uid</span><span class="p">:</span><span class="w"> </span><span class="l">4b393674-981a-488c-a2e2-d794f0b0a312</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespaceSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchExpressions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes.io/metadata.name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l">In</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">values</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">dev-app</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">status</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">conditions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">lastTransitionTime</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2023-07-03T13:00:41Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;True&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">GroupMembersComputed</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="l">andreasm@linuxvm01:~/nsx-antrea-integration$ k get clustergroup f240efd5-3a95-49d3-9252-058cc80bc0c0 -oyaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">crd.antrea.io/v1alpha3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterGroup</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ccp-adapter.antrea.tanzu.vmware.com/createdFrom</span><span class="p">:</span><span class="w"> </span><span class="l">nestdbGroupMsg</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ccp-adapter.antrea.tanzu.vmware.com/display-name</span><span class="p">:</span><span class="w"> </span><span class="l">f240efd5-3a95-49d3-9252-058cc80bc0c0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2023-07-03T13:06:59Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">generation</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ccp-adapter.antrea.tanzu.vmware.com/managedBy</span><span class="p">:</span><span class="w"> </span><span class="l">ccp-adapter</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">f240efd5-3a95-49d3-9252-058cc80bc0c0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resourceVersion</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2267842&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">uid</span><span class="p">:</span><span class="w"> </span><span class="l">cacd1386-a434-4c42-8739-6813dd1d475b</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">childGroups</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">f240efd5-3a95-49d3-9252-058cc80bc0c0-0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">status</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">conditions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">lastTransitionTime</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2023-07-03T13:07:00Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;True&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">GroupMembersComputed</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">andreasm@linuxvm01:~/nsx-antrea-integration$ k get clustergroup f240efd5-3a95-49d3-9252-058cc80bc0c0-0 -oyaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">crd.antrea.io/v1alpha3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterGroup</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ccp-adapter.antrea.tanzu.vmware.com/createdFrom</span><span class="p">:</span><span class="w"> </span><span class="l">nestdbGroupMsg</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ccp-adapter.antrea.tanzu.vmware.com/display-name</span><span class="p">:</span><span class="w"> </span><span class="l">f240efd5-3a95-49d3-9252-058cc80bc0c0-0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ccp-adapter.antrea.tanzu.vmware.com/parent</span><span class="p">:</span><span class="w"> </span><span class="l">f240efd5-3a95-49d3-9252-058cc80bc0c0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2023-07-03T13:06:59Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">generation</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ccp-adapter.antrea.tanzu.vmware.com/managedBy</span><span class="p">:</span><span class="w"> </span><span class="l">ccp-adapter</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">f240efd5-3a95-49d3-9252-058cc80bc0c0-0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resourceVersion</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2269597&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">uid</span><span class="p">:</span><span class="w"> </span><span class="l">bd7f4526-2be9-4a4e-860e-0bb85ea30516</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">podSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchExpressions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">app</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l">NotIn</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">values</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">ubuntu-20-04</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">status</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">conditions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">lastTransitionTime</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2023-07-03T13:07:00Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;True&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">GroupMembersComputed</span><span class="w">
</span></span></span></code></pre></div><p>With all three policies applied, they look like this in the TKC cluster:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@linuxvm01:~/antrea/policies/groups$ k get acnp
</span></span><span class="line"><span class="cl">NAME                                   TIER                          PRIORITY             DESIRED NODES   CURRENT NODES   AGE
</span></span><span class="line"><span class="cl">17dbadce-06cf-4d1e-9747-3e888f0f58e0   nsx-category-infrastructure   1.000000017763571    <span class="m">4</span>               <span class="m">4</span>               18h
</span></span><span class="line"><span class="cl">933e463e-c061-4e80-80b3-eff3402e41a9   nsx-category-infrastructure   1.0000000177635702   <span class="m">4</span>               <span class="m">4</span>               18h
</span></span><span class="line"><span class="cl">cfbe3754-c365-4697-b124-5fbaddd87b57   nsx-category-infrastructure   1.0000000177635728   <span class="m">3</span>               <span class="m">3</span>               17h
</span></span></code></pre></div><p>By using NSX managing the Antrea policies there is also a very easy way to verify if the policies are working or not by using the Traffic Analysis tool in NSX:

    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230703153342301.png"
        alt="nsx-traffic-analysis"
      />
      
    </figure>
</p>
<p>This tools will also inform you of any policies applied by using kubectl inside the cluster, in other words it can also show you policies not created or applied from the NSX manager.</p>
<p>I have applied a Antrea Policy directly in the TKC cluster using kubectl called <em>block-ns-app3-app4</em>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">andreasm@linuxvm01:~/antrea/policies/groups$ k get acnp
</span></span><span class="line"><span class="cl">NAME                                   TIER                          PRIORITY             DESIRED NODES   CURRENT NODES   AGE
</span></span><span class="line"><span class="cl">17dbadce-06cf-4d1e-9747-3e888f0f58e0   nsx-category-infrastructure   1.000000017763571    <span class="m">4</span>               <span class="m">4</span>               20h
</span></span><span class="line"><span class="cl">933e463e-c061-4e80-80b3-eff3402e41a9   nsx-category-infrastructure   1.0000000177635702   <span class="m">4</span>               <span class="m">4</span>               20h
</span></span><span class="line"><span class="cl">block-ns-app3-app4   <span class="c1">#this             securityops                   4                    1               1               3s</span>
</span></span><span class="line"><span class="cl">cfbe3754-c365-4697-b124-5fbaddd87b57   nsx-category-infrastructure   1.0000000177635728   <span class="m">3</span>               <span class="m">3</span>               20h
</span></span></code></pre></div><p>If I do a traceroute from within NSX from a pod in ns Dev-App3 to a pod in ns Dev-App4 and hit this rule, the NSX manager will show me this:

    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230704110828663.png"
        alt="traceflow"
      />
      
    </figure>
</p>
<p>Its clearly doing its job and blocking the traffic, but which rule is it?
Click on EgressMetric, copy the rule id and paste it in the search field in NSX:

    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230704110937455.png"
        alt="policy-id"
      />
      
    </figure>
</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230704111008480.png"
        alt="search"
      />
      
    </figure>
</p>


<h3 class="relative group">Applying Kubernetes related policies using inventory information from Antrea 
    <div id="applying-kubernetes-related-policies-using-inventory-information-from-antrea" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#applying-kubernetes-related-policies-using-inventory-information-from-antrea" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>As mentioned above, NSX can also utilize the information from TKC cluster (or any Kubernetes cluster that uses Antrea) to enforce them in the Distributed firewall. The information NSX is currently:</p>
<ul>
<li>Kubernetes Cluster - Used to create security group containing Kubernetes clusters by name, not used alone but in combination with the below -&gt;</li>
<li>Kubernetes Namespace - Used to create security group containing Kubernetes clusters namespace by name or tag, not used alone but in combination from a Kubernetes cluster defined above.</li>
<li>Kubernetes Service - Used to create security group containing Kubernetes Services  by name or tag, not used alone but in combination with any of the above -&gt;</li>
<li>Kubernetes Ingress - Used to create security group containing Kubernetes Ingresses by name or tag, not used alone but in combination with any of the above Kubernetes Cluster or Kubernetes Namespace.</li>
<li>Antrea Egress - Used to create security group containing Antrea Egress IP in use by name or tag, not used alone but in combination with only Kubernetes Cluster.</li>
<li>Antrea IP Pool - Used to create security group containing Antrea Egress IP Pool by name or tag, not used alone but in combination with only Kubernetes Cluster.</li>
<li>Kubernetes Node - Used to create security group containing Kubernetes Node IPs or POD CIDRs by node IP address or POD CIDR, not used alone but in combination with only Kubernetes Cluster.</li>
<li>Kubernetes Gateway - Used to create security group containing Kubernetes Gateways by name or tag, not used alone but in combination with only Kubernetes Cluster.</li>
</ul>
<p>An example of a Security group in NSX using the contexts above, Kubernetes Cluster with name <em>dev-cluster</em> and Kubernetes Node IP address:

    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230704114000685.png"
        alt="kubernetes-cluster-nodes"
      />
      
    </figure>
</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230704114033192.png"
        alt="kubernets-nodes-dev-cluster-1"
      />
      
    </figure>
</p>
<p>Now, if I want to create a NSX firewall policy isolating two Kubernetes clusters from each other using the constructs above:</p>
<p>I will simply create two security groups like the one above, selection the two different cluster in each group. Then the policy will be like this:</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230704115441922.png"
        alt="policy-blocking-dev1-to-dev2"
      />
      
    </figure>
</p>
<p>Now if I do a traceflow from any node in dev-cluster-1 to any node in dev-cluster-2 it will dropped.</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230704115342329.png"
        alt="traceflow-dev-1-dev-2"
      />
      
    </figure>
</p>
<p>The Firewall Rule ID is:

    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230704115625261.png"
        alt="drop-rule"
      />
      
    </figure>
</p>
<p>With this approach, its very easy to isolate complete clusters from each other with some really simple rules. We could even create a negated rule, saying you are allowed to reach any workers from same cluster but nothing else with one blocking rule (using a negated selection where source is dev-cluster-1 and destination is also dev-cluster-1:

    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230704120342084.png"
        alt="destination-same-source"
      />
      
    </figure>
</p>
<p>The policy:

    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        src="/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/images/image-20230704120437282.png"
        alt="negated"
      />
      
    </figure>
</p>
<p>This is just one rule blocing everything except its own Kubernetes nodes.</p>


<h2 class="relative group">RBAC - making sure no one can overwrite/override existing rules. 
    <div id="rbac---making-sure-no-one-can-overwriteoverride-existing-rules" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#rbac---making-sure-no-one-can-overwriteoverride-existing-rules" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>How to manage RBAC, or Tier Entitlement with Antrea I have already covered <a href="https://blog.andreasm.io/2023/06/01/managing-antrea-in-vsphere-with-tanzu/#antrea-rbac" target="_blank">here</a></p>


<h2 class="relative group">Outro&hellip; 
    <div id="outro" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#outro" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>I have in this post shown three different ways to manage and apply Antrea Network policies. Three different approaches, the first approach was all manual, the second automatic but the policies still needs to be defined. The last one with the NSX manager a bit different approach as not all the Antrea Network policy features are available and some policies have to be defined different. But, the NSX manager can also be used to automate some of the policies by just adding the clusters to existing policies. Then they will be applied at once.</p>
<p>The Antrea policies used and how they are defined in this post is by all means not the final answer or best practice. They were just used as simple examples to have something to &ldquo;work with&rdquo; during this post. As I have mentioned, one could utilise the different tiers to delegate administration of the policies to the right set of responsibilities (security admins, vSphere operators, Dev-ops etc). If the target is zero-trust also inside your TKC clusters, this can be achieved by utilizing the tiers and place a drop-all-else rule dead last in the Antrea policy chain (baseline tier e.g).</p>

          
          
          
        </div>
        
        

        
        
  
  <section class="flex flex-row flex-wrap justify-center pt-4 text-xl">
    
      
      <a
      target="_blank"
      class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800"
      href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://blog.andreasm.io/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/&amp;title=Securing%20Kubernetes%20clusters%20with%20Antrea%20Network%20Policies"
      title="Share on LinkedIn"
      aria-label="Share on LinkedIn"
      >
      

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg>

  </span>


    </a>
      
    
      
      <a
      target="_blank"
      class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800"
      href="https://twitter.com/intent/tweet/?url=https://blog.andreasm.io/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/&amp;text=Securing%20Kubernetes%20clusters%20with%20Antrea%20Network%20Policies"
      title="Tweet on Twitter"
      aria-label="Tweet on Twitter"
      >
      

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8L200.7 275.5 26.8 48H172.4L272.9 180.9 389.2 48zM364.4 421.8h39.1L151.1 88h-42L364.4 421.8z"/></svg>
  </span>


    </a>
      
    
      
      <a
      target="_blank"
      class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800"
      href="https://s2f.kytta.dev/?text=Securing%20Kubernetes%20clusters%20with%20Antrea%20Network%20Policies%20https://blog.andreasm.io/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/"
      title=""
      aria-label=""
      >
      

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48 0 0 0-63.72 28.5-63.72 125.7 0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54 0 0 1-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"/></svg>

  </span>


    </a>
      
    
      
      <a
      target="_blank"
      class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800"
      href="mailto:?body=https://blog.andreasm.io/2023/06/21/securing-kubernetes-clusters-with-antrea-network-policies/&amp;subject=Securing%20Kubernetes%20clusters%20with%20Antrea%20Network%20Policies"
      title="Send via email"
      aria-label="Send via email"
      >
      

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M207.8 20.73c-93.45 18.32-168.7 93.66-187 187.1c-27.64 140.9 68.65 266.2 199.1 285.1c19.01 2.888 36.17-12.26 36.17-31.49l.0001-.6631c0-15.74-11.44-28.88-26.84-31.24c-84.35-12.98-149.2-86.13-149.2-174.2c0-102.9 88.61-185.5 193.4-175.4c91.54 8.869 158.6 91.25 158.6 183.2l0 16.16c0 22.09-17.94 40.05-40 40.05s-40.01-17.96-40.01-40.05v-120.1c0-8.847-7.161-16.02-16.01-16.02l-31.98 .0036c-7.299 0-13.2 4.992-15.12 11.68c-24.85-12.15-54.24-16.38-86.06-5.106c-38.75 13.73-68.12 48.91-73.72 89.64c-9.483 69.01 43.81 128 110.9 128c26.44 0 50.43-9.544 69.59-24.88c24 31.3 65.23 48.69 109.4 37.49C465.2 369.3 496 324.1 495.1 277.2V256.3C495.1 107.1 361.2-9.332 207.8 20.73zM239.1 304.3c-26.47 0-48-21.56-48-48.05s21.53-48.05 48-48.05s48 21.56 48 48.05S266.5 304.3 239.1 304.3z"/></svg>

  </span>


    </a>
      
    
  </section>


        


<h2 class="mt-8 text-2xl font-extrabold mb-10">Related</h2>
<section class="w-full grid gap-4 sm:grid-cols-2 md:grid-cols-3">
  
  

  <a href="/2024/04/16/exploring-some-antrea-features/" class="min-w-full">
    
    <div class="min-h-full border border-neutral-200 dark:border-neutral-700 border-2 rounded overflow-hidden shadow-2xl relative">
        
        <div class="w-full thumbnail_card_related nozoom" style="background-image:url(/2024/04/16/exploring-some-antrea-features/feature-antrea-1.png);"></div>
        
      

      <div class="px-6 py-4">

        
        <div class="font-bold text-xl text-neutral-800 decoration-primary-500 hover:underline hover:underline-offset-2 dark:text-neutral"
          href="/2024/04/16/exploring-some-antrea-features/">Exploring some Antrea Features</div>
        

        <div class="text-sm text-neutral-500 dark:text-neutral-400">
          











  





  



  













<div class="flex flex-row flex-wrap items-center">
  
  
  <time datetime="2024-04-16T09:25:28&#43;02:00">16 April 2024</time><span class="px-2 text-primary-500">&middot;</span><span>6097 words</span><span class="px-2 text-primary-500">&middot;</span><span title="Reading time">29 mins</span>
  

  
  
</div>


<div class="flex flex-row flex-wrap items-center">
  
  
  
  
  
  
  
  
  
  
  
</div>




<div class="flex flex-row flex-wrap items-center">
  
  
  
  
  
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/kubernetes/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Kubernetes
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/cni/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    CNI
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/antrea/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Antrea
  </span>
</span>
  </span>
  
  
  
  
  
  
  
  
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/antrea/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Antrea
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/kubernetes/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Kubernetes
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/cni/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Cni
  </span>
</span>
  </span>
  
  
  
  
</div>




        </div>

        
        <div class="py-1 prose dark:prose-invert">
          In this post I will go through a couple of Antrea features I find interesting, some new features and some older features
        </div>
        
      </div>
      <div class="px-6 pt-4 pb-2">

      </div>
    </div>
  </a>

  
  

  <a href="/2023/09/25/antrea-multi-cluster-in-tkg-and-vsphere-with-tanzu/" class="min-w-full">
    
    <div class="min-h-full border border-neutral-200 dark:border-neutral-700 border-2 rounded overflow-hidden shadow-2xl relative">
        
        <div class="w-full thumbnail_card_related nozoom" style="background-image:url(/2023/09/25/antrea-multi-cluster-in-tkg-and-vsphere-with-tanzu/feature-antrea-1.png);"></div>
        
      

      <div class="px-6 py-4">

        
        <div class="font-bold text-xl text-neutral-800 decoration-primary-500 hover:underline hover:underline-offset-2 dark:text-neutral"
          href="/2023/09/25/antrea-multi-cluster-in-tkg-and-vsphere-with-tanzu/">Antrea Multi-cluster - in TKG and vSphere with Tanzu</div>
        

        <div class="text-sm text-neutral-500 dark:text-neutral-400">
          











  





  



  













<div class="flex flex-row flex-wrap items-center">
  
  
  <time datetime="2023-09-25T10:59:30&#43;02:00">25 September 2023</time><span class="px-2 text-primary-500">&middot;</span><span>11466 words</span><span class="px-2 text-primary-500">&middot;</span><span title="Reading time">54 mins</span>
  

  
  
</div>


<div class="flex flex-row flex-wrap items-center">
  
  
  
  
  
  
  
  
  
  
  
</div>




<div class="flex flex-row flex-wrap items-center">
  
  
  
  
  
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/kubernetes/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Kubernetes
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/cni/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    CNI
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/antrea/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Antrea
  </span>
</span>
  </span>
  
  
  
  
  
  
  
  
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/kubernetes/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Kubernetes
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/tanzu/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Tanzu
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/antrea/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Antrea
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/cni/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Cni
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/multi-cluster/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Multi-Cluster
  </span>
</span>
  </span>
  
  
  
  
</div>




        </div>

        
        <div class="py-1 prose dark:prose-invert">
          In this post I will go through how to configure and use the Antrea feature gate Multi-cluster in both TKGs and TKG
        </div>
        
      </div>
      <div class="px-6 pt-4 pb-2">

      </div>
    </div>
  </a>

  
  

  <a href="/2023/12/18/a-quick-glance-at-cilium-cni/" class="min-w-full">
    
    <div class="min-h-full border border-neutral-200 dark:border-neutral-700 border-2 rounded overflow-hidden shadow-2xl relative">
        
        <div class="w-full thumbnail_card_related nozoom" style="background-image:url(/2023/12/18/a-quick-glance-at-cilium-cni/feature-cilium.jpg);"></div>
        
      

      <div class="px-6 py-4">

        
        <div class="font-bold text-xl text-neutral-800 decoration-primary-500 hover:underline hover:underline-offset-2 dark:text-neutral"
          href="/2023/12/18/a-quick-glance-at-cilium-cni/">A Quick Glance at Cilium CNI</div>
        

        <div class="text-sm text-neutral-500 dark:text-neutral-400">
          











  





  



  













<div class="flex flex-row flex-wrap items-center">
  
  
  <time datetime="2023-12-18T11:49:56&#43;01:00">18 December 2023</time><span class="px-2 text-primary-500">&middot;</span><span>8012 words</span><span class="px-2 text-primary-500">&middot;</span><span title="Reading time">38 mins</span>
  

  
  
</div>


<div class="flex flex-row flex-wrap items-center">
  
  
  
  
  
  
  
  
  
  
  
</div>




<div class="flex flex-row flex-wrap items-center">
  
  
  
  
  
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/kubernetes/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Kubernetes
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/cni/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    CNI
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/networking/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Networking
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/security/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Security
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/monitoring/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Monitoring
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/ebpf/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    EBPF
  </span>
</span>
  </span>
  
  
  
  
  
  
  
  
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/cilium/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Cilium
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/kubernetes/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Kubernetes
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/cni/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Cni
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/networking/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Networking
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/ebpf/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Ebpf
  </span>
</span>
  </span>
  
  
  
  
</div>




        </div>

        
        <div class="py-1 prose dark:prose-invert">
          In this post I will deploy Cilium in my k8s cluster and test some features and how it is to manage
        </div>
        
      </div>
      <div class="px-6 pt-4 pb-2">

      </div>
    </div>
  </a>

  
</section>

  
      </div>
     
      
      
        
        
          
          
        
      <script>
        var oid = "views_posts\/2023-06-21-antrea-network-policies-deepdive\/index.md"
        var oid_likes = "likes_posts\/2023-06-21-antrea-network-policies-deepdive\/index.md"
      </script>
      
      
      <script type="text/javascript" src="/js/page.min.0860cf4e04fa2d72cc33ddba263083464d48f67de06114529043cb4623319efed4f484fd7f1730df5abea0e2da6f3538855634081d02f2d6e920b956f063e823.js" integrity="sha512-CGDPTgT6LXLMM926JjCDRk1I9n3gYRRSkEPLRiMxnv7U9IT9fxcw31q&#43;oOLabzU4hVY0CB0C8tbpILlW8GPoIw=="></script>
      
  
    </section>
  <footer class="pt-8 max-w-prose print:hidden">

    
  
    
    
    
    <div class="pt-8">
      <hr class="border-dotted border-neutral-300 dark:border-neutral-600" />
      <div class="flex justify-between pt-3">
        <span>
          
            <a class="flex group mr-3" href="/2023/06/01/managing-antrea-in-vsphere-with-tanzu/">
              <span
                class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400"
                >&larr;</span
              >
              <span
                class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400"
                >&rarr;</span
              >
              <span class="flex flex-col">
                <span
                  class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500"
                  >Managing Antrea in vSphere with Tanzu</span
                >
                <span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400">
                  
                    <time datetime="2023-06-01T11:14:32&#43;02:00">1 June 2023</time>
                  
                </span>
              </span>
            </a>
          
        </span>
        <span>
          
            <a class="flex text-right group ml-3" href="/2023/07/12/installing-tmc-local-on-vsphere-8-with-tanzu-using-keycloak-as-oidc-provider/">
              <span class="flex flex-col">
                <span
                  class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500"
                  >Installing TMC local on vSphere 8 with Tanzu using Keycloak as OIDC provider</span
                >
                <span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400">
                  
                    <time datetime="2023-07-12T15:22:46&#43;02:00">12 July 2023</time>
                  
                </span>
              </span>
              <span
                class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400"
                >&rarr;</span
              >
              <span
                class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400"
                >&larr;</span
              >
            </a>
          
        </span>
      </div>
    </div>
  


    
  </footer>
</article>

      <div id="top-scroller" class="pointer-events-none absolute top-[110vh] bottom-0 w-12 ltr:right-0 rtl:left-0">
  <a href="#the-top"
    class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 mb-16 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400"
    aria-label="Scroll to top" title="Scroll to top">
    &uarr;
  </a>
</div>
    </main><footer id="site-footer" class="py-10 print:hidden">
  
  
    
    <nav class="flex flex-row pb-4 text-base font-medium text-neutral-500 dark:text-neutral-400">
      <ul class="flex flex-col list-none sm:flex-row">
        
        <li class="flex mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0">
          <a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2 flex items-center" href="/tags/"
            title="">
            
            Tags
          </a>
        </li>
        
        <li class="flex mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0">
          <a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2 flex items-center" href="/categories/"
            title="">
            
            Categories
          </a>
        </li>
        
      </ul>
    </nav>
    
  
  <div class="flex items-center justify-between">

    
    
    <p class="text-sm text-neutral-500 dark:text-neutral-400">
      &copy;
      2024
      Andreas Marqvardsen
    </p>
    

    
    
    <p class="text-xs text-neutral-500 dark:text-neutral-400">
      
      
      Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500"
        href="https://gohugo.io/" target="_blank" rel="noopener noreferrer">Hugo</a> &amp; <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500"
        href="https://blowfish.page/" target="_blank" rel="noopener noreferrer">Blowfish</a>
    </p>
    

  </div>
  <script>
    
    mediumZoom(document.querySelectorAll("img:not(.nozoom)"), {
      margin: 24,
      background: 'rgba(0,0,0,0.5)',
      scrollOffset: 0,
    })
    
  </script>
  
  
  <script type="text/javascript" src="/js/process.min.ee03488f19c93c2efb199e2e3014ea5f3cb2ce7d45154adb3399a158cac27ca52831db249ede5bb602700ef87eb02434139de0858af1818ab0fb4182472204a4.js" integrity="sha512-7gNIjxnJPC77GZ4uMBTqXzyyzn1FFUrbM5mhWMrCfKUoMdsknt5btgJwDvh&#43;sCQ0E53ghYrxgYqw&#43;0GCRyIEpA=="></script>
  
  
</footer>
<div
  id="search-wrapper"
  class="invisible fixed inset-0 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh]"
  data-url="https://blog.andreasm.io/"
  style="z-index:500"
>
  <div
    id="search-modal"
    class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"
  >
    <header class="relative z-10 flex items-center justify-between flex-none px-2">
      <form class="flex items-center flex-auto min-w-0">
        <div class="flex items-center justify-center w-8 h-8 text-neutral-400">
          

  <span class="relative block icon">
    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>

  </span>


        </div>
        <input
          type="search"
          id="search-query"
          class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent"
          placeholder="Search"
          tabindex="0"
        />
      </form>
      <button
        id="close-search-button"
        class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400"
        title="Close (Esc)"
      >
        

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75 0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3L54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75 0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75 0-45.25s32.75-12.5 45.25 0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25 0s12.5 32.75 0 45.25l-105.4 105.4L310.6 361.4z"/></svg>

  </span>


      </button>
    </header>
    <section class="flex-auto px-2 overflow-auto">
      <ul id="search-results">
        
      </ul>
    </section>
  </div>
</div>

  </div>
</body>

</html>
